<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan CSS ABRS  Support Blog !!</title>
  
  <subtitle>Azure Backup , Azure Site Recovery , Azure Migrate に関するサポート情報を発信します。</subtitle>
  <link href="https://jpabrs-scem.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpabrs-scem.github.io/blog/"/>
  <updated>2025-01-06T06:27:18.427Z</updated>
  <id>https://jpabrs-scem.github.io/blog/</id>
  
  <author>
    <name>Japan CSS ABRS &amp; SCEM Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Azure Backup の 保持期間について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/Backup_RetentionPeriod/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/Backup_RetentionPeriod/</id>
    <published>2025-01-06T03:00:00.000Z</published>
    <updated>2025-01-06T06:27:18.427Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートです。<br>今回は、よくお問い合わせをうける「保持期限」について、取りまとめてお伝えします。<br>公開ドキュメント上では、下記のように「最大保有期間：バックアップ頻度次第」と記載が書かれており、実際に「毎日」「毎週」のバックアップを構成した場合の最大保有期間は、ポリシー作成画面で確認するのみとなっております。</p><p>・保有の制限<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix#retention-limits">https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix#retention-limits</a></p><p><img src="/blog/AzureBackupGeneral/Backup_RetentionPeriod/Backup_RetentionPeriod_01.png"></p><p>（図例：Azure VM Backup の場合）<br><img src="/blog/AzureBackupGeneral/Backup_RetentionPeriod/Backup_RetentionPeriod_02.png"></p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Azure VM Backup の場合</a><br><a href="#2">2. Azure ファイル共有に対する Azure Backup の場合</a><br><a href="#3">3. SQL Server DB に対する Azure Backup の場合</a><br><a href="#4">4. SAP HANA DB に対する Azure Backup の場合</a><br><a href="#5">5. Microsoft Azure Recovery Services (MARS) の場合</a><br><a href="#6">6. Azure ディスク バックアップの場合</a><br><a href="#7">7. Azure BLOB バックアップ の場合</a><br><a href="#8">8. Microsoft Azure Backup Server (MABS) または System Center Data Protection Manager (DPM) の場合</a></p><hr><h2 id="1-Azure-VM-Backup-の場合"><a href="#1-Azure-VM-Backup-の場合" class="headerlink" title=" 1. Azure VM Backup の場合"></a><a id="1"></a> 1. Azure VM Backup の場合</h2><h3 id="ポリシーのサブタイプ：Standard-の場合"><a href="#ポリシーのサブタイプ：Standard-の場合" class="headerlink" title="ポリシーのサブタイプ：Standard の場合"></a>ポリシーのサブタイプ：Standard の場合</h3><h4 id="インスタント回復スナップショットの保持期間"><a href="#インスタント回復スナップショットの保持期間" class="headerlink" title="インスタント回復スナップショットの保持期間"></a>インスタント回復スナップショットの保持期間</h4><table><thead><tr><th>バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日</td><td>1 日</td><td>5 日</td></tr><tr><td>毎週</td><td>5 日</td><td>5 日</td></tr></tbody></table><h4 id="Recovery-Services-コンテナー層上の保持期間"><a href="#Recovery-Services-コンテナー層上の保持期間" class="headerlink" title="Recovery Services コンテナー層上の保持期間"></a>Recovery Services コンテナー層上の保持期間</h4><table><thead><tr><th>バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日</td><td>7 日</td><td>9999 日</td></tr><tr><td>毎週</td><td>1 週</td><td>5163 週</td></tr><tr><td>毎月</td><td>1 ヶ月</td><td>1188 ヶ月</td></tr><tr><td>毎年</td><td>1 年</td><td>99 年</td></tr></tbody></table><h3 id="ポリシーのサブタイプ：Enhanced-の場合"><a href="#ポリシーのサブタイプ：Enhanced-の場合" class="headerlink" title="ポリシーのサブタイプ：Enhanced の場合"></a>ポリシーのサブタイプ：Enhanced の場合</h3><h4 id="インスタント回復スナップショットの保持期間-1"><a href="#インスタント回復スナップショットの保持期間-1" class="headerlink" title="インスタント回復スナップショットの保持期間"></a>インスタント回復スナップショットの保持期間</h4><table><thead><tr><th>バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>4 時間ごと</td><td>1 日</td><td>11 日</td></tr><tr><td>6 時間ごと</td><td>1 日</td><td>17 日</td></tr><tr><td>8 時間ごと</td><td>1 日</td><td>22 日</td></tr><tr><td>12 時間ごと</td><td>1 日</td><td>30 日</td></tr><tr><td>毎日</td><td>1 日</td><td>30 日</td></tr><tr><td>毎週</td><td>5 日</td><td>30 日</td></tr></tbody></table><h4 id="Recovery-Services-コンテナー層上の保持期間-1"><a href="#Recovery-Services-コンテナー層上の保持期間-1" class="headerlink" title="Recovery Services コンテナー層上の保持期間"></a>Recovery Services コンテナー層上の保持期間</h4><table><thead><tr><th>バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日</td><td>7 日</td><td>9999 日</td></tr><tr><td>毎週</td><td>1 週</td><td>5163 週</td></tr><tr><td>毎月</td><td>1 ヶ月</td><td>1188 ヶ月</td></tr><tr><td>毎年</td><td>1 年</td><td>99 年</td></tr></tbody></table><p>（補足）Enhanced バックアップ ポリシーの場合、「〇時間ごと」というような頻度を選択可能です。<br>　1 日に複数回のバックアップ取得を設定した場合、バックアップ ポリシー上の周期から計算して「その日の最後のバックアップ」のみが Recovery Services コンテナー層に保管されます。</p><p>・拡張ポリシーを使用して Azure VM をバックアップする - Azure Backup | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal#create-an-enhanced-policy-and-configure-vm-backup">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal#create-an-enhanced-policy-and-configure-vm-backup</a><br>　“毎時間のバックアップの場合、その日の最後のバックアップがコンテナーに転送されます。 バックアップが失敗すると、次の日の最初のバックアップがコンテナーに転送されます。”</p><p>(Enhanced バックアップ ポリシー の設定例)<br>開始時刻：JST 16時<br>スケジュール：4時間ごと<br>バックアップ期間：24時間</p><p>スナップショット① = JST 6/27 16:00 ごろ取得 → Recovery Services コンテナーには転送されず、スナップショット層にのみ保管される<br>スナップショット② = JST 6/27 20:00 ごろ取得 → Recovery Services コンテナーには転送されず、スナップショット層にのみ保管される<br>スナップショット③ = JST 6/28 0:00 ごろ取得   → Recovery Services コンテナーには転送されず、スナップショット層にのみ保管される<br>スナップショット④ = JST 6/28 4:00 ごろ取得   → Recovery Services コンテナーには転送されず、スナップショット層にのみ保管される<br>スナップショット⑤ = JST 6/28 8:00 ごろ取得   → Recovery Services コンテナーには転送されず、スナップショット層にのみ保管される<br>スナップショット⑥ = JST 6/28 12:00 ごろ取得  → <font color="OrangeRed">Recovery Services コンテナーへ転送される</font></p><p>（補足）オンデマンド バックアップの場合、最大 99 年まで保持期間を指定可能です。<br><img src="/blog/AzureBackupGeneral/Backup_RetentionPeriod/Backup_RetentionPeriod_03.png"></p><h2 id="2-Azure-ファイル共有に対する-Azure-Backup-の場合"><a href="#2-Azure-ファイル共有に対する-Azure-Backup-の場合" class="headerlink" title=" 2. Azure ファイル共有に対する Azure Backup の場合"></a><a id="2"></a> 2. Azure ファイル共有に対する Azure Backup の場合</h2><table><thead><tr><th>Azure ファイル共有 に対するバックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日</td><td>1 日</td><td>200 日</td></tr><tr><td>毎週</td><td>1 週</td><td>200 週</td></tr><tr><td>毎月</td><td>1 ヶ月</td><td>120 ヶ月</td></tr><tr><td>毎年</td><td>1 年</td><td>10 年</td></tr></tbody></table><h2 id="3-SQL-Server-DB-に対する-Azure-Backup-の場合"><a href="#3-SQL-Server-DB-に対する-Azure-Backup-の場合" class="headerlink" title=" 3. SQL Server DB に対する Azure Backup の場合"></a><a id="3"></a> 3. SQL Server DB に対する Azure Backup の場合</h2><table><thead><tr><th>完全バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日</td><td>7 日</td><td>9999 日</td></tr><tr><td>毎週</td><td>1 週</td><td>5163 週</td></tr><tr><td>毎月</td><td>1 ヶ月</td><td>1188 ヶ月</td></tr><tr><td>毎年</td><td>1 年</td><td>99 年</td></tr></tbody></table><table><thead><tr><th>差分バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎週</td><td>7 日</td><td>180 日</td></tr></tbody></table><table><thead><tr><th>ログバックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎分/毎時</td><td>7 日</td><td>35 日</td></tr></tbody></table><h2 id="4-SAP-HANA-DB-に対する-Azure-Backup-の場合"><a href="#4-SAP-HANA-DB-に対する-Azure-Backup-の場合" class="headerlink" title=" 4. SAP HANA DB に対する Azure Backup の場合"></a><a id="4"></a> 4. SAP HANA DB に対する Azure Backup の場合</h2><table><thead><tr><th>完全バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日</td><td>7 日</td><td>9999 日</td></tr><tr><td>毎週</td><td>1 週</td><td>5163 週</td></tr><tr><td>毎月</td><td>1 ヶ月</td><td>1188 ヶ月</td></tr><tr><td>毎年</td><td>1 年</td><td>99 年</td></tr></tbody></table><table><thead><tr><th>差分バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎週</td><td>7 日</td><td>180 日</td></tr></tbody></table><table><thead><tr><th>増分バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎週</td><td>7 日</td><td>180 日</td></tr></tbody></table><table><thead><tr><th>ログバックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎分/毎時</td><td>7 日</td><td>35 日</td></tr></tbody></table><h2 id="5-Microsoft-Azure-Recovery-Services-MARS-の場合"><a href="#5-Microsoft-Azure-Recovery-Services-MARS-の場合" class="headerlink" title=" 5. Microsoft Azure Recovery Services (MARS) の場合"></a><a id="5"></a> 5. Microsoft Azure Recovery Services (MARS) の場合</h2><table><thead><tr><th>MARS バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日</td><td>7 日</td><td>9999 日</td></tr><tr><td>毎週</td><td>4 週</td><td>5163 週</td></tr><tr><td>毎月</td><td>3 ヶ月</td><td>1316 ヶ月</td></tr><tr><td>毎年</td><td>1 年</td><td>100 年</td></tr></tbody></table><h2 id="6-Azure-ディスク-バックアップの場合"><a href="#6-Azure-ディスク-バックアップの場合" class="headerlink" title=" 6. Azure ディスク バックアップの場合"></a><a id="6"></a> 6. Azure ディスク バックアップの場合</h2><table><thead><tr><th>Azure ディスク バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>1 時間ごと</td><td>1 日</td><td>18 日</td></tr><tr><td>2 時間ごと</td><td>1 日</td><td>37 日</td></tr><tr><td>4 時間ごと</td><td>1 日</td><td>75 日</td></tr><tr><td>6 時間ごと</td><td>1 日</td><td>112 日</td></tr><tr><td>8 時間ごと</td><td>1 日</td><td>150 日</td></tr><tr><td>12 時間ごと</td><td>1 日</td><td>225 日</td></tr><tr><td>毎日</td><td>1 日</td><td>365 日</td></tr></tbody></table><p>(補足 1 )<br>Azure ディスク バックアップでは、ディスクあたりのスナップショット合計数が、スケジュール バックアップ 450 個 + オンデマンド バックアップ 50 個の合計 500 個までとなるよう、バックアップ ポリシー上で制限されています。<br>・ディスク バックアップのスケジュールと保持期間はどのように機能しますか?<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-overview#how-does-the-disk-backup-scheduling-and-retention-period-work">https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-overview#how-does-the-disk-backup-scheduling-and-retention-period-work</a><br>　“スナップショットの保持期間は、ディスクのスナップショット制限によって制御されます。”</p><p>(補足 2 )<br>バックアップ ポリシー作成時、「保持規則の追加」をクリックすることで、<br>「毎日」もしくは「毎週」作成される、特定のバックアップについては、追加で保持期間を設定することができます。</p><p>・バックアップ ポリシーを作成する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-managed-disks#create-backup-policy">https://learn.microsoft.com/ja-jp/azure/backup/backup-managed-disks#create-backup-policy</a><br>　“最初に正常に作成された日単位または週単位のバックアップを選択して、特定のバックアップが削除される前に保持されるリテンション期間を指定できます。<br>　 このオプションは、日または週の特定のバックアップを長期間保持するのに便利です。<br>　 その他のバックアップについては、保持期間を短くすることができます。”</p><p><img src="/blog/AzureBackupGeneral/Backup_RetentionPeriod/Backup_RetentionPeriod_04.png" alt="image"></p><h2 id="7-Azure-BLOB-バックアップ-の場合"><a href="#7-Azure-BLOB-バックアップ-の場合" class="headerlink" title=" 7. Azure BLOB バックアップ の場合"></a><a id="7"></a> 7. Azure BLOB バックアップ の場合</h2><h3 id="運用バックアップの場合"><a href="#運用バックアップの場合" class="headerlink" title="運用バックアップの場合"></a>運用バックアップの場合</h3><p>バックアップ対象ストレージ アカウント上にのみバックアップ データを保管します。<br>「1 日に 1 回のバックアップ」などではなく、継続的なバックアップ取得となるため、「バックアップ頻度」というものはございません。<br>最小保持期間は 1 日、最大保持期間は 360 日、またはそれに相当する数の週 (51) または月 (11) です。</p><h3 id="保管済みバックアップの場合"><a href="#保管済みバックアップの場合" class="headerlink" title="保管済みバックアップの場合"></a>保管済みバックアップの場合</h3><p>バックアップ対象ストレージ アカウント上および バックアップ コンテナー上にバックアップ データを保管します。</p><table><thead><tr><th>保管済みバックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日</td><td>7 日</td><td>3650 日</td></tr><tr><td>毎週</td><td>4 週</td><td>521 週</td></tr></tbody></table><p>(補足)<br>保持期間は日、週、月、年 単位で設定することも可能です。<br><img src="/blog/AzureBackupGeneral/Backup_RetentionPeriod/Backup_RetentionPeriod_05.png" alt="image"></p><p>「保持規則の追加」をクリックすることで、「毎週」、「毎月」もしくは「毎年」作成される、特定のバックアップについては、追加で保持期間を設定することができます。<br><img src="/blog/AzureBackupGeneral/Backup_RetentionPeriod/Backup_RetentionPeriod_06.png" alt="image"></p><h2 id="8-Microsoft-Azure-Backup-Server-MABS-または-System-Center-Data-Protection-Manager-DPM-の場合"><a href="#8-Microsoft-Azure-Backup-Server-MABS-または-System-Center-Data-Protection-Manager-DPM-の場合" class="headerlink" title=" 8. Microsoft Azure Backup Server (MABS) または System Center Data Protection Manager (DPM) の場合"></a><a id="8"></a> 8. Microsoft Azure Backup Server (MABS) または System Center Data Protection Manager (DPM) の場合</h2><h3 id="DPM-MABS-ローカルディスクへのバックアップ"><a href="#DPM-MABS-ローカルディスクへのバックアップ" class="headerlink" title="(DPM / MABS) ローカルディスクへのバックアップ"></a>(DPM / MABS) ローカルディスクへのバックアップ</h3><table><thead><tr><th>バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>(*1)</td><td>1 日 (*2)</td><td>448 日</td></tr></tbody></table><p>(*1) 保護対象のワークロードにより、指定可能な間隔が異なります。たとえば SQL Server の場合、最短 15 分間隔が指定できます。<br>また、保護対象がファイル データの場合、回復ポイントの最大数は 64 個、保護対象がアプリケーション データの場合は最大 448 個の制限がございます。</p><p>(*2) DPM / MABS における保持期間の考え方は、カレンダー上の経過日数ではなく、正常に回復ポイントが取得された日数をカウントします。<br>たとえば、保持期間を 1 日に設定し、月曜日に回復ポイントを取得した場合、1 日分としてカウントされ、バックアップ データは火曜日以降も保持されます。<br>保持日数のカウント数を超えた場合 (たとえば次の月曜日に回復ポイントを作成)、メンテナンス ジョブ (毎日深夜 0 時に自動実行) によって、古いものから削除されます。</p><h3 id="DPM-Tape-への長期保護バックアップ-保護対象をディスクにバックアップしてからテープにバックアップ"><a href="#DPM-Tape-への長期保護バックアップ-保護対象をディスクにバックアップしてからテープにバックアップ" class="headerlink" title="(DPM)  Tape への長期保護バックアップ (保護対象をディスクにバックアップしてからテープにバックアップ)"></a>(DPM)  Tape への長期保護バックアップ (保護対象をディスクにバックアップしてからテープにバックアップ)</h3><table><thead><tr><th>バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日</td><td>7 日</td><td>28 日</td></tr><tr><td>毎週</td><td>1 週</td><td>4 週</td></tr><tr><td>毎月</td><td>1 ヶ月</td><td>11 ヶ月</td></tr><tr><td>毎年</td><td>1 年</td><td>99 年</td></tr></tbody></table><h3 id="DPM-Tape-への短期保護バックアップ-保護対象を直接テープにバックアップ"><a href="#DPM-Tape-への短期保護バックアップ-保護対象を直接テープにバックアップ" class="headerlink" title="(DPM)  Tape への短期保護バックアップ (保護対象を直接テープにバックアップ)"></a>(DPM)  Tape への短期保護バックアップ (保護対象を直接テープにバックアップ)</h3><table><thead><tr><th>バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日</td><td>7 日</td><td>84 日</td></tr><tr><td>毎週</td><td>1 週</td><td>12 週</td></tr></tbody></table><h3 id="DPM-MABS-オンライン-バックアップ-保護対象をディスクにバックアップしてから-Recovery-Services-コンテナーにバックアップ"><a href="#DPM-MABS-オンライン-バックアップ-保護対象をディスクにバックアップしてから-Recovery-Services-コンテナーにバックアップ" class="headerlink" title="(DPM / MABS) オンライン バックアップ (保護対象をディスクにバックアップしてから Recovery Services コンテナーにバックアップ)"></a>(DPM / MABS) オンライン バックアップ (保護対象をディスクにバックアップしてから Recovery Services コンテナーにバックアップ)</h3><table><thead><tr><th>バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日　(一日最大 2 回)</td><td>7 日</td><td>9999 日</td></tr><tr><td>毎週</td><td>4 週</td><td>9999 週</td></tr><tr><td>毎月</td><td>3 ヶ月</td><td>9999 ヶ月</td></tr><tr><td>毎年</td><td>1 年</td><td>9999 年</td></tr></tbody></table><p>Azure Backup における保有期間について、以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートです。&lt;br&gt;今回は、よくお問い合わせをうける「保持期限」について、取りまとめてお伝えします。&lt;br&gt;公開ドキュメント上では、下記のように「最大保有期間：バックアップ頻度次第」</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup にて取得した復元ポイントの保持期限を確認する方法</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/</id>
    <published>2025-01-06T03:00:00.000Z</published>
    <updated>2025-01-06T06:27:18.667Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、<strong>Azure VM Backup にて取得した復元ポイントの保持期限を確認する方法</strong> について、ご案内いたします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. スケジュール バックアップにて取得した復元ポイントの保持期限を確認されたい場合</a><br><a href="#2">2. 「今すぐバックアップ」にて取得した復元ポイントの保持期限を確認されたい場合</a><br> <a href="#2-1"> 2-1. Azure ポータル画面から確認する</a><br> <a href="#2-2"> 2-2. Azure ポータル画面より、定期的に csv へエクスポートする</a></p><hr><h2 id="1-スケジュール-バックアップにて取得した復元ポイントの保持期限を確認されたい場合"><a href="#1-スケジュール-バックアップにて取得した復元ポイントの保持期限を確認されたい場合" class="headerlink" title="1. スケジュール バックアップにて取得した復元ポイントの保持期限を確認されたい場合"></a>1. スケジュール バックアップにて取得した復元ポイントの保持期限を確認されたい場合<a id="1"></a></h2><p>スケジュール バックアップにて取得する復元ポイントは、バックアップ ポリシーにて設定した保持期限に従って保持されますので、設定しているバックアップ ポリシーを参照ください。</p><p>Recovery Services コンテナー ＞ バックアップ ポリシー にて確認可能です。<br>もしくは、下図のように Recovery Services コンテナー ＞ バックアップ アイテム ＞ Azure Virtual Machine ＞ 対象の仮想マシンを選択し、「バックアップ ポリシー」を確認可能です。</p><p><img src="/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/HowToCheckRetentionPeriodForVMBackup_01.png" alt="HowToCheckRetentionPeriodForVMBackup_01"></p><h2 id="2-「今すぐバックアップ」にて取得した復元ポイントの保持期限を確認されたい場合"><a href="#2-「今すぐバックアップ」にて取得した復元ポイントの保持期限を確認されたい場合" class="headerlink" title="2. 「今すぐバックアップ」にて取得した復元ポイントの保持期限を確認されたい場合"></a>2. 「今すぐバックアップ」にて取得した復元ポイントの保持期限を確認されたい場合<a id="2"></a></h2><h3 id="2-1-Azure-ポータル画面から確認する"><a href="#2-1-Azure-ポータル画面から確認する" class="headerlink" title="2-1. Azure ポータル画面から確認する"></a>2-1. Azure ポータル画面から確認する<a id="2-1"></a></h3><p>以下のいずれかの方法で「今すぐバックアップ」にて取得した復元ポイントの保持期限の確認が可能です。</p><p>＜バックアップ ジョブから確認する場合＞</p><p>「今すぐバックアップ」にて取得した復元ポイントの保持期限は、Azure ポータル画面上の「バックアップ ジョブ」画面から確認可能です。<br>対象のRecovery Services コンテナー ＞ バックアップ ジョブ ＞ 「View details」をクリックいただき、「Recovery Point Expiry Time in UTC」欄をご確認ください。</p><p>・復旧ポイントの管理<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/manage-recovery-points#frequently-asked-question">https://docs.microsoft.com/ja-jp/azure/backup/manage-recovery-points#frequently-asked-question</a></p><p><img src="/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/HowToCheckRetentionPeriodForVMBackup_02.png" alt="HowToCheckRetentionPeriodForVMBackup_02"></p><p><img src="/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/HowToCheckRetentionPeriodForVMBackup_03.png" alt="HowToCheckRetentionPeriodForVMBackup_03"></p><p>なお、復元ポイントの保持期限情報を含めた、Azure ポータル画面上のバックアップ ジョブ情報の保持期間は、最大 6 か月間でございます。<br>（弊社検証環境にて確認したところ、現状 1 年以上前のバックアップ ジョブも確認はできましたが、仕様としては 6 か月間となっております）<br>そのため、6 か月以上前の バックアップ ジョブ履歴を保持し、オンデマンド バックアップにて取得したバックアップ ポイントの保持期限を確認されたい場合は<a href="#2-2"> csv へのエクスポート </a>をご検討ください。</p><p>＜バックアップ項目から確認する場合＞</p><p>「今すぐバックアップ」にて取得した復元ポイントの保持期限は、Azure ポータル画面上の「バックアップ項目」画面からも確認可能です。<br>対象のRecovery Services コンテナー ＞ バックアップ アイテム ＞ バックアップ対象の VM の「View details」をクリックいただき、バックアップ項目の「有効期限」欄をご確認ください。</p><p><img src="/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/HowToCheckRetentionPeriodForVMBackup_04.png" alt="image"></p><p>なお、「有効期限」はUTC表記となります。<br>「有効期限」は、スナップショット層に保管されている復元ポイントについては、「インスタント回復スナップショットの保有期間」が表示される仕様となっております。</p><h3 id="2-2-Azure-ポータル画面より、定期的に-csv-へエクスポートする"><a href="#2-2-Azure-ポータル画面より、定期的に-csv-へエクスポートする" class="headerlink" title="2-2.Azure ポータル画面より、定期的に csv へエクスポートする"></a>2-2.Azure ポータル画面より、定期的に csv へエクスポートする<a id="2-2"></a></h3><p>対象の Recovery Services コンテナー ＞ バックアップ ジョブから、「Filter」にて任意の期間等を選択いただき、バックアップ ジョブが存在するうちに「Export jobs」を実施いただきますよう、お願いいたします。<br> <img src="/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/HowToCheckRetentionPeriodForVMBackup_05.png" alt="HowToCheckRetentionPeriodForVMBackup_04"><br> <img src="/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/HowToCheckRetentionPeriodForVMBackup_06.png" alt="HowToCheckRetentionPeriodForVMBackup_05"><br> <img src="/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/HowToCheckRetentionPeriodForVMBackup_07.png" alt="HowToCheckRetentionPeriodForVMBackup_07"><br> <img src="/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/HowToCheckRetentionPeriodForVMBackup_08.png" alt="HowToCheckRetentionPeriodForVMBackup_08"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、&lt;strong&gt;Azure VM Backup にて取得した復元ポイントの保持期限を確認する方法&lt;/strong&gt; について、ご案内いたします。&lt;/p&gt;
</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup で取得した復旧ポイントの保持期間の延長について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToExtendVMRetentionPeriod/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToExtendVMRetentionPeriod/</id>
    <published>2025-01-06T03:00:00.000Z</published>
    <updated>2025-01-06T06:27:18.675Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、 <strong>Azure VM Backup として取得済の復元ポイントの保持期限を延長できるかという点</strong> についてご案内いたします。</p><p>Azure VM Backup 関連のお問い合わせで、以下のようなお問い合わせを多くいただきます。</p><ol><li>バックアップ ポリシーに従って取得済の復元ポイントの保持期間を延長することは可能か</li><li>バックアップ ポリシーに従って取得済の復元ポイントの中の、特定の復元ポイントのみの保持期間を延長して保持しておくことは可能か</li><li>「今すぐバックアップ」にて取得済の復元ポイントの保持期間を延長して保持しておくことは可能か</li></ol><p>結論から申し上げますと、<em><strong>1. は可能でございますが、2. 3. については保持期間を延長して保持しておくことはかないません。</strong></em></p><p>・特定の復旧ポイントのリテンション期間を延長または減らす方法<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#----------------------------">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#----------------------------</a></p><blockquote><p>抜粋:”この機能は、現時点ではサポートされていません。 <a href="https://feedback.azure.com/d365community/forum/153aa817-0725-ec11-b6e6-000d3a4f0858#">Azure Backup コミュニティ ポータル</a>で、任意の機能に関する質問を投稿できます。”</p></blockquote><p>バックアップポリシーにてスケジュールバックアップで取得した復元ポイントはポリシーによって管理されますが、「今すぐバックアップ」にて取得した復元ポイントはバックアップ時に設定した保持期限に従い管理されます。<br>即ち、<em><strong>「今すぐバックアップ」の保持期限はバックアップポリシーの設定内容の影響を受けません。</strong></em>(ただし、インスタントリストアの保持期限はバックアップポリシーに従います。)</p><p>また <strong>Azure Backup では保持期限は最長 99 年となるため、無期限に保存するような設定はできません。</strong><br>ただし「バックアップの停止」時に「バックアップ データの保持」を選択した場合は、「バックアップの再開」または「バックアップ データの削除」を行うまで、取得済みの復旧ポイントは無期限に保存されます。<br>このとき「バックアップの再開」を行うと、バックアップ ポリシーに設定した保持期限に従って、保持期限が過ぎた復旧ポイントが削除されます。</p><p>代替案含め、下記にてご説明いたします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. バックアップ ポリシーに従って取得済の復元ポイントの保持期間を延長することは可能か</a><br><a href="#2">2. バックアップ ポリシーに従って取得済の復元ポイントの中の、特定の復元ポイントのみの保持期間を延長して保持しておくことは可能か</a><br><a href="#3">3.「今すぐバックアップ」にて取得済の復元ポイントの保持期間を延長して保持しておくことは可能か</a><br><a href="#4">4. Azure VM Backup の取得済復旧ポイントの保持期限を伸ばす代替案</a><br><a href="#5">5. 参考</a></p><h2 id="1-バックアップ-ポリシーに従って取得済の復元ポイントの保持期間を延長することは可能か"><a href="#1-バックアップ-ポリシーに従って取得済の復元ポイントの保持期間を延長することは可能か" class="headerlink" title="1. バックアップ ポリシーに従って取得済の復元ポイントの保持期間を延長することは可能か"></a>1. バックアップ ポリシーに従って取得済の復元ポイントの保持期間を延長することは可能か<a id="1"></a></h2><p>対象の仮想マシンに適用しているバックアップ ポリシー内の保持期間を変更することで、これまで取得済の復元ポイントに対しても保持期間を延長することが可能でございます。<br>例えば、週次 (日次) にて取得する復元ポイント（バックアップ ポイント）に対する保持期間の変更は、すでに週次 (日次) にて取得した復元ポイントに対しても変更が適用されます。</p><p>下記の弊社公開情報をご覧ください。<br>・Azure Backup - よく寄せられる質問 - バックアップ ポリシーを変更した場合どうなりますか。<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-backup-faq#--------------------------">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-backup-faq#--------------------------</a></p><p>・アーキテクチャの概要 -  復旧ポイントに対するポリシーの変更の影響<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-architecture#impact-of-policy-change-on-recovery-points">https://docs.microsoft.com/ja-jp/azure/backup/backup-architecture#impact-of-policy-change-on-recovery-points</a></p><p><img src="/blog/AzureVMBackup/HowToExtendVMRetentionPeriod/HowToExtendVMRetentionPeriod_01.png" alt="HowToExtendVMRetentionPeriod_01"></p><h2 id="2-バックアップ-ポリシーに従って取得済の復元ポイントの中の、特定の復元ポイントのみの保持期間を延長して保持しておくことは可能か"><a href="#2-バックアップ-ポリシーに従って取得済の復元ポイントの中の、特定の復元ポイントのみの保持期間を延長して保持しておくことは可能か" class="headerlink" title="2. バックアップ ポリシーに従って取得済の復元ポイントの中の、特定の復元ポイントのみの保持期間を延長して保持しておくことは可能か"></a>2. バックアップ ポリシーに従って取得済の復元ポイントの中の、特定の復元ポイントのみの保持期間を延長して保持しておくことは可能か<a id="2"></a></h2><h2 id="3-「今すぐバックアップ」にて取得済の復元ポイントの保持期間を延長して保持しておくことは可能か"><a href="#3-「今すぐバックアップ」にて取得済の復元ポイントの保持期間を延長して保持しておくことは可能か" class="headerlink" title="3. 「今すぐバックアップ」にて取得済の復元ポイントの保持期間を延長して保持しておくことは可能か"></a>3. 「今すぐバックアップ」にて取得済の復元ポイントの保持期間を延長して保持しておくことは可能か<a id="3"></a></h2><p>バックアップ ポリシー上で「保持期間」を変更した場合、これまで取得してきたすべての復元ポイントに対して、ポリシーの変更が適用されます。<br>残念ながら、これまで取得してきた復元ポイントのうち、「ある特定の復元ポイントのみ」の保持期間を延長して保持しておく、ということはかないません。</p><p>また、「今すぐバックアップ」（オンデマンド バックアップ）にて取得した復元ポイントの保持期間も延長することはかないません。(「今すぐバックアップ」の保持期限はバックアップポリシーの設定内容の影響を受けないため)<br>上記 2. 3. をご所望の場合は、下記代替案の通り、対象の復元ポイントからディスクとして復元しておき、ご利用者様にてディスクを保持していただくことをお勧めします。</p><h2 id="4-Azure-VM-Backup-の取得済復旧ポイントの保持期限を伸ばす代替案"><a href="#4-Azure-VM-Backup-の取得済復旧ポイントの保持期限を伸ばす代替案" class="headerlink" title="4. Azure VM Backup の取得済復旧ポイントの保持期限を伸ばす代替案"></a>4. Azure VM Backup の取得済復旧ポイントの保持期限を伸ばす代替案<a id="4"></a></h2><p>対象の仮想マシン ＞ 「VM の復元」をクリック ＞ 「復元ポイント」にて、保持しておきたい特定の復元ポイントを選択します。<br>「構成の復元：新規作成」「復元の種類：ディスクの復元」を選択のうえ、「復元」をクリックします。<br><strong>復元されたディスクは、ご利用者様にてディスクを削除しない限り、保持され続けます。</strong></p><p>復元されたからディスクを既存の VM にアタッチすることや、既存の VM とディスクをスワップすること、および、復元されたディスクを使って新規 VM を作成することが可能です。</p><p><img src="/blog/AzureVMBackup/HowToExtendVMRetentionPeriod/HowToExtendVMRetentionPeriod_02.png" alt="HowToExtendVMRetentionPeriod_02"></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考<a id="5"></a></h2><p>・Azure VM Backupでリストアされるディスク名に関して<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/About_Restored_Disk/">https://jpabrs-scem.github.io/blog/AzureVMBackup/About_Restored_Disk/</a><br>・Azure VM Backup にて取得した復元ポイントの保持期限を確認する方法<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/">https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/</a><br>・バックアップ ポリシーに設定されている保有期間が過ぎても、スナップショットが存在するのはなぜですか。<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-instant-restore-capability#why-does-my-snapshot-still-exist-even-after-the-set-retention-period-in-backup-policy">https://docs.microsoft.com/ja-jp/azure/backup/backup-instant-restore-capability#why-does-my-snapshot-still-exist-even-after-the-set-retention-period-in-backup-policy</a><br>・自分の保有ポリシーよりも多くのスナップショットが表示されるのはなぜですか。<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-instant-restore-capability#why-do-i-see-more-snapshots-than-my-retention-policy">https://docs.microsoft.com/ja-jp/azure/backup/backup-instant-restore-capability#why-do-i-see-more-snapshots-than-my-retention-policy</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、 &lt;strong&gt;Azure VM Backup として取得済の復元ポイントの保持期限を延長できるかという点&lt;/strong&gt; についてご案内いたします。</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure Backup の自動的に通知されるクラシック アラートについて</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/Classic_Alert_For_Administrators/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/Classic_Alert_For_Administrators/</id>
    <published>2024-12-26T04:00:00.000Z</published>
    <updated>2025-01-06T06:27:18.435Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートです。<br>お客様より、Azure Backup のアラート設定を行っていないのに、アラート メールが通知されるとのお問い合わせをいただくことがございます。<br>このようなシナリオの場合に通知されているのは、Azure Backup のクラシック アラート機能によるアラート メールであることが大半でございます。</p><p>そのため今回は、アラートの通知設定有無に関わらず、特定ユーザーに通知される Azure Backup のクラシック アラート メールの概要、ならびに停止方法についてご案内いたします。  </p><div class="alert is-warning"><p class="alert-title">警告</p><p>本記事は、Azure Backup のクラシック アラートの仕様に関する記事となります。</p><p>Azure Backup の組み込みの Azure Monitor アラート<strong>のみ</strong>を利用している環境には、本記事でご説明するアラート メールは通知されません。  </p></div><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Azure Backup からのアラート メールについて</a><br><a href="#2">2. アラート メールの通知を止める方法について</a>  </p><hr><h2 id="1-Azure-Backup-からのアラート-メールについて"><a href="#1-Azure-Backup-からのアラート-メールについて" class="headerlink" title=" 1. Azure Backup からのアラート メールについて"></a><a id="1"></a> 1. Azure Backup からのアラート メールについて</h2><p>Azure Backup のクラシック アラートでは、<strong>アラートの通知設定に関わらず</strong>、下記ユーザーに破壊的な操作 (論理的な削除設定の無効化や、データを削除して保護を停止など) に関するアラート メールが自動的に通知される仕様となっております。  </p><ul><li>Recovery Services コンテナーが配置されているサブスクリプションの所有者 (Azure RBAC)  </li><li>Recovery Services コンテナーが配置されているサブスクリプションの管理者 (従来の管理者)  </li><li>Recovery Services コンテナーが配置されているサブスクリプションの共同管理者  (従来の管理者)  </li></ul><p>通知されるアラート メールは、例えば下記の様なメールとなります。<br><img src="/blog/AzureBackupGeneral/Classic_Alert_For_Administrators/Classic_Alert_For_Administrators_01.png">  </p><p>詳細につきましては、下記ドキュメントでもご説明しております。<br>・ Azure Backup を使用してクラシック アラートをバックアップする - Azure Backup | Microsoft Learn<br>   <a href="https://learn.microsoft.com/ja-jp/azure/backup/move-to-azure-monitor-alerts#notification-for-backup-alerts">https://learn.microsoft.com/ja-jp/azure/backup/move-to-azure-monitor-alerts#notification-for-backup-alerts</a><br>   抜粋 :  </p><blockquote><p>破壊的な操作 (データを削除して保護を停止など) が実行されると、アラートが生成され、<strong>Recovery Services コンテナー用に通知が構成されていない場合でも、サブスクリプションの所有者、管理者、共同管理者にメールが送信されます</strong>。  </p></blockquote><h2 id="2-アラート-メールの通知を止める方法について"><a href="#2-アラート-メールの通知を止める方法について" class="headerlink" title=" 2. アラート メールの通知を止める方法について"></a><a id="2"></a> 2. アラート メールの通知を止める方法について</h2><p>クラシック アラートの破壊的な操作に関するアラート メールの通知を止めるには、Azure Backup の組み込みの Azure Monitor アラート機能のみを有効化し、クラシック アラートの機能を無効化してください。<br>設定手順を以下にご案内いたします。  </p><h2 id="2-1-組み込みの-Azure-Monitor-アラート機能を有効化する手順"><a href="#2-1-組み込みの-Azure-Monitor-アラート機能を有効化する手順" class="headerlink" title=" 2.1 組み込みの Azure Monitor アラート機能を有効化する手順"></a><a id="2.1"></a> 2.1 組み込みの Azure Monitor アラート機能を有効化する手順</h2><ol><li>ご利用環境にて、Azure Backup のクラシック アラートを無効化しても問題の無いことを確認します  </li><li>ご利用の Recovery Services コンテナーの、”プロパティ &gt; 監視の設定 : 更新” を選択します<br>  <img src="/blog/AzureBackupGeneral/Classic_Alert_For_Administrators/Classic_Alert_For_Administrators_02.png">  </li><li>監視の設定画面にて、”バックアップ用の Azure Monitor アラートのみを使用” オプションのチェックを入れ、設定を保存します<br>  <img src="/blog/AzureBackupGeneral/Classic_Alert_For_Administrators/Classic_Alert_For_Administrators_03.png">  </li></ol><div class="alert is-info"><p class="alert-title">Note</p><p>Azure Backup のクラシック アラートは、2026 年 3 月 31 日をもって廃止される予定となっております。</p><p>もし現時点で Azure Backup のクラシック アラートをご利用である場合には、下記ブログ記事にて組み込みの Azure Monitor アラートへの移行方法をご案内しておりますので、適宜ご確認ください。</p><p>・ QL4L-5D8 XNV5-HTZ クラシック アラートから Azure Monitor を使用した組み込みのアラートへの移行について | Japan CSS ABRS Support Blog !!</p><p>  <a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/HowToMoveClassicAlert/">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/HowToMoveClassicAlert/</a>  </p></div>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートです。&lt;br&gt;お客様より、Azure Backup のアラート設定を行っていないのに、アラート メールが通知されるとのお問い合わせをいただくことがございます。&lt;br&gt;このような</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>Azure Migrate レプリケーション アプライアンスのデプロイについて</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureMigrate/ReplicationApplianceRegister/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureMigrate/ReplicationApplianceRegister/</id>
    <published>2024-12-25T03:00:00.000Z</published>
    <updated>2025-01-06T06:27:18.511Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Migrate サポートです。<br>今回は Azure Migrate のエージェントベース シナリオにおける、レプリケーション アプライアンスをデプロイする際の注意事項について説明いたします。</p><p><strong>該当シナリオ</strong><br>(シナリオ 1 ) Azure Migrate オンプレミス 物理マシン → Azure への移行 エージェントベース</p><ul><li>マシンを物理サーバーとして Azure に移行する | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/migrate/tutorial-migrate-physical-virtual-machines">https://learn.microsoft.com/ja-jp/azure/migrate/tutorial-migrate-physical-virtual-machines</a></li></ul><p>(シナリオ 2 ) Azure Migrate オンプレミス VMWare VM → Azure への移行 エージェントベース</p><ul><li>VMware vSphere VM を Azure (エージェントベース) に移行する | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/migrate/vmware/tutorial-migrate-vmware-agent?context=/azure/migrate/context/migrate-context">https://learn.microsoft.com/ja-jp/azure/migrate/vmware/tutorial-migrate-vmware-agent?context=%2Fazure%2Fmigrate%2Fcontext%2Fmigrate-context</a></li></ul><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. レプリケーション アプライアンスの OS について</a><br><a href="#2">2. 「日本語」で構成されたレプリケーション アプライアンスについて</a><br><a href="#3">3. その他 - よくある質問</a></p><hr><h2 id="1-レプリケーション-アプライアンスの-OS-について"><a href="#1-レプリケーション-アプライアンスの-OS-について" class="headerlink" title=" 1. レプリケーション アプライアンスの OS について"></a><a id="1"></a> 1. レプリケーション アプライアンスの OS について</h2><p>前提として、エージェントベースによる Azure Migrate 移行の場合、「レプリケーション アプライアンス」の役割を果たすマシンをユーザー側で用意・構成いただく必要があります。<br>「レプリケーション アプライアンス」用のマシンを用意する際の、要件・サポート マトリックスは下記にまとめられております。</p><ul><li>レプリケーション アプライアンス | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/migrate/migrate-replication-appliance">https://learn.microsoft.com/ja-jp/azure/migrate/migrate-replication-appliance</a></li></ul><p>上記公開情報では、オペレーティング システムを [Windows Server 2016 または Windows Server 2012 R2] と記載しておりますが<br>「Windows Server 2012 R2」は、オンプレミス上のマシンに対する OS サポートは終了しており<br>万一、OS 観点で何らかの問題が発生して、Azure Migrate 機能が動作しないといった場合に、OS 観点での調査がサポートできない可能性があります。<br>このため、レプリケーション アプライアンスを新しく用意される際には「Windows Server 2016」にてご用意いただけますと幸いです。</p><ul><li>Windows Server 2012 および 2012 R2 のサポート終了 | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/lifecycle/announcements/windows-server-2012-r2-end-of-support">https://learn.microsoft.com/ja-jp/lifecycle/announcements/windows-server-2012-r2-end-of-support</a></li></ul><p>なお、公開情報のレプリケーション アプライアンスの要件は最小要件となっております。<br>そのため、用意いただいたレプリケーション アプライアンスのサーバーが、公開情報に記載しているすべての要件を満たしていない場合、Azure Migrate としてサポートできかねますことをご了承ください。</p><h2 id="2-「日本語」で構成されたレプリケーション-アプライアンスについて"><a href="#2-「日本語」で構成されたレプリケーション-アプライアンスについて" class="headerlink" title=" 2. 「日本語」で構成されたレプリケーション アプライアンスについて"></a><a id="2"></a> 2. 「日本語」で構成されたレプリケーション アプライアンスについて</h2><p>レプリケーション アプライアンス用のマシンを用意する際に</p><ul><li>Windows OS をインストールする時点 (OS のイメージ) で、「日本語」のイメージからセットアップした</li><li>OS をインストールする時点で、システム ロケールを「日本語」で設定していた</li><li>マシンの NIC に日本語を使用していた</li></ul><p>ようなケースの場合、レプリケーション アプライアンスの後続の設定に失敗する可能性が高くなります。</p><p>レプリケーション アプライアンスの要件として、オペレーティング システムのロケールは <strong>英語 (en-us)</strong> となります。<br>このため、上記のようなケースにおいては、必ず「英語」にて OS イメージの取得・システムロケールの設定・ NIC 情報の設定を行っていただきますようお願いいたします。</p><div class="alert is-info"><p class="alert-title">Note</p><p>Windows OS をインストールする際に、システム ロケールを「日本語」選択してインストールを完了後に、ロケールやリージョンをあとから英語 (en-us) に変更しているケースがあります。</p><p>このようなケースも、後続のレプリケーション アプライアンスの設定 (MicrosoftAzureSiteRecoveryUnifiedSetup.exe 実行時) にて下記のようなエラー メッセージが発生し、レプリケーション アプライアンスの設定が進まない状況となってしまいます。</p><p>お手数をおかけしますが、OS をインストールする段階から「英語」を選択する必要がありますので、再インストールをお願いいたします。</p></div><p>(エラー メッセージの例)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Microsoft Azure Site Recovery Unified Setup is unable to proceed as the Operating System locale selected on this computer is not English.</span><br><span class="line">Recommended Action : Run setup on a computer with Operating system locale selected as English.</span><br></pre></td></tr></table></figure><p><img src="/blog/AzureMigrate/ReplicationApplianceRegister/01.png"></p><p>また、NIC の情報に日本語が含まれている場合も、「MicrosoftAzureSiteRecoveryUnifiedSetup.exe」に実行には成功したものの<br>後続のレプリケーション アプライアンスのセットアップ作業中に、問題が発生するケースがあります。<br>例えば、レプリケーション アプライアンスは Azure Migrate の「プロセス サーバー」としての役割も果たしますが、プロキシ サーバーの登録処理が失敗するといった事例があります。</p><p>NIC 情報についても「英語」にて設定いただきますようお願いいたします。<br>ご利用のレプリケーション アプライアンス上で NIC 情報を確認する際には以下のコマンドをご利用ください。</p><p>(管理者権限にて PowerShell を立ち上げ、コマンド実行)<br><code>Get-NetAdapter | Format-List -Property *</code></p><ul><li>Get-NetAdapter | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/powershell/module/netadapter/get-netadapter?view=windowsserver2022-ps">https://learn.microsoft.com/ja-jp/powershell/module/netadapter/get-netadapter?view=windowsserver2022-ps</a></li></ul><p>弊社開発部門では、レプリケーション アプライアンスの開発 ~ 一連の動作確認時には、OS インストール時点からシステム ロケール / NIC を「英語」 としている環境上でのみ動作確認を実施しております。<br>このため、レプリケーション アプライアンスの役割を果たすマシンにおいて <strong>「英語」以外の言語でセットアップされたマシンのシステム ロケールやリージョンを後から「英語」に変更する操作は、弊社開発部門の検証時には想定がされていない操作</strong> となります。</p><h2 id="3-その他-よくある質問"><a href="#3-その他-よくある質問" class="headerlink" title=" 3. その他 - よくある質問"></a><a id="3"></a> 3. その他 - よくある質問</h2><h3 id="Q1-Azure-上にレプリケーション-アプライアンスを構築してもよいか？"><a href="#Q1-Azure-上にレプリケーション-アプライアンスを構築してもよいか？" class="headerlink" title=" Q1. Azure 上にレプリケーション アプライアンスを構築してもよいか？"></a><a id="3-1"></a> Q1. Azure 上にレプリケーション アプライアンスを構築してもよいか？</h3><p>A1. 技術的には、Azure 上にレプリケーション アプライアンスを構成して、利用することは可能です。<br>しかし、これまでの事例ですと、「Azure 上にレプリケーション アプライアンスを配置して、オンプレミス上のマシンを Azure Migrate で移行したい」というケースにて</p><ul><li>レプリケーションが非常に遅い</li><li>Azure Migrate の一連の処理がタイムアウトする、非常に時間がかかる</li></ul><p>といったお問い合わせを多数いただいております。<br>このようなトラブルシューティングの際には、弊社からは最終的に 改めてオンプレミス上にレプリケーション アプライアンスを再構築いただくようご依頼することが多くありますので、ご留意ください。</p><p>また、何らかの理由で レプリケーション アプライアンスを Azure 上に構成することをご検討の場合、必ず PoC など動作検証をお客様にて実施し、充分に検討いただくますようお願いいたします。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Migrate サポートです。&lt;br&gt;今回は Azure Migrate のエージェントベース シナリオにおける、レプリケーション アプライアンスをデプロイする際の注意事項について説明いたします。&lt;</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure Migrate" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Migrate/"/>
    
  </entry>
  
  <entry>
    <title>HSR に対する Azure Workload Backup</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureSAPBackup/How_to_HSR_workload_backup/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureSAPBackup/How_to_HSR_workload_backup/</id>
    <published>2024-12-04T03:00:00.000Z</published>
    <updated>2025-01-06T06:27:18.511Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、HSR に対する Azure Workload Backup を構成するにあたって、実際のバックアップ構成手順を作業例交えてお伝えします。</p><h4 id="ポイント"><a href="#ポイント" class="headerlink" title="ポイント"></a>ポイント</h4><ul><li>HANA システム レプリケーション (HSR) データベースの仕様上、HANA DB のユーザー名とパスワードは、Primary → Secondary へレプリケートされますが、hdbuserstore の情報（＝つまり、作成したキー情報）はレプリケートされません。</li><li>Azure Backup では、Primary/Seconday すべての ノード 上に対してバックアップ操作をさせるために、ユーザー名/パスワード 入力での操作ではなく、hdbuserstore キーの入力での操作を行う仕組みになっています。<br>このため、Azure Backup の事前登録スクリプト (msawb-plugin-config-com-sap-hana.sh) を実行する前に、2 種類のキーを Azure Backup 対象となる<font color="DeepPink">全ての</font> Azure 仮想マシン上 (ノード上) でも作成する必要があります。</li><li>下記の公開ドキュメントは必ずご一読の上で、作業ください。<br>・Azure VM 上の SAP HANA システム レプリケーション データベースをバックアップする<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup</a></li></ul><h4 id="環境構成"><a href="#環境構成" class="headerlink" title="環境構成"></a>環境構成</h4><p>今回は、同一 リージョン・サブスクリプション・VNET 上に 2 つの Azure 仮想マシンを作成し、それぞれ Primary ノード・Secondary ノードとします。</p><table><thead><tr><th>Azure 仮想マシン名</th><th>役割</th></tr></thead><tbody><tr><td>SAPHANA23</td><td>HSR Primary</td></tr><tr><td>SAPHANA24</td><td>HSR Secondary</td></tr></tbody></table><p>SAP HANA SID： hxe<br>SAP HANA インスタンス番号： 90<br>マルチデータベースコンテナー (MDC)</p><table><thead><tr><th>ユーザー</th><th>概要</th><th>作成するキー名</th></tr></thead><tbody><tr><td>SYSTEM</td><td>システムユーザー</td><td>SYSTEM</td></tr><tr><td>OKTBK</td><td>カスタム バックアップ ユーザー<br>新規で手動作成が必要<br>任意のユーザーを指定可能</td><td>OKTBKKEY</td></tr></tbody></table><h2 id="目次-手順概略"><a href="#目次-手順概略" class="headerlink" title="目次 - 手順概略"></a>目次 - 手順概略</h2><hr><p><a href="#1">1. (Primary マシン上) SYSTEM ユーザーに対してキーを設定する</a><br><a href="#2">2. (Primary マシン上) カスタム バックアップ ユーザーを作成・パスワード管理・ロールなどの設定を行う</a><br><a href="#3">3. (Primary マシン上) カスタム バックアップ ユーザーに対してキーを設定する</a><br><a href="#4">4. (Secondary マシン上) SYSTEM ユーザーに対してキーを設定する</a><br><a href="#5">5. (Secondary マシン上) カスタム バックアップ ユーザーに対してキーを設定する</a><br><a href="#6">6. (これまで Azure Backup 構成していた場合)「バックアップの停止」を行う</a><br><a href="#7">7. (Primary マシン上) 事前登録スクリプトをダウンロード・実行する</a><br><a href="#8">8. (Secondary マシン上) 事前登録スクリプトをダウンロード・実行する</a><br><a href="#9">9. Recovery Services コンテナー上で「データベースを検出」「バックアップの有効化」「今すぐバックアップ」を行う</a><br><a href="#10">10. FAQ</a></p><hr><p>※　SAP HANA 自体の環境構築・HSR の設定は、Azure Backup とは関りが無いため、すでに HSR 設定が完了している前提で本記事では説明を開始します。<br>　　記事内の<font color="Red">赤文字</font>・<font color="MediumBlue">青文字</font>などは、ユーザーの環境に依って異なります。</p><h2 id="1-Primary-マシン上-SYSTEM-ユーザーに対してキーを設定する"><a href="#1-Primary-マシン上-SYSTEM-ユーザーに対してキーを設定する" class="headerlink" title=" 1. (Primary マシン上) SYSTEM ユーザーに対してキーを設定する"></a><a id="1"></a> 1. (Primary マシン上) SYSTEM ユーザーに対してキーを設定する</h2><p>(参考) 公開ドキュメント - 事前登録スクリプトで実行される処理<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/tutorial-backup-sap-hana-db#what-the-pre-registration-script-does">https://learn.microsoft.com/ja-jp/azure/backup/tutorial-backup-sap-hana-db#what-the-pre-registration-script-does</a><br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_01.png" alt="image"></p><p>HANA DB を立ち上げ、設定します。<br>(Primary マシン上で実行するコマンド 例)<br>su <font color="Red">hxe</font>adm -<br>HDB start<br>hdbuserstore list<br>この時点では何もキーはありません。<br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_02.png" alt="image"></p><p>(Primary マシン上で実行するコマンド 例)<br>hdbuserstore Set <font color="Red">SYSTEM</font> <font color="MediumBlue">saphana23</font>:3<font color="Red">90</font>13 <font color="MediumBlue">&lt;キー名&gt;</font> <font color="Red">&lt;パスワード&gt;</font><br>hdbuserstore list</p><p>今回は、SYSTEM ユーザーに対して設定するキーの名前も「SYSTEM」としています。<br>下図の通り、「SYSTEM」という名前のキーが作成されていることを確認します。<br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_03.png" alt="image"></p><h2 id="2-Primary-マシン上-カスタム-バックアップ-ユーザーを作成・パスワード管理・ロールなどの設定を行う"><a href="#2-Primary-マシン上-カスタム-バックアップ-ユーザーを作成・パスワード管理・ロールなどの設定を行う" class="headerlink" title=" 2. (Primary マシン上) カスタム バックアップ ユーザーを作成・パスワード管理・ロールなどの設定を行う"></a><a id="2"></a> 2. (Primary マシン上) カスタム バックアップ ユーザーを作成・パスワード管理・ロールなどの設定を行う</h2><p>・(参考) 事前登録スクリプトを実行する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script</a><br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_04.png" alt="image"></p><p>カスタム バックアップ ユーザー名は、特に名前の制約はありません。<br>今回は例として「OKTBK」という名前のカスタム バックアップ ユーザーを作成します。</p><p>(Primary マシン上で実行するコマンド 例)<br>hdbsql -t -U <font color="Red">SYSTEM</font> CREATE USER <font color="MediumBlue">OKTBK</font> PASSWORD <font color="Red">&lt;パスワード&gt;</font> NO FORCE_FIRST_PASSWORD_CHANGE</p><p>「-U」の引数として、前段で作成済のキー「SYSTEM」を渡すことで、新しいユーザーをキーを使って作成することができます。<br>「NO FORCE_FIRST_PASSWORD_CHANGE」句は必須ではありませんが、設定することで、ユーザー「OKTBK」が初めてログインした際に、パスワード変更を求められることが無くなります。<br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_05.png" alt="image"></p><p>下図は念のため、「USERS」テーブル上にカスタム バックアップ ユーザー「OKTBK」が作成されたことを確認しています。<br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_06.png" alt="image"></p><p>付与すべきロールは公開ドキュメントに記載があるので、今回は SQL を使用してロールを付与していきます。</p><p>〇　カスタム バックアップ ユーザー「OKTBK」のパスワードの期限を無効化する<br>hdbsql -t -U <font color="Red">SYSTEM</font> “ALTER USER <font color="Red">OKTBK</font> DISABLE PASSWORD LIFETIME”</p><p>・(参考) 事前登録スクリプトを実行する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script</a><br>　“このカスタム バックアップ キーのパスワード有効期限が切れると、バックアップと復元操作は失敗します。”</p><p>〇　カスタム バックアップ ユーザー「OKTBK」を Activate する<br>hdbsql -t -U <font color="Red">SYSTEM</font> “ALTER USER <font color="Red">OKTBK</font> ACTIVATE USER NOW”</p><p>〇　カスタム バックアップ ユーザー「OKTBK」に対して「データベース管理者」ロールを付与する<br>hdbsql -t -U <font color="Red">SYSTEM</font> “GRANT <font color="Green">DATABASE ADMIN</font> TO <font color="Red">OKTBK</font>“</p><p>〇　カスタム バックアップ ユーザー「OKTBK」に対して「CATALOG READ（＝バックアップ カタログを読み取れる）」ロールを付与する<br>hdbsql -t -U <font color="Red">SYSTEM</font> “GRANT <font color="Green">CATALOG READ</font> TO <font color="Red">OKTBK</font>“<br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_07.png" alt="image"></p><p>〇　カスタム バックアップ ユーザー「OKTBK」に対して「バックアップ管理者」ロールを付与する<br>HANA の SPS バージョンが「05」以上であれば「バックアップ管理者」ロールの付与も必要です。<br>今回の環境だと「SPS ：06」のため、「バックアップ管理者」ロールの付与も必要です。</p><p>HDB version<br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_08.png" alt="image"></p><p>・(外部サイト 参考) GRANT Statement (Access Control) | SAP Help Portal<br>　<a href="https://help.sap.com/docs/SAP_HANA_PLATFORM/4fe29514fd584807ac9f2a04f6754767/20f674e1751910148a8b990d33efbdc5.html">https://help.sap.com/docs/SAP_HANA_PLATFORM/4fe29514fd584807ac9f2a04f6754767/20f674e1751910148a8b990d33efbdc5.html</a> </p><p>hdbsql -t -U <font color="Red">SYSTEM</font> “GRANT <font color="Green">BACKUP ADMIN</font> TO <font color="Red">OKTBK</font>“<br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_09.png" alt="image"></p><p>念のためカスタム バックアップ ユーザー「OKTBK」に、現時点で付与されているロールを「GRANTED_PRIVILEGES」テーブルから確認してみます。<br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_10.png" alt="image"></p><h2 id="3-Primary-マシン上-カスタム-バックアップ-ユーザーに対してキーを設定する"><a href="#3-Primary-マシン上-カスタム-バックアップ-ユーザーに対してキーを設定する" class="headerlink" title=" 3. (Primary マシン上) カスタム バックアップ ユーザーに対してキーを設定する"></a><a id="3"></a> 3. (Primary マシン上) カスタム バックアップ ユーザーに対してキーを設定する</h2><p>・(参考) 事前登録スクリプトを実行する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script</a><br>　“カスタム バックアップ ユーザーの hdbuserstore にキーを追加します。これにより、HANA バックアップ プラグインですべての操作 (データベース クエリ、復元操作、構成、バックアップの実行) を管理できるようになります。”</p><p>(実行するコマンド)<br>hdbuserstore Set &lt;作成するキー名&gt; &lt;作成先HANA DB のホスト名&gt;:3&lt;インスタンス番号&gt;13 &lt;カスタム バックアップ ユーザー名&gt; &lt;カスタム バックアップ ユーザーのパスワード&gt;</p><p>※ 下記は、仮想 IP は使用していない前提のコマンド例を記載しています。</p><p>(Primary マシン上で実行するコマンド 例)<br>hdbuserstore Set <font color="Red">OKTBKKEY</font> <font color="MediumBlue">saphana23</font>:3<font color="Red">90</font>13 <font color="MediumBlue">OKTBK</font> <font color="Red">&lt;パスワード&gt;</font></p><p>キーが作成されているかどうかを確認します。<br>hdbuserstore list<br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_11.png" alt="image"></p><div class="alert is-info"><p class="alert-title">Note</p><p>※ 仮想 IP を使用して クラスタ構成・HSR 構成を行っている場合、公開ドキュメントのとおりローカル ホストではなくロード バランサーのホスト/IP を使用してカスタム バックアップ キーを作成してください</p><p>・(参考) 事前登録スクリプトを実行する</p><p><a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script</a></p><p><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_30.png" alt="image"></p><p>例えば「10.1.0.13」をクラスタ構成時の仮想 IP としている場合、カスタム バックアップ ユーザーに対するキー作成時には、この仮想 IP アドレスを用いて作成します</p><p><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_31.png" alt="image"></p><p><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_32.png" alt="image"></p><p><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_33.png" alt="image"></p></div><h2 id="4-Secondary-マシン上-SYSTEM-ユーザーに対してキーを設定する"><a href="#4-Secondary-マシン上-SYSTEM-ユーザーに対してキーを設定する" class="headerlink" title=" 4. (Secondary マシン上) SYSTEM ユーザーに対してキーを設定する"></a><a id="4"></a> 4. (Secondary マシン上) SYSTEM ユーザーに対してキーを設定する</h2><p>Primary マシン上で、SYSTEM ユーザーに対して設定したものと同じキー名のキーを作成・設定します。</p><p>(Secondary マシン上で実行するコマンド 例)<br>hdbuserstore Set <font color="Red">SYSTEM</font> <font color="MediumBlue">saphana24</font>:3<font color="Red">90</font>13 SYSTEM <font color="MediumBlue">&lt;パスワード&gt;</font><br>hdbuserstore list<br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_12.png" alt="image"></p><h2 id="5-Secondary-マシン上-カスタム-バックアップ-ユーザーに対してキーを設定する"><a href="#5-Secondary-マシン上-カスタム-バックアップ-ユーザーに対してキーを設定する" class="headerlink" title=" 5. (Secondary マシン上) カスタム バックアップ ユーザーに対してキーを設定する"></a><a id="5"></a> 5. (Secondary マシン上) カスタム バックアップ ユーザーに対してキーを設定する</h2><p>（補足）<br>Primary マシン上で作成したカスタム バックアップ ユーザーとそのパスワードは、HSR の機能によって、自動的に Secondary マシンへレプリケートされます。<br>このためすでに HSR 設定済であれば Secondary マシン上では再度「カスタム バックアップ ユーザーの作成」を行う必要はありませんが、この段階でもし HSR 設定が完了しておらず、レプリケートしていない場合は、ユーザーにて Secondary マシン上にも再度「カスタム バックアップ ユーザーの作成」から作業ください。<br>ここでは、すでに HSR 機能にてカスタム バックアップ ユーザーはレプリケートされている前提で、Secondary マシン上での「カスタム バックアップ ユーザーの作成」部分はスキップします。</p><p>※ 下記は、仮想 IP は使用していない前提のコマンド例を記載しています。</p><p>(実行するコマンド)<br>hdbuserstore Set &lt;作成するキー名&gt; &lt;作成先HANA DB のホスト名&gt;:3&lt;インスタンス番号&gt;13 &lt;カスタム バックアップ ユーザー名&gt; &lt;カスタム バックアップ ユーザーのパスワード&gt;</p><p>(Secondary マシン上で実行するコマンド 例)<br>hdbuserstore Set <font color="Red">OKTBKKEY</font> <font color="MediumBlue">saphana24</font>:3<font color="Red">90</font>13 <font color="MediumBlue">OKTBK</font> <font color="Red">&lt;パスワード&gt;</font><br>hdbuserstore list<br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_13.png" alt="image"></p><div class="alert is-info"><p class="alert-title">Note</p><p>※ Primary マシン側と同様、仮想 IP を使用して クラスタ構成・HSR 構成を行っている場合、公開ドキュメントのとおりローカル ホストではなくロード バランサーのホスト/IP を使用してカスタム バックアップ キーを作成してください</p><p>例えば「10.1.0.13」をクラスタ構成時の仮想 IP としている場合、カスタム バックアップ ユーザーに対するキー作成時には、この仮想 IP アドレスを用いて作成します</p><p><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_34.png" alt="image"></p></div><h2 id="6-これまで-Azure-Backup-構成していた場合-「バックアップの停止」を行う"><a href="#6-これまで-Azure-Backup-構成していた場合-「バックアップの停止」を行う" class="headerlink" title=" 6. (これまで Azure Backup 構成していた場合)「バックアップの停止」を行う"></a><a id="6"></a> 6. (これまで Azure Backup 構成していた場合)「バックアップの停止」を行う</h2><p>『これまで スタンドアロンの SAP HANA DB として、Azure workload Backup を構成していた』<br>という場合、対象の SAP HANA DB は今後「HSR に対する Azure Workload Backup」としてバックアップ構成しなおすことになります。<br>このため、一度、これまでバックアップ取得していたスタンドアロンの SAP HANA DB に対しては<br>「バックアップ データの保持」・「バックアップの停止」を行ってください。</p><p>・(参考 「バックアップの停止」部分まで) 2 つのスタンドアロン VM/1 つのスタンドアロン VM が Azure VM 上の SAP HANA Database バックアップを使用して既に保護されている<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#two-standalone-vms-one-standalone-vm-already-protected-using-sap-hana-database-backup-on-azure-vm">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#two-standalone-vms-one-standalone-vm-already-protected-using-sap-hana-database-backup-on-azure-vm</a></p><p>『これまで一度も、対象 DB に対して Azure Workload Backup を構成したことが無い』<br>『今回初めて HSR 構成・HSR に対する Azure Workload Backup を行う』<br>という場合は、「6」手順はスキップし、「7. (Primary マシン上) 事前登録スクリプトをダウンロード・実行する」より作業を再開ください。</p><h2 id="7-Primary-マシン上-事前登録スクリプトをダウンロード・実行する"><a href="#7-Primary-マシン上-事前登録スクリプトをダウンロード・実行する" class="headerlink" title=" 7. (Primary マシン上) 事前登録スクリプトをダウンロード・実行する"></a><a id="7"></a> 7. (Primary マシン上) 事前登録スクリプトをダウンロード・実行する</h2><p>・(参考) 事前登録スクリプトを実行する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script</a></p><p>(ルートユーザーで実行するコマンド)<br>./msawb-plugin-config-com-sap-hana.sh -sn -bk &lt;カスタム バックアップ ユーザー向けに作成したキー名&gt; -hn (HSR ID)</p><p>【引数の説明】<br>■　-sn ( –skip-network-checks )： ネットワーク要件を満たしているかどうかのチェック処理をスキップしたい場合、追加ください<br>■　-bk ( -backup-key )：カスタム バックアップ ユーザー向けに作成したキー名を引数として渡してください<br>■　-hn (–hsr-unique-value)：HSR ID。Recovery Services コンテナー上での論理名を引数として渡します。この値はユーザーにて自由に決定ください</p><p>・(コマンド引数の参考) 事前登録スクリプトを実行する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script</a><br>　“このカスタム バックアップ ユーザー キーを、パラメーターとしてスクリプトに渡します。<br>　 -bk CUSTOM_BACKUP_KEY_NAME または -backup-key CUSTOM_BACKUP_KEY_NAME”</p><p>そのほか引数の説明は、事前登録スクリプト内に詳しく記載されています。</p><p>今回は例として「Hana2324LC」を HSR ID として、バックアップ構成します。</p><p>(Primary マシン上で実行するコマンド 例)<br>sudo su -<br>chmod 755 msawb-plugin-config-com-sap-hana.sh<br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_14.png" alt="image"></p><p>./msawb-plugin-config-com-sap-hana.sh -sn -bk <font color="Red">OKTBKKEY</font> -hn <font color="Red">Hana2324LC</font><br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_15.png" alt="image"></p><p><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_16.png" alt="image"></p><p>事前登録スクリプト実行完了後、下記 ファイル上で、Azure Backup 構成における HSR ID やカスタム バックアップ ユーザーの設定値を確認できます。</p><p>(Primary マシン上で実行するコマンド 例)<br>cat /opt/msawb/etc/config/SAPHana/config.json<br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_17.png" alt="image"></p><p>Primary 側で事前登録スクリプトを実行後、カスタム バックアップ ユーザーに対して、「INIFILE ADMIN」ロールなどが追加付与されていることが分かります。<br>(事前登録スクリプトにて追加付与されました)<br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_18.png" alt="image"></p><h2 id="8-Secondary-マシン上-事前登録スクリプトをダウンロード・実行する"><a href="#8-Secondary-マシン上-事前登録スクリプトをダウンロード・実行する" class="headerlink" title=" 8. (Secondary マシン上) 事前登録スクリプトをダウンロード・実行する"></a><a id="8"></a> 8. (Secondary マシン上) 事前登録スクリプトをダウンロード・実行する</h2><p><font color="DeepPink">「-hn」引数に渡す、一意の HSR ID は、必ず Primary 側にて設定したものとおなじ HSR ID にしてください。</font></p><p>(ルートユーザーで実行するコマンド)<br>./msawb-plugin-config-com-sap-hana.sh -sn -bk &lt;カスタム バックアップ ユーザー向けに作成したキー名&gt; -hn (HSR ID) -p &lt;ポート番号&gt;</p><p>・(参考) 事前登録スクリプトを実行する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script</a><br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_19.png" alt="image"></p><p>(Secondary マシン上で実行するコマンド 例)<br>sudo su -<br>./msawb-plugin-config-com-sap-hana.sh -sn -bk <font color="Red">OKTBKKEY</font> -hn <font color="MediumBlue">Hana2324LC</font> -p 3<font color="Red">90</font>13<br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_20.png" alt="image"></p><p><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_21.png" alt="image"></p><p>cat /opt/msawb/etc/config/SAPHana/config.json<br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_22.png" alt="image"></p><h2 id="9-Recovery-Services-コンテナー上で「データベースを検出」「バックアップの有効化」「今すぐバックアップ」を行う"><a href="#9-Recovery-Services-コンテナー上で「データベースを検出」「バックアップの有効化」「今すぐバックアップ」を行う" class="headerlink" title=" 9. Recovery Services コンテナー上で「データベースを検出」「バックアップの有効化」「今すぐバックアップ」を行う"></a><a id="9"></a> 9. Recovery Services コンテナー上で「データベースを検出」「バックアップの有効化」「今すぐバックアップ」を行う</h2><p>ここからは下記公開ドキュメントに沿って、Azure ポータル画面上で操作ください。</p><p>・データベースを検出する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#discover-the-databases">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#discover-the-databases</a></p><p>(英語版となり恐縮ですが) Azure ポータル画面上の作業例です<br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_23.png" alt="image"></p><p><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_24.png" alt="image"></p><p><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_25.png" alt="image"></p><p><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_26.png" alt="image"></p><p><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_27.png" alt="image"></p><p><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_28.png" alt="image"></p><p>(バックアップ取得後)<br><img src="/blog/AzureSAPBackup/How_to_HSR_workload_backup/How_to_HSR_workload_backup_29.png" alt="image"></p><h2 id="10-FAQ"><a href="#10-FAQ" class="headerlink" title=" 10. FAQ"></a><a id="10"></a> 10. FAQ</h2><h3 id="Q1-HSR-構成に伴い、クラスタ-ソフトウェアは-Pacemaker-Lifekeeper-など制限はありますか？"><a href="#Q1-HSR-構成に伴い、クラスタ-ソフトウェアは-Pacemaker-Lifekeeper-など制限はありますか？" class="headerlink" title="Q1. HSR 構成に伴い、クラスタ ソフトウェアは Pacemaker, Lifekeeper など制限はありますか？"></a>Q1. HSR 構成に伴い、クラスタ ソフトウェアは Pacemaker, Lifekeeper など制限はありますか？</h3><p>A1. 「HSR に対する Azure Workload Backup」の観点においては、クラスタ ソフトウェアの制限はありません。<br>ユーザー側にて HSR を構成し、HSR が機能しているのであれば、 Azure Backup としてはバックアップ取得が可能です。</p><h3 id="Q2-事前登録スクリプトを実行する前に、HANA-側で-HSR-設定を完了しておく必要はありますか？"><a href="#Q2-事前登録スクリプトを実行する前に、HANA-側で-HSR-設定を完了しておく必要はありますか？" class="headerlink" title="Q2. 事前登録スクリプトを実行する前に、HANA 側で HSR 設定を完了しておく必要はありますか？"></a>Q2. 事前登録スクリプトを実行する前に、HANA 側で HSR 設定を完了しておく必要はありますか？</h3><p>A2. いいえ、下記順序でも構いません。<br>　事前登録スクリプト実行<br>　　↓<br>　HSR 構成<br>　　↓<br>　「データベースを検出」「バックアップの有効化」バックアップ取得</p><p>・Azure Backup のデータベースで SAP HANA ネイティブ クライアント バックアップを実行する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-sap-hana-native-clients-backup-on-a-database-with-azure-backup">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-sap-hana-native-clients-backup-on-a-database-with-azure-backup</a></p><h3 id="Q3-HANA-Studio-からバックアップ・復元操作はできますか？"><a href="#Q3-HANA-Studio-からバックアップ・復元操作はできますか？" class="headerlink" title="Q3. HANA Studio からバックアップ・復元操作はできますか？"></a>Q3. HANA Studio からバックアップ・復元操作はできますか？</h3><p>A3. いいえ、HSR に対する Azure Workload Backup 構成をしている場合は、HANA Studio からの操作はサポートいたしておりません。</p><p>・(参考) SAP HANA ネイティブ クライアントを使用して操作を管理する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-manage#manage-operations-using-sap-hana-native-clients">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-manage#manage-operations-using-sap-hana-native-clients</a><br>　“HANA ネイティブ クライアントは、Backint ベースの操作用のみに統合されています。<br>　　スナップショットと HANA システム レプリケーション モードに関連する操作は、現在サポートされていません。”</p><p>HSR に対する Azure Workload Backup の設定方法は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、HSR に対する Azure Workload Backup を構成するにあたって、実際のバックアップ構成手順を作業例交えてお伝えします。&lt;/p&gt;
&lt;h4</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure SAPHANA Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-SAPHANA-Backup/"/>
    
  </entry>
  
  <entry>
    <title>ビジネス継続性センターからバックアップ センターに移動する方法</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/HowToMoveToBCFromABCC/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/HowToMoveToBCFromABCC/</id>
    <published>2024-12-02T03:00:00.000Z</published>
    <updated>2025-01-06T06:27:18.459Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回はビジネス継続性センターからバックアップ センターに移動する手順を説明します。  </p><p>2023 年 11 月からパブリック プレビューが開始されましたビジネス継続性センターは、<strong>バックアップ センターの拡張版として設定されており、最終的にはバックアップ センターと置き換えられる予定となっています。</strong><br>そのため現在ではバックアップ センターは、すべての地域で Azure ポータルの検索結果に表示されなくなりました。  </p><p>バックアップ センターは Azure ポータルの検索から削除されましたが、バックアップ センターがビジネス継続性センターに置き換わる前にお客様が適応できるように、ビジネス継続性センターからバックアップ センターに移動するオプションが用意されています。<br>※ このオプションは今後削除される可能性がございます。  </p><p>ビジネス継続性センターの詳細については下記ドキュメントをご参照ください。<br>・Azure Business Continuity センターとは | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/business-continuity-center/business-continuity-center-overview">https://learn.microsoft.com/ja-jp/azure/business-continuity-center/business-continuity-center-overview</a></p><h2 id="ビジネス継続性センターからバックアップ-センターを開く方法"><a href="#ビジネス継続性センターからバックアップ-センターを開く方法" class="headerlink" title="ビジネス継続性センターからバックアップ センターを開く方法"></a>ビジネス継続性センターからバックアップ センターを開く方法</h2><p>バックアップ センターを起動したい場合は、まず Azure ポータルの検索から 「ビジネス継続性センター」 に移動してください。<br><img src="/blog/AzureBackupGeneral/HowToMoveToBCFromABCC/HowToMoveToBCFromABCC_1.png"></p><p>その後、ビジネス継続性センターの 「ヘルプ」 メニューから 「バックアップ センターに移動」 を選択してください。<br><img src="/blog/AzureBackupGeneral/HowToMoveToBCFromABCC/HowToMoveToBCFromABCC_2.png"></p><p>バックアップ センターに移動する場合は、その理由をフィードバックすることができます。<br>お客様のフィードバックは、ビジネス継続性センターの体験を向上させるために非常に貴重です。<br>欠けている機能、パフォーマンスの問題、またはその他の懸念事項を含めてお知らせいただけますと幸いです。<br><img src="/blog/AzureBackupGeneral/HowToMoveToBCFromABCC/HowToMoveToBCFromABCC_3.png"></p><p>説明は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回はビジネス継続性センターからバックアップ センターに移動する手順を説明します。  &lt;/p&gt;
&lt;p&gt;2023 年 11 月からパブリック プレビューが開始されま</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup と Azure Site Recovery による DR 要件について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/DR_ASR_or_VMBackup/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/DR_ASR_or_VMBackup/</id>
    <published>2024-11-05T03:00:00.000Z</published>
    <updated>2025-01-06T06:27:18.435Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは。Azure Backup 、Azure Site Recovery 担当です。<br>今回は Azure のリージョン障害などを想定した Azure VM の Disaster Recovery (DR) 対策を検討中のお客様よりお問合せをいただきます「Azure VM Backup と Azure Site Recovery どちらを利用すればいいのか？」について解説させていただきます。</p><p>結論としては、お客様の DR 要件である RTO, RPO をクリアにしていただく必要があり、ここがクリアになれば Azure VM Backup と Azure Site Recovery どちらを選択すればいいか判断できるようになると存じます。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. DR, RTO, RPO について</a><br>   <a href="#1-1">  1.1 Disaster Recovery (DR)</a><br>   <a href="#1-2">  1.2 Recovery Time Objective (RTO)</a><br>   <a href="#1-3">  1.3 Recovery Point Objective (RPO)</a><br><a href="#2">2. Azure VM Backup と Azure Site Recovery の比較</a><br><a href="#2">3. 参考情報 : DR 対策のための Azure VM のディスクの冗長構成は非推奨</a></p><hr><h2 id="1-DR-RTO-RPO-について"><a href="#1-DR-RTO-RPO-について" class="headerlink" title=" 1. DR, RTO, RPO について"></a><a id="1"></a> 1. DR, RTO, RPO について</h2><p>まずは前提知識について DR, RTO, RPO について簡単に説明いたします。</p><h3 id="Disaster-Recovery-DR"><a href="#Disaster-Recovery-DR" class="headerlink" title=" Disaster Recovery (DR)"></a><a id="1-1"></a> Disaster Recovery (DR)</h3><p>大規模災害などの影響によりシステムやデータセンターが障害を受けた際に、利用できなくなったシステムを素早く復旧するための計画やそのような状態を未然に防ぐことを指します。<br>事業者様によって整備されている、BCP (事業継続計画) をご確認いただくことで後の RTO, RPO の指標が明確になるかと存じます。</p><h3 id="Recovery-Time-Objective-RTO"><a href="#Recovery-Time-Objective-RTO" class="headerlink" title=" Recovery Time Objective (RTO)"></a><a id="1-2"></a> Recovery Time Objective (RTO)</h3><p>「目標復旧時間」のことで、大規模災害などの影響によりシステムやデータセンターが障害を受けシステムが停止した時に、その時点から復旧までにかかる時間のことを指します。どのくらいの時間がダウンタイムとして許容できるかをご確認いただくのが良いかと存じます。</p><ul><li>ダウンタイムの許容時間は最大 24 時間。など</li></ul><p>・RTO (目標復旧時間)<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-backup-glossary#rto-recovery-time-objective">https://learn.microsoft.com/ja-jp/azure/backup/azure-backup-glossary#rto-recovery-time-objective</a></p><h3 id="Recovery-Point-Objective-RPO"><a href="#Recovery-Point-Objective-RPO" class="headerlink" title=" Recovery Point Objective (RPO)"></a><a id="1-3"></a> Recovery Point Objective (RPO)</h3><p>「目標復旧時点」のことで、大規模災害などの影響によりシステムやデータセンターが障害を受けシステムが停止した時に、過去のどの時点のデータまでを復旧できるかを指します。障害時点から復旧ポイントまでの間の時間のデータは復旧できないことになるため、データ復旧ができなくても許容できる時間をご確認いただくのが良いかと存じます。</p><ul><li>データ損失の許容時間は直前 12 時間以内。など</li></ul><p>・RPO (復旧ポイントの目標)<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-backup-glossary#rpo-recovery-point-objective">https://learn.microsoft.com/ja-jp/azure/backup/azure-backup-glossary#rpo-recovery-point-objective</a></p><h2 id="2-Azure-VM-Backup-と-Azure-Site-Recovery-の比較"><a href="#2-Azure-VM-Backup-と-Azure-Site-Recovery-の比較" class="headerlink" title=" 2. Azure VM Backup と Azure Site Recovery の比較"></a><a id="2"></a> 2. Azure VM Backup と Azure Site Recovery の比較</h2><p>以下は Azure VM Backup と Azure Site Recovery の比較表です。<br>1 時間以上のダウンタイム (RTO) が許容されない場合や、24 時間以上のデータ損失が許容されない場合など Azure VM Backup で対応できない場合には Azure Site Recovery の採用をご検討いただければと存じます。</p><table><thead><tr><th align="left">#</th><th align="left">Azure VM Backup</th><th align="left">Azure Site Recovery</th></tr></thead><tbody><tr><td align="left">機能</td><td align="left">Azure VM のバックアップを取得します。<br>Recovery Services コンテナーを GRS (または RA-GRS) にすることで、ペア リージョンへのバックアップ データのレプリケーションが行われペア リージョンでの復元ができるようになります。<br>[ご参考] ・ Azure VM Backup における CRR (クロスリージョン リストア) について<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/CRR/">https://jpabrs-scem.github.io/blog/AzureVMBackup/CRR/</a></td><td align="left">Azure VM のデータをターゲット リージョンのディスクへレプリケーションします。</td></tr><tr><td align="left">復旧ポイントの保持期間</td><td align="left">最大 99 年保持することができます。</td><td align="left">Unmanaged Disk では最大 72 時間 (3 日) 保持することができます。<br>Managed Disk では最大 15 日保持することができます。</td></tr><tr><td align="left">RTO に関する SLA</td><td align="left">RTO について SLA はありません。</td><td align="left">SLA で 1 時間以内の RTO を保証します。<br> [ご参考] ・Azure Site Recovery の SLA<br><a href="https://azure.microsoft.com/ja-jp/support/legal/sla/site-recovery/v1_2/">https://azure.microsoft.com/ja-jp/support/legal/sla/site-recovery/v1_2/</a><br>&gt;オンプレミスと Azure 間の計画上および計画外のフェールオーバー用に構成された保護された各インスタンスにつき、マイクロソフトは、1 時間の目標復旧時間を保証します。</td></tr><tr><td align="left">Recovery Time Objective (RTO)</td><td align="left">明確には定めておりません。<br> <strong>大容量の VM では復元に 24 時間以上かかる場合がございます。</strong><br>[ご参考] ・1.1 Azure VM Backup のバックアップ時間について<br>Azure Backup の バックアップ / リストア 所要時間について　<br><a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/Backup_RecoveryTIme/#1-1">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/Backup_RecoveryTIme/#1-1</a></td><td align="left">1 時間以内の RTO を提供します。</td></tr><tr><td align="left">Recovery Point Objective (RPO)</td><td align="left">スタンダード バックアップ ポリシーをご利用の場合、バックアップのスケジュールは 1 日 1 回となります。<br>その場合、最短の復元ポイント時点が 24 時間以上前となる場合がございます。<br>拡張バックアップ ポリシーをご利用の場合、バックアップのスケジュールは最短 4 時間おきのバックアップが可能です。<br> [ご参考] ・拡張ポリシーを使用して Azure VM をバックアップする<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal</a></td><td align="left">クラッシュ整合性復旧ポイントは 5 分ごとに取得されます。<br>アプリ整合性復旧ポイントは、レプリケーション ポリシーにて設定でき最短で 1 時間ごとにスケジュールできます。</td></tr></tbody></table><h2 id="3-参考情報-DR-対策のための-Azure-VM-のディスクの冗長構成は非推奨"><a href="#3-参考情報-DR-対策のための-Azure-VM-のディスクの冗長構成は非推奨" class="headerlink" title=" 3. 参考情報 : DR 対策のための Azure VM のディスクの冗長構成は非推奨"></a><a id="3"></a> 3. 参考情報 : DR 対策のための Azure VM のディスクの冗長構成は非推奨</h2><p>Azure VM では、Unmanaged Disk を利用している場合にストレージ アカウントの GRS は非推奨構成です。<br>そのため、Azure VM の DR 要件に関してはディスクの Azure VM Backup または ASR の利用をご検討いただき、ディスク単位での冗長構成については検討対象から外していただいた方が良いかと存じます。 </p><p>・ローカル冗長ストレージ - ローカル冗長ストレージ<br>　<a href="https://learn.microsoft.com/ja-jp/azure/storage/common/storage-redundancy#locally-redundant-storage">https://learn.microsoft.com/ja-jp/azure/storage/common/storage-redundancy#locally-redundant-storage</a></p><blockquote><p>シナリオで Azure アンマネージド ディスクを使用している場合は、LRS を選択できます。 GRS を使用する Azure アンマネージド ディスクのストレージ アカウントを作成することはできますが、非同期 geo レプリケーションの整合性に関する潜在的な問題のため、お勧めしません。</p></blockquote><p>本記事の内容は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは。Azure Backup 、Azure Site Recovery 担当です。&lt;br&gt;今回は Azure のリージョン障害などを想定した Azure VM の Disaster Recovery (DR) 対策を検</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup を意図的に失敗させる方法</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/</id>
    <published>2024-11-05T03:00:00.000Z</published>
    <updated>2025-01-06T06:27:18.695Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>アラートのテスト等のため “Azure VM Backup を失敗させたい” というお問い合わせをよくいただきます。<br>今回は、<strong>Azure VM Backup を意図的に失敗させる方法</strong>について、ご案内いたします。</p><p>(その他ブログで公開している Azure Backup の失敗方法)<br>・Azure VM Backup のデータ転送フェーズを意図的に失敗させる方法<br>　<a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_ttv/">https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_ttv/</a></p><p>・MARS バックアップ を意図的に失敗させる方法<br>　<a href="https://jpabrs-scem.github.io/blog/MARSBackup/How_to_fail_MARS_backup/">https://jpabrs-scem.github.io/blog/MARSBackup/How_to_fail_MARS_backup/</a></p><p>・Azure Files Backup を意図的に失敗させる方法<br>　<a href="https://jpabrs-scem.github.io/blog/AzureFilesBackup/How_to_fail_AFS_backup/">https://jpabrs-scem.github.io/blog/AzureFilesBackup/How_to_fail_AFS_backup/</a></p><h2 id="1-バックアップを故意に失敗させる方法-共有ディスクをアタッチする"><a href="#1-バックアップを故意に失敗させる方法-共有ディスクをアタッチする" class="headerlink" title="1. バックアップを故意に失敗させる方法 (共有ディスクをアタッチする)"></a>1. バックアップを故意に失敗させる方法 (共有ディスクをアタッチする)<a id="1"></a></h2><p>「共有ディスクを一時的にアタッチしてバックアップ ジョブを失敗させる」 方法をご紹介します。<br>Azure VM Backup において、共有ディスクのバックアップはサポートされていません。<br>この仕様を利用して、共有ディスクを対象の VM にアタッチすることでバックアップの失敗を意図的に発生させることが可能です。<br>この方法では、バックアップ ジョブ開始直後 ～ 30 分程度で 「UserErrorSharedDiskBackupNotSupported」 エラーで失敗する見込みです。</p><p>・VM ストレージのサポート | Azure VM バックアップのサポート マトリックス - Azure Backup | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#vm-storage-support">https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#vm-storage-support</a></p><h3 id="1-1-詳細手順"><a href="#1-1-詳細手順" class="headerlink" title="1.1.詳細手順"></a>1.1.詳細手順</h3><p>バックアップ 対象の VM に、Azure ポータル画面上で一時的に共有ディスクを追加アタッチします。<br>・Azure マネージド ディスクに対して共有ディスクを有効にする - Azure Virtual Machines | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/disks-shared-enable?tabs=azure-portal">https://learn.microsoft.com/ja-jp/azure/virtual-machines/disks-shared-enable?tabs=azure-portal</a></p><p><img src="/blog/AzureVMBackup/How_to_fail_VM_backup/How_to_fail_VM_backup_01.png" alt="image01"></p><p>(「SharedDisk02」は、共有ディスクリソースになっています)<br><img src="/blog/AzureVMBackup/How_to_fail_VM_backup/How_to_fail_VM_backup_02.png" alt="image02"></p><p>「今すぐバックアップ」をトリガーします。<br><img src="/blog/AzureVMBackup/How_to_fail_VM_backup/How_to_fail_VM_backup_03.png" alt="image03"></p><p>バックアップ ジョブ開始直後 ～ 30 分程度でバックアップ ジョブが「UserErrorSharedDiskBackupNotSupported」エラーにて失敗する見込みです。<br><img src="/blog/AzureVMBackup/How_to_fail_VM_backup/How_to_fail_VM_backup_04.png" alt="image04"></p><p><img src="/blog/AzureVMBackup/How_to_fail_VM_backup/How_to_fail_VM_backup_05.png" alt="image05"></p><p>バックアップ ジョブ エラーを確認した後は、一時的にアタッチしていた共有ディスクをデタッチします。</p><p>Azure VM Backup を意図的に失敗させる方法について、ご案内は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;アラートのテスト等のため “Azure VM Backup を失敗させたい” というお問い合わせをよくいただきます。&lt;br&gt;今回は、&lt;strong&gt;Azure V</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure Backup の障害調査に必要な情報</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigating/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigating/</id>
    <published>2024-11-05T03:00:00.000Z</published>
    <updated>2025-01-06T06:27:18.483Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートの山本です。<br>今回は Azure Backup のバックアップ失敗、リストア失敗の時の調査をするにあたり、提供いただきたい情報をお伝えいたします。<br>なお、 Azure Backup の障害調査にあたり NW 観点で取得いただきたいログに関しては下記をご覧ください<br>・Azure Backup の障害調査に必要な情報 (疎通確認)<br><a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/</a></p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Azure VM バックアップの障害調査に必要なログ</a><br>  <a href="#1-1">  1-1. Azure VM Backup の VSS 障害調査に追加で必要なログ</a><br><a href="#2">2.   Azure VM バックアップ の ファイルレベル リストア (ILRリストア) 失敗調査に必要なログ</a><br><a href="#3">3. Azure Backup for SAP HANA in Azure VM の障害調査に必要なログ</a><br><a href="#4">4. MARS Backup エージェントを利用したバックアップ の障害調査に必要なログ</a><br>  <a href="#4-1">4-1. Microsoft Azure Backup Agent のログ</a><br>  <a href="#4-2">4-2. システム情報</a><br>  <a href="#4-3">4-3. イベント ログ</a><br>  <a href="#4-4">4-4. 各種証明書の確認証跡およびインポート</a><br>   <a href="#4-4-1">4-4-1. 個人 ＞ 証明書</a><br>   <a href="#4-4-2">4-4-2. 信頼されたルート証明書 ＞ 証明書</a><br>   <a href="#4-4-3">4-4-3. 中間証明機関 ＞ 証明書</a><br>   <a href="#4-4-4">4-4-4. 証明書インポート手順</a></p><hr><h2 id="1-Azure-VM-バックアップの障害調査に必要なログ"><a href="#1-Azure-VM-バックアップの障害調査に必要なログ" class="headerlink" title="1. Azure VM バックアップの障害調査に必要なログ"></a>1. Azure VM バックアップの障害調査に必要なログ<a id="1"></a></h2><p>　*Azure VM Backup ではないですが  Azure Backup for SQL Server in Azure VM や Azure Backup for SAP HANA in Azure VM など Azure VM 上の DB のバックアップに関するものでも同様に必要です。<br>下記の <strong>環境情報</strong>と<strong>ログ情報</strong>の収集をお願いいたします。</p><p>*NVA などの場合、OS が対応していない可能性もございます。<br>(参考) 詳細は下記をご覧ください<br>・NVA のバックアップについて<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/NVA_backup/">https://jpabrs-scem.github.io/blog/AzureVMBackup/NVA_backup/</a></p><h3 id="環境情報"><a href="#環境情報" class="headerlink" title="環境情報"></a>環境情報</h3><p>・Subscription ID<br>・Recovery Services コンテナー名、およびそのリソースグループ名<br>・バックアップ対象 VM 名、およびそのリソースグループ名<br>・OS およびバージョン情報</p><h4 id="ログ情報"><a href="#ログ情報" class="headerlink" title="ログ情報"></a>ログ情報</h4><p>下記を参考に zip などにまとめてご提供いただけますと幸いです。</p><h4 id="・Windows-の場合"><a href="#・Windows-の場合" class="headerlink" title="・Windows の場合"></a>・Windows の場合</h4><blockquote><p>C:\Windows\System32\winevt\Logs<br>C:\WindowsAzure\</p></blockquote><h4 id="・Linuxの場合"><a href="#・Linuxの場合" class="headerlink" title="・Linuxの場合"></a>・Linuxの場合</h4><blockquote><p>/var/log/</p></blockquote><p>全量いただけることが望ましいですが、全量が困難な場合は下記をご提供ください。</p><blockquote><p>/var/log/azure/*<br>/var/log/syslog*<br>/var/log/waagent.*</p></blockquote><h3 id="1-1-Azure-VM-Backup-の-VSS-障害調査に追加で必要なログ"><a href="#1-1-Azure-VM-Backup-の-VSS-障害調査に追加で必要なログ" class="headerlink" title="1-1 . Azure VM Backup の VSS 障害調査に追加で必要なログ"></a>1-1 . Azure VM Backup の VSS 障害調査に追加で必要なログ<a id="1-1"></a></h3><p>Azure VM Backupの下記のようなエラーが出ることがございます。</p><blockquote><p>Error Code ：Snapshot operation failed due to VSS Writers in bad state.<br>Error Message ：ExtensionFailedVssWriterInBadState</p></blockquote><p>その場合には VSS 観点での調査が必要であるため、上記 <a href="#1">1. Azure VM バックアップの障害調査に必要なログ</a> に加えて下記 URL 先のログの採取をお願いします。<br> <strong>可能な限り “[A]”が望ましいですが、”[B]” の方法で採取いただいても、ある程度は調査が可能な場合がございます。</strong><br>・VSS エラーが発生している事象の調査<br><a href="https://jpwinsup.github.io/mslog/storage/vss/vss-error/">https://jpwinsup.github.io/mslog/storage/vss/vss-error/</a></p><p>また合わせて下記も関連するブログでございます。<br>・Azure VM Backupにおける整合性について<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#1-1-VSS-%E8%A6%B3%E7%82%B9%E3%81%A7%E3%81%AE%E8%AA%BF%E6%9F%BB%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#1-1-VSS-%E8%A6%B3%E7%82%B9%E3%81%A7%E3%81%AE%E8%AA%BF%E6%9F%BB%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6</a></p><h2 id="2-Azure-VM-バックアップ-の-ファイルレベル-リストア-ILRリストア-失敗調査に必要なログ"><a href="#2-Azure-VM-バックアップ-の-ファイルレベル-リストア-ILRリストア-失敗調査に必要なログ" class="headerlink" title="2.   Azure VM バックアップ の ファイルレベル リストア (ILRリストア) 失敗調査に必要なログ"></a>2.   Azure VM バックアップ の ファイルレベル リストア (ILRリストア) 失敗調査に必要なログ<a id="2"></a></h2><p>下記の <strong>環境情報</strong>と<strong>ログ情報</strong>の収集をお願いいたします。</p><h3 id="環境情報-1"><a href="#環境情報-1" class="headerlink" title="環境情報"></a>環境情報</h3><p>・Subscription ID<br>・Recovery Services コンテナー名、およびそのリソースグループ名<br>・バックアップ対象 VM 名、およびそのリソースグループ名、OS 名<br>・リストア先の VM 名、およびそのリソースグループ名、OS 名</p><h3 id="ログ情報-1"><a href="#ログ情報-1" class="headerlink" title="ログ情報"></a>ログ情報</h3><p>zip などにまとめてご提供いただけますと幸いです。</p><h4 id="・-Windows-の場合-“ディスクの管理”-の画面の画面ショット"><a href="#・-Windows-の場合-“ディスクの管理”-の画面の画面ショット" class="headerlink" title="・(Windows の場合) “ディスクの管理” の画面の画面ショット"></a>・(Windows の場合) “ディスクの管理” の画面の画面ショット</h4><p><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_01.png" alt="参考画像"></p><h4 id="・実行したスクリプト、および実行後に作成されたフォルダ一式"><a href="#・実行したスクリプト、および実行後に作成されたフォルダ一式" class="headerlink" title="・実行したスクリプト、および実行後に作成されたフォルダ一式"></a>・実行したスクリプト、および実行後に作成されたフォルダ一式</h4><ul><li><strong>Windowsの場合</strong><br>・スクリプトファイル：IaaSVMILRExeForWindows.exe<br>・スクリプト実行後に作成されるフォルダー：”仮想マシン名(小文字)”+”スクリプトファイル実行日時”</li></ul><p>　下記例では “okt-temp-win-20220212145642” が作成されています。<br><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_02.png"></p><p>“okt-temp-win-20220212145642”の中身<br><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_03.png" alt="&quot;okt-temp-win-20220212145642&quot;の中身"></p><ul><li><strong>Linux の場合</strong><br>・ILRのスクリプトファイル：例)　<strong>vm02kensho(小文字VM名)_1_jpe_6591639015130036692_802427195716_899298aac7c04bf094ad68bfc5b9584ed206b94b62d965.py</strong><br>・作成されたディレクトリの <strong>Scripts ディレクトリ一式</strong>：例） <strong>vm02kensho-20220212151619/Script</strong><br>スクリプトを実行後、「<strong>vm02kensho-20220212151619</strong>」ディレクトリが自動生成されていることがわかる。<br><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_04.png"></li></ul><blockquote><p>ls -all</p></blockquote><p><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_05.png" alt="「vm02kensho-20220212151619」ディレクトリが自動生成されている"></p><p>「vm02kensho-20220212151619」ディレクトリの中身、および作成されたディレクトリの <strong>Scripts ディレクトリ</strong>の中身は下記の通り</p><blockquote><p>ls -allR</p></blockquote><p><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_06.png" alt="「vm02kensho-20220212151619」ディレクトリの中身,および作成されたディレクトリの Scripts ディレクトリの中身"></p><h2 id="3-Azure-Backup-for-SAP-HANA-in-Azure-VM-の障害調査に必要なログ"><a href="#3-Azure-Backup-for-SAP-HANA-in-Azure-VM-の障害調査に必要なログ" class="headerlink" title="3. Azure Backup for SAP HANA in Azure VM の障害調査に必要なログ"></a>3. Azure Backup for SAP HANA in Azure VM の障害調査に必要なログ<a id="3"></a></h2><p><span style="color: red; "> <a href="#1">1. Azure VM バックアップの障害調査に必要なログ</a> の <strong>環境情報</strong> ならびに <strong>ログ情報 - Linuxの場合</strong> に加えて</span>下記もご対応お願いします。</p><p>*お手数ですが、全ての DB の backup.log 及び backint.log の採取をお願いします。</p><h3 id="SAP-HANAのbackup-log-及び-backint-log"><a href="#SAP-HANAのbackup-log-及び-backint-log" class="headerlink" title="SAP HANAのbackup.log 及び backint.log"></a>SAP HANAのbackup.log 及び backint.log</h3><blockquote><ul><li>xxにはインスタンスナンバーが入ります。<br>  ・/hana/shared/HXE/HDBxx/(hostname)/trace/backup.log<br>  ・/hana/shared/HXE/HDBxx/(hostname)/trace/DB_&lt;DB名&gt;/backup.log<br>  ・/hana/shared/HXE/HDBxx/(hostname)/trace/backint.log<br>  ・/hana/shared/HXE/HDBxx/(hostname)/trace/DB_&lt;DB名&gt;/backint.log</li></ul></blockquote><p>*上記パスに該当のログが無い場合は以下を試し、コマンド実行結果に表示されるディレクトリの場所の log をアップロードしてください。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo -i (rootユーザーに切り替えます)</span><br><span class="line">cd / (ディレクトリの最上層に移動します)</span><br><span class="line">find ./ -name &quot;backup.log&quot; (findコマンドにより該当のログの場所を特定します)</span><br><span class="line">find ./ -name &quot;backint.log&quot; (findコマンドにより該当のログの場所を特定します)</span><br></pre></td></tr></table></figure><h3 id="opt-配下の-log"><a href="#opt-配下の-log" class="headerlink" title="opt 配下の log"></a>opt 配下の log</h3><p>・/opt/msawb/var/log ディレクトリ配下のファイルを zip 等におまとめのうえで、アップロードしてください。</p><h2 id="4-MARS-Backup-エージェントを利用したバックアップ-の障害調査に必要なログ"><a href="#4-MARS-Backup-エージェントを利用したバックアップ-の障害調査に必要なログ" class="headerlink" title="4. MARS Backup エージェントを利用したバックアップ の障害調査に必要なログ"></a>4. MARS Backup エージェントを利用したバックアップ の障害調査に必要なログ<a id="4"></a></h2><h2 id="4-0-環境情報とWindowsログ"><a href="#4-0-環境情報とWindowsログ" class="headerlink" title="4.0 環境情報とWindowsログ"></a>4.0 環境情報とWindowsログ</h2><p><a href="#1">1. Azure VM バックアップの障害調査に必要なログ</a> の <strong>環境情報</strong> ならびに <strong>ログ情報 - Windows の場合</strong> の取得をお願いします。<br>*MARS バックアップ のバックアップ対象の環境が Azure VM でない場合は Azure VM 名 / VM リソース グループ名は不要です。</p><p>上記に加えて下記もご対応お願いします。</p><h3 id="4-1-Microsoft-Azure-Backup-Agent-のログ"><a href="#4-1-Microsoft-Azure-Backup-Agent-のログ" class="headerlink" title="4.1 Microsoft Azure Backup Agent のログ　"></a>4.1 Microsoft Azure Backup Agent のログ　<a id="4-1"></a></h3><p> まず、下記 リンク先から調査用スクリプトのダウンロードをお願いします。<br><a href="https://github.com/jpabrs-scem/blog/files/10148102/WABDiag.zip">WABDiag.zip</a></p><p>ダウンロードいただきました WABDiag.tx を .ps1 に変更して使用し、問題が発生しているマシンより Azure Backup ログの収集をお願いいたします。<br>※ ファイルの解凍パスワードは “AzureBackup” となります。</p><ol><li>WABDiag.ps1 を管理者権限の PowerShell で実行します。</li></ol><blockquote><p>実行コマンド: &lt;スクリプトのパス&gt;\WABDiag.ps1 &lt;パス\保存するフォルダ名&gt;<br>   実行例: C:\WABDiag\WABDiag.ps1 C:\Logs</p></blockquote><p>   実行結果にファイル パスが無い旨のメッセージが表示される可能性がございますが、対象のファイル自体が無い事を示すメッセージとなりますので、無視していただいて問題ございません。</p><p><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_07.png" alt="WABDiag.ps1出力ファイル"></p><h4 id="PowerShell-の実行ポリシーの制限によりスクリプトが実行できない場合"><a href="#PowerShell-の実行ポリシーの制限によりスクリプトが実行できない場合" class="headerlink" title="PowerShell の実行ポリシーの制限によりスクリプトが実行できない場合"></a>PowerShell の実行ポリシーの制限によりスクリプトが実行できない場合</h4><p>PowerShellを管理者権限で起動し、下記コマンドを実行し実行ポリシーを変更後、再度実行していただけますでしょうか。</p><blockquote><p>コマンド：Set-ExecutionPolicy Unrestricted</p></blockquote><p>また現在の実行ポリシーを後ほど元に戻す場合は、変更前に下記コマンドを実行し、設定されているポリシーを確認、メモし、スクリプト実行後に同様の手順で変更していただきますようお願いいたします。</p><blockquote><p>コマンド：Get-ExecutionPolicy </p></blockquote><ul><li>参考<br>・実行ポリシーについて - PowerShell<br><a href="https://docs.microsoft.com/ja-jp/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.2">https://docs.microsoft.com/ja-jp/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.2</a></li></ul><h3 id="4-2-システム情報"><a href="#4-2-システム情報" class="headerlink" title="4.2 システム情報 "></a>4.2 システム情報 <a id="4-2"></a></h3><ol><li>対象のマシンに管理者権限を保持するユーザーでログオンします。</li><li>管理者権限でコマンド プロンプトを起動し、以下のコマンドで取得します。<blockquote><p>msinfo32 /nfo &lt;出力ファイル名&gt;<br>実行例)  &gt; msinfo32 /nfo SVR_msinfo32.nfo</p></blockquote></li><li>生成されたファイルをご提供ください。<br><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_08.png" alt="システム情報"></li></ol><h3 id="4-3-イベント-ログ"><a href="#4-3-イベント-ログ" class="headerlink" title="4.3 イベント ログ"></a>4.3 イベント ログ<a id="4-3"></a></h3><ol><li>対象のマシンに管理者権限を保持するユーザーでログオンします。</li><li>[スタート] - [管理ツール] - [イベント ビューアー] を開きます。</li><li>左側ペインの以下のイベントに対して、右クリックをし、[すべてのイベントを名前をつけて保存] を選択し、ファイルの種類が “イベント ファイル (<em>.evtx)” であることを確認し、任意の名前を付けて、[保存] をクリックします。<br>(ファイルの種類が “イベント ファイル (</em>.csv)” も併せて取得をお願いいたします)<br>a) [イベント ビューアー (ローカル)] - [Windows ログ] - [システム]<br>b) [イベント ビューアー (ローカル)] - [Windows ログ] - [Application]</li><li>保存したイベント ログ ファイルをご提供ください。</li></ol><h3 id="4-4-各種証明書の確認証跡およびインポート"><a href="#4-4-各種証明書の確認証跡およびインポート" class="headerlink" title="4.4 各種証明書の確認証跡およびインポート"></a>4.4 各種証明書の確認証跡およびインポート<a id="4-4"></a></h3><p>下記詳細手順のもと、証明書 および 権限の確認を確認のうえ、画面ショットを zip などにおまとめの上ご提供お願いいたします。</p><p>*該当の証明書がない場合は下記 URL よりダウンロードしインポートをお願いします。<br>これによりMARS エージェントが立ち上がらないなどの場合の場合改善することがございます。</p><p>対象マシン上の「スタート」ボタンを右クリック＞「ファイル名を指定して実行」＞「certlm.msc」と入力して「OK」し、以下すべての証明書が存在するかご確認ください。<br><strong>（※ Windows Server 2012 以前の OS の場合は、MMC スナップインより証明書スナップインを起動してください）</strong></p><p><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_09.png"></p><p><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_10.png"></p><h3 id="4-4-1-個人-＞-証明書"><a href="#4-4-1-個人-＞-証明書" class="headerlink" title="4.4.1 個人 ＞ 証明書"></a>4.4.1 個人 ＞ 証明書<a id="4-4-1"></a></h3><blockquote><p>・CB_&lt;MARSのバックアップを実施する予定のRecovery Services コンテナー名&gt;-xx-xx-xxxx-vaultcredentials<br>・CB_&lt;ホスト名&gt;._xxxxxxxxxxxxxxxxxx<br>※　上記 2 が存在していることを確認の上、その画面スクリーンショットをご提供ください<br>（存在していない場合もございますので、その場合は、その点ご返信いただけますと幸いです。）<br><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_11.png"></p></blockquote><p>“<strong>・CB_&lt;ホスト名&gt;._xxxxxxxxxxxxxxxxxx</strong> の期限がきれている場合は正常に MARS エージェントが正常に起動しないことがあります。<br>下記を参考に再インストール をご実施ください。それにより証明書がインストールされます。<br>・MARS エージェントの再インストール手順<br><a href="https://jpabrs-scem.github.io/blog/MARSBackup/How_to_re-install/">https://jpabrs-scem.github.io/blog/MARSBackup/How_to_re-install/</a></p><h3 id="4-4-2-信頼されたルート証明書-＞-証明書"><a href="#4-4-2-信頼されたルート証明書-＞-証明書" class="headerlink" title="4.4.2 信頼されたルート証明書 ＞ 証明書 "></a>4.4.2 信頼されたルート証明書 ＞ 証明書 <a id="4-4-2"></a></h3><p>[参考]<br>・Azure TLS 証明書の変更<br><a href="https://learn.microsoft.com/ja-jp/azure/security/fundamentals/tls-certificate-changes#what-changed">https://learn.microsoft.com/ja-jp/azure/security/fundamentals/tls-certificate-changes#what-changed</a></p><p>[証明書zipダウンロード先]<br><a href="https://github.com/jpabrs-scem/blog/files/9615338/root.certificate.zip">root certificate.zip</a></p><blockquote><p>ルート証明書名    証明書の拇印<br><a href="https://cacerts.digicert.com/DigiCertGlobalRootG2.crt">DigiCert Global Root G2    : df3c24f9bfd666761b268073fe06d1cc8d4f82a4</a><br><a href="https://cacerts.digicert.com/DigiCertGlobalRootCA.crt">DigiCert Global Root CA    : a8985d3a65e5e5c4b2d7d66d40c6dd2fb19c5436</a><br><a href="https://cacerts.digicert.com/BaltimoreCyberTrustRoot.crt">Baltimore CyberTrust Root    : d4de20d05e66fc53fe1a50882c78db2852cae474</a><br><a href="https://www.d-trust.net/cgi-bin/D-TRUST_Root_Class_3_CA_2_2009.crt">D-TRUST Root Class 3 CA 2 2009    : 58e8abb0361533fb80f79b1b6d29d3ff8d5f00f0</a><br><a href="https://www.microsoft.com/pkiops/certs/Microsoft%20RSA%20Root%20Certificate%20Authority%202017.crt">Microsoft RSA Root Certificate Authority2017    : 73a5e64a3bff8316ff0edccc618a906e4eae4d74</a><br><a href="https://www.microsoft.com/pkiops/certs/Microsoft%20ECC%20Root%20Certificate%20Authority%202017.crt">Microsoft ECC Root Certificate Authority 2017    : 999a64c37ff47d9fab95f14769891460eec4c3c5</a></p></blockquote><p><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_12.png"></p><p>※　上記 6 つすべての証明書が存在していること (存在していない場合もございます)<br>・証明書をダブルクリックし、「詳細」タブ ＞ スクロールして下の方に「拇印」がありますので、値が上記と同一であることが確認し、その画面ショットをご提供ください。<br>（存在していない場合もございますので、その場合は、その点ご返信いただけますと幸いです。）</p><p><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_13.png"></p><h3 id="4-4-3-中間証明機関-＞-証明書"><a href="#4-4-3-中間証明機関-＞-証明書" class="headerlink" title="4.4.3 中間証明機関 ＞ 証明書 "></a>4.4.3 中間証明機関 ＞ 証明書 <a id="4-4-3"></a></h3><p>[参考]<br>・Azure Storage TLS: Changes are coming! (…and why you care)<br><a href="https://techcommunity.microsoft.com/t5/azure-storage-blog/azure-storage-tls-changes-are-coming-and-why-you-care/ba-p/1705518">https://techcommunity.microsoft.com/t5/azure-storage-blog/azure-storage-tls-changes-are-coming-and-why-you-care/ba-p/1705518</a></p><p>[証明書zipダウンロード先]<br><a href="https://github.com/jpabrs-scem/blog/files/9615291/intermediate.certificate.zip">intermediate certificate.zip</a></p><blockquote><p>中間証明書名    証明書の拇印<br><a href="http://www.microsoft.com/pki/mscorp/Microsoft%20RSA%20TLS%20CA%2001.crt">Microsoft RSA TLS CA 01    : 703d7a8f0ebf55aaa59f98eaf4a206004eb2516a</a><br><a href="http://www.microsoft.com/pki/mscorp/Microsoft%20RSA%20TLS%20CA%2002.crt">Microsoft RSA TLS CA 02    : b0c2d2d13cdd56cdaa6ab6e2c04440be4a429c75</a></p></blockquote><p>※　上記 2 つすべての証明書が存在していること<br>・証明書をダブルクリックし、「詳細」タブ ＞ スクロールして下の方に「拇印」がありますので、値が上記と同一であることが確認できる画面スクリーンショットをご提供ください。</p><p><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_14.png"></p><h3 id="4-4-4-証明書インポート手順"><a href="#4-4-4-証明書インポート手順" class="headerlink" title="4.4.4 証明書インポート手順 "></a>4.4.4 証明書インポート手順 <a id="4-4-4"></a></h3><ol><li>証明書をエクスポートしたいマシンに、管理者権限でログインします。</li><li>[スタート] - [ファイル名を指定して実行] から、certlm.msc と入力して、[Enter]キーを押します。<strong>（※ Windows Server 2012 以前の OS の場合は、MMC スナップインより証明書スナップインを起動してください）</strong></li><li>ユーザーアカウント制御 が起動する場合は管理者権限での実行を許可します。</li><li>左側の [証明書 (ローカル コンピューター)]を展開して、 [信頼されたルート証明機関] - [証明書] を開きます。</li><li>[証明書] を右クリックし [すべてのタスク] – [インポート] と選択します。</li><li>証明書のインポートウィザードが起動しますので以下の様に進めます。<br>・ 「証明書のインポート ウィザードの開始」画面で [次へ] をクリック。<br>・ インポートする証明書のファイル  -&gt;  (上記公開情報よりダウンロードした各証明書を保存したパス)<br>・ 証明書ストア -&gt; (“信頼されたルート証明機関” となっていることを確認)</li><li>「信頼されたルート証明機関」証明書ストアに証明書がインポートされた事を確認します。</li></ol><ul><li>中間証明書のインポート手順は、上記の「信頼されたルート証明機関」の箇所を「中間証明機関」にお読み替えいただけますようお願いいたします。</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートの山本です。&lt;br&gt;今回は Azure Backup のバックアップ失敗、リストア失敗の時の調査をするにあたり、提供いただきたい情報をお伝えいたします。&lt;br&gt;なお、 Azur</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="情報採取" scheme="https://jpabrs-scem.github.io/blog/tags/%E6%83%85%E5%A0%B1%E6%8E%A1%E5%8F%96/"/>
    
  </entry>
  
  <entry>
    <title>SQL Server DB に対する Azure Backupを、Proxy Serverをバイパスして PE 経由でバックアップする場合の設定</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureSQLBackup/How_to_PE_SQL_backup_bypass_proxy/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureSQLBackup/How_to_PE_SQL_backup_bypass_proxy/</id>
    <published>2024-11-05T03:00:00.000Z</published>
    <updated>2025-01-06T06:27:18.559Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、SQL Server DB に対する Azure Backupを、Proxy Serverをパイパスして PE 経由でバックアップする場合の設定方法についてお伝えします。</p><h4 id="ポイント"><a href="#ポイント" class="headerlink" title="ポイント"></a>ポイント</h4><h5 id="ポイントその-1"><a href="#ポイントその-1" class="headerlink" title="( ポイントその 1 )"></a>( ポイントその 1 )</h5><p>Poxyを経由させてSQL Server DB に対する Azure Backupを行いたい場合は、下記2種類のアカウントに対して、クライアントOS上でProxy設定を行う必要があります。<br>　１つ目：Local System アカウント<br>　２つ目：NT Service\AzureWLBackupPluginSvcアカウント</p><p>そのため、Proxyは経由せず（＝「Proxyをバイパスする」）、バックアップを取得したい場合は、上記 ２ つのアカウントに対してバイパス設定を行う必要があります。<br>※もともと２つのアカウントに対してProxy Server 設定を行っていないのであれば、SQL Server DB に対する Azure BackupにおいてProxyを経由してバックアップすることはありません。</p><p>上記２つのアカウントに対してProxyを設定している、かつ　Proxy を経由せずに、プライベート エンドポイント（PE）経由でSQL Backupをさせたい場合、下記をバイパスさせる必要があります。<br>（例外リスト/バイパスリスト）<br>    　LocalHost 、Wire Server （168.63.129.16）、169.254.169.254、以下ドキュメント記載のAzure Backup、Azure Storage、Microsoft Entra ID</p><p>・プライベート エンドポイントを使用して Recovery Services コンテナー用のプロキシ サーバーを設定する<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/private-endpoints#set-up-proxy-server-for-recovery-services-vault-with-private-endpoint">https://docs.microsoft.com/ja-jp/azure/backup/private-endpoints#set-up-proxy-server-for-recovery-services-vault-with-private-endpoint</a> </p><h5 id="ポイントその-2"><a href="#ポイントその-2" class="headerlink" title="( ポイントその 2 )"></a>( ポイントその 2 )</h5><p>本ブログ記事作成時点 (2024/10) では、Microsoft Entra ID はプライベート エンドポイントに対応していませんので、Microsoft Entra ID は PE 以外の疎通ルートを確立させる必要があります。</p><h2 id="目次-手順概略"><a href="#目次-手順概略" class="headerlink" title="目次 - 手順概略"></a>目次 - 手順概略</h2><hr><p><a href="#1">1. Recovery Services コンテナー上にプライベート エンドポイントを作成</a><br><a href="#2">2．バックアップ対象の SQL Server DB が存在する Azure 仮想マシン上で、Local System アカウントに対して、SQL Server DB に対する Azure Backup サービスがバイパスされるよう、設定</a><br><a href="#3">3. 「データベースの検出」「バックアップの有効化」</a><br><a href="#4">4. バックアップ対象の SQL Server DB が存在する Azure 仮想マシン上で、サービスアカウント ( NT Service\AzureWLBackupPluginSvc ) に対して、 SQL Server DB に対する Azure Backup サービスがバイパスされるよう、設定</a><br><a href="#5">5. SQL Server DB に対する Azure Backup「今すぐバックアップ」を実行</a></p><hr><h2 id="1-Recovery-Services-コンテナー上にプライベート-エンドポイントを作成"><a href="#1-Recovery-Services-コンテナー上にプライベート-エンドポイントを作成" class="headerlink" title=" 1. Recovery Services コンテナー上にプライベート エンドポイントを作成"></a><a id="1"></a> 1. Recovery Services コンテナー上にプライベート エンドポイントを作成</h2><p>こちらは 弊社公開ドキュメントに詳細手順を公開しておりますので、下記をご参考に作成ください。<br>・Azure Backup のプライベート エンドポイントの作成と使用<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/private-endpoints">https://docs.microsoft.com/ja-jp/azure/backup/private-endpoints</a> </p><h2 id="2．バックアップ対象の-SQL-Server-DB-が存在する-Azure-仮想マシン上で、Local-System-アカウントに対して、SQL-Server-DB-に対する-Azure-Backup-サービスがバイパスされるよう、設定"><a href="#2．バックアップ対象の-SQL-Server-DB-が存在する-Azure-仮想マシン上で、Local-System-アカウントに対して、SQL-Server-DB-に対する-Azure-Backup-サービスがバイパスされるよう、設定" class="headerlink" title=" 2．バックアップ対象の SQL Server DB が存在する Azure 仮想マシン上で、Local System アカウントに対して、SQL Server DB に対する Azure Backup サービスがバイパスされるよう、設定"></a><a id="2"></a> 2．バックアップ対象の SQL Server DB が存在する Azure 仮想マシン上で、Local System アカウントに対して、SQL Server DB に対する Azure Backup サービスがバイパスされるよう、設定</h2><h5 id="Local-System-アカウント-に対する-Proxy-Server-バイパス設定-手順詳細"><a href="#Local-System-アカウント-に対する-Proxy-Server-バイパス設定-手順詳細" class="headerlink" title="Local System アカウント に対する Proxy Server バイパス設定 手順詳細"></a>Local System アカウント に対する Proxy Server バイパス設定 手順詳細</h5><p>以下より PsExec をダウンロードします。​<br>​　・PsExec v2.2<br>　　<a href="https://docs.microsoft.com/ja-jp/sysinternals/downloads/psexec">https://docs.microsoft.com/ja-jp/sysinternals/downloads/psexec</a> </p><p>管理者特権のプロンプトから ダウンロードしたファイルを解凍したフォルダに移動し 、次のコマンドを実行して Internet Explorer を開きます。​<br>（実行コマンド）</p><blockquote><p>psexec -i -s “c:\Program Files\Internet Explorer\iexplore.exe”​</p></blockquote><p>Internet Explorer で、[ツール] &gt; [インターネット オプション] &gt; [接続] &gt; [LAN の設定] の順に移動します。​<br>システム アカウントの Proxy 設定を確認します。<br>Proxy の IP アドレスとポートを設定します。​</p><p>・下図例では、Proxy Server の IP アドレスが「10.2.0.16」である前提の画面スクリーンショットとなっています。<br>・下図中央の「Local Area Network (LAN) Settings」ウィンドウ ＞ 「Byspass proxy server for local addresses」チェックボックスを ON とします。<br>　これは、下記公開ドキュメント「VM 内の localhost 通信のプロキシを無効にします。」と記載している設定に該当しています。<br>　・トラフィックをルーティングするために HTTP プロキシ サーバーを使用する<br>　　<a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#use-an-http-proxy-server-to-route-traffic">https://docs.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#use-an-http-proxy-server-to-route-traffic</a></p><p>・下図一番右側の「Proxy Settings」ウィンドウ ＞ 「Exceptions」欄に記入すべきものが、SQL Server DB に対する Azure Backup 実行時 (= Local Sysytem アカウントが利用される際) に、Proxy Server を経由させずに通信したい場合のアドレスを入力する欄です。<br>　ここに、以下を記入することで、SQL Server DB に対する Azure Backup 実行時はプロキシをバイパスさせることができます。<br>　LocalHost 、Wire Server （168.63.129.16）、169.254.169.254、上記ドキュメント記載のAzure Backup、Azure Storage、Microsoft Entra ID</p><p>(実際の入力値)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">localhost;168.63.129.16;169.254.169.254;*.backup.windowsazure.com;*.queue.core.windows.net;</span><br><span class="line">*.blob.core.windows.net;*.blob.storage.azure.net;*.msftidentity.com;</span><br><span class="line">*.msidentity.com;account.activedirectory.windowsazure.com;accounts.accesscontrol.windows.net;</span><br><span class="line">adminwebservice.microsoftonline.com;api.passwordreset.microsoftonline.com;</span><br><span class="line">autologon.microsoftazuread-sso.com;becws.microsoftonline.com;</span><br><span class="line">clientconfig.microsoftonline-p.net;companymanager.microsoftonline.com;</span><br><span class="line">device.login.microsoftonline.com;graph.microsoft.com;graph.windows.net;login.microsoft.com;</span><br><span class="line">login.microsoftonline.com;login.microsoftonline-p.com;login.windows.net;</span><br><span class="line">logincert.microsoftonline.com;loginex.microsoftonline.com;login-us.microsoftonline.com;</span><br><span class="line">nexus.microsoftonline-p.com;passwordreset.microsoftonline.com;</span><br><span class="line">provisioningapi.microsoftonline.com;20.190.128.*;40.126.*;*.hip.live.com;*.microsoftonline.com;</span><br><span class="line">*.microsoftonline-p.com;*.msauth.net;*.msauthimages.net;*.msecnd.net;*.msftauth.net;</span><br><span class="line">*.msftauthimages.net;*.phonefactor.net;nterpriseregistration.windows.net;management.azure.com;</span><br><span class="line">policykeyservice.dc.ad.msft.net</span><br></pre></td></tr></table></figure><p><img src="/blog/AzureSQLBackup/How_to_PE_SQL_backup_bypass_proxy/How_to_PE_SQL_backup_bypass_proxy_01.png"></p><h2 id="3．「データベースの検出」「バックアップの有効化」"><a href="#3．「データベースの検出」「バックアップの有効化」" class="headerlink" title=" 3．「データベースの検出」「バックアップの有効化」"></a><a id="3"></a> 3．「データベースの検出」「バックアップの有効化」</h2><p>Azure ポータル画面上から、対象の SQL Server DB に対して「データベースの検出」「バックアップの有効化」を行います。</p><p>・コンテナーから複数の SQL Server VM をバックアップする - Azure Backup | Microsoft Docs<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#discover-sql-server-databases">https://docs.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#discover-sql-server-databases</a> </p><h2 id="4．バックアップ対象の-SQL-Server-DB-が存在する-Azure-仮想マシン上で、サービスアカウント-NT-Service-AzureWLBackupPluginSvc-に対して、-SQL-Server-DB-に対する-Azure-Backup-サービスがバイパスされるよう、設定"><a href="#4．バックアップ対象の-SQL-Server-DB-が存在する-Azure-仮想マシン上で、サービスアカウント-NT-Service-AzureWLBackupPluginSvc-に対して、-SQL-Server-DB-に対する-Azure-Backup-サービスがバイパスされるよう、設定" class="headerlink" title=" 4．バックアップ対象の SQL Server DB が存在する Azure 仮想マシン上で、サービスアカウント ( NT Service\AzureWLBackupPluginSvc ) に対して、 SQL Server DB に対する Azure Backup サービスがバイパスされるよう、設定"></a><a id="4"></a> 4．バックアップ対象の SQL Server DB が存在する Azure 仮想マシン上で、サービスアカウント ( NT Service\AzureWLBackupPluginSvc ) に対して、 SQL Server DB に対する Azure Backup サービスがバイパスされるよう、設定</h2><p>「バックアップの有効化」が成功後、Azure Backup サービスによって対象マシン上に生成済の「NT Service\AzureWLBackupPluginSvc」アカウントに対する、Proxy Server のバイパス設定を行います。<br>バイパスリストは  Local Sysytem アカウントに対して設定した内容と同一です。<br>下記に、「NT Service\AzureWLBackupPluginSvc」アカウントへの設定手順の一例を記載します。<br>一例としては、カレントユーザーに対して行ったProxy設定を、コマンド実行によって「NT Service\AzureWLBackupPluginSvc」アカウントに対して引き継ぐ手順です。<br>そのため、一時的にまずはカレントユーザーに対しても、Proxy Server のバイパス設定を行います。</p><h5 id="一例-「NT-Service-AzureWLBackupPluginSvc」アカウントに対する-Proxy-バイパス設定-手順詳細"><a href="#一例-「NT-Service-AzureWLBackupPluginSvc」アカウントに対する-Proxy-バイパス設定-手順詳細" class="headerlink" title="(一例) 「NT Service\AzureWLBackupPluginSvc」アカウントに対する Proxy バイパス設定 手順詳細"></a>(一例) 「NT Service\AzureWLBackupPluginSvc」アカウントに対する Proxy バイパス設定 手順詳細</h5><p>まずは「NT Service\AzureWLBackupPluginSvc」アカウントが存在しているかを、念のため確認します。<br>対象マシン上で、スタートボタンを右クリック ＞ ファイル名を指定して実行 ＞ 「regedit」を入力し「OK」をクリックします。<br><img src="/blog/AzureSQLBackup/How_to_PE_SQL_backup_bypass_proxy/How_to_PE_SQL_backup_bypass_proxy_02.png"></p><p><img src="/blog/AzureSQLBackup/How_to_PE_SQL_backup_bypass_proxy/How_to_PE_SQL_backup_bypass_proxy_03.png"></p><p>レジストリ エディターが開きますので、以下パスへ遷移します。<br>（対象パス）<br>        HKEY_USERS\S-1-5-80-1631947889-4033244730-3205203906-53534054-4184208151</p><p>上記レジストリキー (フォルダー)「S-1-5-80-1631947889-4033244730-3205203906-53534054-4184208151」が、「NT Service\AzureWLBackupPluginSvc」アカウントを表しています。<br>この時点で存在していない場合、「データベースの検出」「バックアップの有効化」もしくは「再登録」が正常完了していない可能性がありますので、「データベースの検出」「バックアップの有効化」「再登録」が成功しているかどうかを再度確認・再実行願います。<br><img src="/blog/AzureSQLBackup/How_to_PE_SQL_backup_bypass_proxy/How_to_PE_SQL_backup_bypass_proxy_04.png"></p><p>レジストリ エディター上でレジストリキー (フォルダー)「S-1-5-80-1631947889-4033244730-3205203906-53534054-4184208151」が存在していることを確認出来たら、一時的に カレントユーザーに対して Proxy Server の設定を行います。</p><p>・設定内容は、Local System アカウント に対する Proxy Server バイパス設定と同一です<br>・下図例 では、Proxy Server の IP アドレスが「10.2.0.16」である前提の画面スクリーンショットとなっています。<br>・下図中央の「Don’t use the proxy server for local (intranet) addresses」チェックボックスを ON とします。<br>　これは、下記公開ドキュメント「VM 内の localhost 通信のプロキシを無効にします。」と記載している設定に該当しています。<br>　・トラフィックをルーティングするために HTTP プロキシ サーバーを使用する<br>　　<a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#use-an-http-proxy-server-to-route-traffic">https://docs.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#use-an-http-proxy-server-to-route-traffic</a></p><p>・下図一番右側 黄色罫線箇所が、Proxy Server を経由させずに通信したい場合のアドレスを入力する欄です。<br>　ここに、以下を記入することで、SQL Server DB に対する Azure Backup 実行時はプロキシをバイパスさせることができます。<br>　LocalHost 、Wire Server （168.63.129.16）、169.254.169.254、上記ドキュメント記載のAzure Backup、Azure Storage、Microsoft Entra ID</p><p>(実際の入力値)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">localhost;168.63.129.16;169.254.169.254;*.backup.windowsazure.com;*.queue.core.windows.net;</span><br><span class="line">*.blob.core.windows.net;*.blob.storage.azure.net;*.msftidentity.com;</span><br><span class="line">*.msidentity.com;account.activedirectory.windowsazure.com;accounts.accesscontrol.windows.net;</span><br><span class="line">adminwebservice.microsoftonline.com;api.passwordreset.microsoftonline.com;</span><br><span class="line">autologon.microsoftazuread-sso.com;becws.microsoftonline.com;</span><br><span class="line">clientconfig.microsoftonline-p.net;companymanager.microsoftonline.com;</span><br><span class="line">device.login.microsoftonline.com;graph.microsoft.com;graph.windows.net;login.microsoft.com;</span><br><span class="line">login.microsoftonline.com;login.microsoftonline-p.com;login.windows.net;</span><br><span class="line">logincert.microsoftonline.com;loginex.microsoftonline.com;login-us.microsoftonline.com;</span><br><span class="line">nexus.microsoftonline-p.com;passwordreset.microsoftonline.com;</span><br><span class="line">provisioningapi.microsoftonline.com;20.190.128.*;40.126.*;*.hip.live.com;*.microsoftonline.com;</span><br><span class="line">*.microsoftonline-p.com;*.msauth.net;*.msauthimages.net;*.msecnd.net;*.msftauth.net;</span><br><span class="line">*.msftauthimages.net;*.phonefactor.net;nterpriseregistration.windows.net;management.azure.com;</span><br><span class="line">policykeyservice.dc.ad.msft.net</span><br></pre></td></tr></table></figure><p><img src="/blog/AzureSQLBackup/How_to_PE_SQL_backup_bypass_proxy/How_to_PE_SQL_backup_bypass_proxy_05.png"></p><p>カレントユーザーに対して、Proxy Server のバイパス設定を保存した後に、下記リンク先から、サービス アカウント ( NT Service\AzureWLBackupPluginSvc ) に対するプロキシを設定するスクリプトをダウンロードします。<br>    - <a href="https://github.com/jpabrs-scem/blog/files/12788965/SetProxyforAzureWLBackupPluginSvcfromCurrentUser.zip">SetProxyforAzureWLBackupPluginSvcfromCurrentUser.zip</a></p><p>バックアップ対象の SQL Server DB が存在する Azure 仮想マシン上に、ダウンロードしたスクリプトを配置し、展開します。<br>    - ファイルの解凍パスワードは <strong><code>AzureBackup</code></strong> です</p><p>管理者特権の PowerShell から、ダウンロードしたファイルを解凍したフォルダに移動し、次のコマンドを実行します。<br>    - (実行コマンド)<br>      <code>.\SetProxyforAzureWLBackupPluginSvcfromCurrentUser.ps1</code><br>    - スクリプトを実行すると、以下ログファイルが作成されます。<br>      <code>&lt;スクリプトを実行したフォルダ&gt;/AzureBackup_Set_Proxy_For_AzureWLBackup_PluginSvc_yyyyMMdd_HHmmss.log</code><br><img src="/blog/AzureSQLBackup/How_to_PE_SQL_backup_bypass_proxy/How_to_PE_SQL_backup_bypass_proxy_06.png" alt="image"></p><div class="alert is-info"><p class="alert-title">Note</p><p>サービス アカウントのプロキシ設定は、サービス アカウントのレジストリ キーを編集することで設定しますが、</p><p>設定する一部の値の型が “REG_BINARY” となり、バイナリ データを登録する必要がございます。</p><p>設定の簡易化のため、本手順では、現在ログインしているユーザー (カレント ユーザー) のプロキシ設定を継承する 上記のPowerShell コマンド (スクリプト) を用いて、サービス アカウントのプロキシ設定を行います。</p></div><div class="alert is-warning"><p class="alert-title">警告</p><p>本手順でご案内しているスクリプトについては、お客様の責任のもと、ご利用いただきますようお願い申し上げます。</p><p>スクリプト実行時のエラーや、想定外の問題について、当社は責任を負いかねますのでご了承ください。</p></div><p>上記コマンド実行後、カレントユーザーに対する Proxy Server 設定を、元の状態に戻します。<br>念のため、以下スクリプトを実行いただき、Local System アカウントとNT Service\AzureWLBackupPluginSvcアカウントに対して、Proxy Server バイパス設定が正しく設定されているかを確認します。</p><h5 id="１．下記ドキュメント上の「Azure-Backup-接続テスト-スクリプト-AzureBackupConnectivityTestScriptsForWindows-zip-」を対象-Azure-仮想マシン上にダウンロードし、-zip-ファイルを展開します。"><a href="#１．下記ドキュメント上の「Azure-Backup-接続テスト-スクリプト-AzureBackupConnectivityTestScriptsForWindows-zip-」を対象-Azure-仮想マシン上にダウンロードし、-zip-ファイルを展開します。" class="headerlink" title="１．下記ドキュメント上の「Azure Backup 接続テスト スクリプト (AzureBackupConnectivityTestScriptsForWindows.zip) 」を対象 Azure 仮想マシン上にダウンロードし、 zip ファイルを展開します。"></a>１．下記ドキュメント上の「Azure Backup 接続テスト スクリプト (AzureBackupConnectivityTestScriptsForWindows.zip) 」を対象 Azure 仮想マシン上にダウンロードし、 zip ファイルを展開します。</h5><p>・ネットワーク接続を確立する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#establish-network-connectivity">https://learn.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#establish-network-connectivity</a></p><h5 id="２．展開した-zip-ファイル内の「Start-ConnectivityTests-ps1」を、対象-Azure-仮想マシン上で実行します。"><a href="#２．展開した-zip-ファイル内の「Start-ConnectivityTests-ps1」を、対象-Azure-仮想マシン上で実行します。" class="headerlink" title="２．展開した zip ファイル内の「Start-ConnectivityTests.ps1」を、対象 Azure 仮想マシン上で実行します。"></a>２．展開した zip ファイル内の「Start-ConnectivityTests.ps1」を、対象 Azure 仮想マシン上で実行します。</h5><p>今回は、Azure Backup サービスと Azure Storage サービスに対しては、プライベート エンドポイント経由で通信するため、引数に「-IsPrivateEndpointEnabled」を追加して実行します。<br>（実行コマンド 例）</p><blockquote><p>.\Start-ConnectivityTests.ps1 -IsPrivateEndpointEnabled</p></blockquote><p><img src="/blog/AzureSQLBackup/How_to_PE_SQL_backup_bypass_proxy/How_to_PE_SQL_backup_bypass_proxy_07.png"></p><p><img src="/blog/AzureSQLBackup/How_to_PE_SQL_backup_bypass_proxy/How_to_PE_SQL_backup_bypass_proxy_08.png"></p><p>「Start-ConnectivityTests.ps1」スクリプトを実行後、ターミナル上に結果が返却されます。</p><h5 id="「Start-ConnectivityTests-ps1」実行結果の期待値"><a href="#「Start-ConnectivityTests-ps1」実行結果の期待値" class="headerlink" title="「Start-ConnectivityTests.ps1」実行結果の期待値"></a>「Start-ConnectivityTests.ps1」実行結果の期待値</h5><p>(1)<br>WinInet settings for NT Authority\System (used by Azure Workload Backup Coordinator service)<br>ProxyEnable: <span style="color: red; ">1</span><br>となっていること。(=プロキシ設定 ON を表す)</p><p>(2)<br>WinInet settings for NT Authority\System (used by Azure Workload Backup Coordinator service)<br>「ProxyOverride:」以降が、設定した例外リスト/バイパスリストの内容となっていること</p><p>(3)<br>WinInet settings for NT Service\AzureWLBackupPluginSvc (used by Azure Workload Backup Plugin service)<br>ProxyEnable: <span style="color: red; ">1</span><br>となっていること。(=プロキシ設定 ON を表す)</p><p>(4)<br>WinInet settings for NT Service\AzureWLBackupPluginSv (used by Azure Workload Backup Plugin service)<br>「ProxyOverride:」以降が、設定した例外リスト/バイパスリストの内容となっていること<br><img src="/blog/AzureSQLBackup/How_to_PE_SQL_backup_bypass_proxy/How_to_PE_SQL_backup_bypass_proxy_09.png"></p><h2 id="5．SQL-Server-DB-に対する-Azure-Backup「今すぐバックアップ」を実行"><a href="#5．SQL-Server-DB-に対する-Azure-Backup「今すぐバックアップ」を実行" class="headerlink" title=" 5．SQL Server DB に対する Azure Backup「今すぐバックアップ」を実行"></a><a id="5"></a> 5．SQL Server DB に対する Azure Backup「今すぐバックアップ」を実行</h2><p>Azure ポータル画面上で設定した、バックアップ ポリシーに従った次回の スケジュールバックアップが成功することを確認いただく、もしくは「今すぐバックアップ」を実行してオンデマンド バックアップが成功することをご確認ください。</p><p>・オンデマンド バックアップを実行する<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/tutorial-sql-backup#run-an-on-demand-backup">https://docs.microsoft.com/ja-jp/azure/backup/tutorial-sql-backup#run-an-on-demand-backup</a></p><p>SQL Server DB に対する Azure Backupを、Proxy Serverをパイパスして PE 経由でバックアップする場合の設定方法は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、SQL Server DB に対する Azure Backupを、Proxy Serverをパイパスして PE 経由でバックアップする場合の設定方法につい</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure SQL Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-SQL-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup の通信要件や処理の流れについて</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/</id>
    <published>2024-11-05T03:00:00.000Z</published>
    <updated>2025-01-06T06:27:18.703Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートです。<br>今回は Azure VM Backup における通信要件や処理の流れに関して、具体的なお問い合わせ例を交えて公式ドキュメントを補足する形でご説明させていただきます。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Azure VM Backup の 通信要件について</a><br> <a href="#1-1">1-1.参考 URL</a><br><a href="#2">2. Azure VM Backup の処理の流れ</a><br> <a href="#2-1">2-1. Take Snapshot フェーズ</a><br> <a href="#2-2">2-2. Transfer data to vault フェーズ</a><br> <a href="#2-3">2-3. 参考 URL</a><br><a href="#3">3. よくいただくお問い合わせ</a></p><hr><h2 id="1-Azure-VM-Backup-の-通信要件について"><a href="#1-Azure-VM-Backup-の-通信要件について" class="headerlink" title="1. Azure VM Backup の 通信要件について"></a><a id="1"></a>1. Azure VM Backup の 通信要件について</h2><p>Azure VM Backup の通信要件は VM Agent が正常に動作するために必要な通信要件と同じでございます。<br>VM Agent の通信要件は下記の通り、Wire Server と呼ばれる各ノードごとにある 仮想パブリック IP 168.63.129.16 に対して通信ができることでございます。<br>つまり、<strong>Azure VM Backup の通信要件は 168.63.129.16 に対して通信ができること</strong>です。</p><p>・Azure Linux エージェントの理解と使用 - 必要条件 [Linux]<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/agent-linux#requirements">https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/agent-linux#requirements</a></p><blockquote><p>VM が IP アドレス168.63.129.16 にアクセスできることを確認します。</p></blockquote><p>・Azure 仮想マシン エージェントの概要 - 前提条件 [Windows]<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/agent-windows#prerequisites">https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/agent-windows#prerequisites</a></p><blockquote><p>VM が IP アドレス168.63.129.16 にアクセスできることを確認します。</p></blockquote><p><strong>当該仮想パブリック IP 168.63.129.16 (Wire Server) は Azure VM Backupはじめ、DNS 機能など Azure 内の様々な用途で使用されているため、Azure 内部で優先的にルーティングされる様になっており NSG や Azure Firewall の影響は受けず、かつ、ロンゲストマッチにより、0/0 強制ルーティング (強制トンネリング) ではオンプレに引き込まれずに Azure 側にルーティングされるようになっています。ただし、VM 内部でのファイアーウォール ではブロックすることは可能です。</strong><br>下記公式ドキュメントが参考になるかと存じます。<br>・IP アドレス 168.63.129.16 とは<br> <a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/what-is-ip-address-168-63-129-16">https://docs.microsoft.com/ja-jp/azure/virtual-network/what-is-ip-address-168-63-129-16</a></p><blockquote><p>VM エージェントでは、ポート 80/tcp と 32526/tcp を介した WireServer (168.63.129.16) とのアウトバウンド通信が必要です。 これらは、VM 上のローカル ファイアウォールでは開いている必要があります。 これらのポート上での 168.63.129.16 との通信は、構成されたネットワーク セキュリティ グループの対象ではありません。</p></blockquote><p>また、Azure VM Backup では必要な通信やデータ転送はすべて Azure バックボーン ネットワーク上でのみ行われるため、仮想ネットワーク (インターネット) にアクセスする必要はありません。<br>したがって IP や FQDN へのアクセスを許可するも必要がありません。</p><p>・Azure VM バックアップにはインターネット接続は不要 | セキュリティ機能の概要 - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/security-overview#internet-connectivity-not-required-for-azure-vm-backup">https://learn.microsoft.com/ja-jp/azure/backup/security-overview#internet-connectivity-not-required-for-azure-vm-backup</a>  </p><blockquote><p>Azure VM のバックアップを行うには、お使いの仮想マシンのディスクから Recovery Services コンテナーにデータを移動する必要があります。 ただし、必要な通信やデータ転送はすべて Azure バックボーン ネットワーク上でのみ行われ、仮想ネットワークにアクセスする必要はありません。 そのため、セキュリティで保護されたネットワーク内に配置された Azure VM のバックアップでは、IP や FQDN へのアクセスを許可する必要がありません。</p></blockquote><p>・FAQ - Azure Backup を使用してランサムウェアからバックアップを保護する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/protect-backups-from-ransomware-faq#----------------------azure-backup----------------------------">https://learn.microsoft.com/ja-jp/azure/backup/protect-backups-from-ransomware-faq#----------------------azure-backup----------------------------</a>  </p><blockquote><p>Azure VM の場合、転送中のデータは Azure のバックボーン ネットワークに残りますが、仮想ネットワークにアクセスする必要はありません。 そのため、セキュリティで保護されたネットワーク内に配置された Azure VM のバックアップでは、IP や FQDN へのアクセスを許可する必要がありません。</p></blockquote><p>・推奨されるシナリオとサポートされるシナリオ | Azure Backup のプライベート エンドポイント - 概要 - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-private-endpoints-concept#recommended-and-supported-scenarios">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-private-endpoints-concept#recommended-and-supported-scenarios</a>  </p><blockquote><p>VM バックアップでは、どの IP または FQDN へのアクセスも許可する必要はありません。</p></blockquote><p>・スナップショットをストレージ アカウントからコンテナーに移動した場合、転送中の暗号化はどのように管理されますか? | FAQ-Azure VM をバックアップする - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#-------------------------------------------------------">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#-------------------------------------------------------</a></p><blockquote><p>Azure VM バックアップでは、転送中の暗号化に HTTPS 通信を使用します。 データ転送では、VM のバックアップにインターネット アクセスを必要としない Azure ファブリック (パブリック エンドポイントではなく) を使用します。</p></blockquote><p>・インターネット接続 | ガイダンスとベスト プラクティス - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/guidance-best-practices#internet-connectivity">https://learn.microsoft.com/ja-jp/azure/backup/guidance-best-practices#internet-connectivity</a></p><blockquote><p>Azure VM バックアップ: ストレージと Azure Backup サービス間の必要な通信やデータ転送はすべて Azure ネットワーク内で行われ、仮想ネットワークにアクセスする必要はありません。 そのため、セキュリティで保護されたネットワーク内に配置された Azure VM のバックアップでは、IP や FQDN へのアクセスを許可する必要がありません。</p></blockquote><h4 id="1-1-参考-URL"><a href="#1-1-参考-URL" class="headerlink" title="1.1 参考 URL"></a>1.1 参考 URL<a id="1-1"></a></h4><p>合わせて下記の公式ドキュメントもご覧ください。<br>Azure VM Backup ではオンラインバックアップの場合、初回オンラインバックアップ時に VM agent の拡張機能がインストールされること、および VM agent が正常に動作することが必要であることが分かります。</p><p>・Azure VM バックアップの概要 - バックアップ プロセス<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-process">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-process</a></p><blockquote><p>最初のバックアップ時に、バックアップ拡張機能が VM にインストールされます (VM が実行されている場合)</p></blockquote><p>・Azure VM バックアップのサポート マトリックス - サポートされるシナリオ<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#supported-scenarios">https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#supported-scenarios</a></p><blockquote><p>Azure VM では、追加のエージェントは必要ありません。 Azure Backup によって、VM 上で実行している Azure VM エージェントに対して拡張機能がインストールされ、使用されます。</p></blockquote><p>・Azure VM バックアップのサポート マトリックス - オペレーティング システムのサポート (Windows)<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#operating-system-support-windows">https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#operating-system-support-windows</a></p><blockquote><p>Azure VM エージェント拡張機能を使用したバックアップ</p></blockquote><p>・Azure VM バックアップのサポート マトリックス - オペレーティング システムのサポート (Linux)<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#support-for-linux-backup">https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#support-for-linux-backup</a></p><blockquote><p><em><strong>VM 上で Linux 用の Azure VM エージェントが動作し</strong></em>かつ Python がサポートされていれば使用できます。</p></blockquote><p>・Azure Backup のアーキテクチャとコンポーネント - Azure Backup のしくみ<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-architecture#how-does-azure-backup-work">https://docs.microsoft.com/ja-jp/azure/backup/backup-architecture#how-does-azure-backup-work</a></p><blockquote><p>Azure VM をバックアップする:Azure VM を直接バックアップすることができます。 Azure Backup によって、VM 上で実行されている Azure VM エージェントに、バックアップ拡張機能がインストールされます。 この拡張機能は、VM 全体をバックアップします。</p></blockquote><h2 id="2-Azure-VM-Backup-の処理の流れ"><a href="#2-Azure-VM-Backup-の処理の流れ" class="headerlink" title="2. Azure VM Backup の処理の流れ"></a><a id="2"></a>2. Azure VM Backup の処理の流れ</h2><p>まず、下記の公式ドキュメントをご覧ください。<br>・Azure VM バックアップの概要 - バックアップ プロセス<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-process">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-process</a></p><p><strong>上記公式ドキュメントをご覧いただいた前提で記載させていただきます。</strong><br>オンライン (VM 起動中) の Azure VM Backup では VM agent の機能の拡張機能としてバックアップ拡張機能を利用します。<br>オフラインの場合は VM 内部と連携しないため、VM agent が対応していないような VM でもバックアップをクラッシュ整合性で取得することが可能です。<br>なお、オフライン状態 とは VM が <strong>“状態 : 停止済み (割り当て解除)”</strong> である状態を指します。</p><p>ご参考にまでに下記も併せてご覧ください。<br>参考ブログ記事<br>・Azure VM Backup では オフライン バックアップができるのか<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Azure_VM_Offline_backup/">https://jpabrs-scem.github.io/blog/AzureVMBackup/Azure_VM_Offline_backup/</a><br>・クラッシュ整合性 - Azure VM Backupにおける整合性について<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#3">https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#3</a></p><p>Azure VM Backupでは バックアップ ジョブの画面で確認できるように、順番に Take Snapshot と Transfer data to vault の 2 つの大きなフェーズ  (Sub Task) がございます。これら 2 つのフェーズが完了して初めてバックアップ ジョブとして完了となります。<br><img src="/blog/AzureVMBackup/NWRequirementAndProcess/NWRequirementAndProcess_01.png"></p><h3 id="2-1-Take-Snapshot-フェーズ"><a href="#2-1-Take-Snapshot-フェーズ" class="headerlink" title="2.1 Take Snapshot フェーズ"></a><a id="2-1"></a>2.1 Take Snapshot フェーズ</h3><p>まず、オンライン バックアップの場合、バックアップ拡張機能によって OS 内部と連携し静止点をとり、スナップショット データを取得します。その際のスナップショット データはユーザーからは見えない (マネージドな) ローカル物理ホスト上で取得します。<br>次に、オフライン バックアップの場合 は OS 内部と連携せずスナップショットを取得します。<br>Azure VM Backup において VM と連携する処理は Take Snapshot フェーズのみでございます。<br>そのため、Take Snapshot フェーズが完了すれば VM の再起動や運用によってはアップデートや DB の再開などを行っていただいてもかまいません。<br>Azure VM Backup はオンラインでもオフラインでもバックアップすることが可能ですが、<strong>Take Snapshot フェーズ</strong> に電源操作をされた場合には対象のバックアップが失敗する可能性がございます。<br> Transfer data to vault フェーズが終わっていなくても Take Snapshot フェーズが終わっていれば有事の際にはインスタントリストア機能を用いてリストアすることも可能です。<br>・Azure Backup のインスタント リストア機能を使用してバックアップと復元のパフォーマンスを改善する<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-instant-restore-capability">https://docs.microsoft.com/ja-jp/azure/backup/backup-instant-restore-capability</a></p><p>なお、前回のバックアップ ジョブが Take Snapshot フェーズの場合、後続のバックアップ ジョブは失敗する仕様となっております。</p><p>その他 以下参考になれば幸いです。<br>・Azure Backup は、アプリケーションのパフォーマンスに影響を与えますか?<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#azure-backup----------------------------">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#azure-backup----------------------------</a><br>抜粋 : “VM スナップショットの作成には数分かかります。この段階では、アプリケーションのパフォーマンスに対する影響はほとんどありません。”</p><p>・自分の VM バックアップ ポリシーで設定した、スケジュールされたバックアップ時刻からバックアップ開始時刻までの最大遅延時間はどれぐらいですか。<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#----vm-----------------------------------------------------------------">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#----vm-----------------------------------------------------------------</a><br>抜粋 : “スケジュールされたバックアップは、スケジュールされたバックアップ時刻から 2 時間以内にトリガーされます。”</p><p>・ VM スナップショットに関する問題のトラブルシューティング<br> <a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#troubleshoot-vm-snapshot-issues">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#troubleshoot-vm-snapshot-issues</a><br>抜粋 : “VM の CPU またはメモリが高くなっています。 仮想マシンのメモリまたは CPU の使用率が高くなり、90% を超えてると、スナップショット タスクがキューに格納されて遅延します。 最終的にはタイムアウトになります。”</p><h3 id="2-2-Transfer-data-to-vault-フェーズ"><a href="#2-2-Transfer-data-to-vault-フェーズ" class="headerlink" title="2.2 Transfer data to vault フェーズ"></a><a id="2-2"></a>2.2 Transfer data to vault フェーズ</h3><p>つぎに、ローカル物理ホスト上から Recovery Services コンテナー(バックアップデータ専用ストレージコンテナー) へ転送いたします。そのため<strong>バックアップデータは VM の 仮想 NIC を通って Recovery Services コンテナーへ転送されるのではなく、バックエンドで (ローカル物理ホスト上から物理的に離れた同一リージョン内にある) Recovery Services コンテナーへ転送されます。</strong></p><p>なお、前回のバックアップ ジョブが Transfer data to vault フェーズの場合、後続のバックアップ ジョブの Transfer data to vault フェーズは Skip される仕様となっており、リトライなどは実施されません。</p><h4 id="2-3-参考-URL"><a href="#2-3-参考-URL" class="headerlink" title="2.3 参考 URL"></a><a id="2-3"></a>2.3 参考 URL</h4><p>・Azure VM バックアップの概要 - バックアップ プロセス<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-process">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-process</a></p><p>・Azure VM Backup では オフライン バックアップができるのか<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Azure_VM_Offline_backup/">https://jpabrs-scem.github.io/blog/AzureVMBackup/Azure_VM_Offline_backup/</a></p><p>・クラッシュ整合性 - Azure VM Backupにおける整合性について<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#3">https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#3</a></p><p>・よく寄せられる質問 - Azure VM のバックアップ - スナップショットをストレージ アカウントからコンテナーに移動した場合、転送中の暗号化はどのように管理されますか?<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#-------------------------------------------------------">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#-------------------------------------------------------</a></p><blockquote><p>Azure VM バックアップでは、転送中の暗号化に HTTPS 通信を使用します。 <strong>データ転送では、VM のバックアップにインターネット アクセスを必要としない Azure ファブリック (パブリック エンドポイントではなく) を使用します</strong>。</p></blockquote><h2 id="3-よくいただくお問い合わせ"><a href="#3-よくいただくお問い合わせ" class="headerlink" title="3. よくいただくお問い合わせ"></a><a id="3"></a>3. よくいただくお問い合わせ</h2><p>これらに関連してよくいただくお問い合わせと回答を記載させていただきます。</p><blockquote><p>Q. 強制トンネリングを実施しているが、Azure VM Backup の通信を強制トンネリング対象から除外したいが、どのような設定をすればよいか。UDR を用いて可能か？</p><blockquote><p>A. Azure VM Backupに必要な通信は強制トンネリングや NSG の影響を受けないためローカル (OS内部) FW でブロックしていない限り通信要件は満たされます。<br>そのため強制トンネリング環境であっても特別な考慮は不要です。<br>また、UDR を用いて該当通信をルーティングすることはできません。<br>参考<br>・Azure VM Backup の 通信要件について - Azure VM Backup の 通信要件(本ページ)<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#1">https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#1</a></p></blockquote></blockquote><blockquote><p>Q. バックアップはまだ完了していないが、 Take Snapshot が終わっていれば VM の再起動などを行ってもよいか？またTake Snapshot が終わっていればリストアすることは可能か？</p><blockquote><p>A. Take Snapshot フェーズが完了していれば VM 内部と連携するフェーズは完了しているため、VM (OS内部) に対する変更、 VM の再起動などを行っていただいてもかまいません。<br>また Take Snapshot が完了していればインスタント リストア機能を用いてローカル物理ホスト上に保存されたスナップショットデータからリストアを行うことが可能です。<br>参考<br>・Take Snapshot フェーズ - Azure VM Backup の 通信要件(本ページ)<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#2-1">https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#2-1</a></p></blockquote></blockquote><blockquote><p>Q.  Recovery Services コンテナーにプライベート エンドポイントを設定した際の Azure VM バックアップをとるための NSG の設定を知りたい</p><blockquote><p>A. Azure VM Backup では1.Take Snapshotフェーズで Wire Server (168.63.129.16) と通信し、2.  Transfer data to vault フェーズで Azure 基盤内でバックアップデータ(取得したスナップショット) を Recovery Services コンテナーへ転送します。<br>そのため、 Azure VM と Recovery Services コンテナーは直接通信しないので、プライベート エンドポイント観点での 対象 VM に対する NSG の考慮は Azure VM Backup では不要です。<br>また Wire Server (168.63.129.16) への通信もプライベート エンドポイントの影響を受けません。<br>プライベート エンドポイント を設定していても設定していなくても、その前後で Azure VM Backup は設定変更することなく取得することが可能です。<br>参考<br>・Azure VM Backup の 通信要件について - Azure VM Backup の 通信要件(本ページ)<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#1">https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#1</a><br>・Take Snapshot フェーズ - Azure VM Backup の 通信要件(本ページ)<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#2-1">https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#2-1</a><br>・Transfer data to vaultフェーズ Azure VM Backup の 通信要件(本ページ)<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#2-2">https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#2-2</a></p></blockquote></blockquote><blockquote><p>Q. Azure VM Backup のバックアップデータ転送トラフィックが VM に与える影響を懸念しているがベストプラクティスはあるか？</p><blockquote><p>A. Azure Backup のデータ転送は Azure のバックアップエンド側で行われ VM の 仮想 NIC を経由しないためバックアップデータ転送トラフィックが VM に与える影響はございません。<br>参考<br>・Transfer data to vaultフェーズ Azure VM Backup の 通信要件(本ページ)<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#2-2">https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#2-2</a></p></blockquote></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートです。&lt;br&gt;今回は Azure VM Backup における通信要件や処理の流れに関して、具体的なお問い合わせ例を交えて公式ドキュメントを補足する形でご説明させていただきます</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup でリストアする際に利用するステージングの場所として利用するストレージ アカウントについて</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/RestoreStagingStorageAccount/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/RestoreStagingStorageAccount/</id>
    <published>2024-09-05T03:00:00.000Z</published>
    <updated>2025-01-06T06:27:18.703Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Backup サポートです。<br>今回は、Azure VM Backup でリストアする際に利用するステージングの場所として利用するストレージ アカウントについて、下記の通りお伝えします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. 公開情報 (Docs)</a><br><a href="#2">2. 利用できるストレージ アカウント</a><br><a href="#3">3. リストアされた後にストレージ アカウントに残るファイルについて</a><br><a href="#4">4. 参考画面ショット</a></p><hr><h3 id="1-公開情報-Docs"><a href="#1-公開情報-Docs" class="headerlink" title="1. 公開情報 (Docs)"></a><a id="1"></a>1. 公開情報 (Docs)</h3><p>まず最初に、本件に関する Docs は下記でございます。<br>・ストレージ アカウント - Azure portal で Azure VM データを復元する方法<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#storage-accounts">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#storage-accounts</a></p><blockquote><p>抜粋:”Vault-Standard 復元ポイントからマネージド VM のディスクを復元するときに、マネージド ディスクと Azure Resource Manager (ARM) テンプレートが、ステージング場所にあるディスクの VHD ファイルと共に復元されます。 インスタント復元ポイントからディスクを復元する場合、マネージド ディスクと ARM テンプレートのみが復元されます。”</p></blockquote><blockquote><p>抜粋:リージョン間復元では、 ステージング場所 (ストレージ アカウントの場所) は、Recovery Services コンテナーが セカンダリ リージョンとして扱うリージョンに存在する必要があります。 たとえば、Recovery Services コンテナーは米国東部 2 リージョンにあります (geo 冗長性とリージョン間復元が有効になっています)。 これは、セカンダリ リージョンは米国中部であることを意味します。 そのため、VM のリージョン間復元を行なうには、米国中部でストレージ アカウントを作成する必要があります。<br><a href="https://learn.microsoft.com/ja-jp/azure/availability-zones/cross-region-replication-azure">すべての地域の Azure リージョン間レプリケーションのペアリングに関する記事</a>をご覧ください。</p></blockquote><h3 id="2-利用できるストレージ-アカウント"><a href="#2-利用できるストレージ-アカウント" class="headerlink" title="2. 利用できるストレージ アカウント"></a><a id="2"></a>2. 利用できるストレージ アカウント</h3><p>選択できるストレージ アカウントは下記の条件を満たすものです。<br>・リストア先 (=ターゲット) のサブスクリプション内およびコンテナーと同じリージョンにある<br>・ZRS 以外の冗長性 (LRS・GRS)<br>・Premium Storage アカウントではない<br>・(ストレージアカウントのネットワーク設定でパブリックアクセスが制限されている場合) 例外の “信頼されたサービスの一覧にある Azure サービスがこのストレージ アカウントにアクセスすることを許可します” をチェックしている<br>・階層型名前空間 (HierarchicalNamespace) が有効化されていない</p><h3 id="3-リストアされた後にストレージ-アカウントに残るファイルについて"><a href="#3-リストアされた後にストレージ-アカウントに残るファイルについて" class="headerlink" title="3.リストアされた後にストレージ アカウントに残るファイルについて"></a><a id="3"></a>3.リストアされた後にストレージ アカウントに残るファイルについて</h3><p>マネージドディスクの Azure VM の復元が完了しますと対象のストレージ アカウントの中に下記のファイルが残ります。<br>下記の通り、ストレージ アカウントにファイルが残るかおよび、どのファイルが残るかはリストア シナリオによって異なります。</p><table><thead><tr><th align="left">#</th><th align="left"></th><th align="left">リストアシナリオ</th><th align="left">ステージングのストレージ アカウントに残るファイル</th></tr></thead><tbody><tr><td align="left"></td><td align="left"></td><td align="left"><strong>Recovery Services コンテナー (vault-standrd) 層からのリストア</strong></td><td align="left"></td></tr><tr><td align="left">1</td><td align="left"></td><td align="left">新規 VM 作成</td><td align="left">無し</td></tr><tr><td align="left">2</td><td align="left"></td><td align="left">ディスクの復元</td><td align="left">VHD ファイルと json ファイル</td></tr><tr><td align="left">3</td><td align="left"></td><td align="left">既存の置換え</td><td align="left">VHD ファイル</td></tr><tr><td align="left"></td><td align="left"></td><td align="left"><strong>スナップショット 層からのリストア (インスタントリストア)</strong></td><td align="left"></td></tr><tr><td align="left">4</td><td align="left"></td><td align="left">新規 VM 作成</td><td align="left">無し</td></tr><tr><td align="left">5</td><td align="left"></td><td align="left">ディスクの復元</td><td align="left">json ファイル</td></tr><tr><td align="left">6</td><td align="left"></td><td align="left">既存の置換え</td><td align="left">無し</td></tr><tr><td align="left"></td><td align="left"></td><td align="left"><strong>クロスリージョン リストア</strong></td><td align="left"></td></tr><tr><td align="left">7</td><td align="left"></td><td align="left">新規 VM 作成</td><td align="left">無し</td></tr><tr><td align="left">8</td><td align="left"></td><td align="left">ディスクの復元</td><td align="left">VHD ファイルと json ファイル</td></tr></tbody></table><div class="alert is-info"><p class="alert-title">Note</p><p>復元が正常に成功していることが確認でき次第、これらのファイルは削除いただいて問題ございません。</p><p>しかしながら、これらのファイルが自動で削除されることはございませんので、お手数ですがファイルが不要の場合手動での削除をお願いいたします。</p><p>また、ステージングの場所として使用したストレージ アカウントについても、復元が完了しましたら削除いただいて問題ございません。</p></div><h3 id="4-参考画面ショット"><a href="#4-参考画面ショット" class="headerlink" title="4.参考画面ショット"></a><a id="4"></a>4.参考画面ショット</h3><p> VM 名：VM-RHEL-PE という Azure VM (OS ディスク 1 つ、データディスク 2 つ) を (2) の既存の置換えにてリストアしたあとのストレージ アカウントです。</p><p> <img src="/blog/AzureVMBackup/RestoreStagingStorageAccount/RestoreStagingStorageAccount_01.png"></p><blockquote><p>コンテナー名：<br> vmrhelpe-51f2bd236a2e479a95cfc2bdd53b986c<br> 上記の通り、Azure VM 名にランダムな文字列のコンテナー名のコンテナーが作成されます。</p></blockquote><blockquote><p>VHD：<br> vmrhelpe-datadisk-000-20220319-233028.vhd<br> vmrhelpe-datadisk-001-20220319-233028.vhd<br> vmrhelpe-osdisk-20220319-233028.vhd<br> 上記の通り、Azure VM 名にディスク種別および LUN 番号リストア日時 (UTC表記) が付加された vhd ファイルが作成されます。</p></blockquote><blockquote><p>json：<br> azuredeployf08911fe-654a-49e1-9baa-41ca15cbb272.json<br> config-sqlvm13-f08911fe-654a-49e1-9baa-41ca15cbb272.json<br> parameterf08911fe-654a-49e1-9baa-41ca15cbb272.json<br> 上記の通り、<br> 「azuredeploy&lt;リストア ジョブで使用されるJob ID&gt;」<br> 「config-&lt;VM 名&gt;-&lt;リストア ジョブで使用されるJob ID&gt;」<br> 「parameter&lt;リストア ジョブで使用されるJob ID&gt;」の名前から始まるファイルが 3 つ作成されます。</p></blockquote><p>「Job ID」は、コマンドからの確認や、Recovery Services コンテナー &gt; バックアップ ジョブ &gt; 「ジョブのエクスポート」より確認ができます。</p><p>・ジョブをエクスポートする<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-manage-windows-server#export-jobs">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-manage-windows-server#export-jobs</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、Azure VM Backup でリストアする際に利用するステージングの場所として利用するストレージ アカウントについて、下記の通りお伝えします。&lt;/p&gt;
&lt;</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup における CSV のサポートについて</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/CSV_not_Supported/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/CSV_not_Supported/</id>
    <published>2024-09-03T15:00:00.000Z</published>
    <updated>2025-01-06T06:27:18.635Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Backup サポートです。<br>今回は、Azure VM Backup での、クラスターの共有ボリューム (Cluster Shared Volume : CSV) を利用している VM のサポート状況、および Azure Backup でのバックアップ方法についてご案内いたします。  </p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. CSV のサポートについて</a><br><a href="#2">2. WSFC を利用している場合について</a><br><a href="#3">3. CSV の利用有無 および CSV ライターの動作状況を確認する方法</a><br><a href="#4">4. CSV ライターを無効化する方法</a><br><a href="#5">5. CSV を利用している場合の Azure Backup について</a>  </p><hr><h2 id="1-CSV-のサポートについて"><a href="#1-CSV-のサポートについて" class="headerlink" title=" 1. CSV のサポートについて"></a><a id="1"></a> 1. CSV のサポートについて</h2><p>Azure VM Backup では、CSV を利用している VM のバックアップはサポートされていません。<br>CSV を利用している VM で Azure VM Backup が実行されると、CSV ライターが失敗し、バックアップ データの整合性が <strong>「ファイル システム整合性」</strong> となる可能性がございます。  </p><div class="alert is-info"><p class="alert-title">Note</p><p>Windows OS の Azure VM Backup では、Windows ボリューム シャドウ コピー サービス (VSS) と連携し、スナップショットを取得します。</p><p>すべての VSS ライターが正常に動作した場合には、取得されるバックアップ データの整合性は「アプリケーション整合性」となります。</p><p>詳細につきましては、下記ブログ記事をご確認ください。</p><p>・ Azure VM Backupにおける整合性について | Japan CSS ABRS Support Blog !!</p><p>　 <a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/">https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/</a>  </p></div><p>・ VM ストレージのサポート / Azure VM バックアップのサポート マトリックス - Azure Backup | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#vm-storage-support">https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#vm-storage-support</a><br>　 抜粋 :  </p><blockquote><p>共有ストレージ :<br>クラスターの共有ボリューム (CSV) またはスケールアウト ファイル サーバーを使用した VM のバックアップはサポートされていません。<br>バックアップ中に CSV ライターが失敗する可能性があります。<br>また、復元時に CSV ボリュームを含むディスクが起動しない可能性があります。  </p></blockquote><h3 id="補足"><a href="#補足" class="headerlink" title=" (補足)"></a><a id="1.1"></a> (補足)</h3><p>CSV を利用している、もしくは CSV ライターが有効である状態で VM バックアップを実行すると、イベント ログに下記警告レベルのログが記録されます。  </p><ul><li>アプリケーション ログ  <blockquote><p>ログの名前: Application<br>ソース: VSS<br>日付: yyyy/mm/dd HH:mm:ss<br>イベント ID: 8229<br>タスクのカテゴリ: なし<br>レベル: 警告<br>キーワード: クラシック<br>ユーザー: N/A<br>コンピューター: &lt;コンピューター名&gt;<br>説明:<br>エラー 0x00000000, The operation completed successfully.<br> により、VSS ライターはイベントを拒否しました。イベントの処理中に VSS ライターがライター コンポーネントに加えた変更は、要求側では利用できません。 VSS ライターをホストしているアプリケーションからの関連イベントについては、イベント ログを参照してください。  </p><p>Operation:<br>   PrepareForSnapshot Event  </p><p>Context:<br>   Execution Context: Writer<br>   Writer Class Id: {1072ae1c-e5a7-4ea1-9e4a-6f7964656570}<br>   Writer Name: Cluster Shared Volume VSS Writer<br>   Writer Instance ID: {a2c1fb45-4c7e-43dc-b4e1-6f4660f40ce4}<br>   Command Line: C:\Windows\Cluster\clussvc.exe -s<br>   Process ID: 4004</Data><br><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_01.png">  </p></blockquote></li><li>システム ログ  <blockquote><p>ログの名前: System<br>ソース: Microsoft-Windows-FailoverClustering<br>日付: yyyy/mm/dd HH:mm:ss<br>イベント ID: 1544<br>タスクのカテゴリ: Cluster Backup/Restore<br>レベル: 警告<br>キーワード:<br>ユーザー: SYSTEM<br>コンピューター: &lt;コンピューター名&gt;<br>説明:<br>クラスター構成データのバックアップ操作が取り消されました。クラスターのボリューム シャドウ コピー サービス (VSS) ライターが中止要求を受信しました。<br><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_02.png">  </p></blockquote></li></ul><h2 id="2-WSFC-を利用している場合について"><a href="#2-WSFC-を利用している場合について" class="headerlink" title=" 2. WSFC を利用している場合について"></a><a id="2"></a> 2. WSFC を利用している場合について</h2><p>Windows Server フェールオーバー クラスター (Windows Server Failover Cluster : WSFC) を構成している場合には、<strong>クラスターをセットアップした段階で CSV ライターがインストール</strong>されます。<br>そのため、<strong>CSV を利用していない場合でも</strong>、WSFC を構成している VM で Azure VM Backup が実行されると、CSV ライターが失敗し、バックアップ データの整合性が 「ファイル システム整合性」 となる可能性がございます。  </p><p>WSFC を構成しており CSV を利用している場合には、Azure VM Backup はサポート対象外となり、Azure VM Backup 以外のバックアップを構成いただく必要がございますが、<br>WSFC を構成しているが CSV を利用していない場合には、<strong>CSV ライターを無効化することで</strong>、Azure VM Backup で 「アプリケーション整合性」 のバックアップ データが取得可能となります。  </p><p>従って、まずは <a href="#3">3. CSV の利用有無 および CSV ライターの動作状況を確認する方法</a> にて、CSV の利用有無 と CSV ライターの動作状況をご確認ください。  </p><h2 id="3-CSV-の利用有無-および-CSV-ライターの動作状況を確認する方法"><a href="#3-CSV-の利用有無-および-CSV-ライターの動作状況を確認する方法" class="headerlink" title=" 3. CSV の利用有無 および CSV ライターの動作状況を確認する方法"></a><a id="3"></a> 3. CSV の利用有無 および CSV ライターの動作状況を確認する方法</h2><p><a href="#3.1">CSV の利用有無を確認する方法</a>、および <a href="#3.2">CSV ライターの動作状況を確認する方法</a> について、以下のとおりご案内いたします。  </p><p>下記の確認方法にて、CSV の利用有無 と CSV ライターの動作状況を確認し、<br>CSV の利用が確認できた場合には、<a href="#5">5. CSV を利用している場合の Azure Backup について</a> を、<br>CSV は利用していないが CSV ライターが有効な状態であった場合には、<a href="#4">4. CSV ライターを無効化する方法</a> をご確認ください。  </p><div class="alert is-success"><p class="alert-title">ヒント</p><p>CSV を利用していない、且つ CSV ライターも無効な状態である場合には、追加の作業を行うことなく、Azure VM Backup を構成することが可能でございます。  </p></div><h3 id="3-1-CSV-の利用有無を確認する方法"><a href="#3-1-CSV-の利用有無を確認する方法" class="headerlink" title=" 3.1 CSV の利用有無を確認する方法"></a><a id="3.1"></a> 3.1 CSV の利用有無を確認する方法</h3><p>CSV の利用有無を確認するには、管理者として実行した PowerShell コンソールで、下記コマンドを実行してください。<br>コマンド実行結果に、CSV の情報が出力された場合には、コマンドを実行しているマシン (WSFC) で CSV が利用されていると判断可能です。  </p><p>CSV を利用している場合には、<a href="#5">5. CSV を利用している場合の Azure Backup について</a> をご確認ください。<br>CSV を利用していない場合には、<a href="#3.2">3.2 CSV ライターの動作状況を確認する方法</a> をご確認ください。  </p><p><strong>コマンド</strong>  </p><pre><code class="PowerShell">Get-ClusterSharedVolume</code></pre><p><strong>実行結果例</strong>  </p><ul><li>CSV を利用している場合<br><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_03.png">  </li><li>CSV を利用していない場合<br><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_04.png">  </li></ul><h3 id="3-2-CSV-ライターの動作状況を確認する方法"><a href="#3-2-CSV-ライターの動作状況を確認する方法" class="headerlink" title=" 3.2 CSV ライターの動作状況を確認する方法"></a><a id="3.2"></a> 3.2 CSV ライターの動作状況を確認する方法</h3><p>CSV ライターの動作状況を確認するには、管理者として実行した PowerShell コンソールで、下記コマンドを実行してください。<br>コマンド実行結果に、<code>Cluster Shared Volume VSS Writer</code> という名前の VSS ライターが含まれていた場合には、コマンドを実行しているマシンに CSV ライターがインストールされており、有効な状態であると判断可能です。  </p><p>CSV は利用していないが、CSV ライターが有効な状態であった場合には、<a href="#4">4. CSV ライターを無効化する方法</a> をご確認ください。<br>CSV は利用しておらず、CSV ライターも無効な状態であった場合には、追加の作業を行うことなく、Azure VM Backup を構成することが可能でございます。<br>(CSV の利用有無が未確認の場合には、<a href="#3.1">3.1 CSV の利用有無を確認する方法</a> をご確認ください。)  </p><p><strong>コマンド</strong>  </p><pre><code class="PowerShell">vssadmin list writers</code></pre><p><strong>実行結果例</strong><br><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_05.png">  </p><h2 id="4-CSV-ライターを無効化する方法"><a href="#4-CSV-ライターを無効化する方法" class="headerlink" title=" 4. CSV ライターを無効化する方法"></a><a id="4"></a> 4. CSV ライターを無効化する方法</h2><p>CSV ライターを無効化する手順を、以下のとおりご案内いたします。<br>WSFC を構成しているが CSV を利用していない場合には、この手順に従い、CSV ライターを無効化することで、Azure VM Backup で 「アプリケーション整合性」 のバックアップ データが取得可能となります。  </p><div class="alert is-warning"><p class="alert-title">警告</p><p><strong>CSV を利用していないことを、事前にご確認いただいたうえで</strong>、CSV ライターを無効化してください。</p><p>CSV の利用有無を確認する方法につきましては、<a href="#3.1">こちら</a> をご確認ください。  </p></div><h3 id="4-1-CSV-ライターの無効化手順"><a href="#4-1-CSV-ライターの無効化手順" class="headerlink" title=" 4.1 CSV ライターの無効化手順"></a><a id="4.1"></a> 4.1 CSV ライターの無効化手順</h3><ul><li><ol start="0"><li>各クラスター ノードそれぞれで下記手順を実施します  </li></ol></li><li><ol><li>「ファイル名を指定して実行」 に <code>regedit</code> と入力して実行し、 レジストリ エディターを起動します<br><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_06.png">  </li></ol></li><li><ol start="2"><li>下記のキーを右クリックし、「アクセス許可」 を選択して、「Failover Clusters のアクセス許可」 の画面を開きます  <pre><code class="text">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Failover Clusters</code></pre><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_07.png">  </li></ol></li><li><ol start="3"><li>「詳細設定」 を押下し、「Failover Clusters のセキュリティの詳細設定」 の画面を開きます<br><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_08.png">  </li></ol></li><li><ol start="4"><li>「所有者」 の隣の 「変更」 を選択し、「選択するオブジェクトを入力してください」 に <code>管理者アカウント (下記の例では、azureadmin)</code> を入力して、「名前の確認」 &gt; 「OK」 を選択します<br>※ 「場所の指定」には、サーバーが参加しているドメインが選択されている状態で問題ございません<br><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_09.png"><br><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_10.png">  </li></ol></li><li><ol start="5"><li>「所有者」 が 管理者アカウント (下記の例では、azureadmin) に変更されたことを確認し、「OK」 を押下して、「Failover Clusters のセキュリティの詳細設定」 の画面を閉じます<br><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_11.png">  </li></ol></li><li><ol start="6"><li>手順 2 で開いた 「Failover Clusters のアクセス許可」 画面に戻り、管理者アカウント または Administrators のフル コントロールにチェックを入れ、「OK」 を選択して画面を閉じます<br><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_12.png">  </li></ol></li><li><ol start="7"><li>手順 1 で起動したレジストリ エディターで Failover Clusters のキーを右クリックし、「新規」 &gt; 「DWORD (32 ビット) 値」 を選択して、下記のレジストリを作成します  <pre><code class="text">キー : HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Failover Clusters名前 : EnableCsvVssWriter種類 : REG_DWORDデータ : 0</code></pre><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_13.png"><br><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_14.png">  </li></ol></li><li><ol start="8"><li>OS の再起動を実施します  </li></ol></li></ul><p>以上で CSV ライターの無効化作業は完了です。  </p><h3 id="4-2-CSV-ライターの無効化を元に戻す方法"><a href="#4-2-CSV-ライターの無効化を元に戻す方法" class="headerlink" title=" 4.2 CSV ライターの無効化を元に戻す方法"></a><a id="4.2"></a> 4.2 CSV ライターの無効化を元に戻す方法</h3><p><a href="#4.1">4.1 CSV ライターの無効化手順</a> で行った設定を元に戻す手順を、以下のとおりご案内いたします。<br>この手順を実施することで、無効化した CSV ライターを再度有効化することが可能となります。  </p><ul><li><ol start="0"><li>各クラスター ノードそれぞれで下記手順を実施します  </li></ol></li><li><ol><li>「ファイル名を指定して実行」 に <code>regedit</code> と入力して実行し、 レジストリ エディターを起動します<br><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_15.png">  </li></ol></li><li><ol start="2"><li>下記のキーを表示し、レジストリ 「EnableCsvVssWriter」 を右クリックし、「削除」を選択します  <pre><code class="text">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Failover Clusters</code></pre><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_16.png">  </li></ol><ul><li>「一部のレジストリ値を削除するとシステムが不安定になる場合があります。この値を完全に削除しますか？」というメッセージを含むポップアップが表示されますが、「はい」を選択してください<br><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_17.png">  </li></ul></li><li><ol start="3"><li>下記のキーを右クリックし、「アクセス許可」 を選択して、「Failover Clusters のアクセス許可」 の画面を開きます  <pre><code class="text">HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Failover Clusters</code></pre><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_18.png">  </li></ol></li><li><ol start="4"><li>「Failover Clusters のアクセス許可」 画面で 管理者アカウント または Administrators のフル コントロールのチェックを外し、「適用」 を選択します<br><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_19.png">  </li></ol></li><li><ol start="5"><li>「Failover Clusters のアクセス許可」 画面で 「詳細設定」 を押下し、「Failover Clusters のセキュリティの詳細設定」 の画面を開きます<br><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_20.png">  </li></ol></li><li><ol start="6"><li>「所有者」 の隣の 「変更」 を選択し、「選択するオブジェクトを入力してください」 に<br><code>NT Service\TrustedInstaller</code> と入力して、「名前の確認」 &gt; 「OK」 を選択します<br>※ 「場所の指定」には、ローカル マシン名を指定してください<br><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_21.png"><br><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_22.png">  </li></ol></li><li><ol start="7"><li>「所有者」 が TrustedInstaller アカウントに変更されたことを確認し、「OK」 を押下して、「Failover Clusters のセキュリティの詳細設定」 および 「Failover Clusters のアクセス許可」 の画面を閉じます<br><img src="/blog/AzureVMBackup/CSV_not_Supported/CSV_not_Supported_23.png">  </li></ol></li></ul><p>以上で CSV ライターの無効化の戻し作業は完了です。  </p><h2 id="5-CSV-を利用している場合の-Azure-Backup-について"><a href="#5-CSV-を利用している場合の-Azure-Backup-について" class="headerlink" title=" 5. CSV を利用している場合の Azure Backup について"></a><a id="5"></a> 5. CSV を利用している場合の Azure Backup について</h2><div class="alert is-important"><p class="alert-title">重要</p><p>前提として、CSV は Azure 共有ディスクを利用して構成していることを想定しております。</p><p>共有ディスクを利用していない場合には、下記方法は適用されない可能性がございますので、予めご了承ください。  </p></div><p>CSV を利用している VM で Azure Backup を構成する一例といたしましては、CSV として利用している共有ディスクを含め、VM にアタッチされているすべてのディスクに Azure Disk Backup を構成する方法がございます。<br>もし、Azure Disk Backup を利用する場合には、すべてのディスクに対して同じ静止点でバックアップを取得するために、下記の点を考慮してバックアップを構成してください。  </p><ul><li>ディスクそれぞれで構成する Azure Disk Backup は、同じバックアップ スケジュールを設定する  </li><li>Azure Disk Backup が動作する前に VM を事前に停止する<br>(※ 恐縮ながら、Azure Disk Backup では、バックアップ前後に VM を起動 / 停止させるような機能はございません。)  </li></ul><p>尚、Azure Disk バックアップの詳細につきましては、下記ドキュメントをご確認ください。<br>・ Azure ディスク バックアップの概要 - Azure Backup | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-overview">https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-overview</a><br>　 抜粋 :  </p><blockquote><p>Azure ディスク バックアップ ソリューションは、次のようなシナリオで役立ちます。<br>クラスター シナリオで実行されているアプリ: Windows Server フェールオーバー クラスターと Linux クラスターの両方で共有ディスクへの書き込みが行われている。  </p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、Azure VM Backup での、クラスターの共有ボリューム (Cluster Shared Volume : CSV) を利用している VM のサポート</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>AzureBackupProtectionLock について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureFilesBackup/About_Protection_Lock/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureFilesBackup/About_Protection_Lock/</id>
    <published>2024-08-27T15:00:00.000Z</published>
    <updated>2025-01-06T06:27:18.491Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>Azure ファイル共有のバックアップを構成すると、バックアップ データやストレージ アカウントが誤って削除されないように、削除ロック 「AzureBackupProtectionLock」 がストレージ アカウントに設定されます。<br>今回は、Azure ファイル共有のバックアップによって、ストレージ アカウントに設定される削除ロック 「AzureBackupProtectionLock」 についてご案内します。  </p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">AzureBackupProtectionLock とは</a><br><a href="#2">AzureBackupProtectionLock が設定されるタイミング</a><br><a href="#3">AzureBackupProtectionLock を一時的に削除する方法</a><br><a href="#4">AzureBackupProtectionLock を設定させない方法</a>  </p><hr><h2 id="AzureBackupProtectionLock-とは"><a href="#AzureBackupProtectionLock-とは" class="headerlink" title="AzureBackupProtectionLock とは"></a><a id="1"></a>AzureBackupProtectionLock とは</h2><p>Azure ファイル共有のバックアップでは、Azure ファイル共有のスナップショット機能を利用し、バックアップを取得しておりますが、Azure ファイル共有のスナップショットは、ストレージ アカウントが削除されると、全てのスナップショットが併せて削除されます。<br>そのため、Azure ファイル共有のバックアップでは、Azure Backup サービスによって取得されたバックアップ (スナップショット) が誤って削除されないように、バックアップ対象の Azure ファイル共有がデプロイされているストレージ アカウントに対して、削除ロック 「AzureBackupProtectionLock」 を設定いたします。  </p><ul><li>ストレージ アカウントのロックを有効にすることが推奨されるのはなぜですか?<br>Azure Files のバックアップに関する FAQ - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-files-faq#-------------------------------------">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-files-faq#-------------------------------------</a><br>抜粋 :</li></ul><blockquote><p>ストレージ アカウントが削除されると、すべてのスナップショットが失われます。 <strong>誤って削除されないようにアカウントを保護するため、Azure Backup によってストレージ アカウントに削除ロックが設定されます。</strong> つまり、許可されているユーザーはリソースを読んだり変更したりできますが、削除することはできません。 また、このロックにより、ストレージ アカウントの下にあるファイル共有の削除も制限されます。 そのため、ストレージ アカウントとファイル共有の両方が不注意による削除から保護されます。  </p></blockquote><p>(例)  </p><ul><li>ロック名 : <code>AzureBackupProtectionLock</code>  </li><li>ロックの種類 : 削除  </li><li>スコープ : ストレージ アカウント  </li><li>メモ : <code>Auto-created by Azure Backup for storage accounts registered with a Recovery Services Vault. This lock is intended to guard against deletion of backups due to accidental deletion of the storage account. (Recovery Services Vaultに登録されているストレージアカウントに対してAzure Backupによって自動的に作成されます。このロックは、ストレージアカウントの誤った削除によるバックアップの削除を防ぐことを目的としています。)</code><br><img src="/blog/AzureFilesBackup/About_Protection_Lock/About_Protection_Lock_01.png"></li></ul><h2 id="AzureBackupProtectionLock-が設定されるタイミング"><a href="#AzureBackupProtectionLock-が設定されるタイミング" class="headerlink" title="AzureBackupProtectionLock が設定されるタイミング"></a><a id="2"></a>AzureBackupProtectionLock が設定されるタイミング</h2><p>削除ロック 「AzureBackupProtectionLock」 は、主に下記のタイミングで設定されます。  </p><ul><li>Azure ファイル共有のバックアップが構成されたとき<br>(より正確には、ストレージ アカウントが Recovery Services コンテナーのバックアップ インフラストラクチャとして登録されたとき)  </li><li>Azure ファイル共有のバックアップが実行されたとき  </li></ul><p>削除ロック 「AzureBackupProtectionLock」 を手動削除したとしても、Azure ファイル共有のバックアップが実行されると、削除ロック 「AzureBackupProtectionLock」 が自動設定されます。  </p><h2 id="AzureBackupProtectionLock-を一時的に削除する方法"><a href="#AzureBackupProtectionLock-を一時的に削除する方法" class="headerlink" title="AzureBackupProtectionLock を一時的に削除する方法"></a><a id="3"></a>AzureBackupProtectionLock を一時的に削除する方法</h2><p>ファイル共有にアップロードしている一部ファイルを削除したいなどのシナリオにおいては、削除ロック 「AzureBackupProtectionLock」 を手動で削除してください。  </p><p>前提条件 :<br>削除ロックを削除するには、作業を行うユーザーが対象のストレージ アカウントに対して、<code>Microsoft.Authorization/*</code> または <code>Microsoft.Authorization/locks/*</code> アクションにアクセス可能である必要がございます。 (組み込みロールでは、<strong>所有者</strong> もしくは <strong>ユーザー アクセス管理者ロール</strong> の割り当てが必要となります。)<br>削除ロックの作業を行う前に、予め上記アクセス許可を行ってください。  </p><ul><li>誰がロックを作成または削除できるか / ロックを使って Azure リソースを保護する - Azure Resource Manager | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/lock-resources?tabs=json#who-can-create-or-delete-locks">https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/lock-resources?tabs=json#who-can-create-or-delete-locks</a><br>抜粋 :</li></ul><blockquote><p>管理ロックを作成または削除するには、<code>Microsoft.Authorization/*</code> または <code>Microsoft.Authorization/locks/*</code> アクションにアクセスする必要があります。<strong>所有者</strong>と<strong>ユーザー アクセス管理者ロール</strong>に割り当てられているユーザーには、必要なアクセス権があります。  </p></blockquote><p>手順 :  </p><ol><li><p>削除ロック 「AzureBackupProtectionLock」 を削除する<br>ストレージ アカウントの <code>設定 &gt; ロック</code> へアクセスし、削除ロック 「AzureBackupProtectionLock」 を削除します<br><img src="/blog/AzureFilesBackup/About_Protection_Lock/About_Protection_Lock_02.png"></p></li><li><p>(不要なファイル削除などの作業完了後) 削除ロック 「AzureBackupProtectionLock」 を再設定する  </p><ul><li>ストレージ アカウントの <code>設定 &gt; ロック</code> へアクセスし、削除ロックを追加します<br><img src="/blog/AzureFilesBackup/About_Protection_Lock/About_Protection_Lock_03.png">  </li><li>もしくは、Azure ファイル共有のオンデマンド バックアップを手動で実行します (自動的に、削除ロック 「AzureBackupProtectionLock」 が設定されます)<br>詳細な手順につきましては、下記ドキュメントをご確認ください。  <ul><li>オンデマンド バックアップの実行手順 :<br>オンデマンド バックアップ ジョブを実行する / Azure portal で Azure ファイル共有をバックアップする - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-files?tabs=backup-center#run-an-on-demand-backup-job">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-files?tabs=backup-center#run-an-on-demand-backup-job</a>  </li></ul></li></ul></li></ol><h2 id="AzureBackupProtectionLock-を設定させない方法"><a href="#AzureBackupProtectionLock-を設定させない方法" class="headerlink" title="AzureBackupProtectionLock を設定させない方法"></a><a id="4"></a>AzureBackupProtectionLock を設定させない方法</h2><p>Azure ファイル共有のバックアップ構成時に、ストレージ アカウントのロック無効化設定を行うことで、削除ロック 「AzureBackupProtectionLock」 を設定せずに、Azure ファイル共有のバックアップを構成 / 取得いただくことが可能となります。  </p><div class="alert is-important"><p class="alert-title">重要</p><p>Azure Backup サービスといたしましては、<strong>削除ロック 「AzureBackupProtectionLock」 を有効化していただくことを推奨</strong>いたします。</p><p>もし削除ロック 「AzureBackupProtectionLock」 を設定せずにバックアップを構成し、意図せずスナップショットが消失したとしても、基本的には弊社側での復旧対応は致しかねますこと、予めご了承ください。  </p></div><p>手順 :  </p><ul><li><p>Recovery Services コンテナーからバックアップを構成する場合<br>Recovery Services コンテナーの <code>はじめに &gt; バックアップ &gt; Azure ファイル共有のバックアップ構成</code> にアクセスします。<br><img src="/blog/AzureFilesBackup/About_Protection_Lock/About_Protection_Lock_04.png"><br>バックアップの構成画面のストレージ アカウントの選択時に、<strong>「ストレージ アカウントのロックを有効にする」のチェックを外してください</strong>。<br><img src="/blog/AzureFilesBackup/About_Protection_Lock/About_Protection_Lock_05.png"></p></li><li><p>Azure ファイル共有からバックアップを構成する場合<br>Azure ファイル共有の <code>操作 &gt; バックアップ</code> へアクセスし、<strong>「Storage account lock」のトグル ボタンを無効にしてください</strong>。<br><img src="/blog/AzureFilesBackup/About_Protection_Lock/About_Protection_Lock_06.png"></p></li></ul><div class="alert is-warning"><p class="alert-title">警告</p><p>Azure ファイル共有を新規作成する際に表示される Azure Backup 構成画面では、ストレージ アカウントのロックを無効化させる設定は行えません。</p><p>もしストレージ アカウントのロックを無効化させたい場合には、<strong>バックアップを構成せずに</strong> Azure ファイル共有を作成し、その後に Azure Backup を構成してください。</p><p><img src="/blog/AzureFilesBackup/About_Protection_Lock/About_Protection_Lock_07.png"></p></div><div class="alert is-warning"><p class="alert-title">警告</p><p>同じストレージ アカウントにデプロイされている、他の Azure ファイル共有で既に Azure Backup を構成している場合には、ストレージ アカウントが Recovery Services コンテナーのバックアップ インフラストラクチャとして既に登録されているため、ストレージ アカウントのロック無効化設定が行えません。</p><p>ストレージ アカウントのロック無効化設定が行えるのは、Recovery Services コンテナーのバックアップ インフラストラクチャに登録されていないストレージ アカウントにデプロイされている Azure ファイル共有のバックアップを構成する時のみ (ストレージ アカウント配下の Azure ファイル共有全てにおいて、Azure Backup が構成されていないとき) であることにご注意ください。  </p></div>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;Azure ファイル共有のバックアップを構成すると、バックアップ データやストレージ アカウントが誤って削除されないように、削除ロック 「AzureBackupP</summary>
      
    
    
    
    
    <category term="Azure Files Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Files-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの料金の違い</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_billing/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_billing/</id>
    <published>2024-08-19T03:00:00.000Z</published>
    <updated>2025-01-06T06:27:18.703Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、Azure VM Backup において、<br>「Standard バックアップ ポリシー (標準ポリシー) 」でバックアップを取得した場合と<br>「Enhanced バックアップ ポリシー (拡張ポリシー) 」でバックアップを取得した場合のそれぞれの料金の違いについて説明します。<br><img src="/blog/AzureVMBackup/VM_Backup_billing/VM_Backup_billing_01.png" alt="image"></p><p>(参考 関連ブログ記事)<br>・料金計算ツールを用いた Azure VM Backup の料金見積もりについて | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br>　<a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_calculator/">https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_calculator/</a></p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの機能の違いについて</a><br><a href="#2">2. Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの料金の違い</a><br><a href="#3">3. スナップショット料金の請求先について</a></p><hr><h2 id="1-Standard-バックアップ-ポリシーと-Enhanced-バックアップ-ポリシーの機能の違いについて"><a href="#1-Standard-バックアップ-ポリシーと-Enhanced-バックアップ-ポリシーの機能の違いについて" class="headerlink" title="1. Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの機能の違いについて"></a>1. Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの機能の違いについて<a id="1"></a></h2><p>それぞれのバックアップ ポリシーで Azure VM Backup を取得する場合の機能の違いは下記公開ドキュメントをご参照ください。<br>・拡張ポリシーを使用して Azure VM をバックアップする - Azure Backup | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal</a></p><h2 id="2-Standard-バックアップ-ポリシーと-Enhanced-バックアップ-ポリシーの料金の違い"><a href="#2-Standard-バックアップ-ポリシーと-Enhanced-バックアップ-ポリシーの料金の違い" class="headerlink" title="2. Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの料金の違い"></a>2. Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの料金の違い<a id="2"></a></h2><h3 id="Azure-VM-Backup-の料金"><a href="#Azure-VM-Backup-の料金" class="headerlink" title="Azure VM Backup の料金"></a>Azure VM Backup の料金</h3><p>Azure VM Backup を利用する場合、その料金を見積もる際には以下 3 点が課金項目となります。<br>　(1) Azure 仮想マシンのインスタンスに対する課金<br>　(2) Recovery Services コンテナーに保管されるバックアップ データに対する課金<br>　(3) Azure VM Backup の機能で取得されるスナップショットに対する課金</p><p>(1) と (2) の課金は、「Standard バックアップ ポリシー」でバックアップ取得しても、「Enhanced バックアップ ポリシー」でバックアップ取得しても、どちらも同じ料金計算方式となります。</p><p>この 2 項目は、下記公開ドキュメント上で説明している「保護されたインスタンス サイズ (1) 」「バックアップ ストレージの課金 (2) 」箇所に相当します。</p><p>(参考ドキュメント)<br>・バックアップのコスト<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-costs">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-costs</a><br>　引用： “保護されたインスタンス サイズの計算は、”実際の” VM のサイズに基づきます。”<br>　引用： “同様に、バックアップ ストレージの課金は、Azure Backup に格納されているデータ量 (各回復ポイントの実際のデータの合計) に基づきます。”</p><p>いっぽう (3) の課金は、「Standard バックアップ ポリシー」でバックアップ取得する場合と、「Enhanced バックアップ ポリシー」でバックアップ取得する場合とで、料金の加算方法が変わってきます。</p><h3 id="「Azure-VM-Backup-の機能で取得されるスナップショットに対する課金」の加算方法の違い"><a href="#「Azure-VM-Backup-の機能で取得されるスナップショットに対する課金」の加算方法の違い" class="headerlink" title="「Azure VM Backup の機能で取得されるスナップショットに対する課金」の加算方法の違い"></a>「Azure VM Backup の機能で取得されるスナップショットに対する課金」の加算方法の違い</h3><p>「Standard バックアップ ポリシー」では、初回のスナップショット取得時点では料金は発生しません。<br>「Enhanced バックアップ ポリシー」では、初回のスナップショット取得時点で、使用データ量分のスナップショットに対して料金が発生します。</p><p>また、1 GB あたりの課金額は以下の通りそれぞれ違いがあります。</p><p>標準ポリシー:  0.12 ドル/ 1 GB<br>拡張ポリシー:  0.05 ドル/ 1 GB</p><ul><li>リージョンにより料金が異なる場合がございます。(上記 および 以下の参考例は、USEast2 の価格となります。)</li></ul><p>下記の表は 100 GB の容量をもつ Azure 仮想マシンに対して、毎日 1 GB の増分が発生するケースにおいて、スナップショットを 4 日間保管した場合の比較表となります。<br>*表中の料金は前日からの増分により発生した課金の月額を示しており、実際の料金は保存期間によって変動する場合があります。<br>(参考例)<br><img src="/blog/AzureVMBackup/VM_Backup_billing/VM_Backup_billing_02.png"><br>※1 便宜上 100 GB と記載しておりますが、より正確には初回のスナップショット取得時点では 0 GB となります。<br>(その後の変更ブロック発生によりスナップショット サイズが増大いたします)</p><p>上記サンプルケースでは Enhanced バックアップ ポリシー 利用時の方が費用は高くなりますが、初回のバックアップデータ量が減った場合や、翌日以降の増分データ量が増加する場合は、Standard バックアップ ポリシー利用時の方が割高となるシナリオも考えられます。</p><p>「(3) Azure VM Backup の機能で取得されるスナップショットに対する課金」における<br>リージョン毎のスナップショット料金詳細は下記をご参照ください。</p><h4 id="Standard-バックアップ-ポリシー-スナップショットに対する料金"><a href="#Standard-バックアップ-ポリシー-スナップショットに対する料金" class="headerlink" title="Standard バックアップ ポリシー - スナップショットに対する料金"></a>Standard バックアップ ポリシー - スナップショットに対する料金</h4><p>下記リンクから、リージョン・通貨をご希望のものへと設定変更いただければ、スナップショットに対する料金を確認できます。<br>・Azure ページ BLOB Storage の価格 | Microsoft Azure<br>　<a href="https://azure.microsoft.com/ja-jp/pricing/details/storage/page-blobs/">https://azure.microsoft.com/ja-jp/pricing/details/storage/page-blobs/</a></p><p><img src="/blog/AzureVMBackup/VM_Backup_billing/VM_Backup_billing_03.png"></p><h4 id="Enhanced-バックアップ-ポリシー-スナップショットに対する料金"><a href="#Enhanced-バックアップ-ポリシー-スナップショットに対する料金" class="headerlink" title="Enhanced バックアップ ポリシー - スナップショットに対する料金"></a>Enhanced バックアップ ポリシー - スナップショットに対する料金</h4><p>下記リンクから、リージョン・通貨をご希望のものへと設定変更いただければ、スナップショットに対する料金を確認できます。<br>・料金 - Managed Disks | Microsoft Azure<br>　<a href="https://azure.microsoft.com/ja-jp/pricing/details/managed-disks/">https://azure.microsoft.com/ja-jp/pricing/details/managed-disks/</a></p><p><img src="/blog/AzureVMBackup/VM_Backup_billing/VM_Backup_billing_04.png"></p><h2 id="3-スナップショット料金の請求先について"><a href="#3-スナップショット料金の請求先について" class="headerlink" title="3. スナップショット料金の請求先について"></a>3. スナップショット料金の請求先について<a id="3"></a></h2><p>　(1) Azure 仮想マシンのインスタンスに対する課金<br>　(2) Recovery Services コンテナーに保管されるバックアップ データに対する課金<br>　(3) Azure VM Backup の機能で取得されるスナップショットに対する課金</p><p>上記料金の請求書上では、各項目 および バックアップ ポリシーの違いによって、次に示す表のように表示されます。<br>Azure Backup の 料金として請求される項目は (1) (2) であり、(3) は スナップショットにかかった料金 として別の項目として請求されます。 </p><table><thead><tr><th align="left">課金項目</th><th align="left">バックアップ ポリシー</th><th align="left">サービス名</th><th align="left">請求上の表示 (Meter)</th><th align="left">請求されるリソースグループ</th></tr></thead><tbody><tr><td align="left">(1)</td><td align="left">Standard / Enhanced バックアップ ポリシー</td><td align="left">Backup</td><td align="left">Azure VM Protected Instances</td><td align="left">Recovery Services コンテナーのリソース グループ</td></tr><tr><td align="left">(2)</td><td align="left">Standard / Enhanced バックアップ ポリシー</td><td align="left">Backup</td><td align="left"><span style="color: red; ">LRS</span> Data Stored</td><td align="left">Recovery Services コンテナーのリソース グループ</td></tr><tr><td align="left">(3)</td><td align="left">Standard バックアップ ポリシー</td><td align="left">Storage</td><td align="left">LRS snapshots</td><td align="left">Managed Disk のリソース グループ</td></tr><tr><td align="left">(3)</td><td align="left">Enhanced バックアップ ポリシー</td><td align="left">Storage</td><td align="left">Snapshots ZRS Snapshots</td><td align="left">復元ポイント コレクションのリソース グループ</td></tr></tbody></table><p>　( <span style="color: red; ">赤文字</span>部分は、対象 Recovery Services コンテナーの「ストレージ レプリケーションの種類」によって変わります)</p><p>ご参考までに、弊社検証環境にて確認した各項目の表示例を以下に示します。<br>画像 1：コスト分析画面にて確認した (1) および (2) の表示例（ストレージ レプリケーションの種類 ：ローカル冗長 (LRS)）<br><img src="/blog/AzureVMBackup/VM_Backup_billing/VM_Backup_billing_05.png" alt="画像 1"></p><p> 画像 2：コスト分析画面にて確認した (3) の表示例 (Standard バックアップ ポリシー)<br><img src="/blog/AzureVMBackup/VM_Backup_billing/VM_Backup_billing_06.png" alt="画像 2"></p><p>(参考) 画像 2 のバックアップ対象 の VM の Azure Managed Disk のリソース グループ名：rgsqlag<br><img src="/blog/AzureVMBackup/VM_Backup_billing/VM_Backup_billing_07.png" alt="参考"></p><p>画像 3：コスト分析画面にて確認した (3) の表示例 (Enhanced バックアップ ポリシー)<br><img src="/blog/AzureVMBackup/VM_Backup_billing/VM_Backup_billing_08.png" alt="画像 3"></p><p>(参考) 画像 3 の復元ポイント コレクションのリソース グループ名：azurebackuprg_eastus_1<br><img src="/blog/AzureVMBackup/VM_Backup_billing/VM_Backup_billing_09.png" alt="参考"></p><p>(補足)<br>各バックアップ ポリシーにて取得されるスナップショットはそれぞれ以下のスナップショット層へ格納されます。<br>　・Standard バックアップ ポリシー： LRS のスナップショット層<br>　・Enhanced バックアップ ポリシー： ZRS のスナップショット層 </p><p>(参考ドキュメント)<br>・拡張ポリシーを使用して Azure VM をバックアップする<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal</a><br>　引用： “インスタント復元層では、ゾーン冗長ストレージ (ZRS) の回復性を使用してゾーン冗長性が確保されています。”</p><p>本記事の内容は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、Azure VM Backup において、&lt;br&gt;「Standard バックアップ ポリシー (標準ポリシー) 」でバックアップを取得した場合と&lt;br&gt;「</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>QL4L-5D8 XNV5-HTZ クラシック アラートから Azure Monitor を使用した組み込みのアラートへの移行について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/HowToMoveClassicAlert/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/HowToMoveClassicAlert/</id>
    <published>2024-08-14T04:00:00.000Z</published>
    <updated>2025-01-06T06:27:18.435Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Backup サポートです。<br>今回は、2023 年 3 月末より弊社から発行されている、アラート追跡 ID 「QL4L-5D8」、「XNV5-HTZ」について説明いたします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#Q1">Q1. 「QL4L-5D8」「XNV5-HTZ」このアラートは何ですか？</a><br><a href="#Q2">Q2. どの Recovery Services コンテナーが「クラシック アラート設定」になっていますか？</a><br><a href="#Q3">Q3. クラシック アラートから Azure Monitor を使用した組み込みのアラートへと移行した場合のコストはどうなりますか？</a><br><a href="#Q4">Q4. クラシック アラートの「通知の構成」をしているかどうかは 1 つ 1 つの Recovery Services コンテナーを確認する必要がありますか？</a><br><a href="#Q5">Q5. Azure Monitor を使用した組み込みのアラートで、クラシック アラートと同じ重要度のアラート メールを通知するには？</a></p><hr><h2 id="Q1-「QL4L-5D8」「XNV5-HTZ」このアラートは何ですか？"><a href="#Q1-「QL4L-5D8」「XNV5-HTZ」このアラートは何ですか？" class="headerlink" title="Q1. 「QL4L-5D8」「XNV5-HTZ」このアラートは何ですか？"></a><a id="Q1"></a>Q1. 「QL4L-5D8」「XNV5-HTZ」このアラートは何ですか？</h2><p><strong>A1</strong> クラシック アラートから、Azure Monitor を使用した組み込みのアラートへと移行するよう、お知らせするためのものです。<br>Recovery Services コンテナーでは、クラシック アラートが<span style="color: red; ">既定</span>で存在しており、かつ、利用可能な状態となっております。<br>後述 「Q2. どの Recovery Services コンテナーが「クラシック アラート設定」になっていますか？」 をご参照いただき、クラシック アラートを利用した通知の設定有無をまずはご確認くださいますようお願いいたします。</p><h4 id="・クラシック-アラート機能用いて、現在メールへのアラート通知を構成している場合"><a href="#・クラシック-アラート機能用いて、現在メールへのアラート通知を構成している場合" class="headerlink" title="・クラシック アラート機能用いて、現在メールへのアラート通知を構成している場合"></a>・クラシック アラート機能用いて、現在メールへのアラート通知を構成している場合</h4><p>クラシック アラートは、2026 年 3 月 31 日をもって廃止する予定です。<br>監視設定を継続してご利用になられる場合は、お手数ではございますが、「Azure Monitor を使用した組み込みのアラート」への切り替えを事前にご検討くださいますようお願いいたします。</p><h4 id="・クラシック-アラート機能用いて、現在メールへのアラート通知を構成していないが、今後はバックアップ-ジョブ失敗時にメール通知などのアラートをご希望の場合"><a href="#・クラシック-アラート機能用いて、現在メールへのアラート通知を構成していないが、今後はバックアップ-ジョブ失敗時にメール通知などのアラートをご希望の場合" class="headerlink" title="・クラシック アラート機能用いて、現在メールへのアラート通知を構成していないが、今後はバックアップ ジョブ失敗時にメール通知などのアラートをご希望の場合"></a>・クラシック アラート機能用いて、現在メールへのアラート通知を構成していないが、今後はバックアップ ジョブ失敗時にメール通知などのアラートをご希望の場合</h4><p>クラシック アラートから、「Azure Monitor を使用した組み込みのアラート」へと切り替え設定することをご検討ください。</p><h4 id="・クラシック-アラート機能用いて、現在メールへのアラート通知を構成していない、かつ今後もバックアップ-ジョブ失敗時にメール通知などのアラートをご希望でない場合"><a href="#・クラシック-アラート機能用いて、現在メールへのアラート通知を構成していない、かつ今後もバックアップ-ジョブ失敗時にメール通知などのアラートをご希望でない場合" class="headerlink" title="・クラシック アラート機能用いて、現在メールへのアラート通知を構成していない、かつ今後もバックアップ ジョブ失敗時にメール通知などのアラートをご希望でない場合"></a>・クラシック アラート機能用いて、現在メールへのアラート通知を構成していない、かつ今後もバックアップ ジョブ失敗時にメール通知などのアラートをご希望でない場合</h4><p><span style="color: red; ">特段お客様での追加作業は不要です。</span></p><p>・監視とレポートのシナリオ<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/monitoring-and-alerts-overview#monitoring-and-reporting-scenarios">https://learn.microsoft.com/ja-jp/azure/backup/monitoring-and-alerts-overview#monitoring-and-reporting-scenarios</a></p><p><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_01.png"></p><p><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_02.png"></p><p><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_03.png"></p><h2 id="Q2-どの-Recovery-Services-コンテナーが「クラシック-アラート設定」になっていますか？"><a href="#Q2-どの-Recovery-Services-コンテナーが「クラシック-アラート設定」になっていますか？" class="headerlink" title="Q2.どの Recovery Services コンテナーが「クラシック アラート設定」になっていますか？"></a><a id="Q2"></a>Q2.どの Recovery Services コンテナーが「クラシック アラート設定」になっていますか？</h2><p><strong>A2</strong><br>・既定ですべての Recovery Services コンテナーにおいて、「Azure Monitor を使用した組み込みのアラート」へと移行していない Recovery Services コンテナーは、「クラシック アラート」が有効になっており、今回の正常性アラート対象となっております<br>・実際に「クラシック アラート」を用いてメールへの通知構成をしているかどうかは、お客様環境の設定次第です</p><h4 id="【どの-Recovery-Services-コンテナーでクラシック-アラートが有効になっているのかを確認する方法】"><a href="#【どの-Recovery-Services-コンテナーでクラシック-アラートが有効になっているのかを確認する方法】" class="headerlink" title="【どの Recovery Services コンテナーでクラシック アラートが有効になっているのかを確認する方法】"></a>【どの Recovery Services コンテナーでクラシック アラートが有効になっているのかを確認する方法】</h4><p>[バックアップ センター] ブレードの [概要] タブより、”アクティブなアラート” 項目に<br><code>[以前のアラート ソリューションであるクラシック アラートを使用しているコンテナーが xx 個あります。]</code><br> と表示されている場合、クラシック アラートが有効・利用可能となっている Recovery Services コンテナーが存在しています。</p><p>この記述がある場合は、後述される [アクションを起こすには、ここをクリック] をクリックします。</p><p><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_04.png"></p><p>Azure Monitor アラートのみの使用をオプトインの [アラートの管理] をクリックします。</p><p><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_05.png"></p><p>[Azure Monitor アラートのみの使用をオプトイン] 画面にて、リストされている Recovery Services コンテナーを確認します。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>項目 <code>クラシック アラートのバックアップ</code> が「はい」となっている Recovery Services コンテナーが対象となります。</p></div><p><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_06.png"></p><h4 id="【どの-Recovery-Services-コンテナーが、クラシック-アラートの「通知の構成」を行っているのかを確認する方法】"><a href="#【どの-Recovery-Services-コンテナーが、クラシック-アラートの「通知の構成」を行っているのかを確認する方法】" class="headerlink" title="【どの Recovery Services コンテナーが、クラシック アラートの「通知の構成」を行っているのかを確認する方法】"></a>【どの Recovery Services コンテナーが、クラシック アラートの「通知の構成」を行っているのかを確認する方法】</h4><p>リストされた Recovery Services コンテナーが実際に通知の構成をしているかどうかは、上記でリストされた Recovery Services コンテナー ＞ [バックアップ アラート] ＞ ”通知の構成” ＞ 「メールの通知：オン」 となっているかどうかで確認可能です。<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_07.png"></p><p>通知の構成をしている Recovery Services コンテナーがある場合、[Azure Monitor アラートのみの使用をオプトイン] 画面にて、アラートの設定の更新を行います。</p><div class="alert is-info"><p class="alert-title">Note</p><p>”通知の構成” ＞「メールの通知：オン」をしている Recovery Services コンテナーが無い場合、かつ、今後バックアップジョブの監視設定をする必要が無い場合は、下記対応は不要です。</p></div><p>まず、対象 Recovery Services コンテナーを選択して、”アラートの設定” 列の “更新” を押下してください。<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_08.png"></p><p>表示された [監視の設定] 画面にて “Backup 用の Azure Monitor アラートのみを使用” にチェックを入れてください。<br>また “Backup のジョブ エラーに関する組み込みの Azure Monitor アラート” も有効化してください。<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_09.png"></p><div class="alert is-warning"><p class="alert-title">警告</p><p> “ジョブ エラーに関する組み込みの Azure Monitor アラート” が無効化されていると、バックアップセンターの下記概要画面上ではクラシック アラートを使用しているコンテナーとしてカウントされたままとなりますのでご注意ください。</p><p><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_10.png"></p></div><p>最後に画面下部の “更新” ボタンを押下していただければ、クラシック アラートの廃止は完了いたします。</p><p>なお、 [監視の設定] 画面に記載されているように、メールなどの通知が必要な場合は、別途設定していただく必要があります。<br>詳細は下記のドキュメントを参照いただければと存じます。<br>・クラシック アラートから組み込みのAzure Monitor アラートに移行する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/move-to-azure-monitor-alerts#migrate-from-classic-alerts-to-built-in-azure-monitor-alerts">https://learn.microsoft.com/ja-jp/azure/backup/move-to-azure-monitor-alerts#migrate-from-classic-alerts-to-built-in-azure-monitor-alerts</a></p><h2 id="Q3-クラシック-アラートから-Azure-Monitor-を使用した組み込みのアラートへと移行した場合のコストはどうなりますか？"><a href="#Q3-クラシック-アラートから-Azure-Monitor-を使用した組み込みのアラートへと移行した場合のコストはどうなりますか？" class="headerlink" title="Q3.クラシック アラートから Azure Monitor を使用した組み込みのアラートへと移行した場合のコストはどうなりますか？"></a><a id="Q3"></a>Q3.クラシック アラートから Azure Monitor を使用した組み込みのアラートへと移行した場合のコストはどうなりますか？</h2><p><strong>A3</strong> 「Azure Monitor を使用した組み込みのアラートが生成されること」自体に料金は発生しません。<br>一方、メールなどへアラートを通知させる場合は、少額の料金が発生いたします。<br>詳細は下記ドキュメントよりご参照ください。</p><p>・クラシック アラートから組み込みの Azure Monitor アラートに移行する<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/move-to-azure-monitor-alerts#migrate-from-classic-alerts-to-built-in-azure-monitor-alerts">https://learn.microsoft.com/ja-jp/azure/backup/move-to-azure-monitor-alerts#migrate-from-classic-alerts-to-built-in-azure-monitor-alerts</a></p><p><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_11.png"></p><p>Free レベル (1 か月あたり 1,000 メール) を超える通知に対しては、下記の料金が発生します。</p><p>・価格 - Azure Monitor | Microsoft Azure<br><a href="https://azure.microsoft.com/ja-jp/pricing/details/monitor/">https://azure.microsoft.com/ja-jp/pricing/details/monitor/</a><br>“メール            1 か月あたりメール 1,000 通         メール 100,000 通につき $2”<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_12.png"></p><h2 id="Q4-クラシック-アラートの「通知の構成」をしているかどうかは-1-つ-1-つの-Recovery-Services-コンテナーを確認する必要がありますか？"><a href="#Q4-クラシック-アラートの「通知の構成」をしているかどうかは-1-つ-1-つの-Recovery-Services-コンテナーを確認する必要がありますか？" class="headerlink" title="Q4.クラシック アラートの「通知の構成」をしているかどうかは 1 つ 1 つの Recovery Services コンテナーを確認する必要がありますか？"></a><a id="Q4"></a>Q4.クラシック アラートの「通知の構成」をしているかどうかは 1 つ 1 つの Recovery Services コンテナーを確認する必要がありますか？</h2><p><strong>A4</strong> 恐縮ながら、現状はクラシック アラートの「通知の構成」部分を照会するような Azure PowerShell / Azure CLI コマンドのご用意が無いため、お客様には Azure ポータル画面の Recovery Services コンテナーを 1 つ 1 つ確認いただく必要がございます。<br>※　前提としてクラシック アラートの「通知の構成」をされているのであれば、お客様が設定されたメールアドレスの宛先へと、バックアップ ジョブ失敗時などに通知がなされています。</p><p>その他確認手段の 1 つとして、以下のような REST API を発行することで確認が可能ですので、参考として紹介いたします。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>以下 REST API は、本ブログ発行時点で確認可能な手段であり、事前予告なく返却値が変わる可能性がありますこと、ご了承ください。</p><p>さらに、以下 REST API は、あくまで参考としてご連携するサンプル コマンドでございます。</p><p>コマンド実装をされる場合は貴社にて検証のうえ、実施いただきますようご留意ください。</p><p>また、Azure サポートでは主に Post Production の Break &amp; Fix を担当しており、スクリプトのコードレビューのサポートは承っておりませんので、予めご理解をいただけますと幸いでございます。</p></div><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">### クラシック アラートのメール通知が有効化されているかを確認する </span><br><span class="line">### ※ (前提) Connect-AzAccount コマンドにて、 Azure に接続可能な状態で実行すること</span><br><span class="line"></span><br><span class="line">$RSVList = Get-AzRecoveryServicesVault | Select-Object Name, ResourceGroupName, SubscriptionId</span><br><span class="line"></span><br><span class="line"># リクエスト ヘッダーを作成</span><br><span class="line">$headers = @&#123;</span><br><span class="line">    &#x27;Content-type&#x27;  = &#x27;application/json&#x27;</span><br><span class="line">    &#x27;Authorization&#x27; = &#x27;Bearer &#x27; + (Get-AzAccessToken).Token</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 結果出力先のオブジェクトを作成</span><br><span class="line">$results = @()</span><br><span class="line"></span><br><span class="line"># Recovery Services コンテナーごとに API へリクエストを送り、結果を取得する</span><br><span class="line">foreach ( $rsv in $RSVList ) &#123;</span><br><span class="line">    $uri = &quot;https://management.azure.com/subscriptions/$($rsv.SubscriptionId)/resourceGroups/$($rsv.ResourceGroupName)/providers/Microsoft.RecoveryServices/vaults/$($rsv.Name)/monitoringConfigurations/notificationConfiguration?api-version=2017-07-01-preview&quot;</span><br><span class="line">    $response = (Invoke-RestMethod -Uri $uri -Method Get -Headers $headers).properties</span><br><span class="line">    $results += @([pscustomobject]@&#123;subscriptionID = $rsv.SubscriptionId; resourceGroupName = $rsv.ResourceGroupName; recoveryServicesContainerName = $rsv.Name; isClassicAlertNotificationEnabled = $response.areNotificationsEnabled; mailRecipients = $response.additionalRecipients -join &#x27;; &#x27; &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 全ての結果をコンソール出力</span><br><span class="line">$results | Sort-Object isClassicAlertNotificationEnabled -Descending | ForEach-Object &#123; Write-Output $_ | Format-Table &#125;</span><br></pre></td></tr></table></figure><p>上記 REST API を発行した場合、「isClassicAlertNotificationEnabled：True」となっている Recovery Services コンテナーが「通知の構成：オン」となっているものとなります。<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_13.png"></p><p><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_14.png"></p><p><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_15.png"></p><p><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_16.png"></p><h2 id="Q5-Azure-Monitor-を使用した組み込みのアラートで、クラシック-アラートと同じ重要度のアラート-メールを通知するには？"><a href="#Q5-Azure-Monitor-を使用した組み込みのアラートで、クラシック-アラートと同じ重要度のアラート-メールを通知するには？" class="headerlink" title="Q5. Azure Monitor を使用した組み込みのアラートで、クラシック アラートと同じ重要度のアラート メールを通知するには？"></a><a id="Q5"></a>Q5. Azure Monitor を使用した組み込みのアラートで、クラシック アラートと同じ重要度のアラート メールを通知するには？</h2><p><strong>A5</strong><br>まず、クラシック アラートと Azure Monitor アラートの重要度につきまして、以下にご案内いたします。</p><div class="alert is-info"><p class="alert-title">Note</p><p>お急ぎの方は、下記各アラートの重要度に関する説明は省略いただいて問題ございません。設定方法をご案内している <a href="#Q5.1">【Azure Monitor を使用した組み込みのアラートで、クラシック アラートと同じ重要度のアラート メールを通知する設定方法】</a> をご確認ください。</p></div><h4 id="クラシック-アラートの重要度について"><a href="#クラシック-アラートの重要度について" class="headerlink" title="クラシック アラートの重要度について"></a>クラシック アラートの重要度について</h4><p>クラシック アラートでは、「重大」、「警告」の 2 種のアラートが以下のタイミングで発報されます。  </p><ul><li>「重大」 : バックアップやリストアの失敗、バックアップ データの削除などの破壊的操作が行われたとき  </li><li>「警告」 : MARS エージェントでのバックアップ操作で警告が発生したとき  </li></ul><p>・ Azure Backup で保護されたワークロードの監視 - Azure Backup | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults#alert-types">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults#alert-types</a><br>　 抜粋 :</p><blockquote><p><strong>重大</strong>: 原則として、(スケジュールされたかユーザーがトリガーしたかを問わず) バックアップまたは回復が失敗すると、アラートが生成されて “重大” アラートとして表示されます。 アラートは、バックアップの削除などの破壊的な操作でも生成されます。<br><strong>警告</strong>: バックアップ操作が成功したもののいくつかの警告を伴う場合、これらは “警告” アラートとして表示されます。 警告アラートは現在、Azure Backup エージェントのバックアップにのみ使用できます。<br><strong>情報</strong>: 現時点では、Azure Backup サービスで “情報” アラートは生成されません。  </p></blockquote><h4 id="Azure-Monitor-の組み込みアラートの重要度について"><a href="#Azure-Monitor-の組み込みアラートの重要度について" class="headerlink" title="Azure Monitor の組み込みアラートの重要度について"></a>Azure Monitor の組み込みアラートの重要度について</h4><p>Azure Monitor の組み込みアラートでは、主に「セキュリティ アラート」、「ジョブの失敗のアラート」の 2 種のアラートが以下のタイミングで発報されます。  </p><ul><li>「セキュリティ アラート」(重要度 : 0 - 重大) : バックアップ データの削除や、コンテナーの論理的な削除機能が無効化されたとき  </li><li>「ジョブの失敗のアラート」(重要度 : 1 - エラー) : バックアップやリストアが失敗したとき  </li></ul><p>また、MARS エージェントでのバックアップ操作で警告が発生したときや、SQL Server バックアップでサポートされていないバックアップ タイプが設定されていたときには、警告 (重要度 : 2 - 警告) アラートが発報されます。  </p><p>・ Azure Backup で保護されたワークロードの監視 - Azure Backup | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults#azure-monitor-alerts-for-azure-backup">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults#azure-monitor-alerts-for-azure-backup</a><br>　 抜粋 :  </p><blockquote><p><strong>セキュリティ アラート</strong>: バックアップ データの削除や、コンテナーの論理的な削除機能の無効化などのシナリオの場合、セキュリティ アラート (重大度 0) が発生し、Azure portal に表示されるか、他のクライアント (PowerShell、CLI、REST API) で使用されます。<br><strong>ジョブの失敗のアラート</strong>: バックアップ エラーや復元エラーなどのシナリオの場合、Azure Backup は、Azure Monitor 経由で組み込みアラート (重大度 1) を提供します。  </p></blockquote><p>・ SQL Server のデータベース バックアップに関するトラブルシューティング - Azure Backup | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-sql-server-azure-troubleshoot#backup-type-unsupported">https://learn.microsoft.com/ja-jp/azure/backup/backup-sql-server-azure-troubleshoot#backup-type-unsupported</a>  </p><h4 id="クラシック-アラートと-Azure-Monitor-を利用した組み込みのアラートの重要度の関係性について"><a href="#クラシック-アラートと-Azure-Monitor-を利用した組み込みのアラートの重要度の関係性について" class="headerlink" title="クラシック アラートと Azure Monitor を利用した組み込みのアラートの重要度の関係性について"></a>クラシック アラートと Azure Monitor を利用した組み込みのアラートの重要度の関係性について</h4><p>クラシック アラートと Azure Monitor を利用した組み込みのアラートの重要度は、おおよそ以下の関係性がございます。</p><ul><li>クラシック アラートの 「重大」 ≒  Azure Monitor を利用した組み込みのアラートの 「重大」 + 「エラー」  </li><li>クラシック アラートの 「警告」 ≒  Azure Monitor を利用した組み込みのアラートの 「警告」  </li></ul><h3 id="【Azure-Monitor-を使用した組み込みのアラートで、クラシック-アラートと同じ重要度のアラート-メールを通知する設定方法】"><a href="#【Azure-Monitor-を使用した組み込みのアラートで、クラシック-アラートと同じ重要度のアラート-メールを通知する設定方法】" class="headerlink" title="【Azure Monitor を使用した組み込みのアラートで、クラシック アラートと同じ重要度のアラート メールを通知する設定方法】"></a><a id="Q5.1"></a>【Azure Monitor を使用した組み込みのアラートで、クラシック アラートと同じ重要度のアラート メールを通知する設定方法】</h3><p>Azure Monitor を使用した組み込みのアラートで、クラシック アラートと同じ重要度のアラート メールを通知する設定方法を、以下にご案内いたします。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>下記ドキュメントに従って、クラシック アラートから組み込みの Azure Monnitor アラートへ移行する設定が完了していることが前提となります。</p><p>もし未設定である場合には、事前に下記ドキュメントの手順 1 ~ 7 を実行してください。</p><p>・ Azure Backup 用の Azure Monitor ベースのアラートに切り替える - Azure Backup | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/move-to-azure-monitor-alerts#migrate-from-classic-alerts-to-built-in-azure-monitor-alerts">https://learn.microsoft.com/ja-jp/azure/backup/move-to-azure-monitor-alerts#migrate-from-classic-alerts-to-built-in-azure-monitor-alerts</a>  </p></div><h4 id="クラシック-アラートのメール通知設定を確認する"><a href="#クラシック-アラートのメール通知設定を確認する" class="headerlink" title="クラシック アラートのメール通知設定を確認する"></a>クラシック アラートのメール通知設定を確認する</h4><p>Recovery Services コンテナーの <code>監視 &gt; バックアップ アラート &gt; 通知の構成</code> を表示し、項目「重要度」の設定内容を確認します。  </p><p><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_17.png"></p><h4 id="Azure-Backup-用のアラート処理ルールの設定を変更する"><a href="#Azure-Backup-用のアラート処理ルールの設定を変更する" class="headerlink" title="Azure Backup 用のアラート処理ルールの設定を変更する"></a>Azure Backup 用のアラート処理ルールの設定を変更する</h4><p>バックアップ センターの <code>監視とレポート &gt; アラート &gt; アラート処理ルール</code> を表示し、Azure Monitor アラートへ切り替えるときに作成したアラート処理ルールを編集します。  </p><p><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_18.png"><br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_19.png"></p><p>項目 フィルター に、「重要度」フィルターを追加し、値として “0 - 重大”, “1 - エラー”, “2 - 警告” のいずれかを選択し、設定を保存します。<br>(下記例においては、クラシック アラートの重要度設定が “クリティカル, 警告” となっていたため、”0 - 重大”, “1 - エラー”, “2 - 警告” の 3 点を選択しております。)<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_20.png"></p><p>以上で設定は完了です。  </p><h3 id="クラシック-アラートと-Azure-Monitor-を使用した組み込みのアラートの通知メールのサンプル"><a href="#クラシック-アラートと-Azure-Monitor-を使用した組み込みのアラートの通知メールのサンプル" class="headerlink" title="クラシック アラートと Azure Monitor を使用した組み込みのアラートの通知メールのサンプル"></a><a id="Q5.2"></a>クラシック アラートと Azure Monitor を使用した組み込みのアラートの通知メールのサンプル</h3><p>クラシック アラートと Azure Monitor を使用した組み込みのアラートの通知メールのサンプルを、以下のとおりご案内いたします。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>こちらのサンプル メールは 2024/8 頃に受信したものとなりますので、あくまで参考程度に留めてくださいますようお願い申し上げます。</p><p>より正確な内容をご確認いただくためにも、お客様ご自身で、アラート メールの受信検証を行っていただき、内容をご確認ください。</p></div><ul><li><p>バックアップ ジョブ失敗に関するアラート メール  </p><ul><li>クラシック アラート<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_21.png">  </li><li>Azure Monitor を使用した組み込みのアラート<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_22.png">  </li></ul></li><li><p>セキュリティ アラート メール  </p><ul><li>クラシック アラート<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_23.png">  </li><li>Azure Monitor を使用した組み込みのアラート<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_24.png">  </li></ul></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、2023 年 3 月末より弊社から発行されている、アラート追跡 ID 「QL4L-5D8」、「XNV5-HTZ」について説明いたします。&lt;/p&gt;
&lt;h2 id</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>ASR の障害調査に必要な情報</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureSiteRecovery/RequestForInvestigating_ASR/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureSiteRecovery/RequestForInvestigating_ASR/</id>
    <published>2024-08-13T03:00:00.000Z</published>
    <updated>2025-01-06T06:27:18.611Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Site Recovery サポートです。<br>Azure Site Recovery (以下、ASR ) に関する調査をスムーズに進める為に、お客様側で確認して頂く箇所と、調査に必要な環境情報とログ情報を取得して頂き、サポートへ送付して頂く場合がございます。<br>今回は、ASR の障害調査に必要な <strong>環境情報</strong> と <strong>ログ情報</strong> について、ご案内いたします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. 調査に必要な環境情報</a><br><a href="#2">2. ログの取得方法</a><br><a href="#2-1">2-1. Azure to Azure シナリオの障害調査に必要なログ</a><br><a href="#2-2">2-2. VMware to Azure / 物理マシン to Azure クラシック シナリオの障害調査に必要なログ</a><br><a href="#2-3">2-3. VMware to Azure / 物理マシン to Azure モダン化シナリオの障害調査に必要なログ</a><br><a href="#2-4">2-4. Hyper-V to Azure シナリオの障害調査に必要なログ</a><br><a href="#3">3. ログ収集ツールの使用方法</a><br><a href="#3-1">3-1. ASRDiagnosticTool の使用方法</a><br><a href="#3-2">3-2. collect_support_materials の使用方法</a>  </p><hr><h2 id="1-調査に必要な環境情報"><a href="#1-調査に必要な環境情報" class="headerlink" title=" 1. 調査に必要な環境情報"></a><a id="1"></a> 1. 調査に必要な環境情報</h2><p>※既にお問い合わせチケット上に起票頂いている場合は、記載は不要になります。</p><ol><li>問題が発生しているサブスクリプション ID  </li><li>ASR のシナリオ詳細 (以下の内のどれか)<br>　a. Azure to Azure<br>　b. VMware to Azure モダン化<br>　c. VMware to Azure クラシック<br>　d. 物理マシン to Azure モダン化<br>　e. 物理マシン to Azure クラシック<br>　f. Hyper-V to Azure</li><li>問題が発生している Recovery Service コンテナー名 </li><li>問題が発生している Recovery Service コンテナーのリソース グループ名 </li><li>対象の マシン名</li><li>対象の Azure 仮想マシンのリソース グループ名</li><li>対象の OS </li><li>Proxy 設定の有無</li><li>ASR プライベート エンドポイント 設定の有無</li><li>Express Route 使用の有無</li></ol><h3 id="「モダン化」と「クラシック」を見分ける方法"><a href="#「モダン化」と「クラシック」を見分ける方法" class="headerlink" title="「モダン化」と「クラシック」を見分ける方法"></a>「モダン化」と「クラシック」を見分ける方法</h3><p>ASR の VMware to Azure シナリオ / 物理マシン to Azure シナリオ では 「モダン化」 と 「クラシック」 の 2 つの構成があります。<br>「モダン化」 と 「クラシック」 のどちらを利用しているかは、以下の画面から確認いただけます。</p><p>Azure Portal にて Recovery Services コンテナーを開き &gt; はじめに - Site Recovery &gt; 「VMware マシンを Azure に」 の下にある 1. の末尾に <code>(従来)</code> が、<br>付与されている場合は、<strong>「クラシック」の Recovery Services コンテナー</strong> となります。<br>付与されて<strong>いない</strong>場合は、<strong>「モダン化」の Recovery Services コンテナー</strong> となります。</p><p><img src="/blog/AzureSiteRecovery/RequestForInvestigating_ASR/RequestForInvestigating_ASR_01.png"></p><h2 id="2-ログの取得方法"><a href="#2-ログの取得方法" class="headerlink" title=" 2. ログの取得方法"></a><a id="2"></a> 2. ログの取得方法</h2><h3 id="2-1-Azure-to-Azure-シナリオの障害調査に必要なログ"><a href="#2-1-Azure-to-Azure-シナリオの障害調査に必要なログ" class="headerlink" title=" 2-1. Azure to Azure シナリオの障害調査に必要なログ"></a><a id="2-1"></a> 2-1. Azure to Azure シナリオの障害調査に必要なログ</h3><p>本シナリオではログを収集する方法が 2 つありますので、下記いずれかの方法にてログを収集ください。  </p><ul><li>方法 1 : ツールを使用してログを収集する</li><li>方法 2 : 手動でログを収集する  </li></ul><h4 id="方法-1-ツールを使用してログを収集する"><a href="#方法-1-ツールを使用してログを収集する" class="headerlink" title="(方法 1) ツールを使用してログを収集する"></a>(方法 1) ツールを使用してログを収集する</h4><p><u>&lt; Windows の場合 &gt;</u><br>下記の手順に沿って ASRDiagnosticTool  を実行し、ログをご収集ください。<br><a href="#3-1">3-1 ASRDiagnosticTool の使用方法</a></p><p><span style="color: red; ">またツール取得に加えて下記ファイルを手動で収集し、ご提供ください。</span>  </p><blockquote><p>C:\WindowsAzure\Logs</p></blockquote><p><u>&lt; Linux の場合 &gt;</u><br>下記の手順に沿って collect_support_materials.sh を実行し、ログをご収集ください。<br><a href="#3-2">3-2 collect_support_materials の使用方法</a>  </p><p><span style="color: red; ">またツール取得に加えて下記ファイルを手動で収集し、ご提供ください。</span>  </p><blockquote><p>/var/log/<br>  - evtcollforw.log<br>  - InstallerError.json<br>  - tagTelemetry_*.log<br>  - uarespawnd.log<br>  - Waagent.log<br>  - azure<br>  - ASRsetuptelemetry  </p></blockquote><h4 id="方法-2-手動でログを収集する"><a href="#方法-2-手動でログを収集する" class="headerlink" title="(方法 2 ) 手動でログを収集する"></a>(方法 2 ) 手動でログを収集する</h4><p><u>&lt; Windows の場合 &gt;</u>  </p><blockquote><p>C:\ProgramData\ASRSetupLogs<br>C:\ProgramData\Microsoft Azure Site Recovery<br>C:\Program Files\Microsoft Azure Recovery Services Agent\Temp<br>C:\Windows\System32\winevt\logs<br>C:\WindowsAzure\Logs<br>C:\Program Files (x86)\Microsoft Azure Site Recovery\agent <strong>(※1)</strong> </p></blockquote><p><strong>(※1)</strong> 全量いただけることが望ましいですが、全量が困難な場合は下記をご提供ください。  </p><blockquote><p>C:\Program Files (x86)\Microsoft Azure Site Recovery\agent\<br>  - AzureRcmCli.log<br>  - evtcollforw.log<br>  - s2*.log<br>  - svagent*.log<br>  - vacp.log<br>  - Application Data\ApplicationPolicyLogs<br>  - vxlogs  </p></blockquote><p><u>&lt; Linux の場合 &gt;</u>  </p><blockquote><p>/var/log/  <strong>(※1)</strong></p></blockquote><p><strong>(※1)</strong> 全量いただけることが望ましいですが、全量が困難な場合は下記をご提供ください。     </p><blockquote><p>/var/log/<br>  - ApplicationPolicyLogs/vacp.log<br>  - appservice*.log<br>  - AzureRcmCli.log<br>  - cdpcli.log<br>  - evtcollforw.log<br>  - InMage*.log<br>  - InstallerError.json<br>  - involflt*.log<br>  - s2*.log<br>  - svagent*.log<br>  - tagTelemetry_*.log<br>  - ua_install.log<br>  - uarespawnd.log<br>  - Waagent.log<br>  - azure<br>  - vxlogs<br>  - ApplicationData<br>  - ASRsetuptelemetry  </p></blockquote><h3 id="2-2-VMware-to-Azure-物理マシン-to-Azure-クラシック-シナリオの障害調査に必要なログ"><a href="#2-2-VMware-to-Azure-物理マシン-to-Azure-クラシック-シナリオの障害調査に必要なログ" class="headerlink" title=" 2-2. VMware to Azure / 物理マシン to Azure クラシック シナリオの障害調査に必要なログ"></a><a id="2-2"></a> 2-2. VMware to Azure / 物理マシン to Azure クラシック シナリオの障害調査に必要なログ</h3><p>ログ取得対象は下記マシン両方となります。</p><ul><li>構成サーバーとして機能するマシン</li><li>ソース マシン (保護対象マシン)</li></ul><p>本シナリオではログを収集する方法が 2 つありますので、下記いずれかの方法にてログを収集ください。</p><ul><li>方法 1 : ツールを使用してログを収集する</li><li>方法 2 : 手動でログを収集する</li></ul><p><span style="color: red; ">「構成サーバーとして機能するマシン」 と 「ソース マシン (保護対象マシン)」 両方から</span> 、 それぞれのログを収集ください。</p><h4 id="方法-1-ツールを使用してログを収集する-1"><a href="#方法-1-ツールを使用してログを収集する-1" class="headerlink" title="(方法 1) ツールを使用してログを収集する"></a>(方法 1) ツールを使用してログを収集する</h4><p><u>&lt; 構成サーバーおよび ソース マシンが Windows の場合 &gt;</u><br>下記の手順に沿ってASRDiagnosticTool  を実行し、ログをご収集ください。<br><a href="#3-1">3-1 ASRDiagnosticTool の使用方法</a></p><p><u>&lt; ソース マシンが Linux の場合 &gt;</u><br>下記の手順に沿って collect_support_materials.sh を実行し、ログをご収集ください。<br><a href="#3-2">3-2 collect_support_materials の使用方法</a></p><h4 id="方法-2-手動でログを収集する-1"><a href="#方法-2-手動でログを収集する-1" class="headerlink" title="(方法 2 ) 手動でログを収集する"></a>(方法 2 ) 手動でログを収集する</h4><p><u>&lt; 構成サーバー &gt;</u>  </p><blockquote><p>C:\ProgramData\ASRLogs<br>C:\ProgramData\ASRSetupLogs<br>C:\Windows\System32\winevt\logs<br>&lt;Cache InstallDir&gt;\home\svsystems\pushinstallsvc\temporaryfiles\  </p></blockquote><p><u>&lt; ソース マシン (Windows) &gt;</u>  </p><blockquote><p>C:\ProgramData\ASRSetupLogs</p></blockquote><p><u>&lt; ソース マシン (Linux) &gt;</u></p><blockquote><p>var/log/ua_install.log </p></blockquote><h3 id="2-3-VMware-to-Azure-物理マシン-to-Azure-モダン化シナリオの障害調査に必要なログ"><a href="#2-3-VMware-to-Azure-物理マシン-to-Azure-モダン化シナリオの障害調査に必要なログ" class="headerlink" title=" 2-3. VMware to Azure / 物理マシン to Azure モダン化シナリオの障害調査に必要なログ"></a><a id="2-3"></a> 2-3. VMware to Azure / 物理マシン to Azure モダン化シナリオの障害調査に必要なログ</h3><p>ログ取得対象は下記マシン両方となります。</p><ul><li>レプリケーション アプライアンスとして機能するマシン</li><li>ソース マシン (保護対象マシン)</li></ul><p>本シナリオではログを収集する方法が 2 つありますので、下記いずれかの方法にてログを収集ください。</p><ul><li>方法 1 : ツールを使用してログを収集する</li><li>方法 2 : 手動でログを収集する</li></ul><p><span style="color: red; ">「構成サーバーとして機能するマシン」 と 「ソース マシン (保護対象マシン)」 両方から</span> 、 それぞれのログを収集ください。</p><h4 id="方法-1-ツールを使用してログを収集する-2"><a href="#方法-1-ツールを使用してログを収集する-2" class="headerlink" title="(方法 1) ツールを使用してログを収集する"></a>(方法 1) ツールを使用してログを収集する</h4><p><u>&lt; レプリケーション アプライアンス および ソース マシンが Windows の場合 &gt;</u><br>下記の手順に沿ってASRDiagnosticTool  を実行し、ログをご収集ください。<br><a href="#3-1">3-1 ASRDiagnosticTool の使用方法</a></p><p><u>&lt; ソース マシンが Linux の場合 &gt;</u><br>下記の手順に沿って collect_support_materials.sh を実行し、ログをご収集ください。<br><a href="#3-2">3-2 collect_support_materials の使用方法</a></p><p><span style="color: red; ">またツール取得に加えて下記ファイルを手動で収集し、ご提供ください。</span>  </p><blockquote><p>/var/log/<br> - evtcollforw.log<br> - InstallerError.json<br> - tagTelemetry_*.log<br> - uarespawnd.log<br> - Waagent.log<br> - azure<br> - ASRsetuptelemetry  </p></blockquote><h4 id="方法-2-手動でログを収集する-2"><a href="#方法-2-手動でログを収集する-2" class="headerlink" title="(方法 2 ) 手動でログを収集する"></a>(方法 2 ) 手動でログを収集する</h4><p><u>&lt; レプリケーション アプライアンス &gt;</u><br>※ ファイルが存在しなければ取得不要です<br>※ <code>&lt;Cache InstallDir&gt;</code> はアプライアンス構築時に指定したキャッシュ ディスクとなり、デフォルトでは <code>E:\</code> ドライブとなります。 </p><blockquote><p>C:\Program Files\Microsoft Azure Recovery Services Agent\Temp<br>C:\Program Files\Microsoft Azure Recovery Services On-Premise Agent\logs<br>C:\Program Files\Microsoft Azure Site Recovery Process Server\home\svsystems<br>C:\ProgramData\MicrosoftAzureDRApplianceConfigurationManager.log<br>C:\ProgramData\Microsoft Azure\Logs<br>C:\ProgramData\ASRLogs<br>C:\ProgramData\AutoUpdateInstaller.log<br>C:\ProgramData\DiscoveryServiceServerInstall.log<br>C:\ProgramData\DiscoveryServiceVmwareInstall.log<br>C:\ProgramData\InstallDra.log<br>C:\ProgramData\PushInstallAgentSetup.log<br>C:\ProgramData\RcmProxyAgentSetup.log<br>C:\ProgramData\RcmReplicationAgentSetup.log<br>C:\ProgramData\RcmReprotectAgentSetup.log<br>C:\ProgramData\ProcessServerSetup.log<br>C:\ProgramData\Install Log<br>C:\Windows\Temp\OBInstaller0Curr.errlog<br>C:\Windows\Temp\OBManagedlog.LOGCurr.errlog<br>C:\Windows\Temp\OBMsi.log<br>&lt;Cache InstallDir&gt;\MarsAgent<br>&lt;Cache InstallDir&gt;\PSTelemetry<br>&lt;Cache InstallDir&gt;\PushInstallAgent<br>&lt;Cache InstallDir&gt;\RcmProxyAgent<br>&lt;Cache InstallDir&gt;\RcmReplicationAgent<br>&lt;Cache InstallDir&gt;\RcmReprotectAgent  </p></blockquote><p><u>&lt; ソース マシン (Windows) &gt;</u></p><blockquote><p>C:\ProgramData\ASRSetupLogs<br>&lt;Mobility service agent InstallDir&gt;\agent <strong>(※1)</strong> </p></blockquote><p><strong>(※1)</strong> 全量いただけることが望ましいですが、全量が困難な場合は下記をご提供ください。   </p><blockquote><p>&lt;Mobility service agent InstallDir&gt;\agent\<br> - AzureRcmCli.log<br> - evtcollforw.log<br> - s2*.log<br> - svagent*.log<br> - vacp.log<br> - Application Data\ApplicationPolicyLogs<br> - vxlogs  </p></blockquote><p><u>&lt; ソース マシン (Linux) &gt;</u></p><blockquote><p>/tmp/MobilityAgentAutoUpgrade/logs/ua_upgrader.log<br>/var/log/ <strong>(※1)</strong></p></blockquote><p><strong>(※1)</strong> 全量いただけることが望ましいですが、全量が困難な場合は下記をご提供ください。  </p><blockquote><p>/var/log/<br> - ApplicationPolicyLogs/vacp.log<br> - appservice*.log<br> - AzureRcmCli.log<br> - cdpcli.log<br> - evtcollforw.log<br> - InMage*.log<br> - InstallerError.json<br> - involflt*.log<br> - s2*.log<br> - svagent*.log<br> - tagTelemetry_*.log<br> - ua_install.log<br> - uarespawnd.log<br> - Waagent.log<br> - azure<br> - vxlogs<br> - ApplicationData<br> - ASRsetuptelemetry  </p></blockquote><h3 id="2-4-Hyper-V-to-Azure-シナリオの障害調査に必要なログ"><a href="#2-4-Hyper-V-to-Azure-シナリオの障害調査に必要なログ" class="headerlink" title=" 2-4. Hyper-V to Azure シナリオの障害調査に必要なログ"></a><a id="2-4"></a> 2-4. Hyper-V to Azure シナリオの障害調査に必要なログ</h3><p>本シナリオではログを収集する方法は手動収集のみとなります。</p><p><u>&lt; Hyper-V ホスト マシン &gt;</u>  </p><blockquote><p>C:\ProgramData\ASRLogs<br>C:\WindowsAzure\Logs<br>C:\Windows\System32\winevt\logs<br>C:\Program Files\Microsoft Azure Recovery Services Agent\Temp </p></blockquote><p><u>&lt; Hyper-V ゲスト マシン &gt;</u><br>収集が必要なログはございません。</p><h2 id="3-ログ収集ツールの使用方法"><a href="#3-ログ収集ツールの使用方法" class="headerlink" title=" 3. ログ収集ツールの使用方法"></a><a id="3"></a> 3. ログ収集ツールの使用方法</h2><h3 id="3-1-ASRDiagnosticTool-の使用方法"><a href="#3-1-ASRDiagnosticTool-の使用方法" class="headerlink" title=" 3-1. ASRDiagnosticTool の使用方法"></a><a id="3-1"></a> 3-1. ASRDiagnosticTool の使用方法</h3><p>ログ収集対象マシンが <strong>Windows マシン</strong> である場合、本ツールを利用して下記シナリオのログを収集できます。</p><ul><li>Azure to Azure</li><li>VMware to Azure</li><li>物理マシン to Azure</li></ul><p>ASRDiagnosticTool  を利用する前に、下記の各要件を満たしていることを確認してください。</p><ul><li>ツールを実行するマシンに .NET Framework 4.6.2 以上がインストールされていること<br>（参考）方法: インストールされている .NET Framework バージョンを確認する<br><a href="https://learn.microsoft.com/ja-jp/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed#net-framework-45-and-later-versions">https://learn.microsoft.com/ja-jp/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed#net-framework-45-and-later-versions</a></li><li>C:\ ドライブにログを収集するための空き容量があること</li></ul><p>下記の手順に沿って、<br><span style="color: red; ">「構成サーバーとして機能するマシン (クラシック)」 または 「ASR レプリケーション アプライアンス として機能するマシン (モダン化)」 と</span><br><span style="color: red; ">「ソース マシン (保護対象マシン)」 の 2 つから、</span><br>それぞれにて本ツールを実行してログをご収集ください。</p><h4 id="ステップ-1"><a href="#ステップ-1" class="headerlink" title="ステップ 1 :"></a>ステップ 1 :</h4><p>対象の VM にサインインします。</p><h4 id="ステップ-2"><a href="#ステップ-2" class="headerlink" title="ステップ 2 :"></a>ステップ 2 :</h4><p>構成サーバー (クラシック) または ASR レプリケーション アプライアンス (モダン化) とソース マシンの下記ディレクトリに、 ASRDiagnosticTool  が配置されているか確認します。</p><ul><li>構成サーバー (クラシック) : <code>&lt;Cache InstallDir&gt;\agent\ASRDiagnosticTool</code></li><li>ASR レプリケーション アプライアンス  (モダン化)  : <code>&lt;Cache InstallDir&gt;\ProgramData\Microsoft Azure\Tools\ASRDiagnosticTool</code></li><li>ソース マシン : <code>C:\Program Files (x86)\Microsoft Azure Site Recovery\agent\ASRDiagnosticTool</code></li></ul><p>配置されていない場合は下記の手順に従って配置します。  </p><ol><li><a href="https://aka.ms/ASRDiagnosticTool">https://aka.ms/ASRDiagnosticTool</a> から ASRDiagnosticTool.zip ファイルをダウンロードします。</li><li>zip ファイルを解凍し、ログを取得したいマシン上に配置します。</li></ol><h4 id="ステップ-3"><a href="#ステップ-3" class="headerlink" title="ステップ 3 :"></a>ステップ 3 :</h4><p>(ソース マシン (保護対象マシン) 上でツールを実行する場合はスキップください)   </p><p>構成サーバー (クラシック) または ASR レプリケーション アプライアンス (モダン化) のキャッシュ ドライブのインストール先が E ドライブ以外の場合は、下記の設定変更を行います。  </p><ol><li><code>&lt;ASRDiagnosticToolのインストール先&gt;\ASRDiagnosticTool\Config</code> に移動し、ApplianceLogs.json ファイルを開きます。</li><li><code>E:\</code> となっているすべての文字列を検索し、構成サーバーのキャッシュ ドライブのインストール先に変更します。<br> 例えば、<code>M:\</code> ドライブにインストールしている場合は、<code>E:\\MarsAgent\\logs</code> を <code>M:\\MarsAgent\\logs</code> に変更します。</li></ol><h4 id="ステップ-4"><a href="#ステップ-4" class="headerlink" title="ステップ 4 :"></a>ステップ 4 :</h4><p>下記手順に従って ASRDiagnosticTool を実行します。</p><ol><li>管理者モードでコマンド プロンプトを開きます。</li><li>次のコマンドで ASRDiagnosticTool  の配置先に移動します。<br> ※ <code>&lt;ASRDiagnosticToolのインストール先&gt;</code> はインストール先のディレクトリに書き換えてください。　   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd &quot;&lt;ASRDiagnosticToolのインストール先&gt;\ASRDiagnosticTool&quot;</span><br></pre></td></tr></table></figure></li><li>次のコマンドで ASRDiagnosticTool  を実行します。 (完了まで5 ~ 30 分 かかります。また、かかる時間は実行している環境によって異なります) <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ASRDiagnosticTool.exe</span><br></pre></td></tr></table></figure></li></ol><p>(実行例)<br><img src="/blog/AzureSiteRecovery/RequestForInvestigating_ASR/RequestForInvestigating_ASR_02.png"></p><h4 id="ステップ-5"><a href="#ステップ-5" class="headerlink" title="ステップ 5 :"></a>ステップ 5 :</h4><p>コマンド プロンプトに下記のようなメッセージが表示されていれば、ログの収集成功となります。<br><code>Please collect the archive at</code> に圧縮されたログが生成されますので、本ログをご提供いただけますと幸いです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Log collection completed successfully.</span><br><span class="line">Please collect the archive at C:\Users\Administrator\AppData\Roaming\ASRDiagnosticLogs-WIN-C381N1BJK2T-25-07-15-14-57.zip.</span><br></pre></td></tr></table></figure><h4 id="ツール利用時の影響について"><a href="#ツール利用時の影響について" class="headerlink" title="ツール利用時の影響について"></a>ツール利用時の影響について</h4><p>当ツールは、単純なログ収集ツールとなっております。これまで「高負荷となった」、「サーバーのリブート」や「特定のサービスが再起動する」といった事例の報告はございません。  </p><p>実際に CPU/メモリがどれくらい消費されるか・ログファイル量は、お客様の環境に依存しますので明確な指標をお出しすることは難しくございますが、弊社検証環境 (Azure 仮想マシン (Standard D8as v5 (8 vcpu 数、32 GiB メモリ))) で当該スクリプトを実行した場合、<span style="color: green; "><strong>ツール実行～終了までのおよそ 3 分 20 秒間</strong></span>では下記結果となり、「非常に大きな負荷がかかった」等の数値は確認しておりません。<br>しかしながら、こちらの結果はあくまでも弊社環境での検証となりますため、必要に応じてお客様ご自身の環境にて検証いただきますようお願い申し上げます。</p><details><summary>ツール利用時のパフォーマンス検証結果</summary><p>下記表は <code>パフォーマンス モニター</code> を使ったパフォーマンスの検証結果となります。</p><table><thead><tr><th align="left">-</th><th align="left">CPU</th><th align="left">-</th><th align="left">-</th><th align="left">-</th><th align="left">Disk</th><th align="left">-</th><th align="left">-</th><th align="left">-</th><th align="left">Memory</th><th align="left">-</th><th align="left">-</th><th align="left">-</th></tr></thead><tbody><tr><td align="left">Time</td><td align="left"><strong>Processor Time</strong></td><td align="left"><strong>User Time</strong></td><td align="left"><strong>Privileged Time</strong></td><td align="left"><strong>Interrupt Time</strong></td><td align="left"><strong>Disk Time</strong></td><td align="left"><strong>Current Disk Queue Length</strong></td><td align="left"><strong>Avg. Disk sec/Write</strong></td><td align="left"><strong>Avg. Disk sec/Read</strong></td><td align="left"><strong>Available MBytes</strong></td><td align="left"><strong>Pages/sec</strong></td><td align="left"><strong>Committed Bytes In Use</strong></td><td align="left"><strong>Committed Bytes</strong></td></tr><tr><td align="left">08/05/2024 19:56:22</td><td align="left"></td><td align="left"></td><td align="left"></td><td align="left"></td><td align="left"></td><td align="left">0</td><td align="left"></td><td align="left"></td><td align="left">29303</td><td align="left"></td><td align="left">8.95</td><td align="left">3533012992</td></tr><tr><td align="left">08/05/2024 19:56:52</td><td align="left">0.05</td><td align="left">0.03</td><td align="left">0.03</td><td align="left">0.00</td><td align="left">0.14</td><td align="left">0</td><td align="left">0.00</td><td align="left">0.01</td><td align="left">29303</td><td align="left">2.80</td><td align="left">8.94</td><td align="left">3528171520</td></tr><tr><td align="left">08/05/2024 19:57:22</td><td align="left">3.95</td><td align="left">2.41</td><td align="left">1.51</td><td align="left">0.01</td><td align="left">0.14</td><td align="left">0</td><td align="left">0.00</td><td align="left">0.01</td><td align="left">29312</td><td align="left">0.73</td><td align="left">8.97</td><td align="left">3538006016</td></tr><tr><td align="left">08/05/2024 19:57:52</td><td align="left">0.60</td><td align="left">0.27</td><td align="left">0.30</td><td align="left">0.01</td><td align="left">0.19</td><td align="left">0</td><td align="left">0.00</td><td align="left">0.01</td><td align="left">29236</td><td align="left">1.20</td><td align="left">9.23</td><td align="left">3641659392</td></tr><tr><td align="left">08/05/2024 19:58:22</td><td align="left">0.13</td><td align="left">0.08</td><td align="left">0.04</td><td align="left">0.00</td><td align="left">0.10</td><td align="left">0</td><td align="left">0.00</td><td align="left">0.00</td><td align="left">29241</td><td align="left">0.13</td><td align="left">9.22</td><td align="left">3636760576</td></tr><tr><td align="left">08/05/2024 19:58:52</td><td align="left">0.90</td><td align="left">0.30</td><td align="left">0.57</td><td align="left">0.00</td><td align="left">32.52</td><td align="left">1</td><td align="left">0.00</td><td align="left">0.01</td><td align="left">28870</td><td align="left">0.13</td><td align="left">10.13</td><td align="left">3995738112</td></tr><tr><td align="left">08/05/2024 19:59:22</td><td align="left">0.96</td><td align="left">0.38</td><td align="left">0.59</td><td align="left">0.03</td><td align="left">33.07</td><td align="left">1</td><td align="left">0.00</td><td align="left">0.01</td><td align="left">28541</td><td align="left">0.13</td><td align="left">10.98</td><td align="left">4331937792</td></tr><tr><td align="left">08/05/2024 19:59:52</td><td align="left">4.94</td><td align="left">3.35</td><td align="left">1.55</td><td align="left">0.00</td><td align="left">29.31</td><td align="left">1</td><td align="left">0.00</td><td align="left">0.01</td><td align="left">29189</td><td align="left">350.56</td><td align="left">9.23</td><td align="left">3644022784</td></tr><tr><td align="left">08/05/2024 20:00:22</td><td align="left">28.85</td><td align="left">24.40</td><td align="left">4.45</td><td align="left">0.04</td><td align="left">39.55</td><td align="left">10</td><td align="left">0.05</td><td align="left">0.00</td><td align="left">29083</td><td align="left">34.47</td><td align="left">9.20</td><td align="left">3631489024</td></tr><tr><td align="left">08/05/2024 20:00:52</td><td align="left">2.01</td><td align="left">1.24</td><td align="left">0.74</td><td align="left">0.00</td><td align="left">55.49</td><td align="left">0</td><td align="left">0.02</td><td align="left">0.00</td><td align="left">29232</td><td align="left">38.91</td><td align="left">8.99</td><td align="left">3547832320</td></tr><tr><td align="left">08/05/2024 20:01:22</td><td align="left">0.04</td><td align="left">0.05</td><td align="left">0.04</td><td align="left">0.00</td><td align="left">0.07</td><td align="left">0</td><td align="left">0.00</td><td align="left">0.00</td><td align="left">29236</td><td align="left">0.13</td><td align="left">8.98</td><td align="left">3544920064</td></tr><tr><td align="left">08/05/2024 20:01:52</td><td align="left">0.12</td><td align="left">0.04</td><td align="left">0.01</td><td align="left">0.00</td><td align="left">0.09</td><td align="left">0</td><td align="left">0.00</td><td align="left">0.00</td><td align="left">29236</td><td align="left">0.13</td><td align="left">8.98</td><td align="left">3542532096</td></tr></tbody></table></details><h3 id="3-2-collect-support-materials-の使用方法"><a href="#3-2-collect-support-materials-の使用方法" class="headerlink" title=" 3-2. collect_support_materials の使用方法"></a><a id="3-2"></a> 3-2. collect_support_materials の使用方法</h3><p>ログ収集対象マシンが <strong>Linux マシン</strong> である場合、本ツールを利用して下記シナリオのログを収集できます。</p><ul><li>Azure to Azure</li><li>VMware to Azure</li><li>物理マシン to Azure</li></ul><p>下記の手順にそって本ツールを実行して、ログを収集してください。</p><h4 id="ステップ-1-1"><a href="#ステップ-1-1" class="headerlink" title="ステップ 1 :"></a>ステップ 1 :</h4><p>対象の VM にサインインします。</p><h4 id="ステップ-2-1"><a href="#ステップ-2-1" class="headerlink" title="ステップ 2 :"></a>ステップ 2 :</h4><p>スクリプト <code>/usr/local/ASR/Vx/bin/collect_support_materials.sh</code> を管理者権限で実行します</p><h4 id="ステップ-3-1"><a href="#ステップ-3-1" class="headerlink" title="ステップ 3 :"></a>ステップ 3 :</h4><p>以下のように出力されますので、<code>support store location</code> の <code>free space</code> が十分であることをご確認いただき、<code>Y</code> または <code>y</code> を入力してください。  </p><p>(出力例)<br><img src="/blog/AzureSiteRecovery/RequestForInvestigating_ASR/RequestForInvestigating_ASR_03.png"></p><h4 id="ステップ-4-1"><a href="#ステップ-4-1" class="headerlink" title="ステップ 4 :"></a>ステップ 4 :</h4><p>上記 <code>support store location</code> に圧縮されたログが生成されますので、本ログをご提供いただけますと幸いです。</p><h4 id="ツール利用時の影響について-1"><a href="#ツール利用時の影響について-1" class="headerlink" title="ツール利用時の影響について"></a>ツール利用時の影響について</h4><p>当ツールは、単純なログ収集ツールとなっております。これまで「高負荷となった」、「サーバーのリブート」や「特定のサービスが再起動する」といった事例の報告はございません。<br>出力されるログファイルの量は環境毎、およびシナリオ毎で異なりますが、弊社検証環境での動作確認ではログ ファイルのサイズは 700 KB 程度でございました。</p><p>実際に CPU/メモリがどれくらい消費されるかは、お客様の環境に依存しますので明確な指標をお出しすることは難しくございますが、弊社検証環境 (Azure 仮想マシン (Standard D8as v5 (8 vcpu 数、32 GiB メモリ))) で当該スクリプトを実行した場合、<span style="color: green; "><strong>スクリプト実行～終了までのおよそ 20 秒間</strong></span>では下記結果となり、「非常に大きな負荷がかかった」 等の数値は確認しておりません。<br>しかしながら、こちらの結果はあくまでも弊社環境での検証となりますため、必要に応じてお客様ご自身の環境にて検証いただきますようお願い申し上げます。</p><details><summary>ツール利用時のパフォーマンス検証結果</summary><p>下記表は <code>vmstat</code> コマンドを使ったパフォーマンスの検証結果となります。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmstat 5 | awk &#x27;&#123; print strftime(&quot;%Y/%m/%d %H:%M:%S&quot;), $0 &#125;&#x27;</span><br></pre></td></tr></table></figure><table><thead><tr><th align="left">-</th><th align="left">procs</th><th align="left">-</th><th align="left">memory</th><th align="left">-</th><th align="left">-</th><th align="left">-</th><th align="left">swap</th><th align="left">-</th><th align="left">io</th><th align="left">-</th><th align="left">system</th><th align="left">-</th><th align="left">cpu</th><th align="left">-</th><th align="left">-</th><th align="left">-</th><th align="left">-</th></tr></thead><tbody><tr><td align="left"><strong>Time</strong></td><td align="left"><strong>r</strong></td><td align="left"><strong>b</strong></td><td align="left"><strong>swpd</strong></td><td align="left"><strong>free</strong></td><td align="left"><strong>buff</strong></td><td align="left"><strong>cache</strong></td><td align="left"><strong>si</strong></td><td align="left"><strong>so</strong></td><td align="left"><strong>bi</strong></td><td align="left"><strong>bo</strong></td><td align="left"><strong>in</strong></td><td align="left"><strong>cs</strong></td><td align="left"><strong>us</strong></td><td align="left"><strong>sy</strong></td><td align="left"><strong>id</strong></td><td align="left"><strong>wa</strong></td><td align="left"><strong>st</strong></td></tr><tr><td align="left">2024/6/3 8:38:04</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">459724</td><td align="left">4184</td><td align="left">15316156</td><td align="left">0</td><td align="left">0</td><td align="left">2544</td><td align="left">1481</td><td align="left">308</td><td align="left">811</td><td align="left">5</td><td align="left">1</td><td align="left">72</td><td align="left">22</td><td align="left">0</td></tr><tr><td align="left">2024/6/3 8:38:09</td><td align="left">0</td><td align="left">2</td><td align="left">0</td><td align="left">524152</td><td align="left">4184</td><td align="left">15248072</td><td align="left">0</td><td align="left">0</td><td align="left">21636</td><td align="left">5809</td><td align="left">2451</td><td align="left">6335</td><td align="left">2</td><td align="left">1</td><td align="left">79</td><td align="left">19</td><td align="left">0</td></tr><tr><td align="left">2024/6/3 8:38:14</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">511444</td><td align="left">4184</td><td align="left">15260096</td><td align="left">0</td><td align="left">0</td><td align="left">18309</td><td align="left">67</td><td align="left">2960</td><td align="left">7064</td><td align="left">1</td><td align="left">1</td><td align="left">89</td><td align="left">9</td><td align="left">0</td></tr><tr><td align="left">2024/6/3 8:38:19</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">495660</td><td align="left">4184</td><td align="left">15271268</td><td align="left">0</td><td align="left">0</td><td align="left">17027</td><td align="left">328</td><td align="left">2542</td><td align="left">6767</td><td align="left">2</td><td align="left">1</td><td align="left">89</td><td align="left">9</td><td align="left">0</td></tr><tr><td align="left">2024/6/3 8:38:24</td><td align="left">1</td><td align="left">1</td><td align="left">0</td><td align="left">448740</td><td align="left">4184</td><td align="left">15311520</td><td align="left">0</td><td align="left">0</td><td align="left">29925</td><td align="left">115</td><td align="left">6789</td><td align="left">13947</td><td align="left">7</td><td align="left">2</td><td align="left">79</td><td align="left">12</td><td align="left">0</td></tr><tr><td align="left"><span style="color: green; ">2024/6/3 8:38:29</td><td align="left">5</td><td align="left">3</td><td align="left">0</td><td align="left">374476</td><td align="left">4184</td><td align="left">15384444</td><td align="left">0</td><td align="left">0</td><td align="left">36440</td><td align="left">73</td><td align="left">9115</td><td align="left">18576</td><td align="left">12</td><td align="left">2</td><td align="left">76</td><td align="left">9</td><td align="left">0</td></tr><tr><td align="left"><span style="color: green; ">2024/6/3 8:38:34</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">413664</td><td align="left">4184</td><td align="left">15346216</td><td align="left">0</td><td align="left">0</td><td align="left">29338</td><td align="left">588</td><td align="left">3365</td><td align="left">6832</td><td align="left">1</td><td align="left">1</td><td align="left">88</td><td align="left">10</td><td align="left">0</td></tr><tr><td align="left"><span style="color: green; ">2024/6/3 8:38:39</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">394872</td><td align="left">4184</td><td align="left">15364684</td><td align="left">0</td><td align="left">0</td><td align="left">25054</td><td align="left">3479</td><td align="left">3219</td><td align="left">6826</td><td align="left">2</td><td align="left">1</td><td align="left">78</td><td align="left">19</td><td align="left">0</td></tr><tr><td align="left"><span style="color: green; ">2024/6/3 8:38:44</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">376320</td><td align="left">4184</td><td align="left">15383056</td><td align="left">0</td><td align="left">0</td><td align="left">43755</td><td align="left">75</td><td align="left">4825</td><td align="left">7378</td><td align="left">2</td><td align="left">1</td><td align="left">88</td><td align="left">9</td><td align="left">0</td></tr><tr><td align="left"><span style="color: green; ">2024/6/3 8:38:49</td><td align="left">0</td><td align="left">2</td><td align="left">0</td><td align="left">331164</td><td align="left">4184</td><td align="left">15416172</td><td align="left">0</td><td align="left">0</td><td align="left">43115</td><td align="left">332</td><td align="left">4878</td><td align="left">7463</td><td align="left">3</td><td align="left">1</td><td align="left">82</td><td align="left">13</td><td align="left">0</td></tr></tbody></table></details>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Site Recovery サポートです。&lt;br&gt;Azure Site Recovery (以下、ASR ) に関する調査をスムーズに進める為に、お客様側で確認して頂く箇所と、調査に必要な環境情報と</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure Site Recovery" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Site-Recovery/"/>
    
  </entry>
  
  <entry>
    <title>Azure Backup におけるウイルス除外設定について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/AV_ExcludeSetting/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/AV_ExcludeSetting/</id>
    <published>2024-06-19T03:00:00.000Z</published>
    <updated>2025-01-06T06:27:18.615Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートの山本です。<br>今回はお問い合わせをいただくことが多い、 <strong>Azure Backup を利用する際のウイルス検知の除外設定</strong>  について、Azure VM Backup と MARS バックアップの場合それぞれについてご説明させていただきます。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Azure VM Backup の場合のウイルス検知除外設定</a><br> <a href="#1-1">1-1. Windows OS の場合</a><br> <a href="#1-2">1-2. Linux OS の場合</a><br><a href="#2">2. MARS バックアップの場合のウイルス検知除外設定</a></p><hr><h2 id="1-Azure-VM-Backup-の場合のウイルス検知除外設定"><a href="#1-Azure-VM-Backup-の場合のウイルス検知除外設定" class="headerlink" title="1. Azure VM Backup の場合のウイルス検知除外設定"></a>1. Azure VM Backup の場合のウイルス検知除外設定<a id="1"></a></h2><p>Azure VM Backup とは Azure 上の VM に対するバックアップサービスです。<br>・Azure VM バックアップの概要<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction</a></p><p>Windows OS と Linux OS に場合分けしてお伝えします。</p><h3 id="1-1-Windows-OS-の場合"><a href="#1-1-Windows-OS-の場合" class="headerlink" title="1-1. Windows OS の場合"></a>1-1. Windows OS の場合<a id="1-1"></a></h3><p>Windows OS の場合、下記をアンチウイルス ソフトの除外設定にいれてください。</p><blockquote><p>C:\Packages\Plugins\Microsoft.Azure.RecoveryServices.VMSnapshot<br>C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.RecoveryServices.VMSnapshot</p></blockquote><p>なお、上記は下記の公式ドキュメントにも記載されております。<br>・Azure Backup の失敗のトラブルシューティング:エージェント/拡張機能に関する問題 - 手順 4:Azure Backup VM 拡張機能の正常性を確認する<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout#step-4-check-azure-backup-extension-health">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout#step-4-check-azure-backup-extension-health</a></p><p>・VMRestorePointInternalError - VM で構成されているウイルス対策により、バックアップ拡張機能の実行が制限されています<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#vmrestorepointinternalerror---antivirus-configured-in-the-vm-is-restricting-the-execution-of-backup-extension">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#vmrestorepointinternalerror---antivirus-configured-in-the-vm-is-restricting-the-execution-of-backup-extension</a></p><h3 id="1-2-Linux-OS-の場合"><a href="#1-2-Linux-OS-の場合" class="headerlink" title="1-2. Linux OS の場合"></a>1-2. Linux OS の場合<a id="1-2"></a></h3><p>Linux OS の場合、下記をアンチウイルス ソフトの除外設定にいれてください。</p><blockquote><p>/var/lib/waagent/WALinuxAgent<br>/var/lib/waagent/Microsoft.Azure.RecoveryServices.VMSnapshotLinux</p></blockquote><h3 id="2-MARS-バックアップの場合のウイルス検知除外設定"><a href="#2-MARS-バックアップの場合のウイルス検知除外設定" class="headerlink" title="2 .MARS バックアップの場合のウイルス検知除外設定"></a>2 .MARS バックアップの場合のウイルス検知除外設定<a id="2"></a></h3><p>MARS バックアップ (Azure MARS Backup エージェントを利用したバックアップ) とはクラウドかオンプレミス環境かを問わず、Windows OS において、ファイルとフォルダー単位のバックアップやシステム状態のバックアップを 取得し Azure 上に保存するバックアップサービスです。</p><p>・Microsoft Azure Recovery Services (MARS) エージェントを使用したバックアップのサポート マトリックス<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mars-agent">https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mars-agent</a></p><p>MARS バックアップをお使いの場合、MARS のインストール フォルダ配下をアンチウイルス ソフトのスキャン除外設定にいれてください。<br>デフォルトでは以下のパスに MARS はインストールが行われます。</p><blockquote><p>C:\Program Files\Microsoft Azure Recovery Services Agent</p></blockquote><p>もし MARS のインストール時に以下のように “インストール フォルダ” とは異なるフォルダに “キャッシュの場所” を指定していた場合は、指定した “キャッシュの場所” のフォルダもスキャン除外対象に別途ご指定ください。<br><img src="/blog/AzureVMBackup/AV_ExcludeSetting/AV_ExcludeSetting_01.png" alt="MARS インストール画面"></p><p>また、上記に加えて MARS のインストール フォルダ配下の以下プロセスもスキャン除外の対象としてご設定ください。</p><blockquote><p>[Install Path]\bin\cbengine.exe</p></blockquote><p>参考までに弊社検証環境にて Windows Defender で除外設定を行った場合のサンプル イメージを以下に記載いたします。<br>※ 指定しているフォルダ パスは前述の MARS インストール画面での設定例をベースにしております。<br><img src="/blog/AzureVMBackup/AV_ExcludeSetting/AV_ExcludeSetting_02.png" alt="除外設定例"><br>あくまで参考イメージでございますので、実際に指定する除外パスや指定方法については、お客様のご要件あるいはアンチウイルス ソフトの仕様に依存いたしますことにご留意ください。</p><p>なお、上記 MARS のウイルス スキャン除外設定は下記の公式ドキュメントにも記載されております。<br>・Azure Backup でファイルとフォルダーのバックアップが遅い場合のトラブルシューティング - 原因: Azure Backup の妨げになっている別のプロセスまたはウイルス対策ソフトウェア<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-troubleshoot-slow-backup-performance-issue#cause-another-process-or-antivirus-software-interfering-with-azure-backup">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-troubleshoot-slow-backup-performance-issue#cause-another-process-or-antivirus-software-interfering-with-azure-backup</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートの山本です。&lt;br&gt;今回はお問い合わせをいただくことが多い、 &lt;strong&gt;Azure Backup を利用する際のウイルス検知の除外設定&lt;/strong&gt;  について、Az</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup における CRR (クロスリージョン リストア) について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/CRR/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/CRR/</id>
    <published>2024-06-17T03:00:00.000Z</published>
    <updated>2025-01-06T06:27:18.619Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Backup サポートです。<br>今回は、Azure Backup での リージョンをまたがる復元（ = Cross-Region Restore / CRR）にて頻繁にいただくお問い合わせに関して、下記ご案内いたします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. CRR 機能を有効した場合の、冗長性オプションは「GRS」になるのか、「RA-GRS」になるのか？</a><br><a href="#1-1">1-1. Azure Portal での CRR 有効時の確認方法</a><br><a href="#1-2">1-2. GRS と RA-GRS(CRR有効化) の違い</a><br><a href="#1-3">1-3. セカンダリ リージョンへのリストア手順</a><br><a href="#2">2. セカンダリ リージョンへ復元ポイントがレプリケートされるまでに、最大何時間かかるのか？</a><br><a href="#3">3. セカンダリ リージョンへ復元ポイントがいつレプリケート完了したか、Azure ポータル画面上でどのように確認すればよいのか？</a><br><a href="#3-1">3-1. 補足：バックアップ ジョブについて</a><br><a href="#4">4. 災害復旧後のレプリケーションについて</a></p><hr><h2 id="1-CRR-機能を有効した場合の、冗長性オプションは「GRS」になるのか、「RA-GRS」になるのか？"><a href="#1-CRR-機能を有効した場合の、冗長性オプションは「GRS」になるのか、「RA-GRS」になるのか？" class="headerlink" title=" 1. CRR 機能を有効した場合の、冗長性オプションは「GRS」になるのか、「RA-GRS」になるのか？"></a><a id="1"></a> 1. CRR 機能を有効した場合の、冗長性オプションは「GRS」になるのか、「RA-GRS」になるのか？</h2><p>結論から申し上げますと、RA-GRS となります。<br><img src="/blog/AzureVMBackup/CRR/CRR_01.png" alt="CRR_01"></p><p>・Azure Backup 用語集 - Azure Backup | Microsoft Docs<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/azure-backup-glossary#grs">https://docs.microsoft.com/ja-jp/azure/backup/azure-backup-glossary#grs</a></p><h3 id="1-1-Azure-Portal-での-CRR-有効時の確認方法"><a href="#1-1-Azure-Portal-での-CRR-有効時の確認方法" class="headerlink" title=" 1-1. Azure Portal での CRR 有効時の確認方法"></a><a id="1-1"></a> 1-1. Azure Portal での CRR 有効時の確認方法</h3><p>ご参考までに、CRR 機能を有効にした場合の Azure ポータル画面上の見え方を説明いたします。<br>下図の Recovery Services コンテナーは「ストレージ レプリケーションの種類：geo 冗長」かつ「クロス リージョン 復元：有効」となっております。<br>これによって CRR 機能が有効 (=RA-GRS) となります。<br><img src="/blog/AzureVMBackup/CRR/CRR_02.png"></p><p>CRR 機能が有効になっている場合、「バックアップ アイテム」画面上では「プライマリ リージョン」のほかに「セカンダリ リージョン」も選択できるよう、活性化されます。<br><img src="/blog/AzureVMBackup/CRR/CRR_03.png"></p><p><img src="/blog/AzureVMBackup/CRR/CRR_04.png"></p><p> 一方でRecovery Services コンテナー上で「リージョンをまたがる復元：無効にする」を選択されている場合は、下図のように「プライマリ リージョン」がデフォルトで選択されており、かつ非活性表示となっているため「セカンダリ リージョン」への切り替えが不可能となっております。<br> <img src="/blog/AzureVMBackup/CRR/CRR_05.png" alt="CRR_05"></p><div class="alert is-warning"><p class="alert-title">警告</p><p>CRR 機能が有効にされてから上記「セカンダリ リージョン」の項目が活性化されるまで<strong>最大で 48 時間</strong>かかりますのでご注意ください。</p><hr><p>・ Recovery Services コンテナーを作成して構成する - Azure Backup | Microsoft Learn  : リージョンをまたがる復元の設定</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault#set-cross-region-restore">https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault#set-cross-region-restore</a></p></div><h3 id="1-2-GRS-と-RA-GRS-CRR有効化時-の違い"><a href="#1-2-GRS-と-RA-GRS-CRR有効化時-の違い" class="headerlink" title=" 1-2. GRS と RA-GRS (CRR有効化時) の違い"></a><a id="1-2"></a> 1-2. GRS と RA-GRS (CRR有効化時) の違い</h3><p> Recovery Services コンテナーの冗長性が GRS であっても、RA-GRS (CRR有効化時) であってもセカンダリ リージョンにバックアップデータはレプリケーションされ保持されます。<br> 違いは<strong>任意のタイミングでセカンダリ リージョンへ復元できるか</strong>どうかです。</p><p>・geo 冗長ストレージ (GRS) コンテナーで、リージョンをまたがる復元 (CRR) 機能が有効になっている場合とそうでない場合では、どのような違いがありますか。<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-backup-faq#geo----------grs-----------------------crr----------------------------------------">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-backup-faq#geo----------grs-----------------------crr----------------------------------------</a><br>　“CRR 機能が有効になっていない GRS コンテナーの場合、<span style="color: red">Azure によってプライマリ リージョンでの障害が宣言されるまで、セカンダリ リージョンのデータにはアクセスできません。</span> このような場合、セカンダリ リージョンから復元が行われます。<br>　　CRR が有効になっている場合、プライマリ リージョンが稼働している場合でも、セカンダリ リージョンでの復元をトリガーできます。”</p><p>またコストは RA-GRS (CRR有効化) にすることでストレージ単価が高くなりますのでその点ご留意ください。詳細に関しては下記をご覧ください。<br>・Azure Backup の価格 - バックアップ ストレージ の項目をご覧ください。<br><a href="https://azure.microsoft.com/ja-jp/pricing/details/backup/">https://azure.microsoft.com/ja-jp/pricing/details/backup/</a></p><h3 id="1-3-セカンダリ-リージョンへのリストア手順"><a href="#1-3-セカンダリ-リージョンへのリストア手順" class="headerlink" title=" 1-3. セカンダリ リージョンへのリストア手順"></a><a id="1-3"></a> 1-3. セカンダリ リージョンへのリストア手順</h3><p>下記公開情報をご覧ください。<br>・セカンダリ リージョンに復元する - Azure portal で Azure VM データを復元する方法<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region</a></p><h2 id="2-セカンダリ-リージョンへ復元ポイントがレプリケートされるまでに、最大何時間かかるのか？"><a href="#2-セカンダリ-リージョンへ復元ポイントがレプリケートされるまでに、最大何時間かかるのか？" class="headerlink" title=" 2. セカンダリ リージョンへ復元ポイントがレプリケートされるまでに、最大何時間かかるのか？"></a><a id="2"></a> 2. セカンダリ リージョンへ復元ポイントがレプリケートされるまでに、最大何時間かかるのか？</h2><p>セカンダリ リージョンへのデータのレプリケーションは、プライマリリージョンへのバックアップジョブが完了 (最大24時間) してから 12 時間以内にレプリケーションが完了するように動作します。<br>そのため、プライマリリージョンのバックアップジョブ完了とセカンダリ リージョンへのレプリケーションにはラグが生じます。</p><p>・Azure portal を使用して VM を復元する - Azure Backup | Microsoft Docs<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region</a></p><blockquote><p>現在、セカンダリ リージョンの RPO は “36 時間” です。 これは、プライマリ リージョンの RPO が “24 時間” であり、プライマリからセカンダリ リージョンへのバックアップ データのレプリケーションに最大 “12 時間” かかることがあるためです。</p></blockquote><h2 id="3-セカンダリ-リージョンへ復元ポイントがいつレプリケート完了したか、Azure-ポータル画面上でどのように確認すればよいのか？"><a href="#3-セカンダリ-リージョンへ復元ポイントがいつレプリケート完了したか、Azure-ポータル画面上でどのように確認すればよいのか？" class="headerlink" title=" 3. セカンダリ リージョンへ復元ポイントがいつレプリケート完了したか、Azure ポータル画面上でどのように確認すればよいのか？"></a><a id="3"></a> 3. セカンダリ リージョンへ復元ポイントがいつレプリケート完了したか、Azure ポータル画面上でどのように確認すればよいのか？</h2><p>Recovery Services コンテナー ＞ バックアップ アイテム ＞ セカンダリ リージョン ＞ Azure Virtual Machine ＞ 対象の仮想マシンを選択し、「復元ポイント」欄に、対象の復元ポイントが表示されていれば、セカンダリ リージョンへのレプリケートは完了していると判断できます。</p><p>作業例）プライマリ リージョンに配置されている仮想マシン「SAPHANA03」を「今すぐバックアップ」を実施し、取得された復元ポイントがセカンダリ リージョンに複製されているかを確認する<br><img src="/blog/AzureVMBackup/CRR/CRR_06.png" alt="CRR_08"></p><p>下図画面の黄色罫線部分が、「今すぐバックアップ」にてトリガーし、バックアップが完了したバックアップ ジョブです。<br><em><strong>2021/12/9 17:50 に「今すぐバックアップ」のバックアップ ジョブがトリガーされ、18:21 ごろにバックアップが完了しております。</strong></em><br><img src="/blog/AzureVMBackup/CRR/CRR_07.png" alt="CRR_09"></p><p>バックアップ アイテム ＞ プライマリ リージョン ＞ Azure Virtual Machine 画面上の「最新の復元ポイント」に表示されている時刻は、バックアップが実行開始された時刻となります。<br><img src="/blog/AzureVMBackup/CRR/CRR_08.png" alt="CRR_10"></p><p>「プライマリ リージョン」側のバックアップ項目画面では、「復元ポイント」欄に、取得済の復元ポイントが表示されています。<br><img src="/blog/AzureVMBackup/CRR/CRR_09.png" alt="CRR_11"></p><p>一方で、バックアップ アイテム ＞ セカンダリ リージョン ＞ Azure Virtual Machine ＞ 対象の仮想マシンをクリックします。<br>バックアップ項目画面では、<em><strong>「復元ポイント」欄に、12/09 18:32 時点では、12/09 にプライマリ リージョン側にて取得済の復元ポイントはまだ表示されておらず、セカンダリ リージョン側に復元ポイントが複製されていないことが分かります。</strong></em><br>（2021/12/09 24時ごろも確認しましたが、復元ポイントは表示されておりませんでした）<br><img src="/blog/AzureVMBackup/CRR/CRR_10.png" alt="CRR_12"></p><p>同じく、「セカンダリ リージョンへの復元」をクリックし、「復元ポイントの選択」欄を表示しても、<em><strong>12/09 17:50 に開始・取得済の復元ポイントは表示されていないことが確認できます。</strong></em><br><img src="/blog/AzureVMBackup/CRR/CRR_11.png" alt="CRR_13"></p><p>2021/12/09 17:50 Auzre VM Backup 開始後、 <em><strong>12 時間以上経過した 2021/12/10 8:09 時点では、「復元ポイントの選択」欄にて、セカンダリ リージョンのデータとして 17:50 のバックアップ開始分が表示されていることが確認できました。</strong></em></p><p><img src="/blog/AzureVMBackup/CRR/CRR_12.png" alt="CRR_14"></p><h3 id="補足：セカンダリ-リージョンのジョブについて"><a href="#補足：セカンダリ-リージョンのジョブについて" class="headerlink" title=" 補足：セカンダリ リージョンのジョブについて"></a><a id="3-1"></a> 補足：セカンダリ リージョンのジョブについて</h3><p>Recovery Services コンテナー ＞ バックアップ ジョブ ＞「セカンダリ リージョンのジョブを表示する」をクリックすると、セカンダリ リージョンのリストア ジョブを確認可能です。<br>しかし、プライマリ リージョンに配置されている仮想マシンのバックアップ ジョブは、 セカンダリ リージョンのバックアップ ジョブ上には表示されません。<br><img src="/blog/AzureVMBackup/CRR/CRR_13.png" alt="CRR_15"></p><p><img src="/blog/AzureVMBackup/CRR/CRR_14.png" alt="CRR_16"></p><h2 id="災害復旧後のレプリケーションに関するFAQ"><a href="#災害復旧後のレプリケーションに関するFAQ" class="headerlink" title=" 災害復旧後のレプリケーションに関するFAQ"></a><a id="4"></a> 災害復旧後のレプリケーションに関するFAQ</h2><blockquote><p>Q. プライマリリージョンが復旧したあとに プライマリリージョンに VM を復旧できるか</p><blockquote><p>A. こちらは可能ですが、Azure VM Backup の機能で実現するにはクロスリージョン リストアを実施いただく必要がございます。<br>具体的には一度セカンダリリージョンに VM をリストア いただき、復元した VM をセカンダリリージョンの Recovery Services コンテナーで保護しプライマリリージョンにクロスリージョン リストアを行う必要がございます。<br>これはセカンダリリージョンにあるバックアップデータからはセカンダリリージョンにしか、プライマリリージョンにあるバックアップデータからはプライマリリージョンにしかリストアができないためです。<br>Azure VM Backup の クロスリージョン リストア以外の方法ではセカンダリリージョンに VM をリストアした後に Azure Site Recovery などを用いた方法が考えられます。<br>・Azure VM を別の Azure リージョンに移動する<br><a href="https://docs.microsoft.com/ja-jp/azure/site-recovery/azure-to-azure-move-overview">https://docs.microsoft.com/ja-jp/azure/site-recovery/azure-to-azure-move-overview</a></p></blockquote></blockquote><blockquote><p>Q. バックアップデータのレプリケーションは再開されるか</p><blockquote><p>A. プライマリリージョンからセカンダリリージョンへのバックアップデータレプリケーションは災害復旧次第再開されます。<br>一方プライマリリージョンのデータが失われていたとしてもセカンダリリージョンからプライマリリージョンへのバックアップデータのレプリケーションは行われません。</p></blockquote></blockquote><p>CRR に関する説明は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、Azure Backup での リージョンをまたがる復元（ = Cross-Region Restore / CRR）にて頻繁にいただくお問い合わせに関して、</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
</feed>
