<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan CSS ABRS  Support Blog !!</title>
  
  <subtitle>Azure Backup , Azure Site Recovery , Azure Migrate に関するサポート情報を発信します。</subtitle>
  <link href="https://jpabrs-scem.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpabrs-scem.github.io/blog/"/>
  <updated>2022-06-22T06:34:34.902Z</updated>
  <id>https://jpabrs-scem.github.io/blog/</id>
  
  <author>
    <name>Japan CSS ABRS &amp; SCEM Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>DPMとMABSを使用しvCenter Serverに接続する時に、「VMWare Serverと通信できない」Error 33623 が発生した場合の対処方法</title>
    <link href="https://jpabrs-scem.github.io/blog/DPM&amp;MABS/VMware_Error_332623/"/>
    <id>https://jpabrs-scem.github.io/blog/DPM&amp;MABS/VMware_Error_332623/</id>
    <published>2022-03-31T03:00:00.000Z</published>
    <updated>2022-06-22T06:34:34.902Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Microsoft Azure Backup ＆ Recovery Services サポートです。</p><p>最近 DPM (Data Protection Manager)、MABS (Microsoft Azure Backup Server) を使用し、オンプレミス環境や AVS(Azure VMware Solution) 環境にある VMWare 仮想マシンをアックアップする需要が多くなっています。<br>DPM と MABS を VMWare vCenter Server に初期接続する時に、下記のような「VMWare Server と通信できない」エラーが発生した問い合わせがあります。</p><p>また下記幣ブログの記事では Take Snapshot フェーズを失敗させる方法をご案内しております。<br>・Azure VM Backup を意図的に失敗させる方法<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/">https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/</a></p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. 【事象 Error ID 33623】</a><br><a href="#2">2. 【対処方法】</a></p><hr><h2 id="1-【事象】"><a href="#1-【事象】" class="headerlink" title="1. 【事象】"></a>1. 【事象】<a id="1"></a></h2><blockquote><p>Error ID 33623<br>Internal error code 0x80990EF2 </p></blockquote><p>*** ＜DPMコンソールのエラー画面サンプル＞ ***<br><img src="https://user-images.githubusercontent.com/71251920/161022695-3e7da576-4708-442b-800a-45d94a32f307.png"></p><p>上記エラーを解消するためのサポートチケットを起票する前に、まず下記 2 つの設定を確認することを推奨します。</p><h2 id="2-【対処方法】"><a href="#2-【対処方法】" class="headerlink" title="2. 【対処方法】"></a>2. 【対処方法】<a id="2"></a></h2><ol><li>vCenter Server 6.7 以降の場合、DPM、MABS サーバーにで TLS 1.2 を有効にします。</li></ol><p>TLS 1.2を有効化する方法について下記ドキュメントをご参照ください。<br> MABS向けのドキュメント：<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-backup-server-vmware#vmware-vsphere-67-and-70">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-backup-server-vmware#vmware-vsphere-67-and-70</a></p><p>DPM向けのドキュメント：<br><a href="https://docs.microsoft.com/ja-jp/system-center/dpm/back-up-vmware?view=sc-dpm-2019#vmware-vsphere-67">https://docs.microsoft.com/ja-jp/system-center/dpm/back-up-vmware?view=sc-dpm-2019#vmware-vsphere-67</a></p><h3 id="実施ステップのサンプル"><a href="#実施ステップのサンプル" class="headerlink" title="実施ステップのサンプル"></a>実施ステップのサンプル</h3><p>①以下のテキストをコピーして、.txt ファイルに貼り付けます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Windows Registry Editor Version 5.00</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\.NETFramework\v2.0.50727]</span><br><span class="line">&quot;SystemDefaultTlsVersions&quot;=dword:00000001</span><br><span class="line">&quot;SchUseStrongCrypto&quot;=dword:00000001</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\WOW6432Node\Microsoft\.NETFramework\v4.0.30319]</span><br><span class="line">&quot;SystemDefaultTlsVersions&quot;=dword:00000001</span><br><span class="line">&quot;SchUseStrongCrypto&quot;=dword:00000001</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v2.0.50727]</span><br><span class="line">&quot;SystemDefaultTlsVersions&quot;=dword:00000001</span><br><span class="line">&quot;SchUseStrongCrypto&quot;=dword:00000001</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v4.0.30319]</span><br><span class="line">&quot;SystemDefaultTlsVersions&quot;=dword:00000001</span><br><span class="line">&quot;SchUseStrongCrypto&quot;=dword:00000001</span><br></pre></td></tr></table></figure><p>②そのファイルを EnableTLS12.reg という名前で DPM、MABSサーバーに保存します。</p><p>③ファイルをダブルクリックして、レジストリ エントリをアクティブ化します。</p><ol start="2"><li>下記ドキュメントを参照し、HTTPS 証明書の検証を無効化にして、事象改善されるかを確認します。<br>MABS向けのドキュメント：<br>「HTTPS 証明書の検証の無効化」セッションを参照します。<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-backup-server-vmware#create-a-secure-connection-to-the-vcenter-server">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-backup-server-vmware#create-a-secure-connection-to-the-vcenter-server</a></li></ol><p>DPM向けのドキュメント：<br>「セキュリティで保護された通信プロトコルを無効にする」セッションを参照します。<br><a href="https://docs.microsoft.com/ja-jp/system-center/dpm/back-up-vmware?view=sc-dpm-2019#configure-dpm-to-protect-vmware">https://docs.microsoft.com/ja-jp/system-center/dpm/back-up-vmware?view=sc-dpm-2019#configure-dpm-to-protect-vmware</a></p><h3 id="実施ステップのサンプル-1"><a href="#実施ステップのサンプル-1" class="headerlink" title="実施ステップのサンプル"></a>実施ステップのサンプル</h3><p>①以下のテキストをコピーして、.txt ファイルに貼り付けます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Windows Registry Editor Version 5.00</span><br><span class="line"></span><br><span class="line">[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft Data Protection Manager\VMWare]</span><br><span class="line">&quot;IgnoreCertificateValidation&quot;=dword:00000001</span><br></pre></td></tr></table></figure><p>②そのファイルを DisableSecureAuthentication.reg という名前で DPM、MABS サーバーに保存します。</p><p>③ファイルをダブルクリックして、レジストリ エントリをアクティブ化します。</p><p>もし上記アクションを実施後でも事象改善しない場合、問い合わせを起票していただければと存じます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Microsoft Azure Backup ＆ Recovery Services サポートです。&lt;/p&gt;
&lt;p&gt;最近 DPM (Data Protection Manager)、MABS (Microsof</summary>
      
    
    
    
    
    <category term="TROUBLE SHOOTING" scheme="https://jpabrs-scem.github.io/blog/tags/TROUBLE-SHOOTING/"/>
    
    <category term="DPM / MABS" scheme="https://jpabrs-scem.github.io/blog/tags/DPM-MABS/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup のデータ転送フェーズを意図的に失敗させる方法</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_ttv/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_ttv/</id>
    <published>2022-03-10T03:00:00.000Z</published>
    <updated>2022-06-22T06:34:34.850Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートの 荘司 です。<br>今回は、<strong>Azure VM Backup における転送フェーズを意図的に失敗させる方法</strong>について、ご案内いたします。<br>*転送フェーズとは Transfer data to vault フェーズを指します。<br>詳細については幣ブログの関連のページをご覧ください<br>・Transfer data to vault フェーズ - Azure VM Backup の通信要件や処理の流れについて<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#2-2">https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#2-2</a></p><p>また下記幣ブログの記事では Take Snapshot フェーズを失敗させる方法をご案内しております。<br>・Azure VM Backup を意図的に失敗させる方法<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/">https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/</a></p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Transfer data to vault を失敗させる方法概略</a><br><a href="#2">2. Transfer data to vault を失敗させる方法の注意点</a><br><a href="#3">3. Transfer data to vault を失敗させる手順</a></p><hr><h2 id="1-Transfer-data-to-vault-を失敗させる方法概略"><a href="#1-Transfer-data-to-vault-を失敗させる方法概略" class="headerlink" title="1. Transfer data to vault を失敗させる方法概略"></a>1. Transfer data to vault を失敗させる方法概略<a id="1"></a></h2><p>Azure VM Backup を実行し、Take Snapshot 完了後に該当の Azure VM のリストアポイントコレクション (ローカルスナップショットのメタデータ) を削除します。<br>そうすることで Transfer data to vault が失敗し、バックアップストレージ(標準コンテナー/ Recovery Services コンテナー)への転送が失敗します。</p><h2 id="2-Transfer-data-to-vault-を失敗させる方法の注意点"><a href="#2-Transfer-data-to-vault-を失敗させる方法の注意点" class="headerlink" title="2. Transfer data to vault を失敗させる方法の注意点"></a>2. Transfer data to vault を失敗させる方法の注意点<a id="2"></a></h2><ol><li>この方法ではリストアポイントコレクションを削除するため、リストアポイントコレクションを削除する前に取得された復元ポイントおよび該当のバックアップ ジョブで作成された復元ポイントではインスタントリストアが出来なくなります。<br>つまり、回復の種類が “スナップショット” のものは下記のように <em><strong>“UserErrorInstantRpNotFound” と復元するためのリソースがない旨のエラーメッセージがでて復元ができなくなります</strong></em>。<br>“スナップショットと標準コンテナー” のものは バックアップストレージ からの復元が可能です。<br><img src="https://user-images.githubusercontent.com/71251920/157503085-0d5ff930-b877-444f-83ab-7637015cbfeb.png"></li><li>この方法を実施したあと下記のようなエラーが発生しますが、再度バックアップを実行することにより解消されます。<br><img src="https://user-images.githubusercontent.com/71251920/157502733-09a19fbb-23f5-430a-a334-55591de41b52.png"></li></ol><p>その場合、復元した際に <strong>“UserErrorInstantRpNotFound”</strong> となっていた復元ポイントは <strong>無効/Invalid</strong> と表示されます。<br><img src="https://user-images.githubusercontent.com/71251920/157502744-47f216d0-2f8a-4fa4-a72c-79f78a80a546.png"></p><h2 id="3-Transfer-data-to-vault-を失敗させる手順"><a href="#3-Transfer-data-to-vault-を失敗させる手順" class="headerlink" title="3. Transfer data to vault を失敗させる手順"></a>3. Transfer data to vault を失敗させる手順<a id="3"></a></h2><ol><li><p>失敗させたい VM にて今すぐバックアップを実行します。</p></li><li><p>バックアップ ジョブより該当のジョブの詳細を開き、サブタスクが以下の状態となっていることを確認します。(この状態になるのに通常 5 ~ 10 分程度かかります)<br>　・Take Snapshot：Completed<br>　・Transfer data to vault：In progress<br><img src="https://user-images.githubusercontent.com/71251920/157502743-dd6c88d7-a959-47e1-b3cd-8cded953ceb0.png"></p></li><li><p>ポータルのホーム画面にて “Restore Point Celloctions” と検索し、サービス欄に出てきた Restore Point Celloctions をクリックします。<br><img src="https://user-images.githubusercontent.com/71251920/157502742-73239758-d52f-4230-96ba-005cb7e411f6.png"></p></li><li><p>検索欄に該当の VM 名を入力し、出てきた RestorePoint Collection をクリックします。<br>　RestorePoint Collection は “AzureBackup_&lt;VM 名&gt;_xxxxxxxxxxxxx” といった命名規則にて存在しております。<br><img src="https://user-images.githubusercontent.com/71251920/157502740-150a8c21-19e4-4bdd-89ea-28e1f9db93fd.png"></p></li><li><p>Delete をクリックし、出現したメッセージの OK をクリックして RestorePoint Collection を削除します。<br><img src="https://user-images.githubusercontent.com/71251920/157502739-4d1655cc-2ee2-4eb2-ba22-d8cb9d73d4af.png"></p></li><li><p>バックアップ ジョブが完了するのを待ちます。(状況によって数十分から数時間要する場合があります)</p></li><li><p>時間が経過すると、以下のように Transfer data to vault プロセスが失敗したことを確認できます。<br><img src="https://user-images.githubusercontent.com/71251920/157502737-ba0b8cda-001e-421e-a6d7-e3648c2c38fa.png"></p></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートの 荘司 です。&lt;br&gt;今回は、&lt;strong&gt;Azure VM Backup における転送フェーズを意図的に失敗させる方法&lt;/strong&gt;について、ご案内いたします。&lt;br</summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>ABRS チームについて ~リモートワークでの働きかた~</title>
    <link href="https://jpabrs-scem.github.io/blog/information/team-introduction_2/"/>
    <id>https://jpabrs-scem.github.io/blog/information/team-introduction_2/</id>
    <published>2022-03-04T03:00:00.000Z</published>
    <updated>2022-06-22T06:34:34.962Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは！ABRS チームの山本です。<br>今日は、私たちのチームがどのように働いているのか、少しでも皆さんにイメージしていただき、興味をもっていただけるよう、普段の働き方や仕事環境について紹介いたします。<br>現在は全メンバーがリモートワークをしており、首都圏以外にも北海道や大阪在住、またUS在住のメンバーまで在籍しております。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. よくある仕事の流れ</a><br><a href="#2">2. とある日の一日</a><br><a href="#3">3. デスク ツアー！</a><br><a href="#4">4. リモート ワークの魅力</a><br><a href="#5">5. 関連記事</a></p><hr><h3 id="1-よくある仕事の流れ"><a href="#1-よくある仕事の流れ" class="headerlink" title="1. よくある仕事の流れ"></a>1. よくある仕事の流れ<a id="1"></a></h3><p>Microsoft のサポート エンジニアはお客様から起票いただいたサポート リクエストを通してお客様の抱える問題を解決するための技術支援を行います。<br>案件の受付からクローズまで基本的には担当するメンバーがオーナーシップを持って対応します。<br>基本的な案件対応の流れとしては、案件の受付 → 調査方針の決定 → 発生している問題の調査 → 回答、事象の解消を確認 → クローズ(対応終了) です。<br>案件の受付から、概ね 14 日程度でクローズとなります。<br>各エンジニアは 10 ~ 20 件ほどの案件を担当として受け持ち、また同時並行で案件対応を進めていきます。また他にも公開ドキュメントの修正やこうしたブログの執筆も行っております。</p><p>このように記載すると 1 つの案件を最初から最後まで自分ひとりで対応しなければいけないように感じるかもしれません。<br>しかし、実際には同じチームのメンバーや、その他の Azure サポート チームのメンバーと非常に密に連携しながら仕事を進めています。<br>クラウド サービスでは、新しい機能の追加や機能の改修が日常的に行われており、もはや一人のスーパー エンジニアが何でも知っている、という時代ではなくなっています。<br>言い換えれば、新しい機能や未知の問題に直面したとき、あなたがその問題の第一人者です。<br>また、事例の無いお問い合わせを担当するとワクワクするようになります。</p><p>このような状況から、各案件でオーナーシップをとる担当者がいるものの、実際には色々なメンバーと支援をし合いながら調査を行っています。</p><h3 id="2-とある日の一日"><a href="#2-とある日の一日" class="headerlink" title="2. とある日の一日 "></a>2. とある日の一日 <a id="2"></a></h3><p>9:00 - サポート窓口が開きます。<br>業務を開始！まずはメール チェックし、今日一日のタスクの洗い出し。</p><hr><p>9:30 - チームの朝会に参加します！<br>チーム全体への共有事項の展開や、サポート案件対応で困ったポイントを相談します。</p><hr><p>10:00 - 新規案件対応。<br>その日に新しくお問い合わせいただいた案件について、お客様へ電話をして対応方針をお客様と相談します。</p><hr><p>12:00 - お昼休憩！<br>家族と一緒にお昼ご飯を食べます！</p><hr><p>13:00 - ミーティングに参加します！<br>チーム ミーティングや他のサポート チームとのミーティングに参加し、打ち合わせを行います。</p><hr><p>13:30 - 案件調査を行います。<br>気合を入れて、時間のかかる調査 (ログの解析、再現テスト) を行います。</p><hr><p>15:00 - Coffee Break ミーティングに参加。<br>Coffee Break ミーティングでは、業務に関連のない雑談もしてリフレッシュ！<br>コミュニケーションを取るきっかけになり案件対応の相談もしやすくなっているように感じます！</p><hr><p>15:30 - 調査を再開します！<br>サポート窓口が閉まる 17:30 までにお客様へ調査結果を報告できるようラスト スパート！</p><hr><p>16:30 - 夕会<br>一日の進捗を共有したり各メンバの状況をシェア・相談します。</p><hr><p>17:30 - サポート窓口が閉まります。<br>気が済むまで、翌日報告予定の案件の調査や、他メンバーの案件の内容を勉強します。</p><hr><h3 id="3-デスク-ツアー！"><a href="#3-デスク-ツアー！" class="headerlink" title="3. デスク ツアー！"></a>3. デスク ツアー！<a id="3"></a></h3><p>実際のメンバーのデスクですので、こちらからメンバーがどのような環境で働いているのか参考になれば嬉しいです！</p><h5 id="本記事内唯一の縦置きディスプレイ配置！USキーボード！"><a href="#本記事内唯一の縦置きディスプレイ配置！USキーボード！" class="headerlink" title="本記事内唯一の縦置きディスプレイ配置！USキーボード！"></a>本記事内唯一の縦置きディスプレイ配置！USキーボード！</h5><p><img src="https://user-images.githubusercontent.com/71251920/156648350-f0e85a1e-fe54-4866-8268-8914bc880362.png"></p><h5 id="女優ライトでミーティングもバッチリ！リアルフォースキーボード！メインPCは自作の光る-Desk-mini"><a href="#女優ライトでミーティングもバッチリ！リアルフォースキーボード！メインPCは自作の光る-Desk-mini" class="headerlink" title="女優ライトでミーティングもバッチリ！リアルフォースキーボード！メインPCは自作の光る Desk mini !"></a>女優ライトでミーティングもバッチリ！リアルフォースキーボード！メインPCは自作の光る Desk mini !</h5><p><img src="https://user-images.githubusercontent.com/71251920/156648359-3bdc08e5-c0f5-4b50-ae94-7e0aef791006.jpg"></p><h5 id="トラックボールマウス！！"><a href="#トラックボールマウス！！" class="headerlink" title="トラックボールマウス！！"></a>トラックボールマウス！！</h5><p><img src="https://user-images.githubusercontent.com/71251920/156648360-81024452-0551-4987-abb0-944fba099dcc.jpg"></p><h5 id="モニターの上のぬいぐるみは家族にミーティング中かどうかをお知らせする機能あり！！"><a href="#モニターの上のぬいぐるみは家族にミーティング中かどうかをお知らせする機能あり！！" class="headerlink" title="モニターの上のぬいぐるみは家族にミーティング中かどうかをお知らせする機能あり！！"></a>モニターの上のぬいぐるみは家族にミーティング中かどうかをお知らせする機能あり！！</h5><p><img src="https://user-images.githubusercontent.com/71251920/156648362-65cc4352-b2bb-4108-a815-6ac80eeb1e13.jpg"></p><h5 id="ワーキングママ！！"><a href="#ワーキングママ！！" class="headerlink" title="ワーキングママ！！"></a>ワーキングママ！！</h5><p><img src="https://user-images.githubusercontent.com/71251920/156648364-0b6794a8-4dc9-49d6-b774-dddcc5e6cba2.png"></p><h5 id="シンプル-is-ベスト"><a href="#シンプル-is-ベスト" class="headerlink" title="シンプル is ベスト."></a>シンプル is ベスト.</h5><p><img src="https://user-images.githubusercontent.com/71251920/156648366-8a3639de-c478-4780-8db6-e7753b016415.jpg"></p><h5 id="キーボードは社割で買いました！カレンダーは星野道夫さんのです。はやくアラスカに行きたいです！"><a href="#キーボードは社割で買いました！カレンダーは星野道夫さんのです。はやくアラスカに行きたいです！" class="headerlink" title="キーボードは社割で買いました！カレンダーは星野道夫さんのです。はやくアラスカに行きたいです！"></a>キーボードは社割で買いました！カレンダーは星野道夫さんのです。はやくアラスカに行きたいです！</h5><p><img src="https://user-images.githubusercontent.com/71251920/156648368-15eb0558-c2f4-49cb-a887-61e18cc76088.jpg"></p><h5 id="保温機能がついた高性能マグカップ！！"><a href="#保温機能がついた高性能マグカップ！！" class="headerlink" title="保温機能がついた高性能マグカップ！！"></a>保温機能がついた高性能マグカップ！！</h5><p><img src="https://user-images.githubusercontent.com/71251920/156648370-3fbf5c3d-9022-49e5-a392-c061bb204052.jpg"></p><h5 id="ゲーミングな光が-So-Cool"><a href="#ゲーミングな光が-So-Cool" class="headerlink" title="ゲーミングな光が So Cool!"></a>ゲーミングな光が So Cool!</h5><p><img src="https://user-images.githubusercontent.com/71251920/156648371-3c45e268-97bd-49ef-a84e-60695546a15f.jpg"></p><h5 id="チーム唯一の新卒・新入社員！デスクもまだまださらなる進化の可能性を秘めています！！"><a href="#チーム唯一の新卒・新入社員！デスクもまだまださらなる進化の可能性を秘めています！！" class="headerlink" title="チーム唯一の新卒・新入社員！デスクもまだまださらなる進化の可能性を秘めています！！"></a>チーム唯一の新卒・新入社員！デスクもまだまださらなる進化の可能性を秘めています！！</h5><p><img src="https://user-images.githubusercontent.com/71251920/168879380-f0e93804-61b5-4f87-a02d-5d7e57ff17e4.png"></p><h5 id="タブレット端末も活用してトリプルモニタ環境。インフラエンジニア必携”パケットキャプチャの教科書”をデスク脇に備えています！"><a href="#タブレット端末も活用してトリプルモニタ環境。インフラエンジニア必携”パケットキャプチャの教科書”をデスク脇に備えています！" class="headerlink" title="タブレット端末も活用してトリプルモニタ環境。インフラエンジニア必携”パケットキャプチャの教科書”をデスク脇に備えています！"></a>タブレット端末も活用してトリプルモニタ環境。インフラエンジニア必携”パケットキャプチャの教科書”をデスク脇に備えています！</h5><p><img src="https://user-images.githubusercontent.com/71251920/168879386-3526cd8d-a403-402f-a8e6-b434c9207302.png"></p><h3 id="4-リモート-ワークの魅力"><a href="#4-リモート-ワークの魅力" class="headerlink" title="4. リモート ワークの魅力"></a>4. リモート ワークの魅力<a id="4"></a></h3><p>自分好みの環境を作ることが出来る。<br>睡眠時間が増えます。<br>自分の時間が取りやすい (通勤なし、すぐ家族に会える) のは非常に良い。<br>家族との時間が格段に増える。<br>出勤時間が 0 になるので、自由時間が増える。<br>自由なタイミングで休憩時間をとって、役所行ったり子供の面倒を見たり出来る。<br>通勤時間がなくなるので、その分を有意義に使えます。<br>子供のオムツをかえられる。<br>宅配の荷物が受け取れる。</p><h3 id="関連記事"><a href="#関連記事" class="headerlink" title="関連記事"></a>関連記事<a id="5"></a></h3><p>・ABRS &amp; SCEM チームについて<br><a href="https://jpabrs-scem.github.io/blog/information/team-introduction/">https://jpabrs-scem.github.io/blog/information/team-introduction/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは！ABRS チームの山本です。&lt;br&gt;今日は、私たちのチームがどのように働いているのか、少しでも皆さんにイメージしていただき、興味をもっていただけるよう、普段の働き方や仕事環境について紹介いたします。&lt;br&gt;現在は全</summary>
      
    
    
    
    
    <category term="Information" scheme="https://jpabrs-scem.github.io/blog/tags/Information/"/>
    
  </entry>
  
  <entry>
    <title>NVA のバックアップについて</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/NVA_backup/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/NVA_backup/</id>
    <published>2022-02-22T03:00:00.000Z</published>
    <updated>2022-06-22T06:34:34.850Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>みなさこんにちは、Azure Backup サポートです。<br>今回は、<strong>「Azure VM Backup にてネットワーク仮想アプライアンス (NVA) をバックアップ可能か？」</strong>というお問い合わせについて回答します。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. 仮想アプライアンスはバックアップできない可能性がある</a><br><a href="#2">2. VM エージェント の状態の確認</a><br><a href="#3">3. 代替案 - Azure Disk Backup を利用する</a></p><hr><h3 id="1-仮想アプライアンスはバックアップできない可能性が高い"><a href="#1-仮想アプライアンスはバックアップできない可能性が高い" class="headerlink" title="1. 仮想アプライアンスはバックアップできない可能性が高い"></a><a id="1"></a>1. 仮想アプライアンスはバックアップできない可能性が高い</h3><p>結論から申し上げますと、残念ながら NVA として機能する仮想マシンについては、Azure VM Backup サポート対象外の カスタム OS となる可能性が高いです。<br>*NVA 以外の仮想アプライアンス、カスタム OS などにおいても同様です。</p><p>Azure Marketplace より、NVA として機能する仮想マシンを作成した場合も同様に、Azure VM Backup サポート対象外の OS であることが多くございます。<br>Azure VM Backup では、オンライン バックアップを実施する際、VM エージェントの拡張機能を利用しますが、NVA に用いられる OS に対しては一般的に、VM エージェントが対応しておりません。</p><p>正確にご確認いただくには、後述のドキュメントを参照の上、<strong>まず VM エージェントが対応しているかをお客様ご自身、および OS 発行ベンダーにご確認いただく必要</strong> がございます。</p><p>事例ベースのご案内では、<strong>Zscaler 社の NVA や Palo Alto 社の NVA 、Fortinet 社の NVA (Fortianalyzer) が対応していない事例がございました。また同様に NVA 以外のカスタム OS に関しましても VM エージェントが対応していないために Azure VM Backup がご利用いただけない事例がございました。</strong></p><p>・Azure Linux VM エージェントの概要 - Azure Virtual Machines | Microsoft Docs<br>　<a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/agent-linux#requirements">https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/agent-linux#requirements</a></p><p>下記 に Azure VM Backup の OSサポート対象範囲について記載がございますので、ご参考ください。<br>・Azure VM バックアップのサポート マトリックス - オペレーティング システムのサポート (Windows)<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#operating-system-support-windows">https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#operating-system-support-windows</a><br>・Azure VM バックアップのサポート マトリックス - オペレーティング システムのサポート (Linux)<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#operating-system-support-linux">https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#operating-system-support-linux</a><br>・Azure で動作保証済みの Linux ディストリビューション<br>　<a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/endorsed-distros">https://docs.microsoft.com/ja-jp/azure/virtual-machines/linux/endorsed-distros</a></p><h3 id="2-VM-エージェント-の状態の確認"><a href="#2-VM-エージェント-の状態の確認" class="headerlink" title="2. VM エージェント の状態の確認"></a><a id="2"></a>2. VM エージェント の状態の確認</h3><p>Azure VM Backup をオンラインでご利用いただくには対象の VM を起動しエージェントの状態を確認いただき、Ready となっていることが大前提 (必要条件) となります。<br>お客様で確認するには下記 <strong>“エージェントの状態”</strong> をご確認ください。<br>サポート外の OS の場合、<strong>Ready</strong> ではなく <strong>Not Ready</strong> となる事例が多くございます。<br><img src="https://user-images.githubusercontent.com/71251920/154855287-696dca76-4bdc-4e8b-ac40-1108515edca8.png" alt="エージェントの状態 の確認"></p><p>また、サポート対象の OS で <strong>Not Ready</strong> となっていた場合にはエージェントが正しく動いていないと見受けられます。<br>その際には agent の再起動や 対象 VM の再起動を行っていただき、それでも事象が改善しない場合には Azure VM agent イシューとしてお問い合わせいただければと存じます。</p><p>NVA として機能する仮想マシンをバックアップする方法の代替案としては、以下が挙げられます。</p><h3 id="3-代替案-Azure-Disk-Backup-を利用する"><a href="#3-代替案-Azure-Disk-Backup-を利用する" class="headerlink" title=" 3. 代替案 - Azure Disk Backup を利用する"></a><a id="3"></a> 3. 代替案 - Azure Disk Backup を利用する</h3><p>Azure VM Backup にて仮想マシン全体をバックアップするのではなく、仮想マシンのディスクを Azure Disk Backup にてバックアップする方法がございます。<br>Azure Disk Backup にてディスクをバックアップする場合は、VM エージェントを利用いたしませんので、対象仮想マシンの ディスクをバックアップする手段として挙げられます。<br>・Azure ディスク バックアップの概要 - Azure Backup | Microsoft Docs<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/disk-backup-overview#key-benefits-of-disk-backup">https://docs.microsoft.com/ja-jp/azure/backup/disk-backup-overview#key-benefits-of-disk-backup</a></p><blockquote><p>抜粋 : Azure ディスク バックアップは、増分スナップショットを使用する、エージェントレスでクラッシュ整合性のあるソリューションで、次のような利点があります。</p></blockquote><p>どの種類のディスクが Azure Disk Backup のサポート対象であるかは、下記ドキュメントをご参考ください。<br>・Azure ディスク バックアップのサポート マトリックス - Azure Backup | Microsoft Docs<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/disk-backup-support-matrix">https://docs.microsoft.com/ja-jp/azure/backup/disk-backup-support-matrix</a></p><p>Azure Disk Backup はクラッシュ整合性となりますのでその点もご留意いただければと思います。詳細につきましては下記 URL の幣ブログ記事をご覧ください。<br>・Azure VM Backupにおける整合性について - クラッシュ整合性<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#3">https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#3</a></p><p>「Azure VM Backup にてネットワーク仮想アプライアンス (NVA) をバックアップ可能か？」に関する説明は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;みなさこんにちは、Azure Backup サポートです。&lt;br&gt;今回は、&lt;strong&gt;「Azure VM Backup にてネットワーク仮想アプライアンス (NVA) をバックアップ可能か？」&lt;/strong&gt;というお問い</summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>MARS バックアップ を意図的に失敗させる方法</title>
    <link href="https://jpabrs-scem.github.io/blog/MARSBackup/How_to_fail_MARS_backup/"/>
    <id>https://jpabrs-scem.github.io/blog/MARSBackup/How_to_fail_MARS_backup/</id>
    <published>2022-02-17T03:00:00.000Z</published>
    <updated>2022-06-22T06:34:34.902Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートの 山本 です。<br>アラートのテスト等のため “Azure MARS Backup エージェントを利用したバックアップ (以下MARSバックアップ) を失敗させたい” というお問い合わせをよくいただきます。<br>今回は、<strong>MARS バックアップ を意図的に失敗させる方法</strong>について、ご案内いたします。</p><p>なお、下記では Azure VM Backup を失敗させる方法について紹介しております。<br>・Azure VM Backup を意図的に失敗させる方法<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/">https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/</a></p><h3 id="意図的に-MARS-バックアップ-エラーを発生させる仕組み"><a href="#意図的に-MARS-バックアップ-エラーを発生させる仕組み" class="headerlink" title="意図的に MARS バックアップ エラーを発生させる仕組み"></a>意図的に MARS バックアップ エラーを発生させる仕組み</h3><p>バックアップ対象にフォルダを指定し、ポリシーを設定した後、対象のフォルダ名を変更します。そうすることでバックアップ対象のフォルダがない為にバックアップが失敗します。</p><h3 id="MARS-バックアップ-を失敗させる方法-手順"><a href="#MARS-バックアップ-を失敗させる方法-手順" class="headerlink" title="MARS バックアップ を失敗させる方法(手順)"></a>MARS バックアップ を失敗させる方法(手順)</h3><ul><li>以下は MARS エージェントがインストールされているリソース内での作業となります。</li></ul><h4 id="1-MARSエージェントのスケジュールバックアップ設定よりテスト用のフォルダをバックアップ対象として選択し、設定します。その他の設定は任意の設定で問題ございません。"><a href="#1-MARSエージェントのスケジュールバックアップ設定よりテスト用のフォルダをバックアップ対象として選択し、設定します。その他の設定は任意の設定で問題ございません。" class="headerlink" title="1. MARSエージェントのスケジュールバックアップ設定よりテスト用のフォルダをバックアップ対象として選択し、設定します。その他の設定は任意の設定で問題ございません。"></a>1. MARSエージェントのスケジュールバックアップ設定よりテスト用のフォルダをバックアップ対象として選択し、設定します。その他の設定は任意の設定で問題ございません。</h4><p>(画像ではデスクトップ上の test フォルダを対象として選択しています)<br> <img src="https://user-images.githubusercontent.com/71251920/154327014-9a8eb2b3-13e5-48f3-905c-031ae5e7126a.jpg"></p><h4 id="2-上記でバックアップ対象としたフォルダ名を変更します。"><a href="#2-上記でバックアップ対象としたフォルダ名を変更します。" class="headerlink" title="2. 上記でバックアップ対象としたフォルダ名を変更します。"></a>2. 上記でバックアップ対象としたフォルダ名を変更します。</h4><p>(画像ではtestフォルダをtest_changeフォルダと変更しました)<br> <img src="https://user-images.githubusercontent.com/71251920/154327016-1281d20b-feb2-4524-8ea5-fa50cecf8359.jpg"></p><h4 id="3-今すぐバックアップを実行します。"><a href="#3-今すぐバックアップを実行します。" class="headerlink" title="3. 今すぐバックアップを実行します。"></a>3. 今すぐバックアップを実行します。</h4><p>　バックアップ期間は任意の期間で問題ありません。<br> <img src="https://user-images.githubusercontent.com/71251920/154327019-106c84e8-9bc7-4df5-9aa3-854e399666ac.jpg"></p><h4 id="4-確認画面にて、1で設定した名前変更前のフォルダが指定されてることを確認し、バックアップを実施してください。"><a href="#4-確認画面にて、1で設定した名前変更前のフォルダが指定されてることを確認し、バックアップを実施してください。" class="headerlink" title="4. 確認画面にて、1で設定した名前変更前のフォルダが指定されてることを確認し、バックアップを実施してください。"></a>4. 確認画面にて、1で設定した名前変更前のフォルダが指定されてることを確認し、バックアップを実施してください。</h4><p> <img src="https://user-images.githubusercontent.com/71251920/154327020-f8d375b6-033a-45fb-a5f0-d6c4aafbfe01.jpg"></p><h4 id="5-バックアップの失敗のメッセージが現れることを確認してください。"><a href="#5-バックアップの失敗のメッセージが現れることを確認してください。" class="headerlink" title="5. バックアップの失敗のメッセージが現れることを確認してください。"></a>5. バックアップの失敗のメッセージが現れることを確認してください。</h4><p>下記画像では Status Details に　Job failed と表示されています。<br> <img src="https://user-images.githubusercontent.com/71251920/154327021-05c22aec-45ec-4adf-b615-04dc7424662d.jpg"></p><h3 id="アラート例"><a href="#アラート例" class="headerlink" title="アラート例"></a>アラート例</h3><p>下記のような Azure Backup の組み込みアラートを設定している場合アラートがメールで通知されます。<br><img src="https://user-images.githubusercontent.com/71251920/154327023-c5e4526e-9e9f-4c25-b2b3-faa4bb6f9705.jpg" alt="組み込みアラート"></p><p><img src="https://user-images.githubusercontent.com/71251920/154327010-0a5c3e60-a3f3-4919-860d-98a8ae1530d3.jpg" alt="アラート通知メール"></p><blockquote><p>&lt;原文&gt;Description: Backup failed as none of the items specified as part of the backup policy exist.</p><blockquote><p>&lt;抄訳&gt;説明：バックアップポリシーの一部として指定された項目が存在しないため、バックアップが失敗しました。</p></blockquote></blockquote><p>以上で MARS バックアップ を意図的に失敗させる方法に関しましてのご説明は終了となります。</p><p>ぜひお試しいただければと思います。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートの 山本 です。&lt;br&gt;アラートのテスト等のため “Azure MARS Backup エージェントを利用したバックアップ (以下MARSバックアップ) を失敗させたい” とい</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="MARS Backup" scheme="https://jpabrs-scem.github.io/blog/tags/MARS-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup の通信要件や処理の流れについて</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/</id>
    <published>2022-02-16T03:00:00.000Z</published>
    <updated>2022-06-22T06:34:34.850Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートの山本です。<br>今回は Azure VM Backup における通信要件や処理の流れに関して、具体的なお問い合わせ例を交えて公式ドキュメントを補足する形でご説明させていただきます。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Azure VM Backup の 通信要件について</a><br> <a href="#1-1">1-1.参考 URL</a><br><a href="#2">2. Azure VM Backup の処理の流れ</a><br> <a href="#2-1">2-1. Take Snapshot フェーズ</a><br> <a href="#2-2">2-2. Transfer data to vault フェーズ</a><br> <a href="#2-3">2-3. 参考 URL</a><br><a href="#3">3. よくいただくお問い合わせ</a></p><hr><h2 id="1-Azure-VM-Backup-の-通信要件について"><a href="#1-Azure-VM-Backup-の-通信要件について" class="headerlink" title="1. Azure VM Backup の 通信要件について"></a><a id="1"></a>1. Azure VM Backup の 通信要件について</h2><p>Azure VM Backup の通信要件は VM Agent が正常に動作するために必要な通信要件と同じでございます。<br>VM Agent の通信要件は下記の通り、Wire Server と呼ばれる各ノードごとにある 仮想パブリック IP 168.63.129.16 に対して通信ができることでございます。<br>つまり、<strong>Azure VM Backup の通信要件は 168.63.129.16 に対して通信ができること</strong>です。</p><p>・Azure Linux エージェントの理解と使用 - 必要条件 [Linux]<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/agent-linux#requirements">https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/agent-linux#requirements</a></p><blockquote><p>VM が IP アドレス168.63.129.16 にアクセスできることを確認します。</p></blockquote><p>・Azure 仮想マシン エージェントの概要 - 前提条件 [Windows]<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/agent-windows#prerequisites">https://docs.microsoft.com/ja-jp/azure/virtual-machines/extensions/agent-windows#prerequisites</a></p><blockquote><p>VM が IP アドレス168.63.129.16 にアクセスできることを確認します。</p></blockquote><p><strong>当該仮想パブリック IP 168.63.129.16 (Wire Server) は Azure VM Backupはじめ、DNS 機能など Azure 内の様々な用途で使用されているため、Azure 内部で優先的にルーティングされる様になっており NSG や Azure Firewall の影響は受けず、かつ、ロンゲストマッチにより、0/0 強制ルーティング (強制トンネリング) ではオンプレに引き込まれずに Azure 側にルーティングされるようになっています。ただし、VM 内部でのファイアーウォール ではブロックすることは可能です。</strong><br>下記公式ドキュメントが参考になるかと存じます。<br>・IP アドレス 168.63.129.16 とは<br> <a href="https://docs.microsoft.com/ja-jp/azure/virtual-network/what-is-ip-address-168-63-129-16">https://docs.microsoft.com/ja-jp/azure/virtual-network/what-is-ip-address-168-63-129-16</a></p><blockquote><p>VM エージェントでは、ポート 80/tcp と 32526/tcp を介した WireServer (168.63.129.16) とのアウトバウンド通信が必要です。 これらは、VM 上のローカル ファイアウォールでは開いている必要があります。 これらのポート上での 168.63.129.16 との通信は、構成されたネットワーク セキュリティ グループの対象ではありません。</p></blockquote><h4 id="1-1-参考-URL"><a href="#1-1-参考-URL" class="headerlink" title="1.1 参考 URL"></a>1.1 参考 URL<a id="1-1"></a></h4><p>合わせて下記の公式ドキュメントもご覧ください。<br>Azure VM Backup ではオンラインバックアップの場合、初回オンラインバックアップ時に VM agent の拡張機能がインストールされること、および VM agent が正常に動作することが必要であることが分かります。</p><p>・Azure VM バックアップの概要 - バックアップ プロセス<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-process">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-process</a></p><blockquote><p>最初のバックアップ時に、バックアップ拡張機能が VM にインストールされます (VM が実行されている場合)</p></blockquote><p>・Azure VM バックアップのサポート マトリックス - サポートされるシナリオ<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#supported-scenarios">https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#supported-scenarios</a></p><blockquote><p>Azure VM では、追加のエージェントは必要ありません。 Azure Backup によって、VM 上で実行している Azure VM エージェントに対して拡張機能がインストールされ、使用されます。</p></blockquote><p>・Azure VM バックアップのサポート マトリックス - オペレーティング システムのサポート (Windows)<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#operating-system-support-windows">https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#operating-system-support-windows</a></p><blockquote><p>Azure VM エージェント拡張機能を使用したバックアップ</p></blockquote><p>・Azure VM バックアップのサポート マトリックス - オペレーティング システムのサポート (Linux)<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#support-for-linux-backup">https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#support-for-linux-backup</a></p><blockquote><p><em><strong>VM 上で Linux 用の Azure VM エージェントが動作し</strong></em>かつ Python がサポートされていれば使用できます。</p></blockquote><p>・Azure Backup のアーキテクチャとコンポーネント - Azure Backup のしくみ<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-architecture#how-does-azure-backup-work">https://docs.microsoft.com/ja-jp/azure/backup/backup-architecture#how-does-azure-backup-work</a></p><blockquote><p>Azure VM をバックアップする:Azure VM を直接バックアップすることができます。 Azure Backup によって、VM 上で実行されている Azure VM エージェントに、バックアップ拡張機能がインストールされます。 この拡張機能は、VM 全体をバックアップします。</p></blockquote><h2 id="2-Azure-VM-Backup-の処理の流れ"><a href="#2-Azure-VM-Backup-の処理の流れ" class="headerlink" title="2. Azure VM Backup の処理の流れ"></a><a id="2"></a>2. Azure VM Backup の処理の流れ</h2><p>まず、下記の公式ドキュメントをご覧ください。<br>・Azure VM バックアップの概要 - バックアップ プロセス<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-process">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-process</a></p><p><strong>上記公式ドキュメントをご覧いただいた前提で記載させていただきます。</strong><br>オンライン (VM 起動中) の Azure VM Backup では VM agent の機能の拡張機能としてバックアップ拡張機能を利用します。<br>オフラインの場合は VM 内部と連携しないため、VM agent が対応していないような VM でもバックアップをクラッシュ整合性で取得することが可能です。<br>なお、オフライン状態 とは VM が <strong>“状態 : 停止済み (割り当て解除)”</strong> である状態を指します。</p><p>ご参考にまでに下記も併せてご覧ください。<br>参考ブログ記事<br>・Azure VM Backup では オフライン バックアップができるのか<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Azure_VM_Offline_backup/">https://jpabrs-scem.github.io/blog/AzureVMBackup/Azure_VM_Offline_backup/</a><br>・クラッシュ整合性 - Azure VM Backupにおける整合性について<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#3">https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#3</a></p><p>Azure VM Backupでは バックアップ ジョブの画面で確認できるように、順番に Take Snapshot と Transfer data to vault の 2 つの大きなフェーズ  (Sub Task) がございます。これら 2 つのフェーズが完了して初めてバックアップ ジョブとして完了となります。<br><img src="https://user-images.githubusercontent.com/71251920/154117538-c4961564-fd9e-4e77-91ee-bff235da3704.png"></p><h3 id="2-1-Take-Snapshot-フェーズ"><a href="#2-1-Take-Snapshot-フェーズ" class="headerlink" title="2.1 Take Snapshot フェーズ"></a><a id="2-1"></a>2.1 Take Snapshot フェーズ</h3><p>まず、オンライン バックアップの場合、バックアップ拡張機能によって OS 内部と連携し静止点をとり、スナップショット データを取得します。その際のスナップショット データはユーザーからは見えない (マネージドな) ローカル物理ホスト上で取得します。<br>次に、オフライン バックアップの場合 は OS 内部と連携せずスナップショットを取得します。<br>Azure VM Backup において VM と連携する処理は Take Snapshot フェーズのみでございます。<br>そのため、Take Snapshot フェーズが完了すれば VM の再起動や運用によってはアップデートや DB の再開などを行っていただいてもかまいません。<br>Azure VM Backup はオンラインでもオフラインでもバックアップすることが可能ですが、<strong>Take Snapshot フェーズ</strong> に電源操作をされた場合には対象のバックアップが失敗する可能性がございます。<br>Take Snapshot フェーズが終わっていれば有事の際にはインスタントリストア機能を用いてリストアすることも可能です。<br>・Azure Backup のインスタント リストア機能を使用してバックアップと復元のパフォーマンスを改善する<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-instant-restore-capability">https://docs.microsoft.com/ja-jp/azure/backup/backup-instant-restore-capability</a></p><p>なお、前回のバックアップ ジョブが Take Snapshot フェーズの場合、後続のバックアップ ジョブは失敗する仕様となっております。</p><p>その他 以下参考になれば幸いです。<br>・Azure Backup は、アプリケーションのパフォーマンスに影響を与えますか?<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#azure-backup----------------------------">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#azure-backup----------------------------</a><br>抜粋 : “VM スナップショットの作成には数分かかります。この段階では、アプリケーションのパフォーマンスに対する影響はほとんどありません。”</p><p>・ VM スナップショットに関する問題のトラブルシューティング<br> <a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#troubleshoot-vm-snapshot-issues">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#troubleshoot-vm-snapshot-issues</a><br>抜粋 : “VM の CPU またはメモリが高くなっています。 仮想マシンのメモリまたは CPU の使用率が高くなり、90% を超えてると、スナップショット タスクがキューに格納されて遅延します。 最終的にはタイムアウトになります。”</p><h3 id="2-2-Transfer-data-to-vault-フェーズ"><a href="#2-2-Transfer-data-to-vault-フェーズ" class="headerlink" title="2.2 Transfer data to vault フェーズ"></a><a id="2-2"></a>2.2 Transfer data to vault フェーズ</h3><p>つぎに、ローカル物理ホスト上から Recovery Services コンテナー(バックアップデータ専用ストレージコンテナー) へ転送いたします。そのため<strong>バックアップデータは VM の 仮想 NIC を通って Recovery Services コンテナーへ転送されるのではなく、バックエンドで (ローカル物理ホスト上から物理的に離れた同一リージョン内にある) Recovery Services コンテナーへ転送されます。</strong></p><p>なお、前回のバックアップ ジョブが Transfer data to vault フェーズの場合、後続のバックアップ ジョブの Transfer data to vault フェーズは Skip される仕様となっており、リトライなどは実施されません。</p><h4 id="2-3-参考-URL"><a href="#2-3-参考-URL" class="headerlink" title="2.3 参考 URL"></a><a id="2-3"></a>2.3 参考 URL</h4><p>・Azure VM バックアップの概要 - バックアップ プロセス<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-process">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-process</a></p><p>・Azure VM Backup では オフライン バックアップができるのか<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Azure_VM_Offline_backup/">https://jpabrs-scem.github.io/blog/AzureVMBackup/Azure_VM_Offline_backup/</a></p><p>・クラッシュ整合性 - Azure VM Backupにおける整合性について<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#3">https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#3</a></p><p>・よく寄せられる質問 - Azure VM のバックアップ - スナップショットをストレージ アカウントからコンテナーに移動した場合、転送中の暗号化はどのように管理されますか?<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#-------------------------------------------------------">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#-------------------------------------------------------</a></p><blockquote><p>Azure VM バックアップでは、転送中の暗号化に HTTPS 通信を使用します。 <strong>データ転送では、VM のバックアップにインターネット アクセスを必要としない Azure ファブリック (パブリック エンドポイントではなく) を使用します</strong>。</p></blockquote><h2 id="3-よくいただくお問い合わせ"><a href="#3-よくいただくお問い合わせ" class="headerlink" title="3. よくいただくお問い合わせ"></a><a id="3"></a>3. よくいただくお問い合わせ</h2><p>これらに関連してよくいただくお問い合わせと回答を記載させていただきます。</p><blockquote><p>Q. 強制トンネリングを実施しているが、Azure VM Backup の通信を強制トンネリング対象から除外したいが、どのような設定をすればよいか。UDR を用いて可能か？</p><blockquote><p>A. Azure VM Backupに必要な通信は強制トンネリングや NSG の影響を受けないためローカル (OS内部) FW でブロックしていない限り通信要件は満たされます。<br>そのため強制トンネリング環境であっても特別な考慮は不要です。<br>また、UDR を用いて該当通信をルーティングすることはできません。<br>参考<br>・Azure VM Backup の 通信要件について - Azure VM Backup の 通信要件(本ページ)<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#1">https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#1</a></p></blockquote></blockquote><blockquote><p>Q. バックアップはまだ完了していないが、 Take Snapshot が終わっていれば VM の再起動などを行ってもよいか？またTake Snapshot が終わっていればリストアすることは可能か？</p><blockquote><p>A. Take Snapshot フェーズが完了していれば VM 内部と連携するフェーズは完了しているため、VM (OS内部) に対する変更、 VM の再起動などを行っていただいてもかまいません。<br>また Take Snapshot が完了していればインスタント リストア機能を用いてローカル物理ホスト上に保存されたスナップショットデータからリストアを行うことが可能です。<br>参考<br>・Take Snapshot フェーズ - Azure VM Backup の 通信要件(本ページ)<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#2-1">https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#2-1</a></p></blockquote></blockquote><blockquote><p>Q. Azure VM Backup のバックアップデータ転送トラフィックが VM に与える影響を懸念しているがベストプラクティスはあるか？</p><blockquote><p>A. Azure Backup のデータ転送は Azure のバックアップエンド側で行われ VM の 仮想 NIC を経由しないためバックアップデータ転送トラフィックが VM に与える影響はございません。<br>参考<br>・Transfer data to vaultフェーズ Azure VM Backup の 通信要件(本ページ)<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#2-2">https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#2-2</a></p></blockquote></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートの山本です。&lt;br&gt;今回は Azure VM Backup における通信要件や処理の流れに関して、具体的なお問い合わせ例を交えて公式ドキュメントを補足する形でご説明させていただ</summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>一部の System Center 2019 で SQL Server 2019 を使用する際の前提条件</title>
    <link href="https://jpabrs-scem.github.io/blog/SystemCenter/Prerequisites_SQL2019/"/>
    <id>https://jpabrs-scem.github.io/blog/SystemCenter/Prerequisites_SQL2019/</id>
    <published>2022-02-16T03:00:00.000Z</published>
    <updated>2022-06-22T06:34:34.914Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆さんこんにちは、System Center サポートチームの 保科と申します。</p><p>2022 年 2 月 16 日現在、System Center 2012 の延長サポートが終了間近であったり、System Center 2016 のメインストリームサポートが終了となります。<br>これに伴い、System Center 2019 へのアップグレードや新規環境構築を検討されているお客様も多くいらっしゃるかと思います。<br>System Center 2019 で使用するデータベースでは、SQL Server 2019 の使用がサポートされております。<br>本記事では、一部の System Center 2019 で SQL Server 2019 を使用する際の注意点について説明いたします。</p><h3 id="本記事が対象とする-System-Center-製品"><a href="#本記事が対象とする-System-Center-製品" class="headerlink" title="本記事が対象とする System Center 製品"></a>本記事が対象とする System Center 製品</h3><blockquote><p>・System Center Operations Manager (SCOM) 2019<br>・System Center Service Manager (SCSM) 2019</p></blockquote><h3 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h3><p>冒頭でもお伝えしました通り、System Center 2019 では SQL Server 2019 の利用がサポートされております。<br>一方で、本記事が対象としている System Center 製品においては、インストール直後の SQL Server 2019 にデータベースを構成するようにインストールを行うと、インストールに失敗する場合があります。<br>これは、<strong>対象の System Center 2019 製品では、SQL Server 2019 に加えて、SQL Server 2019 CU8 以上の適用が必要となるため</strong>です。<br>CU8 以上の適用はインストール時に表示される前提条件では確認できず、インストール開始まで進めることが可能です。<br>この際、CU8 以上が適用されていないため内部的にエラーが発生し、System Center 2019 のインストールが失敗します。<br>こちらは、各 System Center 2019 でサポートされる構成が掲載された弊社公開情報にも CU8 以上の適用が必須なことが明記されております。<br>・SCOM 2019 における SQL Server 2019 CU8 以上の適用が必要な旨記載された弊社公開情報:<br><a href="https://docs.microsoft.com/ja-jp/system-center/scom/plan-sqlserver-design?view=sc-om-2019">https://docs.microsoft.com/ja-jp/system-center/scom/plan-sqlserver-design?view=sc-om-2019</a><br>(“SQL Server の要件” 項を参照ください。)<br>・SCSM 2019 における SQL Server 2019 CU8 以上の適用が必要な旨記載された弊社公開情報:<br><a href="https://docs.microsoft.com/ja-jp/system-center/scsm/system-requirements?view=sc-sm-2019">https://docs.microsoft.com/ja-jp/system-center/scsm/system-requirements?view=sc-sm-2019</a><br>(“SQL Server の要件” 項を参照ください。)</p><p>なお、System Center Virtual Machine Manager (SCVMM) 2019 および System Center Orchestrator (SCORCH) 2019、System Center Data Protection Manager (SCDPM) においては、SCOM 2019 および SCSM 2019 と同様に SQL Server 2019 の使用がサポートされております。<br>一方で、これらの System Center 2019 製品では CU8 以上のアップデートが SQL Server 2019 での適用が必須と明記されておりません。<br>また、実際に CU8 以上が適用されていない状態でもインストールに成功することを弊社検証環境において確認しております。</p><h3 id="対処方法"><a href="#対処方法" class="headerlink" title="対処方法"></a>対処方法</h3><p>SQL Server 2019 を対象となる System Center 2019 製品で使用する場合、SQL Server 2019 に CU8 以上の適用が必要となります。<br>各 SQL Server のバージョンで提供されている最新の CU アップデートは下記の弊社公開情報から参照いただけます。</p><ul><li>アプリケーションとそのコンポーネントのバージョン、エディション、および更新SQL Server決定する<br><a href="https://docs.microsoft.com/ja-jp/troubleshoot/sql/general/determine-version-edition-update-level">https://docs.microsoft.com/ja-jp/troubleshoot/sql/general/determine-version-edition-update-level</a></li></ul><p>SQL Server 2019 の最新版の CU アップデートを入手される場合、こちらの公開情報より “現在サポートされているバージョンの更新プログラムで利用可能な最新SQL Server” 項の表を参照します。<br>“バージョン” 列が “SQL Server 2019” と記載された行の “最新の累積的な更新プログラム” より、”CU <strong>xx</strong> for 2019” と書かれた文字をクリックすることで、対象の CU アップデートの内容およびダウンロード先が掲載された弊社サイトが開かれます。<br>( <strong>xx</strong> には、CU アップデートの数値が記載されております。<br>2022 年 2 月 16 日現在、こちらは “CU15 for 2019” と記載されております。)<br>開かれたサイトより最新版の CU アップデートをダウンロードいただけるリンクをクリックし、アップデートファイルを入手します。<br>そのアップデートファイルを System Center 2019 製品で使用する SQL Server 上で適用することでアップデートが完了します。<br>アップデート後、System Center 2019 のインストールが行えるかご確認ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆さんこんにちは、System Center サポートチームの 保科と申します。&lt;/p&gt;
&lt;p&gt;2022 年 2 月 16 日現在、System Center 2012 の延長サポートが終了間近であったり、System Cen</summary>
      
    
    
    
    
    <category term="System Center" scheme="https://jpabrs-scem.github.io/blog/tags/System-Center/"/>
    
    <category term="SCOM" scheme="https://jpabrs-scem.github.io/blog/tags/SCOM/"/>
    
    <category term="SCSM" scheme="https://jpabrs-scem.github.io/blog/tags/SCSM/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup における CRR (クロスリージョン リストア) について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/CRR/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/CRR/</id>
    <published>2022-02-13T03:00:00.000Z</published>
    <updated>2022-06-22T06:34:34.850Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Backup サポートです。<br>今回は、Azure Backup での リージョンをまたがる復元（ = Cross-Region Restore / CRR）にて頻繁にいただくお問い合わせに関して、下記 3 点ご案内いたします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. CRR 機能を有効した場合の、冗長性オプションは「GRS」になるのか、「RA-GRS」になるのか？</a><br><a href="#1-1">1-1. Azure Portal での CRR 有効時の確認方法</a><br><a href="#1-2">1-2. GRS と RA-GRS(CRR有効化) の違い</a><br><a href="#1-3">1-3. セカンダリ リージョンへのリストア手順</a><br><a href="#2">2. セカンダリ リージョンへ復元ポイントがレプリケートされるまでに、最大何時間かかるのか？</a><br><a href="#3">3. セカンダリ リージョンへ復元ポイントがいつレプリケート完了したか、Azure ポータル画面上でどのように確認すればよいのか？</a><br><a href="#3-1">3-1. 補足：バックアップ ジョブについて</a><br><a href="#4">4. 災害復旧後のレプリケーションについて</a></p><hr><h2 id="1-CRR-機能を有効した場合の、冗長性オプションは「GRS」になるのか、「RA-GRS」になるのか？"><a href="#1-CRR-機能を有効した場合の、冗長性オプションは「GRS」になるのか、「RA-GRS」になるのか？" class="headerlink" title=" 1. CRR 機能を有効した場合の、冗長性オプションは「GRS」になるのか、「RA-GRS」になるのか？"></a><a id="1"></a> 1. CRR 機能を有効した場合の、冗長性オプションは「GRS」になるのか、「RA-GRS」になるのか？</h2><p>結論から申し上げますと、RA-GRS となります。<br><img src="https://user-images.githubusercontent.com/71251920/153718070-4b865afe-f876-47e2-afd0-2484e7889235.gif" alt="CRR_01"></p><p>・Azure Backup 用語集 - Azure Backup | Microsoft Docs<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/azure-backup-glossary#grs">https://docs.microsoft.com/ja-jp/azure/backup/azure-backup-glossary#grs</a></p><h3 id="1-1-Azure-Portal-での-CRR-有効時の確認方法"><a href="#1-1-Azure-Portal-での-CRR-有効時の確認方法" class="headerlink" title=" 1-1. Azure Portal での CRR 有効時の確認方法"></a><a id="1-1"></a> 1-1. Azure Portal での CRR 有効時の確認方法</h3><p>ご参考までに、CRR 機能を有効にした場合の Azure ポータル画面上の見え方を説明いたします。<br>Recovery Services コンテナー「RSV-JPE-GRS-CRR」は「ストレージ レプリケーションの種類：geo 冗長」かつ「リージョンをまたがる復元：有効にする」となっております。<br>これによって CRR 機能が有効 (=RA-GRS) となります。</p><p><img src="https://user-images.githubusercontent.com/71251920/153718069-e91606c7-4001-40d7-8ec1-4596719263c5.gif" alt="CRR_02"></p><p>CRR 機能が有効になっている場合、「バックアップ アイテム」画面上では「主要領域」のほかに「2 次領域」も選択できるよう、活性化されます。<br><img src="https://user-images.githubusercontent.com/71251920/153718068-75b83793-921b-41ce-a330-4d957fd9e11f.gif" alt="CRR_03"><br><img src="https://user-images.githubusercontent.com/71251920/153718067-585d2fb5-242b-4352-87e9-efbb5ba0984e.gif" alt="CRR_04"></p><p> 一方でRecovery Services コンテナー「リージョンをまたがる復元：無効にする」の場合は、下図のように「主要領域」のみが選択となり、かつ非活性表示となります。<br> <img src="https://user-images.githubusercontent.com/71251920/153718066-3ecee4e8-f824-49c1-bd0c-8e9fed23b2f1.png" alt="CRR_05"></p><h3 id="1-2-GRS-と-RA-GRS-CRR有効化時-の違い"><a href="#1-2-GRS-と-RA-GRS-CRR有効化時-の違い" class="headerlink" title=" 1-2. GRS と RA-GRS (CRR有効化時) の違い"></a><a id="1-2"></a> 1-2. GRS と RA-GRS (CRR有効化時) の違い</h3><p> Recovery Services コンテナーの冗長性が GRS であっても、RA-GRS (CRR有効化時) であってもセカンダリ リージョンにバックアップデータはレプリケーションされ保持されます。<br> 違いは<strong>任意のタイミングでセカンダリ リージョンへ復元できるか</strong>どうかです。<br> GRS の場合は弊社がリージョン障害を宣言した場合に限りセカンダリ リージョンへのリストアが可能です。<br> 一方 RA-GRS の場合は任意のタイミングで (リージョン障害が起こっていなくても) セカンダリ リージョンへのリストアが可能です。</p><h3 id="1-3-セカンダリ-リージョンへのリストア手順"><a href="#1-3-セカンダリ-リージョンへのリストア手順" class="headerlink" title=" 1-3. セカンダリ リージョンへのリストア手順"></a><a id="1-3"></a> 1-3. セカンダリ リージョンへのリストア手順</h3><p>下記公開情報をご覧ください。<br>・セカンダリ リージョンに復元する - Azure portal で Azure VM データを復元する方法<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region</a></p><h2 id="2-セカンダリ-リージョンへ復元ポイントがレプリケートされるまでに、最大何時間かかるのか？"><a href="#2-セカンダリ-リージョンへ復元ポイントがレプリケートされるまでに、最大何時間かかるのか？" class="headerlink" title=" 2. セカンダリ リージョンへ復元ポイントがレプリケートされるまでに、最大何時間かかるのか？"></a><a id="2"></a> 2. セカンダリ リージョンへ復元ポイントがレプリケートされるまでに、最大何時間かかるのか？</h2><p>セカンダリ リージョンへのデータのレプリケーションは、プライマリリージョンへのバックアップジョブが完了 (最大24時間) してから 12 時間以内にレプリケーションが完了するように動作します。<br>そのため、プライマリリージョンのバックアップジョブ完了とセカンダリ リージョンへのレプリケーションにはラグが生じます。</p><p>・Azure portal を使用して VM を復元する - Azure Backup | Microsoft Docs<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region</a></p><blockquote><p>現在、セカンダリ リージョンの RPO は “36 時間” です。 これは、プライマリ リージョンの RPO が “24 時間” であり、プライマリからセカンダリ リージョンへのバックアップ データのレプリケーションに最大 “12 時間” かかることがあるためです。</p></blockquote><h2 id="3-セカンダリ-リージョンへ復元ポイントがいつレプリケート完了したか、Azure-ポータル画面上でどのように確認すればよいのか？"><a href="#3-セカンダリ-リージョンへ復元ポイントがいつレプリケート完了したか、Azure-ポータル画面上でどのように確認すればよいのか？" class="headerlink" title=" 3. セカンダリ リージョンへ復元ポイントがいつレプリケート完了したか、Azure ポータル画面上でどのように確認すればよいのか？"></a><a id="3"></a> 3. セカンダリ リージョンへ復元ポイントがいつレプリケート完了したか、Azure ポータル画面上でどのように確認すればよいのか？</h2><p>Recovery Services コンテナー ＞ バックアップ アイテム ＞ 2 次領域 ＞ Azure Virtual Machine ＞ 対象の仮想マシンを選択し、「復元ポイント」欄に、対象の復元ポイントが表示されていれば、 2 次領域へのレプリケートは完了していると判断できます。<br><img src="https://user-images.githubusercontent.com/71251920/153718060-4b01fca7-5815-4b8a-b2e8-3eb2f32ffa17.png" alt="CRR_08"><br>作業例）主要領域に配置されている仮想マシン「SAPHANA03」を「今すぐバックアップ」を実施し、取得された復元ポイントが 2 次領域に複製されているかを確認する</p><p>下図画面の黄色罫線部分が、「今すぐバックアップ」にてトリガーし、バックアップが完了したバックアップ ジョブです。<br><em><strong>2021/12/9 17:50 に「今すぐバックアップ」のバックアップ ジョブがトリガーされ、18:21 ごろにバックアップが完了しております。</strong></em><br><img src="https://user-images.githubusercontent.com/71251920/153718059-212e67d8-e43b-483f-9f18-19906a8b0805.gif" alt="CRR_09"></p><p>バックアップ アイテム ＞ 主要領域 ＞ Azure Virtual Machine 画面上の「最新の復元ポイント」に表示されている時刻は、バックアップが実行開始された時刻となります。<br><img src="https://user-images.githubusercontent.com/71251920/153718057-67e701d6-4f7b-44e7-bbfc-add77d52be00.jpg" alt="CRR_10"></p><p>「主要領域」側のバックアップ項目画面では、「復元ポイント」欄に、取得済の復元ポイントが表示されています。<br><img src="https://user-images.githubusercontent.com/71251920/153718056-ffaa1520-c74a-424e-a0ed-b58585c6235d.png" alt="CRR_11"></p><p>一方で、バックアップ アイテム ＞ 2 次領域 ＞ Azure Virtual Machine ＞ 対象の仮想マシンをクリックします。<br>バックアップ項目画面では、<em><strong>「復元ポイント」欄に、12/09 18:32 時点では、12/09 に主要領域側にて取得済の復元ポイントはまだ表示されておらず、2 次領域側に復元ポイントが複製されていないことが分かります。</strong></em><br>（2021/12/09 24時ごろも確認しましたが、復元ポイントは表示されておりませんでした）<br><img src="https://user-images.githubusercontent.com/71251920/153718055-f4e602c6-942e-4542-bc68-1105e1e595d2.png" alt="CRR_12"></p><p>同じく、「セカンダリ リージョンへの復元」をクリックし、「復元ポイントの選択」欄を表示しても、<em><strong>12/09 17:50 に開始・取得済の復元ポイントは表示されていないことが確認できます。</strong></em><br><img src="https://user-images.githubusercontent.com/71251920/153718054-b2f2fa69-cee7-4fb6-9997-46186c01f2b2.png" alt="CRR_13"></p><p>2021/12/09 17:50 Auzre VM Backup 開始後、 <em><strong>12 時間以上経過した 2021/12/10 8:09 時点では、「復元ポイントの選択」欄にて、セカンダリ リージョンのデータとして 17:50 のバックアップ開始分が表示されていることが確認できました。</strong></em></p><p><img src="https://user-images.githubusercontent.com/71251920/153718052-24c17913-41e2-4936-bb36-39735f087e94.png" alt="CRR_14"></p><h3 id="補足：バックアップ-ジョブについて"><a href="#補足：バックアップ-ジョブについて" class="headerlink" title=" 補足：バックアップ ジョブについて"></a><a id="3-1"></a> 補足：バックアップ ジョブについて</h3><p>Recovery Services コンテナー ＞ バックアップ ジョブ ＞「View jobs in secondary region」をクリックすると、2 次領域のバックアップ ジョブを確認可能です。<br>しかし、主要領域に配置されている仮想マシン「SAPHANA03」の「今すぐバックアップ」のバックアップ ジョブは、 2 次領域のバックアップ ジョブ上には表示されません。<br><img src="https://user-images.githubusercontent.com/71251920/153718051-58d3846a-cb16-4509-982d-f9034093cf3d.gif" alt="CRR_15"></p><p><img src="https://user-images.githubusercontent.com/71251920/153718050-bf4b2841-6c14-40fa-8c21-94d806c47872.jpg" alt="CRR_16"></p><h2 id="災害復旧後のレプリケーションに関するFAQ"><a href="#災害復旧後のレプリケーションに関するFAQ" class="headerlink" title=" 災害復旧後のレプリケーションに関するFAQ"></a><a id="4"></a> 災害復旧後のレプリケーションに関するFAQ</h2><blockquote><p>Q. プライマリリージョンが復旧したあとに プライマリリージョンに VM を復旧できるか、またその方法</p><blockquote><p>A. こちらは可能ですが、Azure VM Backup の機能で実現するにはクロスリージョン リストアを実施いただく必要がございます。<br>具体的には一度セカンダリリージョンに VM をリストア いただき、復元した VM をセカンダリリージョンの Recovery Services コンテナーで保護しプライマリリージョンにクロスリージョン リストアを行う必要がございます。<br>これはセカンダリリージョンにあるバックアップデータからはセカンダリリージョンにしか、プライマリリージョンにあるバックアップデータからはプライマリリージョンにしかリストアができないためです。<br>Azure VM Backup の クロスリージョン リストア以外の方法ではセカンダリリージョンに VM をリストアした後に Azure Site Recovery などを用いた方法が考えられます。<br>・Azure VM を別の Azure リージョンに移動する<br><a href="https://docs.microsoft.com/ja-jp/azure/site-recovery/azure-to-azure-move-overview">https://docs.microsoft.com/ja-jp/azure/site-recovery/azure-to-azure-move-overview</a></p></blockquote></blockquote><blockquote><p>Q. バックアップデータのレプリケーションは再開されるか</p><blockquote><p>A. プライマリリージョンからセカンダリリージョンへのバックアップデータレプリケーションは災害復旧次第再開されます。<br>一方プライマリリージョンのデータが失われていたとしてもセカンダリリージョンからプライマリリージョンへのバックアップデータのレプリケーションは行われません。</p></blockquote></blockquote><p>CRR に関する説明は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、Azure Backup での リージョンをまたがる復元（ = Cross-Region Restore / CRR）にて頻繁にいただくお問い合わせに関して、</summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>Azure Backup の障害調査に必要な情報</title>
    <link href="https://jpabrs-scem.github.io/blog/Recovery%20Services%20vaults/RequestForInvestigating/"/>
    <id>https://jpabrs-scem.github.io/blog/Recovery%20Services%20vaults/RequestForInvestigating/</id>
    <published>2022-02-11T03:00:00.000Z</published>
    <updated>2022-06-22T06:34:34.906Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートの山本です。<br>今回は Azure Backup のバックアップ失敗、リストア失敗の時の調査をするにあたり、提供いただきたい情報をお伝えいたします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Azure VM バックアップの障害調査に必要なログ</a><br>  <a href="#1-1">  1-1. Azure VM Backup の VSS 障害調査に追加で必要なログ</a><br><a href="#2">2.   Azure VM バックアップ の ファイルレベル リストア (ILRリストア) 失敗調査に必要なログ</a><br><a href="#3">3. Azure Backup for SAP HANA in Azure VM の障害調査に必要なログ</a><br><a href="#4">4. MARS Backup エージェントを利用したバックアップ の障害調査に必要なログ</a><br>  <a href="#4-1">4-1. Microsoft Azure Backup Agent のログ</a><br>  <a href="#4-2">4-2. システム情報</a><br>  <a href="#4-3">4-3. イベント ログ</a></p><hr><h2 id="1-Azure-VM-バックアップの障害調査に必要なログ"><a href="#1-Azure-VM-バックアップの障害調査に必要なログ" class="headerlink" title="1. Azure VM バックアップの障害調査に必要なログ"></a>1. Azure VM バックアップの障害調査に必要なログ<a id="1"></a></h2><p>　*Azure VM Backup ではないですが  Azure Backup for SQL Server in Azure VM や Azure Backup for SAP HANA in Azure VM など Azure VM 上の DB のバックアップに関するものでも同様に必要です。<br>下記の <strong>環境情報</strong>と<strong>ログ情報</strong>の収集をお願いいたします。</p><h3 id="環境情報"><a href="#環境情報" class="headerlink" title="環境情報"></a>環境情報</h3><p>・Subscription ID<br>・Recovery Services コンテナー名、およびそのリソースグループ名<br>・バックアップ対象 VM 名、およびそのリソースグループ名</p><h4 id="ログ情報"><a href="#ログ情報" class="headerlink" title="ログ情報"></a>ログ情報</h4><p>下記を参考に zip などにまとめてご提供いただけますと幸いです。</p><h4 id="・Windows-の場合"><a href="#・Windows-の場合" class="headerlink" title="・Windows の場合"></a>・Windows の場合</h4><blockquote><p>C:\Windows\System32\winevt\Logs<br>C:\WindowsAzure\</p></blockquote><h4 id="・Linuxの場合"><a href="#・Linuxの場合" class="headerlink" title="・Linuxの場合"></a>・Linuxの場合</h4><blockquote><p>/var/log/</p></blockquote><p>全量いただけることが望ましいですが、全量が困難な場合は下記をご提供ください。</p><blockquote><p>/var/log/azure/*<br>/var/log/syslog*<br>/var/log/waagent.*</p></blockquote><h3 id="1-1-Azure-VM-Backup-の-VSS-障害調査に追加で必要なログ"><a href="#1-1-Azure-VM-Backup-の-VSS-障害調査に追加で必要なログ" class="headerlink" title="1-1 . Azure VM Backup の VSS 障害調査に追加で必要なログ"></a>1-1 . Azure VM Backup の VSS 障害調査に追加で必要なログ<a id="1-1"></a></h3><p>Azure VM Backupの下記のようなエラーが出ることがございます。<br>その場合には VSS 観点での調査が必要であるため、そのため上記 <a href="#1">1. Azure VM バックアップの障害調査に必要なログ</a> に加えて下記のログの採取もお願いします。</p><blockquote><p>Error Code ：Snapshot operation failed due to VSS Writers in bad state.<br>Error Message ：ExtensionFailedVssWriterInBadState</p></blockquote><p>VSS 観点での調査のためには下記 URL 先のログの採取をお願いします。<br> <strong>可能な限り “[A]”が望ましいですが、”[B]” の方法で採取いただいても、ある程度は調査が可能な場合がございます。</strong><br>・VSS エラーが発生している事象の調査<br><a href="https://jpwinsup.github.io/mslog/storage/vss/vss-error.html">https://jpwinsup.github.io/mslog/storage/vss/vss-error.html</a></p><p>また合わせて下記も関連するブログでございます。<br>・Azure VM Backupにおける整合性について<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#1-1-VSS-%E8%A6%B3%E7%82%B9%E3%81%A7%E3%81%AE%E8%AA%BF%E6%9F%BB%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#1-1-VSS-%E8%A6%B3%E7%82%B9%E3%81%A7%E3%81%AE%E8%AA%BF%E6%9F%BB%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6</a></p><h2 id="2-Azure-VM-バックアップ-の-ファイルレベル-リストア-ILRリストア-失敗調査に必要なログ"><a href="#2-Azure-VM-バックアップ-の-ファイルレベル-リストア-ILRリストア-失敗調査に必要なログ" class="headerlink" title="2.   Azure VM バックアップ の ファイルレベル リストア (ILRリストア) 失敗調査に必要なログ"></a>2.   Azure VM バックアップ の ファイルレベル リストア (ILRリストア) 失敗調査に必要なログ<a id="2"></a></h2><p>下記の <strong>環境情報</strong>と<strong>ログ情報</strong>の収集をお願いいたします。</p><h3 id="環境情報-1"><a href="#環境情報-1" class="headerlink" title="環境情報"></a>環境情報</h3><p>・Subscription ID<br>・Recovery Services コンテナー名、およびそのリソースグループ名<br>・バックアップ対象 VM 名、およびそのリソースグループ名、OS 名<br>・リストア先の VM 名、およびそのリソースグループ名、OS 名</p><h3 id="ログ情報-1"><a href="#ログ情報-1" class="headerlink" title="ログ情報"></a>ログ情報</h3><p>zip などにまとめてご提供いただけますと幸いです。</p><h4 id="・-Windows-の場合-“ディスクの管理”-の画面の画面ショット"><a href="#・-Windows-の場合-“ディスクの管理”-の画面の画面ショット" class="headerlink" title="・(Windows の場合) “ディスクの管理” の画面の画面ショット"></a>・(Windows の場合) “ディスクの管理” の画面の画面ショット</h4><p><img src="https://user-images.githubusercontent.com/71251920/153464381-6ba8f9bf-56fd-48fd-9784-b819d8a4f79c.png" alt="参考画像"></p><h4 id="・実行したスクリプト、および実行後に作成されたフォルダ一式"><a href="#・実行したスクリプト、および実行後に作成されたフォルダ一式" class="headerlink" title="・実行したスクリプト、および実行後に作成されたフォルダ一式"></a>・実行したスクリプト、および実行後に作成されたフォルダ一式</h4><ul><li><strong>Windowsの場合</strong><br>・スクリプトファイル：IaaSVMILRExeForWindows.exe<br>・スクリプト実行後に作成されるフォルダー：”仮想マシン名(小文字)”+”スクリプトファイル実行日時”</li></ul><p>　下記例では “okt-temp-win-20220212145642” が作成されています。<br><img src="https://user-images.githubusercontent.com/71251920/153714819-e9f24f63-75f0-4268-b0fc-ac6e43155cc1.png"></p><p>“okt-temp-win-20220212145642”の中身<br><img src="https://user-images.githubusercontent.com/71251920/153714818-906282be-7acc-4e9f-9d4e-62d5b2b369a0.png" alt="&quot;okt-temp-win-20220212145642&quot;の中身"></p><ul><li><strong>Linux の場合</strong><br>・ILRのスクリプトファイル：例)　<strong>vm02kensho(小文字VM名)_1_jpe_6591639015130036692_802427195716_899298aac7c04bf094ad68bfc5b9584ed206b94b62d965.py</strong><br>・作成されたディレクトリの <strong>Scripts ディレクトリ一式</strong>：例） <strong>vm02kensho-20220212151619/Script</strong><br>スクリプトを実行後、「<strong>vm02kensho-20220212151619</strong>」ディレクトリが自動生成されていることがわかる。<br><img src="https://user-images.githubusercontent.com/71251920/153714817-892202e9-3df5-4377-9276-42b16eb82fd4.png"></li></ul><blockquote><p>ls -all</p></blockquote><p><img src="https://user-images.githubusercontent.com/71251920/153714816-49b0446b-8728-498e-b51f-bff02f37f0a5.png" alt="「vm02kensho-20220212151619」ディレクトリが自動生成されている"></p><p>「vm02kensho-20220212151619」ディレクトリの中身、および作成されたディレクトリの <strong>Scripts ディレクトリ</strong>の中身は下記の通り</p><blockquote><p>ls -allR</p></blockquote><p><img src="https://user-images.githubusercontent.com/71251920/153714814-a652e630-b1c8-4e43-a96f-4d974c9d7cf4.png" alt="「vm02kensho-20220212151619」ディレクトリの中身,および作成されたディレクトリの Scripts ディレクトリの中身"></p><h2 id="3-Azure-Backup-for-SAP-HANA-in-Azure-VM-の障害調査に必要なログ"><a href="#3-Azure-Backup-for-SAP-HANA-in-Azure-VM-の障害調査に必要なログ" class="headerlink" title="3. Azure Backup for SAP HANA in Azure VM の障害調査に必要なログ"></a>3. Azure Backup for SAP HANA in Azure VM の障害調査に必要なログ<a id="3"></a></h2><p> <a href="#1">1. Azure VM バックアップの障害調査に必要なログ</a> の <strong>環境情報</strong> ならびに <strong>ログ情報 - Linuxの場合</strong> に加えて下記もご対応お願いします。<br>*お手数ですが、全ての DB の backup.log 及び backint.log の採取をお願いします。</p><h3 id="SAP-HANAのbackup-log-及び-backint-log"><a href="#SAP-HANAのbackup-log-及び-backint-log" class="headerlink" title="SAP HANAのbackup.log 及び backint.log"></a>SAP HANAのbackup.log 及び backint.log</h3><blockquote><ul><li>xxにはインスタンスナンバーが入ります。<br>  ・/hana/shared/HXE/HDBxx/<hostname>/trace/backup.log<br>  ・/hana/shared/HXE/HDBxx/<hostname>/trace/DB_&lt;DB名&gt;/backup.log<br>  ・/hana/shared/HXE/HDBxx/<hostname>/trace/backint.log<br>  ・/hana/shared/HXE/HDBxx/<hostname>/trace/DB_&lt;DB名&gt;/backint.log</li></ul></blockquote><p>*上記パスに該当のログが無い場合は以下を試し、コマンド実行結果に表示されディレクトリの場所の log をアップロードしてください。</p><blockquote><p>   #sudo -i (rootユーザーに切り替えます)<br>    #cd / (ディレクトリの最上層に移動します)<br>    #find ./ -name “backup.log” (findコマンドにより該当のログの場所を特定します)<br>    #find ./ -name “backint.log” (findコマンドにより該当のログの場所を特定します)</p></blockquote><h2 id="4-MARS-Backup-エージェントを利用したバックアップ-の障害調査に必要なログ"><a href="#4-MARS-Backup-エージェントを利用したバックアップ-の障害調査に必要なログ" class="headerlink" title="4. MARS Backup エージェントを利用したバックアップ の障害調査に必要なログ"></a>4. MARS Backup エージェントを利用したバックアップ の障害調査に必要なログ<a id="4"></a></h2><p>MARS バックアップ のバックアップ対象の環境が Azure VM の場合、<a href="#1">1. Azure VM バックアップの障害調査に必要なログ</a> の <strong>環境情報</strong> ならびに <strong>ログ情報 - Windows の場合</strong> に加えて下記もご対応お願いします。*オンプレミス環境や Azure VM 以外の環境であれば不要です。</p><h3 id="4-1-Microsoft-Azure-Backup-Agent-のログ"><a href="#4-1-Microsoft-Azure-Backup-Agent-のログ" class="headerlink" title="4.1 Microsoft Azure Backup Agent のログ　"></a>4.1 Microsoft Azure Backup Agent のログ　<a id="4-1"></a></h3><p> まず、下記 リンク先から調査用スクリプトのダウンロードをお願いします。<br><a href="https://github.com/jpabrs-scem/blog/files/8045897/WABDiag.zip">WABDiag.zip</a></p><p>ダウンロードいただきました WABDiag.tx を .ps1 に変更して使用し、問題が発生しているマシンより Azure Backup ログの収集をお願いいたします。<br>※ ファイルの解凍パスワードは “AzureBackup” となります。</p><ol><li>WABDiag.ps1 を管理者権限の PowerShell で実行します。</li></ol><blockquote><p>実行コマンド: &lt;スクリプトのパス&gt;\WABDiag.ps1 &lt;パス\保存するフォルダ名&gt;<br>   実行例: C:\WABDiag\WABDiag.ps1 C:\Logs</p></blockquote><p>   実行結果にファイル パスが無い旨のメッセージが表示される可能性がございますが、対象のファイル自体が無い事を示すメッセージとなりますので、無視していただいて問題ございません。</p><h4 id="PowerShell-の実行ポリシーの制限によりスクリプトが実行できない場合"><a href="#PowerShell-の実行ポリシーの制限によりスクリプトが実行できない場合" class="headerlink" title="PowerShell の実行ポリシーの制限によりスクリプトが実行できない場合"></a>PowerShell の実行ポリシーの制限によりスクリプトが実行できない場合</h4><p>PowerShellを管理者権限で起動し、下記コマンドを実行し実行ポリシーを変更後、再度実行していただけますでしょうか。</p><blockquote><p>コマンド：Set-ExecutionPolicy Unrestricted</p></blockquote><p>また現在の実行ポリシーを後ほど元に戻す場合は、変更前に下記コマンドを実行し、設定されているポリシーを確認、メモし、スクリプト実行後に同様の手順で変更していただきますようお願いいたします。</p><blockquote><p>コマンド：Get-ExecutionPolicy </p></blockquote><ul><li>参考<br>・実行ポリシーについて - PowerShell<br><a href="https://docs.microsoft.com/ja-jp/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.2">https://docs.microsoft.com/ja-jp/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.2</a></li></ul><h3 id="4-2-システム情報"><a href="#4-2-システム情報" class="headerlink" title="4.2 システム情報 "></a>4.2 システム情報 <a id="4-2"></a></h3><ol><li>対象のマシンに管理者権限を保持するユーザーでログオンします。</li><li>管理者権限でコマンド プロンプトを起動し、以下のコマンドで取得します。<blockquote><p>msinfo32 /nfo &lt;出力ファイル名&gt;<br>実行例)  &gt; msinfo32 /nfo SVR_msinfo32.nfo</p></blockquote></li><li>生成されたファイルをご提供ください。</li></ol><h3 id="4-3-イベント-ログ"><a href="#4-3-イベント-ログ" class="headerlink" title="4.3 イベント ログ"></a>4.3 イベント ログ<a id="4-3"></a></h3><ol><li>対象のマシンに管理者権限を保持するユーザーでログオンします。</li><li>[スタート] - [管理ツール] - [イベント ビューアー] を開きます。</li><li>左側ペインの以下のイベントに対して、右クリックをし、[すべてのイベントを名前をつけて保存] を選択し、ファイルの種類が “イベント ファイル (<em>.evtx)” であることを確認し、任意の名前を付けて、[保存] をクリックします。<br>(ファイルの種類が “イベント ファイル (</em>.csv)” も併せて取得をお願いいたします)<br>a) [イベント ビューアー (ローカル)] - [Windows ログ] - [システム]<br>b) [イベント ビューアー (ローカル)] - [Windows ログ] - [Application]</li><li>保存したイベント ログ ファイルをご提供ください。</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートの山本です。&lt;br&gt;今回は Azure Backup のバックアップ失敗、リストア失敗の時の調査をするにあたり、提供いただきたい情報をお伝えいたします。&lt;/p&gt;
&lt;h2 id=</summary>
      
    
    
    
    
    <category term="Recovery Services vaults" scheme="https://jpabrs-scem.github.io/blog/tags/Recovery-Services-vaults/"/>
    
    <category term="情報採取" scheme="https://jpabrs-scem.github.io/blog/tags/%E6%83%85%E5%A0%B1%E6%8E%A1%E5%8F%96/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backupにおける整合性について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/</id>
    <published>2022-02-11T03:00:00.000Z</published>
    <updated>2022-06-22T06:34:34.850Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートの山本です。<br>今回は Azure VM Backup における整合性に関して具体例も踏まえつつご説明させていただきます。</p><p>まず、Azure VM Backup における整合性は下記の３種類ございます。<br>・アプリケーション整合性 (Application-consistent)<br><img src="https://user-images.githubusercontent.com/71251920/153444342-2ef78226-36af-42ec-b791-def280af289e.png" alt="2022-02-11_00h49_03"></p><p>・ファイルシステム整合性 (File-system consistent)<br><img src="https://user-images.githubusercontent.com/71251920/153444335-2c65943d-8f13-4c6d-b2d0-7bf4283b6fc4.png" alt="2022-02-11_00h49_22"></p><p>・クラッシュ整合性 (Crash-consistent)<br><img src="https://user-images.githubusercontent.com/71251920/153444341-0b61bf0e-5b58-4040-a0ef-c0d213a2187b.png" alt="2022-02-11_00h49_36"></p><p>なお、公開情報は下記にございますのでまず一度ご一読ください。<br>その前提で説明させていただきます。</p><ul><li>参考<br>・Azure VM バックアップの概要 スナップショットの整合性<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#snapshot-consistency">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#snapshot-consistency</a></li></ul><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. アプリケーション整合性</a><br><a href="#1-1">  1.1 VSS 観点での調査について</a><br><a href="#1-2">  1.2  SQL Server のインストールされた Windows OS のバックアップについて</a><br><a href="#1-2-1">   1.2.1  ご参考ページ</a><br><a href="#1-3">  1.3  Oracle DB for Windows VM の Azure VM Backup について</a><br><a href="#1-4">  1.4  事前事後スクリプトについて</a><br><a href="#2">2. ファイルシステム整合性</a><br><a href="#3">3. クラッシュ整合性</a></p><hr><h2 id="1-アプリケーション整合性"><a href="#1-アプリケーション整合性" class="headerlink" title="1. アプリケーション整合性"></a>1. アプリケーション整合性<a id="1"></a></h2><p>こちら Azure VM Backup における最も上位の整合性でございます。<br>Windows OS のバックアップを取得した場合や事前事後スクリプトを設定した Linux OS でオンライン バックアップを取得した場合にアプリケーション整合性となります。<br>なお、Windows OS の場合は VSS (ボリューム シャドウ コピー サービス) との連携によりアプリケーション整合性を取得するのみであり、Linux OS のような事前事後スクリプトの準備はございません。</p><p>Azure Portal 上の表示では、Windows OS の場合は VSS (VSS ライター) が正常に稼働すればアプリケーション整合性となり、Linux VM の場合は事前事後スクリプトが正常に完了すればアプリケーション整合性となります。<br>つまり、VSS に対応していないアプリケーションをご利用の場合は該当アプリケーションに対する整合性はございませんが、Azure Portal (Azure Backup) では VSS ライターが提供されていない対象のアプリケーションを検知することが出来ないため Azure Portal 上の表示はアプリケーション整合性となります。</p><p>また、<strong>ご利用のアプリケーション整合性が VSS に対応しているかは各アプリケーションの提供元ベンダーまでお問い合わせいただきますようお願いします。</strong></p><ul><li>参考<br>・ボリューム シャドウ コピー サービスの仕組み<br><a href="https://docs.microsoft.com/ja-jp/windows-server/storage/file-server/volume-shadow-copy-service#how-volume-shadow-copy-service-work">https://docs.microsoft.com/ja-jp/windows-server/storage/file-server/volume-shadow-copy-service#how-volume-shadow-copy-service-work</a><blockquote><p>Microsoft 以外の VSS ライターは、バックアップ中のデータの整合性を保証する必要がある Windows 用の多くのアプリケーションに含まれています。</p></blockquote></li></ul><h3 id="1-1-VSS-観点での調査について"><a href="#1-1-VSS-観点での調査について" class="headerlink" title="1.1 VSS 観点での調査について"></a>1.1 VSS 観点での調査について<a id="1-1"></a></h3><p>まず、Azure Backup チームでは VSS 関連の障害調査に関しては VSS および 特定の VSS ライターに不調があるというところまでが調査可能です。<br>なぜ “VSS および 特定の VSS ライターに不調が起きたのか” に関する根本原因についてはお客様の契約次第ではオンプレミス チームでの有償対応が必要となることがございます。<br>また、お客様のご契約が Azure 製品のサポート契約のみの場合オンプレミス範囲のサポート契約がないため、詳細な調査を行えないことがございます。<br>また切り分けの結果、他社製品のアプリケーションの VSS ライターの不具合であった場合には弊社ではサポート出来かねますので、ご利用のアプリケーション提供ベンダーまでお問い合わせお願いします。</p><p>つぎに、それぞれについて下記の通りお伝えさせていただきます。</p><h4 id="・VSS-の不調-bad-state-によりAzure-VM-Backupが失敗する"><a href="#・VSS-の不調-bad-state-によりAzure-VM-Backupが失敗する" class="headerlink" title="・VSS の不調 (bad state)によりAzure VM Backupが失敗する"></a>・VSS の不調 (bad state)によりAzure VM Backupが失敗する</h4><p>こちら根本原因の特定には VSS 観点での調査が必要となります。<br> Azure Backup チームでは 根本原因の特定については可能な範囲での調査をさせていただきます。</p><p>ご参考にまでに、下記のようなエラーが出ることがございます。</p><blockquote><p>Error Code ：ExtensionFailedVssServiceInBadState<br>Error Message ：Snapshot operation failed due to VSS (Volume Shadow Copy) service in bad state</p></blockquote><blockquote><p>Error Code ：ExtensionFailedVssWriterInBadState<br>Error Message ：Snapshot operation failed due to VSS Writers in bad state.</p></blockquote><p>事象の改善方法としては下記 URL 記載の <strong>VSS の再起動、および VM の再起動を行うことで改善することがほとんどでございます。</strong></p><p>・Azure 仮想マシンでのバックアップ エラーのトラブルシューティング - ExtensionFailedVssServiceInBadState - VSS (ボリューム シャドウ コピー) サービスが正しくない状態にあるため、スナップショット操作に失敗しました<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#extensionfailedvssserviceinbadstate---snapshot-operation-failed-due-to-vss-volume-shadow-copy-service-in-bad-state">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#extensionfailedvssserviceinbadstate---snapshot-operation-failed-due-to-vss-volume-shadow-copy-service-in-bad-state</a></p><p> VSS 観点で、なぜ VSS が bad state になったか、に関する根本原因の調査のためには下記 URL 先のログの採取をお願いします。<br> <strong>可能な限り “[A]”が望ましいですが、”[B]” の方法で採取いただいても、ある程度は調査が可能な場合がございます。</strong><br>・VSS エラーが発生している事象の調査<br><a href="https://jpwinsup.github.io/mslog/storage/vss/vss-error.html">https://jpwinsup.github.io/mslog/storage/vss/vss-error.html</a></p><h4 id="・VSS-ライターのエラーにより警告付き完了となる-アプリケーション整合性ではなくファイルシステム整合性となって復旧ポイントが取得されている"><a href="#・VSS-ライターのエラーにより警告付き完了となる-アプリケーション整合性ではなくファイルシステム整合性となって復旧ポイントが取得されている" class="headerlink" title="・VSS ライターのエラーにより警告付き完了となる / アプリケーション整合性ではなくファイルシステム整合性となって復旧ポイントが取得されている"></a>・VSS ライターのエラーにより警告付き完了となる / アプリケーション整合性ではなくファイルシステム整合性となって復旧ポイントが取得されている</h4><p>こちら根本原因の特定には VSS および VSS ライター観点での調査が必要となります。<br> Azure Backup チームでは どうして VSS ライター が失敗したのか、に関する根本原因の特定については可能な範囲での調査をさせていただきます。<br>　一次調査の結果、VSS ライターのエラーを出しているアプリケーションが 弊社 SQL Server 等弊社製品の場合は担当チーム (SQL Server 等) で対応が可能でございますが、お客様の契約次第では有償対応が必要となることがございます。<br>　一方、VSS ライターのエラーを出しているアプリケーションが他社製品の場合、ご利用のアプリケーション提供ベンダーまでお問い合わせいただくようお願い申し上げます。</p><p>改善策としては、下記の URL をご参考にして<strong>VSS の再起動、および VM の再起動の対応いただければと存じます。</strong><br>・Azure 仮想マシンでのバックアップ エラーのトラブルシューティング - ExtensionFailedVssWriterInBadState - VSS ライターが正しくない状態にあるため、スナップショット操作に失敗しました<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#extensionfailedvsswriterinbadstate---snapshot-operation-failed-because-vss-writers-were-in-a-bad-state">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#extensionfailedvsswriterinbadstate---snapshot-operation-failed-because-vss-writers-were-in-a-bad-state</a></p><h3 id="1-2-SQL-Server-のインストールされた-Windows-OS-のバックアップについて"><a href="#1-2-SQL-Server-のインストールされた-Windows-OS-のバックアップについて" class="headerlink" title="1.2  SQL Server のインストールされた Windows OS のバックアップについて"></a>1.2  SQL Server のインストールされた Windows OS のバックアップについて<a id="1-2"></a></h3><p>こちらよくいただくお問い合わせとして次の通りお伝えします。</p><blockquote><p>・SQL Server のインストールされた Windows OS をAzure VM Backup でバックアップすることは可能か、また何か考慮点があるか？<br>*ここで SQL Server とは Microsoft SQL Server を指します。</p></blockquote><p><strong>こちら結論から申し上げますと、可能です。</strong><br>Microsoft SQL Server では SQL ライターがございますので、SQL データベースの整合性を保った VM 全体のバックアップを取得することが可能です。</p><p>考慮点としましては下記 URL をご覧ください。</p><ul><li>参考<br>・Azure VM バックアップの概要 - スナップショットの作成<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#snapshot-creation">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#snapshot-creation</a><blockquote><p>既定の Azure Backup では、VSS の完全バックアップが作成されます (アプリケーション レベルで整合性のあるバックアップを取得するため、バックアップ時に、SQL Server などのアプリケーションのログは切り捨てられます)。 Azure VM バックアップで SQL Server データベースを使用している場合は、(ログを保持するため) VSS コピー バックアップを作成するように設定を変更できます。 詳細については、 こちらの記事を参照してください。</p></blockquote></li></ul><p>・Azure 仮想マシンでのバックアップ エラーのトラブルシューティング - VM スナップショットに関する問題のトラブルシューティング<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#troubleshoot-vm-snapshot-issues">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#troubleshoot-vm-snapshot-issues</a></p><blockquote><p>既定では、VM バックアップによって Windows VM 上に VSS フル バックアップが作成されます。 SQL Server を実行していて SQL Server のバックアップを構成されている VM では、スナップショットの遅延が発生する可能性がありますナップショットの遅延が原因でバックアップが失敗する場合は、次のレジストリ キーを設定します。<br>[HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT]<br>“USEVSSCOPYBACKUP”=”TRUE”</p></blockquote><p>上記レジストリ設定にあたって OS 再起動は必要ございません。</p><h4 id="1-2-1-上記に関するご参考ページ"><a href="#1-2-1-上記に関するご参考ページ" class="headerlink" title="1.2.1 上記に関するご参考ページ "></a>1.2.1 上記に関するご参考ページ <a id="1-2-1"></a></h4><p>・コピーのみのバックアップ - SQL Server<br><a href="https://docs.microsoft.com/ja-jp/sql/relational-databases/backup-restore/copy-only-backups-sql-server?view=sql-server-ver16">https://docs.microsoft.com/ja-jp/sql/relational-databases/backup-restore/copy-only-backups-sql-server?view=sql-server-ver16</a></p><blockquote><p>コピーのみのバックアップは、従来の SQL Server バックアップのシーケンスから独立した SQL Server バックアップです。 通常、バックアップを行うとデータベースが変更され、その後のバックアップの復元方法に影響します。 ただし、データベース全体のバックアップや復元の手順に影響を与えない、特殊な目的にバックアップを行うと役に立つ場合があります。 このため、コピーのみのバックアップが導入されました。</p></blockquote><p>また、下記は<strong>弊社外のブログ</strong>ではございますが、本件に関する参考になればと存じ、ご案内させていただきます。<br>※社外の情報のため内容につきましては当社は、下記外部のリンク先ウェブサイトの内容に関していかなる責任も負うものではありません。<br>・Azure Backup で SQL Server がインストールされている仮想マシンをバックアップする際に意識しておきたいこと<br><a href="https://blog.engineer-memo.com/2018/03/17/azure-backup-%E3%81%A7-sql-server-%E3%81%8C%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%82%92/">https://blog.engineer-memo.com/2018/03/17/azure-backup-%E3%81%A7-sql-server-%E3%81%8C%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3%E3%82%92/</a></p><h3 id="1-3-Oracle-DB-for-Windows-VM-の-Azure-VM-Backup-について"><a href="#1-3-Oracle-DB-for-Windows-VM-の-Azure-VM-Backup-について" class="headerlink" title="1.3  Oracle DB for Windows VM の Azure VM Backup について"></a>1.3  Oracle DB for Windows VM の Azure VM Backup について<a id="1-3"></a></h3><p>よくお問い合わせをいただく例としましては Oracle DB が搭載された Windows OS に関してお問い合わせをいただくことがございます。<br>弊社では Windows OS 向けの Oracle DB すべてが VSS に対応しているかわかりかねますが、少なくとも実績はございます。<br>ご利用の Oracle DB が VSS に対応しているかが不明な場合は別途 Oracle 社にお問い合わせいただければと存じます。</p><ul><li>下記情報は弊社外のサイトでございますが、ご参考になれば幸いです。弊社情報ではございませんのでその点ご留意ください。<br>・Oracleがインストールされているシステムで Exit Code -311が発生する<br><a href="https://jpkb.actiphy.com/?epkb_post_type_1=old-kb-Oracle%E3%81%8C%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%A7-Exit-Code-311%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B">https://jpkb.actiphy.com/?epkb_post_type_1=old-kb-Oracle%E3%81%8C%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%A7-Exit-Code-311%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B</a></li></ul><p>・(Oracle社) VSSを使用したデータベースのバックアップおよびリカバリの目的<br>  ※Oracle DB すべてが VSS に対応しているかはわかりかねます<br><a href="https://docs.oracle.com/cd/F19136_01/ntqrf/purpose-of-database-backup-and-recovery-with-vss.html#GUID-6A44D80C-0427-4DB8-AD3C-BD5426AECC2B">https://docs.oracle.com/cd/F19136_01/ntqrf/purpose-of-database-backup-and-recovery-with-vss.html#GUID-6A44D80C-0427-4DB8-AD3C-BD5426AECC2B</a></p><h3 id="1-4-事前事後スクリプトについて"><a href="#1-4-事前事後スクリプトについて" class="headerlink" title="1.4 事前事後スクリプトについて"></a>1.4 事前事後スクリプトについて<a id="1-4"></a></h3><p>Linux VM 事前事後スクリプトに関しましては、お客様自身で対象のアプリケーション (DBなど) の I/O を停止 / 再開する処理を記載いただく必要がございます。<br>そのため、対象のアプリケーションに対してそのようなコマンド制御ができない場合は、残念ながら事前事後スクリプトを用いることはできません。そのようなコマンド制御が可能かはアプリケーション提供ベンダーまでお問い合わせをいただきますようお願いします。</p><ul><li>参考<br>・Azure Linux VM のアプリケーション整合性バックアップ<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-linux-app-consistent">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-linux-app-consistent</a><br>・git hub 上のサンプル事前事後スクリプト (Oracle や MySQLがございます。)<br><a href="https://github.com/MicrosoftAzureBackup">https://github.com/MicrosoftAzureBackup</a></li></ul><h2 id="2-ファイルシステム整合性"><a href="#2-ファイルシステム整合性" class="headerlink" title="2.ファイルシステム整合性"></a>2.ファイルシステム整合性<a id="2"></a></h2><p>Windows OS のオンライン バックアップを取得した際に一部の VSSライターが失敗した場合や Linux OS でオンライン バックアップを取得した場合 (または 事前事後スクリプトが失敗した場合) にファイルシステム整合性となります。<br>こちらは OS の起動を保証した整合性ですが、アプリケーションレベルでの整合性は担保されておりません。</p><h2 id="3-クラッシュ整合性"><a href="#3-クラッシュ整合性" class="headerlink" title="3.クラッシュ整合性"></a>3.クラッシュ整合性<a id="3"></a></h2><p>スナップショット作成実行時のディスクのデータのみを保存します。<br>アプリケーション整合性やファイルシステム整合性とは異なり、OS 内部とは連携せずスナップショットを取得します。<br>そのため、オフライン状態の VM をバックアップした際にはクラッシュ整合性となります。<br>OS の起動を保証しない整合性ではございますが、<strong>正常に電源が落とされた状態の VM であればメモリ上の情報や I/O の発生はなく、ディスクにしか情報はないため整合性の懸念は全くございません。</strong></p><ul><li>参考 (関連するブログ記事です。)<br>・Azure VM Backup では オフライン バックアップができるのか<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Azure_VM_Offline_backup/">https://jpabrs-scem.github.io/blog/AzureVMBackup/Azure_VM_Offline_backup/</a></li></ul><p>一方、Azure Disk Backup やマネージドディスクのスナップショットなどは、起動中の VM にアタッチされているディスクのスナップショットを取得することが可能ですが、この際のオンライン状態でのスナップショットの整合性は Azure VM Backupとは異なり、クラッシュ整合性となります。<br>整合性は劣るものの、後述の通り DB のない VM であればクラッシュ整合性でも基本的には問題ございません。</p><ul><li>参考<br>・Azure ディスク バックアップの概要<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/disk-backup-overview">https://docs.microsoft.com/ja-jp/azure/backup/disk-backup-overview</a><br>・仮想ハード ディスクのスナップショットを作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/snapshot-copy-managed-disk?tabs=portal">https://docs.microsoft.com/ja-jp/azure/virtual-machines/snapshot-copy-managed-disk?tabs=portal</a></li></ul><p>クラッシュ整合性に関しましては次の公開情報にございますようなイメージをしていただけるとわかりやすいかと存じます。<br> (Azure Site Recovery のドキュメントではございますが、考え方は同じです。)<br>・Azure Site Recovery に関する一般的な質問 - クラッシュ整合性復旧ポイントとは何ですか?<br><a href="https://docs.microsoft.com/ja-jp/azure/site-recovery/site-recovery-faq#---------------------">https://docs.microsoft.com/ja-jp/azure/site-recovery/site-recovery-faq#---------------------</a></p><blockquote><p>クラッシュ整合性復旧ポイントには、スナップショットの作成中にサーバーから電源コードが引き抜かれたときのディスク上のデータが含まれます。 クラッシュ整合性復旧ポイントには、スナップショットの作成時にメモリに入っていたものは一切含まれません。<br>クラッシュ整合性復旧ポイントは通常、データベースのないオペレーティング システムや、ファイル サーバー、DHCP サーバー、プリント サーバーなどのアプリケーションにとっては十分です。</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートの山本です。&lt;br&gt;今回は Azure VM Backup における整合性に関して具体例も踏まえつつご説明させていただきます。&lt;/p&gt;
&lt;p&gt;まず、Azure VM Backu</summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM BackupにおけるRecovery Services コンテナーの変更について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Change_RSV_for_VM/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/Change_RSV_for_VM/</id>
    <published>2022-02-09T03:00:00.000Z</published>
    <updated>2022-06-22T06:34:34.850Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートの山本です。<br>今回はお問い合わせをいただくことが多い、<strong>Azure VM Backup を取得している Recovery Services コンテナーを変更することは可能か？</strong>について説明させていただきます。</p><p>バックアップアイテムが保護されたあとは冗長性の変更をいただくことが出来ないので、 Recovery Services コンテナーを変更いただく必要がございます。<br>ただし、GRS 設定時、CRR 有効化のみ可能です。<br>・ストレージ冗長性の設定<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-create-rs-vault#set-storage-redundancy">https://docs.microsoft.com/ja-jp/azure/backup/backup-create-rs-vault#set-storage-redundancy</a></p><blockquote><p>コンテナーでバックアップを構成する前に、必ず Recovery Services コンテナーのストレージ レプリケーションの種類を変更してください。 バックアップを構成した後、変更するオプションは無効になります。</p></blockquote><p>結論から申し上げますと <strong>Recovery Services コンテナーを変更することは可能</strong>です。</p><p>なお、本件に関連した公式ドキュメントは下記でございます。<br>・Recovery Services コンテナーを作成して構成する - 既定の設定を変更する<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-create-rs-vault#modify-default-settings">https://docs.microsoft.com/ja-jp/azure/backup/backup-create-rs-vault#modify-default-settings</a></p><p>すでにバックアップを構成している　VM に対して Recovery Services コンテナー を変更するには、VM と 既存のRecovery Services コンテナーとの紐づけを解除する必要がございます。<br>紐づけを解除することで、新たに別の Recovery Services コンテナーに紐づけることが可能です。</p><p>紐づけを解除する方法としては 後述の通り２ 種類ございます。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. 既存のバックアップデータを [維持] する方法</a><br> <a href="#1-1"> 1.1 注意事項</a><br> <a href="#1-2"> 1.2 変更手順概要</a><br> <a href="#1-3"> 1.3 手順</a><br><a href="#2">2. 既存のバックアップデータを [削除] する方法</a><br> <a href="#2-1"> 2.1 注意事項</a><br> <a href="#2-2"> 2.2 変更手順概要</a><br> <a href="#2-3"> 2.3 手順</a><br> <a href="#2-3-1"> 2.3.1 論理削除状態について</a><br><a href="#3">3. バックアップデータを残しつつリソースグループを変更しない方法</a><br> <a href="#3-1"> 3.1 手順</a></p><hr><h2 id="1-既存のバックアップデータを-維持-する方法"><a href="#1-既存のバックアップデータを-維持-する方法" class="headerlink" title="1. 既存のバックアップデータを [維持] する方法"></a>1. 既存のバックアップデータを [維持] する方法<a id="1"></a></h2><p> Recovery Services コンテナーと VM の紐づけは VM のリソースグループ名と VM 名によって行っています。<br>この方法ではその仕組みを利用、つまり対象の VM のリソースグループを変更することにより、既存の Recovery Services コンテナーとの紐づけを解除します。<br>なお、リソースグループを変更し新しい Recovery Services コンテナーにてバックアップを構成した場合でも、VM のリソースグループ名を 元のリソースグループに戻した場合、既存の Recovery Services コンテナーと紐づいている状態になります。</p><h3 id="1-1-注意事項"><a href="#1-1-注意事項" class="headerlink" title="1.1 注意事項"></a>1.1 注意事項<a id="1-1"></a></h3><p>こちらの方法では対象の VM のリソースグループの変更が必要です。<br>・Recovery Services コンテナーを作成して構成する<br>    <a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-create-rs-vault#must-preserve-previous-backed-up-data">https://docs.microsoft.com/ja-jp/azure/backup/backup-create-rs-vault#must-preserve-previous-backed-up-data</a></p><blockquote><p>Azure VM の場合は、GRS コンテナー内の VM に対して保護を停止してデータを保持し、VM を別のリソース グループに移動してから、LRS コンテナー内の VM を保護することができます。</p></blockquote><h3 id="1-2-変更手順概要"><a href="#1-2-変更手順概要" class="headerlink" title="1.2 変更手順概要"></a>1.2 変更手順概要<a id="1-2"></a></h3><ol><li>古いRecovery Service コンテナーでのバックアップ停止する</li><li>バックアップ対象の VM のリソースグループを変更する</li><li>新しいRecovery Service コンテナーにてバックアップを構成する</li></ol><h3 id="1-3-手順"><a href="#1-3-手順" class="headerlink" title="1.3 手順"></a>1.3 手順<a id="1-3"></a></h3><p>0-1. Recovery Service コンテナー変更対象の VM の状態を確認 (リソースグループ : rg-1 )<br><img src="https://user-images.githubusercontent.com/71251920/153033255-67f50490-d9e1-4da1-bd32-38b90169176f.jpg" alt="Change_RSV_for_VM_01"></p><p>0-2. Recovery Service コンテナー: rsv-1 にてバックアップ有効化、復旧ポイント作成済み<br><img src="https://user-images.githubusercontent.com/71251920/153033252-b754f533-636e-48b7-954a-64d05b206926.jpg" alt="Change_RSV_for_VM_02"></p><p>1-1. VM のバックアップを停止<br><img src="https://user-images.githubusercontent.com/71251920/153033249-43853045-8fe5-45db-81f8-192f132642c6.jpg" alt="Change_RSV_for_VM_03"></p><p>1-2. 停止の際、バックアップデータ (復旧ポイント) の保持を選択し、理由を記入してバックアップの停止をクリック<br><img src="https://user-images.githubusercontent.com/71251920/153033247-afd58826-d3ab-4a12-a97f-200aed5e8080.jpg" alt="Change_RSV_for_VM_04"></p><p>1-3. バックアップの無効化完了を確認</p><p>(1-4) この状態では別のRecovery Service コンテナーではまだ紐づけが解除されていないためバックアップを有効化できません。<br>(別のRecovery Service コンテナーでバックアップを有効化しようとしても対象に表示されません)<br><img src="https://user-images.githubusercontent.com/71251920/153033243-14e0e75a-aeee-4fa6-9e31-c2d74e63f494.jpg" alt="Change_RSV_for_VM_06"></p><p>2-1. VM &gt; 概要 &gt; リソースグループ 横の移動をクリック<br><img src="https://user-images.githubusercontent.com/71251920/153033242-3bec21b2-4884-49f0-b4a3-79f618e886c8.jpg" alt="Change_RSV_for_VM_07"></p><p>2-2. 移動させたいリソースグループを選択し、次へ<br>2-3. 検証が完了するのを待ち、次へ<br>2-4. 内容を確認し、下部チェックを選択して、移動をクリック<br><img src="https://user-images.githubusercontent.com/71251920/153033238-2dd487ff-b8e1-44b9-af62-2ec16276a830.jpg" alt="Change_RSV_for_VM_08"></p><p>2-5. リソースグループの移動完了を確認<br><img src="https://user-images.githubusercontent.com/71251920/153033235-749eb8ff-5a0e-4573-b736-01bb9232fd8e.jpg" alt="Change_RSV_for_VM_09"></p><p>3-1. 新たにバックアップを取得したい別の Recovery Service コンテナーにて該当の VM のバックアップを有効化<br>    (この時点で別の Recovery Service コンテナーのバックアップ構成の仮想マシン選択欄に該当の VM が表示されるようになります)<br><img src="https://user-images.githubusercontent.com/71251920/153033232-ea02b8b6-f6a5-48d5-b59a-8cd6f20bd115.jpg" alt="Change_RSV_for_VM_10"></p><p>3-2. 今すぐバックアップにてバックアップ完了。<br>新たなRecovery Service コンテナーにて問題なくバックアップできることを確認</p><p><img src="https://user-images.githubusercontent.com/71251920/153033229-353621e5-0fa7-4ffc-9e24-23650542bc4e.jpg" alt="Change_RSV_for_VM_11"></p><p>(3-3) 古いRecovery Service コンテナーには過去の復旧ポイントは残存したままで、この復旧ポイントからも VM を復元することが可能です。<br><img src="https://user-images.githubusercontent.com/71251920/153033227-2c45fbbd-0036-429a-8a33-9dbf06cce622.jpg" alt="Change_RSV_for_VM_12"></p><h2 id="2-既存のバックアップデータを-削除-する方法"><a href="#2-既存のバックアップデータを-削除-する方法" class="headerlink" title="2. 既存のバックアップデータを [削除] する方法"></a>2. 既存のバックアップデータを [削除] する方法<a id="2"></a></h2><p> 既存のRecovery Services コンテナーに保存された対象 VM のバックアップデータを削除することによって、既存の Recovery Services コンテナーと対象の VM との紐づけを解除します。 </p><h3 id="2-1-注意事項"><a href="#2-1-注意事項" class="headerlink" title="2.1 注意事項"></a>2.1 注意事項<a id="2-1"></a></h3><p>こちらの方法では対象VMの 既存のバックアップデータの削除が必要です。<br>・Recovery Services コンテナーを作成して構成する<br>    <a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-create-rs-vault#dont-need-to-preserve-previous-backed-up-data">https://docs.microsoft.com/ja-jp/azure/backup/backup-create-rs-vault#dont-need-to-preserve-previous-backed-up-data</a></p><blockquote><p>新しい LRS コンテナーのワークロードを保護するには、GRS コンテナー内の現在の保護とデータを削除し、バックアップを再構成する必要があります。</p></blockquote><p>また本作業を行う際、バックアップアラートを設定していない場合でも発砲されます。<br>詳細につきましては下記をご確認ください。<br>・バックアップ アラートの通知<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor#notification-for-backup-alerts">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor#notification-for-backup-alerts</a></p><blockquote><p>“破壊的な操作 (データを削除して保護を停止など) が実行されると、アラートが生成され、Recovery Services コンテナー用に通知が構成されていない場合でも、サブスクリプションの所有者、管理者、共同管理者にメールが送信されます。</p></blockquote><h3 id="2-2-変更手順概要"><a href="#2-2-変更手順概要" class="headerlink" title="2.2 変更手順概要"></a>2.2 変更手順概要<a id="2-2"></a></h3><ol><li>古いRecovery Service コンテナーでのバックアップを停止し、バックアップデータを削除する</li><li>新しいRecovery Service コンテナーにてバックアップを構成する</li></ol><h3 id="2-3-手順"><a href="#2-3-手順" class="headerlink" title="2.3 手順"></a>2.3 手順<a id="2-3"></a></h3><p>0-1. Recovery Service コンテナー変更対象の VM の状態を確認 (リソースグループ : rg-1 )<br><img src="https://user-images.githubusercontent.com/71251920/153033224-cee11ab5-892f-4ed0-b085-2222c859c83b.jpg" alt="Change_RSV_for_VM_13"></p><p>0-2. Recovery Service コンテナー: rsv-1 にてバックアップ有効化、復旧ポイント作成済み<br><img src="https://user-images.githubusercontent.com/71251920/153033220-1a7bdbaa-c235-47c1-a999-04ecff700e92.jpg" alt="Change_RSV_for_VM_14"></p><p>1-1. VM のバックアップを停止<br><img src="https://user-images.githubusercontent.com/71251920/153033219-95548634-88d5-4dd1-a6b1-f2a3287402c1.jpg" alt="Change_RSV_for_VM_15"></p><p>1-2. 停止の際、バックアップデータ (復旧ポイント) の削除を選択し、理由を記入してバックアップの停止をクリック<br><img src="https://user-images.githubusercontent.com/71251920/153033215-abe38422-30ba-450e-a27e-773957273cf8.jpg" alt="Change_RSV_for_VM_16"></p><p>1-3. この時、設定 – プロパティ &gt; セキュリティ設定 更新 &gt; 論理削除 が 無効 に設定されていることを確認してください。<br>    バックアップデータは完全に削除される必要があります。<br><img src="https://user-images.githubusercontent.com/71251920/153033211-44a0eab1-f6cf-41ba-908b-e83454025295.jpg" alt="Change_RSV_for_VM_17"></p><ul><li>注意事項： 論理削除状態について<a id="2-3-1"></a><br>論理削除状態(論理削除が有効な状態で削除した状態)では完全にバックアップデータが消えず、対象 VM と  Recovery Services コンテナーの紐づけが解除されません。その際は下記 URL を参考にして論理削除状態のバックアップアイテムを完全に削除してください。<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-security-feature-cloud#permanently-deleting-soft-deleted-backup-items">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-security-feature-cloud#permanently-deleting-soft-deleted-backup-items</a> </li></ul><p>1-4. バックアップデータの削除完了を”  Azure Portal  → 対象のRecovery Services コンテナー → バックアップアイテム → Azure Virtual Machines” から、対象のVMが表示されないことを確認します。</p><p>2-1. 新たにバックアップを取得したい別の Recovery Service コンテナーにて該当の VM のバックアップを有効化<br>    (この時点で別の Recovery Service コンテナーのバックアップ構成の仮想マシン選択欄に該当の VM が表示されるようになります)<br><img src="https://user-images.githubusercontent.com/71251920/153033209-9d8daa07-6052-49e7-ae71-0ba5a7e3a15e.jpg" alt="Change_RSV_for_VM_18"></p><p>2-2. 今すぐバックアップにてバックアップ完了。<br>新たなRecovery Service コンテナーにて問題なくバックアップできることを確認<br><img src="https://user-images.githubusercontent.com/71251920/153033202-587b9bd3-bcd5-41a6-a10f-d6a1bffdbca4.jpg" alt="Change_RSV_for_VM_19"></p><h2 id="3-バックアップデータを残しつつリソースグループを変更しない方法"><a href="#3-バックアップデータを残しつつリソースグループを変更しない方法" class="headerlink" title="3. バックアップデータを残しつつリソースグループを変更しない方法"></a>3. バックアップデータを残しつつリソースグループを変更しない方法<a id="3"></a></h2><p><strong>Azure Backup のデータをそのまま保存し、VM のリソースグループを変更せずに新しい Recovery Services コンテナーに紐づけることは上述した通り、Recovery Services コンテナーと VM の紐づけは VM のリソースグループ名と VM 名によって行ってるためできません。</strong><br><a href="#1">1. 既存のバックアップデータを [維持] する方法</a> によって変更後、リソースグループを戻すと元の Recovery Services コンテナーが残っている場合にはもとの Recovery Services コンテナーに紐づいてしまいます。<br>また、もとの Recovery Services コンテナーが削除された場合には新しい Recovery Services コンテナーとの紐づけが切れ、 Azure VM のバックアップメニューからはバックアップが構成されていない状態になります。</p><p>そのため方法としては、<strong>既存のバックアップデータを一度ディスクとして復元して保存いただくことで可能です</strong>。特定の復元ポイントだけを保存しておけばよいという場合はこちらの手順が利用可能です。<br>もちろん、すべての復元ポイントからディスクとして復元いただければ、すべての バックアップデータを保存することは可能です。</p><p>具体的な手順としては下記です。</p><h4 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順<a id="3-1"></a></h4><ol><li>保存したい復元ポイントからディスクとしてリストアする。<br>詳細は下記をご覧ください<br>・代替案 - Azure VM Backup で取得した復旧ポイントの保持期間の延長について<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToExtendVMRetentionPeriod/#4">https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToExtendVMRetentionPeriod/#4</a></li></ol><ol start="2"><li>その後 上述の<a href="#2">2. 既存のバックアップデータを [削除] する方法</a>によって Recovery Services コンテナーを変更する。</li></ol><hr>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートの山本です。&lt;br&gt;今回はお問い合わせをいただくことが多い、&lt;strong&gt;Azure VM Backup を取得している Recovery Services コンテナーを変更</summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>プロキシを利用した MARS エージェントによるバックアップについて</title>
    <link href="https://jpabrs-scem.github.io/blog/MARSBackup/MARS_Proxy_Setting/"/>
    <id>https://jpabrs-scem.github.io/blog/MARSBackup/MARS_Proxy_Setting/</id>
    <published>2022-02-09T03:00:00.000Z</published>
    <updated>2022-06-22T06:34:34.902Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートの荘司です。<br>今回は、<strong>プロキシを利用した MARS  エージェントによるバックアップの設定例及び挙動</strong>について、認証が必要な場合や pac ファイルをご利用の場合も含めてご案内します。</p><p>MARS エージェント によるバックアップはマシン内のファイルやフォルダーやシステム状態のバックアップを行い Azure 上に保存するバックアップサービスです。<br>対象のバックアップ環境はオンプレミスでも Azure でも可能です。</p><ul><li>参考<br>・Microsoft Azure Recovery Services (MARS) エージェントを使用したバックアップのサポート マトリックス<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mars-agent">https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mars-agent</a></li></ul><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. MARS エージェントのプロパティ設定を利用したプロキシ設定例</a><br><a href="#2">2. Windows のシステムアカウントプロキシ設定を利用した設定例</a><br><a href="#3">3. 認証プロキシを利用する際の設定例</a><br><a href="#4">4. PAC ファイルを利用したプロキシ設定を適用する場合の設定例</a><br><a href="#5">5. MARS Backup と Windows (システムアカウント) の両方にプロキシ設定がある場合の挙動</a><br><a href="#6">6. まとめ</a></p><hr><h2 id="1-MARS-エージェントのプロパティ設定を利用したプロキシ設定例"><a href="#1-MARS-エージェントのプロパティ設定を利用したプロキシ設定例" class="headerlink" title="1. MARS エージェントのプロパティ設定を利用したプロキシ設定例"></a>1. MARS エージェントのプロパティ設定を利用したプロキシ設定例<a id="1"></a></h2><p>本設定に関連した公式ドキュメントは下記でございます。</p><ul><li>参考<br>・Azure Backup MARS エージェントをインストールする - エージェントをインストールして登録する<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/install-mars-agent#install-and-register-the-agent">https://docs.microsoft.com/ja-jp/azure/backup/install-mars-agent#install-and-register-the-agent</a></li></ul><p>MARS のインストール時の下記プロキシ設定に、プロキシ サーバーの IP アドレス及びポートを記入することで、プロキシを利用したバックアップが可能です。</p><p><img src="https://user-images.githubusercontent.com/71251920/152903682-258c22e6-793d-4c62-82d4-20f293c8d330.png" alt="MARS_Proxy_01"></p><ul><li>MARS Backup エージェントのプロキシ設定では PAC ファイルによるプロキシの設定はできません。後述のシステムアカウントを用いたプロキシ設定により可能です。</li></ul><h2 id="2-Windows-のシステムアカウントプロキシ設定を利用した設定例"><a href="#2-Windows-のシステムアカウントプロキシ設定を利用した設定例" class="headerlink" title="2. Windows のシステムアカウントプロキシ設定を利用した設定例 "></a>2. Windows のシステムアカウントプロキシ設定を利用した設定例 <a id="2"></a></h2><p>本設定に関連した公式ドキュメントは下記でございます。</p><ul><li>参考<br>・Windows のプロキシ設定を確認する<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-mars-troubleshoot#verifying-proxy-settings-for-windows">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-mars-troubleshoot#verifying-proxy-settings-for-windows</a></li></ul><p>MARS エージェントが参照する Windows のプロキシ設定はシステムアカウントにて設定する必要がございます。<br>PsExec を用いることにより、設定可能でございます。<br>下記手順は PsExec にて Windows のプロキシ設定する手順をご紹介しております。</p><ol><li><p>下記 URL より PsExec をダウンロードします。<br>・PsExec - Windows Sysinternals | Microsoft Docs<br>　<a href="https://docs.microsoft.com/ja-jp/sysinternals/downloads/psexec">https://docs.microsoft.com/ja-jp/sysinternals/downloads/psexec</a></p></li><li><p>コマンドプロンプトを開き、PsExec のあるフォルダまで移動した後、以下コマンドを実行します。<br>psexec -i -s “c:\Program Files\Internet Explorer\iexplore.exe”</p></li><li><p>以下画面が出た場合は Agree をクリックしてください。<br><img src="https://user-images.githubusercontent.com/71251920/152903684-37a1b7d4-8e85-4e6a-92df-7f5cb0faba7a.png" alt="MARS_Proxy_02"></p></li><li><p>Internet Explorerが起動されますので、[ツール] &gt; [インターネット オプション] &gt; [接続] &gt; [ LAN の設定] より、プロキシサーバーの IP アドレス及びポートを記入します。<br><img src="https://user-images.githubusercontent.com/71251920/152903686-eadf5857-01e8-40fa-89a6-6d8337c4be12.png" alt="MARS_Proxy_03"></p></li><li><p>Windows のプロキシ設定がされている場合、MARS インストール時にプロキシ設定をしなくても、プロキシを利用したバックアップが可能です。</p></li></ol><h2 id="3-認証プロキシを利用する際の設定例"><a href="#3-認証プロキシを利用する際の設定例" class="headerlink" title="3. 認証プロキシを利用する際の設定例 "></a>3. 認証プロキシを利用する際の設定例 <a id="3"></a></h2><p>MARS のインストール時に下記プロキシ設定に、プロキシサーバーの IP アドレス及びポート、認証の際のユーザーネーム、パスワードを記入することで、認証プロキシを利用したバックアップが可能です。<br>*<a href="#2">2. の Windows のシステムアカウントプロキシ設定</a>だけでは認証が通らないため、認証プロキシの設定はできません。<br><img src="https://user-images.githubusercontent.com/71251920/152904399-0e4149d2-2911-4516-bcdd-938ea9fbaa0c.png" alt="MARS_Proxy_04"></p><h2 id="4-PAC-ファイルを利用したプロキシ設定を適用する場合の設定例"><a href="#4-PAC-ファイルを利用したプロキシ設定を適用する場合の設定例" class="headerlink" title="4. PAC ファイルを利用したプロキシ設定を適用する場合の設定例 "></a>4. PAC ファイルを利用したプロキシ設定を適用する場合の設定例 <a id="4"></a></h2><ol><li><p> <a href="#2">2. の Windows のシステムアカウントプロキシ設定</a>の 1 から 3 の手順によって Internet Explorer を起動します。</p></li><li><p>[ツール] &gt; [インターネット オプション] &gt; [接続] &gt; [ LAN の設定] より、PAC ファイルの URL を記入することで、PAC ファイルの設定によるプロキシを利用したバックアップが可能です。<br><img src="https://user-images.githubusercontent.com/71251920/152903691-9d2000f4-2f9f-4748-b2e1-442de641449e.png" alt="MARS_Proxy_05"></p></li></ol><h2 id="5-MARS-Backup-と-Windows-システムアカウント-の両方にプロキシ設定がある場合の挙動"><a href="#5-MARS-Backup-と-Windows-システムアカウント-の両方にプロキシ設定がある場合の挙動" class="headerlink" title="5.  MARS Backup と Windows (システムアカウント) の両方にプロキシ設定がある場合の挙動 "></a>5.  MARS Backup と Windows (システムアカウント) の両方にプロキシ設定がある場合の挙動 <a id="5"></a></h2><p>MARS Backup エージェントのプロパティと Windows の両方にプロキシの設定がされている場合は、MARS Backup エージェントに設定されている内容が優先されます。</p><h2 id="6-まとめ"><a href="#6-まとめ" class="headerlink" title="6.  まとめ "></a>6.  まとめ <a id="6"></a></h2><p>各シナリオと設定例、及び優先される設定を以下の表にまとめますので、プロキシ設定の際のご参考にしていただければ幸いです。<br> ① MARS のプロキシ設定とは<a href="#1">1. MARS エージェントのプロパティ設定を利用したプロキシ設定</a>です。<br> ② Windows のプロキシ設定とは<a href="#2">2. Windows のシステムアカウントプロキシ設定</a>です。<br><img src="https://user-images.githubusercontent.com/71251920/152903692-27e268c0-7e89-44a4-ab36-1430047dde2e.png" alt="MARS_Proxy_06"><br>① はプロキシサーバーの IP アドレス、プロキシサーバーのポート、認証プロキシのユーザーネーム、認証プロキシのユーザーのパスワードを設定可能<br>② はプロキシサーバーの IP アドレス、プロキシサーバーのポート又は PAC ファイルの URL 設定を設定可能</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートの荘司です。&lt;br&gt;今回は、&lt;strong&gt;プロキシを利用した MARS  エージェントによるバックアップの設定例及び挙動&lt;/strong&gt;について、認証が必要な場合や pac</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="MARS Backup" scheme="https://jpabrs-scem.github.io/blog/tags/MARS-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure Backup におけるウイルス除外設定について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/AV_ExcludeSetting/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/AV_ExcludeSetting/</id>
    <published>2022-02-06T03:00:00.000Z</published>
    <updated>2022-06-22T06:34:34.850Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートの山本です。<br>今回はお問い合わせをいただくことが多い、 <strong>Azure Backup を利用する際のウイルス検知の除外設定</strong>  について、Azure VM Backup と MARS バックアップの場合それぞれについてご説明させていただきます。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Azure VM Backup の場合のウイルス検知除外設定</a><br> <a href="#1-1">1-1. Windows OS の場合</a><br> <a href="#1-2">1-2. Linux OS の場合</a><br><a href="#2">2. MARS バックアップの場合のウイルス検知除外設定</a></p><hr><h2 id="1-Azure-VM-Backup-の場合のウイルス検知除外設定"><a href="#1-Azure-VM-Backup-の場合のウイルス検知除外設定" class="headerlink" title="1. Azure VM Backup の場合のウイルス検知除外設定"></a>1. Azure VM Backup の場合のウイルス検知除外設定<a id="1"></a></h2><p>Azure VM Backup とは Azure 上の VM に対するバックアップサービスです。<br>・Azure VM バックアップの概要<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction</a></p><p>Windows OS と Linux OS に場合分けしてお伝えします。</p><h3 id="1-1-Windows-OS-の場合"><a href="#1-1-Windows-OS-の場合" class="headerlink" title="1-1. Windows OS の場合"></a>1-1. Windows OS の場合<a id="1-1"></a></h3><p>Windows OS の場合、下記をアンチウイルス ソフトの除外設定にいれてください。</p><blockquote><p>C:\Packages\Plugins\Microsoft.Azure.RecoveryServices.VMSnapshot<br>C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.RecoveryServices.VMSnapshot</p></blockquote><p>なお、上記は下記の公式ドキュメントにも記載されております。<br>・Azure Backup の失敗のトラブルシューティング:エージェント/拡張機能に関する問題 - 手順 4:Azure Backup VM 拡張機能の正常性を確認する<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout#step-4-check-azure-backup-extension-health">https://docs.microsoft.com/ja-jp/azure/backup/https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout#step-4-check-azure-backup-extension-health</a></p><p>・VMRestorePointInternalError - VM で構成されているウイルス対策により、バックアップ拡張機能の実行が制限されています<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#vmrestorepointinternalerror---antivirus-configured-in-the-vm-is-restricting-the-execution-of-backup-extension">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#vmrestorepointinternalerror---antivirus-configured-in-the-vm-is-restricting-the-execution-of-backup-extension</a></p><h3 id="1-2-Linux-OS-の場合"><a href="#1-2-Linux-OS-の場合" class="headerlink" title="1-2. Linux OS の場合"></a>1-2. Linux OS の場合<a id="1-2"></a></h3><p>Linux OS の場合、下記をアンチウイルス ソフトの除外設定にいれてください。</p><blockquote><p>/var/lib/waagent/WALinuxAgent<br>/var/lib/waagent/Microsoft.Azure.RecoveryServices.VMSnapshotLinux</p></blockquote><h3 id="2-MARS-バックアップの場合のウイルス検知除外設定"><a href="#2-MARS-バックアップの場合のウイルス検知除外設定" class="headerlink" title="2 .MARS バックアップの場合のウイルス検知除外設定"></a>2 .MARS バックアップの場合のウイルス検知除外設定<a id="2"></a></h3><p>MARS バックアップ (Azure MARS Backup エージェントを利用したバックアップ) とはクラウドかオンプレミス環境かを問わず、Windows OS において、ファイルとフォルダー単位のバックアップやシステム状態のバックアップを 取得し Azure 上に保存するバックアップサービスです。</p><p>・Microsoft Azure Recovery Services (MARS) エージェントを使用したバックアップのサポート マトリックス<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mars-agent">https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mars-agent</a></p><p>MARS バックアップをお使いの場合、下記をアンチウイルス ソフトの除外設定にいれてください。</p><blockquote><p>C:\Program Files\Microsoft Azure Recovery Services Agent\bin\cbengine.exe (プロセスとして除外)<br>C:\Program Files\Microsoft Azure Recovery Services Agent\<br>スクラッチ場所 (標準的の場所を使用していない場合)</p></blockquote><p>なお、上記は下記の公式ドキュメントにも記載されております。<br>・Azure Backup でファイルとフォルダーのバックアップが遅い場合のトラブルシューティング - 原因: Azure Backup の妨げになっている別のプロセスまたはウイルス対策ソフトウェア<br>  <a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-troubleshoot-slow-backup-performance-issue#cause-another-process-or-antivirus-software-interfering-with-azure-backup">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-troubleshoot-slow-backup-performance-issue#cause-another-process-or-antivirus-software-interfering-with-azure-backup</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートの山本です。&lt;br&gt;今回はお問い合わせをいただくことが多い、 &lt;strong&gt;Azure Backup を利用する際のウイルス検知の除外設定&lt;/strong&gt;  について、Az</summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup で取得した復旧ポイントの保持期間の延長について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToExtendVMRetentionPeriod/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToExtendVMRetentionPeriod/</id>
    <published>2022-02-05T03:00:00.000Z</published>
    <updated>2022-06-22T06:34:34.850Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、 <strong>Azure VM Backup として取得済の復元ポイントの保持期限を延長できるかという点</strong> についてご案内いたします。</p><p>Azure VM Backup 関連のお問い合わせで、以下のようなお問い合わせを多くいただきます。</p><ol><li>バックアップ ポリシーに従って取得済の復元ポイントの保持期間を延長することは可能か</li><li>バックアップ ポリシーに従って取得済の復元ポイントの中の、特定の復元ポイントのみの保持期間を延長して保持しておくことは可能か</li><li>「今すぐバックアップ」にて取得済の復元ポイントの保持期間を延長して保持しておくことは可能か</li></ol><p>結論から申し上げますと、<em><strong>1. は可能でございますが、2. 3. については保持期間を延長して保持しておくことはかないません。</strong></em></p><p>バックアップポリシーにてスケジュールバックアップで取得した復元ポイントはポリシーによって管理されますが、「今すぐバックアップ」にて取得した復元ポイントはバックアップ時に設定した保持期限に従い管理されます。<br>即ち、<em><strong>「今すぐバックアップ」の保持期限はバックアップポリシーの設定内容の影響を受けません。</strong></em>(ただし、インスタントリストアの保持期限はバックアップポリシーに従います。)</p><p>また <strong>Azure Backup では無期限に保存するような設定はできません</strong>。</p><p>代替案含め、下記にてご説明いたします。</p><h2 id="1-バックアップ-ポリシーに従って取得済の復元ポイントの保持期間を延長することは可能か"><a href="#1-バックアップ-ポリシーに従って取得済の復元ポイントの保持期間を延長することは可能か" class="headerlink" title="1. バックアップ ポリシーに従って取得済の復元ポイントの保持期間を延長することは可能か"></a>1. バックアップ ポリシーに従って取得済の復元ポイントの保持期間を延長することは可能か<a id="1"></a></h2><p>対象の仮想マシンに適用しているバックアップ ポリシー内の保持期間を変更することで、これまで取得済の復元ポイントに対しても保持期間を延長することが可能でございます。<br>例えば、週次 (日次) にて取得する復元ポイント（バックアップ ポイント）に対する保持期間の変更は、すでに週次 (日次) にて取得した復元ポイントに対しても変更が適用されます。</p><p>下記の弊社公開情報をご覧ください。<br>・アーキテクチャの概要 -  復旧ポイントに対するポリシーの変更の影響<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-architecture#impact-of-policy-change-on-recovery-points">https://docs.microsoft.com/ja-jp/azure/backup/backup-architecture#impact-of-policy-change-on-recovery-points</a></p><p><img src="https://user-images.githubusercontent.com/71251920/151024656-f6589f03-6965-47ad-9848-36742f9e3e7e.png" alt="HowToExtendVMRetentionPeriod_01"></p><h2 id="2-バックアップ-ポリシーに従って取得済の復元ポイントの中の、特定の復元ポイントのみの保持期間を延長して保持しておくことは可能か"><a href="#2-バックアップ-ポリシーに従って取得済の復元ポイントの中の、特定の復元ポイントのみの保持期間を延長して保持しておくことは可能か" class="headerlink" title="2. バックアップ ポリシーに従って取得済の復元ポイントの中の、特定の復元ポイントのみの保持期間を延長して保持しておくことは可能か"></a>2. バックアップ ポリシーに従って取得済の復元ポイントの中の、特定の復元ポイントのみの保持期間を延長して保持しておくことは可能か<a id="2"></a></h2><h2 id="3-「今すぐバックアップ」にて取得済の復元ポイントの保持期間を延長して保持しておくことは可能か"><a href="#3-「今すぐバックアップ」にて取得済の復元ポイントの保持期間を延長して保持しておくことは可能か" class="headerlink" title="3. 「今すぐバックアップ」にて取得済の復元ポイントの保持期間を延長して保持しておくことは可能か"></a>3. 「今すぐバックアップ」にて取得済の復元ポイントの保持期間を延長して保持しておくことは可能か<a id="3"></a></h2><p>バックアップ ポリシー上で「保持期間」を変更した場合、これまで取得してきたすべての復元ポイントに対して、ポリシーの変更が適用されます。<br>残念ながら、これまで取得してきた復元ポイントのうち、「ある特定の復元ポイントのみ」の保持期間を延長して保持しておく、ということはかないません。</p><p>また、「今すぐバックアップ」（オンデマンド バックアップ）にて取得した復元ポイントの保持期間も延長することはかないません。(「今すぐバックアップ」の保持期限はバックアップポリシーの設定内容の影響を受けないため)<br>上記 2. 3. をご所望の場合は、下記代替案の通り、対象の復元ポイントからディスクとして復元しておき、ご利用者様にてディスクを保持していただくことをお勧めします。</p><h3 id="代替案"><a href="#代替案" class="headerlink" title="代替案"></a>代替案<a id="4"></a></h3><p>対象の仮想マシン ＞ 「VM の復元」をクリック ＞ 「復元ポイント」にて、保持しておきたい特定の復元ポイントを選択します。<br>「構成の復元：新規作成」「復元の種類：ディスクの復元」を選択のうえ、「復元」をクリックします。<br><strong>復元されたディスクは、ご利用者様にてディスクを削除しない限り、保持され続けます。</strong></p><p>復元されたからディスクを既存の VM にアタッチすることや、既存の VM とディスクをスワップすること、および、復元されたディスクを使って新規 VM を作成することが可能です。</p><p><img src="https://user-images.githubusercontent.com/71251920/151024649-a76bd670-cc4c-4dc6-9b89-7849ca86f7e2.gif" alt="HowToExtendVMRetentionPeriod_02"></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考<a id="5"></a></h2><p>・Azure VM Backupでリストアされるディスク名に関して<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/About_Restored_Disk/">https://jpabrs-scem.github.io/blog/AzureVMBackup/About_Restored_Disk/</a><br>・Azure VM Backup にて取得した復元ポイントの保持期限を確認する方法<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/">https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、 &lt;strong&gt;Azure VM Backup として取得済の復元ポイントの保持期限を延長できるかという点&lt;/strong&gt; についてご案内いたします。</summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM のリストア (既存を置換) が失敗する</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Restorefail_invalid_protection/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Restorefail_invalid_protection/</id>
    <published>2022-02-05T03:00:00.000Z</published>
    <updated>2022-06-22T06:34:34.850Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートの山本です。<br>今回は、Azure VM Backup にて、対象の仮想マシンを <strong>「VM の復元」-「構成の復元：既存を置換」にて「復元」を実行すると、「OlrBackupFailed」エラーが発生する</strong>場合の原因と対処法についてご案内します。</p><p>上記「OlrBackupFailed」エラーが発生した場合、考えられる要因として、対象の仮想マシンに対して「バックアップの停止」を行っていることが考えられます。<br>（対象の仮想マシンに対して「バックアップの停止」を行っていない、後述のシナリオに合致しない等あれば、弊社までお問い合わせ願います。）</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#0">0.【前提】対象の VM の電源は停止しておく必要がございます</a><br><a href="#1">1. 該当シナリオ</a><br><a href="#2">2. 原因</a><br><a href="#3">3. 「構成の復元：既存を置換」として復元したい場合の回避策</a></p><hr><h3 id="【前提】対象の-VM-は停止してください。"><a href="#【前提】対象の-VM-は停止してください。" class="headerlink" title="【前提】対象の VM は停止してください。"></a>【前提】対象の VM は停止してください。<a id="0"></a></h3><p>既存を置換 にて復元する場合、ディスクのリストア後、対象 VM に対してディスクのスワップが実施されるため、対象の VM の電源は停止しておく必要がございます。<br>作業実施前にの画面ショットのように ”停止済み(割り当て解除)” であることを確認してください。<br><img src="https://user-images.githubusercontent.com/71251920/152478015-6ef0aea5-4143-4347-99b3-1eea5ec42b06.png" alt="OLR_premise_01"></p><p>VM を起動したまま実施した場合、下記のような Error Message、および 画面となり失敗します。(リストアのトリガー自体ができません。)<br>その場合は、上記の画面ショットの状態になるように VM の電源 を停止してください。</p><blockquote><p>エラー コード    UserErrorVmNotShutDown<br>エラー メッセージ    VM needs to be in deallocated state for performing replace disks operation<br>推奨される操作    Please shut down the VM, and retry</p></blockquote><p><img src="https://user-images.githubusercontent.com/71251920/152478012-f216f599-44e5-4e0f-913e-5c0013071509.png" alt="OLR_premise_02"></p><h2 id="1-該当シナリオ"><a href="#1-該当シナリオ" class="headerlink" title="1. 該当シナリオ"></a>1. 該当シナリオ<a id="1"></a></h2><p>１） 「VM の復元」を実行したい仮想マシンに対して、「バックアップの停止」を実施済である<br>（下図のように、「バックアップの停止」ボタンが非活性、「バックアップの再開」ボタンが活性、「前回のバックアップの状態：警告（バックアップが無効）」と表示されている状態となります）<br><img src="https://user-images.githubusercontent.com/71251920/148112964-af3db82c-a70e-4fe0-bdab-8d0dddc58086.png" alt="invalid_VM_backup"></p><p>２）上記「バックアップの停止」を実施済の状態で、「VM の復元」をクリックし、「構成の復元：既存を置換」を選択している状態で「復元」を実行する<br><img src="https://user-images.githubusercontent.com/71251920/148112978-b25ab648-9245-4db6-a81e-bc7279595399.png" alt="VM_OLR"></p><p>３）「バックアップ ジョブ」画面にて、以下の状態で処理が終了する。<br>「Operation : Restore」・・・「StatusCompleted with warnings」「Error Code : OlrBackupFailed」<br>「Operation : Backup」・・・「Status : Failed」「Error Code : UserErrorBcmDatasourceNotPresent」<br><img src="https://user-images.githubusercontent.com/71251920/148112973-7caf6f19-c212-4f22-90ea-558998abc2d7.png" alt="OLR_Error_Jobs"><br>（「Operation : Restore」側の詳細画面）<br><img src="https://user-images.githubusercontent.com/71251920/148112977-0cd72cb6-c2bb-403f-8100-cd25a5b02b44.png" alt="Restore_error_details"><br>（「Operation : Backup」側の詳細画面）<br><img src="https://user-images.githubusercontent.com/71251920/148112975-73526fb8-4586-4cc9-863e-c3d314999398.png" alt="Backup_error_details"></p><p>上記のシナリオてに合致した場合、「復元」がエラーコード「OlrBackupFailed」となる理由は、仮想マシンに対して、「バックアップの停止」が行われているためである可能性が高いです。</p><h2 id="2-原因"><a href="#2-原因" class="headerlink" title="2. 原因"></a>2. 原因<a id="2"></a></h2><p>「構成の復元：既存を置換」で「復元」を実行した場合、復元の流れとして、復元ポイントからディスクが復元された後、「復元されたディスクに置換する前の仮想マシンの状態」に対するバックアップ（※）が実施されます。<br>「復元されたディスクに置換する前の仮想マシンの状態」に対するバックアップ（※）が成功した場合、復元されたディスクとの置換作業が実施されます。<br>「バックアップの停止」中の場合は、（※）のバックアップ処理が行えず「Status：Failed」となり、復元ジョブもエラーコード「OlrBackupFailed」となります。<br>仮想マシンに対するディスクの置換は行われず、指定した復元ポイント時点のディスクが復元され、Azure ポータル画面の「ディスク」一覧にて確認可能となります。</p><h2 id="3-「構成の復元：既存を置換」として復元したい場合の回避策"><a href="#3-「構成の復元：既存を置換」として復元したい場合の回避策" class="headerlink" title="3. 「構成の復元：既存を置換」として復元したい場合の回避策"></a>3. 「構成の復元：既存を置換」として復元したい場合の回避策<a id="3"></a></h2><p>下記の 2 種類の方法が考えられます。<br>１．対象の仮想マシンに対して、「バックアップの再開」をクリックし、バックアップを有効にした状態で、再度「VM の復元」-「構成の復元：既存を置換」を実施する。<br>これにより、復元時に自動トリガーされるバックアップ ジョブ（※）も正常に実施され、復元ジョブも成功します。<br><img src="https://user-images.githubusercontent.com/71251920/148112970-9689b050-a986-4de4-b752-274624c4a17e.gif" alt="VM_backup_resume"></p><p>２．対象の仮想マシンに対して、「バックアップの停止」を実施済の状態のまま、「VM の復元」-「構成の復元：既存を置換」を実施する。<br>この場合、前述の通り「Operation : Restore」「StatusCompleted with warnings」となりますが、ディスクとしては復元されます。<br>ディスクとして復元後、対象の仮想マシンを「停止済み (割り当て解除)」としている状態で、仮想マシンにアタッチされているディスクと、復元したディスクを手動でスワップすることで、復元ポイント時点の仮想マシンの状態に戻すことが可能です。</p><p>Azure Portal ＞  対象の仮想マシン ＞ 左ペインのディスク ＞ 「OSディスクのスワップ」にて復元されたディスクと現在のディスクをスワップします。<br><img src="https://user-images.githubusercontent.com/71251920/148112967-eaab9628-7f5e-4fd4-a11f-63faa6ad75b5.jpg" alt="Disk_Swap"></p><p>「既存を置換」にて「復元」を実行すると、「OlrBackupFailed」エラーが発生するという場合の対処法について、ご案内は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートの山本です。&lt;br&gt;今回は、Azure VM Backup にて、対象の仮想マシンを &lt;strong&gt;「VM の復元」-「構成の復元：既存を置換」にて「復元」を実行すると、「O</summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
    <category term="TROUBLE SHOOTING" scheme="https://jpabrs-scem.github.io/blog/tags/TROUBLE-SHOOTING/"/>
    
  </entry>
  
  <entry>
    <title>SCOM 2012 R2 エージェントのアンインストール時のトラブル事例</title>
    <link href="https://jpabrs-scem.github.io/blog/SystemCenter/SCOM_2012R2_Uninstall-TroubleCase/"/>
    <id>https://jpabrs-scem.github.io/blog/SystemCenter/SCOM_2012R2_Uninstall-TroubleCase/</id>
    <published>2022-02-04T03:00:00.000Z</published>
    <updated>2022-06-22T06:34:34.914Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 佐藤 です。</p><p>本日は System Center Operations Manager（以後 SCOM）のエージェントの入れ替え作業の失敗事例をご紹介いたします。<br>2022 年 1 月現在の状況として、（<a href="https://docs.microsoft.com/ja-jp/lifecycle/products/microsoft-system-center-2012-r2-operations-manager">SCOM 2012 R2の延長サポートのフェーズが2022年7月に終了</a>）することに伴い、SCOM 2016や2019 など後継バージョンの環境を新規構築して移行を進めている、もしくはご計画されているお客様もいるかと存じます。</p><p>その際、監視対象コンピューターにて <strong>SCOM 2012 R2 のエージェントのアンインストールを行う事となりますが、アンインストール時に想定外に発生したトラブル事例</strong>についてご紹介いたします。</p><p>アンインストールした際には下記パスのように SCOM エージェント専用のフォルダやフォルダ配下のファイルが削除されるのは当然ですが、その他に別ソフトウェアでも使用するファイルが配置しているフォルダにある SCOM エージェント で使用するファイルも削除する対象となります。</p><blockquote><p>例）<br>SCOM エージェント専用のフォルダの例<br>　C:\Program Files\Microsoft Monitoring Agent\Agent<br>別ソフトウェアでも使用するファイルが配置しているフォルダの例<br>　C:\Windows\System32</p><p>上記例に記載しているフォルダ「C:\Windows\System32」からは以下ファイルが削除対象となります。<br>　AcsMsgs.dll<br>　AdtAgent.exe<br>　InterceptCounters.dll<br>　msvcp100.dll<br>　msvcr100.dll</p></blockquote><p>通常他ソフトウェアで上記ファイルを使用している場合は Windows のレジストリの設定値（複数のプログラムで使用しているため、アンインストールしない設定）によりアンインストール時に削除されないようになっているはずが、その設定がされておらず想定外にファイル msvcp100.dll が削除される事例がございました。</p><h4 id="■レジストリ設定個所"><a href="#■レジストリ設定個所" class="headerlink" title="■レジストリ設定個所"></a>■レジストリ設定個所</h4><blockquote><p>　HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\SharedDLLs</p></blockquote><p>当事象は基本発生しないはずですが、万一発生してしまった場合は削除されたファイルを再度インストールする事で基本は復旧いたします。<br>必要なファイルについては各ソフトウェア次第でございますので、ここでのご説明は省略させていただきますが、上記ファイル msvcp100.dll の例でしたら当ファイル含むランタイム一式を下記サイトから取得いただき、再度インストールいただく事で復旧いたしました。<br>x86 と x64 については、今回消失してしまったモジュールにあわせて選択していただく必要がありますのでご留意ください。<br><a href="https://www.microsoft.com/ja-jp/download/details.aspx?id=26999">https://www.microsoft.com/ja-jp/download/details.aspx?id=26999</a> </p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 佐藤 です。&lt;/p&gt;
&lt;p&gt;本日は System Center Operations Manager（以後 SCOM）のエージェントの入れ替え作業の失敗事例をご紹介</summary>
      
    
    
    
    
    <category term="System Center" scheme="https://jpabrs-scem.github.io/blog/tags/System-Center/"/>
    
    <category term="SCOM" scheme="https://jpabrs-scem.github.io/blog/tags/SCOM/"/>
    
  </entry>
  
  <entry>
    <title>SCOM エージェントの入れ替え作業の失敗事例</title>
    <link href="https://jpabrs-scem.github.io/blog/SystemCenter/SCOM_agent_failures/"/>
    <id>https://jpabrs-scem.github.io/blog/SystemCenter/SCOM_agent_failures/</id>
    <published>2022-01-28T03:00:00.000Z</published>
    <updated>2022-06-22T06:34:34.914Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 佐藤 です。</p><p>本日は System Center Operations Manager（以後 SCOM）  のエージェントの入れ替え作業の失敗事例をご紹介いたします。<br>2022 年 1 月現在の状況として、（<a href="https://docs.microsoft.com/ja-jp/lifecycle/products/microsoft-system-center-2012-r2-operations-manager">SCOM 2012 R2の延長サポートのフェーズが2022年7月に終了</a>）することに伴い、SCOM 2016や2019 など後継バージョンの環境を新規構築して移行を進めている、もしくはご計画されているお客様もいるかと存じます。</p><p>その際、監視対象コンピューターにて SCOM 2012 R2 のエージェントのアンインストールを行い、SCOM 2016 や 2019 のエージェントをインストールすることになりますが、<strong>アンインストール時に想定通り削除が出来ず、SCOM 2012 R2 向けのレジストリ設定やフォルダが残存してしまい SCOM エージェントをインストールする際に失敗する事例</strong>が発生しております。</p><h2 id="Error-Message"><a href="#Error-Message" class="headerlink" title="Error Message"></a>Error Message</h2><p>具体的にはプッシュインストール時には下記のようなインストール失敗メッセージが出力されます</p><blockquote><p>リモート コンピューター &lt;&lt;コンピューターFQDN&gt;&gt; のエージェント管理オペレーションは エージェントのインストール に失敗しました。<br>インストール アカウント: XXX<br>エラー コード: 80070643<br>エラーの説明: インストール中に致命的なエラーが発生しました。<br>Microsoft インストーラーのエラーの説明:<br>詳細については、管理サーバーの Windows インストーラーのログ ファイル “C:\Program Files\Microsoft System Center 2016\Operations &gt;Manager\Server\AgentManagement\AgentLogs\xxxAgentInstall.LOG<br>C:\Program Files\Microsoft System Center 2016\Operations Manager\Server\AgentManagement\AgentLogs\XXXMOMAgentMgmt.log” を参照してください。 </p></blockquote><h2 id="対処策"><a href="#対処策" class="headerlink" title="対処策"></a>対処策</h2><p>当事象が発生した際には<br>下記に記載するフォルダとレジストリを確認いただき、残存している場合は削除いただきますようお願いします。</p><p>※下記 2 つの値は環境によりで異なっております。</p><blockquote><p>D996D247BE65CC940AA413D70EF113DC<br>742D699D-56EB-49CC-A04A-317DE01F31CD</p></blockquote><p>以下のように確認いただき、お客様環境の文字列に読み替えをお願いします。</p><p>・D996D247BE65CC940AA413D70EF113DC<br>パス「HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Products」において<br>下図のように [InstallProperties] の [DisplayName] が “Microsoft Monitoring Agent”となっている箇所の フォルダ名</p><p>下図の確認結果として ”D996D247BE65CC940AA413D70EF113DC” を ”5C0796876F6E14A42B83EA524D9BE1AE” に読み替えます。<br><img src="https://user-images.githubusercontent.com/71251920/151289630-3ed34906-47a7-467f-ac70-4bf269148ce7.gif" alt="SCOM_agent_failures_01"></p><p>・742D699D-56EB-49CC-A04A-317DE01F31CD<br>パス「HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\」において<br>下図のように [DisplayName] が “Microsoft Monitoring Agent”となっている箇所の フォルダ名</p><p>下図の確認結果として ”742D699D-56EB-49CC-A04A-317DE01F31CD” を”786970C5-E6F6-4A41-B238-AE25D4B91EEA” に読み替えます。<br><img src="https://user-images.githubusercontent.com/71251920/151289631-00aa5d7c-8b20-4bf3-baca-4baefd861d66.gif" alt="SCOM_agent_failures_02"></p><h3 id="削除対象のレジストリ"><a href="#削除対象のレジストリ" class="headerlink" title="削除対象のレジストリ"></a>削除対象のレジストリ</h3><p>・全てフォルダとなります。keyではございません。<br>・2行目の[XXXX\C96403E8AD6025B4F9E1FE9C574E34AE]は固定文字列のフォルダとなります。</p><p>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Products\D996D247BE65CC940AA413D70EF113DC<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UpgradeCodes\C96403E8AD6025B4F9E1FE9C574E34AE<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Components\D9960A263C3B3F948AE9C9793043B7C9<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall{742D699D-56EB-49CC-A04A-317DE01F31CD}<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\System Center<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\System Center Operations Manager<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft Operations Manager<br>HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Installer\Products\D996D247BE65CC940AA413D70EF113DC<br>HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Installer\Features\D996D247BE65CC940AA413D70EF113DC<br>HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Installer\UpgradeCodes\C96403E8AD6025B4F9E1FE9C574E34AE<br>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\MOMConnector<br>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\HealthService<br>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\System Center Management APM</p><h3 id="削除対象のフォルダ"><a href="#削除対象のフォルダ" class="headerlink" title="削除対象のフォルダ"></a>削除対象のフォルダ</h3><p>C:\Windows\Installer{742D699D-56EB-49CC-A04A-317DE01F31CD}<br>C:\Program Files\Common Files\Microsoft Shared\Operations Manager</p><p>上記レジストリ及びフォルダの確認、削除が完了しましたらここで OS の再起動をお願いします。</p><p>確認および削除手順は以上となります。新規エージェントをインストールする際に失敗する事象が発生した際は、ぜひ一度上記確認をお願いいたします。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 佐藤 です。&lt;/p&gt;
&lt;p&gt;本日は System Center Operations Manager（以後 SCOM）  のエージェントの入れ替え作業の失敗事例をご</summary>
      
    
    
    
    
    <category term="System Center" scheme="https://jpabrs-scem.github.io/blog/tags/System-Center/"/>
    
    <category term="SCOM" scheme="https://jpabrs-scem.github.io/blog/tags/SCOM/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup にて取得した復元ポイントの保持期限を確認する方法</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/</id>
    <published>2022-01-26T03:00:00.000Z</published>
    <updated>2022-06-22T06:34:34.850Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、<strong>Azure VM Backup にて取得した復元ポイントの保持期限を確認する方法</strong> について、ご案内いたします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. スケジュール バックアップにて取得した復元ポイントの保持期限を確認されたい場合</a><br><a href="#2">2. 「今すぐバックアップ」にて取得した復元ポイントの保持期限を確認されたい場合</a><br> <a href="#2-1"> 2-1. Azure ポータル画面から確認する</a><br> <a href="#2-2"> 2-2. Azure ポータル画面より、定期的に csv へエクスポートする</a><br><a href="#3">3. 参考 - 改善リクエストについて</a></p><hr><h2 id="1-スケジュール-バックアップにて取得した復元ポイントの保持期限を確認されたい場合"><a href="#1-スケジュール-バックアップにて取得した復元ポイントの保持期限を確認されたい場合" class="headerlink" title="1. スケジュール バックアップにて取得した復元ポイントの保持期限を確認されたい場合"></a>1. スケジュール バックアップにて取得した復元ポイントの保持期限を確認されたい場合<a id="1"></a></h2><p>スケジュール バックアップにて取得する復元ポイントは、バックアップ ポリシーにて設定した保持期限に従って保持されますので、設定しているバックアップ ポリシーを参照ください。</p><p>Recovery Services コンテナー ＞ バックアップ ポリシー にて確認可能です。<br>もしくは、下図のように Recovery Services コンテナー ＞ バックアップ アイテム ＞ Azure Virtual Machine ＞ 対象の仮想マシンを選択し、「バックアップ ポリシー」を確認可能です。</p><p><img src="https://user-images.githubusercontent.com/71251920/151015032-1fe8bebd-1246-42f0-9ff0-8a511b7c9ef0.png" alt="HowToCheckRetentionPeriodForVMBackup_01"></p><h2 id="2-「今すぐバックアップ」にて取得した復元ポイントの保持期限を確認されたい場合"><a href="#2-「今すぐバックアップ」にて取得した復元ポイントの保持期限を確認されたい場合" class="headerlink" title="2. 「今すぐバックアップ」にて取得した復元ポイントの保持期限を確認されたい場合"></a>2. 「今すぐバックアップ」にて取得した復元ポイントの保持期限を確認されたい場合<a id="2"></a></h2><h3 id="2-1-Azure-ポータル画面から確認する"><a href="#2-1-Azure-ポータル画面から確認する" class="headerlink" title="2-1. Azure ポータル画面から確認する"></a>2-1. Azure ポータル画面から確認する<a id="2-1"></a></h3><p>「今すぐバックアップ」にて取得した復元ポイントの保持期限は、Azure ポータル画面上の「バックアップ ジョブ」画面から確認可能です。<br>対象のRecovery Services コンテナー ＞ バックアップ ジョブ ＞ 「View details」をクリックいただき、「Recovery Point Expiry Time in UTC」欄をご確認ください。</p><p>・復旧ポイントの管理<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/manage-recovery-points#frequently-asked-question">https://docs.microsoft.com/ja-jp/azure/backup/manage-recovery-points#frequently-asked-question</a></p><p><img src="https://user-images.githubusercontent.com/71251920/151015030-46e75c4e-f1a8-4109-8bf1-4ae1234f1363.png" alt="HowToCheckRetentionPeriodForVMBackup_02"></p><p><img src="https://user-images.githubusercontent.com/71251920/151015028-5fcc5364-1da2-4ea8-9221-60b40294dd07.png" alt="HowToCheckRetentionPeriodForVMBackup_03"></p><p>なお、「今すぐバックアップ」にて取得した復元ポイントの保持期限は、Azure ポータル画面のバックアップ ジョブからのみ、確認可能となっております。<br>また、この保持期限情報を含めた、Azure ポータル画面上のバックアップ ジョブ情報の保持期間は、最大 6 か月間でございます。<br>（弊社検証環境にて確認したところ、現状 1 年以上前のバックアップ ジョブも確認はできましたが、仕様としては 6 か月間となっております）</p><p>そのため、6 か月以上前の バックアップ ジョブ履歴を保持し、オンデマンド バックアップにて取得したバックアップ ポイントの保持期限を確認されたい場合は以下をご検討ください。</p><h3 id="2-2-Azure-ポータル画面より、定期的に-csv-へエクスポートする"><a href="#2-2-Azure-ポータル画面より、定期的に-csv-へエクスポートする" class="headerlink" title="2-2.Azure ポータル画面より、定期的に csv へエクスポートする"></a>2-2.Azure ポータル画面より、定期的に csv へエクスポートする<a id="2-2"></a></h3><p>対象の Recovery Services コンテナー ＞ バックアップ ジョブから、「Filter」にて任意の期間等を選択いただき、バックアップ ジョブが存在するうちに「Export jobs」を実施いただきますよう、お願いいたします。<br> <img src="https://user-images.githubusercontent.com/71251920/151015023-bd46a1cd-a3ec-4d7a-8bd6-942be9442e64.png" alt="HowToCheckRetentionPeriodForVMBackup_04"><br> <img src="https://user-images.githubusercontent.com/71251920/151015021-d768d177-6836-42da-acd7-92b6ff6fa2d9.png" alt="HowToCheckRetentionPeriodForVMBackup_05"><br> <img src="https://user-images.githubusercontent.com/71251920/151015016-3fa5aebe-b792-4c4a-9a06-d316eb9c6262.png" alt="HowToCheckRetentionPeriodForVMBackup_07"><br> <img src="https://user-images.githubusercontent.com/71251920/151015012-5a6e4247-66a7-4c5a-83d8-25d17feb149c.png" alt="HowToCheckRetentionPeriodForVMBackup_08"></p><h2 id="3-参考-改善リクエストについて"><a href="#3-参考-改善リクエストについて" class="headerlink" title="3. 参考 - 改善リクエストについて"></a>3. 参考 - 改善リクエストについて<a id="3"></a></h2><p>・現状は「今すぐバックアップ」で取得した復元ポイントの保持期限は、Azure ポータル画面＞バックアップ ジョブからのみ確認可能<br>・Azure ポータル画面＞バックアップ ジョブ は、6 か月で表示が切れる仕様のため、すべての情報を保持したい場合は、最低 6 か月ごとにAzure ポータル画面からCSVエクスポートを手動で行う必要がある<br>（Azure PowerShell 、Azure CLI 、REST API にて「保持期限」を含めたバックアップ ジョブの確認やExportは不可な状況）<br>上記の仕様については、お客様よりコマンド実行で保持期限を取得できるようにするなど、利便性を向上してほしいとのこと、ご要望をいただいております。<br>そのため下記サイトにて、弊社開発部門へ機能の改善リクエストを投稿しております。<br>下記サイトは、お客様が希望する機能がない場合にお客様から、弊社開発部門へ機能のリクエストを上げることができるサイトとなっております。<br><a href="https://feedback.azure.com/d365community/idea/fb238a80-2954-ec11-a81a-6045bd78b970">https://feedback.azure.com/d365community/idea/fb238a80-2954-ec11-a81a-6045bd78b970</a></p><p>当サイトは多数の要望がリクエストされ、投票数が多いものから機能改修の検討がなされますため、現状仕様の改善をご要望の場合は、可能であれば下図「投票数」のボタンをクリックいただけますと幸いです。<br>（「投票」時はマイクロソフト アカウントが必須となります）<br><img src="https://user-images.githubusercontent.com/71251920/151015009-70369f7e-c5fb-4ea2-8ff9-5f082f44e64b.png" alt="HowToCheckRetentionPeriodForVMBackup_09"></p><p>Azure VM Backup にて取得した復元ポイントの保持期限を確認する方法について、ご案内は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、&lt;strong&gt;Azure VM Backup にて取得した復元ポイントの保持期限を確認する方法&lt;/strong&gt; について、ご案内いたします。&lt;/p&gt;
</summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>「Azure Monitor を使用した組み込みのアラート」を利用したバックアップ ジョブ失敗のアラート通知作成例</title>
    <link href="https://jpabrs-scem.github.io/blog/Recovery%20Services%20vaults/How_to_set_Backup_Alert/"/>
    <id>https://jpabrs-scem.github.io/blog/Recovery%20Services%20vaults/How_to_set_Backup_Alert/</id>
    <published>2022-01-24T03:00:00.000Z</published>
    <updated>2022-06-22T06:34:34.906Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、<strong>「Azure Monitor を使用した組み込みのアラート」を利用して、Recovery Services コンテナーにてバックアップ構成済のバックアップ ジョブが失敗した際にメール通知を出すよう、アラート処理ルールを作成する例</strong> をご紹介します。</p><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>・「Azure Monitor を使用した組み込みのアラート」を利用<br>・アラート処理ルールには、バックアップを構成している対象のRecovery Services コンテナーをスコープとして指定し、バックアップ ジョブが失敗した際に、指定のメールアドレスへ通知メールを送信させる</p><h2 id="アラート処理ルール-作成手順"><a href="#アラート処理ルール-作成手順" class="headerlink" title="アラート処理ルール 作成手順"></a>アラート処理ルール 作成手順</h2><p>Azure Backup にて、バックアップ ジョブが失敗した際にアラート通知を出す手段は、下記ドキュメントの通り複数種類ございます。<br>今回は <strong>「Azure Monitor を使用した組み込みのアラート」</strong> を利用します。<br>・Azure Backup の監視とレポートのソリューション<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/monitoring-and-alerts-overview#monitoring-and-reporting-scenarios">https://docs.microsoft.com/ja-jp/azure/backup/monitoring-and-alerts-overview#monitoring-and-reporting-scenarios</a></p><p><img src="https://user-images.githubusercontent.com/71251920/151009982-ca6af556-0142-42f7-b991-33de2714c482.png" alt="How_to_set_Backup_Alert_01"></p><p>「Azure Monitor を使用した組み込みのアラート」を利用した、アラート ルールの作成手順の公開ドキュメントは下記にございます。<br>・ジョブの失敗のシナリオに対して Azure Monitor のアラートを有効にする<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor#turning-on-azure-monitor-alerts-for-job-failure-scenarios">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor#turning-on-azure-monitor-alerts-for-job-failure-scenarios</a></p><p><img src="https://user-images.githubusercontent.com/71251920/151009985-41e50961-1328-4ca2-9814-116dd8eb63cf.png" alt="How_to_set_Backup_Alert_02"></p><p>・アラートの通知を構成する<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor#configuring-notifications-for-alerts">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor#configuring-notifications-for-alerts</a></p><p>バックアップ センター ＞ アラート処理ルール にて、新しいアラート処理ルールを作成することができます。</p><p><img src="https://user-images.githubusercontent.com/71251920/151009987-c76bcfcd-04f3-49f4-ae05-033d3eee4d4e.png" alt="How_to_set_Backup_Alert_03"></p><p><img src="https://user-images.githubusercontent.com/71251920/151009990-288bd354-12f3-4a43-a567-3bb4b5ea9cab.png" alt="How_to_set_Backup_Alert_04"></p><p>今回は、Recovery Services コンテナー「RSV-JPE-LRS」にて Azure Files をバックアップ構成しているため、スコープを「Recovery Services コンテナー：RSV-JPE-LRS」としています。</p><p><img src="https://user-images.githubusercontent.com/71251920/151009992-071f529c-b069-4e95-b579-57e41d858db5.png" alt="How_to_set_Backup_Alert_05"></p><p>また、バックアップ ジョブのエラーを検知した際にアラート通知を発報したいため、「フィルター：重要度」とし、「階層：１ - エラー」を選択します。<br>・Azure Backup で保護されたワークロードの監視<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor#azure-monitor-alerts-for-azure-backup-preview">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor#azure-monitor-alerts-for-azure-backup-preview</a></p><p><img src="https://user-images.githubusercontent.com/71251920/151009994-805f0f47-4085-4c6b-b1e0-5453f242f62f.png" alt="How_to_set_Backup_Alert_06"></p><p><img src="https://user-images.githubusercontent.com/71251920/151009996-9dc217c3-e7ed-43dd-b777-a7f82bf9081b.png" alt="How_to_set_Backup_Alert_07"></p><p><img src="https://user-images.githubusercontent.com/71251920/151009999-50e00252-c95e-47df-b6c9-60fb7255e24a.png" alt="How_to_set_Backup_Alert_08"></p><p>「アクション グループ」には、送信したいメールアドレスを設定しているアクション グループを追加する、もしくは新規作成します。<br>今回はあらかじめ作成済のアクション グループを選択しています。</p><p><img src="https://user-images.githubusercontent.com/71251920/151010003-78799d24-3c6a-4ff6-a8ff-39c7c7c95e90.png" alt="How_to_set_Backup_Alert_09"></p><p> （補足）アクショングループには、下図のように電子メールへの通知を設定済となっています</p><p><img src="https://user-images.githubusercontent.com/71251920/151010005-e0d96c25-d7cc-4789-9b1e-6be5458b86f6.png" alt="How_to_set_Backup_Alert_10"></p><p><img src="https://user-images.githubusercontent.com/71251920/151010009-0b53d0c3-1d15-4902-9059-ad96f54cb6e6.png" alt="How_to_set_Backup_Alert_11"></p><p><img src="https://user-images.githubusercontent.com/71251920/151010014-e76647b0-3eb5-4cc8-8558-b38636996f48.png" alt="How_to_set_Backup_Alert_12"></p><p>上図のように設定することで、Recovery Services コンテナー「RSV-JPE-LRS」にてバックアップ構成済のバックアップ ジョブが失敗した際に、指定した電子メール宛先へ、通知メールが送信されるようになります。 </p><p><img src="https://user-images.githubusercontent.com/71251920/151009979-8f6868a8-2edd-4d08-86a5-ef843a877bda.png" alt="How_to_set_Backup_Alert_13"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、&lt;strong&gt;「Azure Monitor を使用した組み込みのアラート」を利用して、Recovery Services コンテナーにてバックアップ構成</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Recovery Services vaults" scheme="https://jpabrs-scem.github.io/blog/tags/Recovery-Services-vaults/"/>
    
  </entry>
  
  <entry>
    <title>SCVMM サーバーおよび SCVMM 管理対象サーバーの自己署名証明書の更新手順</title>
    <link href="https://jpabrs-scem.github.io/blog/SystemCenter/SCVMM_Renew_Crtificate/"/>
    <id>https://jpabrs-scem.github.io/blog/SystemCenter/SCVMM_Renew_Crtificate/</id>
    <published>2022-01-12T03:00:00.000Z</published>
    <updated>2022-06-22T06:34:34.914Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆さんこんにちは、System Center サポートチームの 保科と申します。</p><p>今回は、System Center Virtual Machine Manager (SCVMM) で使用する自己署名証明書の有効期限が切れた場合や、削除をされた場合の対処方法についてご案内いたします。</p><h3 id="本ページが対象とする-SCVMM-バージョン"><a href="#本ページが対象とする-SCVMM-バージョン" class="headerlink" title="[本ページが対象とする SCVMM バージョン]"></a>[本ページが対象とする SCVMM バージョン]</h3><p>SCVMM 2012<br>SCVMM 2012 SP1<br>SCVMM 2012 R2<br>SCVMM 2016<br>SCVMM 2019</p><h3 id="概要"><a href="#概要" class="headerlink" title="[概要]"></a>[概要]</h3><p>SCVMM では、SCVMM サーバー機能をインストールしたサーバーや、SCVMM にて管理対象となる Hyper-V サーバーに SCVMM エージェントがインストールされた際、同時に自己署名証明書も当該サーバーにインストールされます。<br>これは、SCVMM サーバーと管理対象 Hyper-V サーバーの間の通信の安全性を確保するためにインストールされます。<br>そのため、この自己署名証明書は、SCVMM サーバーが管理対象 Hyper-V サーバーと通信を行う際に必須となる証明書となります。</p><p>この自己署名証明書は、フレンドリ名が  “SCVMM_CERTIFICATE_KEY_CONTAINER***” となっており、発行者はそのホスト自身になっています。<br>(*** の部分は SCVMM サーバーもしくは Hyper-V サーバーの完全修飾ドメイン名となります。)<br>この証明書の期限は SCVMM サーバーや、Hyper-V サーバーを SCVMM の管理対象に設定した年の 1/1 から 5 年間に設定されます。<br>例えば 2015/10/26 に Hyper-V ホストを SCVMM の管理対象に設定した場合、設定される証明書の有効期限は 2020/1/1 になります。<br>これは 2015 年中であればいつ Hyper-Vホストを管理対象に追加された場合でも同様の結果となります。</p><p>上記の通りこの証明書の期限は 5 年間 (SCVMM のバージョンによっては 10 年間)となっています。<br>このため、5 年間 (10 年間) が経過するとこの証明書は無効になります。<br>なお、この証明書の有効期限が超過する 1 ヶ月前になりますと、SCVMM サーバー上で以下の警告メッセージが出力されるようになります。</p><blockquote><p>警告 (20583)<br>コンピューター &lt;対象サーバーの完全修飾ドメイン名&gt; の自己署名証明書は既に有効期限切れか、1 か月以内に有効期限切れになります。</p><p>推奨される操作<br>VMM から &lt;対象サーバーの完全修飾ドメイン名&gt; を削除してから追加して、新しい証明書を取得してください。</p></blockquote><p>また何かのトラブルシュートの際などに誤ってこの証明書を削除してしまったりすることも考えられます。<br>その場合、SCVMM サーバーと Hyper-V サーバーの間の通信に問題が発生し、Hyper-V サーバーの管理作業などが正しく動作しなくなります。</p><p>このような場合、SCVMM サーバーもしくは Hyper-V サーバーにインストールされている SCVMM エージェントを再インストールすることで対処することもできますが、証明書を再発行することでも対処することができます。<br>この際の手順は以下の [対処手順 ①] に従って自己署名証明書の再インストールを実施します。<br>また、SCVMM サーバー限定かつ特定の SCVMM バージョン限定の手順とはなりますが、[対処手順 ②] に従った自己署名証明書の更新も実施いただけます。</p><h3 id="対処手順-①"><a href="#対処手順-①" class="headerlink" title="[対処手順 ①]"></a>[対処手順 ①]</h3><ol><li>自己署名証明書を更新いただくサーバーに管理者権限でログインします。</li><li>Windows + R を入力して、[ファイル名を指定して実行] を起動します。</li><li>mmc と入力して [OK] をクリックします。</li><li>表示されたウインドウで、メニュー バーから [ファイル] - [スナップインの追加と削除] を選択します。</li><li>“利用できるスナップイン” から “証明書” を選択し、[追加] をクリックします。</li><li>[証明書スナップイン] ウインドウが表示されたら、”コンピューター アカウント” をチェックし、[次へ] をクリックします。</li><li>[コンピューターの選択] ウインドウでは、既定値のまま [完了] をクリックします。</li><li>[OK] をクリックして、[スナップインの追加と削除] ウインドウを閉じます。</li><li>左側のツリーから、[証明書 (ローカル コンピューター)] -&gt; [個人] -&gt; [証明書] を開きます。</li><li>中央ペインに表示されている証明書のうち、”フレンドリ名” 列に “SCVMM_CERTIFICATE_KEY_CONTAINER***” と表示されてる証明書を選択して削除します。<br>(*** の部分は SCVMM サーバーもしくは Hyper-V サーバーの完全修飾ドメイン名となります。)<br>そのような証明書が既に存在しない場合、そのまま手順 11. に進みます。</li><li>SCVMM サーバー上で、”Virtual Machine Manager Command Shell” を起動します。</li><li>以下のコマンドを実行します。<blockquote><p><code> </code> <code>$credential = get-credential</code> <code> </code></p></blockquote></li><li>表示されたウインドウに、SCVMM サーバーのローカル管理者権限のあるユーザーのユーザー名とパスワードを入力して [OK] をクリックします。</li><li>続いて、以下のコマンドを実行します。<br>(*** の部分は SCVMM サーバーもしくは Hyper-V サーバーの完全修飾ドメイン名を入力します。)<blockquote><p><code> </code> <code>Get-VMMManagedComputer -ComputerName &quot;***&quot; | Register-SCVMMManagedComputer  -Credential $credential</code> <code> </code></p></blockquote></li><li>自己署名証明書を更新されるサーバーに、有効期限が 5 年後 (10 年後) の 1 月 1 日に設定された自己署名証明書が無事再作成されたことを、10. の手順で開いたコンソール上で確認いただきます。<br>手順実施後も証明書が更新されていない場合、画面を最新の情報に更新いただくことで表示される場合がございます。</li></ol><h3 id="対処手順-②"><a href="#対処手順-②" class="headerlink" title="[対処手順 ②]"></a>[対処手順 ②]</h3><p>こちらの手順は、以下の SCVMM バージョンにて追加されたコマンドレットを使用する手順となります。<br>・SCVMM 2016 Update Rollup 10<br>・SCVMM 2019 Update Rollup 2<br>上記のバージョンに SCVMM をアップデートすると、SCVMM サーバーの自己署名証明書を更新する “Update-SCVMMCertificate” コマンドレットがご利用いただけるようになります。<br>SCVMM サーバー限定の手順となり、Hyper-V サーバーに対しては実施いただけない手順となりますが、以下の手順に沿って SCVMM サーバーにインストールされた自己署名証明書を更新いただけます。</p><ol><li>SCVMM サーバーに管理者権限でログインします。</li><li>ログインしたサーバー上で “Virtual Machine Manager Command Shell” を起動します。</li><li>以下のコマンドを実行します。<blockquote><p><code> </code> <code>Update-SCVMMCertificate -VMMServer &#39;***&#39; </code> <code> </code><br><code> </code> <code> (*** の部分は SCVMM サーバーの完全修飾ドメイン名を入力します。)</code> <code> </code></p></blockquote></li><li>自己署名証明書を更新されるサーバーに、有効期限が 5 年後 (10 年後) の 1 月 1 日に設定された自己署名証明書が無事再作成されたことを、”対処手順 ①” の 10. の手順で開けるコンソール上で確認いただきます。<br>手順実施後も証明書が更新されていない場合、画面を最新の情報に更新いただくことで表示される場合がございます。</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆さんこんにちは、System Center サポートチームの 保科と申します。&lt;/p&gt;
&lt;p&gt;今回は、System Center Virtual Machine Manager (SCVMM) で使用する自己署名証明書の有効</summary>
      
    
    
    
    
    <category term="System Center" scheme="https://jpabrs-scem.github.io/blog/tags/System-Center/"/>
    
    <category term="SCVMM" scheme="https://jpabrs-scem.github.io/blog/tags/SCVMM/"/>
    
  </entry>
  
</feed>
