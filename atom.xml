<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan CSS ABRS &amp; SCEM Support Blog</title>
  
  <subtitle>Azure Backup,Azure Site Recovery,Azure Migrate および System Center 製品(Orchestrator , Operations/Virtual Machine/Service/Data Protection Manager)に関するサポート情報を発信します。</subtitle>
  <link href="https://jpabrs-scem.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpabrs-scem.github.io/blog/"/>
  <updated>2022-02-01T15:19:36.416Z</updated>
  <id>https://jpabrs-scem.github.io/blog/</id>
  
  <author>
    <name>Japan CSS ABRS &amp; SCEM Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>SCOM エージェントの入れ替え作業の失敗事例</title>
    <link href="https://jpabrs-scem.github.io/blog/SystemCenter/SCOM_agent_failures/"/>
    <id>https://jpabrs-scem.github.io/blog/SystemCenter/SCOM_agent_failures/</id>
    <published>2022-01-28T03:00:00.000Z</published>
    <updated>2022-02-01T15:19:36.416Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 佐藤 です。</p><p>本日は System Center Operations Manager（以後 SCOM）  のエージェントの入れ替え作業の失敗事例をご紹介いたします。<br>2022 年 1 月現在の状況として、（<a href="https://docs.microsoft.com/ja-jp/lifecycle/products/microsoft-system-center-2012-r2-operations-manager">SCOM 2012 R2の延長サポートのフェーズが2022年7月に終了</a>）することに伴い、SCOM 2016や2019 など後継バージョンの環境を新規構築して移行を進めている、もしくはご計画されているお客様もいるかと存じます。</p><p>その際、監視対象コンピューターにて SCOM 2012 R2 のエージェントのアンインストールを行い、SCOM 2016 や 2019 のエージェントをインストールすることになりますが、<strong>アンインストール時に想定通り削除が出来ず、SCOM 2012 R2 向けのレジストリ設定やフォルダが残存してしまい SCOM エージェントをインストールする際に失敗する事例</strong>が発生しております。</p><h2 id="Error-Message"><a href="#Error-Message" class="headerlink" title="Error Message"></a>Error Message</h2><p>具体的にはプッシュインストール時には下記のようなインストール失敗メッセージが出力されます</p><blockquote><p>リモート コンピューター &lt;&lt;コンピューターFQDN&gt;&gt; のエージェント管理オペレーションは エージェントのインストール に失敗しました。<br>インストール アカウント: XXX<br>エラー コード: 80070643<br>エラーの説明: インストール中に致命的なエラーが発生しました。<br>Microsoft インストーラーのエラーの説明:<br>詳細については、管理サーバーの Windows インストーラーのログ ファイル “C:\Program Files\Microsoft System Center 2016\Operations &gt;Manager\Server\AgentManagement\AgentLogs\xxxAgentInstall.LOG<br>C:\Program Files\Microsoft System Center 2016\Operations Manager\Server\AgentManagement\AgentLogs\XXXMOMAgentMgmt.log” を参照してください。 </p></blockquote><h2 id="対処策"><a href="#対処策" class="headerlink" title="対処策"></a>対処策</h2><p>当事象が発生した際には<br>下記に記載するフォルダとレジストリを確認いただき、残存している場合は削除いただきますようお願いします。</p><p>※下記 2 つの値は環境によりで異なっております。</p><blockquote><p>D996D247BE65CC940AA413D70EF113DC<br>742D699D-56EB-49CC-A04A-317DE01F31CD</p></blockquote><p>以下のように確認いただき、お客様環境の文字列に読み替えをお願いします。</p><p>・D996D247BE65CC940AA413D70EF113DC<br>パス「HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Products」において<br>下図のように [InstallProperties] の [DisplayName] が “Microsoft Monitoring Agent”となっている箇所の フォルダ名</p><p>下図の確認結果として ”D996D247BE65CC940AA413D70EF113DC” を ”5C0796876F6E14A42B83EA524D9BE1AE” に読み替えます。<br><img src="https://user-images.githubusercontent.com/71251920/151289630-3ed34906-47a7-467f-ac70-4bf269148ce7.gif" alt="SCOM_agent_failures_01"></p><p>・742D699D-56EB-49CC-A04A-317DE01F31CD<br>パス「HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\」において<br>下図のように [DisplayName] が “Microsoft Monitoring Agent”となっている箇所の フォルダ名</p><p>下図の確認結果として ”742D699D-56EB-49CC-A04A-317DE01F31CD” を”786970C5-E6F6-4A41-B238-AE25D4B91EEA” に読み替えます。<br><img src="https://user-images.githubusercontent.com/71251920/151289631-00aa5d7c-8b20-4bf3-baca-4baefd861d66.gif" alt="SCOM_agent_failures_02"></p><h3 id="削除対象のレジストリ"><a href="#削除対象のレジストリ" class="headerlink" title="削除対象のレジストリ"></a>削除対象のレジストリ</h3><p>・全てフォルダとなります。keyではございません。<br>・2行目の[XXXX\C96403E8AD6025B4F9E1FE9C574E34AE]は固定文字列のフォルダとなります。</p><p>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Products\D996D247BE65CC940AA413D70EF113DC<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UpgradeCodes\C96403E8AD6025B4F9E1FE9C574E34AE<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Installer\UserData\S-1-5-18\Components\D9960A263C3B3F948AE9C9793043B7C9<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall{742D699D-56EB-49CC-A04A-317DE01F31CD}<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\System Center<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\System Center Operations Manager<br>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Microsoft Operations Manager<br>HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Installer\Products\D996D247BE65CC940AA413D70EF113DC<br>HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Installer\Features\D996D247BE65CC940AA413D70EF113DC<br>HKEY_LOCAL_MACHINE\SOFTWARE\Classes\Installer\UpgradeCodes\C96403E8AD6025B4F9E1FE9C574E34AE<br>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\MOMConnector<br>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\HealthService<br>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\System Center Management APM</p><h3 id="削除対象のフォルダ"><a href="#削除対象のフォルダ" class="headerlink" title="削除対象のフォルダ"></a>削除対象のフォルダ</h3><p>C:\Windows\Installer{742D699D-56EB-49CC-A04A-317DE01F31CD}<br>C:\Program Files\Common Files\Microsoft Shared\Operations Manager</p><p>上記レジストリ及びフォルダの確認、削除が完了しましたらここで OS の再起動をお願いします。</p><p>確認および削除手順は以上となります。新規エージェントをインストールする際に失敗する事象が発生した際は、ぜひ一度上記確認をお願いいたします。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 佐藤 です。&lt;/p&gt;
&lt;p&gt;本日は System Center Operations Manager（以後 SCOM）  のエージェントの入れ替え作業の失敗事例をご</summary>
      
    
    
    
    
    <category term="System Center" scheme="https://jpabrs-scem.github.io/blog/tags/System-Center/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup で取得した復旧ポイントの保持期間の延長について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToExtendVMRetentionPeriod/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToExtendVMRetentionPeriod/</id>
    <published>2022-01-27T03:00:00.000Z</published>
    <updated>2022-02-01T15:19:36.388Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、 <strong>Azure VM Backup として取得済の復元ポイントの保持期限を延長できるかという点</strong> についてご案内いたします。</p><p>Azure VM Backup 関連のお問い合わせで、以下のようなお問い合わせを多くいただきます。</p><ol><li>バックアップ ポリシーに従って取得済の復元ポイントの保持期間を延長することは可能か</li><li>バックアップ ポリシーに従って取得済の復元ポイントの中の、特定の復元ポイントのみの保持期間を延長して保持しておくことは可能か</li><li>「今すぐバックアップ」にて取得済の復元ポイントの保持期間を延長して保持しておくことは可能か</li></ol><p>結論から申し上げますと、1. は可能でございますが、2. 3. については保持期間を延長して保持しておくことはかないません。<br>代替案含め、下記にてご説明いたします。</p><h2 id="1-バックアップ-ポリシーに従って取得済の復元ポイントの保持期間を延長することは可能か"><a href="#1-バックアップ-ポリシーに従って取得済の復元ポイントの保持期間を延長することは可能か" class="headerlink" title="1. バックアップ ポリシーに従って取得済の復元ポイントの保持期間を延長することは可能か"></a>1. バックアップ ポリシーに従って取得済の復元ポイントの保持期間を延長することは可能か<a id="1"></a></h2><p>対象の仮想マシンに適用しているバックアップ ポリシー内の保持期間を変更することで、これまで取得済の復元ポイントに対しても保持期間を延長することが可能でございます。<br>例えば、週次 (日次) にて取得する復元ポイント（バックアップ ポイント）に対する保持期間の変更は、すでに週次 (日次) にて取得した復元ポイントに対しても変更が適用されます。</p><p>下記の弊社公開情報をご覧ください。<br>・アーキテクチャの概要 -  復旧ポイントに対するポリシーの変更の影響<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-architecture#impact-of-policy-change-on-recovery-points">https://docs.microsoft.com/ja-jp/azure/backup/backup-architecture#impact-of-policy-change-on-recovery-points</a></p><p><img src="https://user-images.githubusercontent.com/71251920/151024656-f6589f03-6965-47ad-9848-36742f9e3e7e.png" alt="HowToExtendVMRetentionPeriod_01"></p><h2 id="2-バックアップ-ポリシーに従って取得済の復元ポイントの中の、特定の復元ポイントのみの保持期間を延長して保持しておくことは可能か"><a href="#2-バックアップ-ポリシーに従って取得済の復元ポイントの中の、特定の復元ポイントのみの保持期間を延長して保持しておくことは可能か" class="headerlink" title="2. バックアップ ポリシーに従って取得済の復元ポイントの中の、特定の復元ポイントのみの保持期間を延長して保持しておくことは可能か"></a>2. バックアップ ポリシーに従って取得済の復元ポイントの中の、特定の復元ポイントのみの保持期間を延長して保持しておくことは可能か<a id="2"></a></h2><h2 id="3-「今すぐバックアップ」にて取得済の復元ポイントの保持期間を延長して保持しておくことは可能か"><a href="#3-「今すぐバックアップ」にて取得済の復元ポイントの保持期間を延長して保持しておくことは可能か" class="headerlink" title="3. 「今すぐバックアップ」にて取得済の復元ポイントの保持期間を延長して保持しておくことは可能か"></a>3. 「今すぐバックアップ」にて取得済の復元ポイントの保持期間を延長して保持しておくことは可能か<a id="3"></a></h2><p>バックアップ ポリシー上で「保持期間」を変更した場合、これまで取得してきたすべての復元ポイントに対して、ポリシーの変更が適用されます。<br>残念ながら、これまで取得してきた復元ポイントのうち、「ある特定の復元ポイントのみ」の保持期間を延長して保持しておく、ということはかないません。<br>また、「今すぐバックアップ」（オンデマンド バックアップ）にて取得した復元ポイントの保持期間も延長することはかないません。<br>上記 2. 3. をご所望の場合は、下記代替案の通り、対象の復元ポイントからディスクとして復元しておき、ご利用者様にてディスクを保持していただくことをお勧めします。</p><h3 id="代替案"><a href="#代替案" class="headerlink" title="代替案"></a>代替案<a id="4"></a></h3><p>対象の仮想マシン ＞ 「VM の復元」をクリック ＞ 「復元ポイント」にて、保持しておきたい特定の復元ポイントを選択します。<br>「構成の復元：新規作成」「復元の種類：ディスクの復元」を選択のうえ、「復元」をクリックします。<br>復元されたディスクは、ご利用者様にてディスクを削除しない限り、保持され続けます。<br><img src="https://user-images.githubusercontent.com/71251920/151024649-a76bd670-cc4c-4dc6-9b89-7849ca86f7e2.gif" alt="HowToExtendVMRetentionPeriod_02"></p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考<a id="5"></a></h2><p>・Azure VM Backupでリストアされるディスク名に関して<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/About_Restored_Disk/">https://jpabrs-scem.github.io/blog/AzureVMBackup/About_Restored_Disk/</a><br>・Azure VM Backup にて取得した復元ポイントの保持期限を確認する方法<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/">https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、 &lt;strong&gt;Azure VM Backup として取得済の復元ポイントの保持期限を延長できるかという点&lt;/strong&gt; についてご案内いたします。</summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup にて取得した復元ポイントの保持期限を確認する方法</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/</id>
    <published>2022-01-26T03:00:00.000Z</published>
    <updated>2022-02-01T15:19:36.388Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、<strong>Azure VM Backup にて取得した復元ポイントの保持期限を確認する方法</strong> について、ご案内いたします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. スケジュール バックアップにて取得した復元ポイントの保持期限を確認されたい場合</a><br><a href="#2">2. 「今すぐバックアップ」にて取得した復元ポイントの保持期限を確認されたい場合</a><br> <a href="#2-1"> 2-1. Azure ポータル画面から確認する</a><br> <a href="#2-2"> 2-2. Azure ポータル画面より、定期的に csv へエクスポートする</a><br><a href="#3">3. 参考 - 改善リクエストについて</a></p><hr><h2 id="1-スケジュール-バックアップにて取得した復元ポイントの保持期限を確認されたい場合"><a href="#1-スケジュール-バックアップにて取得した復元ポイントの保持期限を確認されたい場合" class="headerlink" title="1. スケジュール バックアップにて取得した復元ポイントの保持期限を確認されたい場合"></a>1. スケジュール バックアップにて取得した復元ポイントの保持期限を確認されたい場合<a id="1"></a></h2><p>スケジュール バックアップにて取得する復元ポイントは、バックアップ ポリシーにて設定した保持期限に従って保持されますので、設定しているバックアップ ポリシーを参照ください。</p><p>Recovery Services コンテナー ＞ バックアップ ポリシー にて確認可能です。<br>もしくは、下図のように Recovery Services コンテナー ＞ バックアップ アイテム ＞ Azure Virtual Machine ＞ 対象の仮想マシンを選択し、「バックアップ ポリシー」を確認可能です。</p><p><img src="https://user-images.githubusercontent.com/71251920/151015032-1fe8bebd-1246-42f0-9ff0-8a511b7c9ef0.png" alt="HowToCheckRetentionPeriodForVMBackup_01"></p><h2 id="2-「今すぐバックアップ」にて取得した復元ポイントの保持期限を確認されたい場合"><a href="#2-「今すぐバックアップ」にて取得した復元ポイントの保持期限を確認されたい場合" class="headerlink" title="2. 「今すぐバックアップ」にて取得した復元ポイントの保持期限を確認されたい場合"></a>2. 「今すぐバックアップ」にて取得した復元ポイントの保持期限を確認されたい場合<a id="2"></a></h2><h3 id="2-1-Azure-ポータル画面から確認する"><a href="#2-1-Azure-ポータル画面から確認する" class="headerlink" title="2-1. Azure ポータル画面から確認する"></a>2-1. Azure ポータル画面から確認する<a id="2-1"></a></h3><p>「今すぐバックアップ」にて取得した復元ポイントの保持期限は、Azure ポータル画面上の「バックアップ ジョブ」画面から確認可能です。<br>対象のRecovery Services コンテナー ＞ バックアップ ジョブ ＞ 「View details」をクリックいただき、「Recovery Point Expiry Time in UTC」欄をご確認ください。</p><p>・復旧ポイントの管理<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/manage-recovery-points#frequently-asked-question">https://docs.microsoft.com/ja-jp/azure/backup/manage-recovery-points#frequently-asked-question</a></p><p><img src="https://user-images.githubusercontent.com/71251920/151015030-46e75c4e-f1a8-4109-8bf1-4ae1234f1363.png" alt="HowToCheckRetentionPeriodForVMBackup_02"></p><p><img src="https://user-images.githubusercontent.com/71251920/151015028-5fcc5364-1da2-4ea8-9221-60b40294dd07.png" alt="HowToCheckRetentionPeriodForVMBackup_03"></p><p>なお、「今すぐバックアップ」にて取得した復元ポイントの保持期限は、Azure ポータル画面のバックアップ ジョブからのみ、確認可能となっております。<br>また、この保持期限情報を含めた、Azure ポータル画面上のバックアップ ジョブ情報の保持期間は、最大 6 か月間でございます。<br>（弊社検証環境にて確認したところ、現状 1 年以上前のバックアップ ジョブも確認はできましたが、仕様としては 6 か月間となっております）</p><p>そのため、6 か月以上前の バックアップ ジョブ履歴を保持し、オンデマンド バックアップにて取得したバックアップ ポイントの保持期限を確認されたい場合は以下をご検討ください。</p><h3 id="2-2-Azure-ポータル画面より、定期的に-csv-へエクスポートする"><a href="#2-2-Azure-ポータル画面より、定期的に-csv-へエクスポートする" class="headerlink" title="2-2.Azure ポータル画面より、定期的に csv へエクスポートする"></a>2-2.Azure ポータル画面より、定期的に csv へエクスポートする<a id="2-2"></a></h3><p>対象の Recovery Services コンテナー ＞ バックアップ ジョブから、「Filter」にて任意の期間等を選択いただき、バックアップ ジョブが存在するうちに「Export jobs」を実施いただきますよう、お願いいたします。<br> <img src="https://user-images.githubusercontent.com/71251920/151015023-bd46a1cd-a3ec-4d7a-8bd6-942be9442e64.png" alt="HowToCheckRetentionPeriodForVMBackup_04"><br> <img src="https://user-images.githubusercontent.com/71251920/151015021-d768d177-6836-42da-acd7-92b6ff6fa2d9.png" alt="HowToCheckRetentionPeriodForVMBackup_05"><br> <img src="https://user-images.githubusercontent.com/71251920/151015016-3fa5aebe-b792-4c4a-9a06-d316eb9c6262.png" alt="HowToCheckRetentionPeriodForVMBackup_07"><br> <img src="https://user-images.githubusercontent.com/71251920/151015012-5a6e4247-66a7-4c5a-83d8-25d17feb149c.png" alt="HowToCheckRetentionPeriodForVMBackup_08"></p><h2 id="3-参考-改善リクエストについて"><a href="#3-参考-改善リクエストについて" class="headerlink" title="3. 参考 - 改善リクエストについて"></a>3. 参考 - 改善リクエストについて<a id="3"></a></h2><p>・現状は「今すぐバックアップ」で取得した復元ポイントの保持期限は、Azure ポータル画面＞バックアップ ジョブからのみ確認可能<br>・Azure ポータル画面＞バックアップ ジョブ は、6 か月で表示が切れる仕様のため、すべての情報を保持したい場合は、最低 6 か月ごとにAzure ポータル画面からCSVエクスポートを手動で行う必要がある<br>（Azure PowerShell 、Azure CLI 、REST API にて「保持期限」を含めたバックアップ ジョブの確認やExportは不可な状況）<br>上記の仕様については、お客様よりコマンド実行で保持期限を取得できるようにするなど、利便性を向上してほしいとのこと、ご要望をいただいております。<br>そのため下記サイトにて、弊社開発部門へ機能の改善リクエストを投稿しております。<br>下記サイトは、お客様が希望する機能がない場合にお客様から、弊社開発部門へ機能のリクエストを上げることができるサイトとなっております。<br><a href="https://feedback.azure.com/d365community/idea/fb238a80-2954-ec11-a81a-6045bd78b970">https://feedback.azure.com/d365community/idea/fb238a80-2954-ec11-a81a-6045bd78b970</a></p><p>当サイトは多数の要望がリクエストされ、投票数が多いものから機能改修の検討がなされますため、現状仕様の改善をご要望の場合は、可能であれば下図「投票数」のボタンをクリックいただけますと幸いです。<br>（「投票」時はマイクロソフト アカウントが必須となります）<br><img src="https://user-images.githubusercontent.com/71251920/151015009-70369f7e-c5fb-4ea2-8ff9-5f082f44e64b.png" alt="HowToCheckRetentionPeriodForVMBackup_09"></p><p>Azure VM Backup にて取得した復元ポイントの保持期限を確認する方法について、ご案内は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、&lt;strong&gt;Azure VM Backup にて取得した復元ポイントの保持期限を確認する方法&lt;/strong&gt; について、ご案内いたします。&lt;/p&gt;
</summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>「Azure Monitor を使用した組み込みのアラート」を利用したバックアップ ジョブ失敗のアラート通知作成例</title>
    <link href="https://jpabrs-scem.github.io/blog/Recovery%20Services%20vaults/How_to_set_Backup_Alert/"/>
    <id>https://jpabrs-scem.github.io/blog/Recovery%20Services%20vaults/How_to_set_Backup_Alert/</id>
    <published>2022-01-24T03:00:00.000Z</published>
    <updated>2022-02-01T15:19:36.412Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、<strong>「Azure Monitor を使用した組み込みのアラート」を利用して、Recovery Services コンテナーにてバックアップ構成済のバックアップ ジョブが失敗した際にメール通知を出すよう、アラート処理ルールを作成する例</strong> をご紹介します。</p><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>・「Azure Monitor を使用した組み込みのアラート」を利用<br>・アラート処理ルールには、バックアップを構成している対象のRecovery Services コンテナーをスコープとして指定し、バックアップ ジョブが失敗した際に、指定のメールアドレスへ通知メールを送信させる</p><h2 id="アラート処理ルール-作成手順"><a href="#アラート処理ルール-作成手順" class="headerlink" title="アラート処理ルール 作成手順"></a>アラート処理ルール 作成手順</h2><p>Azure Backup にて、バックアップ ジョブが失敗した際にアラート通知を出す手段は、下記ドキュメントの通り複数種類ございます。<br>今回は <strong>「Azure Monitor を使用した組み込みのアラート」</strong> を利用します。<br>・Azure Backup の監視とレポートのソリューション<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/monitoring-and-alerts-overview#monitoring-and-reporting-scenarios">https://docs.microsoft.com/ja-jp/azure/backup/monitoring-and-alerts-overview#monitoring-and-reporting-scenarios</a></p><p><img src="https://user-images.githubusercontent.com/71251920/151009982-ca6af556-0142-42f7-b991-33de2714c482.png" alt="How_to_set_Backup_Alert_01"></p><p>「Azure Monitor を使用した組み込みのアラート」を利用した、アラート ルールの作成手順の公開ドキュメントは下記にございます。<br>・ジョブの失敗のシナリオに対して Azure Monitor のアラートを有効にする<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor#turning-on-azure-monitor-alerts-for-job-failure-scenarios">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor#turning-on-azure-monitor-alerts-for-job-failure-scenarios</a></p><p><img src="https://user-images.githubusercontent.com/71251920/151009985-41e50961-1328-4ca2-9814-116dd8eb63cf.png" alt="How_to_set_Backup_Alert_02"></p><p>・アラートの通知を構成する<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor#configuring-notifications-for-alerts">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor#configuring-notifications-for-alerts</a></p><p>バックアップ センター ＞ アラート処理ルール にて、新しいアラート処理ルールを作成することができます。</p><p><img src="https://user-images.githubusercontent.com/71251920/151009987-c76bcfcd-04f3-49f4-ae05-033d3eee4d4e.png" alt="How_to_set_Backup_Alert_03"></p><p><img src="https://user-images.githubusercontent.com/71251920/151009990-288bd354-12f3-4a43-a567-3bb4b5ea9cab.png" alt="How_to_set_Backup_Alert_04"></p><p>今回は、Recovery Services コンテナー「RSV-JPE-LRS」にて Azure Files をバックアップ構成しているため、スコープを「Recovery Services コンテナー：RSV-JPE-LRS」としています。</p><p><img src="https://user-images.githubusercontent.com/71251920/151009992-071f529c-b069-4e95-b579-57e41d858db5.png" alt="How_to_set_Backup_Alert_05"></p><p>また、バックアップ ジョブのエラーを検知した際にアラート通知を発報したいため、「フィルター：重要度」とし、「階層：１ - エラー」を選択します。<br>・Azure Backup で保護されたワークロードの監視<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor#azure-monitor-alerts-for-azure-backup-preview">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor#azure-monitor-alerts-for-azure-backup-preview</a></p><p><img src="https://user-images.githubusercontent.com/71251920/151009994-805f0f47-4085-4c6b-b1e0-5453f242f62f.png" alt="How_to_set_Backup_Alert_06"></p><p><img src="https://user-images.githubusercontent.com/71251920/151009996-9dc217c3-e7ed-43dd-b777-a7f82bf9081b.png" alt="How_to_set_Backup_Alert_07"></p><p><img src="https://user-images.githubusercontent.com/71251920/151009999-50e00252-c95e-47df-b6c9-60fb7255e24a.png" alt="How_to_set_Backup_Alert_08"></p><p>「アクション グループ」には、送信したいメールアドレスを設定しているアクション グループを追加する、もしくは新規作成します。<br>今回はあらかじめ作成済のアクション グループを選択しています。</p><p><img src="https://user-images.githubusercontent.com/71251920/151010003-78799d24-3c6a-4ff6-a8ff-39c7c7c95e90.png" alt="How_to_set_Backup_Alert_09"></p><p> （補足）アクショングループには、下図のように電子メールへの通知を設定済となっています</p><p><img src="https://user-images.githubusercontent.com/71251920/151010005-e0d96c25-d7cc-4789-9b1e-6be5458b86f6.png" alt="How_to_set_Backup_Alert_10"></p><p><img src="https://user-images.githubusercontent.com/71251920/151010009-0b53d0c3-1d15-4902-9059-ad96f54cb6e6.png" alt="How_to_set_Backup_Alert_11"></p><p><img src="https://user-images.githubusercontent.com/71251920/151010014-e76647b0-3eb5-4cc8-8558-b38636996f48.png" alt="How_to_set_Backup_Alert_12"></p><p>上図のように設定することで、Recovery Services コンテナー「RSV-JPE-LRS」にてバックアップ構成済ののバックアップ ジョブが失敗した際に、指定した電子メール宛先へ、通知メールが送信されるようになります。 </p><p><img src="https://user-images.githubusercontent.com/71251920/151009979-8f6868a8-2edd-4d08-86a5-ef843a877bda.png" alt="How_to_set_Backup_Alert_13"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、&lt;strong&gt;「Azure Monitor を使用した組み込みのアラート」を利用して、Recovery Services コンテナーにてバックアップ構成</summary>
      
    
    
    
    
    <category term="Recovery Services vaults" scheme="https://jpabrs-scem.github.io/blog/tags/Recovery-Services-vaults/"/>
    
  </entry>
  
  <entry>
    <title>SCVMM サーバーおよび SCVMM 管理対象サーバーの自己署名証明書の更新手順</title>
    <link href="https://jpabrs-scem.github.io/blog/SystemCenter/SCVMM_Renew_Crtificate/"/>
    <id>https://jpabrs-scem.github.io/blog/SystemCenter/SCVMM_Renew_Crtificate/</id>
    <published>2022-01-12T03:00:00.000Z</published>
    <updated>2022-02-01T15:19:36.416Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆さんこんにちは、System Center サポートチームの 保科と申します。</p><p>今回は、System Center Virtual Machine Manager (SCVMM) で使用する自己署名証明書の有効期限が切れた場合や、削除をされた場合の対処方法についてご案内いたします。</p><h3 id="本ページが対象とする-SCVMM-バージョン"><a href="#本ページが対象とする-SCVMM-バージョン" class="headerlink" title="[本ページが対象とする SCVMM バージョン]"></a>[本ページが対象とする SCVMM バージョン]</h3><p>SCVMM 2012<br>SCVMM 2012 SP1<br>SCVMM 2012 R2<br>SCVMM 2016<br>SCVMM 2019</p><h3 id="概要"><a href="#概要" class="headerlink" title="[概要]"></a>[概要]</h3><p>SCVMM では、SCVMM サーバー機能をインストールしたサーバーや、SCVMM にて管理対象となる Hyper-V サーバーに SCVMM エージェントがインストールされた際、同時に自己署名証明書も当該サーバーにインストールされます。<br>これは、SCVMM サーバーと管理対象 Hyper-V サーバーの間の通信の安全性を確保するためにインストールされます。<br>そのため、この自己署名証明書は、SCVMM サーバーが管理対象 Hyper-V サーバーと通信を行う際に必須となる証明書となります。</p><p>この自己署名証明書は、フレンドリ名が  “SCVMM_CERTIFICATE_KEY_CONTAINER***” となっており、発行者はそのホスト自身になっています。<br>(*** の部分は SCVMM サーバーもしくは Hyper-V サーバーの完全修飾ドメイン名となります。)<br>この証明書の期限は SCVMM サーバーや、Hyper-V サーバーを SCVMM の管理対象に設定した年の 1/1 から 5 年間に設定されます。<br>例えば 2015/10/26 に Hyper-V ホストを SCVMM の管理対象に設定した場合、設定される証明書の有効期限は 2020/1/1 になります。<br>これは 2015 年中であればいつ Hyper-Vホストを管理対象に追加された場合でも同様の結果となります。</p><p>上記の通りこの証明書の期限は 5 年間 (SCVMM のバージョンによっては 10 年間)となっています。<br>このため、5 年間 (10 年間) が経過するとこの証明書は無効になります。<br>なお、この証明書の有効期限が超過する 1 ヶ月前になりますと、SCVMM サーバー上で以下の警告メッセージが出力されるようになります。</p><blockquote><p>警告 (20583)<br>コンピューター &lt;対象サーバーの完全修飾ドメイン名&gt; の自己署名証明書は既に有効期限切れか、1 か月以内に有効期限切れになります。</p><p>推奨される操作<br>VMM から &lt;対象サーバーの完全修飾ドメイン名&gt; を削除してから追加して、新しい証明書を取得してください。</p></blockquote><p>また何かのトラブルシュートの際などに誤ってこの証明書を削除してしまったりすることも考えられます。<br>その場合、SCVMM サーバーと Hyper-V サーバーの間の通信に問題が発生し、Hyper-V サーバーの管理作業などが正しく動作しなくなります。</p><p>このような場合、SCVMM サーバーもしくは Hyper-V サーバーにインストールされている SCVMM エージェントを再インストールすることで対処することもできますが、証明書を再発行することでも対処することができます。<br>この際の手順は以下の [対処手順 ①] に従って自己署名証明書の再インストールを実施します。<br>また、SCVMM サーバー限定かつ特定の SCVMM バージョン限定の手順とはなりますが、[対処手順 ②] に従った自己署名証明書の更新も実施いただけます。</p><h3 id="対処手順-①"><a href="#対処手順-①" class="headerlink" title="[対処手順 ①]"></a>[対処手順 ①]</h3><ol><li>自己署名証明書を更新いただくサーバーに管理者権限でログインします。</li><li>Windows + R を入力して、[ファイル名を指定して実行] を起動します。</li><li>mmc と入力して [OK] をクリックします。</li><li>表示されたウインドウで、メニュー バーから [ファイル] - [スナップインの追加と削除] を選択します。</li><li>“利用できるスナップイン” から “証明書” を選択し、[追加] をクリックします。</li><li>[証明書スナップイン] ウインドウが表示されたら、”コンピューター アカウント” をチェックし、[次へ] をクリックします。</li><li>[コンピューターの選択] ウインドウでは、既定値のまま [完了] をクリックします。</li><li>[OK] をクリックして、[スナップインの追加と削除] ウインドウを閉じます。</li><li>左側のツリーから、[証明書 (ローカル コンピューター)] -&gt; [個人] -&gt; [証明書] を開きます。</li><li>中央ペインに表示されている証明書のうち、”フレンドリ名” 列に “SCVMM_CERTIFICATE_KEY_CONTAINER***” と表示されてる証明書を選択して削除します。<br>(*** の部分は SCVMM サーバーもしくは Hyper-V サーバーの完全修飾ドメイン名となります。)<br>そのような証明書が既に存在しない場合、そのまま手順 11. に進みます。</li><li>SCVMM サーバー上で、”Virtual Machine Manager Command Shell” を起動します。</li><li>以下のコマンドを実行します。<blockquote><p><code> </code> <code>$credential = get-credential</code> <code> </code></p></blockquote></li><li>表示されたウインドウに、SCVMM サーバーのローカル管理者権限のあるユーザーのユーザー名とパスワードを入力して [OK] をクリックします。</li><li>続いて、以下のコマンドを実行します。<br>(*** の部分は SCVMM サーバーもしくは Hyper-V サーバーの完全修飾ドメイン名を入力します。)<blockquote><p><code> </code> <code>Get-VMMManagedComputer -ComputerName &quot;***&quot; | Register-SCVMMManagedComputer  -Credential $credential</code> <code> </code></p></blockquote></li><li>自己署名証明書を更新されるサーバーに、有効期限が 5 年後 (10 年後) の 1 月 1 日に設定された自己署名証明書が無事再作成されたことを、10. の手順で開いたコンソール上で確認いただきます。<br>手順実施後も証明書が更新されていない場合、画面を最新の情報に更新いただくことで表示される場合がございます。</li></ol><h3 id="対処手順-②"><a href="#対処手順-②" class="headerlink" title="[対処手順 ②]"></a>[対処手順 ②]</h3><p>こちらの手順は、以下の SCVMM バージョンにて追加されたコマンドレットを使用する手順となります。<br>・SCVMM 2016 Update Rollup 10<br>・SCVMM 2019 Update Rollup 2<br>上記のバージョンに SCVMM をアップデートすると、SCVMM サーバーの自己署名証明書を更新する “Update-SCVMMCertificate” コマンドレットがご利用いただけるようになります。<br>SCVMM サーバー限定の手順となり、Hyper-V サーバーに対しては実施いただけない手順となりますが、以下の手順に沿って SCVMM サーバーにインストールされた自己署名証明書を更新いただけます。</p><ol><li>SCVMM サーバーに管理者権限でログインします。</li><li>ログインしたサーバー上で “Virtual Machine Manager Command Shell” を起動します。</li><li>以下のコマンドを実行します。<blockquote><p><code> </code> <code>Update-SCVMMCertificate -VMMServer &#39;***&#39; </code> <code> </code><br><code> </code> <code> (*** の部分は SCVMM サーバーの完全修飾ドメイン名を入力します。)</code> <code> </code></p></blockquote></li><li>自己署名証明書を更新されるサーバーに、有効期限が 5 年後 (10 年後) の 1 月 1 日に設定された自己署名証明書が無事再作成されたことを、”対処手順 ①” の 10. の手順で開けるコンソール上で確認いただきます。<br>手順実施後も証明書が更新されていない場合、画面を最新の情報に更新いただくことで表示される場合がございます。</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆さんこんにちは、System Center サポートチームの 保科と申します。&lt;/p&gt;
&lt;p&gt;今回は、System Center Virtual Machine Manager (SCVMM) で使用する自己署名証明書の有効</summary>
      
    
    
    
    
    <category term="System Center" scheme="https://jpabrs-scem.github.io/blog/tags/System-Center/"/>
    
  </entry>
  
  <entry>
    <title>Azure Files Backup を意図的に失敗させる方法</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureFilesBackup/How_to_fail_AFS_backup/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureFilesBackup/How_to_fail_AFS_backup/</id>
    <published>2022-01-10T03:00:00.000Z</published>
    <updated>2022-02-01T15:19:36.380Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、アラート通知のテスト等のために、<strong>Azure Files （Azure ファイル共有）のバックアップを意図的に失敗させる方法</strong>についてご案内します。<br>方法としては、バックアップ構成しているAzure Files のストレージ アカウントに対して「読み取り専用」ロックを追加しておき、スケジュール バックアップを実施する方法がございます。</p><h2 id="Azure-Files-のAzure-Backup-ジョブを意図的に失敗させる方法"><a href="#Azure-Files-のAzure-Backup-ジョブを意図的に失敗させる方法" class="headerlink" title="Azure Files のAzure Backup ジョブを意図的に失敗させる方法"></a>Azure Files のAzure Backup ジョブを意図的に失敗させる方法</h2><ol><li><p>テスト希望時間に、スケジュールされたバックアップを実行させたい場合は、（ストレージ アカウントへ「読み取り専用」ロックを追加する前に）Recovery Services コンテナー ＞ バックアップ ポリシー にて、スケジュール バックアップを実行したい時間を変更しておきます。<br><img src="https://user-images.githubusercontent.com/71251920/148649503-d62312ca-088e-49ea-98a1-f503b4b0f5e2.png"></p></li><li><p>バックアップ構成をしている Azure Files のストレージ アカウントに対して「読み取り専用」ロックを追加しておき、スケジュール バックアップが実行開始されるまで待ちます。(または今すぐバックアップを実行します。)<br>（※ 「AzureBackupProtectionLock」という「削除」ロックが自動的に追加されている場合、「読み取り専用」ロックを追加してもバックアップが成功します。<br>一度「AzureBackupProtectionLock」ロックを削除したうえで「読み取り専用」ロックを追加しておきます。）<br><img src="https://user-images.githubusercontent.com/71251920/148649504-9477278b-381c-4966-ad88-c38750bddf3f.png"><br><img src="https://user-images.githubusercontent.com/71251920/148649505-f9da8577-1942-42a8-9ffb-1b6b01d365a1.png"><br><img src="https://user-images.githubusercontent.com/71251920/148649491-01ec384a-493e-4c28-b40c-5150c3fe894a.png"></p></li><li><p>バックアップの実行後に、Recovery Services コンテナー ＞ バックアップ ジョブ にて、ジョブが失敗していることを確認します。<br><img src="https://user-images.githubusercontent.com/71251920/148649493-f43a1cdf-dae3-4b30-b3a0-7efa24eb8d7d.png"><br>「View details」をクリックすると、「Error Code：400190」にてAzure Files のバックアップが失敗していることが確認できます。<br><img src="https://user-images.githubusercontent.com/71251920/148649494-a738edda-9b29-4b64-8d49-b89281946dce.png"></p></li><li><p>指定したメールアドレスへアラート通知を送信するよう設定している場合、指定のメールアドレスへアラート通知が送信されていることが確認できます。</p></li></ol><p>アラート設定に関しましては下記をご覧ください。<br>・「Azure Monitor を使用した組み込みのアラート」を利用したバックアップ ジョブ失敗のアラート通知作成例<br><a href="https://jpabrs-scem.github.io/blog/Recovery%20Services%20vaults/How_to_set_Backup_Alert/">https://jpabrs-scem.github.io/blog/Recovery%20Services%20vaults/How_to_set_Backup_Alert/</a></p><p><img src="https://user-images.githubusercontent.com/71251920/148649496-1799a8de-0156-4556-b02f-447c64605e69.png"></p><p><img src="https://user-images.githubusercontent.com/71251920/148649498-49c6aea5-4381-4cdc-8e1c-5a181eec5e5d.png"></p><ol start="5"><li>バックアップ センター でもアラートを確認可能です。<br>バックアップ センター ＞ 概要 ＞ データソースの種類：Azure Files（Azure Storage）を選択します。<br>「ジョブ(過去 24 時間)」欄に「スケジュールされたバックアップ 失敗」にカウントされていること、「アクティブなアラート(過去 24 時間)」欄に「Sev1」としてカウントされていることが確認できます。</li></ol><p><img src="https://user-images.githubusercontent.com/71251920/148649499-e7dd44af-21e0-4217-b1b6-638e17ed6f16.png"></p><p><img src="https://user-images.githubusercontent.com/71251920/148649500-fce2b072-d882-416e-a919-9124b9cf314a.png"></p><p>アラート通知の検証後は、ストレージ アカウントに対して自動的に追加されていた「削除」ロックを再追加・「読み取り専用」ロックを削除し、元のロック状態に戻します。</p><p><img src="https://user-images.githubusercontent.com/71251920/148649502-836ffea1-9659-475d-9230-8ec612158642.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、アラート通知のテスト等のために、&lt;strong&gt;Azure Files （Azure ファイル共有）のバックアップを意図的に失敗させる方法&lt;/strong</summary>
      
    
    
    
    
    <category term="Azure Files Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Files-Backup/"/>
    
  </entry>
  
  <entry>
    <title>AdtAdmin / setquery でアクセス拒否エラー(0x00000005)が発生する場合の対処法</title>
    <link href="https://jpabrs-scem.github.io/blog/SystemCenter/SCOM_AccessError_0x00000005/"/>
    <id>https://jpabrs-scem.github.io/blog/SystemCenter/SCOM_AccessError_0x00000005/</id>
    <published>2022-01-06T03:00:00.000Z</published>
    <updated>2022-02-01T15:19:36.416Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、System Center サポートチームの 佐藤 です。</p><p>本日は System Center Operations Manager（以後 SCOM） の機能である 監査コレクション サービス (ACS) （<a href="https://docs.microsoft.com/ja-jp/system-center/scom/deploy-install-acs?view=sc-om-2019">監査コレクション サービス (ACS) コレクターとデータベースをインストールする方法 | Microsoft Docs</a>）において WQL クエリ設定を実行する際に必要な設定をご紹介いたします。</p><p>ACS は WQL（<a href="https://docs.microsoft.com/ja-jp/sql/relational-databases/wmi-provider-server-events/using-wql-with-the-wmi-provider-for-server-events?view=sql-server-ver15">WMI Provider for Server Events と WQL の使用 - SQL Server | Microsoft Docs</a>）を使用して取得対象のイベントの範囲を絞ることが可能です。<br>これは ACS データを保存するデータベースの肥大化の防止、また不要なデータを取得しないことでSCOM 管理サーバー/監視対象サーバーの処理負荷の軽減に寄与いたします。</p><p>しかし、規定の設定では下記のように WQL を実行しようとする際にアクセス拒否エラーが出力される事が確認されております。</p><blockquote><p>■コマンド例<br><code> </code> <code>C:\Windows\System32\Security\AdtServer&gt;AdtAdmin /setquery /query:&quot;SELECT * FROM AdtsEvent WHERE EventId=XXX&quot; </code> <code> </code></p></blockquote><p>その際はレジストリエディタにて以下キーに対してユーザー “NETWORK SERVICE” へ フルコントールなどの “値の設定”の権限付与することで改善されます。<br>こちらの設定については SCOM 用に定義されているパラーメータ設定であり、設定変更により他アプリケーションへの影響はございませんのでご安心ください。</p><blockquote><p>■キー<br><code> </code> <code>HKLM\SYSTEM\CurrentControlSet\Services\AdtServer\Parameters</code> <code> </code></p></blockquote><p>参考図：</p><p><img src="https://user-images.githubusercontent.com/71251920/148327138-6c2ba2db-ced8-4408-9c43-144a170ee18d.png" alt="参考図"></p><blockquote><p>対象バージョン：<br>　System Center Operations Manager 2012 R2<br>　System Center Operations Manager 2016<br>　System Center Operations Manager 2019</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、System Center サポートチームの 佐藤 です。&lt;/p&gt;
&lt;p&gt;本日は System Center Operations Manager（以後 SCOM） の機能である 監査コレクション サービス (</summary>
      
    
    
    
    
    <category term="System Center" scheme="https://jpabrs-scem.github.io/blog/tags/System-Center/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM のリストア (既存を置換) が失敗する</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Restorefail_invalid_protection/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Restorefail_invalid_protection/</id>
    <published>2022-01-05T03:00:00.000Z</published>
    <updated>2022-02-01T15:19:36.388Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、Azure VM Backup にて、対象の仮想マシンを <strong>「VM の復元」-「構成の復元：既存を置換」にて「復元」を実行すると、「OlrBackupFailed」エラーが発生する</strong>場合の原因と対処法についてご案内します。</p><p>上記「OlrBackupFailed」エラーが発生した場合、考えられる要因として、対象の仮想マシンに対して「バックアップの停止」を行っていることが考えられます。<br>（対象の仮想マシンに対して「バックアップの停止」を行っていない、以下のシナリオに合致しない等あれば、弊社までお問い合わせ願います。）</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. 該当シナリオ</a><br><a href="#2">2. 原因</a><br><a href="#3">3. 「構成の復元：既存を置換」として復元したい場合の回避策</a></p><hr><h2 id="1-該当シナリオ"><a href="#1-該当シナリオ" class="headerlink" title="1. 該当シナリオ"></a>1. 該当シナリオ<a id="1"></a></h2><p>１） 「VM の復元」を実行したい仮想マシンに対して、「バックアップの停止」を実施済である<br>（下図のように、「バックアップの停止」ボタンが非活性、「バックアップの再開」ボタンが活性、「前回のバックアップの状態：警告（バックアップが無効）」と表示されている状態となります）<br><img src="https://user-images.githubusercontent.com/71251920/148112964-af3db82c-a70e-4fe0-bdab-8d0dddc58086.png" alt="invalid_VM_backup"></p><p>２）上記「バックアップの停止」を実施済の状態で、「VM の復元」をクリックし、「構成の復元：既存を置換」を選択している状態で「復元」を実行する<br><img src="https://user-images.githubusercontent.com/71251920/148112978-b25ab648-9245-4db6-a81e-bc7279595399.png" alt="VM_OLR"></p><p>３）「バックアップ ジョブ」画面にて、以下の状態で処理が終了する。<br>「Operation : Restore」・・・「StatusCompleted with warnings」「Error Code : OlrBackupFailed」<br>「Operation : Backup」・・・「Status : Failed」「Error Code : UserErrorBcmDatasourceNotPresent」<br><img src="https://user-images.githubusercontent.com/71251920/148112973-7caf6f19-c212-4f22-90ea-558998abc2d7.png" alt="OLR_Error_Jobs"><br>（「Operation : Restore」側の詳細画面）<br><img src="https://user-images.githubusercontent.com/71251920/148112977-0cd72cb6-c2bb-403f-8100-cd25a5b02b44.png" alt="Restore_error_details"><br>（「Operation : Backup」側の詳細画面）<br><img src="https://user-images.githubusercontent.com/71251920/148112975-73526fb8-4586-4cc9-863e-c3d314999398.png" alt="Backup_error_details"></p><p>上記のシナリオてに合致した場合、「復元」がエラーコード「OlrBackupFailed」となる理由は、仮想マシンに対して、「バックアップの停止」が行われているためである可能性が高いです。</p><h2 id="2-原因"><a href="#2-原因" class="headerlink" title="2. 原因"></a>2. 原因<a id="2"></a></h2><p>「構成の復元：既存を置換」で「復元」を実行した場合、復元の流れとして、復元ポイントからディスクが復元された後、「復元されたディスクに置換する前の仮想マシンの状態」に対するバックアップ（※）が実施されます。<br>「復元されたディスクに置換する前の仮想マシンの状態」に対するバックアップ（※）が成功した場合、復元されたディスクとの置換作業が実施されます。<br>「バックアップの停止」中の場合は、（※）のバックアップ処理が行えず「Status：Failed」となり、復元ジョブもエラーコード「OlrBackupFailed」となります。<br>仮想マシンに対するディスクの置換は行われず、指定した復元ポイント時点のディスクが復元され、Azure ポータル画面の「ディスク」一覧にて確認可能となります。</p><h2 id="3-「構成の復元：既存を置換」として復元したい場合の回避策"><a href="#3-「構成の復元：既存を置換」として復元したい場合の回避策" class="headerlink" title="3. 「構成の復元：既存を置換」として復元したい場合の回避策"></a>3. 「構成の復元：既存を置換」として復元したい場合の回避策<a id="3"></a></h2><p>下記の 2 種類の方法が考えられます。<br>１．対象の仮想マシンに対して、「バックアップの再開」をクリックし、バックアップを有効にした状態で、再度「VM の復元」-「構成の復元：既存を置換」を実施する。<br>これにより、復元時に自動トリガーされるバックアップ ジョブ（※）も正常に実施され、復元ジョブも成功します。<br><img src="https://user-images.githubusercontent.com/71251920/148112970-9689b050-a986-4de4-b752-274624c4a17e.gif" alt="VM_backup_resume"></p><p>２．対象の仮想マシンに対して、「バックアップの停止」を実施済の状態のまま、「VM の復元」-「構成の復元：既存を置換」を実施する。<br>この場合、前述の通り「Operation : Restore」「StatusCompleted with warnings」となりますが、ディスクとしては復元されます。<br>ディスクとして復元後、対象の仮想マシンを「停止済み (割り当て解除)」としている状態で、仮想マシンにアタッチされているディスクと、復元したディスクを手動でスワップすることで、復元ポイント時点の仮想マシンの状態に戻すことが可能です。</p><p>Azure Portal ＞  対象の仮想マシン ＞ 左ペインのディスク ＞ 「OSディスクのスワップ」にて復元されたディスクと現在のディスクをスワップします。<br><img src="https://user-images.githubusercontent.com/71251920/148112967-eaab9628-7f5e-4fd4-a11f-63faa6ad75b5.jpg" alt="Disk_Swap"></p><p>「既存を置換」にて「復元」を実行すると、「OlrBackupFailed」エラーが発生するという場合の対処法について、ご案内は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、Azure VM Backup にて、対象の仮想マシンを &lt;strong&gt;「VM の復元」-「構成の復元：既存を置換」にて「復元」を実行すると、「OlrB</summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>料金計算ツールを用いた Azure VM Backup の料金見積もりについて</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_calculator/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_calculator/</id>
    <published>2021-12-16T03:00:00.000Z</published>
    <updated>2022-02-01T15:19:36.388Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポート の山本です。<br>今回は、料金計算ツールを用いた Azure VM Backup の料金見積もりについて、ご案内いたします。</p><p>Azure VM Backup ではバックアップ ジョブのスケジュールを日時、週次にて計画することができます。<br>一方、現状の料金計算ツールでは週次のバックアップ スケジュールのシナリオに対応しておらず、<strong>日次のシナリオのみの見積もりが可能</strong>となっております。</p><p>そのため、現時点では週次の見積もりに計算ツールを利用していただくことが叶いません。<br>・料金計算ツール<br><a href="https://azure.microsoft.com/ja-jp/pricing/calculator/">https://azure.microsoft.com/ja-jp/pricing/calculator/</a></p><p>下記の赤枠部分が必須となっております。<br><img src="https://user-images.githubusercontent.com/71251920/146237377-08217f47-4afa-45d5-a112-7c572e5187cc.png" alt="vm_backup_calculator"></p><p>現在、週次シナリオも課金ツールにて見積もりができるよう弊社開発部門へのフィードバックが複数行われております。<br>お客様側では以下のサイトを通じてステータスを確認することが可能です。</p><p>・The scenario in Pricing Calculator to run only weekly backup.<br><a href="https://feedback.azure.com/d365community/idea/7aa7fd4a-0925-ec11-b6e6-000d3a4f0858">https://feedback.azure.com/d365community/idea/7aa7fd4a-0925-ec11-b6e6-000d3a4f0858</a></p><p>上記サイトは機能改善のリクエストを行うサイトであり、リクエストの中で Vote (改善要望) が多いものや影響度の大きいものを判断して優先して修正に取り組みます。<br>そのため、もし週次のスケジュール見積もりを今後ご要望の場合には、お手数ではございますが可能であれば上記の URL より機能改善リクエストに Vote いただけますと幸いです。<br>Vote の際にはメールアドレスを入力することができ、本投稿が Completed した際に指定のメールアドレスに通知される仕組みとなっております。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポート の山本です。&lt;br&gt;今回は、料金計算ツールを用いた Azure VM Backup の料金見積もりについて、ご案内いたします。&lt;/p&gt;
&lt;p&gt;Azure VM Backup </summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup を意図的に失敗させる方法</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/</id>
    <published>2021-11-22T03:00:00.000Z</published>
    <updated>2022-02-01T15:19:36.388Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートの 相田 です。<br>アラートのテスト等のため “Azure VM Backup を失敗させたい” というお問い合わせをよくいただきます。<br>今回は、<strong>Azure VM Backup を意図的に失敗させる方法</strong>について、ご案内いたします。</p><h2 id="意図的にAzure-VM-Backup-エラーを発生させる仕組み"><a href="#意図的にAzure-VM-Backup-エラーを発生させる仕組み" class="headerlink" title="意図的にAzure VM Backup エラーを発生させる仕組み"></a>意図的にAzure VM Backup エラーを発生させる仕組み</h2><p>VM 内の Windows Azure Guest Agent (VM agent) が停止させ、Azure 側の Recovery Services コンテナー (Azure Backup service) との通信ができない状態を作ります。<br>この状態で Backup 取得をしようとすると、VM agent と通信できないためにエラー (Error Code ”UserErrorGuestAgentStatusUnavailable”) が発生し、Backup が失敗となります。<br><img src="https://user-images.githubusercontent.com/71251920/142736316-5995d329-63d1-4b63-acd5-7f3da9f90cf9.png" alt="How_to_Backup_Fail"></p><h2 id="バックアップを故意に失敗させる方法-手順概略"><a href="#バックアップを故意に失敗させる方法-手順概略" class="headerlink" title="バックアップを故意に失敗させる方法 (手順概略)"></a>バックアップを故意に失敗させる方法 (手順概略)</h2><p>・「バックアップを故意に失敗させる方法 (Windows VM の場合) 」</p><blockquote><p>   1.Backup 対象の VM にリモート ログイン<br>   2.Services 内で “RbAgent” と “Windows Azure Guest Agent” の停止、スタートアップの無効化<br>   3.Backup を実施し、エラーの確認<br>   4.Agent の再度起動</p></blockquote><p>・「バックアップを故意に失敗させる方法 (Linux VM の場合) 」</p><blockquote><p>   1.Backup 対象の VM に SSH 接続<br>   2.Agent の停止、および自動起動停止<br>   3.Agent の Service を停止<br>   　（Ubuntu の場合）<code> </code> <code>sudo systemctl stop walinuxagent </code> <code> </code><br>   　（Ubuntu 以外の場合）<code> </code> <code>sudo systemctl stop waagent</code> <code> </code><br>   4.自動起動を停止<br>   　（Ubuntu の場合）<code> </code> <code>sudo systemctl disable walinuxagent </code> <code> </code><br>   　（Ubuntu 以外の場合）<code> </code> <code>sudo systemctl disable waagent</code> <code> </code><br>   5.Backup を実行し、エラーの確認<br>   ・Agent の再起動<br>   （Ubuntu の場合）<br>   　　<code> </code> <code>sudo systemctl start walinuxagent </code> <code> </code><br>       　　<code> </code> <code>sudo systemctl enable walinuxagent </code> <code> </code><br>       　　<code> </code> <code>systemctl status walinuxagent </code> <code> </code><br>       （Ubuntu 以外の場合）<br>       　　<code> </code> <code>sudo systemctl start waagent</code> <code> </code><br>       　　<code> </code> <code>sudo systemctl enable waagent</code> <code> </code><br>   　  　<code> </code> <code>systemctl status waagent</code> <code> </code></p></blockquote><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. バックアップを故意に失敗させる方法 (Windows VM の場合)</a><br><a href="#2">2. バックアップを故意に失敗させる方法 (Linux VM の場合)</a></p><hr><h2 id="1-バックアップを故意に失敗させる方法-Windows-VM-の場合-所要時間-2時間～6時間"><a href="#1-バックアップを故意に失敗させる方法-Windows-VM-の場合-所要時間-2時間～6時間" class="headerlink" title="1. バックアップを故意に失敗させる方法 (Windows VM の場合)  (所要時間 : 2時間～6時間)"></a>1. バックアップを故意に失敗させる方法 (Windows VM の場合)  (所要時間 : 2時間～6時間)<a id="1"></a></h2><h3 id="1-1-環境"><a href="#1-1-環境" class="headerlink" title="1.1. 環境"></a>1.1. 環境</h3><p>本項目では以下の環境で検証を実施しております。<br>VM名 : vm-BackupFailTest-win2016<br>OS : Windows (Windows Server 2016 Datacenter) Version 1607<br>Recovery Service コンテナー名 : vault-BackupFailTest</p><h3 id="1-2-手順概略"><a href="#1-2-手順概略" class="headerlink" title="1.2.手順概略"></a>1.2.手順概略</h3><p>“サービス” から プロセス “RdAgent”、”Windows Azure Guest Agent” を停止し、スタートアップを無効化しバックアップを実行します。<br>バックアップが失敗したらそれぞれをもとに戻します。</p><blockquote><ol><li>Backup 対象の VM にリモート ログイン</li><li>Services 内で “RbAgent” と “Windows Azure Guest Agent” の停止、スタートアップを無効化</li><li>Portal にて Backup を実施し、エラーの確認</li><li>Agent の再起動</li></ol></blockquote><h3 id="1-3-詳細手順"><a href="#1-3-詳細手順" class="headerlink" title="1.3.詳細手順"></a>1.3.詳細手順</h3><p>Backup 対象の VM : Azure portal上で作成した、Backup 対象の VM<br>Backup 対象の VM にリモートログインし、Services を開き、下記 2 つのサービスに対し設定を行います。</p><h4 id="RdAgent"><a href="#RdAgent" class="headerlink" title="RdAgent"></a>RdAgent</h4><p>最初に “RdAgent” を停止、スタートアップ無効にします。<br>・Sercives 一覧の画面で “RdAgent” を右クリック → “Properties” を選択します。<br>・Startup type で “Disabled” を選択 → Service status で Stop を選択 → Service 停止プロセスが完了した後、”OK” を選択します。<br>・Services 一覧の画面にて、 RbAgent の Status の Running が消えており、Startup Type が Disabled 場合、 RbAgent の停止が完了となります。</p><p><img src="https://user-images.githubusercontent.com/71251920/142736495-97875c34-577f-483d-a46e-c1f7c53d5133.png" alt="RdAgent"></p><h4 id="Windows-Azure-Guest-Agent"><a href="#Windows-Azure-Guest-Agent" class="headerlink" title="Windows Azure Guest Agent"></a>Windows Azure Guest Agent</h4><p>次に “Windows Azure Guest Agent” を停止、スタートアップ無効にします。<br>・Sercives 一覧の画面で “Windows Azure Guest Agent” を右クリック → “Properties” を選択します。<br>・Startup type で “Disabled” を選択 → Service status で Stop を選択 → Service 停止プロセスが完了した後、 “OK” を選択します。<br>・Services 一覧の画面にて、 Windows Azure Guest Agent の Status の Running が消えており、Startup Type が Disabled 場合、 Windows Azure Guest Agent の停止が完了となります。</p><p><img src="https://user-images.githubusercontent.com/71251920/142736485-37260305-e959-4d30-ab6d-d2167dc8096c.png" alt="WindowsAzureGuestAgent"></p><p>以上で、VM 側の設定は完了となります。</p><h4 id="Backup-を実施し、エラーの確認"><a href="#Backup-を実施し、エラーの確認" class="headerlink" title="Backup を実施し、エラーの確認"></a>Backup を実施し、エラーの確認</h4><p>・Azure portal を開いていただき、VM のページに移動 → “バックアップ” を選択 → “今すぐパックアップ” を選択。<br>この操作により、バックアップが開始されます。<br>・ 次に Backup の状態を確認します。<br>　Recovery Services コンテナーのページへ移動 → “バックアップ ジョブ” を選択後、最新の Backup の “View details” を選択します。<br>このページで Backup の状態を確認することができます。<br>結果が表示されるまで数時間掛かりますので、 定期的に (1 時間おきなど) 更新して確認することをお勧めいたします。</p><p><img src="https://user-images.githubusercontent.com/71251920/142736544-cc800afd-14c5-400d-9b9c-74d535fdf1f4.png" alt="FailCheck_01"></p><p>・Take Snapshot の Status が Failed 、Error Code <strong>”UserErrorGuestAgentStatusUnavailable”</strong> となり、失敗し完了となります。本環境では 5 時間 25 分かかりました。　</p><p><img src="https://user-images.githubusercontent.com/71251920/142736548-c5cc94e5-4343-4c81-9b8b-52ef8c46f4d8.png" alt="FailCheck_02"></p><h4 id="Agentの再起動"><a href="#Agentの再起動" class="headerlink" title="Agentの再起動"></a>Agentの再起動</h4><p>・エラーの発生確認完了後は、 VM に再度ログインして頂き、各 Agent の Service properties 画面で、Start up type を <strong>“Automatic”</strong> に、Service Status で <strong>“Start”</strong> を選択し、 Agent を再度起動させてください。</p><h2 id="2．バックアップを故意に失敗させる方法-Linux-VM-の場合-所要時間-2時間～6時間"><a href="#2．バックアップを故意に失敗させる方法-Linux-VM-の場合-所要時間-2時間～6時間" class="headerlink" title="2．バックアップを故意に失敗させる方法 (Linux VM の場合) (所要時間 : 2時間～6時間) "></a>2．バックアップを故意に失敗させる方法 (Linux VM の場合) (所要時間 : 2時間～6時間) <a id="2"></a></h2><h3 id="2-1-環境"><a href="#2-1-環境" class="headerlink" title="2.1. 環境"></a>2.1. 環境</h3><p>本項目では以下の環境で検証を実施しております。</p><h4 id="OS"><a href="#OS" class="headerlink" title="OS"></a>OS</h4><blockquote><p>VM名 : vm-BackupFailTest-linux-suse / OS : Linux (sles 15.2)<br>VM 名 : vm-BackupFailTest-linux-rhel / OS : Linux (redhat 8.2)<br>VM 名 : vm-BackupFailTest-linux-ubuntu /OS : Linux (ubuntu 20.04)<br>VM 名 : vm-BackupFailTest-linux-centos / OS : Linux (centos 7.9.2009)</p></blockquote><h4 id="Recovery-Services-コンテナー"><a href="#Recovery-Services-コンテナー" class="headerlink" title="Recovery Services コンテナー"></a>Recovery Services コンテナー</h4><blockquote><p>Recovery Service コンテナー名 : vault-BackupFailTest</p></blockquote><h3 id="2-2手順概略"><a href="#2-2手順概略" class="headerlink" title="2.2手順概略"></a>2.2手順概略</h3><p>下記コマンドを実行しagent プロセスを停止しバックアップを失敗させます。<br>失敗したのを確認したのち、Agent の再起動を行います。</p><h4 id="Agent-の停止"><a href="#Agent-の停止" class="headerlink" title="Agent の停止"></a>Agent の停止</h4><blockquote><p>Backup 対象の VM に SSH 接続します。</p></blockquote><blockquote><p>・以下のコマンドで、 Agent の Service を停止します。<br>（Ubuntu の場合）sudo systemctl stop walinuxagent<br>（Ubuntu 以外の場合）sudo systemctl stop waagent</p></blockquote><blockquote><p>・以下のコマンドで、自動起動を停止します。<br>（Ubuntu の場合）sudo systemctl disable walinuxagent<br>（Ubuntu 以外の場合）sudo systemctl disable waagent</p></blockquote><h4 id="Agent-の再起動"><a href="#Agent-の再起動" class="headerlink" title="Agent の再起動"></a>Agent の再起動</h4><p>バックアップ エラーの検証後は、以下コマンドで waagent を再開します。</p><blockquote><p>（Ubuntu の場合）<br>    sudo systemctl start walinuxagent<br>    sudo systemctl enable walinuxagent<br>    systemctl status walinuxagent<br>（Ubuntu 以外の場合）<br>    sudo systemctl start waagent<br>    sudo systemctl enable waagent<br>    systemctl status waagent</p></blockquote><h3 id="2-3-詳細手順"><a href="#2-3-詳細手順" class="headerlink" title="2.3. 詳細手順"></a>2.3. 詳細手順</h3><p>Linux の場合、 OS により Agent のプロセス名が異なります。</p><h4 id="Agent-プロセス名"><a href="#Agent-プロセス名" class="headerlink" title="Agent プロセス名"></a>Agent プロセス名</h4><p>Ubuntu の場合</p><blockquote><p>walinuxagent.service</p></blockquote><p>Suse &amp; RHEL &amp; CentOS の場合</p><blockquote><p>waagent.service</p></blockquote><p>下記の手順で agentのプロセスを停止し、バックアップを失敗させます。</p><h4 id="Agent-の停止-1"><a href="#Agent-の停止-1" class="headerlink" title="Agent の停止"></a>Agent の停止</h4><p>・Backup 対象の VM に SSH 接続します。</p><blockquote><p>・以下のコマンドで、 Agent の Service を停止します。<br>（Ubuntu の場合）sudo systemctl stop walinuxagent<br>（Ubuntu 以外の場合）sudo systemctl stop waagent</p></blockquote><blockquote><p>・以下のコマンドで、自動起動を停止します。<br>（Ubuntu の場合）sudo systemctl disable walinuxagent<br>（Ubuntu 以外の場合）sudo systemctl disable waagent</p></blockquote><blockquote><p>・以下のコマンドで、 Agent の Service の状態を確認できます。<br>（Ubuntu の場合）systemctl status walinuxagent<br>（Ubuntu 以外の場合）systemctl  waagent</p></blockquote><h4 id="Ubuntu-環境の実行例"><a href="#Ubuntu-環境の実行例" class="headerlink" title="Ubuntu 環境の実行例"></a>Ubuntu 環境の実行例</h4><p><img src="https://user-images.githubusercontent.com/71251920/142736815-a24dfbd6-e29c-4a08-8c90-604a8fdbae81.png" alt="Ubuntu_agent_stop_01"></p><p><img src="https://user-images.githubusercontent.com/71251920/142736817-6a1fee8c-7bd2-4d5b-9bc5-c9e8ffda6f7b.png" alt="Ubuntu_agent_stop_02"><br>RHEL 環境の実行例<br><img src="https://user-images.githubusercontent.com/71251920/142736834-94f46a91-f554-4de5-b6ea-7089b9607ff5.png" alt="RHEL_agent_stop_01"></p><p><img src="https://user-images.githubusercontent.com/71251920/142736825-0e6032e3-f26f-4760-9f0b-5772d4a02168.png" alt="RHEL_agent_stop_02"></p><h4 id="バックアップの実行-amp-失敗確認"><a href="#バックアップの実行-amp-失敗確認" class="headerlink" title="バックアップの実行 &amp; 失敗確認"></a>バックアップの実行 &amp; 失敗確認</h4><p>バックアップを実行し、バックアップ ジョブ が失敗したことを確認します。<br>*バックアップの実行から失敗まで数時間かかる場合がございます。<br>Status が Failed 、Error Code <strong>”UserErrorGuestAgentStatusUnavailable”</strong> となり、失敗し完了となります。本環境では 4 時間 20 分かかりました。　</p><p><img src="https://user-images.githubusercontent.com/71251920/142736877-fd3190e0-596a-4a51-b0d2-f682b2a34a3e.png" alt="FailCheck_03"></p><h4 id="Agent-の再起動-1"><a href="#Agent-の再起動-1" class="headerlink" title="Agent の再起動"></a>Agent の再起動</h4><p>バックアップ エラーの検証後は、以下コマンドで waagent を再開します。</p><blockquote><p>（Ubuntu の場合）<br>   sudo systemctl start walinuxagent<br>   sudo systemctl enable walinuxagent<br>   systemctl status walinuxagent<br>（Ubuntu 以外の場合）<br>   sudo systemctl start waagent<br>   sudo systemctl enable waagent<br>   systemctl status waagent</p></blockquote><h4 id="Ubuntu-環境の実行例-1"><a href="#Ubuntu-環境の実行例-1" class="headerlink" title="Ubuntu 環境の実行例"></a>Ubuntu 環境の実行例</h4><p><img src="https://user-images.githubusercontent.com/71251920/142736924-8e033f57-60aa-449e-bb34-2fb5c410d633.png" alt="Ubuntu_agent_start"></p><h4 id="RHEL-環境の実行例"><a href="#RHEL-環境の実行例" class="headerlink" title="RHEL 環境の実行例"></a>RHEL 環境の実行例</h4><p><img src="https://user-images.githubusercontent.com/71251920/142736923-43d72bbc-e3cb-46a4-825b-a4b71fe61d9a.png" alt="RHEL_agent_start"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートの 相田 です。&lt;br&gt;アラートのテスト等のため “Azure VM Backup を失敗させたい” というお問い合わせをよくいただきます。&lt;br&gt;今回は、&lt;strong&gt;Az</summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup における Take Snapshot フェーズの確認方法</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_check_VM_backup_Subtask/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_check_VM_backup_Subtask/</id>
    <published>2021-11-18T03:00:00.000Z</published>
    <updated>2022-02-01T15:19:36.388Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートの山本です。<br>今回はお問い合わせをいただくことが多い、 <strong>“Azure VM Backup における Take Snapshot フェーズの確認方法”</strong>  について解説させていただきます。<br>Azure VM Backup では  Take Snapshot フェーズ が終わっていれば VM の再起動などを実施いただいても影響がないため、<strong>Take Snapshot フェーズのステータス確認を確認したい、かかった時間を知りたい</strong>、というお問い合わせをよくいただきます。</p><p>まず、はじめに前提知識として Azure VM Backup ではバックアップを取得する際に下記 2 つのサブタスクがございます。<br>1.Take Snapshot (スナップショットの取得)<br>2.Transfer data to vault (Recovery Services コンテナーへの転送)<br><img src="https://user-images.githubusercontent.com/71251920/142253918-138343ac-b7dc-4a35-9e6e-180b4b5542f8.png" alt="Azure VM Backupの 2 つのサブタスク"></p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. サブタスク (Take Snapshot フェーズ) 確認方法</a><br> <a href="#1-1">1-1. Azure Portal を用いたサブタスク (Take Snapshot フェーズ) 確認方法</a><br> <a href="#1-2">1-2. Azure CLI を用いたサブタスク (Take Snapshot フェーズ) 確認方法</a><br> <a href="#1-3">1-3. Azure PowerShell を用いたサブタスク (Take Snapshot フェーズ) 確認方法</a><br><a href="#2">2. サブタスク (Take Snapshot フェーズ) にかかった時間を確認する方法</a><br> <a href="#2-1"> フィードバックご協力のお願い</a></p><hr><h2 id="1-サブタスク-Take-Snapshot-フェーズ-確認方法"><a href="#1-サブタスク-Take-Snapshot-フェーズ-確認方法" class="headerlink" title="1. サブタスク (Take Snapshot フェーズ) 確認方法"></a>1. サブタスク (Take Snapshot フェーズ) 確認方法<a id="1"></a></h2><p>サブタスク確認方法は <strong>Azure Portal で確認する方法</strong>、および、 <strong>Azure CLI や Azure PowerShell といった CLI を用いた方法</strong>がございます。<br>今回弊社検証環境で確認結果も添えてお伝えさせていただきます。<br>また Recovery Services コンテナーのことを RSV と略して表記している部分がございます。</p><ul><li>検証環境情報<br>まず、はじめに今回の検証環境の情報です。<blockquote><p>VM名：VM-Win10<br>リソースグループ：RG-alwaysONVM<br>Recovery Services コンテナー：RSV-JPE-LRS<br>リソースグループ：RG-NormalTest</p></blockquote></li></ul><h3 id="1-1-Azure-Portal-を用いたサブタスク-Take-Snapshot-フェーズ-確認方法"><a href="#1-1-Azure-Portal-を用いたサブタスク-Take-Snapshot-フェーズ-確認方法" class="headerlink" title="1-1. Azure Portal を用いたサブタスク (Take Snapshot フェーズ) 確認方法"></a>1-1. Azure Portal を用いたサブタスク (Take Snapshot フェーズ) 確認方法<a id="1-1"></a></h3><p>[対象の Recovery Services コンテナー] → 左ペインの [バックアップ ジョブ] → 対象のバックアップ ジョブの [View details] → [Sub Tasks] の手順で確認いただくことが可能です。</p><p><img src="https://user-images.githubusercontent.com/71251920/142235689-8f2a6b5d-44b9-47f4-80fe-571407e09e47.png" alt="Check_Subtask"></p><h3 id="1-2-Azure-CLI-を用いたサブタスク-Take-Snapshot-フェーズ-確認方法"><a href="#1-2-Azure-CLI-を用いたサブタスク-Take-Snapshot-フェーズ-確認方法" class="headerlink" title="1-2. Azure CLI を用いたサブタスク (Take Snapshot フェーズ) 確認方法"></a>1-2. Azure CLI を用いたサブタスク (Take Snapshot フェーズ) 確認方法<a id="1-2"></a></h3><p>今回は Windows の PowerShell を用いて Azure CLI を実行します。</p><h4 id="0-事前準備"><a href="#0-事前準備" class="headerlink" title="0.事前準備"></a>0.事前準備</h4><p>　 Azure へログインします。ログインしている環境であれば不要です。</p><blockquote><p>コマンド：<code> </code> <code>az login</code> <code> </code></p></blockquote><h4 id="1-バックアップ-ジョブのステータス確認-Name-値-の取得"><a href="#1-バックアップ-ジョブのステータス確認-Name-値-の取得" class="headerlink" title="1.バックアップ ジョブのステータス確認 (.Name 値 の取得)"></a>1.バックアップ ジョブのステータス確認 (.Name 値 の取得)</h4><blockquote><p>コマンド：<code> </code> <code>az backup job list --resource-group &lt; RSV リソースグループ名&gt; --vault-name &lt; RSV 名&gt; --status inprogress​ -o table</code> <code> </code><br>コマンド例：<code> </code> <code>az backup job list --resource-group RG-NormalTest --vault-name RSV-JPE-LRS --status inprogress​ -o table</code> <code> </code></p></blockquote><p>上記コマンドを実行いただくと実行中のバックアップ ジョブの name 値が取得できます。<br> 出力結果を Azure VM Backup の実行中のバックアップ ジョブに限定する場合は下記のオプションを付けることで可能です。</p><blockquote><p>コマンド： <code> </code> <code>--backup-management-type AzureIaasVM</code> <code> </code> </p></blockquote><p>　下記例 “name” : “2a8c96f8-c282-4f62-9286-fda08088047e”<br><img src="https://user-images.githubusercontent.com/71251920/142236195-c47b1fe8-73b0-401e-a050-43be7c4a35d6.png" alt="Check_name_value"></p><h4 id="2-サブタスク-Take-Snapshot-フェーズ-のステータス確認"><a href="#2-サブタスク-Take-Snapshot-フェーズ-のステータス確認" class="headerlink" title="2.サブタスク (Take Snapshot フェーズ) のステータス確認"></a>2.サブタスク (Take Snapshot フェーズ) のステータス確認</h4><p>name 値 を用いて下記のコマンドを実行することでサブタスクのステータスが確認できます。<br>下記例では Take Snapshot のステータスが Completed 、Transfer data to vault のステータスが InProgress 、となっており、スナップショットの取得が終わり、 Recovery Services コンテナーへの転送中であることが分かります。</p><blockquote><p>コマンド：<code> </code> <code>az backup job show --name &lt;name値&gt; --resource-group  &lt; RSV リソースグループ名&gt; --vault-name  &lt; RSV 名&gt; --query properties.extendedInfo.tasksList -o table</code> <code> </code></p></blockquote><blockquote><p>コマンド例 :<code> </code> <code>az backup job show --name 2a8c96f8-c282-4f62-9286-fda08088047e --resource-group  RG-NormalTest --vault-name RSV-JPE-LRS --query properties.extendedInfo.tasksList -o table</code> <code> </code></p></blockquote><p><img src="https://user-images.githubusercontent.com/71251920/142236727-60dfeae5-4960-4f91-a96e-c9d223acaff2.png" alt="Check_Subtask_Azure_CLI_1"></p><p>–query オプションを付けない場合は下記の部分から確認できます。</p><blockquote><p>コマンド：<code> </code> <code>az backup job show --name &lt; name 値&gt; --resource-group  &lt; RSV リソースグループ名&gt; --vault-name  &lt; RSV 名&gt;</code> <code> </code><br>コマンド例：<code> </code> <code>az backup job show --name 2a8c96f8-c282-4f62-9286-fda08088047e --resource-group  RG-NormalTest --vault-name RSV-JPE-LRS</code> <code> </code></p></blockquote><p><img src="https://user-images.githubusercontent.com/71251920/142236740-9817d4cf-13a9-480b-816c-ba09e252aea6.png" alt="Check_Subtask_Azure_CLI_2"></p><ul><li>参考：<br>・Azure CLI を使用した Azure での仮想マシンのバックアップ - バックアップ ジョブを監視する<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/quick-backup-vm-cli#monitor-the-backup-job">https://docs.microsoft.com/ja-jp/azure/backup/quick-backup-vm-cli#monitor-the-backup-job</a><br>・az backup job - az backup job list<br><a href="https://docs.microsoft.com/ja-jp/cli/azure/backup/job?view=azure-cli-latest#az_backup_job_list">https://docs.microsoft.com/ja-jp/cli/azure/backup/job?view=azure-cli-latest#az_backup_job_list</a><br>・JMESPath クエリを使用して Azure CLI コマンドの出力に対してクエリを実行する方法 - 辞書のプロパティを取得する(–query オプションに関する参考情報)<br><a href="https://docs.microsoft.com/ja-jp/cli/azure/query-azure-cli#get-properties-in-a-dictionary">https://docs.microsoft.com/ja-jp/cli/azure/query-azure-cli#get-properties-in-a-dictionary</a></li></ul><h3 id="1-3-Azure-PowerShell-を用いたサブタスク-Take-Snapshot-フェーズ-確認方法"><a href="#1-3-Azure-PowerShell-を用いたサブタスク-Take-Snapshot-フェーズ-確認方法" class="headerlink" title="1-3. Azure PowerShell を用いたサブタスク (Take Snapshot フェーズ) 確認方法"></a>1-3. Azure PowerShell を用いたサブタスク (Take Snapshot フェーズ) 確認方法<a id="1-3"></a></h3><p>今回は Windows の PowerShell を用いて Azure PowerShell を実行します。</p><h4 id="0-事前準備-1"><a href="#0-事前準備-1" class="headerlink" title="0.事前準備"></a>0.事前準備</h4><p>　 Azure へログインします。ログインしている環境であれば不要です。</p><blockquote><p>コマンド：<code> </code> <code>Connect-AzAccount</code> <code> </code>　　</p></blockquote><h4 id="1-定数を設定します。"><a href="#1-定数を設定します。" class="headerlink" title="1.定数を設定します。"></a>1.定数を設定します。</h4><blockquote><p>コマンド：<code> </code> <code>$Vault = Get-AzRecoveryServicesVault -Name &quot;&lt; RSV 名&gt;&quot;</code> <code> </code><br>コマンド例：<code> </code> <code>$Vault = Get-AzRecoveryServicesVault -Name &quot;RSV-JPE-LRS&quot;</code> <code> </code></p></blockquote><blockquote><p>コマンド：<code> </code> <code>$VMName = &quot;&lt; VM 名&gt;&quot;</code> <code> </code><br>コマンド例：<code> </code> <code>$VMName = &quot;VM-Win10&quot;</code> <code> </code></p></blockquote><p><img src="https://user-images.githubusercontent.com/71251920/142237893-8c25f4e9-4db1-4da5-b27b-7f33160e893a.png" alt="configure_const"></p><h4 id="2-バックアップ-ジョブのステータス確認"><a href="#2-バックアップ-ジョブのステータス確認" class="headerlink" title="2.バックアップ ジョブのステータス確認"></a>2.バックアップ ジョブのステータス確認<a id="a"></a></h4><p>下記コマンドを実行することで、指定した VM の実行中のバックアップ ジョブの一覧が確認できます。<br>下記例では1つしかないため、$Jobs[0] に実行中のバックアップ ジョブの情報が格納されます。<br>複数ある場合は直近に実行されたものから若い番号に格納されます。</p><blockquote><p>コマンド：<br><code> </code> <code>$Jobs = (Get-AzRecoveryservicesBackupJob -Status &quot;InProgress&quot; -VaultId $Vault.id | ? &#123;$_.WorkloadName -eq $vmName&#125;)</code> <code> </code><br><code> </code> <code>$Jobs</code> <code> </code></p></blockquote><p><img src="https://user-images.githubusercontent.com/71251920/142238480-a33273d9-7e95-43e0-b23a-451b947fd4f3.png" alt="Check_job_status_ps_1"></p><blockquote><p>コマンド：<code> </code> <code>$Jobs[0]</code> <code> </code></p></blockquote><p><img src="https://user-images.githubusercontent.com/71251920/142238471-c9927a38-86e5-4a5d-9140-dee620472a93.png" alt="Check_job_status_ps_2"></p><h4 id="3．実行中のバックアップ-ジョブのサブタスクを取得・表示"><a href="#3．実行中のバックアップ-ジョブのサブタスクを取得・表示" class="headerlink" title="3．実行中のバックアップ ジョブのサブタスクを取得・表示"></a>3．実行中のバックアップ ジョブのサブタスクを取得・表示</h4><p>下記コマンドを実行することでサブタスクのステータスが確認できます。<br>下記例では、Take Snapshot は Completed、Transfer data to vault は InProgress 、となっており、スナップショットの取得が終わり、 Recovery Services コンテナーへの転送中であることが分かります。</p><blockquote><p>コマンド：<br><code> </code> <code>$SubTasks = Get-AzRecoveryServicesBackupJobDetail -Job $Jobs[0]  -VaultId $Vault.id</code> <code> </code><br><code> </code> <code>$SubTasks.subtasks</code> <code> </code></p></blockquote><p><img src="https://user-images.githubusercontent.com/71251920/142249583-ef423e62-9bef-4352-bc34-6a87edf18b4a.png" alt="Check_sub_task_ps_1"></p><p>上記警告については、現在使用可能な ”Get-AzRecoveryServicesBackupJobDetail” のエイリアス ”Get-AzRecoveryServicesBackupJobDetails” が将来的に廃止されていることを示しますが、上記のコマンドであれば使用していないので無視していただいて構いません。</p><p>また下記コマンドを実行していただくことで警告を表示させないことが可能です。</p><blockquote><p>コマンド：<code> </code> <code>Set-Item Env:\SuppressAzurePowerShellBreakingChangeWarnings &quot;true&quot;</code> <code> </code></p></blockquote><p>上記のコマンドを実行したところ警告が出ていないことが分かります。</p><p><img src="https://user-images.githubusercontent.com/71251920/142249588-14b3aca1-3e4d-4948-81a9-b874ec1b5dc1.png" alt="Check_sub_task_ps_2"></p><p>・How do I get rid of the warnings? (警告の非表示について)<br><a href="https://github.com/Azure/azure-powershell/blob/main/documentation/breaking-changes/breaking-changes-messages-help.md#how-do-i-get-rid-of-the-warnings">https://github.com/Azure/azure-powershell/blob/main/documentation/breaking-changes/breaking-changes-messages-help.md#how-do-i-get-rid-of-the-warnings</a></p><h4 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h4><p>なお、<a href="#a">2.バックアップ ジョブのステータス確認</a> で下記のように　VM 名を指定しない場合、その他の実行中のバックアップ ジョブも表示されます。(実行中のその他の VM がある場合)</p><blockquote><p>コマンド：<br><code> </code> <code>$Jobs = Get-AzRecoveryservicesBackupJob -Status &quot;InProgress&quot; -VaultId $Vault.id</code> <code> </code><br><code> </code> <code>$Jobs</code> <code> </code></p></blockquote><p>その際の $Jobs[0]、$Jobs[1] の値は次のようになります。<br><img src="https://user-images.githubusercontent.com/71251920/142242086-55eda1c2-5509-4bac-9c5c-c7d1b64c3401.png" alt="Check_job_status_ps_3"></p><ul><li>参考：<br>・APowerShell を使用して Azure VM をバックアップおよび復元する - バックアップ ジョブの監視<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-automation#monitoring-a-backup-job">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-automation#monitoring-a-backup-job</a><br>・Get-AzRecoveryServicesBackupJob<br><a href="https://docs.microsoft.com/ja-jp/powershell/module/az.recoveryservices/get-azrecoveryservicesbackupjob?view=azps-6.6.0">https://docs.microsoft.com/ja-jp/powershell/module/az.recoveryservices/get-azrecoveryservicesbackupjob?view=azps-6.6.0</a></li></ul><h2 id="2-サブタスク-Take-Snapshot-フェーズ-にかかった時間を確認する方法"><a href="#2-サブタスク-Take-Snapshot-フェーズ-にかかった時間を確認する方法" class="headerlink" title="2. サブタスク (Take Snapshot フェーズ) にかかった時間を確認する方法 "></a>2. サブタスク (Take Snapshot フェーズ) にかかった時間を確認する方法 <a id="2"></a></h2><p>お客様では Azure Portal、およびコマンド (Azure CLI 、Azure PowerShell) を用いても残念ながらサブタスク (Take Snapshot フェーズ) にかかった時間を確認できません。<br>しかし、お問い合わせいただくことで弊社にてお客様環境の実績値をお調べしお伝えすることが可能です。<br>その際には下記情報を添えてお問い合わせいただきますようお願いいたします。<br>　・サブスクリプション ID<br>　・VM 名およびそのリソースグループ名<br>　・Recovery Services コンテナー 名およびそのリソースグループ名</p><p>また、今後のバックアップ ジョブであれば、<a href="#1">1. サブタスク (Take Snapshot フェーズ) 確認方法</a>を参考にしていただくことでおおよそ可能かと存じます。<br>具体的には、実行中のバックアップ ジョブを検知し、ループを回して定期的に対象のサブタスク (Take Snapshot フェーズ等) のステータスを確認し、Inprogress である間の時間を計測していただくことでおおよその時間を測定いただければと存じます。<br>なお、具体的な実装につきましては、恐縮ながら Azure サポートサービスの範囲外であるためお客様ご自身でご実装いただきますようお願いいたします。</p><h4 id="フィードバックご協力のお願い"><a href="#フィードバックご協力のお願い" class="headerlink" title="フィードバックご協力のお願い"></a>フィードバックご協力のお願い<a id="2-1"></a></h4><p>現在、Azure Portal から Take Snapshot にかかった時間を表示できるように弊社開発部門へのフィードバックが行われております。<br>お客様側では以下のサイトを通じてステータスを確認することが可能です。</p><p>・Visualize what time “Take snapshot” is completed in Azure portal<br><a href="https://feedback.azure.com/d365community/idea/ff50fa2f-785d-ec11-a819-0022484e8090">https://feedback.azure.com/d365community/idea/ff50fa2f-785d-ec11-a819-0022484e8090</a></p><p>上記サイトは機能改善のリクエストを行うサイトであり、リクエストの中で Vote (改善要望) が多いものや影響度の大きいものを判断して優先して修正に取り組みます。<br>そのため、もし、Azure Portal から Take Snapshot にかかった時間を表示できるようご要望の場合には、お手数ではございますが可能であれば上記の URL より機能改善リクエストに Vote いただけますと幸いです。<br>Vote の際にはメールアドレスを入力することができ、本投稿が Completed した際に指定のメールアドレスに通知される仕組みとなっております。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートの山本です。&lt;br&gt;今回はお問い合わせをいただくことが多い、 &lt;strong&gt;“Azure VM Backup における Take Snapshot フェーズの確認方法”&lt;/s</summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backupでリストアされるディスク名に関して</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/About_Restored_Disk/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/About_Restored_Disk/</id>
    <published>2021-11-03T03:00:00.000Z</published>
    <updated>2022-02-01T15:19:36.388Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Backup サポートの山本です。<br>今回は、Azure VM Backup でリストアされるディスク名に関してよくいただくお問い合わせとして、下記 2 点についてご案内いたします。<br><strong>１．「リストアするディスクの名前を指定できるか」</strong><br><strong>２．「リストアしたディスクの名前を変更可能か」</strong></p><h3 id="１．「リストアするディスクの名前を指定できるか」"><a href="#１．「リストアするディスクの名前を指定できるか」" class="headerlink" title="１．「リストアするディスクの名前を指定できるか」"></a>１．「リストアするディスクの名前を指定できるか」</h3><p>結論から申し上げますと、リストアにて作成されるディスクの名前は指定することができません。<br>また、現在の仕様として下記のような命名規則で作成されます。</p><h3 id="lt-リストアされたディスク命名規則について-gt"><a href="#lt-リストアされたディスク命名規則について-gt" class="headerlink" title="&lt;リストアされたディスク命名規則について&gt;"></a>&lt;リストアされたディスク命名規則について&gt;</h3><p>ディスクの復元が完了しますとリソース グループに OS ディスクとデータ ディスク (ある場合) が以下の命名規則で作成されます。</p><blockquote><p>   &lt;VM名&gt; - osdisk - yyyymmdd - hhmmss<br>   &lt;VM名&gt; - datadisk - &lt;lun 番号&gt; - yyyymmdd – hhmmss</p></blockquote><p>なお、VM 名に - が入っている場合には省略されます。<br>例えば、Windows2019-Disk-Test という VM 名の場合は下記のディスク名で復元されます。　　　</p><blockquote><p>windows2019disktest-osdisk–20210414-125726</p></blockquote><h3 id="２．「リストアしたディスクの名前を変更可能か」"><a href="#２．「リストアしたディスクの名前を変更可能か」" class="headerlink" title="２．「リストアしたディスクの名前を変更可能か」"></a>２．「リストアしたディスクの名前を変更可能か」</h3><p>結論から申し上げますと、Azure VM Backupからリストアしたディスク含め、Azure のマネージドディスクは、下記のとおり<strong>作成済のディスクの名前を変更することはできません</strong>。<br>・ディスクに関してよく寄せられる質問 - マネージド ディスクまたはアンマネージド ディスクの名前を、作成後に変更できますか?<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/faq-for-disks#------------------------------------------">https://docs.microsoft.com/ja-jp/azure/virtual-machines/faq-for-disks</a></p><blockquote><p>マネージド ディスクの名前は変更できません。 ただし、アンマネージド ディスクの場合は、現在 VHD または VM にアタッチされていなければ、名前を変更できます。</p></blockquote><p>そのため、Azure VM Backup によってリストアされたディスク名を変更されたい場合、代替案として下記がございます。</p><h3 id="代替案"><a href="#代替案" class="headerlink" title="代替案"></a>代替案</h3><p>〈作業概要〉<br>1）復元された OS ディスク・データディスクの「スナップショットの作成」を実施<br>2）作成された OS ディスク・データ ディスクのスナップショットを選択のうえ、さらに「ディスクの作成」を実施（このとき、「ディスク名」を希望の名前で作成）<br>3）仮想マシンへ３）で作成したディスクを、スワップ・アタッチ<br>＊任意の名前のディスクの作成完了後、変更前のディスクは不要であれば削除いただいてかまいません。</p><p>下記のように、ディスクのスナップショットからのディスクの作成の場合、任意の名前を指定することが可能です。<br><img src="https://user-images.githubusercontent.com/71251920/140078998-fe56c03e-f230-4c17-85c6-da53d170172a.jpg" alt="CreateDiskFromSnapshot"></p><p>詳細手順に関しましては、 Azure Iaas テクニカル サポートチームより、下記のブログがございますので参考にしていただければ幸いです。<br>なお、下記リンク先では OS ディスクに限定していますが、データディスクでも同様の手順で既存のディスク (リストアされたディスク) の名前を変更することが可能です。<br>・既存 VM の OS ディスクのリソース名を変更する<br><a href="https://jpaztech.github.io/blog/vm/how-to-change-os-disk-name/">https://jpaztech.github.io/blog/vm/how-to-change-os-disk-name/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Backup サポートの山本です。&lt;br&gt;今回は、Azure VM Backup でリストアされるディスク名に関してよくいただくお問い合わせとして、下記 2 点についてご案内いたします。&lt;br&gt;&lt;str</summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup の クロスリージョン リストア をした際に Error Code ”UserErrorVmProvisioningFailedDueToLackOfResources” で失敗する。</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/CRR_UserErrorVmProvisioningFailedDueToLackOfResources/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/CRR_UserErrorVmProvisioningFailedDueToLackOfResources/</id>
    <published>2021-10-22T03:00:00.000Z</published>
    <updated>2022-02-01T15:19:36.388Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートの山本です。<br>今回はお問い合わせをいただくことが多い、 <strong>“クロスリージョン リストア を実施した際にセカンダリ リージョン (ペアリージョン) へリストアできない、Error Code : serErrorVmProvisioningFailedDueToLackOfResources で失敗する”</strong> といったお問い合わせについて解説させていただきます。<br>*プライマリリージョンが東日本リージョンの場合、セカンダリリージョンは西日本リージョンとなります。<br>結論から申し上げますと、<strong>対象の VM が東日本リージョンでは 対応しているが、西日本リージョンでは対応していない VM Size であること</strong>が原因でございます。<br>*また、セカンダリリージョンの CPU クオーター制限には抵触していないことが前提でございます。</p><p>ペアリージョンの関係は下記をご確認いただければ幸いです。<br>・ビジネス継続性とディザスター リカバリー (BCDR):Azure のペアになっているリージョン - Azure リージョン ペア<br><a href="https://docs.microsoft.com/ja-jp/azure/best-practices-availability-paired-regions#azure-regional-pairs">https://docs.microsoft.com/ja-jp/azure/best-practices-availability-paired-regions#azure-regional-pairs</a></p><h3 id="本事象の場合に発生する-Error-Code"><a href="#本事象の場合に発生する-Error-Code" class="headerlink" title="本事象の場合に発生する Error Code"></a>本事象の場合に発生する Error Code</h3><hr><p><strong>[Error code]</strong><br>UserErrorVmProvisioningFailedDueToLackOfResources<br><strong>[Warning message]</strong><br>Failed in provisioning the restored VM due to insufficient capacity for the requested VM size in this region.<br><strong>[Recommended action]</strong><br>Read more about improving likelihood of provisioning success at <a href="http://aka.ms/allocation-guidance">http://aka.ms/allocation-guidance</a>. Alternatively try restoring disks to a storage account and then create a VM</p><hr><h3 id="具体的な問題が起こるシナリオ"><a href="#具体的な問題が起こるシナリオ" class="headerlink" title="具体的な問題が起こるシナリオ"></a>具体的な問題が起こるシナリオ</h3><p>例えば、東日本リージョンで Standard E4as_v4 の VM のバックアップを取得しており、クロスリージョン リストアにて西日本リージョンで新規 VM の作成を行う場合に発生いたします。</p><h3 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h3><p>原因としましては、<strong>対象の VM が東日本リージョンでは 対応しているが、西日本リージョンでは対応していない VM Size であること</strong>が原因でございます。 </p><p>下記 URL からリージョンごとにおける VM の対応状況が分かります。<br>今回の Standard E4as_v4の場合、東日本リージョン (Japan East) ではサポートされているが 、西日本リージョン (Japan West) ではサポートされていないことが分かります。<br>下記の URL の通り、東日本リージョン (Japan East) ではサポートされているが 、西日本リージョン (Japan West) ではサポートされていない VM Size が複数ございます。<br>・Products available by region( Virtual Machines)<br><a href="https://azure.microsoft.com/en-us/global-infrastructure/services/?products=virtual-machines&amp;regions=non-regional,us-east,us-east-2,us-central,us-north-central,us-south-central,us-west-central,us-west,us-west-2,japan-east,japan-west">https://azure.microsoft.com/en-us/global-infrastructure/services/?products=virtual-machines&amp;regions=non-regional,us-east,us-east-2,us-central,us-north-central,us-south-central,us-west-central,us-west,us-west-2,japan-east,japan-west</a></p><p><img src="https://user-images.githubusercontent.com/71251920/138295057-8819eb23-3029-403d-9d87-f764ce7b026c.jpg" alt="VM Size_Region_Compatibility"></p><h3 id="回避策"><a href="#回避策" class="headerlink" title="回避策"></a>回避策</h3><p>上記の原因の場合、以下の 2 通りの対応策が考えられます。<br>1.ペアリージョンの両方でサポートされている VM Size を利用する。<br>2.一度 クロスリージョン リストア にて ”ディスクの復元” (VMの作成ではなく) をしていただき、ディスクから VM を作成し、その際に VM Size を変更する。<br>データディスクがある場合は復元したディスクを選択しアタッチする。(LUN 番号が入れ替わらないようにご注意ください)</p><p>下記弊社検証環境での画面ショットです。<br>ディスクから作成することで、下記のように VM Size を変更することが可能です。<br>また、ＶＭ Size に加えて NIC なども設定することが可能です。</p><p><img src="https://user-images.githubusercontent.com/71251920/138295033-694d40b5-8e4e-4366-8f01-b91db652a38e.png" alt="DIskからのVM作成(VM Size Change)"></p><h3 id="lt-リストアされたディスク命名規則について-gt"><a href="#lt-リストアされたディスク命名規則について-gt" class="headerlink" title="&lt;リストアされたディスク命名規則について&gt;"></a>&lt;リストアされたディスク命名規則について&gt;</h3><p>ディスクの復元が完了しますとリソース グループに OS ディスクとデータ ディスク (ある場合) が以下の命名規則で作成されます。</p><blockquote><p>   &lt;VM名&gt; - osdisk - yyyymmdd - hhmmss<br>   &lt;VM名&gt; - datadisk - &lt;lun 番号&gt; - yyyymmdd – hhmmss</p></blockquote><p>なお、VM 名に - が入っている場合には省略されます。<br>例えば、Windows2019-Disk-Test という VM 名の場合は下記のディスク名で復元されます。　　　</p><blockquote><p>windows2019disktest-osdisk–20210414-125726</p></blockquote><h3 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a>参考情報</h3><p>ディスクからの VM 作成に関して下記、弊社が公開している技術情報に手順がございます。<br>・ディスクからの VM の作成<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/create-vm-specialized-portal#create-a-vm-from-a-disk">https://docs.microsoft.com/ja-jp/azure/virtual-machines/windows/create-vm-specialized-portal#create-a-vm-from-a-disk</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートの山本です。&lt;br&gt;今回はお問い合わせをいただくことが多い、 &lt;strong&gt;“クロスリージョン リストア を実施した際にセカンダリ リージョン (ペアリージョン) へリストア</summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup では オフライン バックアップができるのか</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Azure_VM_Offline_backup/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/Azure_VM_Offline_backup/</id>
    <published>2021-10-20T03:00:00.000Z</published>
    <updated>2022-02-01T15:19:36.388Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><h4 id="Azure-VM-Backup-では-オフライン-バックアップができるのか"><a href="#Azure-VM-Backup-では-オフライン-バックアップができるのか" class="headerlink" title="Azure VM Backup では オフライン バックアップができるのか"></a>Azure VM Backup では オフライン バックアップができるのか</h4><p>皆様こんにちは。Azure Backup サポートの山本です。<br>今回はお問い合わせをいただくことが多い、Azure VM Backup でオフライン バックアップができるのかというご要望について解説します。<br>こちらまず、結論から申し上げますと<strong>可能</strong>でございます。</p><h3 id="オンラインバックアップについて"><a href="#オンラインバックアップについて" class="headerlink" title="オンラインバックアップについて"></a>オンラインバックアップについて</h3><p>まず、オンライン バックアップの場合 、Azure VM Backup は Windows VM の場合も Linux VM の場合も、それぞれのエージェント (およびバックアップ拡張機能) と通信・連携し、スナップショットを取得しています。<br>その際の整合性は通常 Windows OS の場合は VSS (ボリューム シャドウ コピー サービス) と連携しアプリケーション整合性となり、Linux VM の場合は通常ファイルシステム整合性 (スクリプトを構成している場合はアプリケーション整合性) となります。</p><p>・Azure VM バックアップの概要 - スナップショットの整合性<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#snapshot-consistency">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#snapshot-consistency</a><br>・Azure Linux VM のアプリケーション整合性バックアップ<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-linux-app-consistent">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-linux-app-consistent</a></p><p><img src="https://user-images.githubusercontent.com/71251920/137937912-912a42c1-f750-4c8b-a157-6a3db50f11c7.png" alt="Windows OS のオンラインバックアップ - アプリケーション整合性"></p><p><img src="https://user-images.githubusercontent.com/71251920/137937882-bb5ea0da-be8a-451c-bd3a-a24c4a8070c4.png" alt="Linux OS のオンラインバックアップ - ファイルシステム整合性"></p><h3 id="オフラインバックアップについて"><a href="#オフラインバックアップについて" class="headerlink" title="オフラインバックアップについて"></a>オフラインバックアップについて</h3><p>次に、オフライン バックアップの場合、VM の電源が落ちているのでエージェントは動いていないため、VM との連携をせずにスナップショットを取得します。(VM 内部と連携しません。)<br>その際の整合性は Windows VM / Linux VM を問わずクラッシュ整合性となります。<br><img src="https://user-images.githubusercontent.com/71251920/137937936-0d85b5e6-7bb8-4131-9553-ec7c9e0e0d58.png" alt="オフライン バックアップ - クラッシュ整合性"></p><h3 id="留意点"><a href="#留意点" class="headerlink" title="留意点"></a>留意点</h3><p>上記のとおり、 Azure VM の電源はオン / オフ どちらでも Azure VM Backup を取得することが可能です。<br>留意点としましては、バックアップ実行中 (正確にはスナップショット取得中) には電源状態の変更を行わないようにお願いします。<br>Azure VM Backup が失敗する可能性がございます。</p><h3 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a>参考情報</h3><p>・Azure VM バックアップの概要 - スナップショットの整合性<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#snapshot-consistency">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#snapshot-consistency</a><br>・Azure Linux VM のアプリケーション整合性バックアップ<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-linux-app-consistent">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-linux-app-consistent</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;h4 id=&quot;Azure-VM-Backup-では-オフライン-バックアップができるのか&quot;&gt;&lt;a href=&quot;#Azure-VM-Backup-では-オフライン-バックアップができるのか&quot; class=&quot;headerlink&quot; t</summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM のリストアの際 NIC の設定が消えてしまう</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/VMRestoring_NIC_Configuration/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/VMRestoring_NIC_Configuration/</id>
    <published>2021-10-20T03:00:00.000Z</published>
    <updated>2022-02-01T15:19:36.388Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><h4 id="Azure-VM-のリストアの際-NIC-の設定が消えてしまう"><a href="#Azure-VM-のリストアの際-NIC-の設定が消えてしまう" class="headerlink" title="Azure VM のリストアの際 NIC の設定が消えてしまう"></a>Azure VM のリストアの際 NIC の設定が消えてしまう</h4><p>皆様こんにちは。Azure Backup サポートの山本です。<br>今回はお問い合わせをいただくことが多い、Azure VM のリストアの際 NIC の設定が消えてしまうというお問い合わせについて解説させていただきます。</p><p>こちら結論から申し上げますと、<strong>Azure VM Backupのリストアメニューにて、[新規VMの作成] を選んだ際、デフォルトで NIC が新たに作成され (設定できない) アタッチされるため、復元時に NIC の情報が消えてしまうのは仕様</strong>となっております。<br>Azure VM Backup ではディスクの情報をバックアップしますが、NIC の情報はバックアップいたしません。<br>なお、リストアメニューにて [既存の置き換え] を選択された場合は VM のディスクのみを入れ替え (スワップ) 、NIC はそのまま利用されるため、NIC の設定が消えるようなことは起こりません。</p><h3 id="代替案"><a href="#代替案" class="headerlink" title="代替案"></a>代替案</h3><p>次のような代替案がございます。<br>(手順１) Azure VM バックアップのリストア メニューからディスクとして一旦復元する。<br>(手順２) ディスクから VM を作成する。<br>      その際に既存の任意の設定をいれた NIC を選択する。<br>    　データディスクがある場合は復元したディスクを選択しアタッチする。(LUN 番号が入れ替わらないようにご注意ください)</p><p>(手順２) に関しましては、 Azure Portal からの操作の場合、下記のような手順で可能でございます。<br>NIC を指定できることが分かります。<br><img src="https://user-images.githubusercontent.com/71251920/137943407-1dad9711-f799-4921-9365-17f1ac006f3b.png" alt="DiskからのVM作成"></p><h3 id="lt-リストアされたディスク命名規則について-gt"><a href="#lt-リストアされたディスク命名規則について-gt" class="headerlink" title="&lt;リストアされたディスク命名規則について&gt;"></a>&lt;リストアされたディスク命名規則について&gt;</h3><p>ディスクの復元が完了しますとリソース グループに OS ディスクとデータ ディスク (ある場合) が以下の命名規則で作成されます。</p><blockquote><p>   &lt;VM名&gt; - osdisk - yyyymmdd - hhmmss<br>   &lt;VM名&gt; - datadisk - &lt;lun 番号&gt; - yyyymmdd – hhmmss</p></blockquote><p>なお、VM 名に - が入っている場合には省略されます。<br>例えば、Windows2019-Disk-Test という VM 名の場合は下記のディスク名で復元されます。　　　</p><blockquote><p>windows2019disktest-osdisk–20210414-125726</p></blockquote><h3 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a>参考情報</h3><p>・Azure portal で Azure VM データを復元する方法 - ディスクを復元する<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-disks">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-disks</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;h4 id=&quot;Azure-VM-のリストアの際-NIC-の設定が消えてしまう&quot;&gt;&lt;a href=&quot;#Azure-VM-のリストアの際-NIC-の設定が消えてしまう&quot; class=&quot;headerlink&quot; title=&quot;Azure </summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>グローバル アセンブリ キャッシュの警告イベントについて</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/GAC/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/GAC/</id>
    <published>2021-10-01T03:00:00.000Z</published>
    <updated>2022-02-01T15:19:36.388Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><h4 id="グローバルアセンブリキャッシュ-GAC-の警告イベントについて"><a href="#グローバルアセンブリキャッシュ-GAC-の警告イベントについて" class="headerlink" title="グローバルアセンブリキャッシュ (GAC) の警告イベントについて"></a>グローバルアセンブリキャッシュ (GAC) の警告イベントについて</h4><p>皆様こんにちは。Azure Backup サポートの谷脇です。<br>今回はお問い合わせをいただくことが多い、 Windows VM の Azure VM バックアップ取得時に発現するイベントログについて解説させていただきます。</p><p>バックアップを取得した際に、『グローバル アセンブリ キャッシュからのアセンブリの削除に失敗しました』の警告が表示される。</p><p>こちらの警告は、グローバルアセンブリキャッシュ (GAC) からファイルの削除に失敗した際に出力されます。<br>※ グローバルアセンブリキャッシュとは<br>コンピュータ上の多数のアプリケーション間で共有するためにインストールされたアセンブリを格納するマシン全体のコード キャッシュ。</p><p>Azure Backup では、 Azure VM のバックアップを取得する際に、以下の2つのファイルを削除、インストールする場合があります。このメッセージが発現した際は、GAC 上からその削除、インストールに失敗しています。<br>・iaasvmazurestorage.dll<br>・iaasvmsnapshotmessage.dll</p><p>このエラーが出る要因として、以前のファイルが存在しない場合や、以前のファイルがロックされている場合が考えられます。しかしながらファイルの削除やインストールはリトライが行われリトライにより成功する場合も多くなっております。<br>従って、正常に Azure Backup によるバックアップが取得できている場合、GAC 上のファイルは正常に参照できている状態であり、無視可能なエラーメッセージです。</p><p>以下の画面のようなイベントログが発現します。</p><blockquote><p>&lt;イベントログ例 &gt;<br>ソース : COM+ SOAP Services<br>EventID : 0<br>Message : グローバル アセンブリ キャッシュからのアセンブリの削除に失敗しました :  C:\Packages\Plugins\Microsoft.Azure.RecoveryServices.VMSnapshot\1.0.70.0\iaasvmsnapshotmessage.dll iaasvmsnapshotmessage,Version=3.0.0.0</p></blockquote><p><img src="https://user-images.githubusercontent.com/71251920/135617775-6ac8b8e6-c1a7-4311-9375-8389248969fe.png" alt="グローバル アセンブリ キャッシュのエラー"><br>このエラーメッセージが発現することを抑止する方法はありませんが、正常にバックアップが取得できていましたら、上記の通り無視可能なエラーメッセージです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;h4 id=&quot;グローバルアセンブリキャッシュ-GAC-の警告イベントについて&quot;&gt;&lt;a href=&quot;#グローバルアセンブリキャッシュ-GAC-の警告イベントについて&quot; class=&quot;headerlink&quot; title=&quot;グローバルア</summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM バックアップを任意のタイミングのみで取得したい</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/invalid_schedule/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/invalid_schedule/</id>
    <published>2021-10-01T03:00:00.000Z</published>
    <updated>2022-02-01T15:19:36.412Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートの谷脇です。<br>今回はお問い合わせをいただくことが多い、 “任意のタイミングのみでバックアップの取得をしたい”、というご要望について解説します。</p><p>まず、Azure VM バックアップはバックアップ ポリシーを利用しスケジュールされたバックアップを取得する運用を想定した製品仕様となっております。<br>しかし、任意のタイミングのみでバックアップする場合、バックアップを取得するタイミング以外は基本的にバックアップポリシーが無効化された状態となります。<br>そのため後述の懸念点がございますため、<strong>弊社としては任意のタイミングのみでバックアップを取得していただく運用を推奨しておりません。</strong></p><p>一方、上記のように任意のタイミングのみでバックアップを行いたいというご要望は多く寄せられております。<br>任意のタイミングのみでバックアップを取得する運用を行う際の懸念点がございますので以下にてご紹介します。<br>懸念点を踏まえ、任意のタイミングのみでバックアップを取得する運用方法について解説させていただきます。</p><p>以下の文章では、任意のタイミングで取得していただくバックアップを [アドホック バックアップ] 、スケジュールされ取得していただくバックアップを [スケジュール バックアップ] としています。</p><h3 id="アドホック-バックアップのみを取得する運用を行う際の懸念点"><a href="#アドホック-バックアップのみを取得する運用を行う際の懸念点" class="headerlink" title="[アドホック バックアップのみを取得する運用を行う際の懸念点]"></a>[アドホック バックアップのみを取得する運用を行う際の懸念点]</h3><p>通常時は、バックアップ ポリシーを無効化 (バックアップの停止) し、必要なときだけバックアップを有効化しアドホック バックアップを取得する場合、下記のような懸念点が考えられます。</p><p>バックアップ ポリシーを無効化すると Garbage Collection と呼ばれるクリーンアップが実行されず、期限切れ復旧ポイントや復旧ポイントのメタデータがクリーンアップされません。<br>メタデータがたまることによって最短で 18 個以上復旧ポイントがたまった場合にエラーメッセージ (<strong>UserErrorRpCollectionLimitReached</strong>) が発生し、それ以降のバックアップが取得できなくなる可能性があります。</p><p> [参考]<br> ・<strong>UserErrorRpCollectionLimitReached</strong> - The Restore Point collection max limit has reached (復元ポイント コレクションの上限に達しました)<br> <a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout#usererrorrpcollectionlimitreached---the-restore-point-collection-max-limit-has-reached">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout#usererrorrpcollectionlimitreached---the-restore-point-collection-max-limit-has-reached</a></p><blockquote><p>エラー コード: UserErrorRpCollectionLimitReached<br>エラー メッセージ: The Restore Point collection max limit has reached (復元ポイント コレクションの上限に達しました)</p></blockquote><p>バックアップが常に有効化されている場合、Garbage Collection が一日 (24 時間) のうちどこかで行われる仕様ですので、上記エラーは通常は発生いたしません。</p><p>参考：Azure Poretal からバックアップ アイテムを選択し、[バックアップの停止] を行うことが出来ます。</p><p><img src="https://user-images.githubusercontent.com/71251920/135618848-76248e66-8013-452e-a471-c4f7c8c37281.png" alt="Stop Azure VM Backup"></p><p>上記の懸念点を踏まえ、アドホック バックアップのみでの運用方法をご紹介します。</p><h3 id="アドホック-バックアップのみを取得する運用を行う方法"><a href="#アドホック-バックアップのみを取得する運用を行う方法" class="headerlink" title="[アドホック バックアップのみを取得する運用を行う方法]"></a>[アドホック バックアップのみを取得する運用を行う方法]</h3><p>あくまで一例ですが、週に一度 48 時間程度バックアップを有効化していただくことで Garbage Collection を実行する方法がございます。<br>(バックアップを有効化した状態で、24 時間のうちどこかで Garbage Collection が実行されますので、目安として 48 時間としています。)<br>アドホック バックアップにつきましては週次バックアップと重ならない日時でバックアップを有効化しアドホック バックアップを取得後、バックアップを無効化します。<br>こちらの方法で定期的に Garbage Collection を行うことが出来ます。</p><h3 id="具体的な運用方法の例"><a href="#具体的な運用方法の例" class="headerlink" title="[具体的な運用方法の例]"></a>[具体的な運用方法の例]</h3><p>週１回 水曜日にバックアップを実行するスケジュールを組んだバックアップ ポリシーを作成し、適用します。<br>平日は 基本的に[バックアップの停止] をし、週末の土曜日、日曜日だけ [バックアップの再開] をした状態にします。<br>アドホック バックアップにつきましては水曜の週次バックアップと重ならない日時でバックアップを有効化しバックアップを取得後、バックアップを無効化します。</p><p>上記の運用でしたら、スケジュール バックアップを取得させず (アドホック バックアップのみを実行し) 週末に Garbage Collection を実行させる運用が可能です。</p><p>また、ご参考までにバックアップの取得完了について Azure Portal で後ご確認いただくか、下記 URL 内の ”バックアップ ジョブのステータス確認” にて Azure PowerShell や Azure CLI で確認することが可能です。<br>・Azure VM Backup における Take Snapshot フェーズの確認方法<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_check_VM_backup_Subtask/">https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_check_VM_backup_Subtask/</a></p><p>また、スケジュール バックアップが不要で、バックアップの頻度が低く、なおかつオフライン バックアップ (VM が停止した状態で取得するバックアップ) の取得をされる場合、Azure VM バックアップ以外のサービスを用いていただく以下のようなディスクのスナップショットを用いる代替案もございます。</p><h3 id="代替案"><a href="#代替案" class="headerlink" title="[代替案]"></a>[代替案]</h3><p>スケジュール バックアップが不要で、バックアップの頻度が低く、オフライン バックアップ (VM が停止した状態で取得するバックアップ) の取得をされる場合、ディスクのスナップショットを用いる代替案がございます。<br>保持期限などはなく、任意のタイミングで削除できます。<br>スナップショットからディスクを作成することができ、そこから VM に対してディスクのスワップや新規 VM の作成を行うことができます。</p><p>ディスクのスナップショットに関しましては下記ドキュメントに記載がございます。<br>・ VM を停止 (割り当て解除) し、OS ディスクの [スナップショット] を取得<br><a href="https://jpaztech.github.io/blog/vm/vm-replica-3/#2-VM-%E3%82%92%E5%81%9C%E6%AD%A2-%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E8%A7%A3%E9%99%A4-%E3%81%97%E3%80%81OS-%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%81%AE-%E3%82%B9%E3%83%8A%E3%83%83%E3%83%97%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88-%E3%82%92%E5%8F%96%E5%BE%97">https://jpaztech.github.io/blog/vm/vm-replica-3/#2-VM-%E3%82%92%E5%81%9C%E6%AD%A2-%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E8%A7%A3%E9%99%A4-%E3%81%97%E3%80%81OS-%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%81%AE-%E3%82%B9%E3%83%8A%E3%83%83%E3%83%97%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88-%E3%82%92%E5%8F%96%E5%BE%97</a></p><p>・ポータルまたは PowerShell を使用してスナップショットを作成する<br><a href="https://docs.microsoft.com/ja-jp/azure/virtual-machines/snapshot-copy-managed-disk?tabs=portal">https://docs.microsoft.com/ja-jp/azure/virtual-machines/snapshot-copy-managed-disk?tabs=portal</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートの谷脇です。&lt;br&gt;今回はお問い合わせをいただくことが多い、 “任意のタイミングのみでバックアップの取得をしたい”、というご要望について解説します。&lt;/p&gt;
&lt;p&gt;まず、Azu</summary>
      
    
    
    
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>ABRS &amp; SCEM チームについて</title>
    <link href="https://jpabrs-scem.github.io/blog/information/team-introduction/"/>
    <id>https://jpabrs-scem.github.io/blog/information/team-introduction/</id>
    <published>2021-09-17T03:00:00.000Z</published>
    <updated>2022-02-01T15:19:36.424Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><h4 id="ABRS-amp-SCEM-チームについて"><a href="#ABRS-amp-SCEM-チームについて" class="headerlink" title="ABRS &amp; SCEM チームについて"></a>ABRS &amp; SCEM チームについて</h4><p>我々のチームは文字通り、ABRS と SCEM という二つの領域をカバーしているチームです。<br>ABRS チーム (Azure Backup and Recovery Service) は主にデータ保護ソリューションを提供する技術領域として Azure Backup 、SCDPM / MABS、 Azure Site Recovery 、Azure Migrate、Azure Resource Mover、Movere の技術サポートを担当しています。</p><p>また、SCEMチーム (System Center Enterprise Management) は統合運用管理製品群として提供されている System Center という製品群のうち、次の Enterprise Management製品を担当します。<br>SCOM (System Center Operations Manager), SCVMM (System Center Virtual Machine Manager), SCO (System Center Operations), SCSM (System Center Service manager) の技術サポートを担当しています。</p><p>現在は完全にフルリモートで各自家から仕事、(WfH, work from home と呼んでいます) しています。<br>新しく加入したメンバーも多いチームですが、フルリモートであっても Teams などをフル活用してメンバー間のコミュニケーションは活発に行われており、チーム全員楽しく新しいチャレンジができています。<br>以下に当チームの代表的な製品をご紹介します。</p><p>• Azure Backup<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/">https://docs.microsoft.com/ja-jp/azure/backup/</a><br>• DPM/MABS<br><a href="https://docs.microsoft.com/ja-jp/system-center/dpm/dpm-overview">https://docs.microsoft.com/ja-jp/system-center/dpm/dpm-overview</a><br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mabs-dpm">https://docs.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mabs-dpm</a><br>• Azure Site Recovery<br><a href="https://docs.microsoft.com/ja-jp/azure/site-recovery/">https://docs.microsoft.com/ja-jp/azure/site-recovery/</a><br>• Azure Migrate<br><a href="https://docs.microsoft.com/ja-jp/azure/migrate/">https://docs.microsoft.com/ja-jp/azure/migrate/</a><br>• System Center 製品群　<br><a href="https://docs.microsoft.com/ja-jp/system-center/">https://docs.microsoft.com/ja-jp/system-center/</a></p><h4 id="Azure-Backup-ってどんな製品？"><a href="#Azure-Backup-ってどんな製品？" class="headerlink" title="Azure Backup ってどんな製品？"></a>Azure Backup ってどんな製品？</h4><p>Azure Backup はデータをバックアップし、それを Microsoft Azure クラウド から回復するための製品です。<br>例えば、Azure VM, Azure Files, Azure Managed Disks, Azure BLOB などのバックアップを行うことが出来ます。<br>Azure VM のバックアップでは、ディスクのスナップショットを取得し、取得したスナップショットを Recovery Services コンテナーにデータ転送することで実現しています。<br>また、取得したスナップショットから復元を行うこともできます。<br><img src="https://user-images.githubusercontent.com/71251920/133728140-8c4f95d7-e3dc-4439-8356-056e0590aebf.png" alt="azure_backup"></p><h4 id="DPM-MABS-ってどんな製品？"><a href="#DPM-MABS-ってどんな製品？" class="headerlink" title="DPM/MABS ってどんな製品？"></a>DPM/MABS ってどんな製品？</h4><p>DPM (System Center Data Protection Manager) と MABS（Microsoft Azure Backup Server) は、多様な保護対象をバックアップと回復するための製品です。<br>バックアップされたデータはローカル・ディスクだけではなく、Microsoft Azure クラウドにも保存できます。<br>主に下記のワークロードを保護する機能を提供しています。<br>・Microsoft ワークロードのアプリケーション (SQL Server、Exchange、SharePoint など)<br>・Windows オペレーティング システムを実行するコンピューターのファイル、フォルダー、ボリューム<br>・Windows オペレーティング システムを実行するコンピューターのシステム状態のバックアップまたは完全なベア メタル バックアップ<br>・Windows または Linux を実行する Hyper-V 仮想マシンと VMWare 仮想マシン<br><img src="https://user-images.githubusercontent.com/71251920/133728130-f8ca4a41-0a0b-42da-ad6f-108a80fe2908.png" alt="DPM"></p><h4 id="Azure-Site-Recovery-ってどんな製品？"><a href="#Azure-Site-Recovery-ってどんな製品？" class="headerlink" title="Azure Site Recovery ってどんな製品？"></a>Azure Site Recovery ってどんな製品？</h4><p>Azure Site Recovery (ASR) は、データの保護を行うことで、メンテナンスや災害などによるシステム停止の際に、お客様のビジネス継続性の確保とディザスター リカバリー (BCDR) を可能とするための製品です。システム停止時には、プライマリ サイトからセカンダリ サイト へフェール オーバーすることで、ビジネス継続性を確保することができます。<br>主に以下の環境のデータの保護を行うことができます。<br>・Azure プライマリ リージョン から Azure セカンダリ リージョン への保護<br>・オンプレミス VM / 物理サーバー サイト から Azure サイト への保護</p><p>オンプレミス VM / 物理サーバー サイト から Azure サイト への保護の図：<br><img src="https://user-images.githubusercontent.com/71251920/133694495-87f3774d-656f-4ee4-8728-206be247a534.png" alt="ASR_P2A"></p><h4 id="Azure-Migrate-ってどんな製品？"><a href="#Azure-Migrate-ってどんな製品？" class="headerlink" title="Azure Migrate ってどんな製品？"></a>Azure Migrate ってどんな製品？</h4><p>Azure Migrate は、オンプレミスのアプリとワークロード、およびプライベート/パブリック クラウド VM の検出、評価、および Azure への移行を追跡するための中央ハブであり、Azure Migrate ツールのほか、サードパーティの ISV オファリングが用意されています。<br>Azure Migrate を使用することでオンプレミスの VMware VM、Hyper-V VM、物理サーバー、その他の仮想化された VM、データベース、Web アプリ、仮想デスクトップの評価と移行を一元化することができます。<br><img src="https://user-images.githubusercontent.com/71251920/133727696-e693d2f9-aaa2-4eeb-8bb6-498ea225a939.png" alt="Azure Migrate"></p><h4 id="System-Center-ってどんな製品？"><a href="#System-Center-ってどんな製品？" class="headerlink" title="System Center ってどんな製品？"></a>System Center ってどんな製品？</h4><p>今回は System Center 製品群のうち、SCOM (System Center Operations Manager) に関してご説明させていただきます。<br>Microsoft System Center の 1 つのコンポーネントである Operations Manager は、1 つのコンソールから多数のコンピューターのサービス、デバイス、および操作を監視できるソフトウェアです。<br>Windows Server や Linux コンピューターなどのエージェント側の死活監視からログ情報/イベント情報の監視、アラート発砲まで一元的に機能をご提供します。<br><img src="https://user-images.githubusercontent.com/71251920/133543828-aa1bc2cc-ae05-4b80-b53f-1a87b1ddce2f.png" alt="SCOM"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;h4 id=&quot;ABRS-amp-SCEM-チームについて&quot;&gt;&lt;a href=&quot;#ABRS-amp-SCEM-チームについて&quot; class=&quot;headerlink&quot; title=&quot;ABRS &amp;amp; SCEM チームについて&quot;&gt;&lt;</summary>
      
    
    
    
    
    <category term="Information" scheme="https://jpabrs-scem.github.io/blog/tags/Information/"/>
    
  </entry>
  
</feed>
