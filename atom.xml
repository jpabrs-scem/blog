<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan CSS ABRS  Support Blog !!</title>
  
  <subtitle>Azure Backup , Azure Site Recovery , Azure Migrate に関するサポート情報を発信します。</subtitle>
  <link href="https://jpabrs-scem.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpabrs-scem.github.io/blog/"/>
  <updated>2024-08-27T06:06:49.049Z</updated>
  <id>https://jpabrs-scem.github.io/blog/</id>
  
  <author>
    <name>Japan CSS ABRS &amp; SCEM Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>AzureBackupProtectionLock について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureFilesBackup/About_Protection_Lock/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureFilesBackup/About_Protection_Lock/</id>
    <published>2024-08-27T15:00:00.000Z</published>
    <updated>2024-08-27T06:06:49.049Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>Azure ファイル共有のバックアップを構成すると、バックアップ データやストレージ アカウントが誤って削除されないように、削除ロック 「AzureBackupProtectionLock」 がストレージ アカウントに設定されます。<br>今回は、Azure ファイル共有のバックアップによって、ストレージ アカウントに設定される削除ロック 「AzureBackupProtectionLock」 についてご案内します。  </p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">AzureBackupProtectionLock とは</a><br><a href="#2">AzureBackupProtectionLock が設定されるタイミング</a><br><a href="#3">AzureBackupProtectionLock を一時的に削除する方法</a><br><a href="#4">AzureBackupProtectionLock を設定させない方法</a>  </p><hr><h2 id="AzureBackupProtectionLock-とは"><a href="#AzureBackupProtectionLock-とは" class="headerlink" title="AzureBackupProtectionLock とは"></a><a id="1"></a>AzureBackupProtectionLock とは</h2><p>Azure ファイル共有のバックアップでは、Azure ファイル共有のスナップショット機能を利用し、バックアップを取得しておりますが、Azure ファイル共有のスナップショットは、ストレージ アカウントが削除されると、全てのスナップショットが併せて削除されます。<br>そのため、Azure ファイル共有のバックアップでは、Azure Backup サービスによって取得されたバックアップ (スナップショット) が誤って削除されないように、バックアップ対象の Azure ファイル共有がデプロイされているストレージ アカウントに対して、削除ロック 「AzureBackupProtectionLock」 を設定いたします。  </p><ul><li>ストレージ アカウントのロックを有効にすることが推奨されるのはなぜですか?<br>Azure Files のバックアップに関する FAQ - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-files-faq#-------------------------------------">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-files-faq#-------------------------------------</a><br>抜粋 :</li></ul><blockquote><p>ストレージ アカウントが削除されると、すべてのスナップショットが失われます。 <strong>誤って削除されないようにアカウントを保護するため、Azure Backup によってストレージ アカウントに削除ロックが設定されます。</strong> つまり、許可されているユーザーはリソースを読んだり変更したりできますが、削除することはできません。 また、このロックにより、ストレージ アカウントの下にあるファイル共有の削除も制限されます。 そのため、ストレージ アカウントとファイル共有の両方が不注意による削除から保護されます。  </p></blockquote><p>(例)  </p><ul><li>ロック名 : <code>AzureBackupProtectionLock</code>  </li><li>ロックの種類 : 削除  </li><li>スコープ : ストレージ アカウント  </li><li>メモ : <code>Auto-created by Azure Backup for storage accounts registered with a Recovery Services Vault. This lock is intended to guard against deletion of backups due to accidental deletion of the storage account. (Recovery Services Vaultに登録されているストレージアカウントに対してAzure Backupによって自動的に作成されます。このロックは、ストレージアカウントの誤った削除によるバックアップの削除を防ぐことを目的としています。)</code><br><img src="https://github.com/user-attachments/assets/6521b8f8-67f1-4b48-863f-41afb943fbd3"></li></ul><h2 id="AzureBackupProtectionLock-が設定されるタイミング"><a href="#AzureBackupProtectionLock-が設定されるタイミング" class="headerlink" title="AzureBackupProtectionLock が設定されるタイミング"></a><a id="2"></a>AzureBackupProtectionLock が設定されるタイミング</h2><p>削除ロック 「AzureBackupProtectionLock」 は、主に下記のタイミングで設定されます。  </p><ul><li>Azure ファイル共有のバックアップが構成されたとき<br>(より正確には、ストレージ アカウントが Recovery Services コンテナーのバックアップ インフラストラクチャとして登録されたとき)  </li><li>Azure ファイル共有のバックアップが実行されたとき  </li></ul><p>削除ロック 「AzureBackupProtectionLock」 を手動削除したとしても、Azure ファイル共有のバックアップが実行されると、削除ロック 「AzureBackupProtectionLock」 が自動設定されます。  </p><h2 id="AzureBackupProtectionLock-を一時的に削除する方法"><a href="#AzureBackupProtectionLock-を一時的に削除する方法" class="headerlink" title="AzureBackupProtectionLock を一時的に削除する方法"></a><a id="3"></a>AzureBackupProtectionLock を一時的に削除する方法</h2><p>ファイル共有にアップロードしている一部ファイルを削除したいなどのシナリオにおいては、削除ロック 「AzureBackupProtectionLock」 を手動で削除してください。  </p><p>前提条件 :<br>削除ロックを削除するには、作業を行うユーザーが対象のストレージ アカウントに対して、<code>Microsoft.Authorization/*</code> または <code>Microsoft.Authorization/locks/*</code> アクションにアクセス可能である必要がございます。 (組み込みロールでは、<strong>所有者</strong> もしくは <strong>ユーザー アクセス管理者ロール</strong> の割り当てが必要となります。)<br>削除ロックの作業を行う前に、予め上記アクセス許可を行ってください。  </p><ul><li>誰がロックを作成または削除できるか / ロックを使って Azure リソースを保護する - Azure Resource Manager | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/lock-resources?tabs=json#who-can-create-or-delete-locks">https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/lock-resources?tabs=json#who-can-create-or-delete-locks</a><br>抜粋 :</li></ul><blockquote><p>管理ロックを作成または削除するには、<code>Microsoft.Authorization/*</code> または <code>Microsoft.Authorization/locks/*</code> アクションにアクセスする必要があります。<strong>所有者</strong>と<strong>ユーザー アクセス管理者ロール</strong>に割り当てられているユーザーには、必要なアクセス権があります。  </p></blockquote><p>手順 :  </p><ol><li><p>削除ロック 「AzureBackupProtectionLock」 を削除する<br>ストレージ アカウントの <code>設定 &gt; ロック</code> へアクセスし、削除ロック 「AzureBackupProtectionLock」 を削除します<br><img src="https://github.com/user-attachments/assets/5b358e3c-edfc-4a9c-90c4-71a540581f69"></p></li><li><p>(不要なファイル削除などの作業完了後) 削除ロック 「AzureBackupProtectionLock」 を再設定する  </p><ul><li>ストレージ アカウントの <code>設定 &gt; ロック</code> へアクセスし、削除ロックを追加します<br><img src="https://github.com/user-attachments/assets/a736e344-22d9-4009-86be-c357f3392602">  </li><li>もしくは、Azure ファイル共有のオンデマンド バックアップを手動で実行します (自動的に、削除ロック 「AzureBackupProtectionLock」 が設定されます)<br>詳細な手順につきましては、下記ドキュメントをご確認ください。  <ul><li>オンデマンド バックアップの実行手順 :<br>オンデマンド バックアップ ジョブを実行する / Azure portal で Azure ファイル共有をバックアップする - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-files?tabs=backup-center#run-an-on-demand-backup-job">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-files?tabs=backup-center#run-an-on-demand-backup-job</a>  </li></ul></li></ul></li></ol><h2 id="AzureBackupProtectionLock-を設定させない方法"><a href="#AzureBackupProtectionLock-を設定させない方法" class="headerlink" title="AzureBackupProtectionLock を設定させない方法"></a><a id="4"></a>AzureBackupProtectionLock を設定させない方法</h2><p>Azure ファイル共有のバックアップ構成時に、ストレージ アカウントのロック無効化設定を行うことで、削除ロック 「AzureBackupProtectionLock」 を設定せずに、Azure ファイル共有のバックアップを構成 / 取得いただくことが可能となります。  </p><div class="alert is-important"><p class="alert-title">重要</p><p>Azure Backup サービスといたしましては、<strong>削除ロック 「AzureBackupProtectionLock」 を有効化していただくことを推奨</strong>いたします。</p><p>もし削除ロック 「AzureBackupProtectionLock」 を設定せずにバックアップを構成し、意図せずスナップショットが消失したとしても、基本的には弊社側での復旧対応は致しかねますこと、予めご了承ください。  </p></div><p>手順 :  </p><ul><li><p>Recovery Services コンテナーからバックアップを構成する場合<br>Recovery Services コンテナーの <code>はじめに &gt; バックアップ &gt; Azure ファイル共有のバックアップ構成</code> にアクセスします。<br><img src="https://github.com/user-attachments/assets/d0ab1a1b-fa35-4c44-b371-1bde80209c07"><br>バックアップの構成画面のストレージ アカウントの選択時に、<strong>「ストレージ アカウントのロックを有効にする」のチェックを外してください</strong>。<br><img src="https://github.com/user-attachments/assets/65a4c4c8-c800-4d04-ab2a-ce8512be102a"></p></li><li><p>Azure ファイル共有からバックアップを構成する場合<br>Azure ファイル共有の <code>操作 &gt; バックアップ</code> へアクセスし、<strong>「Storage account lock」のトグル ボタンを無効にしてください</strong>。<br><img src="https://github.com/user-attachments/assets/9535dd6e-f3b9-41c5-bfc6-a6fc4cfe0d45"></p></li></ul><div class="alert is-warning"><p class="alert-title">警告</p><p>Azure ファイル共有を新規作成する際に表示される Azure Backup 構成画面では、ストレージ アカウントのロックを無効化させる設定は行えません。</p><p>もしストレージ アカウントのロックを無効化させたい場合には、<strong>バックアップを構成せずに</strong> Azure ファイル共有を作成し、その後に Azure Backup を構成してください。</p><p><img src="https://github.com/user-attachments/assets/7df7d32c-6273-4e1f-9529-62e6afd16609"></p></div><div class="alert is-warning"><p class="alert-title">警告</p><p>同じストレージ アカウントにデプロイされている、他の Azure ファイル共有で既に Azure Backup を構成している場合には、ストレージ アカウントが Recovery Services コンテナーのバックアップ インフラストラクチャとして既に登録されているため、ストレージ アカウントのロック無効化設定が行えません。</p><p>ストレージ アカウントのロック無効化設定が行えるのは、Recovery Services コンテナーのバックアップ インフラストラクチャに登録されていないストレージ アカウントにデプロイされている Azure ファイル共有のバックアップを構成する時のみ (ストレージ アカウント配下の Azure ファイル共有全てにおいて、Azure Backup が構成されていないとき) であることにご注意ください。  </p></div>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;Azure ファイル共有のバックアップを構成すると、バックアップ データやストレージ アカウントが誤って削除されないように、削除ロック 「AzureBackupP</summary>
      
    
    
    
    
    <category term="Azure Files Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Files-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの料金の違い</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_billing/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_billing/</id>
    <published>2024-08-19T03:00:00.000Z</published>
    <updated>2024-08-27T06:06:49.065Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、Azure VM Backup において、<br>「Standard バックアップ ポリシー (標準ポリシー) 」でバックアップを取得した場合と<br>「Enhanced バックアップ ポリシー (拡張ポリシー) 」でバックアップを取得した場合のそれぞれの料金の違いについて説明します。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/8ccd86d4-3e8e-4f19-9155-27ae50c50b9a" alt="image"></p><p>(参考 関連ブログ記事)<br>・料金計算ツールを用いた Azure VM Backup の料金見積もりについて | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br>　<a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_calculator/">https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_calculator/</a></p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの機能の違いについて</a><br><a href="#2">2. Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの料金の違い</a><br><a href="#3">3. スナップショット料金の請求先について</a></p><hr><h2 id="1-Standard-バックアップ-ポリシーと-Enhanced-バックアップ-ポリシーの機能の違いについて"><a href="#1-Standard-バックアップ-ポリシーと-Enhanced-バックアップ-ポリシーの機能の違いについて" class="headerlink" title="1. Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの機能の違いについて"></a>1. Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの機能の違いについて<a id="1"></a></h2><p>それぞれのバックアップ ポリシーで Azure VM Backup を取得する場合の機能の違いは下記公開ドキュメントをご参照ください。<br>・拡張ポリシーを使用して Azure VM をバックアップする - Azure Backup | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal</a></p><h2 id="2-Standard-バックアップ-ポリシーと-Enhanced-バックアップ-ポリシーの料金の違い"><a href="#2-Standard-バックアップ-ポリシーと-Enhanced-バックアップ-ポリシーの料金の違い" class="headerlink" title="2. Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの料金の違い"></a>2. Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの料金の違い<a id="2"></a></h2><h3 id="Azure-VM-Backup-の料金"><a href="#Azure-VM-Backup-の料金" class="headerlink" title="Azure VM Backup の料金"></a>Azure VM Backup の料金</h3><p>Azure VM Backup を利用する場合、その料金を見積もる際には以下 3 点が課金項目となります。<br>　(1) Azure 仮想マシンのインスタンスに対する課金<br>　(2) Recovery Services コンテナーに保管されるバックアップ データに対する課金<br>　(3) Azure VM Backup の機能で取得されるスナップショットに対する課金</p><p>(1) と (2) の課金は、「Standard バックアップ ポリシー」でバックアップ取得しても、「Enhanced バックアップ ポリシー」でバックアップ取得しても、どちらも同じ料金計算方式となります。</p><p>この 2 項目は、下記公開ドキュメント上で説明している「保護されたインスタンス サイズ (1) 」「バックアップ ストレージの課金 (2) 」箇所に相当します。</p><p>(参考ドキュメント)<br>・バックアップのコスト<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-costs">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-costs</a><br>　引用： “保護されたインスタンス サイズの計算は、”実際の” VM のサイズに基づきます。”<br>　引用： “同様に、バックアップ ストレージの課金は、Azure Backup に格納されているデータ量 (各回復ポイントの実際のデータの合計) に基づきます。”</p><p>いっぽう (3) の課金は、「Standard バックアップ ポリシー」でバックアップ取得する場合と、「Enhanced バックアップ ポリシー」でバックアップ取得する場合とで、料金の加算方法が変わってきます。</p><h3 id="「Azure-VM-Backup-の機能で取得されるスナップショットに対する課金」の加算方法の違い"><a href="#「Azure-VM-Backup-の機能で取得されるスナップショットに対する課金」の加算方法の違い" class="headerlink" title="「Azure VM Backup の機能で取得されるスナップショットに対する課金」の加算方法の違い"></a>「Azure VM Backup の機能で取得されるスナップショットに対する課金」の加算方法の違い</h3><p>「Standard バックアップ ポリシー」では、初回のスナップショット取得時点では料金は発生しません。<br>「Enhanced バックアップ ポリシー」では、初回のスナップショット取得時点で、使用データ量分のスナップショットに対して料金が発生します。</p><p>また、1 GB あたりの課金額は以下の通りそれぞれ違いがあります。</p><p>標準ポリシー:  0.12 ドル/ 1 GB<br>拡張ポリシー:  0.05 ドル/ 1 GB</p><ul><li>リージョンにより料金が異なる場合がございます。(上記 および 以下の参考例は、USEast2 の価格となります。)</li></ul><p>下記の表は 100 GB の容量をもつ Azure 仮想マシンに対して、毎日 1 GB の増分が発生するケースにおいて、スナップショットを 4 日間保管した場合の比較表となります。<br>*表中の料金は前日からの増分により発生した課金の月額を示しており、実際の料金は保存期間によって変動する場合があります。<br>(参考例)<br><img src="https://github.com/user-attachments/assets/531cd065-17b1-4b0b-ada1-934cf68a5b77"><br>※1 便宜上 100 GB と記載しておりますが、より正確には初回のスナップショット取得時点では 0 GB となります。<br>(その後の変更ブロック発生によりスナップショット サイズが増大いたします)</p><p>上記サンプルケースでは Enhanced バックアップ ポリシー 利用時の方が費用は高くなりますが、初回のバックアップデータ量が減った場合や、翌日以降の増分データ量が増加する場合は、Standard バックアップ ポリシー利用時の方が割高となるシナリオも考えられます。</p><p>「(3) Azure VM Backup の機能で取得されるスナップショットに対する課金」における<br>リージョン毎のスナップショット料金詳細は下記をご参照ください。</p><h4 id="Standard-バックアップ-ポリシー-スナップショットに対する料金"><a href="#Standard-バックアップ-ポリシー-スナップショットに対する料金" class="headerlink" title="Standard バックアップ ポリシー - スナップショットに対する料金"></a>Standard バックアップ ポリシー - スナップショットに対する料金</h4><p>下記リンクから、リージョン・通貨をご希望のものへと設定変更いただければ、スナップショットに対する料金を確認できます。<br>・Azure ページ BLOB Storage の価格 | Microsoft Azure<br>　<a href="https://azure.microsoft.com/ja-jp/pricing/details/storage/page-blobs/">https://azure.microsoft.com/ja-jp/pricing/details/storage/page-blobs/</a></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/727481b0-cbab-4f49-976a-2b8428d5f209"></p><h4 id="Enhanced-バックアップ-ポリシー-スナップショットに対する料金"><a href="#Enhanced-バックアップ-ポリシー-スナップショットに対する料金" class="headerlink" title="Enhanced バックアップ ポリシー - スナップショットに対する料金"></a>Enhanced バックアップ ポリシー - スナップショットに対する料金</h4><p>下記リンクから、リージョン・通貨をご希望のものへと設定変更いただければ、スナップショットに対する料金を確認できます。<br>・料金 - Managed Disks | Microsoft Azure<br>　<a href="https://azure.microsoft.com/ja-jp/pricing/details/managed-disks/">https://azure.microsoft.com/ja-jp/pricing/details/managed-disks/</a></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/69d004e5-cef6-4930-a777-43a986c713ec"></p><h2 id="3-スナップショット料金の請求先について"><a href="#3-スナップショット料金の請求先について" class="headerlink" title="3. スナップショット料金の請求先について"></a>3. スナップショット料金の請求先について<a id="3"></a></h2><p>　(1) Azure 仮想マシンのインスタンスに対する課金<br>　(2) Recovery Services コンテナーに保管されるバックアップ データに対する課金<br>　(3) Azure VM Backup の機能で取得されるスナップショットに対する課金</p><p>上記料金の請求書上では、各項目 および バックアップ ポリシーの違いによって、次に示す表のように表示されます。<br>Azure Backup の 料金として請求される項目は (1) (2) であり、(3) は スナップショットにかかった料金 として別の項目として請求されます。 </p><table><thead><tr><th align="left">課金項目</th><th align="left">バックアップ ポリシー</th><th align="left">サービス名</th><th align="left">請求上の表示 (Meter)</th><th align="left">請求されるリソースグループ</th></tr></thead><tbody><tr><td align="left">(1)</td><td align="left">Standard / Enhanced バックアップ ポリシー</td><td align="left">Backup</td><td align="left">Azure VM Protected Instances</td><td align="left">Recovery Services コンテナーのリソース グループ</td></tr><tr><td align="left">(2)</td><td align="left">Standard / Enhanced バックアップ ポリシー</td><td align="left">Backup</td><td align="left"><span style="color: red; ">LRS</span> Data Stored</td><td align="left">Recovery Services コンテナーのリソース グループ</td></tr><tr><td align="left">(3)</td><td align="left">Standard バックアップ ポリシー</td><td align="left">Storage</td><td align="left">LRS snapshots</td><td align="left">Managed Disk のリソース グループ</td></tr><tr><td align="left">(3)</td><td align="left">Enhanced バックアップ ポリシー</td><td align="left">Storage</td><td align="left">Snapshots ZRS Snapshots</td><td align="left">復元ポイント コレクションのリソース グループ</td></tr></tbody></table><p>　( <span style="color: red; ">赤文字</span>部分は、対象 Recovery Services コンテナーの「ストレージ レプリケーションの種類」によって変わります)</p><p>ご参考までに、弊社検証環境にて確認した各項目の表示例を以下に示します。<br>画像 1：コスト分析画面にて確認した (1) および (2) の表示例（ストレージ レプリケーションの種類 ：ローカル冗長 (LRS)）<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/d086273d-b86f-4458-aa1c-5aac0dd7bd6e" alt="画像 1"></p><p> 画像 2：コスト分析画面にて確認した (3) の表示例 (Standard バックアップ ポリシー)<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/7ecffa2f-913d-462e-90e0-cf98963f3ca9" alt="画像 2"></p><p>(参考) 画像 2 のバックアップ対象 の VM の Azure Managed Disk のリソース グループ名：rgsqlag<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/baed21f1-4624-48ce-a1a0-19e24ddc99cc" alt="参考"></p><p>画像 3：コスト分析画面にて確認した (3) の表示例 (Enhanced バックアップ ポリシー)<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/ed02d045-2044-4124-a3c0-3028e4e50f59" alt="画像 3"></p><p>(参考) 画像 3 の復元ポイント コレクションのリソース グループ名：azurebackuprg_eastus_1<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/418c73c9-524c-4502-99ae-89d8ca17dc86" alt="参考"></p><p>(補足)<br>各バックアップ ポリシーにて取得されるスナップショットはそれぞれ以下のスナップショット層へ格納されます。<br>　・Standard バックアップ ポリシー： LRS のスナップショット層<br>　・Enhanced バックアップ ポリシー： ZRS のスナップショット層 </p><p>(参考ドキュメント)<br>・拡張ポリシーを使用して Azure VM をバックアップする<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal</a><br>　引用： “インスタント復元層では、ゾーン冗長ストレージ (ZRS) の回復性を使用してゾーン冗長性が確保されています。”</p><p>本記事の内容は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、Azure VM Backup において、&lt;br&gt;「Standard バックアップ ポリシー (標準ポリシー) 」でバックアップを取得した場合と&lt;br&gt;「</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>QL4L-5D8 XNV5-HTZ クラシック アラートから Azure Monitor を使用した組み込みのアラートへの移行について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/HowToMoveClassicAlert/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/HowToMoveClassicAlert/</id>
    <published>2024-08-14T04:00:00.000Z</published>
    <updated>2024-08-27T06:06:49.037Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Backup サポートです。<br>今回は、2023 年 3 月末より弊社から発行されている、アラート追跡 ID 「QL4L-5D8」、「XNV5-HTZ」について説明いたします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#Q1">Q1. 「QL4L-5D8」「XNV5-HTZ」このアラートは何ですか？</a><br><a href="#Q2">Q2. どの Recovery Services コンテナーが「クラシック アラート設定」になっていますか？</a><br><a href="#Q3">Q3. クラシック アラートから Azure Monitor を使用した組み込みのアラートへと移行した場合のコストはどうなりますか？</a><br><a href="#Q4">Q4. クラシック アラートの「通知の構成」をしているかどうかは 1 つ 1 つの Recovery Services コンテナーを確認する必要がありますか？</a><br><a href="#Q5">Q5. Azure Monitor を使用した組み込みのアラートで、クラシック アラートと同じ重要度のアラート メールを通知するには？</a></p><hr><h2 id="Q1-「QL4L-5D8」「XNV5-HTZ」このアラートは何ですか？"><a href="#Q1-「QL4L-5D8」「XNV5-HTZ」このアラートは何ですか？" class="headerlink" title="Q1. 「QL4L-5D8」「XNV5-HTZ」このアラートは何ですか？"></a><a id="Q1"></a>Q1. 「QL4L-5D8」「XNV5-HTZ」このアラートは何ですか？</h2><p><strong>A1</strong> クラシック アラートから、Azure Monitor を使用した組み込みのアラートへと移行するよう、お知らせするためのものです。<br>Recovery Services コンテナーでは、クラシック アラートが<span style="color: red; ">既定</span>で存在しており、かつ、利用可能な状態となっております。<br>後述 「Q2. どの Recovery Services コンテナーが「クラシック アラート設定」になっていますか？」 をご参照いただき、クラシック アラートを利用した通知の設定有無をまずはご確認くださいますようお願いいたします。</p><h4 id="・クラシック-アラート機能用いて、現在メールへのアラート通知を構成している場合"><a href="#・クラシック-アラート機能用いて、現在メールへのアラート通知を構成している場合" class="headerlink" title="・クラシック アラート機能用いて、現在メールへのアラート通知を構成している場合"></a>・クラシック アラート機能用いて、現在メールへのアラート通知を構成している場合</h4><p>クラシック アラートは、2026 年 3 月 31 日をもって廃止する予定です。<br>監視設定を継続してご利用になられる場合は、お手数ではございますが、「Azure Monitor を使用した組み込みのアラート」への切り替えを事前にご検討くださいますようお願いいたします。</p><h4 id="・クラシック-アラート機能用いて、現在メールへのアラート通知を構成していないが、今後はバックアップ-ジョブ失敗時にメール通知などのアラートをご希望の場合"><a href="#・クラシック-アラート機能用いて、現在メールへのアラート通知を構成していないが、今後はバックアップ-ジョブ失敗時にメール通知などのアラートをご希望の場合" class="headerlink" title="・クラシック アラート機能用いて、現在メールへのアラート通知を構成していないが、今後はバックアップ ジョブ失敗時にメール通知などのアラートをご希望の場合"></a>・クラシック アラート機能用いて、現在メールへのアラート通知を構成していないが、今後はバックアップ ジョブ失敗時にメール通知などのアラートをご希望の場合</h4><p>クラシック アラートから、「Azure Monitor を使用した組み込みのアラート」へと切り替え設定することをご検討ください。</p><h4 id="・クラシック-アラート機能用いて、現在メールへのアラート通知を構成していない、かつ今後もバックアップ-ジョブ失敗時にメール通知などのアラートをご希望でない場合"><a href="#・クラシック-アラート機能用いて、現在メールへのアラート通知を構成していない、かつ今後もバックアップ-ジョブ失敗時にメール通知などのアラートをご希望でない場合" class="headerlink" title="・クラシック アラート機能用いて、現在メールへのアラート通知を構成していない、かつ今後もバックアップ ジョブ失敗時にメール通知などのアラートをご希望でない場合"></a>・クラシック アラート機能用いて、現在メールへのアラート通知を構成していない、かつ今後もバックアップ ジョブ失敗時にメール通知などのアラートをご希望でない場合</h4><p><span style="color: red; ">特段お客様での追加作業は不要です。</span></p><p>・監視とレポートのシナリオ<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/monitoring-and-alerts-overview#monitoring-and-reporting-scenarios">https://learn.microsoft.com/ja-jp/azure/backup/monitoring-and-alerts-overview#monitoring-and-reporting-scenarios</a></p><p><img src="https://user-images.githubusercontent.com/96324317/230756428-28f8085a-16bf-49ab-aa50-8659f342b81e.png"></p><p><img src="https://user-images.githubusercontent.com/96324317/230756444-3a95a6b5-dd4d-47e0-b3d1-ea3ffe54fa49.png"></p><p><img src="https://user-images.githubusercontent.com/96324317/230756450-5d78ebd9-19e0-455b-9ba6-6f079f9cf65d.png"></p><h2 id="Q2-どの-Recovery-Services-コンテナーが「クラシック-アラート設定」になっていますか？"><a href="#Q2-どの-Recovery-Services-コンテナーが「クラシック-アラート設定」になっていますか？" class="headerlink" title="Q2.どの Recovery Services コンテナーが「クラシック アラート設定」になっていますか？"></a><a id="Q2"></a>Q2.どの Recovery Services コンテナーが「クラシック アラート設定」になっていますか？</h2><p><strong>A2</strong><br>・既定ですべての Recovery Services コンテナーにおいて、「Azure Monitor を使用した組み込みのアラート」へと移行していない Recovery Services コンテナーは、「クラシック アラート」が有効になっており、今回の正常性アラート対象となっております<br>・実際に「クラシック アラート」を用いてメールへの通知構成をしているかどうかは、お客様環境の設定次第です</p><h4 id="【どの-Recovery-Services-コンテナーでクラシック-アラートが有効になっているのかを確認する方法】"><a href="#【どの-Recovery-Services-コンテナーでクラシック-アラートが有効になっているのかを確認する方法】" class="headerlink" title="【どの Recovery Services コンテナーでクラシック アラートが有効になっているのかを確認する方法】"></a>【どの Recovery Services コンテナーでクラシック アラートが有効になっているのかを確認する方法】</h4><p>[バックアップ センター] ブレードの [概要] タブより、”アクティブなアラート” 項目に<br><code>[以前のアラート ソリューションであるクラシック アラートを使用しているコンテナーが xx 個あります。]</code><br> と表示されている場合、クラシック アラートが有効・利用可能となっている Recovery Services コンテナーが存在しています。</p><p>この記述がある場合は、後述される [アクションを起こすには、ここをクリック] をクリックします。</p><p><img src="https://user-images.githubusercontent.com/96324317/230756521-74ec97f7-1147-4799-aa66-59b789ab3f69.png"></p><p>Azure Monitor アラートのみの使用をオプトインの [アラートの管理] をクリックします。</p><p><img src="https://user-images.githubusercontent.com/96324317/230756529-fbb23335-c992-4b39-b4b9-071e280168f8.png"></p><p>[Azure Monitor アラートのみの使用をオプトイン] 画面にて、リストされている Recovery Services コンテナーを確認します。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>項目 <code>クラシック アラートのバックアップ</code> が「はい」となっている Recovery Services コンテナーが対象となります。</p></div><p><img src="https://github.com/user-attachments/assets/319bf6c0-a39a-490a-86ab-a719b2abc0b3"></p><h4 id="【どの-Recovery-Services-コンテナーが、クラシック-アラートの「通知の構成」を行っているのかを確認する方法】"><a href="#【どの-Recovery-Services-コンテナーが、クラシック-アラートの「通知の構成」を行っているのかを確認する方法】" class="headerlink" title="【どの Recovery Services コンテナーが、クラシック アラートの「通知の構成」を行っているのかを確認する方法】"></a>【どの Recovery Services コンテナーが、クラシック アラートの「通知の構成」を行っているのかを確認する方法】</h4><p>リストされた Recovery Services コンテナーが実際に通知の構成をしているかどうかは、上記でリストされた Recovery Services コンテナー ＞ [バックアップ アラート] ＞ ”通知の構成” ＞ 「メールの通知：オン」 となっているかどうかで確認可能です。<br><img src="https://user-images.githubusercontent.com/96324317/230756566-faba366c-1f68-4034-8f4e-bbc1f9e7bc2f.png"></p><p>通知の構成をしている Recovery Services コンテナーがある場合、[Azure Monitor アラートのみの使用をオプトイン] 画面にて、アラートの設定の更新を行います。</p><div class="alert is-info"><p class="alert-title">Note</p><p>”通知の構成” ＞「メールの通知：オン」をしている Recovery Services コンテナーが無い場合、かつ、今後バックアップジョブの監視設定をする必要が無い場合は、下記対応は不要です。</p></div><p>まず、対象 Recovery Services コンテナーを選択して、”アラートの設定” 列の “更新” を押下してください。<br><img src="https://github.com/user-attachments/assets/2534b4ea-f20e-4a75-b1c6-1a0c8944c33f"></p><p>表示された [監視の設定] 画面にて “Backup 用の Azure Monitor アラートのみを使用” にチェックを入れてください。<br>また “Backup のジョブ エラーに関する組み込みの Azure Monitor アラート” も有効化してください。<br><img src="https://github.com/user-attachments/assets/f1833b43-a0a2-4a41-9880-1b14d1f742cf"></p><div class="alert is-warning"><p class="alert-title">警告</p><p> “ジョブ エラーに関する組み込みの Azure Monitor アラート” が無効化されていると、バックアップセンターの下記概要画面上ではクラシック アラートを使用しているコンテナーとしてカウントされたままとなりますのでご注意ください。</p><p><img src="https://github.com/jpabrs-scem/blog/assets/141192952/9518f95f-bbea-4edb-bb60-4410fa0441db"></p></div><p>最後に画面下部の “更新” ボタンを押下していただければ、クラシック アラートの廃止は完了いたします。</p><p>なお、 [監視の設定] 画面に記載されているように、メールなどの通知が必要な場合は、別途設定していただく必要があります。<br>詳細は下記のドキュメントを参照いただければと存じます。<br>・クラシック アラートから組み込みのAzure Monitor アラートに移行する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/move-to-azure-monitor-alerts#migrate-from-classic-alerts-to-built-in-azure-monitor-alerts">https://learn.microsoft.com/ja-jp/azure/backup/move-to-azure-monitor-alerts#migrate-from-classic-alerts-to-built-in-azure-monitor-alerts</a></p><h2 id="Q3-クラシック-アラートから-Azure-Monitor-を使用した組み込みのアラートへと移行した場合のコストはどうなりますか？"><a href="#Q3-クラシック-アラートから-Azure-Monitor-を使用した組み込みのアラートへと移行した場合のコストはどうなりますか？" class="headerlink" title="Q3.クラシック アラートから Azure Monitor を使用した組み込みのアラートへと移行した場合のコストはどうなりますか？"></a><a id="Q3"></a>Q3.クラシック アラートから Azure Monitor を使用した組み込みのアラートへと移行した場合のコストはどうなりますか？</h2><p><strong>A3</strong> 「Azure Monitor を使用した組み込みのアラートが生成されること」自体に料金は発生しません。<br>一方、メールなどへアラートを通知させる場合は、少額の料金が発生いたします。<br>詳細は下記ドキュメントよりご参照ください。</p><p>・クラシック アラートから組み込みの Azure Monitor アラートに移行する<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/move-to-azure-monitor-alerts#migrate-from-classic-alerts-to-built-in-azure-monitor-alerts">https://learn.microsoft.com/ja-jp/azure/backup/move-to-azure-monitor-alerts#migrate-from-classic-alerts-to-built-in-azure-monitor-alerts</a></p><p><img src="https://user-images.githubusercontent.com/96324317/230756632-22b2968e-d899-44f4-8472-c0c5db56f0c9.png"></p><p>Free レベル (1 か月あたり 1,000 メール) を超える通知に対しては、下記の料金が発生します。</p><p>・価格 - Azure Monitor | Microsoft Azure<br><a href="https://azure.microsoft.com/ja-jp/pricing/details/monitor/">https://azure.microsoft.com/ja-jp/pricing/details/monitor/</a><br>“メール            1 か月あたりメール 1,000 通         メール 100,000 通につき $2”<br><img src="https://user-images.githubusercontent.com/96324317/234444128-ca0d6690-a6a8-4bcf-9e9e-7e63cf44ce49.png"></p><h2 id="Q4-クラシック-アラートの「通知の構成」をしているかどうかは-1-つ-1-つの-Recovery-Services-コンテナーを確認する必要がありますか？"><a href="#Q4-クラシック-アラートの「通知の構成」をしているかどうかは-1-つ-1-つの-Recovery-Services-コンテナーを確認する必要がありますか？" class="headerlink" title="Q4.クラシック アラートの「通知の構成」をしているかどうかは 1 つ 1 つの Recovery Services コンテナーを確認する必要がありますか？"></a><a id="Q4"></a>Q4.クラシック アラートの「通知の構成」をしているかどうかは 1 つ 1 つの Recovery Services コンテナーを確認する必要がありますか？</h2><p><strong>A4</strong> 恐縮ながら、現状はクラシック アラートの「通知の構成」部分を照会するような Azure PowerShell / Azure CLI コマンドのご用意が無いため、お客様には Azure ポータル画面の Recovery Services コンテナーを 1 つ 1 つ確認いただく必要がございます。<br>※　前提としてクラシック アラートの「通知の構成」をされているのであれば、お客様が設定されたメールアドレスの宛先へと、バックアップ ジョブ失敗時などに通知がなされています。</p><p>その他確認手段の 1 つとして、以下のような REST API を発行することで確認が可能ですので、参考として紹介いたします。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>以下 REST API は、本ブログ発行時点で確認可能な手段であり、事前予告なく返却値が変わる可能性がありますこと、ご了承ください。</p><p>さらに、以下 REST API は、あくまで参考としてご連携するサンプル コマンドでございます。</p><p>コマンド実装をされる場合は貴社にて検証のうえ、実施いただきますようご留意ください。</p><p>また、Azure サポートでは主に Post Production の Break &amp; Fix を担当しており、スクリプトのコードレビューのサポートは承っておりませんので、予めご理解をいただけますと幸いでございます。</p></div><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">### クラシック アラートのメール通知が有効化されているかを確認する </span><br><span class="line">### ※ (前提) Connect-AzAccount コマンドにて、 Azure に接続可能な状態で実行すること</span><br><span class="line"></span><br><span class="line">$RSVList = Get-AzRecoveryServicesVault | Select-Object Name, ResourceGroupName, SubscriptionId</span><br><span class="line"></span><br><span class="line"># リクエスト ヘッダーを作成</span><br><span class="line">$headers = @&#123;</span><br><span class="line">    &#x27;Content-type&#x27;  = &#x27;application/json&#x27;</span><br><span class="line">    &#x27;Authorization&#x27; = &#x27;Bearer &#x27; + (Get-AzAccessToken).Token</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 結果出力先のオブジェクトを作成</span><br><span class="line">$results = @()</span><br><span class="line"></span><br><span class="line"># Recovery Services コンテナーごとに API へリクエストを送り、結果を取得する</span><br><span class="line">foreach ( $rsv in $RSVList ) &#123;</span><br><span class="line">    $uri = &quot;https://management.azure.com/subscriptions/$($rsv.SubscriptionId)/resourceGroups/$($rsv.ResourceGroupName)/providers/Microsoft.RecoveryServices/vaults/$($rsv.Name)/monitoringConfigurations/notificationConfiguration?api-version=2017-07-01-preview&quot;</span><br><span class="line">    $response = (Invoke-RestMethod -Uri $uri -Method Get -Headers $headers).properties</span><br><span class="line">    $results += @([pscustomobject]@&#123;subscriptionID = $rsv.SubscriptionId; resourceGroupName = $rsv.ResourceGroupName; recoveryServicesContainerName = $rsv.Name; isClassicAlertNotificationEnabled = $response.areNotificationsEnabled; mailRecipients = $response.additionalRecipients -join &#x27;; &#x27; &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 全ての結果をコンソール出力</span><br><span class="line">$results | Sort-Object isClassicAlertNotificationEnabled -Descending | ForEach-Object &#123; Write-Output $_ | Format-Table &#125;</span><br></pre></td></tr></table></figure><p>上記 REST API を発行した場合、「isClassicAlertNotificationEnabled：True」となっている Recovery Services コンテナーが「通知の構成：オン」となっているものとなります。<br><img src="https://user-images.githubusercontent.com/96324317/230820217-777e48c3-f704-4e83-9aeb-1a5b107633af.png"></p><p><img src="https://user-images.githubusercontent.com/96324317/230820265-bcb0a6df-eae6-4946-b0f9-c1f905a539d4.png"></p><p><img src="https://user-images.githubusercontent.com/96324317/230820287-06940bef-a423-4202-a016-e3ec7bd79489.png"></p><p><img src="https://user-images.githubusercontent.com/96324317/230820315-3f9dc117-bfac-4e73-b0aa-d37a12503390.png"></p><h2 id="Q5-Azure-Monitor-を使用した組み込みのアラートで、クラシック-アラートと同じ重要度のアラート-メールを通知するには？"><a href="#Q5-Azure-Monitor-を使用した組み込みのアラートで、クラシック-アラートと同じ重要度のアラート-メールを通知するには？" class="headerlink" title="Q5. Azure Monitor を使用した組み込みのアラートで、クラシック アラートと同じ重要度のアラート メールを通知するには？"></a><a id="Q5"></a>Q5. Azure Monitor を使用した組み込みのアラートで、クラシック アラートと同じ重要度のアラート メールを通知するには？</h2><p><strong>A5</strong><br>まず、クラシック アラートと Azure Monitor アラートの重要度につきまして、以下にご案内いたします。</p><div class="alert is-info"><p class="alert-title">Note</p><p>お急ぎの方は、下記各アラートの重要度に関する説明は省略いただいて問題ございません。設定方法をご案内している <a href="#Q5.1">【Azure Monitor を使用した組み込みのアラートで、クラシック アラートと同じ重要度のアラート メールを通知する設定方法】</a> をご確認ください。</p></div><h4 id="クラシック-アラートの重要度について"><a href="#クラシック-アラートの重要度について" class="headerlink" title="クラシック アラートの重要度について"></a>クラシック アラートの重要度について</h4><p>クラシック アラートでは、「重大」、「警告」の 2 種のアラートが以下のタイミングで発報されます。  </p><ul><li>「重大」 : バックアップやリストアの失敗、バックアップ データの削除などの破壊的操作が行われたとき  </li><li>「警告」 : MARS エージェントでのバックアップ操作で警告が発生したとき  </li></ul><p>・ Azure Backup で保護されたワークロードの監視 - Azure Backup | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults#alert-types">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults#alert-types</a><br>　 抜粋 :</p><blockquote><p><strong>重大</strong>: 原則として、(スケジュールされたかユーザーがトリガーしたかを問わず) バックアップまたは回復が失敗すると、アラートが生成されて “重大” アラートとして表示されます。 アラートは、バックアップの削除などの破壊的な操作でも生成されます。<br><strong>警告</strong>: バックアップ操作が成功したもののいくつかの警告を伴う場合、これらは “警告” アラートとして表示されます。 警告アラートは現在、Azure Backup エージェントのバックアップにのみ使用できます。<br><strong>情報</strong>: 現時点では、Azure Backup サービスで “情報” アラートは生成されません。  </p></blockquote><h4 id="Azure-Monitor-の組み込みアラートの重要度について"><a href="#Azure-Monitor-の組み込みアラートの重要度について" class="headerlink" title="Azure Monitor の組み込みアラートの重要度について"></a>Azure Monitor の組み込みアラートの重要度について</h4><p>Azure Monitor の組み込みアラートでは、主に「セキュリティ アラート」、「ジョブの失敗のアラート」の 2 種のアラートが以下のタイミングで発報されます。  </p><ul><li>「セキュリティ アラート」(重要度 : 0 - 重大) : バックアップ データの削除や、コンテナーの論理的な削除機能が無効化されたとき  </li><li>「ジョブの失敗のアラート」(重要度 : 1 - エラー) : バックアップやリストアが失敗したとき  </li></ul><p>また、MARS エージェントでのバックアップ操作で警告が発生したときや、SQL Server バックアップでサポートされていないバックアップ タイプが設定されていたときには、警告 (重要度 : 2 - 警告) アラートが発報されます。  </p><p>・ Azure Backup で保護されたワークロードの監視 - Azure Backup | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults#azure-monitor-alerts-for-azure-backup">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults#azure-monitor-alerts-for-azure-backup</a><br>　 抜粋 :  </p><blockquote><p><strong>セキュリティ アラート</strong>: バックアップ データの削除や、コンテナーの論理的な削除機能の無効化などのシナリオの場合、セキュリティ アラート (重大度 0) が発生し、Azure portal に表示されるか、他のクライアント (PowerShell、CLI、REST API) で使用されます。<br><strong>ジョブの失敗のアラート</strong>: バックアップ エラーや復元エラーなどのシナリオの場合、Azure Backup は、Azure Monitor 経由で組み込みアラート (重大度 1) を提供します。  </p></blockquote><p>・ SQL Server のデータベース バックアップに関するトラブルシューティング - Azure Backup | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-sql-server-azure-troubleshoot#backup-type-unsupported">https://learn.microsoft.com/ja-jp/azure/backup/backup-sql-server-azure-troubleshoot#backup-type-unsupported</a>  </p><h4 id="クラシック-アラートと-Azure-Monitor-を利用した組み込みのアラートの重要度の関係性について"><a href="#クラシック-アラートと-Azure-Monitor-を利用した組み込みのアラートの重要度の関係性について" class="headerlink" title="クラシック アラートと Azure Monitor を利用した組み込みのアラートの重要度の関係性について"></a>クラシック アラートと Azure Monitor を利用した組み込みのアラートの重要度の関係性について</h4><p>クラシック アラートと Azure Monitor を利用した組み込みのアラートの重要度は、おおよそ以下の関係性がございます。</p><ul><li>クラシック アラートの 「重大」 ≒  Azure Monitor を利用した組み込みのアラートの 「重大」 + 「エラー」  </li><li>クラシック アラートの 「警告」 ≒  Azure Monitor を利用した組み込みのアラートの 「警告」  </li></ul><h3 id="【Azure-Monitor-を使用した組み込みのアラートで、クラシック-アラートと同じ重要度のアラート-メールを通知する設定方法】"><a href="#【Azure-Monitor-を使用した組み込みのアラートで、クラシック-アラートと同じ重要度のアラート-メールを通知する設定方法】" class="headerlink" title="【Azure Monitor を使用した組み込みのアラートで、クラシック アラートと同じ重要度のアラート メールを通知する設定方法】"></a><a id="Q5.1"></a>【Azure Monitor を使用した組み込みのアラートで、クラシック アラートと同じ重要度のアラート メールを通知する設定方法】</h3><p>Azure Monitor を使用した組み込みのアラートで、クラシック アラートと同じ重要度のアラート メールを通知する設定方法を、以下にご案内いたします。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>下記ドキュメントに従って、クラシック アラートから組み込みの Azure Monnitor アラートへ移行する設定が完了していることが前提となります。</p><p>もし未設定である場合には、事前に下記ドキュメントの手順 1 ~ 7 を実行してください。</p><p>・ Azure Backup 用の Azure Monitor ベースのアラートに切り替える - Azure Backup | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/move-to-azure-monitor-alerts#migrate-from-classic-alerts-to-built-in-azure-monitor-alerts">https://learn.microsoft.com/ja-jp/azure/backup/move-to-azure-monitor-alerts#migrate-from-classic-alerts-to-built-in-azure-monitor-alerts</a>  </p></div><h4 id="クラシック-アラートのメール通知設定を確認する"><a href="#クラシック-アラートのメール通知設定を確認する" class="headerlink" title="クラシック アラートのメール通知設定を確認する"></a>クラシック アラートのメール通知設定を確認する</h4><p>Recovery Services コンテナーの <code>監視 &gt; バックアップ アラート &gt; 通知の構成</code> を表示し、項目「重要度」の設定内容を確認します。  </p><p><img src="https://github.com/user-attachments/assets/1f6da508-4c61-4639-b9d7-d9432c3089ef"></p><h4 id="Azure-Backup-用のアラート処理ルールの設定を変更する"><a href="#Azure-Backup-用のアラート処理ルールの設定を変更する" class="headerlink" title="Azure Backup 用のアラート処理ルールの設定を変更する"></a>Azure Backup 用のアラート処理ルールの設定を変更する</h4><p>バックアップ センターの <code>監視とレポート &gt; アラート &gt; アラート処理ルール</code> を表示し、Azure Monitor アラートへ切り替えるときに作成したアラート処理ルールを編集します。  </p><p><img src="https://github.com/user-attachments/assets/f4dddc70-d2ec-47cc-ba55-60400d1e1d32"><br><img src="https://github.com/user-attachments/assets/cdb94c4e-0192-4e46-a749-57930e2b3003"></p><p>項目 フィルター に、「重要度」フィルターを追加し、値として “0 - 重大”, “1 - エラー”, “2 - 警告” のいずれかを選択し、設定を保存します。<br>(下記例においては、クラシック アラートの重要度設定が “クリティカル, 警告” となっていたため、”0 - 重大”, “1 - エラー”, “2 - 警告” の 3 点を選択しております。)<br><img src="https://github.com/user-attachments/assets/f0161061-6b96-494a-93be-eff08d556e17"></p><p>以上で設定は完了です。  </p><h3 id="クラシック-アラートと-Azure-Monitor-を使用した組み込みのアラートの通知メールのサンプル"><a href="#クラシック-アラートと-Azure-Monitor-を使用した組み込みのアラートの通知メールのサンプル" class="headerlink" title="クラシック アラートと Azure Monitor を使用した組み込みのアラートの通知メールのサンプル"></a><a id="Q5.2"></a>クラシック アラートと Azure Monitor を使用した組み込みのアラートの通知メールのサンプル</h3><p>クラシック アラートと Azure Monitor を使用した組み込みのアラートの通知メールのサンプルを、以下のとおりご案内いたします。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>こちらのサンプル メールは 2024/8 頃に受信したものとなりますので、あくまで参考程度に留めてくださいますようお願い申し上げます。</p><p>より正確な内容をご確認いただくためにも、お客様ご自身で、アラート メールの受信検証を行っていただき、内容をご確認ください。</p></div><ul><li><p>バックアップ ジョブ失敗に関するアラート メール  </p><ul><li>クラシック アラート<br><img src="https://github.com/user-attachments/assets/3b3ec1a7-578b-4315-b62a-e322f853505b">  </li><li>Azure Monitor を使用した組み込みのアラート<br><img src="https://github.com/user-attachments/assets/2cb3f7df-5f3a-4199-b1cf-fc20ade47279">  </li></ul></li><li><p>セキュリティ アラート メール  </p><ul><li>クラシック アラート<br><img src="https://github.com/user-attachments/assets/a47cf52e-e42a-4030-9081-ff0c6e5c95e8">  </li><li>Azure Monitor を使用した組み込みのアラート<br><img src="https://github.com/user-attachments/assets/4dfd68e9-ce9c-46a0-8fae-c8c94e8645f6">  </li></ul></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、2023 年 3 月末より弊社から発行されている、アラート追跡 ID 「QL4L-5D8」、「XNV5-HTZ」について説明いたします。&lt;/p&gt;
&lt;h2 id</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>ASR の障害調査に必要な情報</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureSiteRecovery/RequestForInvestigating_ASR/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureSiteRecovery/RequestForInvestigating_ASR/</id>
    <published>2024-08-13T03:00:00.000Z</published>
    <updated>2024-08-27T06:06:49.065Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Site Recovery サポートです。<br>Azure Site Recovery (以下、ASR ) に関する調査をスムーズに進める為に、お客様側で確認して頂く箇所と、調査に必要な環境情報とログ情報を取得して頂き、サポートへ送付して頂く場合がございます。<br>今回は、ASR の障害調査に必要な <strong>環境情報</strong> と <strong>ログ情報</strong> について、ご案内いたします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. 調査に必要な環境情報</a><br><a href="#2">2. ログの取得方法</a><br><a href="#2-1">2-1. Azure to Azure シナリオの障害調査に必要なログ</a><br><a href="#2-2">2-2. VMware to Azure / 物理マシン to Azure クラシック シナリオの障害調査に必要なログ</a><br><a href="#2-3">2-3. VMware to Azure / 物理マシン to Azure モダン化シナリオの障害調査に必要なログ</a><br><a href="#2-4">2-4. Hyper-V to Azure シナリオの障害調査に必要なログ</a><br><a href="#3">3. ログ収集ツールの使用方法</a><br><a href="#3-1">3-1. ASRDiagnosticTool の使用方法</a><br><a href="#3-2">3-2. collect_support_materials の使用方法</a>  </p><hr><h2 id="1-調査に必要な環境情報"><a href="#1-調査に必要な環境情報" class="headerlink" title=" 1. 調査に必要な環境情報"></a><a id="1"></a> 1. 調査に必要な環境情報</h2><p>※既にお問い合わせチケット上に起票頂いている場合は、記載は不要になります。</p><ol><li>問題が発生しているサブスクリプション ID  </li><li>ASR のシナリオ詳細 (以下の内のどれか)<br>　a. Azure to Azure<br>　b. VMware to Azure モダン化<br>　c. VMware to Azure クラシック<br>　d. 物理マシン to Azure モダン化<br>　e. 物理マシン to Azure クラシック<br>　f. Hyper-V to Azure</li><li>問題が発生している Recovery Service コンテナー名 </li><li>問題が発生している Recovery Service コンテナーのリソース グループ名 </li><li>対象の マシン名</li><li>対象の Azure 仮想マシンのリソース グループ名</li><li>対象の OS </li><li>Proxy 設定の有無</li><li>ASR プライベート エンドポイント 設定の有無</li><li>Express Route 使用の有無</li></ol><h3 id="「モダン化」と「クラシック」を見分ける方法"><a href="#「モダン化」と「クラシック」を見分ける方法" class="headerlink" title="「モダン化」と「クラシック」を見分ける方法"></a>「モダン化」と「クラシック」を見分ける方法</h3><p>ASR の VMware to Azure シナリオ / 物理マシン to Azure シナリオ では 「モダン化」 と 「クラシック」 の 2 つの構成があります。<br>「モダン化」 と 「クラシック」 のどちらを利用しているかは、以下の画面から確認いただけます。</p><p>Azure Portal にて Recovery Services コンテナーを開き &gt; はじめに - Site Recovery &gt; 「VMware マシンを Azure に」 の下にある 1. の末尾に <code>(従来)</code> が、<br>付与されている場合は、<strong>「クラシック」の Recovery Services コンテナー</strong> となります。<br>付与されて<strong>いない</strong>場合は、<strong>「モダン化」の Recovery Services コンテナー</strong> となります。</p><img src="https://github.com/user-attachments/assets/74f7a3aa-a3e9-41c9-b85f-a82c903fc74e"><h2 id="2-ログの取得方法"><a href="#2-ログの取得方法" class="headerlink" title=" 2. ログの取得方法"></a><a id="2"></a> 2. ログの取得方法</h2><h3 id="2-1-Azure-to-Azure-シナリオの障害調査に必要なログ"><a href="#2-1-Azure-to-Azure-シナリオの障害調査に必要なログ" class="headerlink" title=" 2-1. Azure to Azure シナリオの障害調査に必要なログ"></a><a id="2-1"></a> 2-1. Azure to Azure シナリオの障害調査に必要なログ</h3><p>本シナリオではログを収集する方法が 2 つありますので、下記いずれかの方法にてログを収集ください。  </p><ul><li>方法 1 : ツールを使用してログを収集する</li><li>方法 2 : 手動でログを収集する  </li></ul><h4 id="方法-1-ツールを使用してログを収集する"><a href="#方法-1-ツールを使用してログを収集する" class="headerlink" title="(方法 1) ツールを使用してログを収集する"></a>(方法 1) ツールを使用してログを収集する</h4><p><u>&lt; Windows の場合 &gt;</u><br>下記の手順に沿って ASRDiagnosticTool  を実行し、ログをご収集ください。<br><a href="#3-1">3-1 ASRDiagnosticTool の使用方法</a></p><p><span style="color: red; ">またツール取得に加えて下記ファイルを手動で収集し、ご提供ください。</span>  </p><blockquote><p>C:\WindowsAzure\Logs</p></blockquote><p><u>&lt; Linux の場合 &gt;</u><br>下記の手順に沿って collect_support_materials.sh を実行し、ログをご収集ください。<br><a href="#3-2">3-2 collect_support_materials の使用方法</a>  </p><p><span style="color: red; ">またツール取得に加えて下記ファイルを手動で収集し、ご提供ください。</span>  </p><blockquote><p>/var/log/<br>  - evtcollforw.log<br>  - InstallerError.json<br>  - tagTelemetry_*.log<br>  - uarespawnd.log<br>  - Waagent.log<br>  - azure<br>  - ASRsetuptelemetry  </p></blockquote><h4 id="方法-2-手動でログを収集する"><a href="#方法-2-手動でログを収集する" class="headerlink" title="(方法 2 ) 手動でログを収集する"></a>(方法 2 ) 手動でログを収集する</h4><p><u>&lt; Windows の場合 &gt;</u>  </p><blockquote><p>C:\ProgramData\ASRSetupLogs<br>C:\ProgramData\Microsoft Azure Site Recovery<br>C:\Program Files\Microsoft Azure Recovery Services Agent\Temp<br>C:\Windows\System32\winevt\logs<br>C:\WindowsAzure\Logs<br>C:\Program Files (x86)\Microsoft Azure Site Recovery\agent <strong>(※1)</strong> </p></blockquote><p><strong>(※1)</strong> 全量いただけることが望ましいですが、全量が困難な場合は下記をご提供ください。  </p><blockquote><p>C:\Program Files (x86)\Microsoft Azure Site Recovery\agent\<br>  - AzureRcmCli.log<br>  - evtcollforw.log<br>  - s2*.log<br>  - svagent*.log<br>  - vacp.log<br>  - Application Data\ApplicationPolicyLogs<br>  - vxlogs  </p></blockquote><p><u>&lt; Linux の場合 &gt;</u>  </p><blockquote><p>/var/log/  <strong>(※1)</strong></p></blockquote><p><strong>(※1)</strong> 全量いただけることが望ましいですが、全量が困難な場合は下記をご提供ください。     </p><blockquote><p>/var/log/<br>  - ApplicationPolicyLogs/vacp.log<br>  - appservice*.log<br>  - AzureRcmCli.log<br>  - cdpcli.log<br>  - evtcollforw.log<br>  - InMage*.log<br>  - InstallerError.json<br>  - involflt*.log<br>  - s2*.log<br>  - svagent*.log<br>  - tagTelemetry_*.log<br>  - ua_install.log<br>  - uarespawnd.log<br>  - Waagent.log<br>  - azure<br>  - vxlogs<br>  - ApplicationData<br>  - ASRsetuptelemetry  </p></blockquote><h3 id="2-2-VMware-to-Azure-物理マシン-to-Azure-クラシック-シナリオの障害調査に必要なログ"><a href="#2-2-VMware-to-Azure-物理マシン-to-Azure-クラシック-シナリオの障害調査に必要なログ" class="headerlink" title=" 2-2. VMware to Azure / 物理マシン to Azure クラシック シナリオの障害調査に必要なログ"></a><a id="2-2"></a> 2-2. VMware to Azure / 物理マシン to Azure クラシック シナリオの障害調査に必要なログ</h3><p>ログ取得対象は下記マシン両方となります。</p><ul><li>構成サーバーとして機能するマシン</li><li>ソース マシン (保護対象マシン)</li></ul><p>本シナリオではログを収集する方法が 2 つありますので、下記いずれかの方法にてログを収集ください。</p><ul><li>方法 1 : ツールを使用してログを収集する</li><li>方法 2 : 手動でログを収集する</li></ul><p><span style="color: red; ">「構成サーバーとして機能するマシン」 と 「ソース マシン (保護対象マシン)」 両方から</span> 、 それぞれのログを収集ください。</p><h4 id="方法-1-ツールを使用してログを収集する-1"><a href="#方法-1-ツールを使用してログを収集する-1" class="headerlink" title="(方法 1) ツールを使用してログを収集する"></a>(方法 1) ツールを使用してログを収集する</h4><p><u>&lt; 構成サーバーおよび ソース マシンが Windows の場合 &gt;</u><br>下記の手順に沿ってASRDiagnosticTool  を実行し、ログをご収集ください。<br><a href="#3-1">3-1 ASRDiagnosticTool の使用方法</a></p><p><u>&lt; ソース マシンが Linux の場合 &gt;</u><br>下記の手順に沿って collect_support_materials.sh を実行し、ログをご収集ください。<br><a href="#3-2">3-2 collect_support_materials の使用方法</a></p><h4 id="方法-2-手動でログを収集する-1"><a href="#方法-2-手動でログを収集する-1" class="headerlink" title="(方法 2 ) 手動でログを収集する"></a>(方法 2 ) 手動でログを収集する</h4><p><u>&lt; 構成サーバー &gt;</u>  </p><blockquote><p>C:\ProgramData\ASRLogs<br>C:\ProgramData\ASRSetupLogs<br>C:\Windows\System32\winevt\logs<br>&lt;Cache InstallDir&gt;\home\svsystems\pushinstallsvc\temporaryfiles\  </p></blockquote><p><u>&lt; ソース マシン (Windows) &gt;</u>  </p><blockquote><p>C:\ProgramData\ASRSetupLogs</p></blockquote><p><u>&lt; ソース マシン (Linux) &gt;</u></p><blockquote><p>var/log/ua_install.log </p></blockquote><h3 id="2-3-VMware-to-Azure-物理マシン-to-Azure-モダン化シナリオの障害調査に必要なログ"><a href="#2-3-VMware-to-Azure-物理マシン-to-Azure-モダン化シナリオの障害調査に必要なログ" class="headerlink" title=" 2-3. VMware to Azure / 物理マシン to Azure モダン化シナリオの障害調査に必要なログ"></a><a id="2-3"></a> 2-3. VMware to Azure / 物理マシン to Azure モダン化シナリオの障害調査に必要なログ</h3><p>ログ取得対象は下記マシン両方となります。</p><ul><li>レプリケーション アプライアンスとして機能するマシン</li><li>ソース マシン (保護対象マシン)</li></ul><p>本シナリオではログを収集する方法が 2 つありますので、下記いずれかの方法にてログを収集ください。</p><ul><li>方法 1 : ツールを使用してログを収集する</li><li>方法 2 : 手動でログを収集する</li></ul><p><span style="color: red; ">「構成サーバーとして機能するマシン」 と 「ソース マシン (保護対象マシン)」 両方から</span> 、 それぞれのログを収集ください。</p><h4 id="方法-1-ツールを使用してログを収集する-2"><a href="#方法-1-ツールを使用してログを収集する-2" class="headerlink" title="(方法 1) ツールを使用してログを収集する"></a>(方法 1) ツールを使用してログを収集する</h4><p><u>&lt; レプリケーション アプライアンス および ソース マシンが Windows の場合 &gt;</u><br>下記の手順に沿ってASRDiagnosticTool  を実行し、ログをご収集ください。<br><a href="#3-1">3-1 ASRDiagnosticTool の使用方法</a></p><p><u>&lt; ソース マシンが Linux の場合 &gt;</u><br>下記の手順に沿って collect_support_materials.sh を実行し、ログをご収集ください。<br><a href="#3-2">3-2 collect_support_materials の使用方法</a></p><p><span style="color: red; ">またツール取得に加えて下記ファイルを手動で収集し、ご提供ください。</span>  </p><blockquote><p>/var/log/<br> - evtcollforw.log<br> - InstallerError.json<br> - tagTelemetry_*.log<br> - uarespawnd.log<br> - Waagent.log<br> - azure<br> - ASRsetuptelemetry  </p></blockquote><h4 id="方法-2-手動でログを収集する-2"><a href="#方法-2-手動でログを収集する-2" class="headerlink" title="(方法 2 ) 手動でログを収集する"></a>(方法 2 ) 手動でログを収集する</h4><p><u>&lt; レプリケーション アプライアンス &gt;</u><br>※ ファイルが存在しなければ取得不要です<br>※ <code>&lt;Cache InstallDir&gt;</code> はアプライアンス構築時に指定したキャッシュ ディスクとなり、デフォルトでは <code>E:\</code> ドライブとなります。 </p><blockquote><p>C:\Program Files\Microsoft Azure Recovery Services Agent\Temp<br>C:\Program Files\Microsoft Azure Recovery Services On-Premise Agent\logs<br>C:\Program Files\Microsoft Azure Site Recovery Process Server\home\svsystems<br>C:\ProgramData\MicrosoftAzureDRApplianceConfigurationManager.log<br>C:\ProgramData\Microsoft Azure\Logs<br>C:\ProgramData\ASRLogs<br>C:\ProgramData\AutoUpdateInstaller.log<br>C:\ProgramData\DiscoveryServiceServerInstall.log<br>C:\ProgramData\DiscoveryServiceVmwareInstall.log<br>C:\ProgramData\InstallDra.log<br>C:\ProgramData\PushInstallAgentSetup.log<br>C:\ProgramData\RcmProxyAgentSetup.log<br>C:\ProgramData\RcmReplicationAgentSetup.log<br>C:\ProgramData\RcmReprotectAgentSetup.log<br>C:\ProgramData\ProcessServerSetup.log<br>C:\ProgramData\Install Log<br>C:\Windows\Temp\OBInstaller0Curr.errlog<br>C:\Windows\Temp\OBManagedlog.LOGCurr.errlog<br>C:\Windows\Temp\OBMsi.log<br>&lt;Cache InstallDir&gt;\MarsAgent<br>&lt;Cache InstallDir&gt;\PSTelemetry<br>&lt;Cache InstallDir&gt;\PushInstallAgent<br>&lt;Cache InstallDir&gt;\RcmProxyAgent<br>&lt;Cache InstallDir&gt;\RcmReplicationAgent<br>&lt;Cache InstallDir&gt;\RcmReprotectAgent  </p></blockquote><p><u>&lt; ソース マシン (Windows) &gt;</u></p><blockquote><p>C:\ProgramData\ASRSetupLogs<br>&lt;Mobility service agent InstallDir&gt;\agent <strong>(※1)</strong> </p></blockquote><p><strong>(※1)</strong> 全量いただけることが望ましいですが、全量が困難な場合は下記をご提供ください。   </p><blockquote><p>&lt;Mobility service agent InstallDir&gt;\agent\<br> - AzureRcmCli.log<br> - evtcollforw.log<br> - s2*.log<br> - svagent*.log<br> - vacp.log<br> - Application Data\ApplicationPolicyLogs<br> - vxlogs  </p></blockquote><p><u>&lt; ソース マシン (Linux) &gt;</u></p><blockquote><p>/tmp/MobilityAgentAutoUpgrade/logs/ua_upgrader.log<br>/var/log/ <strong>(※1)</strong></p></blockquote><p><strong>(※1)</strong> 全量いただけることが望ましいですが、全量が困難な場合は下記をご提供ください。  </p><blockquote><p>/var/log/<br> - ApplicationPolicyLogs/vacp.log<br> - appservice*.log<br> - AzureRcmCli.log<br> - cdpcli.log<br> - evtcollforw.log<br> - InMage*.log<br> - InstallerError.json<br> - involflt*.log<br> - s2*.log<br> - svagent*.log<br> - tagTelemetry_*.log<br> - ua_install.log<br> - uarespawnd.log<br> - Waagent.log<br> - azure<br> - vxlogs<br> - ApplicationData<br> - ASRsetuptelemetry  </p></blockquote><h3 id="2-4-Hyper-V-to-Azure-シナリオの障害調査に必要なログ"><a href="#2-4-Hyper-V-to-Azure-シナリオの障害調査に必要なログ" class="headerlink" title=" 2-4. Hyper-V to Azure シナリオの障害調査に必要なログ"></a><a id="2-4"></a> 2-4. Hyper-V to Azure シナリオの障害調査に必要なログ</h3><p>本シナリオではログを収集する方法は手動収集のみとなります。</p><p><u>&lt; Hyper-V ホスト マシン &gt;</u>  </p><blockquote><p>C:\ProgramData\ASRLogs<br>C:\WindowsAzure\Logs<br>C:\Windows\System32\winevt\logs<br>C:\Program Files\Microsoft Azure Recovery Services Agent\Temp </p></blockquote><p><u>&lt; Hyper-V ゲスト マシン &gt;</u><br>収集が必要なログはございません。</p><h2 id="3-ログ収集ツールの使用方法"><a href="#3-ログ収集ツールの使用方法" class="headerlink" title=" 3. ログ収集ツールの使用方法"></a><a id="3"></a> 3. ログ収集ツールの使用方法</h2><h3 id="3-1-ASRDiagnosticTool-の使用方法"><a href="#3-1-ASRDiagnosticTool-の使用方法" class="headerlink" title=" 3-1. ASRDiagnosticTool の使用方法"></a><a id="3-1"></a> 3-1. ASRDiagnosticTool の使用方法</h3><p>ログ収集対象マシンが <strong>Windows マシン</strong> である場合、本ツールを利用して下記シナリオのログを収集できます。</p><ul><li>Azure to Azure</li><li>VMware to Azure</li><li>物理マシン to Azure</li></ul><p>ASRDiagnosticTool  を利用する前に、下記の各要件を満たしていることを確認してください。</p><ul><li>ツールを実行するマシンに .NET Framework 4.6.2 以上がインストールされていること<br>（参考）方法: インストールされている .NET Framework バージョンを確認する<br><a href="https://learn.microsoft.com/ja-jp/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed#net-framework-45-and-later-versions">https://learn.microsoft.com/ja-jp/dotnet/framework/migration-guide/how-to-determine-which-versions-are-installed#net-framework-45-and-later-versions</a></li><li>C:\ ドライブにログを収集するための空き容量があること</li></ul><p>下記の手順に沿って、<br><span style="color: red; ">「構成サーバーとして機能するマシン (クラシック)」 または 「ASR レプリケーション アプライアンス として機能するマシン (モダン化)」 と</span><br><span style="color: red; ">「ソース マシン (保護対象マシン)」 の 2 つから、</span><br>それぞれにて本ツールを実行してログをご収集ください。</p><h4 id="ステップ-1"><a href="#ステップ-1" class="headerlink" title="ステップ 1 :"></a>ステップ 1 :</h4><p>対象の VM にサインインします。</p><h4 id="ステップ-2"><a href="#ステップ-2" class="headerlink" title="ステップ 2 :"></a>ステップ 2 :</h4><p>構成サーバー (クラシック) または ASR レプリケーション アプライアンス (モダン化) とソース マシンの下記ディレクトリに、 ASRDiagnosticTool  が配置されているか確認します。</p><ul><li>構成サーバー (クラシック) : <code>&lt;Cache InstallDir&gt;\agent\ASRDiagnosticTool</code></li><li>ASR レプリケーション アプライアンス  (モダン化)  : <code>&lt;Cache InstallDir&gt;\ProgramData\Microsoft Azure\Tools\ASRDiagnosticTool</code></li><li>ソース マシン : <code>C:\Program Files (x86)\Microsoft Azure Site Recovery\agent\ASRDiagnosticTool</code></li></ul><p>配置されていない場合は下記の手順に従って配置します。  </p><ol><li><a href="https://aka.ms/ASRDiagnosticTool">https://aka.ms/ASRDiagnosticTool</a> から ASRDiagnosticTool.zip ファイルをダウンロードします。</li><li>zip ファイルを解凍し、ログを取得したいマシン上に配置します。</li></ol><h4 id="ステップ-3"><a href="#ステップ-3" class="headerlink" title="ステップ 3 :"></a>ステップ 3 :</h4><p>(ソース マシン (保護対象マシン) 上でツールを実行する場合はスキップください)   </p><p>構成サーバー (クラシック) または ASR レプリケーション アプライアンス (モダン化) のキャッシュ ドライブのインストール先が E ドライブ以外の場合は、下記の設定変更を行います。  </p><ol><li><code>&lt;ASRDiagnosticToolのインストール先&gt;\ASRDiagnosticTool\Config</code> に移動し、ApplianceLogs.json ファイルを開きます。</li><li><code>E:\</code> となっているすべての文字列を検索し、構成サーバーのキャッシュ ドライブのインストール先に変更します。<br> 例えば、<code>M:\</code> ドライブにインストールしている場合は、<code>E:\\MarsAgent\\logs</code> を <code>M:\\MarsAgent\\logs</code> に変更します。</li></ol><h4 id="ステップ-4"><a href="#ステップ-4" class="headerlink" title="ステップ 4 :"></a>ステップ 4 :</h4><p>下記手順に従って ASRDiagnosticTool を実行します。</p><ol><li>管理者モードでコマンド プロンプトを開きます。</li><li>次のコマンドで ASRDiagnosticTool  の配置先に移動します。<br> ※ <code>&lt;ASRDiagnosticToolのインストール先&gt;</code> はインストール先のディレクトリに書き換えてください。　   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cd &quot;&lt;ASRDiagnosticToolのインストール先&gt;\ASRDiagnosticTool&quot;</span><br></pre></td></tr></table></figure></li><li>次のコマンドで ASRDiagnosticTool  を実行します。 (完了まで5 ~ 30 分 かかります。また、かかる時間は実行している環境によって異なります) <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ASRDiagnosticTool.exe</span><br></pre></td></tr></table></figure></li></ol><p>(実行例)<br><img src="https://github.com/user-attachments/assets/a0c74364-8566-49a2-b8a7-be6efe9cf247"></p><h4 id="ステップ-5"><a href="#ステップ-5" class="headerlink" title="ステップ 5 :"></a>ステップ 5 :</h4><p>コマンド プロンプトに下記のようなメッセージが表示されていれば、ログの収集成功となります。<br><code>Please collect the archive at</code> に圧縮されたログが生成されますので、本ログをご提供いただけますと幸いです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Log collection completed successfully.</span><br><span class="line">Please collect the archive at C:\Users\Administrator\AppData\Roaming\ASRDiagnosticLogs-WIN-C381N1BJK2T-25-07-15-14-57.zip.</span><br></pre></td></tr></table></figure><h4 id="ツール利用時の影響について"><a href="#ツール利用時の影響について" class="headerlink" title="ツール利用時の影響について"></a>ツール利用時の影響について</h4><p>当ツールは、単純なログ収集ツールとなっております。これまで「高負荷となった」、「サーバーのリブート」や「特定のサービスが再起動する」といった事例の報告はございません。  </p><p>実際に CPU/メモリがどれくらい消費されるか・ログファイル量は、お客様の環境に依存しますので明確な指標をお出しすることは難しくございますが、弊社検証環境 (Azure 仮想マシン (Standard D8as v5 (8 vcpu 数、32 GiB メモリ))) で当該スクリプトを実行した場合、<span style="color: green; "><strong>ツール実行～終了までのおよそ 3 分 20 秒間</strong></span>では下記結果となり、「非常に大きな負荷がかかった」等の数値は確認しておりません。<br>しかしながら、こちらの結果はあくまでも弊社環境での検証となりますため、必要に応じてお客様ご自身の環境にて検証いただきますようお願い申し上げます。</p><details><summary>ツール利用時のパフォーマンス検証結果</summary><p>下記表は <code>パフォーマンス モニター</code> を使ったパフォーマンスの検証結果となります。</p><table><thead><tr><th align="left">-</th><th align="left">CPU</th><th align="left">-</th><th align="left">-</th><th align="left">-</th><th align="left">Disk</th><th align="left">-</th><th align="left">-</th><th align="left">-</th><th align="left">Memory</th><th align="left">-</th><th align="left">-</th><th align="left">-</th></tr></thead><tbody><tr><td align="left">Time</td><td align="left"><strong>Processor Time</strong></td><td align="left"><strong>User Time</strong></td><td align="left"><strong>Privileged Time</strong></td><td align="left"><strong>Interrupt Time</strong></td><td align="left"><strong>Disk Time</strong></td><td align="left"><strong>Current Disk Queue Length</strong></td><td align="left"><strong>Avg. Disk sec/Write</strong></td><td align="left"><strong>Avg. Disk sec/Read</strong></td><td align="left"><strong>Available MBytes</strong></td><td align="left"><strong>Pages/sec</strong></td><td align="left"><strong>Committed Bytes In Use</strong></td><td align="left"><strong>Committed Bytes</strong></td></tr><tr><td align="left">08/05/2024 19:56:22</td><td align="left"></td><td align="left"></td><td align="left"></td><td align="left"></td><td align="left"></td><td align="left">0</td><td align="left"></td><td align="left"></td><td align="left">29303</td><td align="left"></td><td align="left">8.95</td><td align="left">3533012992</td></tr><tr><td align="left">08/05/2024 19:56:52</td><td align="left">0.05</td><td align="left">0.03</td><td align="left">0.03</td><td align="left">0.00</td><td align="left">0.14</td><td align="left">0</td><td align="left">0.00</td><td align="left">0.01</td><td align="left">29303</td><td align="left">2.80</td><td align="left">8.94</td><td align="left">3528171520</td></tr><tr><td align="left">08/05/2024 19:57:22</td><td align="left">3.95</td><td align="left">2.41</td><td align="left">1.51</td><td align="left">0.01</td><td align="left">0.14</td><td align="left">0</td><td align="left">0.00</td><td align="left">0.01</td><td align="left">29312</td><td align="left">0.73</td><td align="left">8.97</td><td align="left">3538006016</td></tr><tr><td align="left">08/05/2024 19:57:52</td><td align="left">0.60</td><td align="left">0.27</td><td align="left">0.30</td><td align="left">0.01</td><td align="left">0.19</td><td align="left">0</td><td align="left">0.00</td><td align="left">0.01</td><td align="left">29236</td><td align="left">1.20</td><td align="left">9.23</td><td align="left">3641659392</td></tr><tr><td align="left">08/05/2024 19:58:22</td><td align="left">0.13</td><td align="left">0.08</td><td align="left">0.04</td><td align="left">0.00</td><td align="left">0.10</td><td align="left">0</td><td align="left">0.00</td><td align="left">0.00</td><td align="left">29241</td><td align="left">0.13</td><td align="left">9.22</td><td align="left">3636760576</td></tr><tr><td align="left">08/05/2024 19:58:52</td><td align="left">0.90</td><td align="left">0.30</td><td align="left">0.57</td><td align="left">0.00</td><td align="left">32.52</td><td align="left">1</td><td align="left">0.00</td><td align="left">0.01</td><td align="left">28870</td><td align="left">0.13</td><td align="left">10.13</td><td align="left">3995738112</td></tr><tr><td align="left">08/05/2024 19:59:22</td><td align="left">0.96</td><td align="left">0.38</td><td align="left">0.59</td><td align="left">0.03</td><td align="left">33.07</td><td align="left">1</td><td align="left">0.00</td><td align="left">0.01</td><td align="left">28541</td><td align="left">0.13</td><td align="left">10.98</td><td align="left">4331937792</td></tr><tr><td align="left">08/05/2024 19:59:52</td><td align="left">4.94</td><td align="left">3.35</td><td align="left">1.55</td><td align="left">0.00</td><td align="left">29.31</td><td align="left">1</td><td align="left">0.00</td><td align="left">0.01</td><td align="left">29189</td><td align="left">350.56</td><td align="left">9.23</td><td align="left">3644022784</td></tr><tr><td align="left">08/05/2024 20:00:22</td><td align="left">28.85</td><td align="left">24.40</td><td align="left">4.45</td><td align="left">0.04</td><td align="left">39.55</td><td align="left">10</td><td align="left">0.05</td><td align="left">0.00</td><td align="left">29083</td><td align="left">34.47</td><td align="left">9.20</td><td align="left">3631489024</td></tr><tr><td align="left">08/05/2024 20:00:52</td><td align="left">2.01</td><td align="left">1.24</td><td align="left">0.74</td><td align="left">0.00</td><td align="left">55.49</td><td align="left">0</td><td align="left">0.02</td><td align="left">0.00</td><td align="left">29232</td><td align="left">38.91</td><td align="left">8.99</td><td align="left">3547832320</td></tr><tr><td align="left">08/05/2024 20:01:22</td><td align="left">0.04</td><td align="left">0.05</td><td align="left">0.04</td><td align="left">0.00</td><td align="left">0.07</td><td align="left">0</td><td align="left">0.00</td><td align="left">0.00</td><td align="left">29236</td><td align="left">0.13</td><td align="left">8.98</td><td align="left">3544920064</td></tr><tr><td align="left">08/05/2024 20:01:52</td><td align="left">0.12</td><td align="left">0.04</td><td align="left">0.01</td><td align="left">0.00</td><td align="left">0.09</td><td align="left">0</td><td align="left">0.00</td><td align="left">0.00</td><td align="left">29236</td><td align="left">0.13</td><td align="left">8.98</td><td align="left">3542532096</td></tr></tbody></table></details><h3 id="3-2-collect-support-materials-の使用方法"><a href="#3-2-collect-support-materials-の使用方法" class="headerlink" title=" 3-2. collect_support_materials の使用方法"></a><a id="3-2"></a> 3-2. collect_support_materials の使用方法</h3><p>ログ収集対象マシンが <strong>Linux マシン</strong> である場合、本ツールを利用して下記シナリオのログを収集できます。</p><ul><li>Azure to Azure</li><li>VMware to Azure</li><li>物理マシン to Azure</li></ul><p>下記の手順にそって本ツールを実行して、ログを収集してください。</p><h4 id="ステップ-1-1"><a href="#ステップ-1-1" class="headerlink" title="ステップ 1 :"></a>ステップ 1 :</h4><p>対象の VM にサインインします。</p><h4 id="ステップ-2-1"><a href="#ステップ-2-1" class="headerlink" title="ステップ 2 :"></a>ステップ 2 :</h4><p>スクリプト <code>/usr/local/ASR/Vx/bin/collect_support_materials.sh</code> を管理者権限で実行します</p><h4 id="ステップ-3-1"><a href="#ステップ-3-1" class="headerlink" title="ステップ 3 :"></a>ステップ 3 :</h4><p>以下のように出力されますので、<code>support store location</code> の <code>free space</code> が十分であることをご確認いただき、<code>Y</code> または <code>y</code> を入力してください。  </p><p>(出力例)<br><img src="https://github.com/user-attachments/assets/50ab3587-7945-4d7a-8465-60183c850a4b"></p><h4 id="ステップ-4-1"><a href="#ステップ-4-1" class="headerlink" title="ステップ 4 :"></a>ステップ 4 :</h4><p>上記 <code>support store location</code> に圧縮されたログが生成されますので、本ログをご提供いただけますと幸いです。</p><h4 id="ツール利用時の影響について-1"><a href="#ツール利用時の影響について-1" class="headerlink" title="ツール利用時の影響について"></a>ツール利用時の影響について</h4><p>当ツールは、単純なログ収集ツールとなっております。これまで「高負荷となった」、「サーバーのリブート」や「特定のサービスが再起動する」といった事例の報告はございません。<br>出力されるログファイルの量は環境毎、およびシナリオ毎で異なりますが、弊社検証環境での動作確認ではログ ファイルのサイズは 700 KB 程度でございました。</p><p>実際に CPU/メモリがどれくらい消費されるかは、お客様の環境に依存しますので明確な指標をお出しすることは難しくございますが、弊社検証環境 (Azure 仮想マシン (Standard D8as v5 (8 vcpu 数、32 GiB メモリ))) で当該スクリプトを実行した場合、<span style="color: green; "><strong>スクリプト実行～終了までのおよそ 20 秒間</strong></span>では下記結果となり、「非常に大きな負荷がかかった」 等の数値は確認しておりません。<br>しかしながら、こちらの結果はあくまでも弊社環境での検証となりますため、必要に応じてお客様ご自身の環境にて検証いただきますようお願い申し上げます。</p><details><summary>ツール利用時のパフォーマンス検証結果</summary><p>下記表は <code>vmstat</code> コマンドを使ったパフォーマンスの検証結果となります。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vmstat 5 | awk &#x27;&#123; print strftime(&quot;%Y/%m/%d %H:%M:%S&quot;), $0 &#125;&#x27;</span><br></pre></td></tr></table></figure><table><thead><tr><th align="left">-</th><th align="left">procs</th><th align="left">-</th><th align="left">memory</th><th align="left">-</th><th align="left">-</th><th align="left">-</th><th align="left">swap</th><th align="left">-</th><th align="left">io</th><th align="left">-</th><th align="left">system</th><th align="left">-</th><th align="left">cpu</th><th align="left">-</th><th align="left">-</th><th align="left">-</th><th align="left">-</th></tr></thead><tbody><tr><td align="left"><strong>Time</strong></td><td align="left"><strong>r</strong></td><td align="left"><strong>b</strong></td><td align="left"><strong>swpd</strong></td><td align="left"><strong>free</strong></td><td align="left"><strong>buff</strong></td><td align="left"><strong>cache</strong></td><td align="left"><strong>si</strong></td><td align="left"><strong>so</strong></td><td align="left"><strong>bi</strong></td><td align="left"><strong>bo</strong></td><td align="left"><strong>in</strong></td><td align="left"><strong>cs</strong></td><td align="left"><strong>us</strong></td><td align="left"><strong>sy</strong></td><td align="left"><strong>id</strong></td><td align="left"><strong>wa</strong></td><td align="left"><strong>st</strong></td></tr><tr><td align="left">2024/6/3 8:38:04</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">459724</td><td align="left">4184</td><td align="left">15316156</td><td align="left">0</td><td align="left">0</td><td align="left">2544</td><td align="left">1481</td><td align="left">308</td><td align="left">811</td><td align="left">5</td><td align="left">1</td><td align="left">72</td><td align="left">22</td><td align="left">0</td></tr><tr><td align="left">2024/6/3 8:38:09</td><td align="left">0</td><td align="left">2</td><td align="left">0</td><td align="left">524152</td><td align="left">4184</td><td align="left">15248072</td><td align="left">0</td><td align="left">0</td><td align="left">21636</td><td align="left">5809</td><td align="left">2451</td><td align="left">6335</td><td align="left">2</td><td align="left">1</td><td align="left">79</td><td align="left">19</td><td align="left">0</td></tr><tr><td align="left">2024/6/3 8:38:14</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">511444</td><td align="left">4184</td><td align="left">15260096</td><td align="left">0</td><td align="left">0</td><td align="left">18309</td><td align="left">67</td><td align="left">2960</td><td align="left">7064</td><td align="left">1</td><td align="left">1</td><td align="left">89</td><td align="left">9</td><td align="left">0</td></tr><tr><td align="left">2024/6/3 8:38:19</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">495660</td><td align="left">4184</td><td align="left">15271268</td><td align="left">0</td><td align="left">0</td><td align="left">17027</td><td align="left">328</td><td align="left">2542</td><td align="left">6767</td><td align="left">2</td><td align="left">1</td><td align="left">89</td><td align="left">9</td><td align="left">0</td></tr><tr><td align="left">2024/6/3 8:38:24</td><td align="left">1</td><td align="left">1</td><td align="left">0</td><td align="left">448740</td><td align="left">4184</td><td align="left">15311520</td><td align="left">0</td><td align="left">0</td><td align="left">29925</td><td align="left">115</td><td align="left">6789</td><td align="left">13947</td><td align="left">7</td><td align="left">2</td><td align="left">79</td><td align="left">12</td><td align="left">0</td></tr><tr><td align="left"><span style="color: green; ">2024/6/3 8:38:29</td><td align="left">5</td><td align="left">3</td><td align="left">0</td><td align="left">374476</td><td align="left">4184</td><td align="left">15384444</td><td align="left">0</td><td align="left">0</td><td align="left">36440</td><td align="left">73</td><td align="left">9115</td><td align="left">18576</td><td align="left">12</td><td align="left">2</td><td align="left">76</td><td align="left">9</td><td align="left">0</td></tr><tr><td align="left"><span style="color: green; ">2024/6/3 8:38:34</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">413664</td><td align="left">4184</td><td align="left">15346216</td><td align="left">0</td><td align="left">0</td><td align="left">29338</td><td align="left">588</td><td align="left">3365</td><td align="left">6832</td><td align="left">1</td><td align="left">1</td><td align="left">88</td><td align="left">10</td><td align="left">0</td></tr><tr><td align="left"><span style="color: green; ">2024/6/3 8:38:39</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">394872</td><td align="left">4184</td><td align="left">15364684</td><td align="left">0</td><td align="left">0</td><td align="left">25054</td><td align="left">3479</td><td align="left">3219</td><td align="left">6826</td><td align="left">2</td><td align="left">1</td><td align="left">78</td><td align="left">19</td><td align="left">0</td></tr><tr><td align="left"><span style="color: green; ">2024/6/3 8:38:44</td><td align="left">0</td><td align="left">1</td><td align="left">0</td><td align="left">376320</td><td align="left">4184</td><td align="left">15383056</td><td align="left">0</td><td align="left">0</td><td align="left">43755</td><td align="left">75</td><td align="left">4825</td><td align="left">7378</td><td align="left">2</td><td align="left">1</td><td align="left">88</td><td align="left">9</td><td align="left">0</td></tr><tr><td align="left"><span style="color: green; ">2024/6/3 8:38:49</td><td align="left">0</td><td align="left">2</td><td align="left">0</td><td align="left">331164</td><td align="left">4184</td><td align="left">15416172</td><td align="left">0</td><td align="left">0</td><td align="left">43115</td><td align="left">332</td><td align="left">4878</td><td align="left">7463</td><td align="left">3</td><td align="left">1</td><td align="left">82</td><td align="left">13</td><td align="left">0</td></tr></tbody></table></details>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Site Recovery サポートです。&lt;br&gt;Azure Site Recovery (以下、ASR ) に関する調査をスムーズに進める為に、お客様側で確認して頂く箇所と、調査に必要な環境情報と</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure Site Recovery" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Site-Recovery/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup を意図的に失敗させる方法</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/</id>
    <published>2024-08-08T03:00:00.000Z</published>
    <updated>2024-08-27T06:06:49.065Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>アラートのテスト等のため “Azure VM Backup を失敗させたい” というお問い合わせをよくいただきます。<br>今回は、<strong>Azure VM Backup を意図的に失敗させる方法</strong>について、ご案内いたします。</p><p>(その他ブログで公開している Azure Backup の失敗方法)<br>・Azure VM Backup のデータ転送フェーズを意図的に失敗させる方法<br>　<a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_ttv/">https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_ttv/</a></p><p>・MARS バックアップ を意図的に失敗させる方法<br>　<a href="https://jpabrs-scem.github.io/blog/MARSBackup/How_to_fail_MARS_backup/">https://jpabrs-scem.github.io/blog/MARSBackup/How_to_fail_MARS_backup/</a></p><p>・Azure Files Backup を意図的に失敗させる方法<br>　<a href="https://jpabrs-scem.github.io/blog/AzureFilesBackup/How_to_fail_AFS_backup/">https://jpabrs-scem.github.io/blog/AzureFilesBackup/How_to_fail_AFS_backup/</a></p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Azure Guest Agent を停止して意図的にAzure VM Backup エラーを発生させる仕組み</a><br><a href="#2">2. Azure Guest Agent を停止してバックアップを故意に失敗させる方法 (手順概略) </a><br><a href="#3">3. バックアップを故意に失敗させる方法 (Windows VM の場合)</a><br>  <a href="#3-1">【補足】 Windows Firewall を用いた方法</a><br><a href="#4">4. バックアップを故意に失敗させる方法 (Linux VM の場合)</a><br><a href="#5">5. バックアップを故意に失敗させる方法 (共有ディスクをアタッチする)</a></p><hr><h2 id="1-Azure-Guest-Agent-を停止して意図的にAzure-VM-Backup-エラーを発生させる仕組み"><a href="#1-Azure-Guest-Agent-を停止して意図的にAzure-VM-Backup-エラーを発生させる仕組み" class="headerlink" title="1. Azure Guest Agent を停止して意図的にAzure VM Backup エラーを発生させる仕組み "></a>1. Azure Guest Agent を停止して意図的にAzure VM Backup エラーを発生させる仕組み <a id="1"></a></h2><p>VM 内の Windows Azure Guest Agent (VM agent) が停止させ、Azure 側の Recovery Services コンテナー (Azure Backup service) との通信ができない状態を作ります。<br>この状態で Backup 取得をしようとすると、VM agent と通信できないためにエラー (Error Code ”UserErrorGuestAgentStatusUnavailable”) が発生し、Backup が失敗となります。<br><img src="https://user-images.githubusercontent.com/71251920/142736316-5995d329-63d1-4b63-acd5-7f3da9f90cf9.png" alt="How_to_Backup_Fail"></p><p>*VM 電源状態 がオンライン状態でなければこの方法は使えません。オフライン状態では成功してしまいます。そのため、必ずオンライン (電源起動) 状態でご実施ください。<br>下記ご参考になれば幸いです。<br>・Azure VM Backup では オフライン バックアップができるのか<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Azure_VM_Offline_backup/">https://jpabrs-scem.github.io/blog/AzureVMBackup/Azure_VM_Offline_backup/</a></p><div class="alert is-warning"><p class="alert-title">警告</p><p>VM agent を停止させる方法は標準 (Standard) ポリシーでバックアップ保護されている VM のみ有効となります。</p><p>もし拡張 (Enhanced) ポリシーで保護されている VM で意図的に VM バックアップを失敗させる場合は <a href="#5">5. バックアップを故意に失敗させる方法 (共有ディスクをアタッチする)</a>をご参照ください。</p></div><h2 id="2-Azure-Guest-Agent-を停止してバックアップを故意に失敗させる方法-手順概略"><a href="#2-Azure-Guest-Agent-を停止してバックアップを故意に失敗させる方法-手順概略" class="headerlink" title="2. Azure Guest Agent を停止してバックアップを故意に失敗させる方法 (手順概略) "></a>2. Azure Guest Agent を停止してバックアップを故意に失敗させる方法 (手順概略) <a id="2"></a></h2><p>・「バックアップを故意に失敗させる方法 (Windows VM の場合) 」</p><blockquote><p>   1.Backup 対象の VM にリモート ログイン<br>   2.Services 内で “RdAgent” と “Windows Azure Guest Agent” の停止、スタートアップの無効化<br>   3.Backup を実施し、エラーの確認<br>   4.Agent の再度起動</p></blockquote><p>・「バックアップを故意に失敗させる方法 (Linux VM の場合) 」</p><blockquote><p>   1.Backup 対象の VM に SSH 接続<br>   2.Agent の停止、および自動起動停止<br>   3.Agent の Service を停止<br>   　（Ubuntu の場合）<code> </code> <code>sudo systemctl stop walinuxagent </code> <code> </code><br>   　（Ubuntu 以外の場合）<code> </code> <code>sudo systemctl stop waagent</code> <code> </code><br>   4.自動起動を停止<br>   　（Ubuntu の場合）<code> </code> <code>sudo systemctl disable walinuxagent </code> <code> </code><br>   　（Ubuntu 以外の場合）<code> </code> <code>sudo systemctl disable waagent</code> <code> </code><br>   5.Backup を実行し、エラーの確認<br>   ・Agent の再起動<br>   （Ubuntu の場合）<br>   　　<code> </code> <code>sudo systemctl start walinuxagent </code> <code> </code><br>       　　<code> </code> <code>sudo systemctl enable walinuxagent </code> <code> </code><br>       　　<code> </code> <code>systemctl status walinuxagent </code> <code> </code><br>       （Ubuntu 以外の場合）<br>       　　<code> </code> <code>sudo systemctl start waagent</code> <code> </code><br>       　　<code> </code> <code>sudo systemctl enable waagent</code> <code> </code><br>   　  　<code> </code> <code>systemctl status waagent</code> <code> </code></p></blockquote><h2 id="3-バックアップを故意に失敗させる方法-Windows-VM-の場合-所要時間-2時間～6時間"><a href="#3-バックアップを故意に失敗させる方法-Windows-VM-の場合-所要時間-2時間～6時間" class="headerlink" title="3. バックアップを故意に失敗させる方法 (Windows VM の場合)  (所要時間 : 2時間～6時間)"></a>3. バックアップを故意に失敗させる方法 (Windows VM の場合)  (所要時間 : 2時間～6時間)<a id="3"></a></h2><h3 id="3-1-環境"><a href="#3-1-環境" class="headerlink" title="3.1. 環境"></a>3.1. 環境</h3><p>本項目では以下の環境で検証を実施しております。<br>VM名 : vm-BackupFailTest-win2016<br>OS : Windows (Windows Server 2016 Datacenter) Version 1607<br>Recovery Service コンテナー名 : vault-BackupFailTest<br>VM 電源状態 : オンライン (起動状態)</p><h3 id="3-2-手順概略"><a href="#3-2-手順概略" class="headerlink" title="3.2.手順概略"></a>3.2.手順概略</h3><p>“サービス” から プロセス “RdAgent”、”Windows Azure Guest Agent” を停止し、スタートアップを無効化しバックアップを実行します。<br>バックアップが失敗したらそれぞれをもとに戻します。</p><blockquote><ol><li>Backup 対象の VM にリモート ログイン</li><li>Services 内で “RbAgent” と “Windows Azure Guest Agent” の停止、スタートアップを無効化</li><li>Portal にて Backup を実施し、エラーの確認</li><li>Agent の再起動</li></ol></blockquote><h3 id="3-3-詳細手順"><a href="#3-3-詳細手順" class="headerlink" title="3.3.詳細手順"></a>3.3.詳細手順</h3><p>Backup 対象の VM : Azure portal上で作成した、Backup 対象の VM<br>Backup 対象の VM にリモートログインし、Services を開き、下記 2 つのサービスに対し設定を行います。</p><h4 id="RdAgent"><a href="#RdAgent" class="headerlink" title="RdAgent"></a>RdAgent</h4><p>最初に “RdAgent” を停止、スタートアップ無効にします。<br>・Sercives 一覧の画面で “RdAgent” を右クリック → “Properties” を選択します。<br>・Startup type で “Disabled” を選択 → Service status で Stop を選択 → Service 停止プロセスが完了した後、”OK” を選択します。<br>・Services 一覧の画面にて、 RbAgent の Status の Running が消えており、Startup Type が Disabled 場合、 RbAgent の停止が完了となります。</p><p><img src="https://user-images.githubusercontent.com/71251920/142736495-97875c34-577f-483d-a46e-c1f7c53d5133.png" alt="RdAgent"></p><h4 id="Windows-Azure-Guest-Agent"><a href="#Windows-Azure-Guest-Agent" class="headerlink" title="Windows Azure Guest Agent"></a>Windows Azure Guest Agent</h4><p>次に “Windows Azure Guest Agent” を停止、スタートアップ無効にします。<br>・Sercives 一覧の画面で “Windows Azure Guest Agent” を右クリック → “Properties” を選択します。<br>・Startup type で “Disabled” を選択 → Service status で Stop を選択 → Service 停止プロセスが完了した後、 “OK” を選択します。<br>・Services 一覧の画面にて、 Windows Azure Guest Agent の Status の Running が消えており、Startup Type が Disabled 場合、 Windows Azure Guest Agent の停止が完了となります。</p><p><img src="https://user-images.githubusercontent.com/71251920/142736485-37260305-e959-4d30-ab6d-d2167dc8096c.png" alt="WindowsAzureGuestAgent"></p><p>以上で、VM 側の設定は完了となります。</p><h4 id="Backup-を実施し、エラーの確認"><a href="#Backup-を実施し、エラーの確認" class="headerlink" title="Backup を実施し、エラーの確認"></a>Backup を実施し、エラーの確認</h4><p>・Azure portal を開いていただき、VM のページに移動 → “バックアップ” を選択 → “今すぐパックアップ” を選択。<br>この操作により、バックアップが開始されます。<br>・ 次に Backup の状態を確認します。<br>　Recovery Services コンテナーのページへ移動 → “バックアップ ジョブ” を選択後、最新の Backup の “View details” を選択します。<br>このページで Backup の状態を確認することができます。<br>結果が表示されるまで数時間掛かりますので、 定期的に (1 時間おきなど) 更新して確認することをお勧めいたします。</p><p><img src="https://user-images.githubusercontent.com/71251920/142736544-cc800afd-14c5-400d-9b9c-74d535fdf1f4.png" alt="FailCheck_01"></p><p>・Take Snapshot の Status が Failed 、Error Code <strong>”UserErrorGuestAgentStatusUnavailable”</strong> となり、失敗し完了となります。本環境では 5 時間 25 分かかりました。　</p><p><img src="https://user-images.githubusercontent.com/71251920/142736548-c5cc94e5-4343-4c81-9b8b-52ef8c46f4d8.png" alt="FailCheck_02"></p><h4 id="Agentの再起動"><a href="#Agentの再起動" class="headerlink" title="Agentの再起動"></a>Agentの再起動</h4><p>・エラーの発生確認完了後は、 VM に再度ログインして頂き、各 Agent の Service properties 画面で、Start up type を <strong>“Automatic”</strong> に、Service Status で <strong>“Start”</strong> を選択し、 Agent を再度起動させてください。</p><h2 id="【補足】-Windows-Firewall-を用いた方法"><a href="#【補足】-Windows-Firewall-を用いた方法" class="headerlink" title="【補足】 Windows Firewall を用いた方法 "></a>【補足】 Windows Firewall を用いた方法 <a id="3-1"></a></h2><p>なお、Windows 内部 のローカルファイアウォールから 宛先 168.63.129.16 宛の通信をブロックしていただくことでも同様にエラーを発生させることが可能です。</p><blockquote><p>リモートアドレス (宛先 IP) :  168.63.129.16<br>操作 : ブロック<br>上記以外はすべて 任意 </p></blockquote><p>Windows Server　2016 をご利用の場合は虫眼鏡窓から “Firewall” と検索いただくことで設定可能です。<br><img src="https://user-images.githubusercontent.com/71251920/158552820-74147994-3072-4ee8-ae17-c6b92f9b7e36.png" alt="WindowsFW_01"></p><p>下記例ではすでに、”Block 168.63.129.16” という規則を作成した後の画面ショットです。<br>設定内容は上述の通りでございます。送信の規則 → 新しい規則 から設定ください。<br><img src="https://user-images.githubusercontent.com/71251920/158552815-e3b99fb6-78ec-4c3e-ba4e-616777a25e03.png" alt="WindowsFW_02"></p><p>なお、 168.63.129.16 への通信は特殊な通信のため、NSG では制御することができません。<br>下記ご参考にしてくだされば幸いです。<br>・1. Azure VM Backup の 通信要件について - Azure VM Backup の通信要件や処理の流れについて<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#1">https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#1</a></p><h2 id="4．バックアップを故意に失敗させる方法-Linux-VM-の場合-所要時間-2時間～6時間"><a href="#4．バックアップを故意に失敗させる方法-Linux-VM-の場合-所要時間-2時間～6時間" class="headerlink" title="4．バックアップを故意に失敗させる方法 (Linux VM の場合) (所要時間 : 2時間～6時間) "></a>4．バックアップを故意に失敗させる方法 (Linux VM の場合) (所要時間 : 2時間～6時間) <a id="4"></a></h2><h3 id="4-1-環境"><a href="#4-1-環境" class="headerlink" title="4.1. 環境"></a>4.1. 環境</h3><p>本項目では以下の環境で検証を実施しております。</p><h4 id="OS"><a href="#OS" class="headerlink" title="OS"></a>OS</h4><blockquote><p>VM名 : vm-BackupFailTest-linux-suse / OS : Linux (sles 15.2)<br>VM 名 : vm-BackupFailTest-linux-rhel / OS : Linux (redhat 8.2)<br>VM 名 : vm-BackupFailTest-linux-ubuntu /OS : Linux (ubuntu 20.04)<br>VM 名 : vm-BackupFailTest-linux-centos / OS : Linux (centos 7.9.2009)</p></blockquote><h4 id="Recovery-Services-コンテナー"><a href="#Recovery-Services-コンテナー" class="headerlink" title="Recovery Services コンテナー"></a>Recovery Services コンテナー</h4><blockquote><p>Recovery Service コンテナー名 : vault-BackupFailTest</p></blockquote><h3 id="4-2-手順概略"><a href="#4-2-手順概略" class="headerlink" title="4.2. 手順概略"></a>4.2. 手順概略</h3><p>下記コマンドを実行しagent プロセスを停止しバックアップを失敗させます。<br>失敗したのを確認したのち、Agent の再起動を行います。</p><h4 id="Agent-の停止"><a href="#Agent-の停止" class="headerlink" title="Agent の停止"></a>Agent の停止</h4><blockquote><p>Backup 対象の VM に SSH 接続します。</p></blockquote><blockquote><p>・以下のコマンドで、 Agent の Service を停止します。<br>（Ubuntu の場合）sudo systemctl stop walinuxagent<br>（Ubuntu 以外の場合）sudo systemctl stop waagent</p></blockquote><blockquote><p>・以下のコマンドで、自動起動を停止します。<br>（Ubuntu の場合）sudo systemctl disable walinuxagent<br>（Ubuntu 以外の場合）sudo systemctl disable waagent</p></blockquote><h4 id="Agent-の再起動"><a href="#Agent-の再起動" class="headerlink" title="Agent の再起動"></a>Agent の再起動</h4><p>バックアップ エラーの検証後は、以下コマンドで waagent を再開します。</p><blockquote><p>（Ubuntu の場合）<br>    sudo systemctl start walinuxagent<br>    sudo systemctl enable walinuxagent<br>    systemctl status walinuxagent<br>（Ubuntu 以外の場合）<br>    sudo systemctl start waagent<br>    sudo systemctl enable waagent<br>    systemctl status waagent</p></blockquote><h3 id="4-3-詳細手順"><a href="#4-3-詳細手順" class="headerlink" title="4.3. 詳細手順"></a>4.3. 詳細手順</h3><p>Linux の場合、 OS により Agent のプロセス名が異なります。</p><h4 id="Agent-プロセス名"><a href="#Agent-プロセス名" class="headerlink" title="Agent プロセス名"></a>Agent プロセス名</h4><p>Ubuntu の場合</p><blockquote><p>walinuxagent.service</p></blockquote><p>Suse &amp; RHEL &amp; CentOS の場合</p><blockquote><p>waagent.service</p></blockquote><p>下記の手順で agentのプロセスを停止し、バックアップを失敗させます。</p><h4 id="Agent-の停止-1"><a href="#Agent-の停止-1" class="headerlink" title="Agent の停止"></a>Agent の停止</h4><p>・Backup 対象の VM に SSH 接続します。</p><blockquote><p>・以下のコマンドで、 Agent の Service を停止します。<br>（Ubuntu の場合）sudo systemctl stop walinuxagent<br>（Ubuntu 以外の場合）sudo systemctl stop waagent</p></blockquote><blockquote><p>・以下のコマンドで、自動起動を停止します。<br>（Ubuntu の場合）sudo systemctl disable walinuxagent<br>（Ubuntu 以外の場合）sudo systemctl disable waagent</p></blockquote><blockquote><p>・以下のコマンドで、 Agent の Service の状態を確認できます。<br>（Ubuntu の場合）systemctl status walinuxagent<br>（Ubuntu 以外の場合）systemctl status waagent</p></blockquote><h4 id="Ubuntu-環境の実行例"><a href="#Ubuntu-環境の実行例" class="headerlink" title="Ubuntu 環境の実行例"></a>Ubuntu 環境の実行例</h4><p><img src="https://user-images.githubusercontent.com/71251920/142736815-a24dfbd6-e29c-4a08-8c90-604a8fdbae81.png" alt="Ubuntu_agent_stop_01"></p><p><img src="https://user-images.githubusercontent.com/71251920/142736817-6a1fee8c-7bd2-4d5b-9bc5-c9e8ffda6f7b.png" alt="Ubuntu_agent_stop_02"><br>RHEL 環境の実行例<br><img src="https://user-images.githubusercontent.com/71251920/142736834-94f46a91-f554-4de5-b6ea-7089b9607ff5.png" alt="RHEL_agent_stop_01"></p><p><img src="https://user-images.githubusercontent.com/71251920/142736825-0e6032e3-f26f-4760-9f0b-5772d4a02168.png" alt="RHEL_agent_stop_02"></p><h4 id="バックアップの実行-amp-失敗確認"><a href="#バックアップの実行-amp-失敗確認" class="headerlink" title="バックアップの実行 &amp; 失敗確認"></a>バックアップの実行 &amp; 失敗確認</h4><p>バックアップを実行し、バックアップ ジョブ が失敗したことを確認します。<br>*バックアップの実行から失敗まで数時間かかる場合がございます。<br>Status が Failed 、Error Code <strong>”UserErrorGuestAgentStatusUnavailable”</strong> となり、失敗し完了となります。本環境では 4 時間 20 分かかりました。　</p><p><img src="https://user-images.githubusercontent.com/71251920/142736877-fd3190e0-596a-4a51-b0d2-f682b2a34a3e.png" alt="FailCheck_03"></p><h4 id="Agent-の再起動-1"><a href="#Agent-の再起動-1" class="headerlink" title="Agent の再起動"></a>Agent の再起動</h4><p>バックアップ エラーの検証後は、以下コマンドで waagent を再開します。</p><blockquote><p>（Ubuntu の場合）<br>   sudo systemctl start walinuxagent<br>   sudo systemctl enable walinuxagent<br>   systemctl status walinuxagent<br>（Ubuntu 以外の場合）<br>   sudo systemctl start waagent<br>   sudo systemctl enable waagent<br>   systemctl status waagent</p></blockquote><h4 id="Ubuntu-環境の実行例-1"><a href="#Ubuntu-環境の実行例-1" class="headerlink" title="Ubuntu 環境の実行例"></a>Ubuntu 環境の実行例</h4><p><img src="https://user-images.githubusercontent.com/71251920/142736924-8e033f57-60aa-449e-bb34-2fb5c410d633.png" alt="Ubuntu_agent_start"></p><h4 id="RHEL-環境の実行例"><a href="#RHEL-環境の実行例" class="headerlink" title="RHEL 環境の実行例"></a>RHEL 環境の実行例</h4><p><img src="https://user-images.githubusercontent.com/71251920/142736923-43d72bbc-e3cb-46a4-825b-a4b71fe61d9a.png" alt="RHEL_agent_start"></p><h2 id="5-バックアップを故意に失敗させる方法-共有ディスクをアタッチする"><a href="#5-バックアップを故意に失敗させる方法-共有ディスクをアタッチする" class="headerlink" title="5. バックアップを故意に失敗させる方法 (共有ディスクをアタッチする)"></a>5. バックアップを故意に失敗させる方法 (共有ディスクをアタッチする)<a id="5"></a></h2><p>Guest Agent を手動で停止させる方法以外に「共有ディスクを一時的にアタッチしてバックアップ ジョブを失敗させる」方法もご紹介します。<br>こちらはバックアップ ジョブ開始直後 ～ 30 分程度で「UserErrorSharedDiskBackupNotSupported」エラーで失敗する見込みです。</p><h3 id="5-1-詳細手順"><a href="#5-1-詳細手順" class="headerlink" title="5.1.詳細手順"></a>5.1.詳細手順</h3><p>バックアップ 対象の VM に、Azure ポータル画面上で一時的に共有ディスクを追加アタッチします。<br>・Azure マネージド ディスクに対して共有ディスクを有効にする - Azure Virtual Machines | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/disks-shared-enable?tabs=azure-portal">https://learn.microsoft.com/ja-jp/azure/virtual-machines/disks-shared-enable?tabs=azure-portal</a></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/cc0c7196-64d1-482d-9c7d-c8b4d959eedf" alt="image01"></p><p>(「SharedDisk02」は、共有ディスクリソースになっています)<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/81a8a957-edca-4ef5-9858-ea29cacd4df5" alt="image02"></p><p>「今すぐバックアップ」をトリガーします。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/7d5e8fc1-7f76-4be0-9839-a1bd8c4ec62b" alt="image03"></p><p>バックアップ ジョブ開始直後 ～ 30 分程度でバックアップ ジョブが「UserErrorSharedDiskBackupNotSupported」エラーにて失敗する見込みです。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/682e85d2-1814-4ce8-84a4-6fc45dc98dcb" alt="image04"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/464d5257-728b-4411-ac76-559b9b07c93a" alt="image05"></p><p>バックアップ ジョブ エラーを確認した後は、一時的にアタッチしていた共有ディスクをデタッチします。</p><p>Azure VM Backup を意図的に失敗させる方法について、ご案内は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;アラートのテスト等のため “Azure VM Backup を失敗させたい” というお問い合わせをよくいただきます。&lt;br&gt;今回は、&lt;strong&gt;Azure V</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure Backup におけるウイルス除外設定について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/AV_ExcludeSetting/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/AV_ExcludeSetting/</id>
    <published>2024-06-19T03:00:00.000Z</published>
    <updated>2024-08-27T06:06:49.065Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートの山本です。<br>今回はお問い合わせをいただくことが多い、 <strong>Azure Backup を利用する際のウイルス検知の除外設定</strong>  について、Azure VM Backup と MARS バックアップの場合それぞれについてご説明させていただきます。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Azure VM Backup の場合のウイルス検知除外設定</a><br> <a href="#1-1">1-1. Windows OS の場合</a><br> <a href="#1-2">1-2. Linux OS の場合</a><br><a href="#2">2. MARS バックアップの場合のウイルス検知除外設定</a></p><hr><h2 id="1-Azure-VM-Backup-の場合のウイルス検知除外設定"><a href="#1-Azure-VM-Backup-の場合のウイルス検知除外設定" class="headerlink" title="1. Azure VM Backup の場合のウイルス検知除外設定"></a>1. Azure VM Backup の場合のウイルス検知除外設定<a id="1"></a></h2><p>Azure VM Backup とは Azure 上の VM に対するバックアップサービスです。<br>・Azure VM バックアップの概要<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction</a></p><p>Windows OS と Linux OS に場合分けしてお伝えします。</p><h3 id="1-1-Windows-OS-の場合"><a href="#1-1-Windows-OS-の場合" class="headerlink" title="1-1. Windows OS の場合"></a>1-1. Windows OS の場合<a id="1-1"></a></h3><p>Windows OS の場合、下記をアンチウイルス ソフトの除外設定にいれてください。</p><blockquote><p>C:\Packages\Plugins\Microsoft.Azure.RecoveryServices.VMSnapshot<br>C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.RecoveryServices.VMSnapshot</p></blockquote><p>なお、上記は下記の公式ドキュメントにも記載されております。<br>・Azure Backup の失敗のトラブルシューティング:エージェント/拡張機能に関する問題 - 手順 4:Azure Backup VM 拡張機能の正常性を確認する<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout#step-4-check-azure-backup-extension-health">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout#step-4-check-azure-backup-extension-health</a></p><p>・VMRestorePointInternalError - VM で構成されているウイルス対策により、バックアップ拡張機能の実行が制限されています<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#vmrestorepointinternalerror---antivirus-configured-in-the-vm-is-restricting-the-execution-of-backup-extension">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#vmrestorepointinternalerror---antivirus-configured-in-the-vm-is-restricting-the-execution-of-backup-extension</a></p><h3 id="1-2-Linux-OS-の場合"><a href="#1-2-Linux-OS-の場合" class="headerlink" title="1-2. Linux OS の場合"></a>1-2. Linux OS の場合<a id="1-2"></a></h3><p>Linux OS の場合、下記をアンチウイルス ソフトの除外設定にいれてください。</p><blockquote><p>/var/lib/waagent/WALinuxAgent<br>/var/lib/waagent/Microsoft.Azure.RecoveryServices.VMSnapshotLinux</p></blockquote><h3 id="2-MARS-バックアップの場合のウイルス検知除外設定"><a href="#2-MARS-バックアップの場合のウイルス検知除外設定" class="headerlink" title="2 .MARS バックアップの場合のウイルス検知除外設定"></a>2 .MARS バックアップの場合のウイルス検知除外設定<a id="2"></a></h3><p>MARS バックアップ (Azure MARS Backup エージェントを利用したバックアップ) とはクラウドかオンプレミス環境かを問わず、Windows OS において、ファイルとフォルダー単位のバックアップやシステム状態のバックアップを 取得し Azure 上に保存するバックアップサービスです。</p><p>・Microsoft Azure Recovery Services (MARS) エージェントを使用したバックアップのサポート マトリックス<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mars-agent">https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mars-agent</a></p><p>MARS バックアップをお使いの場合、MARS のインストール フォルダ配下をアンチウイルス ソフトのスキャン除外設定にいれてください。<br>デフォルトでは以下のパスに MARS はインストールが行われます。</p><blockquote><p>C:\Program Files\Microsoft Azure Recovery Services Agent</p></blockquote><p>もし MARS のインストール時に以下のように “インストール フォルダ” とは異なるフォルダに “キャッシュの場所” を指定していた場合は、指定した “キャッシュの場所” のフォルダもスキャン除外対象に別途ご指定ください。<br><img src="https://github.com/jpabrs-scem/blog/assets/141192952/c6390ca3-00d5-413b-af1a-cd1f3dda6c42" alt="MARS インストール画面"></p><p>また、上記に加えて MARS のインストール フォルダ配下の以下プロセスもスキャン除外の対象としてご設定ください。</p><blockquote><p>[Install Path]\bin\cbengine.exe</p></blockquote><p>参考までに弊社検証環境にて Windows Defender で除外設定を行った場合のサンプル イメージを以下に記載いたします。<br>※ 指定しているフォルダ パスは前述の MARS インストール画面での設定例をベースにしております。<br><img src="https://github.com/jpabrs-scem/blog/assets/141192952/0b8cb085-71f5-432c-a10c-5f0ba94c8f3f" alt="除外設定例"><br>あくまで参考イメージでございますので、実際に指定する除外パスや指定方法については、お客様のご要件あるいはアンチウイルス ソフトの仕様に依存いたしますことにご留意ください。</p><p>なお、上記 MARS のウイルス スキャン除外設定は下記の公式ドキュメントにも記載されております。<br>・Azure Backup でファイルとフォルダーのバックアップが遅い場合のトラブルシューティング - 原因: Azure Backup の妨げになっている別のプロセスまたはウイルス対策ソフトウェア<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-troubleshoot-slow-backup-performance-issue#cause-another-process-or-antivirus-software-interfering-with-azure-backup">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-troubleshoot-slow-backup-performance-issue#cause-another-process-or-antivirus-software-interfering-with-azure-backup</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートの山本です。&lt;br&gt;今回はお問い合わせをいただくことが多い、 &lt;strong&gt;Azure Backup を利用する際のウイルス検知の除外設定&lt;/strong&gt;  について、Az</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup における CRR (クロスリージョン リストア) について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/CRR/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/CRR/</id>
    <published>2024-06-17T03:00:00.000Z</published>
    <updated>2024-08-27T06:06:49.065Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Backup サポートです。<br>今回は、Azure Backup での リージョンをまたがる復元（ = Cross-Region Restore / CRR）にて頻繁にいただくお問い合わせに関して、下記ご案内いたします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. CRR 機能を有効した場合の、冗長性オプションは「GRS」になるのか、「RA-GRS」になるのか？</a><br><a href="#1-1">1-1. Azure Portal での CRR 有効時の確認方法</a><br><a href="#1-2">1-2. GRS と RA-GRS(CRR有効化) の違い</a><br><a href="#1-3">1-3. セカンダリ リージョンへのリストア手順</a><br><a href="#2">2. セカンダリ リージョンへ復元ポイントがレプリケートされるまでに、最大何時間かかるのか？</a><br><a href="#3">3. セカンダリ リージョンへ復元ポイントがいつレプリケート完了したか、Azure ポータル画面上でどのように確認すればよいのか？</a><br><a href="#3-1">3-1. 補足：バックアップ ジョブについて</a><br><a href="#4">4. 災害復旧後のレプリケーションについて</a></p><hr><h2 id="1-CRR-機能を有効した場合の、冗長性オプションは「GRS」になるのか、「RA-GRS」になるのか？"><a href="#1-CRR-機能を有効した場合の、冗長性オプションは「GRS」になるのか、「RA-GRS」になるのか？" class="headerlink" title=" 1. CRR 機能を有効した場合の、冗長性オプションは「GRS」になるのか、「RA-GRS」になるのか？"></a><a id="1"></a> 1. CRR 機能を有効した場合の、冗長性オプションは「GRS」になるのか、「RA-GRS」になるのか？</h2><p>結論から申し上げますと、RA-GRS となります。<br><img src="https://user-images.githubusercontent.com/71251920/153718070-4b865afe-f876-47e2-afd0-2484e7889235.gif" alt="CRR_01"></p><p>・Azure Backup 用語集 - Azure Backup | Microsoft Docs<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/azure-backup-glossary#grs">https://docs.microsoft.com/ja-jp/azure/backup/azure-backup-glossary#grs</a></p><h3 id="1-1-Azure-Portal-での-CRR-有効時の確認方法"><a href="#1-1-Azure-Portal-での-CRR-有効時の確認方法" class="headerlink" title=" 1-1. Azure Portal での CRR 有効時の確認方法"></a><a id="1-1"></a> 1-1. Azure Portal での CRR 有効時の確認方法</h3><p>ご参考までに、CRR 機能を有効にした場合の Azure ポータル画面上の見え方を説明いたします。<br>下図の Recovery Services コンテナーは「ストレージ レプリケーションの種類：geo 冗長」かつ「クロス リージョン 復元：有効」となっております。<br>これによって CRR 機能が有効 (=RA-GRS) となります。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/6b7b2f75-b435-4d38-a760-e4cbe8fe169d"></p><p>CRR 機能が有効になっている場合、「バックアップ アイテム」画面上では「プライマリ リージョン」のほかに「セカンダリ リージョン」も選択できるよう、活性化されます。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/3cd63704-557a-4754-a248-82b4e48e93a4"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/932d588b-8e7f-4fe8-be03-267bd984cd68"></p><p> 一方でRecovery Services コンテナー上で「リージョンをまたがる復元：無効にする」を選択されている場合は、下図のように「プライマリ リージョン」がデフォルトで選択されており、かつ非活性表示となっているため「セカンダリ リージョン」への切り替えが不可能となっております。<br> <img src="https://github.com/jpabrs-scem/blog/assets/141192952/a716e9db-a396-4ec8-9d22-60cf8afab3eb" alt="CRR_05"></p><div class="alert is-warning"><p class="alert-title">警告</p><p>CRR 機能が有効にされてから上記「セカンダリ リージョン」の項目が活性化されるまで<strong>最大で 48 時間</strong>かかりますのでご注意ください。</p><hr><p>・ Recovery Services コンテナーを作成して構成する - Azure Backup | Microsoft Learn  : リージョンをまたがる復元の設定</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault#set-cross-region-restore">https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault#set-cross-region-restore</a></p></div><h3 id="1-2-GRS-と-RA-GRS-CRR有効化時-の違い"><a href="#1-2-GRS-と-RA-GRS-CRR有効化時-の違い" class="headerlink" title=" 1-2. GRS と RA-GRS (CRR有効化時) の違い"></a><a id="1-2"></a> 1-2. GRS と RA-GRS (CRR有効化時) の違い</h3><p> Recovery Services コンテナーの冗長性が GRS であっても、RA-GRS (CRR有効化時) であってもセカンダリ リージョンにバックアップデータはレプリケーションされ保持されます。<br> 違いは<strong>任意のタイミングでセカンダリ リージョンへ復元できるか</strong>どうかです。</p><p>・geo 冗長ストレージ (GRS) コンテナーで、リージョンをまたがる復元 (CRR) 機能が有効になっている場合とそうでない場合では、どのような違いがありますか。<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-backup-faq#geo----------grs-----------------------crr----------------------------------------">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-backup-faq#geo----------grs-----------------------crr----------------------------------------</a><br>　“CRR 機能が有効になっていない GRS コンテナーの場合、<span style="color: red">Azure によってプライマリ リージョンでの障害が宣言されるまで、セカンダリ リージョンのデータにはアクセスできません。</span> このような場合、セカンダリ リージョンから復元が行われます。<br>　　CRR が有効になっている場合、プライマリ リージョンが稼働している場合でも、セカンダリ リージョンでの復元をトリガーできます。”</p><p>またコストは RA-GRS (CRR有効化) にすることでストレージ単価が高くなりますのでその点ご留意ください。詳細に関しては下記をご覧ください。<br>・Azure Backup の価格 - バックアップ ストレージ の項目をご覧ください。<br><a href="https://azure.microsoft.com/ja-jp/pricing/details/backup/">https://azure.microsoft.com/ja-jp/pricing/details/backup/</a></p><h3 id="1-3-セカンダリ-リージョンへのリストア手順"><a href="#1-3-セカンダリ-リージョンへのリストア手順" class="headerlink" title=" 1-3. セカンダリ リージョンへのリストア手順"></a><a id="1-3"></a> 1-3. セカンダリ リージョンへのリストア手順</h3><p>下記公開情報をご覧ください。<br>・セカンダリ リージョンに復元する - Azure portal で Azure VM データを復元する方法<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region</a></p><h2 id="2-セカンダリ-リージョンへ復元ポイントがレプリケートされるまでに、最大何時間かかるのか？"><a href="#2-セカンダリ-リージョンへ復元ポイントがレプリケートされるまでに、最大何時間かかるのか？" class="headerlink" title=" 2. セカンダリ リージョンへ復元ポイントがレプリケートされるまでに、最大何時間かかるのか？"></a><a id="2"></a> 2. セカンダリ リージョンへ復元ポイントがレプリケートされるまでに、最大何時間かかるのか？</h2><p>セカンダリ リージョンへのデータのレプリケーションは、プライマリリージョンへのバックアップジョブが完了 (最大24時間) してから 12 時間以内にレプリケーションが完了するように動作します。<br>そのため、プライマリリージョンのバックアップジョブ完了とセカンダリ リージョンへのレプリケーションにはラグが生じます。</p><p>・Azure portal を使用して VM を復元する - Azure Backup | Microsoft Docs<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region</a></p><blockquote><p>現在、セカンダリ リージョンの RPO は “36 時間” です。 これは、プライマリ リージョンの RPO が “24 時間” であり、プライマリからセカンダリ リージョンへのバックアップ データのレプリケーションに最大 “12 時間” かかることがあるためです。</p></blockquote><h2 id="3-セカンダリ-リージョンへ復元ポイントがいつレプリケート完了したか、Azure-ポータル画面上でどのように確認すればよいのか？"><a href="#3-セカンダリ-リージョンへ復元ポイントがいつレプリケート完了したか、Azure-ポータル画面上でどのように確認すればよいのか？" class="headerlink" title=" 3. セカンダリ リージョンへ復元ポイントがいつレプリケート完了したか、Azure ポータル画面上でどのように確認すればよいのか？"></a><a id="3"></a> 3. セカンダリ リージョンへ復元ポイントがいつレプリケート完了したか、Azure ポータル画面上でどのように確認すればよいのか？</h2><p>Recovery Services コンテナー ＞ バックアップ アイテム ＞ セカンダリ リージョン ＞ Azure Virtual Machine ＞ 対象の仮想マシンを選択し、「復元ポイント」欄に、対象の復元ポイントが表示されていれば、セカンダリ リージョンへのレプリケートは完了していると判断できます。</p><p>作業例）プライマリ リージョンに配置されている仮想マシン「SAPHANA03」を「今すぐバックアップ」を実施し、取得された復元ポイントがセカンダリ リージョンに複製されているかを確認する<br><img src="https://user-images.githubusercontent.com/71251920/153718060-4b01fca7-5815-4b8a-b2e8-3eb2f32ffa17.png" alt="CRR_08"></p><p>下図画面の黄色罫線部分が、「今すぐバックアップ」にてトリガーし、バックアップが完了したバックアップ ジョブです。<br><em><strong>2021/12/9 17:50 に「今すぐバックアップ」のバックアップ ジョブがトリガーされ、18:21 ごろにバックアップが完了しております。</strong></em><br><img src="https://github.com/jpabrs-scem/blog/assets/141192952/088ad480-35c7-4706-bd1a-9891d27ddf6c" alt="CRR_09"></p><p>バックアップ アイテム ＞ プライマリ リージョン ＞ Azure Virtual Machine 画面上の「最新の復元ポイント」に表示されている時刻は、バックアップが実行開始された時刻となります。<br><img src="https://user-images.githubusercontent.com/71251920/153718057-67e701d6-4f7b-44e7-bbfc-add77d52be00.jpg" alt="CRR_10"></p><p>「プライマリ リージョン」側のバックアップ項目画面では、「復元ポイント」欄に、取得済の復元ポイントが表示されています。<br><img src="https://github.com/jpabrs-scem/blog/assets/141192952/5010fbae-bf29-4b86-a52c-c5f0b1a34e7d" alt="CRR_11"></p><p>一方で、バックアップ アイテム ＞ セカンダリ リージョン ＞ Azure Virtual Machine ＞ 対象の仮想マシンをクリックします。<br>バックアップ項目画面では、<em><strong>「復元ポイント」欄に、12/09 18:32 時点では、12/09 にプライマリ リージョン側にて取得済の復元ポイントはまだ表示されておらず、セカンダリ リージョン側に復元ポイントが複製されていないことが分かります。</strong></em><br>（2021/12/09 24時ごろも確認しましたが、復元ポイントは表示されておりませんでした）<br><img src="https://github.com/jpabrs-scem/blog/assets/141192952/a65099c1-2452-4090-b88a-d6b49161cece" alt="CRR_12"></p><p>同じく、「セカンダリ リージョンへの復元」をクリックし、「復元ポイントの選択」欄を表示しても、<em><strong>12/09 17:50 に開始・取得済の復元ポイントは表示されていないことが確認できます。</strong></em><br><img src="https://user-images.githubusercontent.com/71251920/153718054-b2f2fa69-cee7-4fb6-9997-46186c01f2b2.png" alt="CRR_13"></p><p>2021/12/09 17:50 Auzre VM Backup 開始後、 <em><strong>12 時間以上経過した 2021/12/10 8:09 時点では、「復元ポイントの選択」欄にて、セカンダリ リージョンのデータとして 17:50 のバックアップ開始分が表示されていることが確認できました。</strong></em></p><p><img src="https://user-images.githubusercontent.com/71251920/153718052-24c17913-41e2-4936-bb36-39735f087e94.png" alt="CRR_14"></p><h3 id="補足：セカンダリ-リージョンのジョブについて"><a href="#補足：セカンダリ-リージョンのジョブについて" class="headerlink" title=" 補足：セカンダリ リージョンのジョブについて"></a><a id="3-1"></a> 補足：セカンダリ リージョンのジョブについて</h3><p>Recovery Services コンテナー ＞ バックアップ ジョブ ＞「セカンダリ リージョンのジョブを表示する」をクリックすると、セカンダリ リージョンのリストア ジョブを確認可能です。<br>しかし、プライマリ リージョンに配置されている仮想マシンのバックアップ ジョブは、 セカンダリ リージョンのバックアップ ジョブ上には表示されません。<br><img src="https://github.com/jpabrs-scem/blog/assets/141192952/3d017558-fd4b-49e8-92c2-c43b2967a3a5" alt="CRR_15"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/141192952/215c24ca-e692-4898-a41f-c713f0567b8a" alt="CRR_16"></p><h2 id="災害復旧後のレプリケーションに関するFAQ"><a href="#災害復旧後のレプリケーションに関するFAQ" class="headerlink" title=" 災害復旧後のレプリケーションに関するFAQ"></a><a id="4"></a> 災害復旧後のレプリケーションに関するFAQ</h2><blockquote><p>Q. プライマリリージョンが復旧したあとに プライマリリージョンに VM を復旧できるか</p><blockquote><p>A. こちらは可能ですが、Azure VM Backup の機能で実現するにはクロスリージョン リストアを実施いただく必要がございます。<br>具体的には一度セカンダリリージョンに VM をリストア いただき、復元した VM をセカンダリリージョンの Recovery Services コンテナーで保護しプライマリリージョンにクロスリージョン リストアを行う必要がございます。<br>これはセカンダリリージョンにあるバックアップデータからはセカンダリリージョンにしか、プライマリリージョンにあるバックアップデータからはプライマリリージョンにしかリストアができないためです。<br>Azure VM Backup の クロスリージョン リストア以外の方法ではセカンダリリージョンに VM をリストアした後に Azure Site Recovery などを用いた方法が考えられます。<br>・Azure VM を別の Azure リージョンに移動する<br><a href="https://docs.microsoft.com/ja-jp/azure/site-recovery/azure-to-azure-move-overview">https://docs.microsoft.com/ja-jp/azure/site-recovery/azure-to-azure-move-overview</a></p></blockquote></blockquote><blockquote><p>Q. バックアップデータのレプリケーションは再開されるか</p><blockquote><p>A. プライマリリージョンからセカンダリリージョンへのバックアップデータレプリケーションは災害復旧次第再開されます。<br>一方プライマリリージョンのデータが失われていたとしてもセカンダリリージョンからプライマリリージョンへのバックアップデータのレプリケーションは行われません。</p></blockquote></blockquote><p>CRR に関する説明は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、Azure Backup での リージョンをまたがる復元（ = Cross-Region Restore / CRR）にて頻繁にいただくお問い合わせに関して、</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure Site Recovery レプリケーション中にディスクを削除した場合</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureSiteRecovery/RemoveDiskASR/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureSiteRecovery/RemoveDiskASR/</id>
    <published>2024-06-04T03:00:00.000Z</published>
    <updated>2024-08-27T06:06:49.065Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>みなさんこんにちは、Azure Site Recovery サポートです。<br>今回は、Azure Site Recovery ( 以下、ASR ) レプリケーション中に、ディスクを削除した場合についてお話します。</p><p>ASR レプリケーション中に以下のディスクを削除すると、レプリケーション エラーが発生し、ASR の運用に不具合が発生する場合がございます。</p><p>・レプリケーション中の保護対象サーバーに接続されているディスク (ソース ディスク)<br>・レプリカ マネージド ディスク (本記事の下部に詳細を記載いたします)</p><p><strong>そのため、ASR レプリケーション運用中は、該当ディスクを削除されないようご留意いただけますと幸いです。</strong></p><h3 id="ASR-レプリケーション中にソース-VM-からディスクを削除されたい場合"><a href="#ASR-レプリケーション中にソース-VM-からディスクを削除されたい場合" class="headerlink" title="ASR レプリケーション中にソース VM からディスクを削除されたい場合"></a>ASR レプリケーション中にソース VM からディスクを削除されたい場合</h3><p>ASR レプリケーション中に、ソース VM からディスクを削除されたい場合、一度レプリケーションを無効化いただき、ディスク削除後に、再度レプリケーションを有効化いただく必要がございます。<br>また、ASR レプリケーション中に特定のディスクをレプリケーションから除外されたい場合も、一度レプリケーションを無効化いただき、以下公開情報をご参考いただき ASR 除外構成を実施いただけますと幸いです。</p><p>・ディザスター リカバリーからディスクを除外する<br><a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/exclude-disks-replication">https://learn.microsoft.com/ja-jp/azure/site-recovery/exclude-disks-replication</a></p><h3 id="レプリカ-マネージド-ディスクとは"><a href="#レプリカ-マネージド-ディスクとは" class="headerlink" title="レプリカ マネージド ディスクとは"></a>レプリカ マネージド ディスクとは</h3><p>ASR レプリケーションでは、すべてのソース ディスクで、データは Azure 上のマネージド ディスクにレプリケートされます。<br>このコピー先のマネージド ディスクがレプリカ マネージド ディスクです。ここには、ソース ディスクのコピーとすべての回復ポイントのスナップショットが格納されます。<br>レプリカ マネージド ディスクは、ディスク名に ASRReplica や asrseeddisk といった文字列が含まれておりますので、見分けることができます。</p><p>Azure ポータルの ASR 管理画面よりご確認いただくことも可能です。<br>ホーム &gt; バックアップ センター | インスタンスのバックアップ &gt; レプリケートされた項目 &gt; (対象の VM) | ディスク と移動し、[レプリカ ディスク名] の欄からご確認いただけます。</p><p>・ターゲット リソース<br><a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/azure-to-azure-architecture#target-resources">https://learn.microsoft.com/ja-jp/azure/site-recovery/azure-to-azure-architecture#target-resources</a></p><p>・asrseeddisk とは何ですか?<br><a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/vmware-azure-common-questions#what-is-asrseeddisk">https://learn.microsoft.com/ja-jp/azure/site-recovery/vmware-azure-common-questions#what-is-asrseeddisk</a></p><h3 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h3><p>レプリケートされるマシン - ストレージ<br><a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/azure-to-azure-support-matrix#replicated-machines---storage">https://learn.microsoft.com/ja-jp/azure/site-recovery/azure-to-azure-support-matrix#replicated-machines---storage</a><br><em>“ディスクのホット リムーブ - サポートされていません - VM 上でデータ ディスクを削除する場合は、レプリケーションを無効にしてから、もう一度 VM に対してレプリケーションを有効にする必要があります。”</em></p><p>Azure Site Recovery レプリケーション中にディスクを削除した場合の案内は、以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;みなさんこんにちは、Azure Site Recovery サポートです。&lt;br&gt;今回は、Azure Site Recovery ( 以下、ASR ) レプリケーション中に、ディスクを削除した場合についてお話します。&lt;/p&gt;
</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure Site Recovery" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Site-Recovery/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup におけるクロス ゾーン リストア (CZR) について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/CZR/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/CZR/</id>
    <published>2024-05-31T03:00:00.000Z</published>
    <updated>2024-08-27T06:06:49.065Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Backup サポートです。<br>今回は Azure Backup での異なる可用性ゾーンへの復元 ( = クロス ゾーン リストア / CZR ) についてご紹介します。<br>今回ご紹介する内容は、それぞれの公開情報に掲載されておりますが、一つのページに集約されておりません。<br>よくお問い合わせいただく内容ですので、本記事では情報を集約化してお伝えします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. CZR を行うための各条件</a><br>  <a href="#1-1">1-1. Azure VM の条件</a><br>  <a href="#1-2">1-2. Recovery Services コンテナーの条件</a><br>  <a href="#1-3">1-3. 利用できる復元オプション</a><br><a href="#2">2. 参考情報</a></p><hr><h2 id="1-CZR-を行うための各条件"><a href="#1-CZR-を行うための各条件" class="headerlink" title="1. CZR を行うための各条件"></a><a id="1"></a>1. CZR を行うための各条件</h2><p>CZR を利用することで、Azure VM バックアップによって保護されている VM またはディスクを、復旧ポイントから別のゾーンに復元することができます。<br>CZR を利用するために Recovery Services コンテナーおよび Azure VM バックアップにより保護されている VM が満たすべき条件を下記にまとめました。  </p><h3 id="1-1-Azure-VM-の条件"><a href="#1-1-Azure-VM-の条件" class="headerlink" title="1-1. Azure VM の条件"></a><a id="1-1"></a>1-1. Azure VM の条件</h3><p>CZR を行うためには、Azure VM バックアップにより保護されている VM が次の条件を満たす必要があります。</p><ul><li>マネージド VM であること</li><li>クロス リージョン リストア (CRR) を行う場合、ゾーン固定 VM であること</li><li><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#encryption-of-azure-vm-backups">暗号化された Azure VM</a> ではないこと</li></ul><h4 id="Azure-VM-が特定の可用性ゾーンに固定されているかどうかを確認する方法"><a href="#Azure-VM-が特定の可用性ゾーンに固定されているかどうかを確認する方法" class="headerlink" title="Azure VM が特定の可用性ゾーンに固定されているかどうかを確認する方法"></a>Azure VM が特定の可用性ゾーンに固定されているかどうかを確認する方法</h4><p>ご参考までに、Azure VM が可用性ゾーンに固定されているかどうかの、Azure ポータル画面での確認方法を説明いたします。<br>VMの概要欄に「可用性ゾーン xxx」 と表示されていれば、表示されているゾーンに固定されており、「可用性ゾーン xxx」 といった表示がない場合はゾーン固定されていないと判断できます。<br>たとえば、下記画像の VM 「CZR-stand-z1」は可用性ゾーン「ゾーン1」に固定されている状態です。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/4a433214-3f04-4212-994c-c21851896d71" width="600px"></p><p>一方で下記画像の VM 「CZR-standard」はどのゾーンにも固定されていない状態となります。<br>(この場合は可用性ゾーンは空欄になります。)<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/63cfa831-c538-456c-8804-cf8bc24edaec" width="600px"></p><h3 id="1-2-Recovery-Services-コンテナーの条件"><a href="#1-2-Recovery-Services-コンテナーの条件" class="headerlink" title="1-2. Recovery Services コンテナーの条件"></a><a id="1-2"></a>1-2. Recovery Services コンテナーの条件</h3><p>CZR は以下の条件を満たす Recovery Services コンテナーで行うことができます。  </p><ul><li>Recovery Services コンテナーのストレージ レプリケーションの種類が「ゾーン冗長」、または「geo 冗長」かつ <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault#set-cross-region-restore">CRR</a> が有効になっていること  </li><li>ただし、ストレージ レプリケーションの種類が「geo 冗長」かつ CRR が有効の場合は、<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region">セカンダリ リージョンへの復元</a>を行う際にのみゾーン指定して復元可能<br>※ <a href="#1-1">1-1. Azure VM の条件</a> で説明の通り、ゾーン固定 VM である必要有<br>※ プライマリ リージョンへは CRR を有効化していてもゾーン指定して復元することは不可能  </li><li>復旧ポイントの「回復の種類」が「Vault-Standard」であること<br>「スナップショット」のみ、または「スナップショットと Vault-Standard」の場合はゾーン指定して復元することは不可能  </li></ul><div class="alert is-success"><p class="alert-title">ヒント</p><p>CRR については下記の弊社ブログにて紹介しております。</p><p>・ Azure VM Backup におけるクロス リージョン リストア (CRR) について | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)</p><p>　 <a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/CRR/">https://jpabrs-scem.github.io/blog/AzureVMBackup/CRR/</a>  </p><hr><p>セカンダリ リージョン (ペア リージョン) について、および可用性ゾーンをサポートしているリージョンについては下記ドキュメントをご覧ください。</p><p>・ Azure のリージョン間レプリケーション | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/reliability/cross-region-replication-azure#azure-paired-regions">https://learn.microsoft.com/ja-jp/azure/reliability/cross-region-replication-azure#azure-paired-regions</a></p><p>・ Availability Zones をサポートする Azure サービス | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/reliability/availability-zones-service-support#azure-regions-with-availability-zone-support">https://learn.microsoft.com/ja-jp/azure/reliability/availability-zones-service-support#azure-regions-with-availability-zone-support</a>  </p></div><h4 id="Azure-Portal-で-Recovery-Services-コンテナー-の「ストレージ-レプリケーションの種類」を確認する方法"><a href="#Azure-Portal-で-Recovery-Services-コンテナー-の「ストレージ-レプリケーションの種類」を確認する方法" class="headerlink" title="Azure Portal で Recovery Services コンテナー の「ストレージ レプリケーションの種類」を確認する方法"></a>Azure Portal で Recovery Services コンテナー の「ストレージ レプリケーションの種類」を確認する方法</h4><p>ご参考までに、「ストレージ レプリケーションの種類」が「ゾーン冗長」に設定している場合の Azure ポータル画面上の見え方を説明いたします。<br>該当の Recovery Services コンテナー &gt; 設定 - プロパティ &gt; バックアップ構成 - 更新 ボタン から「ストレージ レプリケーションの種類」が確認できます。<br>たとえば、下記画像の Recovery Services コンテナーでは「ゾーン冗長」が設定されています。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/014f7a8d-8c30-4721-a339-be3856f4059b" width="800px">  </p><div class="alert is-success"><p class="alert-title">ヒント</p><p>Recovery Services コンテナーで既にバックアップを構成している場合は「ストレージ レプリケーションの種類」を変更することができません。</p><p>「ストレージ レプリケーションの種類」の変更が必要な場合は下記ドキュメントをご参照ください。</p><p>・ Recovery Services コンテナーを作成して構成する - Azure Backup | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault#set-storage-redundancy">https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault#set-storage-redundancy</a></p></div><h4 id="Azure-Portal-で-復旧ポイントの「回復の種類」を確認する方法"><a href="#Azure-Portal-で-復旧ポイントの「回復の種類」を確認する方法" class="headerlink" title="Azure Portal で 復旧ポイントの「回復の種類」を確認する方法"></a>Azure Portal で 復旧ポイントの「回復の種類」を確認する方法</h4><p>ご参考までに、復旧ポイントの「回復の種類」を Azure ポータル画面にて確認する方法を説明いたします。  </p><p>まずは該当の Recovery Services コンテナー &gt; 保護されたアイテム - バックアップ アイテム &gt; Azure Virtual Machine ボタンを選択します。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/98ef24ee-50eb-4fc4-8c7b-af5035a18a7d" width="800px">  </p><p>続いて確認したい VM の行にて、詳細 - View details ボタンを選択します。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/0d293ccf-94ac-4553-b938-3712bd2703a0"> </p><p>すると選択した VM の復旧ポイント一覧が表示され、ここから「回復の種類」を確認できます。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/5979f86a-2f54-49ff-b783-3590e52fe4ea"> </p><div class="alert is-success"><p class="alert-title">ヒント</p><p>「スナップショット」「Vault-Standard」についての説明は下記ドキュメントをご参照ください。</p><p>・ レベル | Azure Backup 用語集 - Azure Backup | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-backup-glossary#tier">https://learn.microsoft.com/ja-jp/azure/backup/azure-backup-glossary#tier</a></p></div><h3 id="1-3-利用できる復元オプション"><a href="#1-3-利用できる復元オプション" class="headerlink" title=" 1-3. 利用できる復元オプション"></a><a id="1-3"></a> 1-3. 利用できる復元オプション</h3><p>CZR は次の復元を行う場合にのみ利用できます。</p><ul><li>VM の作成</li><li>ディスクの復元</li></ul><p>なお、<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#replace-existing-disks">既存のディスクの置き換え</a> はサポートされていません。</p><h4 id="VM-の作成"><a href="#VM-の作成" class="headerlink" title="VM の作成"></a>VM の作成</h4><p>復旧ポイントから VM の新規作成を行う際、前述の条件を満たしている場合に、復元先の可用性ゾーンを指定することができます。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/c3448a33-c9de-4aa3-86f3-90600f6aa8a5" width="600px"> </p><p>具体的な復元の手順は下記の公開情報をご覧ください。  </p><ul><li>VM の作成 | Azure Backup を使用して Azure portal を使用して VM を復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#create-a-vm">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#create-a-vm</a></li></ul><h4 id="ディスクの復元"><a href="#ディスクの復元" class="headerlink" title="ディスクの復元"></a>ディスクの復元</h4><p>復旧ポイントから ディスクの復元を行う際、前述の条件を満たしている場合に、復元先の可用性ゾーンを指定することができます。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/c9b22d52-6058-4b94-b498-e67892d7150f" width="600px">  </p><p>具体的な復元の手順は下記の公開情報をご覧ください。  </p><ul><li>ディスクを復元する | Azure Backup を使用して Azure portal を使用して VM を復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-disks">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-disks</a></li></ul><h2 id="2-参考情報"><a href="#2-参考情報" class="headerlink" title="2. 参考情報"></a><a id="2"></a>2. 参考情報</h2><ul><li>復元オプション | Azure Backup を使用して Azure portal を使用して VM を復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-options">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-options</a>  </li><li>VM の作成 | Azure Backup を使用して Azure portal を使用して VM を復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#create-a-vm">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#create-a-vm</a>  </li><li>ディスクを復元する | Azure Backup を使用して Azure portal を使用して VM を復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-disks">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-disks</a>  </li><li>セカンダリ リージョンに復元する | Azure Backup を使用して Azure portal を使用して VM を復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region</a>  </li><li>サポートされる復元方法 | Azure VM バックアップのサポート マトリックス - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#supported-restore-methods">https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#supported-restore-methods</a>  </li><li>FAQ-Azure VM をバックアップする - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#azure-------------------------">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#azure-------------------------</a>  </li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Backup サポートです。&lt;br&gt;今回は Azure Backup での異なる可用性ゾーンへの復元 ( = クロス ゾーン リストア / CZR ) についてご紹介します。&lt;br&gt;今回ご紹介する内容は</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure Backup の 概要</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/Backup_Overview/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/Backup_Overview/</id>
    <published>2024-05-31T03:00:00.000Z</published>
    <updated>2024-08-27T06:06:49.033Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートです。<br>今回はお問合せをいただくことが多い、Azure Backup サービスでどんなバックアップソリューションを提供しているのか、そしてそれぞれのソリューションで何をバックアップおよび復元できるのかをご紹介いたします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Azure Backup の概要</a><br>   <a href="#1-1">  1.1 Azure Backup のバックアップ ソリューション一覧表</a><br>   <a href="#1-2">  1.2 Recovery Services コンテナー と バックアップ コンテナーについて</a><br>   <a href="#1-3">  1.3 バックアップ ポリシー</a><br>   <a href="#1-4">  1.4 Azure Backup における DR / RTO / RPO について</a><br>   <a href="#1-5">  1.5 Azure Backup の価格</a><br><a href="#2">2. Azure Backup のバックアップ ソリューションの詳細</a><br>   <a href="#2-1">  2.1 Azure VM Backup</a><br>   <a href="#2-2">  2.2 Azure ディスク バックアップ</a><br>   <a href="#2-3">  2.3 Azure ファイル共有バックアップ</a><br>   <a href="#2-4">  2.4 Azure BLOB バックアップ</a><br>   <a href="#2-5">  2.5 Azure VM 内の SQL Server バックアップ</a><br>   <a href="#2-6">  2.6 Azure VM 内の SAP HANA データベースバックアップ</a><br>   <a href="#2-7">  2.7 Azure Database for PostgreSQL バックアップ</a><br>   <a href="#2-8">  2.8 Azure Database for MySQL バックアップ</a><br>   <a href="#2-9">  2.9 MARS バックアップ</a><br>   <a href="#2-10">  2.10 DPM / MABS バックアップ</a><br>   <a href="#2-11">  2.11 Azure Kubernetes Service (AKS) バックアップ</a><br><a href="#3">3. よくいただくお問合せ</a></p><hr><h2 id="1-Azure-Backup-の概要"><a href="#1-Azure-Backup-の概要" class="headerlink" title=" 1. Azure Backup の概要"></a><a id="1"></a> 1. Azure Backup の概要</h2><p>Azure Backup サービスでは、Micosoft Azure クラウド プラットフォームにデータをバックアップすることができます。<br>オンプレミスや Azure の様々なリソースを簡単にバックアップおよび復元を行うことができ、また一元化された監視と管理を行うためのソリューションを提供します。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/9c7ab400-ac12-41e3-9f06-445561de7e12"></p><div class="alert is-success"><p class="alert-title">ヒント</p><p>Azure Backup の詳細については以下のドキュメントを参照ください。  </p><hr><p>・ Azure Backup とは - Azure Backup | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-overview">https://learn.microsoft.com/ja-jp/azure/backup/backup-overview</a></p><p>・アーキテクチャの概要 - Azure Backup | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-architecture">https://learn.microsoft.com/ja-jp/azure/backup/backup-architecture</a></p></div><h2 id="1-1-Azure-Backup-のバックアップ-ソリューション一覧表"><a href="#1-1-Azure-Backup-のバックアップ-ソリューション一覧表" class="headerlink" title=" 1.1 Azure Backup のバックアップ ソリューション一覧表"></a><a id="1-1"></a> 1.1 Azure Backup のバックアップ ソリューション一覧表</h2><p>下記の表では Azure Backup で提供されている各バックアップソリューションとそれぞれでバックアップおよび復元できる対象をご紹介します。<br>また、各ソリューションには各公開ドキュメントへのリンクを付けています。</p><table><thead><tr><th align="left">バックアップの種類</th><th align="left">バックアップ対象</th><th align="left">復元方法</th></tr></thead><tbody><tr><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction">Azure VM バックアップ</a></td><td align="left">Azure VM</td><td align="left"><ul> <li>新しい VM として復元</li> <li>VM にアタッチされていたディスクの復元</li> <li>既存 (バックアップ元) VM のディスクを置き換えて復元 </li> <li>VM 内にある特定ファイルの復元</li> </ul></td></tr><tr><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-overview">Azure ディスク バックアップ</a></td><td align="left">Azure Managed Disks</td><td align="left"><ul> <li>新しいディスクとして復元</li>  </ul></td></tr><tr><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-file-share-backup-overview?tabs=snapshot">Azure ファイル共有バックアップ</a></td><td align="left">ストレージ アカウントのファイル共有</td><td align="left"><ul> <li>Azure ファイル共有の復元</li> <li>個々のファイルまたはフォルダーの復元</li> </ul></td></tr><tr><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-overview?tabs=operational-backup">Azure BLOB バックアップ</a></td><td align="left">ストレージ アカウントの BLOB Storage</td><td align="left"><ul> <li>ストレージ アカウント内のすべての BLOB の復元</li> <li>選択したコンテナーの復元</li> <li>プレフィックスの一致を使用して特定の BLOB の復元</li> </ul></td></tr><tr><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-sql-database">Azure VM 内の SQL Server バックアップ</a></td><td align="left">Azure VM 内の  SQL Server の データベース <br> ※ 完全バックアップ、差分バックアップ、ログ バックアップに対応 <br> ※ Always On 可用性グループのバックアップに対応</td><td align="left"><ul> <li>別のデータベースに復元</li> <li>元のデータベースを上書きして復元</li> <li>ファイルとして復元</li> </ul></td></tr><tr><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-about">Azure VM 内の SAP HANA データベースバックアップ</a></td><td align="left">Azure VM 内の SAP HANA のデータベース <br> ※ 完全バックアップ、差分バックアップ、増分バックアップ、ログ バックアップ、インスタンス スナップショットのバックアップに対応 <br> ※ HANA システム レプリケーション (HSR) データベースのバックアップに対応</td><td align="left"><ul> <li>別のデータベースとして復元</li> <li>元のデータベースを上書きしての復元</li> <li>ファイルとして復元</li> </ul></td></tr><tr><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-database-postgresql-overview">Azure Database for PostgreSQL バックアップ</a></td><td align="left">Azure Database for PostgreSQL サーバーのデータベース</td><td align="left"><ul> <li>別のデータベースとして復元</li> <li>ファイルとして復元</li> </ul></td></tr><tr><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-mysql-flexible-server-about">Azure Database for MySQL バックアップ (注1)</a></td><td align="left">Azure Database for MySQL サーバーのデータベース</td><td align="left"><ul> <li>ファイルとして復元</li> </ul></td></tr><tr><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-about-mars">MARS バックアップ</a></td><td align="left">オンプレミス マシン / Azure VM の Windows OS マシン上 のファイル、フォルダーとシステム状態</td><td align="left"><ul> <li>ファイルとフォルダーの復元</li> <li>ボリューム レベルでの復元</li> <li>システム状態ファイルの復元</li> </ul></td></tr><tr><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mabs-dpm#about-dpmmabs">DPM / MABS バックアップ</a></td><td align="left">オンプレミス マシン / Azure VM 上で実行されているワークロード (SQL server や Exchange など)、仮想マシン (Hyper-V、 VMware) <br> 具体的なバックアップ対象は <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-mabs-protection-matrix">MABS (Azure Backup Server) V4 の保護マトリックス</a> をご参照ください。</td><td align="left">復元できる方法については保護する各ワークロードによって異なります。 <br> 具体的な復元方法は <a href="#2-10-restore">2.10 DPM / MABS バックアップ &gt; 復元方法</a> をご参照ください</td></tr><tr><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-kubernetes-service-backup-overview">Azure Kubernetes Service (AKS) バックアップ</a></td><td align="left">AKS クラスター (クラスター リソースとクラスターにアタッチされている永続ボリューム)</td><td align="left"><ul> <li> 既存の (バックアップ元) の AKS クラスターに復元</li> <li>別の AKS クラスターとして復元</li> </ul></td></tr></tbody></table><div class="alert is-info"><p class="alert-title">Note</p><p>(注1) 2024年5月現在 Azure Database for MySQL のバックアップ機能が Public Preview となっています。  </p><hr><p>・ Public preview: Azure Backup supports long term retention for backup of Azure Database for MySQL– Flexible Server | Azure updates | Microsoft Azure</p><p>　 <a href="https://azure.microsoft.com/en-US/updates/mysql-flexibleserverlongtermretenttion/">https://azure.microsoft.com/en-US/updates/mysql-flexibleserverlongtermretenttion/</a></p></div><h3 id="1-2-Recovery-Services-コンテナー-と-バックアップ-コンテナーについて"><a href="#1-2-Recovery-Services-コンテナー-と-バックアップ-コンテナーについて" class="headerlink" title=" 1.2 Recovery Services コンテナー と バックアップ コンテナーについて"></a><a id="1-2"></a> 1.2 Recovery Services コンテナー と バックアップ コンテナーについて</h3><p>Azure Backup を利用するためには、最初に Azure 上にバックアップ データを保存するストレージを作成する必要があります。<br>このストレージは、<strong>Recovery Services コンテナー</strong>、もしくは<strong>バックアップ コンテナー</strong>と呼ばれ、利用する Azure Backup ソリューションの種類によって、いずれかを必ず作成します。<br>この 2 種類のコンテナーは、バックアップ データを格納する Azure のストレージです。  </p><h4 id="利用方法"><a href="#利用方法" class="headerlink" title="利用方法"></a>利用方法</h4><p>Azure portal にて<code>バックアップ センター</code>ダッシュボードに移動し、<code>概要</code>ペインで<code>コンテナー</code>を選択します。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/0ef72d75-5962-46a2-805a-0d0a33941ca4" width="700px"></p><p>コンテナーの作成画面に移動し、利用したいコンテナーの種類を選択して作成を開始することができます。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/85d52605-3642-47c2-b8bd-321ebbf4791c" width="700px"></p><div class="alert is-success"><p class="alert-title">ヒント</p><p>Recovery Services コンテナーとバックアップ コンテナーの詳細については下記ドキュメントを参照ください。</p><hr><p>・Recovery Services コンテナーの概要 - Azure Backup | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-recovery-services-vault-overview">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-recovery-services-vault-overview</a></p><p>・Recovery Services コンテナーを作成して構成する - Azure Backup | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault">https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault</a></p><p>・バックアップ コンテナーの概要 - Azure Backup | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-vault-overview">https://learn.microsoft.com/ja-jp/azure/backup/backup-vault-overview</a></p><p>・バックアップ コンテナーの作成と管理 - Azure Backup | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/create-manage-backup-vault">https://learn.microsoft.com/ja-jp/azure/backup/create-manage-backup-vault</a>  </p></div><div class="alert is-success"><p class="alert-title">ヒント</p><p>バックアップ データの保存先については下記ドキュメントを参照ください。  </p><hr><p>・Recovery Services コンテナーとバックアップ コンテナーについて | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)</p><p>　 <a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RSV_BV/">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RSV_BV/</a>  </p></div><h3 id="1-3-バックアップ-ポリシーについて"><a href="#1-3-バックアップ-ポリシーについて" class="headerlink" title=" 1.3 バックアップ ポリシーについて"></a><a id="1-3"></a> 1.3 バックアップ ポリシーについて</h3><p>Azure Backup でバックアップをスケジュールするには、<strong>バックアップ ポリシー</strong>を利用します。<br>バックアップ ポリシーは Recovery Services コンテナーもしくはバックアップ コンテナーごとに管理され、各バックアップ ソリューション用に作成することができます。<br>バックアップ ポリシーではバックアップ ソリューションごとに設定できる内容は異なりますが、基本的に以下項目を設定します。  </p><ul><li>スケジュール : いつバックアップをするか</li><li>保持期間 : 復旧ポイントをどれだけの期間保有する必要があるか</li></ul><div class="alert is-success"><p class="alert-title">ヒント</p><p>バックアップ ポリシーの詳細については下記ドキュメントを参照ください。  </p><hr><p>・バックアップ ポリシーの基礎 | アーキテクチャの概要 - Azure Backup | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-architecture#backup-policy-essentials">https://learn.microsoft.com/ja-jp/azure/backup/backup-architecture#backup-policy-essentials</a>  </p></div><div class="alert is-success"><p class="alert-title">ヒント</p><p>バックアップの頻度とバックアップデータの保持期間については下記ドキュメントを参照ください。  </p><hr><p>・Azure Backup の 保持期間について | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)</p><p>　 <a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/Backup_RetentionPeriod/">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/Backup_RetentionPeriod/</a></p></div><h4 id="利用方法-1"><a href="#利用方法-1" class="headerlink" title="利用方法"></a>利用方法</h4><p>バックアップ ポリシーは Recovery Services コンテナーとバックアップ コンテナーそれぞれで管理できます。</p><ul><li>Recovery Services コンテナーの場合  <img src="https://github.com/jpabrs-scem/blog/assets/109163295/f7394639-d63e-4f9b-8acb-b1c13fdfc3e5" width="700px"></li><li>バックアップ コンテナーの場合  <img src="https://github.com/jpabrs-scem/blog/assets/109163295/b1f8b099-d1d7-4d46-830e-233df27e72e7" width="700px"></li></ul><h3 id="1-4-Azure-Backup-における-DR-RTO-RPO-について"><a href="#1-4-Azure-Backup-における-DR-RTO-RPO-について" class="headerlink" title=" 1.4 Azure Backup における DR / RTO / RPO について"></a><a id="1-4"></a> 1.4 Azure Backup における DR / RTO / RPO について</h3><h4 id="Disaster-recovery-DR-について"><a href="#Disaster-recovery-DR-について" class="headerlink" title="Disaster recovery (DR) について"></a>Disaster recovery (DR) について</h4><p>Disaster recovery (DR) は、災害時のシステムの復旧やデータロストを未然に防ぐ対策を指します。<br>Azure Backup では DR の一環として クロス リージョン リストア (CRR) の利用が可能です。<br>適用できるバックアップ ソリューションは以下です。  </p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#cross-region-restore">Azure VM バックアップ</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/backup/restore-sql-database-azure-vm#cross-region-restore">Azure VM 内の SQL Server バックアップ</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-restore#cross-region-restore">Azure VM 内の SAP HANA データベースバックアップ</a> </li><li><a href="https://learn.microsoft.com/ja-jp/azure/backup/about-restore-microsoft-azure-recovery-services#cross-region-restore">MARS バックアップ</a> (注1)</li><li><a href="https://learn.microsoft.com/ja-jp/azure/backup/restore-azure-database-postgresql#restore-databases-across-regions">Azure Database for PostgreSQL バックアップ</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-kubernetes-service-cluster-restore#restore-in-secondary-region-preview">Azure Kubernetes Service (AKS) バックアップ</a> (注1)</li></ul><div class="alert is-info"><p class="alert-title">Note</p><p>(注1) 2024年5月現在 MARS バックアップ と Azure Kubernetes Service (AKS) バックアップでの CRR 機能は Public Preview となっています。  </p><hr><p>・ Preview: Cross Region Restore (CRR) for Recovery Services Agent (MARS) using Azure Backup | Azure の更新情報 | Microsoft Azure</p><p>　 <a href="https://azure.microsoft.com/ja-jp/updates/preview-mars-crr/">https://azure.microsoft.com/ja-jp/updates/preview-mars-crr/</a></p></div><p>ただし CRR を利用するためには Recovery Service コンテナーの冗長性オプションが「GRS」かつ「リージョンをまたがる復元」が有効である必要があります。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>CRR の詳細については下記ドキュメントをご参照ください。  </p><hr><p>・ Azure VM Backup における クロス リージョン リストア (CRR) について | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)</p><p>　 <a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/CRR/">https://jpabrs-scem.github.io/blog/AzureVMBackup/CRR/</a></p><p>・ リージョンをまたがる復元 | Recovery Services コンテナーを作成して構成する - Azure Backup | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault#set-cross-region-restore">https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault#set-cross-region-restore</a></p><p>・ Azure portal を使用してリージョン間復元を実行する | Backup コンテナーの作成と管理 - Azure Backup | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/create-manage-backup-vault#perform-cross-region-restore-using-azure-portal">https://learn.microsoft.com/ja-jp/azure/backup/create-manage-backup-vault#perform-cross-region-restore-using-azure-portal</a>  </p></div><div class="alert is-success"><p class="alert-title">ヒント</p><p>Azure VM Backup と Azure Site Recovery それぞれの DR 要件について下記弊社ブログにて紹介しております。  </p><hr><p>・Azure VM Backup と Azure Site Recovery による DR 要件について | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)</p><p>　 <a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/DR_ASR_or_VMBackup/#2">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/DR_ASR_or_VMBackup/#2</a></p></div><h4 id="Recovery-Time-Objective-RTO-について"><a href="#Recovery-Time-Objective-RTO-について" class="headerlink" title="Recovery Time Objective (RTO) について"></a>Recovery Time Objective (RTO) について</h4><p>Recovery Time Objective (RTO) は「目標復旧時間」のことで、システム停止時点から復旧までに所要する目標時間を指します。<br>Azure Backup では RTO については明確に定められておらず、またバックアップやリストアの所要時間を見積もることができません。<br>これは Azure サービスがマルチテナント サービスであり、 Azure Backup サービスにおける所要時間はバックアップ / リストア対象のバックアップ アイテムの転送データサイズのみではなく、他のリソース、他のユーザー様の稼働状況、帯域の状況などにも処理時間は左右されるためです。<br>詳細については下記ドキュメントをご参照ください。  </p><ul><li>Azure Backup の バックアップ / リストア 所要時間について | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br><a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/Backup_RecoveryTIme">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/Backup_RecoveryTIme</a></li></ul><div class="alert is-success"><p class="alert-title">ヒント</p><p>RTO と RPO について、より詳細な説明は下記の公開ドキュメントをご参照ください。  </p><hr><p>・ Azure Backup 用語集 - Azure Backup | Microsoft Docs</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-backup-glossary#recovery-point-objective-rpo">https://learn.microsoft.com/ja-jp/azure/backup/azure-backup-glossary#recovery-point-objective-rpo</a></p></div><h4 id="Recovery-Point-Objective-RPO-について"><a href="#Recovery-Point-Objective-RPO-について" class="headerlink" title="Recovery Point Objective (RPO) について"></a>Recovery Point Objective (RPO) について</h4><p>Recovery Point Objective (RPO) は「目標復旧時点」のことで、システムが停止した時に、過去のどの時点のデータまでを復旧できるかの目標時点を指します。<br>RPO は利用するバックアップ ソリューションによって異なります。<br>各バックアップ ソリューションによって指定できるバックアップ頻度が異なるためです。<br>例えば Azure ディスク バックアップの場合は最短 1 時間ごとのバックアップを指定することができますが、Azure VM バックアップでは最短でも 4 時間ごとのバックアップとなります。<br>バックアップ頻度については <a href="#1-3"> 1.3 バックアップ ポリシー</a> の<code>ヒント</code>をご参照ください。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>セカンダリ リージョンへのデータのレプリケーションは、プライマリリージョンへのバックアップジョブが完了 (最大24時間) してから 12 時間以内にレプリケーションが完了するように動作します。</p><p>そのため、プライマリリージョンのバックアップジョブ完了とセカンダリ リージョンへのレプリケーションにはラグが生じます。</p><p>詳細は下記の公開ドキュメントをご参照ください。</p><p>・ Azure Backup を使用して Azure portal を使用して VM を復元する - Azure Backup | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region</a></p></div><h3 id="1-5-Azure-Backup-の価格"><a href="#1-5-Azure-Backup-の価格" class="headerlink" title=" 1.5 Azure Backup の価格"></a><a id="1-5"></a> 1.5 Azure Backup の価格</h3><p>基本的には、保護対象のリソースのインスタンス数、保全データサイズなどに課金されます。<br>バックアップソリューションにより課金体系が異なる場合がありますので、詳しくは以下のドキュメントを参照いただくようお願いいたします。  </p><ul><li>料金 - クラウド バックアップ | Microsoft Azure<br><a href="https://azure.microsoft.com/ja-jp/pricing/details/backup/">https://azure.microsoft.com/ja-jp/pricing/details/backup/</a></li><li>料金計算ツール | Microsoft Azure<br><a href="https://azure.microsoft.com/ja-jp/pricing/calculator/">https://azure.microsoft.com/ja-jp/pricing/calculator/</a></li><li>Azure Backup の価格 - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-backup-pricing">https://learn.microsoft.com/ja-jp/azure/backup/azure-backup-pricing</a></li><li>料金計算ツールを用いた Azure VM Backup の料金見積もりについて | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_calculator/">https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_calculator/</a></li><li>Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの料金の違い | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_billing/">https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_billing/</a></li></ul><h2 id="2-Azure-Backup-のバックアップ-ソリューションの詳細"><a href="#2-Azure-Backup-のバックアップ-ソリューションの詳細" class="headerlink" title=" 2. Azure Backup のバックアップ ソリューションの詳細"></a><a id="2"></a> 2. Azure Backup のバックアップ ソリューションの詳細</h2><h3 id="2-1-Azure-VM-Backup"><a href="#2-1-Azure-VM-Backup" class="headerlink" title=" 2.1 Azure VM Backup"></a><a id="2-1"></a> 2.1 Azure VM Backup</h3><p>Azure VM 全体、Azure VM 単位でのバックアップを行うことができます。<br>バックアップの構成や復旧ポイントの管理は Recovery Services コンテナーにて行うことができます。<br>バックアップ対象として Windows OS, Linux OS 共に対象となり、オンライン / オフラインどちらでもバックアップ可能です。  </p><p>バックアップできるバックアップ データの整合性はアプリケーション整合性、ファイルシステム整合性とクラッシュ整合性の 3 種類がございます。<br>整合性の詳細については下記ドキュメントをご参照ください。  </p><ul><li>Azure VM Backupにおける整合性について | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/">https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/</a></li><li>スナップショットの整合性 | Azure VM バックアップについて - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#snapshot-consistency">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#snapshot-consistency</a></li></ul><h4 id="利用方法-2"><a href="#利用方法-2" class="headerlink" title="利用方法"></a>利用方法</h4><p>Azure Portal にて Recovery Services コンテナーを開き、<code>バックアップ</code>を選択、<br>次にワークロードで<code>Azure</code>、バックアップ対象で<code>仮想マシン</code>を選択することでバックアップの設定を開始することができます。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/2463356a-ac96-4c37-82ca-08efccaa5837" width="600px"></p><h4 id="参照リンク"><a href="#参照リンク" class="headerlink" title="参照リンク"></a>参照リンク</h4><p>このバックアップ ソリューションの詳細については下記ドキュメントをご参照ください。  </p><ul><li>Azure VM バックアップについて - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction</a></li><li>Azure VM バックアップのサポート マトリックス - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas">https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas</a></li><li>Recovery Services コンテナーに Azure VM をバックアップする - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-vms-prepare">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-vms-prepare</a></li><li>Azure Backup を使用して Azure portal を使用して VM を復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms</a>  </li></ul><h3 id="2-2-Azure-ディスク-バックアップ"><a href="#2-2-Azure-ディスク-バックアップ" class="headerlink" title=" 2.2 Azure ディスク バックアップ"></a><a id="2-2"></a> 2.2 Azure ディスク バックアップ</h3><p>Azure の マネージド ディスクをバックアップすることができます。<br>また、ディスクが Azure VM に接続されている場合でもバックアップ可能です。<br>ただし、VM が起動中であっても取得されるバックアップはクラッシュ整合性となります。<br>バックアップの構成や復旧ポイントの管理はバックアップ コンテナーにて行うことができます。 </p><h4 id="利用方法-3"><a href="#利用方法-3" class="headerlink" title="利用方法"></a>利用方法</h4><p>Azure Portal にてバックアップ コンテナーを開き、<code>バックアップ</code>を選択、<br>次にデータソースの種類で<code>Azure ディスク</code>を選択することでバックアップの設定を開始することができます。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/5cc5719e-0bac-414e-9a9d-a5709af12f9b" width="600px"></p><h4 id="参照リンク-1"><a href="#参照リンク-1" class="headerlink" title="参照リンク"></a>参照リンク</h4><p>このバックアップ ソリューションの詳細については下記ドキュメントをご参照ください。  </p><ul><li>Azure ディスク バックアップの概要 - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-JP/azure/backup/disk-backup-overview">https://learn.microsoft.com/ja-JP/azure/backup/disk-backup-overview</a></li><li>Azure ディスク バックアップのサポート マトリックス - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-support-matrix">https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-support-matrix</a></li><li>Azure Managed Disks のバックアップ - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-managed-disks">https://learn.microsoft.com/ja-jp/azure/backup/backup-managed-disks</a></li><li>Azure Managed Disks を復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/restore-managed-disks">https://learn.microsoft.com/ja-jp/azure/backup/restore-managed-disks</a></li></ul><h3 id="2-3-Azure-ファイル共有バックアップ"><a href="#2-3-Azure-ファイル共有バックアップ" class="headerlink" title=" 2.3 Azure ファイル共有バックアップ"></a><a id="2-3"></a> 2.3 Azure ファイル共有バックアップ</h3><p>Azure ストレージアカウントのファイル共有をバックアップすることができます。<br>バックアップの構成や復旧ポイントの管理は Recovery Services コンテナーにて行うことができます。  </p><h4 id="利用方法-4"><a href="#利用方法-4" class="headerlink" title="利用方法"></a>利用方法</h4><p>Azure Portal にて Recovery Services コンテナーを開き、<code>バックアップ</code>を選択、<br>次にワークロードで<code>Azure</code>、バックアップ対象で<code>Azure ファイル共有</code>を選択することでバックアップの設定を開始することができます。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/8b6b5bc8-95b3-4097-8f1b-08f5016d43b7" width="600px">  </p><h4 id="参照リンク-2"><a href="#参照リンク-2" class="headerlink" title="参照リンク"></a>参照リンク</h4><p>このバックアップ ソリューションの詳細については下記ドキュメントをご参照ください。  </p><ul><li>Azure ファイル共有のバックアップについて - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-file-share-backup-overview?tabs=snapshot">https://learn.microsoft.com/ja-jp/azure/backup/azure-file-share-backup-overview?tabs=snapshot</a></li><li>Azure Backup を使用した Azure ファイル共有のバックアップのサポート マトリックス - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-file-share-support-matrix?tabs=snapshot-tier">https://learn.microsoft.com/ja-jp/azure/backup/azure-file-share-support-matrix?tabs=snapshot-tier</a></li><li>Azure portal で Azure ファイル共有をバックアップする - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-files?tabs=backup-center">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-files?tabs=backup-center</a></li><li>Azure ファイル共有を復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/restore-afs?tabs=full-share-recovery">https://learn.microsoft.com/ja-jp/azure/backup/restore-afs?tabs=full-share-recovery</a></li></ul><h3 id="2-4-Azure-BLOB-バックアップ"><a href="#2-4-Azure-BLOB-バックアップ" class="headerlink" title=" 2.4 Azure BLOB バックアップ"></a><a id="2-4"></a> 2.4 Azure BLOB バックアップ</h3><p>Azure ストレージアカウントの BLOB コンテナーをバックアップすることができます。<br>バックアップの構成や復旧ポイントの管理はバックアップ コンテナーにて行うことができます。  </p><h4 id="利用方法-5"><a href="#利用方法-5" class="headerlink" title="利用方法"></a>利用方法</h4><p>Azure Portal にてバックアップ コンテナーを開き、<code>バックアップ</code>を選択、<br>次にデータソースの種類で<code>Azure BLOB (Azure Storage)</code>を選択することでバックアップの設定を開始することができます。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/a4e8ba67-a51a-4431-a60c-58e88854c2d6" width="600px">  </p><h4 id="参照リンク-3"><a href="#参照リンク-3" class="headerlink" title="参照リンク"></a>参照リンク</h4><p>このバックアップ ソリューションの詳細については下記ドキュメントをご参照ください。  </p><ul><li>Azure BLOB バックアップの概要 - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-overview?tabs=operational-backup">https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-overview?tabs=operational-backup</a></li><li>Azure BLOB バックアップのサポート マトリックス - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-support-matrix?tabs=operational-backup">https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-support-matrix?tabs=operational-backup</a></li><li>Azure Backup を使用して Azure BLOB のバックアップを構成および管理する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-configure-manage?tabs=operational-backup">https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-configure-manage?tabs=operational-backup</a></li><li>Azure の BLOB を復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/blob-restore?tabs=operational-backup">https://learn.microsoft.com/ja-jp/azure/backup/blob-restore?tabs=operational-backup</a></li></ul><h3 id="2-5-Azure-VM-内の-SQL-Server-バックアップ"><a href="#2-5-Azure-VM-内の-SQL-Server-バックアップ" class="headerlink" title=" 2.5 Azure VM 内の SQL Server バックアップ"></a><a id="2-5"></a> 2.5 Azure VM 内の SQL Server バックアップ</h3><p>Azure VM 内にある SQL Server をバックアップすることができます。<br>バックアップの構成や復旧ポイントの管理は Recovery Services コンテナーにて行うことができます。<br>このソリューションでは、SQL Server 側のバックアップ機能と連携して、SQL データベースのバックアップを作成しています。<br>そのため、Azure VM Backup にはない以下の特徴があります。</p><ul><li>完全、差分、ログバックアップに対応</li><li>頻繁に行われるログバックアップによる 最短 15 分間の RPO (目標復旧時点)</li><li>特定時点への復元</li><li>個々のデータベース レベルのバックアップと復元</li></ul><h4 id="利用方法-6"><a href="#利用方法-6" class="headerlink" title="利用方法"></a>利用方法</h4><p>Azure Portal にて Recovery Services コンテナーを開き、<code>バックアップ</code>を選択、<br>次にワークロードで<code>Azure</code>、バックアップ対象で<code>Azure VM 内の SQL Server</code>を選択することでバックアップの設定を開始することができます。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/cf06b38b-7a42-49cc-9d4f-8a6757936c93" width="600px">  </p><h4 id="参照リンク-4"><a href="#参照リンク-4" class="headerlink" title="参照リンク"></a>参照リンク</h4><p>このバックアップ ソリューションの詳細については下記ドキュメントをご参照ください。  </p><ul><li>Azure への SQL Server データベースのバックアップ - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-sql-database">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-sql-database</a>  </li><li>Azure VM 内の SQL Server のバックアップに関する Azure Backup のサポート マトリックス - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/sql-support-matrix">https://learn.microsoft.com/ja-jp/azure/backup/sql-support-matrix</a>  </li><li>コンテナーから複数の SQL Server VM をバックアップする - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms">https://learn.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms</a></li><li>Azure VM 上の SQL Server データベースを復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/restore-sql-database-azure-vm">https://learn.microsoft.com/ja-jp/azure/backup/restore-sql-database-azure-vm</a></li></ul><h3 id="2-6-Azure-VM-内の-SAP-HANA-データベースバックアップ"><a href="#2-6-Azure-VM-内の-SAP-HANA-データベースバックアップ" class="headerlink" title=" 2.6 Azure VM 内の SAP HANA データベースバックアップ"></a><a id="2-6"></a> 2.6 Azure VM 内の SAP HANA データベースバックアップ</h3><p>Azure VM 内にある SAP HANA データベースをバックアップすることができます。<br>バックアップの構成や復旧ポイントの管理は Recovery Services コンテナーにて行うことができます。<br>Azure Backup は、SAP による Backint 認定がされており、SAP HANA 側のバックアップ機能と連携してバックアップを作成しています。<br>そのため、Azure VM Backup にはない以下の特徴があります。</p><ul><li>完全、差分、ログバックアップに対応</li><li>頻繁に行われるログバックアップによる 最短 15 分間の RPO (目標復旧時点)</li><li>特定時点への復元</li><li>個々のデータベース レベルのバックアップと復元</li></ul><h4 id="利用方法-7"><a href="#利用方法-7" class="headerlink" title="利用方法"></a>利用方法</h4><p>Azure Portal にて Recovery Services コンテナーを開き、<code>バックアップ</code>を選択、<br>次にワークロードで<code>Azure</code>、バックアップ対象で<code>Azure VM 内の SAP HANA</code>を選択することでバックアップの設定を開始することができます。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/037e9907-9b8f-4259-b573-b8e5e0c02e08" width="600px"> </p><h4 id="参照リンク-5"><a href="#参照リンク-5" class="headerlink" title="参照リンク"></a>参照リンク</h4><p>このバックアップ ソリューションの詳細については下記ドキュメントをご参照ください。  </p><ul><li>Azure VM 上の SAP HANA データベース バックアップについて - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-about">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-about</a></li><li>SAP HANA バックアップのサポート マトリックス - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-backup-support-matrix">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-backup-support-matrix</a></li><li>Azure Backup を使用して Azure に SAP HANA データベースをバックアップする - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-sap-hana-database">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-sap-hana-database</a></li><li>Azure VM 上の SAP HANA データベースの復元 - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-restore">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-restore</a></li></ul><h3 id="2-7-Azure-Database-for-PostgreSQL-バックアップ"><a href="#2-7-Azure-Database-for-PostgreSQL-バックアップ" class="headerlink" title=" 2.7 Azure Database for PostgreSQL バックアップ"></a><a id="2-7"></a> 2.7 Azure Database for PostgreSQL バックアップ</h3><p>Azure Database for PostgreSQL をバックアップすることができます。<br>Azure Database for PostgreSQL そのもののバックアップソリューションではデータ保有期間が最大 35 日間ですが、Azure Backup を利用することでデータを長期的 (最大 10 年間) に保有することが可能になります。<br>長期的な保有期間以外にも、バックアップの構成や復旧ポイントを一元的にバックアップ コンテナーにて管理できるメリットなどがあります。</p><h4 id="利用方法-8"><a href="#利用方法-8" class="headerlink" title="利用方法"></a>利用方法</h4><p>Azure Portal にてバックアップ コンテナーを開き、<code>バックアップ</code>を選択、<br>次にデータソースの種類で<code>Azure Database for PostgreSQL サーバー</code>を選択することでバックアップの設定を開始することができます。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/32a2e9ee-0a07-451c-8822-f6ed16edc4d7" width="600px">  </p><h4 id="参照リンク-6"><a href="#参照リンク-6" class="headerlink" title="参照リンク"></a>参照リンク</h4><p>このバックアップ ソリューションの詳細については下記ドキュメントをご参照ください。  </p><ul><li>Azure Database for PostgreSQL のバックアップについて - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-database-postgresql-overview">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-database-postgresql-overview</a></li><li>Azure Database for PostgreSQL サーバーのサポート マトリックス - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-database-postgresql-support-matrix">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-database-postgresql-support-matrix</a></li><li>Azure Database for PostgreSQL のバックアップ - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-database-postgresql">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-database-postgresql</a></li><li>Azure Database for PostgreSQL を復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/restore-azure-database-postgresql">https://learn.microsoft.com/ja-jp/azure/backup/restore-azure-database-postgresql</a></li></ul><h3 id="2-8-Azure-Database-for-MySQL-バックアップ"><a href="#2-8-Azure-Database-for-MySQL-バックアップ" class="headerlink" title=" 2.8 Azure Database for MySQL バックアップ"></a><a id="2-8"></a> 2.8 Azure Database for MySQL バックアップ</h3><p>Azure Database for MySQL をバックアップすることができます。<br>Azure Database for MySQL そのもののバックアップソリューションではデータ保有期間が最大 35 日間ですが、Azure Backup を利用することでデータを長期的 (最大 10 年間) に保有することが可能になります。<br>長期的な保有期間以外にも、バックアップの構成や復旧ポイントを一元的にバックアップ コンテナーにて管理できるメリットなどがあります。</p><h4 id="利用方法-9"><a href="#利用方法-9" class="headerlink" title="利用方法"></a>利用方法</h4><p>Azure Portal にてバックアップ コンテナーを開き、<code>バックアップ</code>を選択、<br>次にデータソースの種類で<code>Azure Database for MySQL (プレビュー)</code>を選択することでバックアップの設定を開始することができます。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/aa2621a6-3992-4712-afa1-4b5e791b7b5e" width="600px">  </p><h4 id="参照リンク-7"><a href="#参照リンク-7" class="headerlink" title="参照リンク"></a>参照リンク</h4><p>このバックアップ ソリューションの詳細については下記ドキュメントをご参照ください。  </p><ul><li>概要 - Azure Backup を使用した Azure Database for MySQL - フレキシブル サーバーの長期保有 - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-mysql-flexible-server-about">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-mysql-flexible-server-about</a></li><li>Azure Backup を使用した Azure Database for MySQL - フレキシブル サーバーの長期保有のサポート マトリックス - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-mysql-flexible-server-support-matrix">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-mysql-flexible-server-support-matrix</a></li><li>Azure Backup を使用して Azure Database for MySQL - フレキシブル サーバーをバックアップする - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-mysql-flexible-server">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-mysql-flexible-server</a></li><li>Azure Backup を使用して Azure Database for MySQL - フレキシブル サーバーを復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-mysql-flexible-server-restore">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-mysql-flexible-server-restore</a></li></ul><h3 id="2-9-MARS-バックアップ"><a href="#2-9-MARS-バックアップ" class="headerlink" title=" 2.9 MARS バックアップ"></a><a id="2-9"></a> 2.9 MARS バックアップ</h3><p>Microsoft Azure Recovery Services (MARS) エージェントを使用して、ファイル、フォルダー、およびボリュームまたはシステム状態をオンプレミスの仮想マシンまたは Azure VM から Azure にバックアップできます。<br>サポートしている OS は Windows OS のみで、Linux OS では利用いただけません。</p><h4 id="利用方法-10"><a href="#利用方法-10" class="headerlink" title="利用方法"></a>利用方法</h4><p>Azure Portal にて Recovery Services コンテナーを開き、<code>バックアップ</code>を選択、<br>次にワークロードで<code>オンプレミス</code>、バックアップ対象で<code>ファイルとフォルダー</code>を選択します。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/88985531-4431-4720-8c3c-b22e75a9abd6" width="300px">  </p><p>続いての画面で<code>Windows Server または Windows クライアント用エージェントのダウンロード</code>のリンクを選択することで、MARS エージェントをダウンロードできます。<br>インストール完了後、MARS エージェント UI からバックアップの設定を開始します。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/ef1fbc8e-1f71-432b-9dc8-cbdbaa23a5ed" width="700px">  </p><h4 id="参照リンク-8"><a href="#参照リンク-8" class="headerlink" title="参照リンク"></a>参照リンク</h4><p>このバックアップ ソリューションの詳細については下記ドキュメントをご参照ください。  </p><ul><li>MARS エージェントについて - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-about-mars">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-about-mars</a></li><li>MARS エージェントを使用したサポート マトリックス - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mars-agent">https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mars-agent</a></li><li>MARS エージェントを使用して Windows マシンをバックアップする - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-windows-with-mars-agent">https://learn.microsoft.com/ja-jp/azure/backup/backup-windows-with-mars-agent</a></li><li>MARS エージェントを使用して Windows Server にファイルを復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-restore-windows-server">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-restore-windows-server</a></li></ul><h3 id="2-10-DPM-MABS-バックアップ"><a href="#2-10-DPM-MABS-バックアップ" class="headerlink" title=" 2.10 DPM / MABS バックアップ"></a><a id="2-10"></a> 2.10 DPM / MABS バックアップ</h3><p>System Center DPM は、エンタープライズ コンピューターおよびデータのバックアップと復旧を構成、促進、および管理するエンタープライズ ソリューションです。<br>MABS は、オンプレミスの物理サーバー、VM、およびそれらで実行されているアプリをバックアップするために使用できるサーバー製品です。<br>MABS は System Center DPM に基づいており、同様の機能を提供しますが、いくつかの違いがあります。<br>詳細は、下記ドキュメントをご参照ください。</p><ul><li>MABS と System Center DPM のサポート マトリックス - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mabs-dpm#about-dpmmabs">https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mabs-dpm#about-dpmmabs</a></li></ul><h4 id="利用方法-11"><a href="#利用方法-11" class="headerlink" title="利用方法"></a>利用方法</h4><p>Azure Portal にて Recovery Services コンテナーを開き、<code>バックアップ</code>を選択、<br>次にワークロードで<code>オンプレミス</code>、バックアップ対象で MABS を使用して保護するワークロードを選択します。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/2426fa06-df5b-4dc4-b400-657115f6def0" width="300px">  </p><p>続いての画面で<code>ダウンロード</code>のリンクを選択することで、Microsoft Azure Backup Server (MABS) をダウンロードできます。<br>インストール完了後、Microsoft Azure Backup Server UI からバックアップの設定を開始します。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/db6de149-ec90-42ec-b048-f99f11076c6f" width="700px">  </p><div class="alert is-info"><p class="alert-title">Note</p><p>ファイルとフォルダーだけをバックアップする場合は、MARS を使用すること、および下記記事のガイダンスに従って操作することをお勧めします。</p><p>・ MARS エージェントを使用して Windows マシンをバックアップする - Azure Backup | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-windows-with-mars-agent">https://learn.microsoft.com/ja-jp/azure/backup/backup-windows-with-mars-agent</a>  </p></div><h4 id="復元方法"><a href="#復元方法" class="headerlink" title=" 復元方法"></a><a id="2-10-restore"></a> 復元方法</h4><p>DPM / MABS を利用してバックアップしたデータの復元方法は保護したワークロードによって異なります。<br>詳細については下記ドキュメントをご参照ください。 </p><ul><li>バックアップされた Hyper-V 仮想マシンを復旧する | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/back-up-hyper-v-virtual-machines-mabs#recover-backed-up-hyper-v-virtual-machines">https://learn.microsoft.com/ja-jp/azure/backup/back-up-hyper-v-virtual-machines-mabs#recover-backed-up-hyper-v-virtual-machines</a>  </li><li>バックアップされた仮想マシンを回復する | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/back-up-azure-stack-hyperconverged-infrastructure-virtual-machines#recover-backed-up-virtual-machines">https://learn.microsoft.com/ja-jp/azure/backup/back-up-azure-stack-hyperconverged-infrastructure-virtual-machines#recover-backed-up-virtual-machines</a>  </li><li>Azure Backup Server を使用して VMware VM を復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/restore-azure-backup-server-vmware">https://learn.microsoft.com/ja-jp/azure/backup/restore-azure-backup-server-vmware</a>  </li><li>Exchange データベースを回復する | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-exchange-mabs#recover-the-exchange-database">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-exchange-mabs#recover-the-exchange-database</a>  </li><li>MABS を使用して Azure から SharePoint データベースを復元する | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-backup-sharepoint-mabs#restore-a-sharepoint-database-from-azure-using-mabs">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-backup-sharepoint-mabs#restore-a-sharepoint-database-from-azure-using-mabs</a>  </li><li>Azure からの SQL Server データベースの回復 | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-sql-mabs#recover-a-sql-server-database-from-azure">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-sql-mabs#recover-a-sql-server-database-from-azure</a>  </li><li>システム状態または BMR の回復 | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-mabs-system-state-and-bmr#recover-system-state-or-bmr">https://learn.microsoft.com/ja-jp/azure/backup/backup-mabs-system-state-and-bmr#recover-system-state-or-bmr</a>  </li><li>バックアップされたファイル データの回復 | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/back-up-file-data#recover-backed-up-file-data">https://learn.microsoft.com/ja-jp/azure/backup/back-up-file-data#recover-backed-up-file-data</a>  </li></ul><h4 id="参照リンク-9"><a href="#参照リンク-9" class="headerlink" title="参照リンク"></a>参照リンク</h4><p>このバックアップ ソリューションの詳細については下記ドキュメントをご参照ください。  </p><ul><li>Data Protection Manager | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/system-center/dpm/dpm-overview?view=sc-dpm-2022">https://learn.microsoft.com/ja-jp/system-center/dpm/dpm-overview?view=sc-dpm-2022</a></li><li>DPM/MABS について | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mabs-dpm#about-dpmmabs">https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mabs-dpm#about-dpmmabs</a></li><li>DPM をインストールする | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/system-center/dpm/install-dpm?view=sc-dpm-2022">https://learn.microsoft.com/ja-jp/system-center/dpm/install-dpm?view=sc-dpm-2022</a></li><li>Azure Backup Server のインストールとアップグレード | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-microsoft-azure-backup">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-microsoft-azure-backup</a></li><li>MABS (Azure Backup Server) V4 の保護マトリックス - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-mabs-protection-matrix">https://learn.microsoft.com/ja-jp/azure/backup/backup-mabs-protection-matrix</a></li><li>MABS と System Center DPM のサポート マトリックス - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mabs-dpm#about-dpmmabs">https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mabs-dpm#about-dpmmabs</a></li></ul><h3 id="2-11-Azure-Kubernetes-Service-AKS-バックアップ"><a href="#2-11-Azure-Kubernetes-Service-AKS-バックアップ" class="headerlink" title=" 2.11 Azure Kubernetes Service (AKS) バックアップ"></a><a id="2-11"></a> 2.11 Azure Kubernetes Service (AKS) バックアップ</h3><p>AKS クラスターにデプロイされている AKS ワークロードと永続ボリュームをバックアップすることができます。<br>バックアップの構成や復旧ポイントの管理はバックアップ コンテナーにて行うことができます。  </p><h4 id="利用方法-12"><a href="#利用方法-12" class="headerlink" title="利用方法"></a>利用方法</h4><p>Azure Portal にてバックアップ コンテナーを開き、<code>バックアップ</code>を選択、<br>次にデータソースの種類で<code>Kubernetes サービス</code>を選択することでバックアップの設定を開始することができます。<br><img src="https://github.com/jpabrs-scem/blog/assets/109163295/872e323b-f078-4840-9479-fe2772d8a477" width="600px">  </p><h4 id="参照リンク-10"><a href="#参照リンク-10" class="headerlink" title="参照リンク"></a>参照リンク</h4><p>このバックアップ ソリューションの詳細については下記ドキュメントをご参照ください。  </p><ul><li>Azure Kubernetes Service (AKS) バックアップとは - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-kubernetes-service-backup-overview">https://learn.microsoft.com/ja-jp/azure/backup/azure-kubernetes-service-backup-overview</a></li><li>Azure Kubernetes Service (AKS) バックアップのサポート マトリックス - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-kubernetes-service-cluster-backup-support-matrix?source=recommendations">https://learn.microsoft.com/ja-jp/azure/backup/azure-kubernetes-service-cluster-backup-support-matrix?source=recommendations</a></li><li>Azure Backup を使用して Azure Kubernetes Service をバックアップする - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-kubernetes-service-cluster-backup?source=recommendations">https://learn.microsoft.com/ja-jp/azure/backup/azure-kubernetes-service-cluster-backup?source=recommendations</a></li><li>Azure Backup を使用して Azure Kubernetes Service (AKS) を復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-kubernetes-service-cluster-restore">https://learn.microsoft.com/ja-jp/azure/backup/azure-kubernetes-service-cluster-restore</a></li></ul><h2 id="3-よくいただくお問合せ"><a href="#3-よくいただくお問合せ" class="headerlink" title=" 3. よくいただくお問合せ"></a><a id="3"></a> 3. よくいただくお問合せ</h2><p>Azure Backup の各バックアップソリューションについてよくいただくお問い合わせと回答を記載させていただきます。</p><h3 id="Q1-「Azure-VM-Backup」-と-「Azure-ディスク-バックアップ」-と-「ディスクのスナップショット」-はどれを利用したらいいですか？"><a href="#Q1-「Azure-VM-Backup」-と-「Azure-ディスク-バックアップ」-と-「ディスクのスナップショット」-はどれを利用したらいいですか？" class="headerlink" title="Q1. 「Azure VM Backup」 と 「Azure ディスク バックアップ」 と 「ディスクのスナップショット」 はどれを利用したらいいですか？"></a>Q1. 「Azure VM Backup」 と 「Azure ディスク バックアップ」 と 「ディスクのスナップショット」 はどれを利用したらいいですか？</h3><p>「アプリケーション整合性を担保したバックアップを取得したい」や「Azure 仮想マシンをまるごと（マシンにアタッチされているディスクのデータを含めて）バックアップしたい」という用途であれば一般的に <strong>Azure VM Backup</strong> をご利用いただくことが多くございます。  </p><p>「Azure 仮想マシンをまるごとバックアップする必要は無い」であったり「とある Azure Managed Disk をディスク単体で定期的にバックアップすればよい」という場合は、<strong>Azure ディスク バックアップ</strong> をご検討ください。  </p><p>「1 度きりのバックアップ用途で取得しておきたい」というご要望をいただくこともあります。<br>しかし Azure VM Backup ではバックアップ ポリシーを利用しスケジュールされたバックアップを取得する運用を想定した製品仕様となっております。<br>そのため、任意のタイミングのみでバックアップを行う場合は懸念点がございますため、弊社としてはこの運用を推奨しておりません。<br>この場合、Azure Backup ではなく、ディスク側の機能である<strong>ディスクのスナップショット</strong>の利用をご検討ください。<br>詳細については下記ドキュメントにて紹介しております。</p><ul><li>Azure VM バックアップを任意のタイミングのみで取得したい | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/invalid_schedule/">https://jpabrs-scem.github.io/blog/AzureVMBackup/invalid_schedule/</a></li></ul><div class="alert is-info"><p class="alert-title">Note</p><p>「Azure ディスク バックアップ」 と 「ディスクのスナップショット」は Azure VM Backup とは異なり整合性が常にクラッシュ整合性となります。</p><p>詳細については下記をご覧ください。</p><hr><p>・Azure VM Backupにおける整合性について - 3.クラッシュ整合性</p><p>　 <a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#3">https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#3</a></p></div><h3 id="Q2-「共有ディスクのバックアップ」はできますか？"><a href="#Q2-「共有ディスクのバックアップ」はできますか？" class="headerlink" title="Q2. 「共有ディスクのバックアップ」はできますか？"></a>Q2. 「共有ディスクのバックアップ」はできますか？</h3><p>【Azure VM Backup で共有ディスクを含めてバックアップしたい場合】<br><strong>Azure VM Backup</strong> では残念ながら共有ディスクをバックアップすることはサポートしておりません。</p><p>ただし、共有ディスクがアタッチされている Azure VM に対して「共有ディスクを除外し、その他のディスクをバックアップする」ことは可能です。<br>この場合は、Azure VM Backup の「選択的ディスクバックアップ」を「Enhanced バックアップ ポリシー」を指定して利用することで実現可能です。</p><ul><li>Azure 仮想マシンの選択的なディスク バックアップと復元 - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/selective-disk-backup-restore">https://learn.microsoft.com/ja-jp/azure/backup/selective-disk-backup-restore</a></li></ul><p>【共有ディスクを「手動で任意のタイミングのみ」バックアップしたい場合】<br><strong>ディスクのスナップショット</strong>を利用して、お客様にて手動で Azure Managed Disk に対してスナップショットを取得いただく方法がございます。</p><p>【共有ディスクを「定期的に」バックアップしたい場合】<br><strong>Azure ディスク バックアップ</strong> ソリューションを利用して、定期的なバックアップ取得 (=スナップショット取得) が可能です。</p><p>また、Windows OS の Azure VM であれば、共有ディスクに対する、「ローカル ディスク」としての <strong>MARS バックアップ</strong>は可能です。</p><div class="alert is-info"><p class="alert-title">Note</p><p>MARS バックアップを利用して共有ディスクをバックアップする場合の注意点 </p><hr><p>・ 「共有ディスク」 が NTFS であり、「クラスター共有ボリューム」には割り当てられていなければ、MARS バックアップとしてバックアップは可能です。</p><p>・ MARS はクラスター リソースを識別することができませんが、ローカル ディスクとして識別されているボリュームであれば、バックアップが可能です。</p><p>・ 「クラスター サポート」とは、共有ボリュームがオンラインになっている場所 (ノード) を気にすることなく継続的にバックアップが可能であるか、という意味になりますが、MARS バックアップにおいては、これをサポートしていません。</p></div><h3 id="Q3-「Azure-VM-内の-SQL-Server-バックアップ」-または-Azure-VM-内の-SAP-HANA-と-「Azure-VM-バックアップ」の違いは何ですか？"><a href="#Q3-「Azure-VM-内の-SQL-Server-バックアップ」-または-Azure-VM-内の-SAP-HANA-と-「Azure-VM-バックアップ」の違いは何ですか？" class="headerlink" title="Q3. 「Azure VM 内の SQL Server バックアップ」 (または Azure VM 内の SAP HANA) と 「Azure VM バックアップ」の違いは何ですか？"></a>Q3. 「Azure VM 内の SQL Server バックアップ」 (または Azure VM 内の SAP HANA) と 「Azure VM バックアップ」の違いは何ですか？</h3><p>Azure VM にある SQL Serverに対し、「Azure Backup」として提供できるサービスとしては  <strong>Azure VM Backup</strong> と <strong>Azure VM 内の SQL Server をバックアップ</strong> の両方でバックアップが可能です。<br><strong>Azure VM 内の SQL Server バックアップ</strong> では データベースのみのバックアップであり、VM 自体がバックアップされません。<br>それに対して <strong>Azure VM Backup</strong> では VM 自体がバックアップされ、その中に SQL Server が存在していれば、それも含まれてバックアップされる形になります。<br>そのため、SQL Server だけでなく、VM 自体の復元が必要な場合は <strong>Azure VM Backup</strong> の利用をご検討ください。<br><strong>Azure VM Backup</strong> における整合性についての詳細は下記ドキュメントをご参照ください。  </p><ul><li>Azure VM Backupにおける整合性について | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#1-2">https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#1-2</a></li></ul><p>また、<strong>Azure VM 内の SQL Server バックアップ</strong> はデータベース ワークロードに特化したワークロードであり、 <strong>Azure VM Backup</strong> にはない、最短 15 分間の RPO (目標復旧時点) を提供し、個々のデータベースのバックアップと復元が可能です。</p><p>また、同じVM上で <strong>Azure VM Backup</strong> と <strong>Azure VM 内の SQL Server バックアップ</strong> を共存させることも可能です。<br>詳細については下記ドキュメントをご参照ください。  </p><ul><li>FAQ - Azure VM 上の SQL Server データベースのバックアップ - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/faq-backup-sql-server#iaas-vm---azure---------sql-server-----------------">https://learn.microsoft.com/ja-jp/azure/backup/faq-backup-sql-server#iaas-vm---azure---------sql-server-----------------</a>    </li></ul><h3 id="Q4-バックアップ失敗時にメールを通知するようにできますか？"><a href="#Q4-バックアップ失敗時にメールを通知するようにできますか？" class="headerlink" title="Q4. バックアップ失敗時にメールを通知するようにできますか？"></a>Q4. バックアップ失敗時にメールを通知するようにできますか？</h3><p>Azure Backup でバックアップ ジョブが失敗した際、Azure Monitor を利用してメール通知を行うように構成できます。<br>詳細は下記ドキュメントをご参照ください。</p><ul><li>「Azure Monitor を使用した組み込みのアラート」を利用したバックアップ ジョブ失敗のアラート通知作成例 | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br><a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/How_to_set_Backup_Alert/">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/How_to_set_Backup_Alert/</a></li></ul><p>お客様のお役に立てれば幸いです。<br>本記事は以上です。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートです。&lt;br&gt;今回はお問合せをいただくことが多い、Azure Backup サービスでどんなバックアップソリューションを提供しているのか、そしてそれぞれのソリューションで何をバ</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Information" scheme="https://jpabrs-scem.github.io/blog/tags/Information/"/>
    
  </entry>
  
  <entry>
    <title>ASR を意図的に失敗させる方法</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureSiteRecovery/How_to_fail_ASR/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureSiteRecovery/How_to_fail_ASR/</id>
    <published>2024-05-09T03:00:00.000Z</published>
    <updated>2024-08-27T06:06:49.065Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>みなさんこんにちは、Azure Site Recovery サポートです。<br>今回は、アラートをテスト目的で発報するために、意図的に Azure Site Recovery ( 以下、ASR ) を失敗させる方法をご紹介します。</p><p>ASR を意図的に失敗させたい場合、主に下記 2 種類の方法にて失敗させることができます。<br><font color="MediumBlue">1 種類目：</font>キャッシュ用ストレージ アカウントへの通信を切断しておく<br><font color="MediumBlue">2 種類目：</font>ASR レプリケーションに関わるサービスをソース マシン上で停止しておく</p><p>本ブログ記事では [Azure VM to Azure VM (ASR)] シナリオを例として、上記の具体的な作業手順を説明します。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. キャッシュ用ストレージ アカウントへの通信を切断しておく方法</a><br><a href="#2">2. ASR レプリケーションに関わるサービスをソース マシン上で停止しておく方法</a><br><a href="#2-1">2-1. ASR レプリケーションに関わるサービスをソース マシン上で停止しておく方法 (Winodws OS 詳細)</a><br><a href="#2-2">2-2. ASR レプリケーションに関わるサービスをソース マシン上で停止しておく方法 (Linux OS 詳細)</a>  </p><hr><h2 id="1-キャッシュ用ストレージ-アカウントへの通信を切断しておく方法"><a href="#1-キャッシュ用ストレージ-アカウントへの通信を切断しておく方法" class="headerlink" title=" 1. キャッシュ用ストレージ アカウントへの通信を切断しておく方法"></a><a id="1"></a> 1. キャッシュ用ストレージ アカウントへの通信を切断しておく方法</h2><p>もっとも簡単な方法として、キャッシュ用ストレージ アカウント側の「ネットワーク」設定にて<br>「パブリック ネットワーク アクセス：無効」へと設定しておくことで<br>ソース マシンからキャッシュ用ストレージ アカウントへの通信を行うことができず、後続の ASR レプリケーション処理が失敗します。</p><p>・(参考) アラートのシナリオ<br>　<a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/site-recovery-monitor-and-troubleshoot#alerts-scenarios">https://learn.microsoft.com/ja-jp/azure/site-recovery/site-recovery-monitor-and-troubleshoot#alerts-scenarios</a><br>　“Azure Site Recovery を使用してテスト VM のアラートの動作をテストするには、キャッシュ ストレージ アカウントのパブリック ネットワーク アクセスを無効にし、”レプリケーションの正常性に重大な問題があります” アラートが生成されるようにします。”</p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/afe22e08-e0f1-458a-992f-93c1b2801242"></p><p>(画面例 : ストレージ アカウントの「パブリック ネットワーク アクセス」を変更しておよそ 15 分経過後)<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/4aeef23e-96de-448a-ae3c-b9ac0452d03d"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/4bf46334-3c31-4ba0-859e-a3e10cef60b4"></p><p>今回は事前に下記 2 種類のアラートをどちらも構成していたため、2 種類のメールアラートが発報されました。</p><p>・アラートの電子メール通知<br>　　<a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/site-recovery-monitor-and-troubleshoot#subscribe-to-email-notifications">https://learn.microsoft.com/ja-jp/azure/site-recovery/site-recovery-monitor-and-troubleshoot#subscribe-to-email-notifications</a></p><p>・Azure Site Recovery に関する組み込みの Azure Monitor アラート<br>　<a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/site-recovery-monitor-and-troubleshoot#built-in-azure-monitor-alerts-for-azure-site-recovery-preview">https://learn.microsoft.com/ja-jp/azure/site-recovery/site-recovery-monitor-and-troubleshoot#built-in-azure-monitor-alerts-for-azure-site-recovery-preview</a></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/0492797a-82f9-42d4-a964-84cfa9bc6283"></p><p>・(参考) Recovery Services コンテナーの Azure Site Recovery の現在の電子メール通知ソリューションは、引き続き動作しますか?<br>　<a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/monitoring-common-questions#will-the-current-email-notification-solution-for-azure-site-recovery-in-recovery-services-vault-continue-to-work">https://learn.microsoft.com/ja-jp/azure/site-recovery/monitoring-common-questions#will-the-current-email-notification-solution-for-azure-site-recovery-in-recovery-services-vault-continue-to-work</a><br>　“現在のところ、既存の電子メール通知ソリューションは、新しい組み込みの Azure Monitor アラート ソリューションと共存しています。<br>　　新しいエクスペリエンスに慣れ、その機能を活用するために、Azure Monitor ベースのアラートを試すことをお勧めします。”</p><p>(メール例 : アラートの電子メール通知)<br>件名：Azure Site Recovery Critical Notification: Virtual machine health is in Critical state<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/2ad19e58-cb8c-45cf-b319-05bbcf452c0a"></p><p>(メール例 : 組み込みの Azure Monitor アラート)<br>件名：Fired:Sev1 Azure Monitor Alert Replication health changed to Critical. on rsv-jpe-lrs ( microsoft.recoveryservices/vaults ) at 5/2/2024 7:13:49 AM<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/e28912a0-d6e6-447b-94ac-b2a68199dda0"></p><h2 id="2-ASR-レプリケーションに関わるサービスをソース-マシン上で停止しておく方法"><a href="#2-ASR-レプリケーションに関わるサービスをソース-マシン上で停止しておく方法" class="headerlink" title=" 2. ASR レプリケーションに関わるサービスをソース マシン上で停止しておく方法"></a><a id="2"></a> 2. ASR レプリケーションに関わるサービスをソース マシン上で停止しておく方法</h2><p>【Windows OS の場合】<br>ソース マシン上の「サービス」画面にて、下記 2 つのサービスを停止することでレプリケーションができなくなり、アラートを発報可能です。<br>(1) InMage Scout Application Service<br>(2) InMage Scout VX Agent - Sentinel/Outpost</p><p>【Linux OS の場合】<br>ソース マシン上で「vxagent」サービスを停止することでレプリケーションができなくなり、アラートを発報可能です。</p><h2 id="2-1-ASR-レプリケーションに関わるサービスをソース-マシン上で停止しておく方法-Winodws-OS-詳細"><a href="#2-1-ASR-レプリケーションに関わるサービスをソース-マシン上で停止しておく方法-Winodws-OS-詳細" class="headerlink" title=" 2-1. ASR レプリケーションに関わるサービスをソース マシン上で停止しておく方法 (Winodws OS 詳細)"></a><a id="2-1"></a> 2-1. ASR レプリケーションに関わるサービスをソース マシン上で停止しておく方法 (Winodws OS 詳細)</h2><p>「サービス」画面を開きます。<br>Services.msc<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/eaccd3a8-bd09-472c-be4b-cf4f092ef063"></p><p>下記 2 つのサービスを手動で停止します。<br>(1) InMage Scout Application Service<br>(2) InMage Scout VX Agent - Sentinel/Outpost<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/5fb4fd79-d6b4-40ce-bfcf-23b6aa4939f8"></p><p>自動起動しないようスタートアップの種類を [無効] に変更しておきます。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/f86d6864-9a4e-4d80-afa0-04747af1efe0"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/ac2c5b20-acbf-4ed8-bad9-029d54671ffd"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/5646e521-e505-4b60-b8f8-fc65e178d481"></p><p>(画面例 : サービスを停止しておよそ 15 分経過後)<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/dcf49eb8-9cfb-40f5-81c9-c2427a0d2e90"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/39b38c4c-e570-42c7-bec6-ff11d9ce0675"></p><p>(メール例 : 組み込みの Azure Monitor アラート)<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/02b07554-4630-44e2-a318-92bee9beffef"></p><p>テスト終了後は、2 つのサービスの状態を元に戻しておきます。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/7310c3f1-6cc8-419c-87b4-7bfc8c52e0a7"></p><h2 id="2-2-ASR-レプリケーションに関わるサービスをソース-マシン上で停止しておく方法-Linux-OS-詳細"><a href="#2-2-ASR-レプリケーションに関わるサービスをソース-マシン上で停止しておく方法-Linux-OS-詳細" class="headerlink" title=" 2-2. ASR レプリケーションに関わるサービスをソース マシン上で停止しておく方法 (Linux OS 詳細)"></a><a id="2-2"></a> 2-2. ASR レプリケーションに関わるサービスをソース マシン上で停止しておく方法 (Linux OS 詳細)</h2><p>ソース マシン上で「vxagent」サービスを停止することでレプリケーションができなくなり、アラートを発報可能です。</p><p>今回は例として SLES OS の マシン上で「vxagent」サービスを停止してみます。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/f3591578-9a1d-4706-ac73-2cdf6eda9e06"></p><p>「vxagent」サービスの状態を確認します。<br>正常にレプリケーションできているマシンの場合、下図のように「active」と表示される見込みです。<br><code>systemctl status vxagent</code><br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/324db4e7-aa8f-4219-a558-e20476f59f07"></p><p>「vxagent」サービスの状態を停止します。<br><code>systemctl stop vxagent</code><br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/7a1faaa4-5d05-4183-9c89-bc844ae7e175"></p><p>「vxagent」サービスが「inactive」になったことを確認します。<br><code>systemctl status vxagent</code><br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/2cdaee3b-171e-467e-92d4-3bfc4035f2c3"></p><p>(画面例 : サービスを停止しておよそ 15 分経過後)<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/f903603e-df14-4ebb-91cf-ca700c7b558e"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/34680ce3-f95a-417c-9e22-154834dddcfb"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/d028d22d-5e85-41dc-aa03-ba6e833d67b9"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/eb57c071-60b7-4ada-8c86-28aeca3403e8"></p><p>(メール例 : 組み込みの Azure Monitor アラート)<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/04ba8b03-5db7-487a-b8de-fc6f99014356"></p><p>テスト終了後は、「vxagent」サービスを元に戻しておきます。<br><code>systemctl start vxagent</code></p><p><code>systemctl status vxagent</code><br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/04ae5d93-c899-4a89-a54a-34ccd0d43b1c"></p><p>ASR を意図的に失敗させる方法の案内は、以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;みなさんこんにちは、Azure Site Recovery サポートです。&lt;br&gt;今回は、アラートをテスト目的で発報するために、意図的に Azure Site Recovery ( 以下、ASR ) を失敗させる方法をご紹介し</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure Site Recovery" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Site-Recovery/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup でリストアする際に利用するステージングの場所として利用するストレージ アカウントについて</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/RestoreStagingStorageAccount/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/RestoreStagingStorageAccount/</id>
    <published>2024-05-09T03:00:00.000Z</published>
    <updated>2024-08-27T06:06:49.065Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Backup サポートです。<br>今回は、Azure VM Backup でリストアする際に利用するステージングの場所として利用するストレージ アカウントについて、下記の通りお伝えします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. 公開情報 (Docs)</a><br><a href="#2">2. 利用できるストレージ アカウント</a><br><a href="#3">3. リストアされた後にストレージ アカウントに残るファイルについて</a><br><a href="#4">4. 参考画面ショット</a></p><hr><h3 id="1-公開情報-Docs"><a href="#1-公開情報-Docs" class="headerlink" title="1. 公開情報 (Docs)"></a><a id="1"></a>1. 公開情報 (Docs)</h3><p>まず最初に、本件に関する Docs は下記でございます。<br>・ストレージ アカウント - Azure portal で Azure VM データを復元する方法<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#storage-accounts">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#storage-accounts</a></p><blockquote><p>抜粋:”Vault-Standard 復元ポイントからマネージド VM のディスクを復元するときに、マネージド ディスクと Azure Resource Manager (ARM) テンプレートが、ステージング場所にあるディスクの VHD ファイルと共に復元されます。 インスタント復元ポイントからディスクを復元する場合、マネージド ディスクと ARM テンプレートのみが復元されます。”</p></blockquote><blockquote><p>抜粋:リージョン間復元では、 ステージング場所 (ストレージ アカウントの場所) は、Recovery Services コンテナーが セカンダリ リージョンとして扱うリージョンに存在する必要があります。 たとえば、Recovery Services コンテナーは米国東部 2 リージョンにあります (geo 冗長性とリージョン間復元が有効になっています)。 これは、セカンダリ リージョンは米国中部であることを意味します。 そのため、VM のリージョン間復元を行なうには、米国中部でストレージ アカウントを作成する必要があります。<br><a href="https://learn.microsoft.com/ja-jp/azure/availability-zones/cross-region-replication-azure">すべての地域の Azure リージョン間レプリケーションのペアリングに関する記事</a>をご覧ください。</p></blockquote><h3 id="2-利用できるストレージ-アカウント"><a href="#2-利用できるストレージ-アカウント" class="headerlink" title="2. 利用できるストレージ アカウント"></a><a id="2"></a>2. 利用できるストレージ アカウント</h3><p>選択できるストレージ アカウントは下記の条件を満たすものです。<br>・リストア先 (=ターゲット) のサブスクリプション内およびコンテナーと同じリージョンにある<br>・ZRS 以外の冗長性 (LRS・GRS)<br>・Premium Storage アカウントではない<br>・(ストレージアカウントのネットワーク設定でパブリックアクセスが制限されている場合) 例外の “信頼されたサービスの一覧にある Azure サービスがこのストレージ アカウントにアクセスすることを許可します” をチェックしている<br>・階層型名前空間 (HierarchicalNamespace) が有効化されていない</p><h3 id="3-リストアされた後にストレージ-アカウントに残るファイルについて"><a href="#3-リストアされた後にストレージ-アカウントに残るファイルについて" class="headerlink" title="3.リストアされた後にストレージ アカウントに残るファイルについて"></a><a id="3"></a>3.リストアされた後にストレージ アカウントに残るファイルについて</h3><p>マネージドディスクの Azure VM の復元が完了しますと対象のストレージ アカウントの中に下記のファイルが残ります。<br>下記の通り、ストレージ アカウントにファイルが残るかおよび、どのファイルが残るかはリストア シナリオによって異なります。</p><table><thead><tr><th align="left">#</th><th align="left"></th><th align="left">リストアシナリオ</th><th align="left">ステージングのストレージ アカウントに残るファイル</th></tr></thead><tbody><tr><td align="left"></td><td align="left"></td><td align="left"><strong>Recovery Services コンテナー (vault-standrd) 層からのリストア</strong></td><td align="left"></td></tr><tr><td align="left">1</td><td align="left"></td><td align="left">新規 VM 作成</td><td align="left">無し</td></tr><tr><td align="left">2</td><td align="left"></td><td align="left">ディスクの復元</td><td align="left">VHD ファイルと json ファイル</td></tr><tr><td align="left">3</td><td align="left"></td><td align="left">既存の置換え</td><td align="left">VHD ファイル</td></tr><tr><td align="left"></td><td align="left"></td><td align="left"><strong>スナップショット 層からのリストア (インスタントリストア)</strong></td><td align="left"></td></tr><tr><td align="left">4</td><td align="left"></td><td align="left">新規 VM 作成</td><td align="left">無し</td></tr><tr><td align="left">5</td><td align="left"></td><td align="left">ディスクの復元</td><td align="left">json ファイル</td></tr><tr><td align="left">6</td><td align="left"></td><td align="left">既存の置換え</td><td align="left">無し</td></tr><tr><td align="left"></td><td align="left"></td><td align="left"><strong>クロスリージョン リストア</strong></td><td align="left"></td></tr><tr><td align="left">7</td><td align="left"></td><td align="left">新規 VM 作成</td><td align="left">無し</td></tr><tr><td align="left">8</td><td align="left"></td><td align="left">ディスクの復元</td><td align="left">VHD ファイルと json ファイル</td></tr></tbody></table><p>これらのファイルはリストア後自動では削除されませんが、手動で削除することが可能です。</p><h3 id="4-参考画面ショット"><a href="#4-参考画面ショット" class="headerlink" title="4.参考画面ショット"></a><a id="4"></a>4.参考画面ショット</h3><p> VM 名：VM-RHEL-PE という Azure VM (OS ディスク 1 つ、データディスク 2 つ) を (2) の既存の置換えにてリストアしたあとのストレージ アカウントです。</p><p> <img src="https://user-images.githubusercontent.com/71251920/198330594-30a09f02-cb39-41c8-ae39-1ab9a21779ac.png"></p><blockquote><p>コンテナー名：<br> vmrhelpe-51f2bd236a2e479a95cfc2bdd53b986c<br> 上記の通り、Azure VM 名にランダムな文字列のコンテナー名のコンテナーが作成されます。</p></blockquote><blockquote><p>VHD：<br> vmrhelpe-datadisk-000-20220319-233028.vhd<br> vmrhelpe-datadisk-001-20220319-233028.vhd<br> vmrhelpe-osdisk-20220319-233028.vhd<br> 上記の通り、Azure VM 名にディスク種別および LUN 番号リストア日時 (UTC表記) が付加された vhd ファイルが作成されます。</p></blockquote><blockquote><p>json：<br> azuredeployf08911fe-654a-49e1-9baa-41ca15cbb272.json<br> config-sqlvm13-f08911fe-654a-49e1-9baa-41ca15cbb272.json<br> parameterf08911fe-654a-49e1-9baa-41ca15cbb272.json<br> 上記の通り、<br> 「azuredeploy&lt;リストア ジョブで使用されるJob ID&gt;」<br> 「config-&lt;VM 名&gt;-&lt;リストア ジョブで使用されるJob ID&gt;」<br> 「parameter&lt;リストア ジョブで使用されるJob ID&gt;」の名前から始まるファイルが 3 つ作成されます。</p></blockquote><p>「Job ID」は、コマンドからの確認や、Recovery Services コンテナー &gt; バックアップ ジョブ &gt; 「ジョブのエクスポート」より確認ができます。</p><p>・ジョブをエクスポートする<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-manage-windows-server#export-jobs">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-manage-windows-server#export-jobs</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、Azure VM Backup でリストアする際に利用するステージングの場所として利用するストレージ アカウントについて、下記の通りお伝えします。&lt;/p&gt;
&lt;</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>テナント制限により Microsoft Entra ID (旧称 Azure Active Directory) 向けの通信に失敗する</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureSQLBackup/CommunicationFails-DueTo-TenantRestrictions/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureSQLBackup/CommunicationFails-DueTo-TenantRestrictions/</id>
    <published>2024-05-08T03:00:00.000Z</published>
    <updated>2024-08-27T06:06:49.065Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>みなさんこんにちは、Azure Backup サポートです。</p><p>MARS バックアップや SQL Server バックアップなどのバックアップにおいて、お客様によってはバックアップや復元で使用する通信がプロキシを経由する構成とされていることがあります。<br>ご利用のプロキシでテナント制限の構成をしている場合、Microsoft Entra ID (旧称 Azure Active Directory) への通信ができず、バックアップ対象のサーバーからバックアップサービス利用のための Azure 認証が失敗することで、バックアップの有効化をはじめとした各種操作ができないことがあります。 </p><p>このブログでは、バックアップ対象のサーバーのプロキシ環境でテナント制限をしている場合のバックアップの失敗について、テナント制限が原因でバックアップが失敗しているかの判断方法と対応方法について記載してます。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. テナント制限とは</a><br><a href="#2">2. テナント制限されている場合の判断方法について (Azure Portal へのログインによる確認)</a><br><a href="#3">3. テナント制限されている場合の判断方法について (Backup のログからの確認)</a><br><a href="#4">4. 回避策について</a></p><hr><h2 id="1-テナント制限とは"><a href="#1-テナント制限とは" class="headerlink" title=" 1.  テナント制限とは"></a><a id="1"></a> 1.  テナント制限とは</h2><p>以下のブログ引用に記載がございますが、テナント制限をすることでプロキシを経由した通信について特定の Microsoft Entra ID テナント以外のアクセスが制限されます。　</p><p>・ブログ引用</p><blockquote><p>テナント制限の機能では、ユーザーがアクセス可能な Azure AD テナントを制限することが可能です。<br>具体的には、クライアント端末から Azure AD に対する認証の通信をプロキシ経由させ、そのプロキシから送信されるデータに許可対象の Azure AD テナントの情報を付与します。その結果、それ以外の Azure AD テナントへのアクセスがブロックされる動作となります。</p></blockquote><p>・テナント制限とは | テナント制限について<br><a href="https://jpazureid.github.io/blog/azure-active-directory/tenant-restriction/#%E3%83%86%E3%83%8A%E3%83%B3%E3%83%88%E5%88%B6%E9%99%90%E3%81%A8%E3%81%AF">https://jpazureid.github.io/blog/azure-active-directory/tenant-restriction/#%E3%83%86%E3%83%8A%E3%83%B3%E3%83%88%E5%88%B6%E9%99%90%E3%81%A8%E3%81%AF</a></p><h2 id="2．テナント制限されている場合の判断方法について-Azure-Portal-へのログインによる確認"><a href="#2．テナント制限されている場合の判断方法について-Azure-Portal-へのログインによる確認" class="headerlink" title=" 2．テナント制限されている場合の判断方法について (Azure Portal へのログインによる確認)"></a><a id="2"></a> 2．テナント制限されている場合の判断方法について (Azure Portal へのログインによる確認)</h2><p>バックアップ対象のサーバーから Azure Potal を利用しテナント制限によって許可されていないテナントへアクセスを試行すると、 「ネットワーク管理者によってアクセスがブロックされました」という以下のようなエラーメッセージが表示されます。 (エラーコード: AADSTS500021)<br>このメッセージを確認できた場合、テナント制限によりサーバーからのテナントアクセスが制限されていると判断できます。</p><p><img src="https://github.com/jpabrs-scem/blog/assets/141223502/f09cf41b-6620-4d25-841d-35cbe978f184" alt="image"></p><p>・テナント制限とは | テナント制限について<br><a href="https://jpazureid.github.io/blog/azure-active-directory/tenant-restriction/#%E3%83%86%E3%83%8A%E3%83%B3%E3%83%88%E5%88%B6%E9%99%90%E3%81%A8%E3%81%AF">https://jpazureid.github.io/blog/azure-active-directory/tenant-restriction/#%E3%83%86%E3%83%8A%E3%83%B3%E3%83%88%E5%88%B6%E9%99%90%E3%81%A8%E3%81%AF</a></p><p>以下のドキュメント引用からもテナント制限されている場合に出力されるエラーコードであることがわかります。</p><p>・ドキュメント引用</p><blockquote><p>AADSTS500021<br>‘{tenant}’ テナントへのアクセスが拒否されました。 AADSTS500021 は、テナント制限機能が構成されており、ユーザーが、ヘッダー Restrict-Access-To-Tenant で指定されている許可されたテナントの一覧にないテナントにアクセスしようとしていることを示します。 </p></blockquote><p>・Microsoft Entra 認証と承認のエラー コード<br><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/reference-error-codes">https://learn.microsoft.com/ja-jp/azure/active-directory/develop/reference-error-codes</a></p><h2 id="3．テナント制限されている場合の判断方法について-Backup-のログからの確認"><a href="#3．テナント制限されている場合の判断方法について-Backup-のログからの確認" class="headerlink" title=" 3．テナント制限されている場合の判断方法について (Backup のログからの確認)"></a><a id="3"></a> 3．テナント制限されている場合の判断方法について (Backup のログからの確認)</h2><p>バックアップ対象のサーバーのログからもテナント制限されているか確認することができます。<br>各ログに「AADSTS500021」の文字列がある場合、テナント制限されていると判断できます。</p><p>以下にログファイル名とログが格納されるディレクトリをご案内します。<br>(ログが格納されるディレクトリは既定の設定の場合を示しています)</p><h4 id="＜Azure-Backup-for-SQL-in-VM-の場合＞"><a href="#＜Azure-Backup-for-SQL-in-VM-の場合＞" class="headerlink" title="＜Azure Backup for SQL in VM の場合＞"></a>＜Azure Backup for SQL in VM の場合＞</h4><p>・ログファイル名<br>　WorkloadExtensionHandlerXX.log<br>・ディレクトリ<br>　WindowsAzure\Logs\Plugins\Microsoft.Azure.RecoveryServices.WorkloadBackup.AzureBackupWindowsWorkload\バージョン\WorkloadExtnLogFolder<br>・エラー出力例 </p><blockquote><p>Microsoft.IdentityModel.Clients.ActiveDirectory.AdalServiceException:<br>　AADSTS500021: Access to ‘IDMAADTenantjpepod01’ tenant is denied.</p></blockquote><h4 id="＜Microsoft-Azure-Recovery-Services-MARS-の場合＞"><a href="#＜Microsoft-Azure-Recovery-Services-MARS-の場合＞" class="headerlink" title="＜Microsoft Azure Recovery Services (MARS) の場合＞"></a>＜Microsoft Azure Recovery Services (MARS) の場合＞</h4><p>・ログファイル名<br>　CBEngine XX.errlog<br>・ディレクトリ<br>　C:\Program Files\Microsoft Azure Recovery Services Agent\Temp<br>・ディレクトリ(MABS)<br>　C:\Program Files\Microsoft Azure Backup Server\DPM\MARS\Microsoft Azure Recovery Services Agent\Temp\<br>・エラー出力例 </p><blockquote><p>WARNING Exception in GetAADToken | Params: {Data = }{Message = AADSTS500021: Access to ‘IDMAADTenantjpepod01’ tenant is denied.</p></blockquote><h2 id="4．回避策について"><a href="#4．回避策について" class="headerlink" title=" 4．回避策について"></a><a id="4"></a> 4．回避策について</h2><p>バックアップが失敗している対象サーバーから「AADSTS500021」のメッセージが出力されている場合、テナント制限が原因でバックアップが失敗している可能性がございます。<br>ご利用のプロキシ環境において、以下テナントへのアクセス許可設定についてご確認ください。 </p><p>Azure Backup では、O365 の以下のテナントに接続が必要です。<br>以下は、バックアップ利用の際に使用されるテナントになります。</p><p>IDMServiceAADTenant&lt;リージョン&gt;pod01.onmicrosoft.com</p><p>お客様の環境のリージョンに合わせて、以下テナントのアクセスを許可してください。<br>※現時点でテナント名やテナント ID の公開情報はないため、以下のリージョン以外のテナント名やテナント ID の確認がご希望の場合、Azure Backup の窓口へお問い合わせをお願いいたします。</p><h4 id="＜東日本リージョンの-Azure-Backup-のテナント情報＞"><a href="#＜東日本リージョンの-Azure-Backup-のテナント情報＞" class="headerlink" title="＜東日本リージョンの Azure Backup のテナント情報＞"></a>＜東日本リージョンの Azure Backup のテナント情報＞</h4><p>テナント名 : IDMServiceAADTenantjpepod01.onmicrosoft.com<br>テナント ID : 6e92595a-0b9c-49e4-a1e9-884d0ab4f4f0</p><h4 id="＜西日本リージョンの-Azure-Backup-のテナント情報＞"><a href="#＜西日本リージョンの-Azure-Backup-のテナント情報＞" class="headerlink" title="＜西日本リージョンの Azure Backup のテナント情報＞"></a>＜西日本リージョンの Azure Backup のテナント情報＞</h4><p>テナント名 : IDMAADTenantjpwpod01.onmicrosoft.com<br>テナント ID : 4617fbbe-e76e-4071-90cd-6f5e7f5d5244</p><blockquote><p>備考：<br>テナント制限の操作に関してご確認したい場合、Entra ID のお問合せをお願いいたします。<br>専門のエンジニアが対応することで円滑で正確な対応が可能となります。</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;みなさんこんにちは、Azure Backup サポートです。&lt;/p&gt;
&lt;p&gt;MARS バックアップや SQL Server バックアップなどのバックアップにおいて、お客様によってはバックアップや復元で使用する通信がプロキシを経</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure SQL Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-SQL-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup にて取得した復元ポイントの保持期限を確認する方法</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToCheckRetentionPeriodForVMBackup/</id>
    <published>2024-05-08T03:00:00.000Z</published>
    <updated>2024-08-27T06:06:49.065Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、<strong>Azure VM Backup にて取得した復元ポイントの保持期限を確認する方法</strong> について、ご案内いたします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. スケジュール バックアップにて取得した復元ポイントの保持期限を確認されたい場合</a><br><a href="#2">2. 「今すぐバックアップ」にて取得した復元ポイントの保持期限を確認されたい場合</a><br> <a href="#2-1"> 2-1. Azure ポータル画面から確認する</a><br> <a href="#2-2"> 2-2. Azure ポータル画面より、定期的に csv へエクスポートする</a><br><a href="#3">3. 参考 - 改善リクエストについて</a></p><hr><h2 id="1-スケジュール-バックアップにて取得した復元ポイントの保持期限を確認されたい場合"><a href="#1-スケジュール-バックアップにて取得した復元ポイントの保持期限を確認されたい場合" class="headerlink" title="1. スケジュール バックアップにて取得した復元ポイントの保持期限を確認されたい場合"></a>1. スケジュール バックアップにて取得した復元ポイントの保持期限を確認されたい場合<a id="1"></a></h2><p>スケジュール バックアップにて取得する復元ポイントは、バックアップ ポリシーにて設定した保持期限に従って保持されますので、設定しているバックアップ ポリシーを参照ください。</p><p>Recovery Services コンテナー ＞ バックアップ ポリシー にて確認可能です。<br>もしくは、下図のように Recovery Services コンテナー ＞ バックアップ アイテム ＞ Azure Virtual Machine ＞ 対象の仮想マシンを選択し、「バックアップ ポリシー」を確認可能です。</p><p><img src="https://user-images.githubusercontent.com/71251920/151015032-1fe8bebd-1246-42f0-9ff0-8a511b7c9ef0.png" alt="HowToCheckRetentionPeriodForVMBackup_01"></p><h2 id="2-「今すぐバックアップ」にて取得した復元ポイントの保持期限を確認されたい場合"><a href="#2-「今すぐバックアップ」にて取得した復元ポイントの保持期限を確認されたい場合" class="headerlink" title="2. 「今すぐバックアップ」にて取得した復元ポイントの保持期限を確認されたい場合"></a>2. 「今すぐバックアップ」にて取得した復元ポイントの保持期限を確認されたい場合<a id="2"></a></h2><h3 id="2-1-Azure-ポータル画面から確認する"><a href="#2-1-Azure-ポータル画面から確認する" class="headerlink" title="2-1. Azure ポータル画面から確認する"></a>2-1. Azure ポータル画面から確認する<a id="2-1"></a></h3><p>以下のいずれかの方法で「今すぐバックアップ」にて取得した復元ポイントの保持期限の確認が可能です。</p><p>＜バックアップ ジョブから確認する場合＞</p><p>「今すぐバックアップ」にて取得した復元ポイントの保持期限は、Azure ポータル画面上の「バックアップ ジョブ」画面から確認可能です。<br>対象のRecovery Services コンテナー ＞ バックアップ ジョブ ＞ 「View details」をクリックいただき、「Recovery Point Expiry Time in UTC」欄をご確認ください。</p><p>・復旧ポイントの管理<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/manage-recovery-points#frequently-asked-question">https://docs.microsoft.com/ja-jp/azure/backup/manage-recovery-points#frequently-asked-question</a></p><p><img src="https://user-images.githubusercontent.com/71251920/151015030-46e75c4e-f1a8-4109-8bf1-4ae1234f1363.png" alt="HowToCheckRetentionPeriodForVMBackup_02"></p><p><img src="https://user-images.githubusercontent.com/71251920/151015028-5fcc5364-1da2-4ea8-9221-60b40294dd07.png" alt="HowToCheckRetentionPeriodForVMBackup_03"></p><p>なお、復元ポイントの保持期限情報を含めた、Azure ポータル画面上のバックアップ ジョブ情報の保持期間は、最大 6 か月間でございます。<br>（弊社検証環境にて確認したところ、現状 1 年以上前のバックアップ ジョブも確認はできましたが、仕様としては 6 か月間となっております）<br>そのため、6 か月以上前の バックアップ ジョブ履歴を保持し、オンデマンド バックアップにて取得したバックアップ ポイントの保持期限を確認されたい場合は<a href="#2-2"> csv へのエクスポート </a>をご検討ください。</p><p>＜バックアップ項目から確認する場合＞</p><p>「今すぐバックアップ」にて取得した復元ポイントの保持期限は、Azure ポータル画面上の「バックアップ項目」画面からも確認可能です。<br>対象のRecovery Services コンテナー ＞ バックアップ アイテム ＞ バックアップ対象の VM の「View details」をクリックいただき、バックアップ項目の「有効期限」欄をご確認ください。</p><p><img src="https://github.com/jpabrs-scem/blog/assets/141223502/a84cdb6c-8520-42de-9ceb-e2270ddaebea" alt="image"></p><p>なお、「有効期限」はUTC表記となります。<br>「有効期限」は、スナップショット層に保管されている復元ポイントについては、「インスタント回復スナップショットの保有期間」が表示される仕様となっております。</p><h3 id="2-2-Azure-ポータル画面より、定期的に-csv-へエクスポートする"><a href="#2-2-Azure-ポータル画面より、定期的に-csv-へエクスポートする" class="headerlink" title="2-2.Azure ポータル画面より、定期的に csv へエクスポートする"></a>2-2.Azure ポータル画面より、定期的に csv へエクスポートする<a id="2-2"></a></h3><p>対象の Recovery Services コンテナー ＞ バックアップ ジョブから、「Filter」にて任意の期間等を選択いただき、バックアップ ジョブが存在するうちに「Export jobs」を実施いただきますよう、お願いいたします。<br> <img src="https://user-images.githubusercontent.com/71251920/151015023-bd46a1cd-a3ec-4d7a-8bd6-942be9442e64.png" alt="HowToCheckRetentionPeriodForVMBackup_04"><br> <img src="https://user-images.githubusercontent.com/71251920/151015021-d768d177-6836-42da-acd7-92b6ff6fa2d9.png" alt="HowToCheckRetentionPeriodForVMBackup_05"><br> <img src="https://user-images.githubusercontent.com/71251920/151015016-3fa5aebe-b792-4c4a-9a06-d316eb9c6262.png" alt="HowToCheckRetentionPeriodForVMBackup_07"><br> <img src="https://user-images.githubusercontent.com/71251920/151015012-5a6e4247-66a7-4c5a-83d8-25d17feb149c.png" alt="HowToCheckRetentionPeriodForVMBackup_08"></p><h2 id="3-参考-改善リクエストについて"><a href="#3-参考-改善リクエストについて" class="headerlink" title="3. 参考 - 改善リクエストについて"></a>3. 参考 - 改善リクエストについて<a id="3"></a></h2><p>・現状は「今すぐバックアップ」で取得した復元ポイントの保持期限は、Azure ポータル画面＞バックアップ ジョブからのみ確認可能<br>・Azure ポータル画面＞バックアップ ジョブ は、6 か月で表示が切れる仕様のため、すべての情報を保持したい場合は、最低 6 か月ごとにAzure ポータル画面からCSVエクスポートを手動で行う必要がある<br>（Azure PowerShell 、Azure CLI 、REST API にて「保持期限」を含めたバックアップ ジョブの確認やExportは不可な状況）<br>上記の仕様については、お客様よりコマンド実行で保持期限を取得できるようにするなど、利便性を向上してほしいとのこと、ご要望をいただいております。<br>そのため下記サイトにて、弊社開発部門へ機能の改善リクエストを投稿しております。<br>下記サイトは、お客様が希望する機能がない場合にお客様から、弊社開発部門へ機能のリクエストを上げることができるサイトとなっております。<br><a href="https://feedback.azure.com/d365community/idea/fb238a80-2954-ec11-a81a-6045bd78b970">https://feedback.azure.com/d365community/idea/fb238a80-2954-ec11-a81a-6045bd78b970</a></p><p>当サイトは多数の要望がリクエストされ、投票数が多いものから機能改修の検討がなされますため、現状仕様の改善をご要望の場合は、可能であれば下図「投票数」のボタンをクリックいただけますと幸いです。<br>（「投票」時はマイクロソフト アカウントが必須となります）<br><img src="https://user-images.githubusercontent.com/71251920/151015009-70369f7e-c5fb-4ea2-8ff9-5f082f44e64b.png" alt="HowToCheckRetentionPeriodForVMBackup_09"></p><p>Azure VM Backup にて取得した復元ポイントの保持期限を確認する方法について、ご案内は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、&lt;strong&gt;Azure VM Backup にて取得した復元ポイントの保持期限を確認する方法&lt;/strong&gt; について、ご案内いたします。&lt;/p&gt;
</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Recovery Services コンテナーとバックアップ コンテナーについて</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RSV_BV/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RSV_BV/</id>
    <published>2024-04-30T03:00:00.000Z</published>
    <updated>2024-08-27T06:06:49.037Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Backup サポートです。<br>今回は、 Azure バックアップ ソリューションで利用する Recovery Services コンテナーとバックアップ コンテナーのバックアップ対象の違いについてご説明します。<br> Recovery Services コンテナーとバックアップ コンテナーはバックアップ対象 (バックアップソリューション) の違いにより使い分ける必要がございます。<br> また、<strong>バックアップセンターは サブスクリプション内の Recovery Services コンテナーやバックアップ コンテナー (およびそれぞれのコンテナーでバックアップしているバックアップアイテム) を統合管理するための管理画面です。</strong></p><p><img src="https://user-images.githubusercontent.com/71251920/216895782-33a2539d-b199-466a-ba15-1184b2ad0552.png" alt=" Azure Backup 関連のリソース"></p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. バックアップソリューションとコンテナー、およびデータ保存先の比較表</a><br><a href="#2">2. コンテナーにバックアップデータが保存されないもの</a><br><a href="#2-1">2-1. Azure ファイル共有バックアップ (スナップショット レベル)</a><br><a href="#2-2">2-2. Azure Blob バックアップ (運用バックアップ)</a><br><a href="#2-3">2-3. Azure ディスク バックアップ</a></p><hr><h3 id="1-バックアップソリューションとコンテナー、およびデータ保存先の比較表"><a href="#1-バックアップソリューションとコンテナー、およびデータ保存先の比較表" class="headerlink" title="1. バックアップソリューションとコンテナー、およびデータ保存先の比較表"></a><a id="1"></a>1. バックアップソリューションとコンテナー、およびデータ保存先の比較表</h3><p> 各 Azure バックアップのソリューションがどのコンテナーを利用するか、またデータの保存先については下記の通りです。<br> また、各ソリューションには各公開ドキュメントへのリンクを付けています。</p><table><thead><tr><th align="left">#</th><th align="left">バックアップ ソリューション</th><th align="left">利用するコンテナー</th><th align="left">コンテナーにバックアップデータを保存するか</th></tr></thead><tbody><tr><td align="left">1</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction">Azure VM バックアップ</a></td><td align="left">Recovery Services コンテナー</td><td align="left">する</td></tr><tr><td align="left">2</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-about-mars">MARS バックアップ</a></td><td align="left">Recovery Services コンテナー</td><td align="left">する</td></tr><tr><td align="left">3</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-microsoft-azure-backup">MABS バックアップ</a></td><td align="left">Recovery Services コンテナー</td><td align="left">する</td></tr><tr><td align="left">4</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-sql-database">SQL in Azure VM バックアップ</a></td><td align="left">Recovery Services コンテナー</td><td align="left">する</td></tr><tr><td align="left">5</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-about">SAP HANA DB in Azure VM バックアップ</a></td><td align="left">Recovery Services コンテナー</td><td align="left">する</td></tr><tr><td align="left">6</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-file-share-backup-overview">Azure ファイル共有バックアップ</a></td><td align="left">Recovery Services コンテナー</td><td align="left">「スナップショット レベル」のバックアップ：しない<br>「Vault-Standard レベル」のバックアップ：する (注1)</td></tr><tr><td align="left">7</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-overview">Azure Blob バックアップ</a></td><td align="left">バックアップ コンテナー</td><td align="left">運用バックアップ：しない<br>保管済みバックアップ：する (注2)</td></tr><tr><td align="left">8</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-overview">Azure ディスク バックアップ</a></td><td align="left">バックアップ コンテナー</td><td align="left"><strong>しない</strong></td></tr><tr><td align="left">9</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-database-postgresql-overview">Azure PosgreSQL バックアップ</a></td><td align="left">バックアップ コンテナー</td><td align="left">する</td></tr><tr><td align="left">10</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-kubernetes-service-backup-overview">Azure Kubernetes Service バックアップ</a></td><td align="left">バックアップ コンテナー</td><td align="left">する</td></tr></tbody></table><ul><li><p><strong>(注1) 2024年4月現在  Azure ファイル共有バックアップ のコンテナー層へのバックアップ機能が Public Preview となっています</strong><br>・Public Preview: Azure Backup enables vaulted backups for Azure Files for comprehensive data protection. | Azure updates | Microsoft Azure<br><a href="https://azure.microsoft.com/en-US/updates/azurefiles-vaultedbackups/">https://azure.microsoft.com/en-US/updates/azurefiles-vaultedbackups/</a></p></li><li><p><strong>(注2) 2024年4月現在  Azure Blob バックアップのコンテナー層へのバックアップ機能が Public Preview となっています</strong><br>・Public Preview: Azure Backup enables vaulted backups for Azure Blob for comprehensive data protection.<br><a href="https://azure.microsoft.com/ja-JP/updates/azureblobvaultedbackups/">https://azure.microsoft.com/ja-JP/updates/azureblobvaultedbackups/</a></p></li></ul><h3 id="2-コンテナーにバックアップデータが保存されないもの"><a href="#2-コンテナーにバックアップデータが保存されないもの" class="headerlink" title="2.コンテナーにバックアップデータが保存されないもの"></a><a id="2"></a>2.コンテナーにバックアップデータが保存されないもの</h3><p>上述のとおり、現在 一般公開されている (プレビュー機能ではない) Azure ファイル共有バックアップ (スナップショット レベル) 、Azure Blob バックアップ (運用バックアップ)、Azure ディスク バックアップは各コンテナーにはバックアップデータは転送されません。<br>それぞれについて簡単にご説明させていただきます。<br>共通している点はそれぞれのソリューションはコアとなる別のソリューションをバックアップサービス側からトリガーし実現している点でございます。</p><h4 id="2-1-Azure-ファイル共有バックアップ-スナップショット-レベル"><a href="#2-1-Azure-ファイル共有バックアップ-スナップショット-レベル" class="headerlink" title="2-1. Azure ファイル共有バックアップ (スナップショット レベル)"></a><a id="2-1"></a>2-1. Azure ファイル共有バックアップ (スナップショット レベル)</h4><p>Azure ファイル共有 バックアップ (スナップショット レベル) は Azure Files の共有スナップショットの機能をバックアップ サービスと連携することによりスナップショット取得・削除の自動化を実現したバックアップ ソリューションです。</p><p>そのため、バックアップ データ (スナップショットデータ) の保存先は Azure Files の共有スナップショットと同じく、そのストレージ アカウント自身 (のスナップショット領域)となります。<br>そのため、 Recovery Services コンテナーには転送されません。<br>下記のように<strong>Azure ファイル共有のスナップショット リソースとして、Azure ファイル共有バックアップにて取得されたスナップショットも確認可能です</strong>。(“発信側” が “AzureBackup” となっているものです)<br><img src="https://user-images.githubusercontent.com/71251920/198350606-969ef3b9-0c2a-4744-9940-87c41936cb09.png"></p><p>・バックアップ プロセスのしくみ - Azure ファイル共有のバックアップについて<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-file-share-backup-overview">https://learn.microsoft.com/ja-jp/azure/backup/azure-file-share-backup-overview</a></p><blockquote><p>抜粋：ファイル共有データは Backup サービスには転送されません。これは、Backup サービスでは、ストレージ アカウントの一部であるスナップショットの作成および管理が行われ、バックアップはコンテナーに転送されないからです。</p></blockquote><p>・Azure Files の共有スナップショット<br><a href="https://learn.microsoft.com/ja-jp/azure/storage/files/storage-snapshots-files">https://learn.microsoft.com/ja-jp/azure/storage/files/storage-snapshots-files</a></p><h4 id="2-2-Azure-Blob-バックアップ-運用バックアップ"><a href="#2-2-Azure-Blob-バックアップ-運用バックアップ" class="headerlink" title="2-2. Azure Blob バックアップ (運用バックアップ)"></a><a id="2-2"></a>2-2. Azure Blob バックアップ (運用バックアップ)</h4><p>Azure Blob バックアップ (運用バックアップ) は Azure Blob のポイントインタイムリストアの機能をバックアップ サービスと連携することにより実現したバックアップソリューションです。</p><p>そのため、バックアップデータ (リストアに必要なデータ) の保存先は Azure Blob のポイントインタイムリストアと同じく、そのストレージ アカウント自身となります。<br>そのため、バックアップ コンテナーには転送されません。</p><p>・運用バックアップのしくみ - Azure Blob の運用バックアップの概要<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-overview">https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-overview</a></p><blockquote><p>抜粋：BLOB の運用バックアップは、ローカル バックアップ ソリューションです。 そのため、バック アップデータはバックアップ コンテナーには転送されず、ソース ストレージ アカウント自体に格納されます。 ただし、バックアップ コンテナーは引き続きバックアップ管理の単位として機能します。 また、これは継続的バックアップ ソリューションです。つまり、バックアップをスケジュール設定する必要がなく、すべての変更内容が保持され、選択した時点の状態から復元できます。</p></blockquote><p>・ブロック BLOB のポイントインタイム リストア<br><a href="https://learn.microsoft.com/ja-jp/azure/storage/blobs/point-in-time-restore-overview">https://learn.microsoft.com/ja-jp/azure/storage/blobs/point-in-time-restore-overview</a></p><h4 id="2-3-Azure-ディスク-バックアップ"><a href="#2-3-Azure-ディスク-バックアップ" class="headerlink" title="2-3. Azure ディスク バックアップ"></a><a id="2-3"></a>2-3. Azure ディスク バックアップ</h4><p>Azure ディスク バックアップ は マネージド ディスクの増分スナップショットの機能とバックアップサービスと連携することによりスナップショット取得の自動化、スナップショットの削除の自動化を実現したバックアップ ソリューションです。</p><p>そのため、バックアップデータ (スナップショット データ) の保存先は マネージドディスクのスナップショットと同じく、マネージドディスクのスナップショットの専用領域 (運用層) となります。そのため、 Recovery Services コンテナーには転送されません。<br>また、下記のように<strong>スナップショットリソースとして Azure ディスクのバックアップによって取得されたスナップショットも確認可能です</strong>。(タグが “CreatedBy：AzureBackup” となっているものです)<br><img src="https://user-images.githubusercontent.com/71251920/198349785-951e0497-fe17-46e5-9714-53f2daf30344.png"></p><p>・バックアップと復元のプロセスのしくみ - Azure ディスク バックアップの概要<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-overview#how-the-backup-and-restore-process-works">https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-overview#how-the-backup-and-restore-process-works</a></p><blockquote><p>抜粋： Azure ディスク バックアップでは、運用層のバックアップのみがサポートされています。 コンテナー ストレージ層へのバックアップのコピーはサポートされていません。</p></blockquote><p>・マネージド ディスクの増分スナップショットの作成<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/disks-incremental-snapshots?tabs=azure-cli">https://learn.microsoft.com/ja-jp/azure/virtual-machines/disks-incremental-snapshots?tabs=azure-cli</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、 Azure バックアップ ソリューションで利用する Recovery Services コンテナーとバックアップ コンテナーのバックアップ対象の違いについて</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>「VMSnapshot」拡張機能のアンインストール手順 (Windows)</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToUninstallVMSnapshotExtension/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToUninstallVMSnapshotExtension/</id>
    <published>2024-01-11T03:00:00.000Z</published>
    <updated>2024-08-27T06:06:49.065Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、「VMSnapshot」拡張機能のアンインストール手順 (Windows OS の場合) についてご案内いたします。</p><p>「VMSnapshot」拡張機能は、Azure VM Backup (Azure 仮想マシンをまるごとバックアップする機能) において、対象の Azure 仮想マシン上にインストールされる拡張機能です。<br>Azure VM Backup にて何らかのエラーが発生した場合、トラブルシューティングの一環として本記事の記載に従って「VMSnapshot」拡張機能を一度マシンからアンインストールしていただき、再度バックアップを実行させることで、エラーが解消されるかを依頼する場合がございます。</p><p>・(参考) Azure VM バックアップについて - Azure Backup | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-process">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-process</a><br>　“Windows VM の場合、VMSnapshot 拡張機能がインストールされます。<br>　 Linux VM の場合、VMSnapshotLinux 拡張機能がインストールされます。”</p><p>・(参考) Azure Backup 用の VM スナップショットの Windows 拡張機能 - Azure Virtual Machines | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/extensions/vmsnapshot-windows">https://learn.microsoft.com/ja-jp/azure/virtual-machines/extensions/vmsnapshot-windows</a></p><p>なお、下記公開ドキュメント上では、Azure ポータル画面 &gt; Azure 仮想マシン &gt; [拡張機能とアプリケーション] 画面から、アンインストールすることができるという説明を記載しておりますが<br>これは <strong>アンマネージド ディスクから作成している Azure 仮想マシンの場合のみ</strong> となります。<br>マネージド ディスク の Azure 仮想マシンの場合は、本記事に従って 「VMSnapshot」拡張機能のアンインストールをお試しください。</p><p>・(参考) ExtensionStuckInDeletionState - 拡張機能の状態がバックアップ操作に対応していません<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#extensionstuckindeletionstate---extension-state-is-not-supportive-to-the-backup-operation">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#extensionstuckindeletionstate---extension-state-is-not-supportive-to-the-backup-operation</a><br>　“バックアップ拡張機能 [VmSnapshot] または [VmSnapshotLinux] を選択し、 [アンインストール] を選択します。”</p><p>(画面例 : マネージド ディスク の Azure 仮想マシンの場合は、[拡張機能とアプリケーション] 画面上には「VMSnapshot」拡張機能は表示されません)<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/d717c42e-9f33-4c0a-af7d-a71c79fc7d7b"></p><h3 id="「VMSnapshot」拡張機能のアンインストール手順-Windows"><a href="#「VMSnapshot」拡張機能のアンインストール手順-Windows" class="headerlink" title="「VMSnapshot」拡張機能のアンインストール手順 (Windows)"></a>「VMSnapshot」拡張機能のアンインストール手順 (Windows)</h3><ol><li><p>PowerShell にて該当の Azure アカウントにログインし、下記コマンドを実行し、該当の Azure 仮想マシン上から「VMSnapshot」拡張機能をアンインストールしてください。<br>  (実行コマンド)<br>   <code>Remove-AzVMExtension -ResourceGroupName &quot;&lt;Azure 仮想マシンのリソース グループ&gt;&quot; -VMName &quot;&lt;Azure 仮想マシン名&gt;&quot; -Name &quot;VMSnapshot&quot;​</code></p><p>上記コマンド実行後、「Y」を入力してアンインストールを指示します。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/3f0a25a7-ae61-49e1-86df-0a1ed4dfeb08"></p><p>・(参考) Remove-AzVMExtension (Az.Compute) | Microsoft Learn<br> <a href="https://learn.microsoft.com/ja-jp/powershell/module/az.compute/remove-azvmextension?view=azps-11.0.0">https://learn.microsoft.com/ja-jp/powershell/module/az.compute/remove-azvmextension?view=azps-11.0.0</a></p></li><li><p>該当の Azure 仮想マシン にサインインし、Windows + r を押下して ”ファイル名を指定して実行” を開き “services.msc” と入力して、サービスを開いてください。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/ba7e6f7a-0d16-48d1-ac96-436d222e26ab"></p></li><li><p>“Windows Azure Guest Agent” を右クリックし、停止をクリックして、サービスを停止してください。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/b279342f-743d-42e8-b8b0-90318f7d745d"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/85805039-bacb-4d6f-b968-1e95532274a0"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/e979141a-791f-403c-8b41-ab8e04cf296e"></p></li><li><p>エクスプローラを開き、C:\Packages\Plugins に移動し、”Microsoft.Azure.RecoveryServices.VMSnapshot” フォルダーの名前を ”Microsoft.Azure.RecoveryServices.VMSnapshot_old” といったように変更してください。</p><p>(補足)<br>   ”Microsoft.Azure.RecoveryServices.VMSnapshot” フォルダーが、マシン上にインストールされている「VMSnapshot」拡張機能のファイル群です。<br>   「VMSnapshot」拡張機能が正常に再インストール完了すれば、こちらの名前を変更したフォルダーは削除いただいて構いません。</p><p>(変更前)<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/e5d87f28-08d4-45d7-a1a1-4b297c323977"></p><p>(変更後)<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/2b0f6098-e4e2-4078-83ab-9295ca549d92"></p></li><li><p>Windows + r を押下して ”ファイル名を指定して実行” を開き “regedit” と入力して、レジストリエディターを開いてください。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/68f5f289-f679-49a0-a065-746c128380e5"></p></li><li><p>HKEY_LOCAL_MACHINE\Software\Microsoft\WindowsAzure に移動し、これを安全な場所にエクスポートしてください。</p><p>(補足)<br>   レジストリ キーの値をあくまでバックアップ目的でエクスポート (退避) します。<br>  「VMSnapshot」拡張機能が正常に再インストール完了すれば、こちらのエクスポートしたファイルは削除いただいて構いません。</p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/496b4c51-75cc-4cde-bca7-c345e7013e35"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/6c185c9f-0c76-4c3e-820d-5d005b3b28b7"></p></li><li><p>HKEY_LOCAL_MACHINE\Software\Microsoft\WindowsAzure\HandlerState に移動し、Microsoft.Azure.RecoveryServices.VMSnapshot_X.X.X.X を削除してください。<br>(X.X.X.X は、マシン上の数字と読み替えてください)<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/3241a8e8-6168-4cf7-aa85-f949417cd879"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/0c078c7d-775b-4c40-8a18-ab7ecc6411da"></p></li><li><p>管理者権限にてコマンドプロンプトを開き以下のコマンド (2 つ) を実行してください。<br>  (実行コマンド)<br>   <code>REG ADD &quot;HKLM\SOFTWARE\Microsoft\BcdrAgent&quot; /v IsProviderInstalled /t REG_SZ /d False /f​</code><br>   <code>REG ADD &quot;HKLM\SOFTWARE\Microsoft\BcdrAgentPersistentKeys&quot; /v IsCommonProviderInstalled /t REG_SZ /d False /f</code></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/c044b76e-0caa-4eef-a293-7abdcb9a054e"></p></li><li><p>サービスより “Windows Azure Guest Agent” を右クリックし、開始をクリックして、サービスを開始してください。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/79b7c5a3-daf1-41d9-9b2c-03c14b0f6b6b"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/961ca6d2-ee49-4a6e-81a1-c368570cc367"></p></li><li><p>次回の Azure VM Backup のスケジュール バックアップ、もしくは「今すぐバックアップ」より、バックアップをトリガーください。<br>・(参考) バックアップをすぐに実行する<br> <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-first-look-arm#run-a-backup-immediately">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-first-look-arm#run-a-backup-immediately</a> </p></li><li><p>Azure VM Backup ジョブが正常に終了すること・「VMSnapshot」拡張機能のフォルダーが再配置されていることを確認ください。<br>下図のように C:\Packages\Plugins 配下に ”Microsoft.Azure.RecoveryServices.VMSnapshot” フォルダーが再配置されていれば【「VMSnapshot」拡張機能を再インストールできた】と判断できます。</p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/cf7645ed-0028-4ce8-a435-9865fbaa7a49"></p><p>「VMSnapshot」拡張機能を正常に再インストールした後は、下記 2 点のフォルダー・ファイルは削除いただいて構いません。<br>・”Microsoft.Azure.RecoveryServices.VMSnapshot_old” フォルダー<br>・エクスポートしていたレジストリ キーのファイル</p></li></ol><p>「VMSnapshot」拡張機能のアンインストール手順 (Windows OS の場合) は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、「VMSnapshot」拡張機能のアンインストール手順 (Windows OS の場合) についてご案内いたします。&lt;/p&gt;
&lt;p&gt;「VMSnapshot</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>疎通確認スクリプトの実行結果について (Linux)</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/NwCheckScript_Linux/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/NwCheckScript_Linux/</id>
    <published>2024-01-10T03:00:00.000Z</published>
    <updated>2024-08-27T06:06:49.037Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、下記ブログにてご案内している「2. Linux VM における Azure Backup 疎通確認」スクリプトの実行結果について、実行結果の見方・Azure Backup において確認にすべきポイントなどをご紹介いたします。</p><p>・2. Linux VM における Azure Backup 疎通確認<br>　<a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/#2">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/#2</a></p><div class="alert is-info"><p class="alert-title">Note</p><p>上記ブログ リンクでご案内している疎通確認スクリプトは、あくまで Azure Backup に関わる通信要件を満たしているかを調査するために、弊社よりご案内・実行いただいているものです。</p><p>疎通確認スクリプトを実行いただいた後は、専任エンジニアが詳細なトラブルシューティングを行いますので、お問い合わせチケット上へ添付ください。</p><p>マシンの環境によっては本スクリプトでは確認しきれないネットワーク構成もあるため、お問い合わせチケットにて、お客様とどのようなネットワーク通信経路となっているかをすり合わせることがございます。</p><p>「nc」コマンドや「curl」コマンドの戻り値については、全てを網羅した情報ではなく、Azure Backup 観点にてチェックすべきものをまとめております。</p></div><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. 疎通確認スクリプトの構成</a><br><a href="#2">2. プロキシ設定の確認</a><br><a href="#3">3. 疎通確認スクリプト結果を確認する際のポイント</a><br><a href="#4">4. nslookup コマンド結果について</a><br><a href="#5">5. nc コマンド結果について</a><br><a href="#6">6. curl コマンド結果について</a></p><hr><h2 id="1-疎通確認スクリプトの構成"><a href="#1-疎通確認スクリプトの構成" class="headerlink" title=" 1. 疎通確認スクリプトの構成"></a><a id="1"></a> 1. 疎通確認スクリプトの構成</h2><p>はじめに、下記ブログ記事でご案内している疎通確認スクリプト (Check_Backup_NW_Linux_verX.X.sh) の、全体的な構成を説明します。</p><p>・2. Linux VM における Azure Backup 疎通確認<br>　<a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/#2">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/#2</a></p><p>(1) 疎通確認スクリプトを実行したマシン情報の出力<br>(2) プロキシ設定の確認<br>(3) 「ファイルの回復」時に必要な宛先への「nslookup」「nc」コマンド結果<br>(4) Azure Backup への「nslookup」「nc」「curl」コマンド結果<br>(5) Azure Storage への「nslookup」「nc」「curl」コマンド結果<br>(6) Microsoft Entra ID への「nslookup」「nc」「curl」コマンド結果</p><p>それでは疎通確認スクリプト結果ログ (CheckNWResult_(ホスト名)_(YYYYMMDDHHMM).log) 上で確認すべきポイントを説明します。</p><h2 id="2-プロキシ設定の確認"><a href="#2-プロキシ設定の確認" class="headerlink" title=" 2. プロキシ設定の確認"></a><a id="2"></a> 2. プロキシ設定の確認</h2><p>Linux OS のマシン上で、プロキシ サーバーを経由するよう設定しているかどうかを確認しています。<br>下図のように、空白行の場合は「http_proxy」「https_proxy」のプロキシ設定は無いと判断します。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/9f9b597d-6a5f-4180-9d8e-141d11eb5e34"></p><p>いっぽう 下図のように出力されている場合は、プロキシ設定を行っていると判断します。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/f4a0cdbc-8d19-497e-93cd-3d5872f68534"></p><h2 id="3-疎通確認スクリプト結果を確認する際のポイント"><a href="#3-疎通確認スクリプト結果を確認する際のポイント" class="headerlink" title=" 3. 疎通確認スクリプト結果を確認する際のポイント"></a><a id="3"></a> 3. 疎通確認スクリプト結果を確認する際のポイント</h2><p>プロキシ設定情報を出力した後は<br>Azure Backup 処理時に、シナリオによっては必要となる 下記 3 つの Azure サービスとの通信を、おもに「nslookup」「nc」「curl」コマンドで確認していきます。<br>　・Azure Backup サービス<br>　・Azure Storage サービス<br>　・Microsoft Entra ID サービス</p><h4 id="ポイント-リージョンによって確認すべき-FQDN-が変わる可能性があります"><a href="#ポイント-リージョンによって確認すべき-FQDN-が変わる可能性があります" class="headerlink" title="(ポイント) リージョンによって確認すべき FQDN が変わる可能性があります"></a>(ポイント) リージョンによって確認すべき FQDN が変わる可能性があります</h4><p>疎通確認スクリプト上の FQDN (例：pod01-rec2.<font color="DeepPink">jpw</font>.backup.windowsazure.com) はあくまで、Azure Backup サービスで使用される FQDN のうちの 1 つです。<br>「jpw」と記載されている通り、疎通確認スクリプトでは、例として西日本リージョンや東日本リージョンで使用されている Azure Backup サービスとの通信を確認しています。<br>お客様が利用するリージョンによって、通信確立が必要な FQDN は変更されます。<br>これは Azure Storage サービスにおいても同様です。</p><p>(参考) MARSエージェントを使ったバックアップで必要な通信要件<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mars-agent#url-and-ip-access">https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mars-agent#url-and-ip-access</a></p><p>また、疎通確認スクリプト上で確認している FQDN は、不定期で変更する場合がございます。</p><h4 id="ポイント-確認している-FQDN-はパブリックな-Azure-サービスです"><a href="#ポイント-確認している-FQDN-はパブリックな-Azure-サービスです" class="headerlink" title="(ポイント) 確認している FQDN はパブリックな Azure サービスです"></a>(ポイント) 確認している FQDN はパブリックな Azure サービスです</h4><p>プライベート エンドポイント経由で Azure Backup を利用する場合、<br>確認すべき Azure Backup ・ Azure Storage サービスの FQDN は、疎通確認スクリプト上で確認しているパブリックな FQDN ではなく、お客様毎にそれぞれ異なる FQDN の通信を確認する必要があります。<br>この場合は下記ブログ記事に従って、ご確認ください。</p><p>(確認方法) 3. プライベート エンドポイント環境における Azure Backup 疎通確認<br><a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/#3">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/#3</a></p><h2 id="4-nslookup-コマンド結果について"><a href="#4-nslookup-コマンド結果について" class="headerlink" title=" 4. nslookup コマンド結果について"></a><a id="4"></a> 4. nslookup コマンド結果について</h2><p>コマンド実行によって得られた代表的な出力結果における、疎通の成否の判断方法をご説明します。 </p><p><strong>&lt;疎通が成功しているコマンド結果 例&gt;</strong><br>__<br>　##TRY!! nslookup  pod01-rec2.jpe.backup.windowsazure.com ##<br>　Server:        168.63.129.16<br>　Address:    168.63.129.16#53</p><p>　Non-authoritative answer:<br>　pod01-rec2.jpe.backup.windowsazure.com    canonical name = jpe-pod01-rec2-s2j8q.ext.trafficmanager.net.<br>　jpe-pod01-rec2-s2j8q.ext.trafficmanager.net    canonical name = jpe-pod01-rec-01.japaneast.cloudapp.azure.com.<br>　Name:    jpe-pod01-rec-01.japaneast.cloudapp.azure.com<br>　<font color="DeepPink">Address: 20.191.166.150</font><br>__</p><p>上記のように 末尾「Address」欄に IP アドレスが表示されていれば「pod01-rec2.jpe.backup.windowsazure.com」という Azure Backup で使用される FQDN の 1 つとは、 nslookup コマンドによる「名前解決はできている」と判断できます。</p><p><strong>&lt;疎通が失敗しているコマンド結果 例&gt;</strong><br>__<br>　##TRY!! nslookup  pod01-rec2.jpe.backup.windowsazure.com ##<br>　;; connection timed out; no servers could be reached<br>__<br>上記に「connection timed out」のような出力の場合、名前解決できていないことが懸念されるため、お客様にてマシン上の名前解決手段を確認いただくことがございます。</p><h2 id="5-nc-コマンド結果について"><a href="#5-nc-コマンド結果について" class="headerlink" title=" 5. nc コマンド結果について"></a><a id="5"></a> 5. nc コマンド結果について</h2><p><strong>&lt;疎通が成功しているコマンド結果 例&gt;</strong><br>__<br>　##TRY!! nc -vz pod01-manag1.jpe.backup.windowsazure.com 443 ##<br>　Ncat: Version 7.50 ( <a href="https://nmap.org/ncat">https://nmap.org/ncat</a> )<br>　Ncat: <font color="DeepPink">Connected to </font>20.191.166.134:443.<br>　Ncat: 0 bytes sent, 0 bytes received in 0.06 seconds.<br>__</p><p>上記のように 「Connected to &lt;宛先の IP アドレス&gt;」が表示されていれば対象のアドレスと nc コマンドによる通信は確立できていると判断できます。</p><p><strong>&lt;疎通が失敗しているコマンド結果 例&gt;</strong><br>__<br>　##TRY!! nc -vz pod01-rec2.jpe.backup.windowsazure.com 3260 ##<br>　Ncat: Version 7.50 ( <a href="https://nmap.org/ncat">https://nmap.org/ncat</a> )<br>　Ncat: <font color="DeepPink">Connection timed out.</font></p><p>　##TRY!! nc -vz pod01-prot1.jpe.backup.windowsazure.com 443 ##<br>　nc: connect to pod01-prot1.jpe.backup.windowsazure.com port 443 <font color="DeepPink">(tcp) failed: Connection timed out</font><br>__</p><p>上記のように「failed」「Connection timed out.」と出力されている場合、 nc コマンドによる通信は確立できていないと判断できます。</p><h4 id="ポイント-プロキシ-サーバーを経由するマシンの場合-nc-コマンドだけでは判断できません"><a href="#ポイント-プロキシ-サーバーを経由するマシンの場合-nc-コマンドだけでは判断できません" class="headerlink" title="(ポイント) プロキシ サーバーを経由するマシンの場合 nc コマンドだけでは判断できません"></a>(ポイント) プロキシ サーバーを経由するマシンの場合 nc コマンドだけでは判断できません</h4><p>弊チームの疎通確認スクリプト上の nc コマンドでは、プロキシを経由した通信確認を行えないため<br>プロキシを経由しているマシン上で実行している場合、たとえ「Connected to &lt;宛先の IP アドレス&gt;」と出力されていても「プロキシを経由して通信確立できている」とはいえません。<br>別途「curl」コマンドにて確認する必要があります。</p><h2 id="6-curl-コマンド結果について"><a href="#6-curl-コマンド結果について" class="headerlink" title=" 6. curl コマンド結果について"></a><a id="6"></a> 6. curl コマンド結果について</h2><p><strong>&lt;疎通が成功しているコマンド結果 例&gt;</strong><br>__<br>　##TRY!! curl -I <a href="https://login.microsoft.com/">https://login.microsoft.com</a> ##<br>　(中略)<br>　HTTP/1.1 <font color="DeepPink">200 OK</font><br>__<br>　##TRY!! curl -I <a href="https://ceuswatcab01.blob.core.windows.net/">https://ceuswatcab01.blob.core.windows.net</a> ##<br>　(中略)<br>　HTTP/1.1 <font color="DeepPink">400 Value for one of the query parameters specified in the request URI is invalid.</font><br>__<br>　##TRY!! curl -I <a href="https://md-dlbrhcw4gn5r.z33.blob.storage.azure.net/">https://md-dlbrhcw4gn5r.z33.blob.storage.azure.net</a> ##<br>　(中略)<br>　HTTP/1.1 <font color="DeepPink">403 Server failed to authenticate the request. Make sure the value of Authorization header is formed correctly including the signature.</font><br>__<br>　##TRY!! curl -I <a href="https://pod01-manag1.jpe.backup.windowsazure.com/">https://pod01-manag1.jpe.backup.windowsazure.com</a> ##<br>　(中略)<br>　HTTP/1.1 <font color="DeepPink">404 Not Found</font><br>__</p><p>上記のように<br>・200 OK<br>・400<br>・403<br>・404<br>が返却された場合、対象の疎通先より応答 (エラーを含む) が返却されているため、Azure Backup 観点では「疎通ができている」と判断できます。 </p><p><strong>&lt;疎通が失敗しているコマンド結果 例&gt;</strong><br>__<br>　##TRY!! curl -I <a href="https://pod01-manag1.jpe.backup.windowsazure.com/">https://pod01-manag1.jpe.backup.windowsazure.com</a> ##<br>　(中略)<br>　curl: (7) <font color="DeepPink">Failed to connect to pod01-manag1.jpe.backup.windowsazure.com port 443: Connection timed out</font><br>__<br>　##TRY!! curl -I <a href="https://loginex.microsoftonline.com/">https://loginex.microsoftonline.com</a> ##<br>　（中略）<br>　curl: (28) <font color="DeepPink">Connection timed out </font>after 300001 milliseconds<br>__</p><p>上記のように「Failed to connect」や「Connection timed out」と出力されている場合、 curl コマンドによる通信は確立できていないと判断できます。</p><p>説明は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、下記ブログにてご案内している「2. Linux VM における Azure Backup 疎通確認」スクリプトの実行結果について、実行結果の見方・Azur</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>疎通確認スクリプトの実行結果について (Windows)</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/NwCheckScript_Windows/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/NwCheckScript_Windows/</id>
    <published>2024-01-10T03:00:00.000Z</published>
    <updated>2024-08-27T06:06:49.037Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、下記ブログにてご案内している「1. Windows VM における Azure Backup 疎通確認」スクリプトの実行結果について、実行結果の見方・Azure Backup において確認すべきポイントなどをご紹介いたします。</p><p>・1. Windows VM における Azure Backup 疎通確認<br>　<a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/#1">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/#1</a></p><div class="alert is-info"><p class="alert-title">Note</p><p>上記ブログ リンクでご案内している疎通確認スクリプトは、あくまで Azure Backup に関わる通信要件を満たしているかを調査するために、弊社よりご案内・実行いただいているものです。</p><p>疎通確認スクリプトを実行いただいた後は、専任エンジニアが詳細なトラブルシューティングを行いますので、お問い合わせチケット上へ添付ください。</p><p>マシンの環境によっては本スクリプトでは確認しきれないネットワーク構成もあるため、お問い合わせチケットにて、お客様とどのようなネットワーク通信経路となっているかをすり合わせることがございます。</p><p>「tnc」コマンドや「Invoke-webRequest」コマンドの戻り値については、全てを網羅した情報ではなく、Azure Backup 観点にてチェックすべきものをまとめております。</p></div><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. 疎通確認スクリプトの構成</a><br><a href="#2">2. プロキシ設定の確認</a><br><a href="#3">3. 疎通確認スクリプト結果を確認する際のポイント</a><br><a href="#4">4. tnc コマンド結果について</a><br><a href="#5">5. Invoke-webRequest コマンド結果について</a><br><a href="#6">6. SSL, TLS 設定を確認する</a></p><hr><h2 id="1-疎通確認スクリプトの構成"><a href="#1-疎通確認スクリプトの構成" class="headerlink" title=" 1. 疎通確認スクリプトの構成"></a><a id="1"></a> 1. 疎通確認スクリプトの構成</h2><p>はじめに、下記ブログ記事でご案内している疎通確認スクリプト (Check_Backup_NW_verX.X.ps1) の、全体的な構成を説明します。</p><p>・1. Windows VM における Azure Backup 疎通確認<br>　<a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/#1">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/#1</a></p><p>(1) 疎通確認スクリプトを実行したマシン情報の出力<br>(2) プロキシ設定の確認<br>(3) Azure Backup への「tnc」「Invoke-webRequest」コマンド結果<br>(4) Azure Storage への「tnc」「Invoke-webRequest」コマンド結果<br>(5) Microsoft Entra ID への「tnc」「Invoke-webRequest」コマンド結果<br>(6) 「ファイルの回復」時に必要な宛先への「tnc」「Invoke-webRequest」コマンド結果<br>(7) SSL, TLS 設定 情報の出力</p><p>それでは疎通確認スクリプト結果ログ (AzureBackup_Check_NW_yyyymmdd_hhmmss.log) 上で確認すべきポイントを説明します。</p><h2 id="2-プロキシ設定の確認"><a href="#2-プロキシ設定の確認" class="headerlink" title=" 2. プロキシ設定の確認"></a><a id="2"></a> 2. プロキシ設定の確認</h2><p>Windows OS のマシン上で、プロキシ サーバーを経由するよう設定しているかどうかを確認しています。</p><ul><li><p>WinInet settings for current user (used by ILR but not supported ,not used by Azure SQL / MARS Backup)<br><font color="DodgerBlue">→マシン上のカレント ユーザーに対するプロキシ設定が行われているかどうかを確認します</font></p></li><li><p>WinInet settings for NT Authority\System (used by Azure SQL / MARS Backup)<br><font color="DodgerBlue">→マシン上のシステム ユーザーに対するプロキシ設定が行われているかどうかを確認します</font></p></li><li><p>WinInet settings for NT Service\AzureWLBackupPluginSv (used by Azure Workload Backup Plugin service)<br><font color="DodgerBlue">→「SQL Server DB に対する Azure Workload Backup」や「SAP HANA DB に対する Azure Workload Backup」にて作成・使用される「AzureWLBackupPluginSv」ユーザーに対するプロキシ設定が行われているかどうかを確認します</font></p></li><li><p>##Check WinHttpProxy<br><font color="DodgerBlue">→WinHttp プロキシ設定が行われているかどうかを確認します</font></p></li></ul><p>下図のように「ProxyEnable」「ProxyServer」「ProxyOverride」箇所が「0」やブランク表示となっていれば「プロキシ設定は行われいない」と判断します。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/79f511c3-9e4e-4f46-9365-e3ee0519161e"></p><p>下図のように「ProxyEnable: 1」となっていれば、プロキシ設定がされていると判断できます。<br>「ProxyServer」箇所が経由しているプロキシ サーバーです。<br>「ProxyOverride」箇所には、プロキシ バイパス設定内容が確認できます。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/6d30b9e4-0cfc-4285-b1b7-9de7f07d94b3"></p><p>(マシン上の設定例)<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/26b8cd0a-bdce-45b0-8fb8-35ac66892571"></p><h2 id="3-疎通確認スクリプト結果を確認する際のポイント"><a href="#3-疎通確認スクリプト結果を確認する際のポイント" class="headerlink" title=" 3. 疎通確認スクリプト結果を確認する際のポイント"></a><a id="3"></a> 3. 疎通確認スクリプト結果を確認する際のポイント</h2><p>プロキシ設定情報を出力した後は<br>Azure Backup 処理時に、シナリオによっては必要となる 下記 3 つの Azure サービスとの通信を「tnc」「Invoke-webRequest」コマンドで確認していきます。<br>　・Azure Backup サービス<br>　・Azure Storage サービス<br>　・Microsoft Entra ID サービス</p><h4 id="ポイント-リージョンによって確認すべき-FQDN-が変わる可能性があります"><a href="#ポイント-リージョンによって確認すべき-FQDN-が変わる可能性があります" class="headerlink" title="(ポイント) リージョンによって確認すべき FQDN が変わる可能性があります"></a>(ポイント) リージョンによって確認すべき FQDN が変わる可能性があります</h4><p>疎通確認スクリプト上の FQDN (例：pod01-manag1.<font color="DeepPink">jpe</font>.backup.windowsazure.com) はあくまで、Azure Backup サービスで使用される FQDN のうちの 1 つです。<br>「jpe」と記載されている通り、疎通確認スクリプトでは、例として東日本リージョンで使用されている Azure Backup サービスとの通信を確認しています。<br>お客様が利用するリージョンによって、通信確立が必要な FQDN は変更されます。<br>これは Azure Storage サービスにおいても同様です。</p><p>(参考) MARSエージェントを使ったバックアップで必要な通信要件<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mars-agent#url-and-ip-access">https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mars-agent#url-and-ip-access</a></p><p>また、疎通確認スクリプト上で確認している FQDN は、不定期で変更する場合がございます。</p><h4 id="ポイント-確認している-FQDN-はパブリックな-Azure-サービスです"><a href="#ポイント-確認している-FQDN-はパブリックな-Azure-サービスです" class="headerlink" title="(ポイント) 確認している FQDN はパブリックな Azure サービスです"></a>(ポイント) 確認している FQDN はパブリックな Azure サービスです</h4><p>プライベート エンドポイント経由で Azure Backup を利用する場合、<br>確認すべき Azure Backup ・ Azure Storage サービスの FQDN は、疎通確認スクリプト上で確認しているパブリックな FQDN ではなく、お客様毎にそれぞれ異なる FQDN の通信を確認する必要があります。<br>この場合は下記ブログ記事に従って、ご確認ください。</p><p>(確認方法) 3. プライベート エンドポイント環境における Azure Backup 疎通確認<br><a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/#3">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/#3</a></p><h2 id="4-tnc-コマンド結果について"><a href="#4-tnc-コマンド結果について" class="headerlink" title=" 4. tnc コマンド結果について"></a><a id="4"></a> 4. tnc コマンド結果について</h2><p>コマンド実行によって得られた代表的な出力結果における、疎通の成否の判断方法をご説明します。 </p><p><strong>&lt;疎通が成功しているコマンド結果 例&gt;</strong><br>__<br>　Result of tnc - 443 / from 10.8.0.6 /To URL  pod01-manag1.jpe.backup.windowsazure.com <font color="DarkTurquoise">IPaddress 20.191.166.134</font> / <font color="DeepPink">TcpTestSucceeded: True</font><br>__</p><p>上記のように「TcpTestSucceeded: True」と出力されていれば「pod01-manag1.jpe.backup.windowsazure.com」という Azure Backup で使用される FQDN の 1 つとは、 tnc コマンド (Test-NetConnection コマンド) による通信は確立できていると判断できます。<br>また、「IPaddress」の後に IP アドレスが出力されていれば、「名前解決はできている」と判断できます。</p><p><strong>&lt;疎通が失敗しているコマンド結果 例&gt;</strong><br>__<br>　Result of tnc - 443 / from 10.2.0.23 /To URL  pod01-manag1.jpe.backup.windowsazure.com <font color="DarkTurquoise">IPaddress 20.191.166.134</font> / <font color="DeepPink">TcpTestSucceeded: False</font><br>__</p><p>上記のように「TcpTestSucceeded: False」と出力されていれば「pod01-manag1.jpe.backup.windowsazure.com」とは、 tnc コマンドによる通信は確立できていないと判断できます。<br>いっぽう「IPaddress」の後に IP アドレスが出力されているため「名前解決はできている」と判断できます。</p><p><code>nslookup pod01-manag1.jpe.backup.windowsazure.com</code><br>と実行いただければ、「pod01-manag1.jpe.backup.windowsazure.com」の IP アドレスを確認可能です。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/80dbbee4-57a2-4160-86a2-ea7c7bb56563"></p><h4 id="ポイント-プロキシ-サーバーを経由するマシンの場合-tnc-コマンドだけでは判断できません"><a href="#ポイント-プロキシ-サーバーを経由するマシンの場合-tnc-コマンドだけでは判断できません" class="headerlink" title="(ポイント) プロキシ サーバーを経由するマシンの場合 tnc コマンドだけでは判断できません"></a>(ポイント) プロキシ サーバーを経由するマシンの場合 tnc コマンドだけでは判断できません</h4><p>弊チームの疎通確認スクリプト上の tnc コマンドでは、プロキシを経由した通信確認を行えないため<br>プロキシを経由しているマシン上で実行している場合、たとえ「TcpTestSucceeded: True」と出力されていても「プロキシを経由して通信確立できている」とはいえません。<br>別途「Invoke-webRequest」コマンドにて確認する必要があります。</p><h2 id="5-Invoke-webRequest-コマンド結果について"><a href="#5-Invoke-webRequest-コマンド結果について" class="headerlink" title=" 5. Invoke-webRequest コマンド結果について"></a><a id="5"></a> 5. Invoke-webRequest コマンド結果について</h2><p>コマンド実行によって得られた代表的な出力結果における、疎通の成否の判断方法をご説明します。 </p><p><strong>&lt;疎通が成功しているコマンド結果 例&gt;</strong><br>__<br>　#TRY!! Invoke-webRequest login.microsoft.com<br>　Result of Invoke-webRequest  / <font color="DeepPink">StatusCode: 200</font>/ StatusDescription: OK<br>__<br>　#TRY!! Invoke-webRequest pod01-manag1.jpe.backup.windowsazure.com<br>　PS&gt;TerminatingError(Invoke-WebRequest): <font color="DeepPink">“リモート サーバーがエラーを返しました: (404) 見つかりません”</font><br>__<br>　#TRY!! Invoke-webRequest ceuswatcab01.blob.core.windows.net<br>　PS&gt;TerminatingError(Invoke-WebRequest): <font color="DeepPink">“InvalidQueryParameterValueValue for one of the query parameters specified in the request URI is invalid. </font>RequestId:3549fc2a-201e-0069-07eb-0edf28000000 Time:2023-11-04T06:52:24.8125809Zcomp”<br>__<br>　#TRY!! Invoke-webRequest md-dlbrhcw4gn5r.z33.blob.storage.azure.net<br>　PS&gt;TerminatingError(Invoke-WebRequest): <font color="DeepPink">“AuthenticationFailedServer failed to authenticate the request. Make sure the value of Authorization header is formed correctly including the signature. </font>RequestId:2a4e4e9a-001c-00bc-34eb-0e8bd7000000 Time:2023-11-04T06:52:28.3332912Z”<br>__</p><p>上記のように<br>　・StatusCode: 200<br>　・404 エラー・403 エラー<br>　・InvalidQueryParameterValueValue<br>　・AuthenticationFailedServer<br>が返却された場合、対象の疎通先より応答 (エラーを含む) が返却されているため、Azure Backup 観点では「疎通ができている」と判断できます。 </p><p><strong>&lt;疎通が失敗しているコマンド結果 例&gt;</strong><br>__<br>　#TRY!! Invoke-webRequest pod01-manag1.jpe.backup.windowsazure.com<br>　PS&gt;TerminatingError(Invoke-WebRequest): <font color="DeepPink">“Unable to connect to the remote server”</font><br>__<br>　#TRY!! Invoke-webRequest weus2watcab01.blob.core.windows.net<br>　PS&gt;TerminatingError(Invoke-WebRequest): <font color="DeepPink">“リモート サーバーに接続できません。”</font><br>__</p><p>上記のように<br>・Unable to connect to the remote server<br>・リモート サーバーに接続できません。<br>が返却された場合、「Invoke-webRequest」コマンドによる該当 FQDN への通信は失敗しており「通信が確立できていない」といえます。</p><h2 id="6-SSL-TLS-設定を確認する"><a href="#6-SSL-TLS-設定を確認する" class="headerlink" title=" 6. SSL, TLS 設定を確認する"></a><a id="6"></a> 6. SSL, TLS 設定を確認する</h2><p>ログ上の後方「TLS CHECK」部分は、SSL/TLS のレジストリキー設定を出力しています。<br>Azure Backup においては、TLS 1.2 が無効化されているマシンの場合、バックアップ構成・バックアップ処理が失敗する可能性があるため確認しております。</p><p>・(参考) TLS 1.2 を有効にしないと、どのような影響がありますか?<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/transport-layer-security#what-is-the-impact-of-not-enabling-tls-12">https://learn.microsoft.com/ja-jp/azure/backup/transport-layer-security#what-is-the-impact-of-not-enabling-tls-12</a></p><p>スクリプトでは、マシン上のレジストリキー<br>(HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\SCHANNEL\Protocols 配下)<br>の値を出力しています。</p><p>(画面例)<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/0990e2f3-b319-4da1-96c6-7e6e4834d820"></p><p>なお、「TLS 1.2」のレジストリキーが明示的に設定されていなくでも、「Windows Server 2012 R2」以降では TLS 1.2 は規定で有効化されています。</p><p>・Azure Backup でのトランスポート層セキュリティ<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/transport-layer-security#verify-windows-registry">https://learn.microsoft.com/ja-jp/azure/backup/transport-layer-security#verify-windows-registry</a><br>　引用：”ここに示す値は、Windows Server 2012 R2 以降のバージョンでは既定で設定されています。 これらのバージョンの Windows では、レジストリ キーが存在しない場合、作成する必要はありません。”</p><p>Azure Backup の失敗において、TLS 1.2 プロトコルに関わる懸念がある場合は、対象マシン上のその他の設定箇所も確認しながら、トラブルシューティングを進めていくこととなります。</p><p>・.NET Framework で TLS 1.1 および TLS 1.2 を有効化する方法 - まとめ - | Japan Developer Support Internet Team Blog (jpdsi.github.io)<br>　<a href="https://jpdsi.github.io/blog/internet-explorer-microsoft-edge/dotnet-framework-tls12/">https://jpdsi.github.io/blog/internet-explorer-microsoft-edge/dotnet-framework-tls12/</a></p><p>説明は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、下記ブログにてご案内している「1. Windows VM における Azure Backup 疎通確認」スクリプトの実行結果について、実行結果の見方・Az</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>ASR モビリティ サービス自動更新用 Automation アカウントの認証をマネージド ID へ移行する際、[修復] といったボタンが表示される</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureSiteRecovery/FixButtonDuringAutomationAccountMigratie/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureSiteRecovery/FixButtonDuringAutomationAccountMigratie/</id>
    <published>2023-12-13T00:00:00.000Z</published>
    <updated>2024-08-27T06:06:49.065Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>みなさんこんにちは、Azure Site Recovery サポートです。<br>今回は、Azure Site Recovery ( 以下、ASR ) にて使用される、マネージド ID の設定についてのご案内です。</p><p>ASR 自動更新には Azure Automation の実行アカウントが利用されますが、Azure Automation 実行アカウントは 2023 年 9 月 30 日に廃止されることが決まっており、マネージド ID へ移行する必要がございます。<br>具体的な移行手順については公開情報にご案内がある他、本ブログ内でも手動で移行する方法についてご案内がございます。</p><p>・既存の実行アカウントからマネージド ID に移行する<br><a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/how-to-migrate-run-as-accounts-managed-identity#migrate-from-an-existing-run-as-account-to-a-managed-identity">https://learn.microsoft.com/ja-jp/azure/site-recovery/how-to-migrate-run-as-accounts-managed-identity#migrate-from-an-existing-run-as-account-to-a-managed-identity</a></p><p>・ASR 自動更新に利用する Automation アカウントの Managed ID への移行方法について<br><a href="https://jpabrs-scem.github.io/blog/AzureSiteRecovery/HowToChangeAzureAutomationManagedId/">https://jpabrs-scem.github.io/blog/AzureSiteRecovery/HowToChangeAzureAutomationManagedId/</a></p><p>移行手順については、上記公開情報にもご案内ある通り、基本的に [Site Recovery インフラストラクチャ] &gt; [拡張機能の更新の設定] から [移行] ボタンをクリックいただくのみとなります。<br>ただし、[移行] ボタンの他に、[修復] といったボタンが表示される場合がございます。<br>それは、Site Recovery のインフラストラクチャ＞拡張機能の更新の設定 画面に表示される “自動更新の設定が異常です” のエラー メッセージが発生している、つまり、一般的にモビリティ サービス自動更新用 Automation アカウントの認証に使用する実行アカウントの証明書がまもなく期限切れとなる場合などに表示されます。</p><h3 id="対処策"><a href="#対処策" class="headerlink" title="対処策"></a>対処策</h3><p>この問題を解決するには、[修復] ボタンを押下後に対象 Automation アカウントの実行アカウントの画面に遷移しますので、遷移後の画面で [証明書の更新] ボタンを押下することで証明書を更新できます。<br>なお、こちらマネージド ID へ移行済みである場合は、特段対応は不要になります。</p><p><img src="https://github.com/jpabrs-scem/blog/assets/140866391/7dec6094-e35e-4952-b1db-7ca64ea3e337" alt="Image"></p><p>・一般的な問題とトラブルシューティング<br><a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/azure-to-azure-autoupdate#common-issues-and-troubleshooting">https://learn.microsoft.com/ja-jp/azure/site-recovery/azure-to-azure-autoupdate#common-issues-and-troubleshooting</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;みなさんこんにちは、Azure Site Recovery サポートです。&lt;br&gt;今回は、Azure Site Recovery ( 以下、ASR ) にて使用される、マネージド ID の設定についてのご案内です。&lt;/p&gt;
&lt;</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure Site Recovery" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Site-Recovery/"/>
    
  </entry>
  
  <entry>
    <title>Azure Backup の障害調査に必要な情報 (疎通確認)</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/</id>
    <published>2023-12-12T03:00:00.000Z</published>
    <updated>2024-08-27T06:06:49.037Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートの山本です。<br>今回は Azure Backup のバックアップ失敗、リストア失敗の時の調査をするにあたり、NW 観点で提供いただきたい情報をお伝えいたします。<br>NW 観点以外の情報採集提供依頼については下記をご覧ください<br>・Azure Backup の障害調査に必要な情報<br><a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigating/">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigating/</a></p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Windows VM における Azure Backup 疎通確認</a><br><a href="#2">2. Linux VM における Azure Backup 疎通確認</a><br><a href="#3">3. プライベート エンドポイント環境における Azure Backup 疎通確認</a></p><hr><h2 id="1-Windows-VM-における-Azure-Backup-疎通確認"><a href="#1-Windows-VM-における-Azure-Backup-疎通確認" class="headerlink" title="1. Windows VM における Azure Backup 疎通確認"></a>1. Windows VM における Azure Backup 疎通確認<a id="1"></a></h2><p>まず、下記 リンク先から疎通確認スクリプトのダウンロードをお願いします。<br><a href="https://github.com/jpabrs-scem/blog/files/11648460/Check_Backup_NW_ver1.7.zip">Check_Backup_NW_ver1.7.zip</a></p><p>(スクリプト実行手順)</p><ol><li>疎通確認スクリプトをダウンロードし、展開してください。<br>※ ファイルの解凍パスワードは <strong>“AzureBackup”</strong> となります。</li><li>PowerShell を右クリックし、管理者として実行をクリックしてください。</li></ol><p> <img src="https://user-images.githubusercontent.com/71251920/175529513-5196c393-be7b-439e-aba3-063969d1ce26.png"></p><ol start="3"><li>PowerShell にて手順 1 で展開したスクリプトの場所に移動してください。<br>例 ) “Takato” というユーザーのデスクトップ上の PowerShell というフォルダ内にスクリプトをダウンロードしたときの移動コマンド<blockquote><p>cd C:\Users\Takato\Desktop\powershell</p></blockquote></li><li>以下コマンドを実行し、スクリプトを実行してください。<br>(現在画像とバージョンが異なりますが、同様の手順でございます。)<blockquote><p>.\Check_Backup_NW_ver1.3.ps1<br><img src="https://user-images.githubusercontent.com/71251920/175529518-afd3ab91-e450-42b9-b7b6-310c6633cca1.png"></p></blockquote></li></ol><ul><li>上記スクリプト実施時に実行ポリシーの制限によりスクリプトが実行できない場合はPowerShell を管理者権限で起動し、下記コマンドを実行し実行ポリシーを変更後、再度実行していただければ幸いでございます。<blockquote><p>Set-ExecutionPolicy Unrestricted</p></blockquote></li></ul><ol start="5"><li>以下のような “ScriptStart Completed” 出力がされるまで、お待ちください。</li></ol><p>*コマンドの実行には、環境によって 20 分ほど要する場合がございます。20 分経っても完了しない場合は、control + c を押下して強制終了してください。</p><p><img src="https://user-images.githubusercontent.com/71251920/175529520-b67e7eab-baef-4036-8c89-64ec9a86e40b.gif"></p><ol start="6"><li>コマンド実行が完了すると、スクリプトと同じフォルダ内に以下のようなログファイルが出力されますので、弊社までご提供お願いいたします。<br>ログファイル名: AzureBackup_Check_NW_yyyymmdd_hhmmss.log</li></ol><p><img src="https://user-images.githubusercontent.com/71251920/175529523-b5004d01-f4cd-4879-9c48-b9de17a8c477.jpg"></p><ul><li>control + c にて強制終了した場合においても該当のログファイルが出力されますので、弊社までご提供お願いいたします。</li></ul><h2 id="2-Linux-VM-における-Azure-Backup-疎通確認"><a href="#2-Linux-VM-における-Azure-Backup-疎通確認" class="headerlink" title="2. Linux VM における Azure Backup 疎通確認"></a>2. Linux VM における Azure Backup 疎通確認<a id="2"></a></h2><p>まず、下記 リンク先から疎通確認スクリプトのダウンロードをお願いします。<br><a href="https://github.com/jpabrs-scem/blog/files/13433813/Check_Backup_NW_Linux_ver1.5.zip">Check_Backup_NW_Linux_ver1.5.zip</a></p><p>(スクリプト実行手順)</p><ol><li><p>疎通確認スクリプトをダウンロードし、展開してください。<br>※ ファイルの解凍パスワードは <strong>“AzureBackup”</strong> となります。</p></li><li><p>対象の Linux マシンにスクリプトを移動し実行します。<br>必要に応じて chmod コマンドなどを用いてパーミッションを変更してください。</p><blockquote><p>chmod 777 Check_Backup_NW_Linux_ver1.4.sh </p></blockquote></li></ol><p>下記のように実行します。</p><blockquote><p>./Check_Backup_NW_Linux_ver1.4.sh</p></blockquote><ol start="3"><li>実行完了<br>実行が完了すれば下記のファイルが作成されます。<br>弊社までご提供お願いいたします。<blockquote><p>ログファイルは CheckNWResult_(ホスト名)_(YYYYMMDDHHMM).log です。</p></blockquote></li></ol><h3 id="2-1-参考画像"><a href="#2-1-参考画像" class="headerlink" title="2.1 参考画像"></a>2.1 参考画像</h3><p><img src="https://user-images.githubusercontent.com/71251920/185762249-d5dbed3c-9bce-409e-8a88-a5b43a52fe95.png" alt="-参考画像-"></p><h2 id="3-プライベート-エンドポイント環境における-Azure-Backup-疎通確認"><a href="#3-プライベート-エンドポイント環境における-Azure-Backup-疎通確認" class="headerlink" title="3. プライベート エンドポイント環境における Azure Backup 疎通確認"></a>3. プライベート エンドポイント環境における Azure Backup 疎通確認<a id="3"></a></h2><p> Azure VM 上の DB のバックアップ (Azure  SQL VM Backup や　Azure SAP HANA バックアップ) や MARS エージェントを利用したバックアップで<strong>プライベート エンドポイントをご利用の場合</strong>は下記もご対応お願いします。</p><p>・必須の DNS エントリを取得する<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/private-endpoints#step-1-get-required-dns-entries">https://learn.microsoft.com/ja-jp/azure/backup/private-endpoints#step-1-get-required-dns-entries</a></p><p>上記 URL に従って下記  PowerShell スクリプトをご実施いただき、名前解決ができるかおよび疎通確認をお願いします。</p><p><a href="https://download.microsoft.com/download/1/2/6/126a410b-0e06-45ed-b2df-84f353034fa1/PrivateIP.ps1">PrivateIP.ps1</a></p><p>*Azure PowerShell が実行できる (Az moduleがインストールされた) 環境でご実施ください。</p><p>・[ご参考] Install the Azure Az PowerShell module<br><a href="https://learn.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-8.3.0">https://learn.microsoft.com/en-us/powershell/azure/install-az-ps?view=azps-8.3.0</a></p><h3 id="結果に-“backup”-が含まれる場合から1つの宛先に対する疎通確認"><a href="#結果に-“backup”-が含まれる場合から1つの宛先に対する疎通確認" class="headerlink" title="結果に “backup” が含まれる場合から1つの宛先に対する疎通確認"></a>結果に “backup” が含まれる場合から1つの宛先に対する疎通確認</h3><p>“privatlink” 付の FQDN に対して疎通確認を行ってください。<br>実施いただいたスクリプトの実行結果と後述の疎通確認コマンドの結果をテキスト(可能であれば画面ショットも添えて) zip などにおまとめの上ご提供お願いします。</p><blockquote><p>スクリプト実行結果例)<br><code> </code> &lt;vaultId&gt;-ab-pod01-fc1      <strong>privatelink</strong>.eus.<strong>backup</strong>.windowsazure.com     10.12.0.15</p></blockquote><p>スクリプトの実行結果が上記の場合は下記のようにお願いします。<br>また hosts ファイルをご利用の場合は nslookup コマンドの代わりに ping コマンドをご利用ください。</p><p><strong>windows(PowerShell)</strong></p><blockquote><p>nslookup(ping) &lt;vaultId&gt;-ab-pod01-fc1.<strong>privatelink</strong>.eus.backup.windowsazure.com<br>tnc -port 443 &lt;vaultId&gt;-ab-pod01-fc1.<strong>privatelink</strong>.eus.backup.windowsazure.com<br>tnc -port 443 10.12.0.15<br>Invoke-WebRequest https://&lt;vaultId&gt;-ab-pod01-fc1.<strong>privatelink</strong>.eus.backup.windowsazure.com<br>Invoke-WebRequest <a href="https://10.12.0.15/">https://10.12.0.15</a></p></blockquote><p><strong>Linux</strong></p><blockquote><p>nslookup(ping) &lt;vaultId&gt;-ab-pod01-fc1.<strong>privatelink</strong>.eus.backup.windowsazure.com<br>nc -vz &lt;vaultId&gt;-ab-pod01-fc1.<strong>privatelink</strong>.eus.backup.windowsazure.com 443<br>nc -vz  10.12.0.15　443<br>curl -I https://&lt;vaultId&gt;-ab-pod01-fc1.<strong>privatelink</strong>.eus.backup.windowsazure.com<br>curl -I <a href="https://10.12.0.15/">https://10.12.0.15</a> </p></blockquote><h3 id="結果に-“backup”-が含まれない-“blob”-や”queue”等が含まれる-場合"><a href="#結果に-“backup”-が含まれない-“blob”-や”queue”等が含まれる-場合" class="headerlink" title="結果に “backup” が含まれない (“blob” や”queue”等が含まれる) 場合"></a>結果に “backup” が含まれない (“blob” や”queue”等が含まれる) 場合</h3><p>こちらは初期調査では一旦不要です。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートの山本です。&lt;br&gt;今回は Azure Backup のバックアップ失敗、リストア失敗の時の調査をするにあたり、NW 観点で提供いただきたい情報をお伝えいたします。&lt;br&gt;NW</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="情報採取" scheme="https://jpabrs-scem.github.io/blog/tags/%E6%83%85%E5%A0%B1%E6%8E%A1%E5%8F%96/"/>
    
  </entry>
  
</feed>
