<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan CSS ABRS  Support Blog !!</title>
  
  <subtitle>Azure Backup , Azure Site Recovery , Azure Migrate に関するサポート情報を発信します。</subtitle>
  <link href="https://jpabrs-scem.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpabrs-scem.github.io/blog/"/>
  <updated>2023-10-30T10:53:16.243Z</updated>
  <id>https://jpabrs-scem.github.io/blog/</id>
  
  <author>
    <name>Japan CSS ABRS &amp; SCEM Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Proxy Server を経由した、SQL Server DB に対する Azure Backup を構成する方法</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureSQLBackup/How_To_SQL_Backup_Via_Proxy/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureSQLBackup/How_To_SQL_Backup_Via_Proxy/</id>
    <published>2023-10-01T03:00:00.000Z</published>
    <updated>2023-10-30T10:53:16.243Z</updated>
    
    <content type="html"><![CDATA[<p>皆様こんにちは、Azure Backup サポートです。<br>今回は、Proxy Server を経由した、SQL Server DB に対する Azure Backup を構成する方法についてお伝えします。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>SQL Server DB に対する Azure Backupを、Proxy Server をバイパスし、PE 経由でバックアップする方法につきましては、以下の記事でご案内しております。</p><hr><p>・ SQL Server DB に対する Azure Backupを、Proxy Serverをバイパスして PE 経由でバックアップする場合の設定</p><p>　 <a href="https://jpabrs-scem.github.io/blog/AzureSQLBackup/How_to_PE_SQL_backup_bypass_proxy/">https://jpabrs-scem.github.io/blog/AzureSQLBackup/How_to_PE_SQL_backup_bypass_proxy/</a></p></div><h2 id="目次-手順概略"><a href="#目次-手順概略" class="headerlink" title="目次 - 手順概略"></a>目次 - 手順概略</h2><hr><p><a href="#1">1. 認証なしの Proxy Server を用意する</a><br><a href="#2">2. バックアップ対象の SQL Server DB が存在する Azure 仮想マシン上で、Local System アカウントに対して、プロキシを設定する</a><br><a href="#3">3. 「データベースの検出」「バックアップの有効化」を実施する</a><br><a href="#4">4. バックアップ対象の SQL Server DB が存在する Azure 仮想マシン上で、サービス アカウント ( NT Service\AzureWLBackupPluginSvc ) に対して、プロキシを設定する</a><br><a href="#5">5. SQL Server DB に対する Azure Backup「今すぐバックアップ」を実行</a>  </p><hr><h2 id="1-認証なしの-Proxy-Server-を用意する"><a href="#1-認証なしの-Proxy-Server-を用意する" class="headerlink" title=" 1. 認証なしの Proxy Server を用意する"></a><a id="1"></a> 1. 認証なしの Proxy Server を用意する</h2><p>認証を要求しない Proxy Server をご用意ください。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>認証付きの Proxy Server はご利用いただけませんので、ご注意ください。</p></div><h2 id="2-バックアップ対象の-SQL-Server-DB-が存在する-Azure-仮想マシン上で、Local-System-アカウントに対して、プロキシを設定する"><a href="#2-バックアップ対象の-SQL-Server-DB-が存在する-Azure-仮想マシン上で、Local-System-アカウントに対して、プロキシを設定する" class="headerlink" title=" 2. バックアップ対象の SQL Server DB が存在する Azure 仮想マシン上で、Local System アカウントに対して、プロキシを設定する"></a><a id="2"></a> 2. バックアップ対象の SQL Server DB が存在する Azure 仮想マシン上で、Local System アカウントに対して、プロキシを設定する</h2><h4 id="Local-System-アカウントに対するプロキシ設定手順の詳細"><a href="#Local-System-アカウントに対するプロキシ設定手順の詳細" class="headerlink" title="Local System アカウントに対するプロキシ設定手順の詳細"></a>Local System アカウントに対するプロキシ設定手順の詳細</h4><ol><li><p>以下より PsExec をダウンロードします。​  </p><ul><li>PsExec v2.2<br><a href="https://docs.microsoft.com/ja-jp/sysinternals/downloads/psexec">https://docs.microsoft.com/ja-jp/sysinternals/downloads/psexec</a>  </li></ul></li><li><p>管理者特権のコマンド プロンプトから、ダウンロードしたファイルを解凍したフォルダに移動し、次のコマンドを実行して Internet Explorer を開きます。​  </p><ul><li>(実行コマンド)<br><code>psexec -i -s &quot;c:\Program Files\Internet Explorer\iexplore.exe&quot;​</code></li></ul></li><li><p>以下の画面が出た場合には、<code>Agree</code> を選択します。<br> <img src="https://github.com/jpabrs-scem/blog/assets/124880886/4baf88bf-216c-42ad-aef4-aca75108afb1" alt="PsExec License Agreement"></p></li><li><p>Internet Explorer が起動されるため、<code>[Tools] &gt; [Internet Options] &gt; [Connections] &gt; [LAN settings]</code>の順に移動します。  </p> <img src="https://github.com/jpabrs-scem/blog/assets/124880886/e3f1e1d4-f3eb-41db-a07f-59a7c8e59399" width="400"></li><li><p><code>Proxy Server</code> 欄の以下項目のチェックを有効化し、Proxy Server の IP およびポート番号を入力します。<br><code>Use a proxy server for your LAN …</code></p> <img src="https://github.com/jpabrs-scem/blog/assets/124880886/cd475c7f-a266-475d-a76a-47da64b1b7e4" width="400"></li><li><p><code>Proxy Server</code> 欄の以下項目のチェックを有効化します。<br> <code>Bypass proxy server for local addresses</code></p><div class="alert is-info"><p class="alert-title">Note</p><p>VM 内の localhost 通信はプロキシから除外します。  </p></div> <img src="https://github.com/jpabrs-scem/blog/assets/124880886/451d67c3-07df-44e0-9521-165773004f78" width="400"></li><li><p><code>Proxy Server</code> 欄の <code>[Advanced]</code> を選択します。</p> <img src="https://github.com/jpabrs-scem/blog/assets/124880886/3992f893-17fa-4629-bd3d-e87713c61db5" width="400"></li><li><p><code>Exceptions</code> 欄に、プロキシから除外する IP アドレスおよび FQDN を入力します。<br> Azure VM においては、以下の 3 項目を入力ください。  </p><ul><li>localhost</li><li>168.63.129.16 (Wire Server)</li><li>169.254.169.254 (Azure Instance Metadata Service)<img src="https://github.com/jpabrs-scem/blog/assets/124880886/cdad2f29-f7aa-4e07-a8c9-0a10b57a2e64" width="400"></li></ul></li><li><p>各設定を <code>OK</code> ボタンを押下して保存してください。プロキシ設定は完了です。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>バックアップ対象の SQL Server DB が存在する Azure 仮想マシンで、</p><p>ネットワーク セキュリティ グループや Firewall によって、Proxy Server に対するアウトバウンド通信が制限されていないことを、あらかじめご確認ください。  </p></div></li></ol><h2 id="3-「データベースの検出」「バックアップの有効化」を実施する"><a href="#3-「データベースの検出」「バックアップの有効化」を実施する" class="headerlink" title=" 3. 「データベースの検出」「バックアップの有効化」を実施する"></a><a id="3"></a> 3. 「データベースの検出」「バックアップの有効化」を実施する</h2><p>Azure ポータル上から、バックアップ対象の SQL Server DB に対して「データベースの検出」「バックアップの有効化」を行います。<br>以下手順に沿って実施してください。  </p><ul><li><p>SQL Server データベースを検出する<br>コンテナーから複数の SQL Server VM をバックアップする - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#discover-sql-server-databases">https://learn.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#discover-sql-server-databases</a></p></li><li><p>バックアップの構成<br>コンテナーから複数の SQL Server VM をバックアップする - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#configure-backup">https://learn.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#configure-backup</a></p></li></ul><h2 id="4-バックアップ対象の-SQL-Server-DB-が存在する-Azure-仮想マシン上で、サービス-アカウント-NT-Service-AzureWLBackupPluginSvc-に対して、プロキシを設定する"><a href="#4-バックアップ対象の-SQL-Server-DB-が存在する-Azure-仮想マシン上で、サービス-アカウント-NT-Service-AzureWLBackupPluginSvc-に対して、プロキシを設定する" class="headerlink" title=" 4. バックアップ対象の SQL Server DB が存在する Azure 仮想マシン上で、サービス アカウント ( NT Service\AzureWLBackupPluginSvc ) に対して、プロキシを設定する"></a><a id="4"></a> 4. バックアップ対象の SQL Server DB が存在する Azure 仮想マシン上で、サービス アカウント ( NT Service\AzureWLBackupPluginSvc ) に対して、プロキシを設定する</h2><p>項目 3 にて実施した「データベースの検出」によって、VM 上にサービス アカウント ( NT Service\AzureWLBackupPluginSvc ) が作成されるため、このサービス アカウントに対してもプロキシ設定を行います。  </p><div class="alert is-info"><p class="alert-title">Note</p><p>サービス アカウントのプロキシ設定は、サービス アカウントのレジストリ キーを編集することで設定しますが、</p><p>設定する一部の値の型が “REG_BINARY” となり、バイナリ データを登録する必要がございます。</p><p>設定の簡易化のため、本手順では、現在ログインしているユーザー (カレント ユーザー) のプロキシ設定を継承する PowerShell コマンド (スクリプト) を用いて、サービス アカウントのプロキシ設定を行います。  </p></div><h3 id="サービス-アカウント-NT-Service-AzureWLBackupPluginSvc-に対するプロキシ設定手順の詳細"><a href="#サービス-アカウント-NT-Service-AzureWLBackupPluginSvc-に対するプロキシ設定手順の詳細" class="headerlink" title="サービス アカウント ( NT Service\AzureWLBackupPluginSvc ) に対するプロキシ設定手順の詳細"></a>サービス アカウント ( NT Service\AzureWLBackupPluginSvc ) に対するプロキシ設定手順の詳細</h3><ol><li><p>レジストリ エディターを開き、以下パスに遷移し、サービス アカウント ( NT Service\AzureWLBackupPluginSvc ) が作成されていることを確認します。<br><code>HKEY_USERS\S-1-5-80-1631947889-4033244730-3205203906-53534054-4184208151</code>  </p><img src="https://github.com/jpabrs-scem/blog/assets/124880886/66d6c303-da57-403c-a2d6-1db766ff2c03" width="500"><div class="alert is-warning"><p class="alert-title">警告</p><p>もし上記レジストリ キーが存在していない場合、上記項目 3 の「データベースの検出」「バックアップの有効化」が正常に完了していない可能性がございます。</p><p>あらためて、「データベースの検出」「バックアップの有効化」操作が成功していることをご確認ください。</p></div></li><li><p>現在ログインしているユーザー (カレント ユーザー) で、<code>[設定] &gt; [ネットワークとインターネット] &gt; [プロキシ]</code> を開き、一時的に Proxy Server を設定します。<br>上記項目 2 と同じプロキシ設定を行ってください。  </p> <img src="https://github.com/jpabrs-scem/blog/assets/124880886/93c32f74-2bcc-42ee-a57c-8c142d7dfa04" width="500"></li><li><p>下記リンク先から、サービス アカウント ( NT Service\AzureWLBackupPluginSvc ) に対するプロキシを設定するスクリプトをダウンロードします。  </p><ul><li><a href="https://github.com/jpabrs-scem/blog/files/12788965/SetProxyforAzureWLBackupPluginSvcfromCurrentUser.zip">SetProxyforAzureWLBackupPluginSvcfromCurrentUser.zip</a></li></ul></li><li><p>バックアップ対象の SQL Server DB が存在する Azure 仮想マシン上に、ダウンロードしたスクリプトを配置し、展開します。  </p><ul><li>ファイルの解凍パスワードは <strong><code>AzureBackup</code></strong> です</li></ul></li><li><p>管理者特権の PowerShell から、ダウンロードしたファイルを解凍したフォルダに移動し、次のコマンドを実行します。</p><ul><li>(実行コマンド)<br><code>.\SetProxyforAzureWLBackupPluginSvcfromCurrentUser.ps1</code>  </li><li>スクリプトを実行すると、以下ログファイルが作成されます。<br><code>&lt;スクリプトを実行したフォルダ&gt;/AzureBackup_Set_Proxy_For_AzureWLBackup_PluginSvc_yyyyMMdd_HHmmss.log</code></li></ul> <img src="https://github.com/jpabrs-scem/blog/assets/124880886/898d1c2e-7c84-48a6-9818-d159883e64ae" width="900"><div class="alert is-warning"><p class="alert-title">警告</p><p>本手順でご案内しているスクリプトについては、お客様の責任のもと、ご利用いただきますようお願い申し上げます。</p><p>スクリプト実行時のエラーや、想定外の問題について、当社は責任を負いかねますのでご了承ください。</p></div></li><li><p>現在ログインしているユーザー (カレント ユーザー) で、<code>[設定] &gt; [ネットワークとインターネット] &gt; [プロキシ]</code> を開き、Proxy Server の設定を元に戻します。</p></li></ol><h3 id="サービス-アカウント-NT-Service-AzureWLBackupPluginSvc-に対するプロキシ設定の確認手順"><a href="#サービス-アカウント-NT-Service-AzureWLBackupPluginSvc-に対するプロキシ設定の確認手順" class="headerlink" title="サービス アカウント ( NT Service\AzureWLBackupPluginSvc ) に対するプロキシ設定の確認手順"></a>サービス アカウント ( NT Service\AzureWLBackupPluginSvc ) に対するプロキシ設定の確認手順</h3><ol><li><p>以下ドキュメントにある「Azure Backup 接続テスト スクリプト (AzureBackupConnectivityTestScriptsForWindows.zip) 」を対象 Azure 仮想マシン上にダウンロードし、 zip ファイルを展開します。</p><ul><li>Azure Backup 接続テスト スクリプト<br>コンテナーから複数の SQL Server VM をバックアップする - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#establish-network-connectivity">https://learn.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#establish-network-connectivity</a></li></ul></li><li><p>展開した zip ファイル内の「Start-ConnectivityTests.ps1」を、対象 Azure 仮想マシン上で実行します。</p><ul><li>(実行コマンド)<br><code>.\Start-ConnectivityTests.ps1</code>  </li></ul></li><li><p>「Start-ConnectivityTests.ps1」を実行した後、ターミナル上に出力された結果に問題が無いことを確認します。</p><ul><li><ol><li><code>WinInet settings for NT Authority\System (used by Azure Workload Backup Coordinator service)</code> の以下項目の値が、以下のとおりであることを確認します。</li></ol><ul><li>ProxyEnable : 1</li><li>ProxyServer : 利用する Proxy Server とそのポート番号</li><li>ProxyOverride : プロキシから除外した接続先<br>例) <code>localhost, 168.63.129.16 (Wire Server), 169.254.169.254 (Azure Instance Metadata Service)</code></li></ul></li><li><ol start="2"><li><code>WinInet settings for NT Service\AzureWLBackupPluginSvc (used by Azure Workload Backup Plugin service)</code> の以下項目の値が、以下のとおりであることを確認します。</li></ol><ul><li>ProxyEnable : 1</li><li>ProxyServer : 利用する Proxy Server とそのポート番号</li><li>ProxyOverride : プロキシから除外した接続先<br>例) <code>localhost, 168.63.129.16 (Wire Server), 169.254.169.254 (Azure Instance Metadata Service)</code></li></ul></li></ul> <img src="https://github.com/jpabrs-scem/blog/assets/124880886/23248c75-35d3-4453-84f6-dab43917f7d8" width="800"></li></ol><h2 id="5-SQL-Server-DB-に対する-Azure-Backup「今すぐバックアップ」を実行"><a href="#5-SQL-Server-DB-に対する-Azure-Backup「今すぐバックアップ」を実行" class="headerlink" title=" 5. SQL Server DB に対する Azure Backup「今すぐバックアップ」を実行"></a><a id="5"></a> 5. SQL Server DB に対する Azure Backup「今すぐバックアップ」を実行</h2><p>Azure ポータル画面上で設定した、バックアップ ポリシーに従った次回の スケジュールバックアップが成功することを確認いただく、もしくは「今すぐバックアップ」を実行してオンデマンド バックアップが成功することをご確認ください。  </p><ul><li>オンデマンド バックアップを実行する<br>チュートリアル - Azure への SQL Server データベースのバックアップ - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/tutorial-sql-backup#run-an-on-demand-backup">https://learn.microsoft.com/ja-jp/azure/backup/tutorial-sql-backup#run-an-on-demand-backup</a></li></ul><p>Proxy Server を経由した、SQL Server DB に対する Azure Backup を構成する方法は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、Proxy Server を経由した、SQL Server DB に対する Azure Backup を構成する方法についてお伝えします。&lt;/p&gt;
&lt;div class=&quot;alert is-succes</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure SQL Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-SQL-Backup/"/>
    
  </entry>
  
  <entry>
    <title>SQL Server DB に対する Azure Backupを、Proxy Serverをバイパスして PE 経由でバックアップする場合の設定</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureSQLBackup/How_to_PE_SQL_backup_bypass_proxy/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureSQLBackup/How_to_PE_SQL_backup_bypass_proxy/</id>
    <published>2023-10-01T03:00:00.000Z</published>
    <updated>2023-10-30T10:53:16.243Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、SQL Server DB に対する Azure Backupを、Proxy Serverをパイパスして PE 経由でバックアップする場合の設定方法についてお伝えします。</p><h4 id="ポイント"><a href="#ポイント" class="headerlink" title="ポイント"></a>ポイント</h4><h5 id="ポイントその-1"><a href="#ポイントその-1" class="headerlink" title="( ポイントその 1 )"></a>( ポイントその 1 )</h5><p>Poxyを経由させてSQL Server DB に対する Azure Backupを行いたい場合は、下記2種類のアカウントに対して、クライアントOS上でProxy設定を行う必要があります。<br>　１つ目：Local System アカウント<br>　２つ目：NT Service\AzureWLBackupPluginSvcアカウント</p><p>そのため、Proxyは経由せず（＝「Proxyをバイパスする」）、バックアップを取得したい場合は、上記 ２ つのアカウントに対してバイパス設定を行う必要があります。<br>※もともと２つのアカウントに対してProxy Server 設定を行っていないのであれば、SQL Server DB に対する Azure BackupにおいてProxyを経由してバックアップすることはありません。</p><p>上記２つのアカウントに対してProxyを設定している、かつ　Proxy を経由せずに、プライベート エンドポイント（PE）経由でSQL Backupをさせたい場合、下記をバイパスさせる必要があります。<br>（例外リスト/バイパスリスト）<br>    　LocalHost 、Wire Server （168.63.129.16）、169.254.169.254、以下ドキュメント記載のAzure Backup、Azure Storage、Azure Active Directory</p><p>・プライベート エンドポイントを使用して Recovery Services コンテナー用のプロキシ サーバーを設定する<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/private-endpoints#set-up-proxy-server-for-recovery-services-vault-with-private-endpoint">https://docs.microsoft.com/ja-jp/azure/backup/private-endpoints#set-up-proxy-server-for-recovery-services-vault-with-private-endpoint</a> </p><h5 id="ポイントその-2"><a href="#ポイントその-2" class="headerlink" title="( ポイントその 2 )"></a>( ポイントその 2 )</h5><p>本ブログ記事作成時点 (2022/10) では、Azure Active Directory ( =AAD ) はプライベート エンドポイントに対応していませんので、AAD は PE 以外の疎通ルートを確立させる必要があります。</p><h2 id="目次-手順概略"><a href="#目次-手順概略" class="headerlink" title="目次 - 手順概略"></a>目次 - 手順概略</h2><hr><p><a href="#1">1. Recovery Services コンテナー上にプライベート エンドポイントを作成</a><br><a href="#2">2．バックアップ対象の SQL Server DB が存在する Azure 仮想マシン上で、Local System アカウントに対して、SQL Server DB に対する Azure Backup サービスがバイパスされるよう、設定</a><br><a href="#3">3. 「データベースの検出」「バックアップの有効化」</a><br><a href="#4">4. バックアップ対象の SQL Server DB が存在する Azure 仮想マシン上で、サービスアカウント ( NT Service\AzureWLBackupPluginSvc ) に対して、 SQL Server DB に対する Azure Backup サービスがバイパスされるよう、設定</a><br><a href="#5">5. SQL Server DB に対する Azure Backup「今すぐバックアップ」を実行</a></p><hr><h2 id="1-Recovery-Services-コンテナー上にプライベート-エンドポイントを作成"><a href="#1-Recovery-Services-コンテナー上にプライベート-エンドポイントを作成" class="headerlink" title=" 1. Recovery Services コンテナー上にプライベート エンドポイントを作成"></a><a id="1"></a> 1. Recovery Services コンテナー上にプライベート エンドポイントを作成</h2><p>こちらは 弊社公開ドキュメントに詳細手順を公開しておりますので、下記をご参考に作成ください。<br>・Azure Backup のプライベート エンドポイントの作成と使用<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/private-endpoints">https://docs.microsoft.com/ja-jp/azure/backup/private-endpoints</a> </p><h2 id="2．バックアップ対象の-SQL-Server-DB-が存在する-Azure-仮想マシン上で、Local-System-アカウントに対して、SQL-Server-DB-に対する-Azure-Backup-サービスがバイパスされるよう、設定"><a href="#2．バックアップ対象の-SQL-Server-DB-が存在する-Azure-仮想マシン上で、Local-System-アカウントに対して、SQL-Server-DB-に対する-Azure-Backup-サービスがバイパスされるよう、設定" class="headerlink" title=" 2．バックアップ対象の SQL Server DB が存在する Azure 仮想マシン上で、Local System アカウントに対して、SQL Server DB に対する Azure Backup サービスがバイパスされるよう、設定"></a><a id="2"></a> 2．バックアップ対象の SQL Server DB が存在する Azure 仮想マシン上で、Local System アカウントに対して、SQL Server DB に対する Azure Backup サービスがバイパスされるよう、設定</h2><h5 id="Local-System-アカウント-に対する-Proxy-Server-バイパス設定-手順詳細"><a href="#Local-System-アカウント-に対する-Proxy-Server-バイパス設定-手順詳細" class="headerlink" title="Local System アカウント に対する Proxy Server バイパス設定 手順詳細"></a>Local System アカウント に対する Proxy Server バイパス設定 手順詳細</h5><p>以下より PsExec をダウンロードします。​<br>​　・PsExec v2.2<br>　　<a href="https://docs.microsoft.com/ja-jp/sysinternals/downloads/psexec">https://docs.microsoft.com/ja-jp/sysinternals/downloads/psexec</a> </p><p>管理者特権のプロンプトから ダウンロードしたファイルを解凍したフォルダに移動し 、次のコマンドを実行して Internet Explorer を開きます。​<br>（実行コマンド）</p><blockquote><p>psexec -i -s “c:\Program Files\Internet Explorer\iexplore.exe”​</p></blockquote><p>Internet Explorer で、[ツール] &gt; [インターネット オプション] &gt; [接続] &gt; [LAN の設定] の順に移動します。​<br>システム アカウントの Proxy 設定を確認します。<br>Proxy の IP アドレスとポートを設定します。​</p><p>・下図例では、Proxy Server の IP アドレスが「10.2.0.16」である前提の画面スクリーンショットとなっています。<br>・下図中央の「Local Area Network (LAN) Settings」ウィンドウ ＞ 「Byspass proxy server for local addresses」チェックボックスを ON とします。<br>　これは、下記公開ドキュメント「VM 内の localhost 通信のプロキシを無効にします。」と記載している設定に該当しています。<br>　・トラフィックをルーティングするために HTTP プロキシ サーバーを使用する<br>　　<a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#use-an-http-proxy-server-to-route-traffic">https://docs.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#use-an-http-proxy-server-to-route-traffic</a></p><p>・下図一番右側の「Proxy Settings」ウィンドウ ＞ 「Exceptions」欄に記入すべきものが、SQL Server DB に対する Azure Backup 実行時 (= Local Sysytem アカウントが利用される際) に、Proxy Server を経由させずに通信したい場合のアドレスを入力する欄です。<br>　ここに、以下を記入することで、SQL Server DB に対する Azure Backup 実行時はプロキシをバイパスさせることができます。<br>　LocalHost 、Wire Server （168.63.129.16）、169.254.169.254、上記ドキュメント記載のAzure Backup、Azure Storage、AAD</p><p>(実際の入力値)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">localhost;168.63.129.16;169.254.169.254;*.backup.windowsazure.com;*.queue.core.windows.net;</span><br><span class="line">*.blob.core.windows.net;*.blob.storage.azure.net;*.msftidentity.com;</span><br><span class="line">*.msidentity.com;account.activedirectory.windowsazure.com;accounts.accesscontrol.windows.net;</span><br><span class="line">adminwebservice.microsoftonline.com;api.passwordreset.microsoftonline.com;</span><br><span class="line">autologon.microsoftazuread-sso.com;becws.microsoftonline.com;</span><br><span class="line">clientconfig.microsoftonline-p.net;companymanager.microsoftonline.com;</span><br><span class="line">device.login.microsoftonline.com;graph.microsoft.com;graph.windows.net;login.microsoft.com;</span><br><span class="line">login.microsoftonline.com;login.microsoftonline-p.com;login.windows.net;</span><br><span class="line">logincert.microsoftonline.com;loginex.microsoftonline.com;login-us.microsoftonline.com;</span><br><span class="line">nexus.microsoftonline-p.com;passwordreset.microsoftonline.com;</span><br><span class="line">provisioningapi.microsoftonline.com;20.190.128.*;40.126.*;*.hip.live.com;*.microsoftonline.com;</span><br><span class="line">*.microsoftonline-p.com;*.msauth.net;*.msauthimages.net;*.msecnd.net;*.msftauth.net;</span><br><span class="line">*.msftauthimages.net;*.phonefactor.net;nterpriseregistration.windows.net;management.azure.com;</span><br><span class="line">policykeyservice.dc.ad.msft.net</span><br></pre></td></tr></table></figure><p><img src="https://user-images.githubusercontent.com/96324317/197693453-7e4e98b9-a52b-4965-bd0a-f5751bfd4c90.png"></p><h2 id="3．「データベースの検出」「バックアップの有効化」"><a href="#3．「データベースの検出」「バックアップの有効化」" class="headerlink" title=" 3．「データベースの検出」「バックアップの有効化」"></a><a id="3"></a> 3．「データベースの検出」「バックアップの有効化」</h2><p>Azure ポータル画面上から、対象の SQL Server DB に対して「データベースの検出」「バックアップの有効化」を行います。</p><p>・コンテナーから複数の SQL Server VM をバックアップする - Azure Backup | Microsoft Docs<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#discover-sql-server-databases">https://docs.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#discover-sql-server-databases</a> </p><h2 id="4．バックアップ対象の-SQL-Server-DB-が存在する-Azure-仮想マシン上で、サービスアカウント-NT-Service-AzureWLBackupPluginSvc-に対して、-SQL-Server-DB-に対する-Azure-Backup-サービスがバイパスされるよう、設定"><a href="#4．バックアップ対象の-SQL-Server-DB-が存在する-Azure-仮想マシン上で、サービスアカウント-NT-Service-AzureWLBackupPluginSvc-に対して、-SQL-Server-DB-に対する-Azure-Backup-サービスがバイパスされるよう、設定" class="headerlink" title=" 4．バックアップ対象の SQL Server DB が存在する Azure 仮想マシン上で、サービスアカウント ( NT Service\AzureWLBackupPluginSvc ) に対して、 SQL Server DB に対する Azure Backup サービスがバイパスされるよう、設定"></a><a id="4"></a> 4．バックアップ対象の SQL Server DB が存在する Azure 仮想マシン上で、サービスアカウント ( NT Service\AzureWLBackupPluginSvc ) に対して、 SQL Server DB に対する Azure Backup サービスがバイパスされるよう、設定</h2><p>「バックアップの有効化」が成功後、Azure Backup サービスによって対象マシン上に生成済の「NT Service\AzureWLBackupPluginSvc」アカウントに対する、Proxy Server のバイパス設定を行います。<br>バイパスリストは  Local Sysytem アカウントに対して設定した内容と同一です。<br>下記に、「NT Service\AzureWLBackupPluginSvc」アカウントへの設定手順の一例を記載します。<br>一例としては、カレントユーザーに対して行ったProxy設定を、コマンド実行によって「NT Service\AzureWLBackupPluginSvc」アカウントに対して引き継ぐ手順です。<br>そのため、一時的にまずはカレントユーザーに対しても、Proxy Server のバイパス設定を行います。</p><h5 id="一例-「NT-Service-AzureWLBackupPluginSvc」アカウントに対する-Proxy-バイパス設定-手順詳細"><a href="#一例-「NT-Service-AzureWLBackupPluginSvc」アカウントに対する-Proxy-バイパス設定-手順詳細" class="headerlink" title="(一例) 「NT Service\AzureWLBackupPluginSvc」アカウントに対する Proxy バイパス設定 手順詳細"></a>(一例) 「NT Service\AzureWLBackupPluginSvc」アカウントに対する Proxy バイパス設定 手順詳細</h5><p>まずは「NT Service\AzureWLBackupPluginSvc」アカウントが存在しているかを、念のため確認します。<br>対象マシン上で、スタートボタンを右クリック ＞ ファイル名を指定して実行 ＞ 「regedit」を入力し「OK」をクリックします。<br><img src="https://user-images.githubusercontent.com/96324317/197693696-1df4ae35-e8c8-4afc-b4ff-cf21ab2f912d.png"></p><p><img src="https://user-images.githubusercontent.com/96324317/197693727-6c4cef17-55b3-4865-be4d-660435ad3b4a.png"></p><p>レジストリ エディターが開きますので、以下パスへ遷移します。<br>（対象パス）<br>        HKEY_USERS\S-1-5-80-1631947889-4033244730-3205203906-53534054-4184208151</p><p>上記レジストリキー (フォルダー)「S-1-5-80-1631947889-4033244730-3205203906-53534054-4184208151」が、「NT Service\AzureWLBackupPluginSvc」アカウントを表しています。<br>この時点で存在していない場合、「データベースの検出」「バックアップの有効化」もしくは「再登録」が正常完了していない可能性がありますので、「データベースの検出」「バックアップの有効化」「再登録」が成功しているかどうかを再度確認・再実行願います。<br><img src="https://user-images.githubusercontent.com/96324317/197693875-49891f05-2b67-4040-9641-1f99ca7b271a.png"></p><p>レジストリ エディター上でレジストリキー (フォルダー)「S-1-5-80-1631947889-4033244730-3205203906-53534054-4184208151」が存在していることを確認出来たら、一時的に カレントユーザーに対して Proxy Server の設定を行います。</p><p>・設定内容は、Local System アカウント に対する Proxy Server バイパス設定と同一です<br>・下図例 では、Proxy Server の IP アドレスが「10.2.0.16」である前提の画面スクリーンショットとなっています。<br>・下図中央の「Don’t use the proxy server for local (intranet) addresses」チェックボックスを ON とします。<br>　これは、下記公開ドキュメント「VM 内の localhost 通信のプロキシを無効にします。」と記載している設定に該当しています。<br>　・トラフィックをルーティングするために HTTP プロキシ サーバーを使用する<br>　　<a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#use-an-http-proxy-server-to-route-traffic">https://docs.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#use-an-http-proxy-server-to-route-traffic</a></p><p>・下図一番右側 黄色罫線箇所が、Proxy Server を経由させずに通信したい場合のアドレスを入力する欄です。<br>　ここに、以下を記入することで、SQL Server DB に対する Azure Backup 実行時はプロキシをバイパスさせることができます。<br>　LocalHost 、Wire Server （168.63.129.16）、169.254.169.254、上記ドキュメント記載のAzure Backup、Azure Storage、AAD</p><p>(実際の入力値)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">localhost;168.63.129.16;169.254.169.254;*.backup.windowsazure.com;*.queue.core.windows.net;</span><br><span class="line">*.blob.core.windows.net;*.blob.storage.azure.net;*.msftidentity.com;</span><br><span class="line">*.msidentity.com;account.activedirectory.windowsazure.com;accounts.accesscontrol.windows.net;</span><br><span class="line">adminwebservice.microsoftonline.com;api.passwordreset.microsoftonline.com;</span><br><span class="line">autologon.microsoftazuread-sso.com;becws.microsoftonline.com;</span><br><span class="line">clientconfig.microsoftonline-p.net;companymanager.microsoftonline.com;</span><br><span class="line">device.login.microsoftonline.com;graph.microsoft.com;graph.windows.net;login.microsoft.com;</span><br><span class="line">login.microsoftonline.com;login.microsoftonline-p.com;login.windows.net;</span><br><span class="line">logincert.microsoftonline.com;loginex.microsoftonline.com;login-us.microsoftonline.com;</span><br><span class="line">nexus.microsoftonline-p.com;passwordreset.microsoftonline.com;</span><br><span class="line">provisioningapi.microsoftonline.com;20.190.128.*;40.126.*;*.hip.live.com;*.microsoftonline.com;</span><br><span class="line">*.microsoftonline-p.com;*.msauth.net;*.msauthimages.net;*.msecnd.net;*.msftauth.net;</span><br><span class="line">*.msftauthimages.net;*.phonefactor.net;nterpriseregistration.windows.net;management.azure.com;</span><br><span class="line">policykeyservice.dc.ad.msft.net</span><br></pre></td></tr></table></figure><p><img src="https://user-images.githubusercontent.com/96324317/197693971-4fcf367e-2685-4284-b0f4-4e8c0c457e38.png"></p><p>カレントユーザーに対して、Proxy Server のバイパス設定を保存した後に、下記リンク先から、サービス アカウント ( NT Service\AzureWLBackupPluginSvc ) に対するプロキシを設定するスクリプトをダウンロードします。<br>    - <a href="https://github.com/jpabrs-scem/blog/files/12788965/SetProxyforAzureWLBackupPluginSvcfromCurrentUser.zip">SetProxyforAzureWLBackupPluginSvcfromCurrentUser.zip</a></p><p>バックアップ対象の SQL Server DB が存在する Azure 仮想マシン上に、ダウンロードしたスクリプトを配置し、展開します。<br>    - ファイルの解凍パスワードは <strong><code>AzureBackup</code></strong> です</p><p>管理者特権の PowerShell から、ダウンロードしたファイルを解凍したフォルダに移動し、次のコマンドを実行します。<br>    - (実行コマンド)<br>      <code>.\SetProxyforAzureWLBackupPluginSvcfromCurrentUser.ps1</code><br>    - スクリプトを実行すると、以下ログファイルが作成されます。<br>      <code>&lt;スクリプトを実行したフォルダ&gt;/AzureBackup_Set_Proxy_For_AzureWLBackup_PluginSvc_yyyyMMdd_HHmmss.log</code><br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/2a4e5a11-313e-4d91-bdf2-0557f68c46d1" alt="image"></p><div class="alert is-info"><p class="alert-title">Note</p><p>サービス アカウントのプロキシ設定は、サービス アカウントのレジストリ キーを編集することで設定しますが、</p><p>設定する一部の値の型が “REG_BINARY” となり、バイナリ データを登録する必要がございます。</p><p>設定の簡易化のため、本手順では、現在ログインしているユーザー (カレント ユーザー) のプロキシ設定を継承する 上記のPowerShell コマンド (スクリプト) を用いて、サービス アカウントのプロキシ設定を行います。</p></div><div class="alert is-warning"><p class="alert-title">警告</p><p>本手順でご案内しているスクリプトについては、お客様の責任のもと、ご利用いただきますようお願い申し上げます。</p><p>スクリプト実行時のエラーや、想定外の問題について、当社は責任を負いかねますのでご了承ください。</p></div><p>上記コマンド実行後、カレントユーザーに対する Proxy Server 設定を、元の状態に戻します。<br>念のため、以下スクリプトを実行いただき、Local System アカウントとNT Service\AzureWLBackupPluginSvcアカウントに対して、Proxy Server バイパス設定が正しく設定されているかを確認します。</p><h5 id="１．下記ドキュメント上の「Azure-Backup-接続テスト-スクリプト-AzureBackupConnectivityTestScriptsForWindows-zip-」を対象-Azure-仮想マシン上にダウンロードし、-zip-ファイルを展開します。"><a href="#１．下記ドキュメント上の「Azure-Backup-接続テスト-スクリプト-AzureBackupConnectivityTestScriptsForWindows-zip-」を対象-Azure-仮想マシン上にダウンロードし、-zip-ファイルを展開します。" class="headerlink" title="１．下記ドキュメント上の「Azure Backup 接続テスト スクリプト (AzureBackupConnectivityTestScriptsForWindows.zip) 」を対象 Azure 仮想マシン上にダウンロードし、 zip ファイルを展開します。"></a>１．下記ドキュメント上の「Azure Backup 接続テスト スクリプト (AzureBackupConnectivityTestScriptsForWindows.zip) 」を対象 Azure 仮想マシン上にダウンロードし、 zip ファイルを展開します。</h5><p>・ネットワーク接続を確立する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#establish-network-connectivity">https://learn.microsoft.com/ja-jp/azure/backup/backup-sql-server-database-azure-vms#establish-network-connectivity</a></p><h5 id="２．展開した-zip-ファイル内の「Start-ConnectivityTests-ps1」を、対象-Azure-仮想マシン上で実行します。"><a href="#２．展開した-zip-ファイル内の「Start-ConnectivityTests-ps1」を、対象-Azure-仮想マシン上で実行します。" class="headerlink" title="２．展開した zip ファイル内の「Start-ConnectivityTests.ps1」を、対象 Azure 仮想マシン上で実行します。"></a>２．展開した zip ファイル内の「Start-ConnectivityTests.ps1」を、対象 Azure 仮想マシン上で実行します。</h5><p>今回は、Azure Backup サービスと Azure Storage サービスに対しては、プライベート エンドポイント経由で通信するため、引数に「-IsPrivateEndpointEnabled」を追加して実行します。<br>（実行コマンド 例）</p><blockquote><p>.\Start-ConnectivityTests.ps1 -IsPrivateEndpointEnabled</p></blockquote><p><img src="https://user-images.githubusercontent.com/96324317/197697047-3663b672-184f-499b-b405-e95770135b27.png"></p><p><img src="https://user-images.githubusercontent.com/96324317/197704009-4d226d75-3057-4439-88ae-b2a42af0f7e5.png"></p><p>「Start-ConnectivityTests.ps1」スクリプトを実行後、ターミナル上に結果が返却されます。</p><h5 id="「Start-ConnectivityTests-ps1」実行結果の期待値"><a href="#「Start-ConnectivityTests-ps1」実行結果の期待値" class="headerlink" title="「Start-ConnectivityTests.ps1」実行結果の期待値"></a>「Start-ConnectivityTests.ps1」実行結果の期待値</h5><p>(1)<br>WinInet settings for NT Authority\System (used by Azure Workload Backup Coordinator service)<br>ProxyEnable: <span style="color: red; ">1</span><br>となっていること。(=プロキシ設定 ON を表す)</p><p>(2)<br>WinInet settings for NT Authority\System (used by Azure Workload Backup Coordinator service)<br>「ProxyOverride:」以降が、設定した例外リスト/バイパスリストの内容となっていること</p><p>(3)<br>WinInet settings for NT Service\AzureWLBackupPluginSvc (used by Azure Workload Backup Plugin service)<br>ProxyEnable: <span style="color: red; ">1</span><br>となっていること。(=プロキシ設定 ON を表す)</p><p>(4)<br>WinInet settings for NT Service\AzureWLBackupPluginSv (used by Azure Workload Backup Plugin service)<br>「ProxyOverride:」以降が、設定した例外リスト/バイパスリストの内容となっていること<br><img src="https://user-images.githubusercontent.com/96324317/197704402-d3ac2ec2-6778-4bfa-bf48-356c975f8d4a.png"></p><h2 id="5．SQL-Server-DB-に対する-Azure-Backup「今すぐバックアップ」を実行"><a href="#5．SQL-Server-DB-に対する-Azure-Backup「今すぐバックアップ」を実行" class="headerlink" title=" 5．SQL Server DB に対する Azure Backup「今すぐバックアップ」を実行"></a><a id="5"></a> 5．SQL Server DB に対する Azure Backup「今すぐバックアップ」を実行</h2><p>Azure ポータル画面上で設定した、バックアップ ポリシーに従った次回の スケジュールバックアップが成功することを確認いただく、もしくは「今すぐバックアップ」を実行してオンデマンド バックアップが成功することをご確認ください。</p><p>・オンデマンド バックアップを実行する<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/tutorial-sql-backup#run-an-on-demand-backup">https://docs.microsoft.com/ja-jp/azure/backup/tutorial-sql-backup#run-an-on-demand-backup</a></p><p>SQL Server DB に対する Azure Backupを、Proxy Serverをパイパスして PE 経由でバックアップする場合の設定方法は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、SQL Server DB に対する Azure Backupを、Proxy Serverをパイパスして PE 経由でバックアップする場合の設定方法につい</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure SQL Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-SQL-Backup/"/>
    
  </entry>
  
  <entry>
    <title>バックアップしているクラシック VM を ARM VM へ移行する際の注意点</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/ClassicVm_to_ARM/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/ClassicVm_to_ARM/</id>
    <published>2023-09-27T03:00:00.000Z</published>
    <updated>2023-10-30T10:53:16.247Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>みなさんこんにちは、Azure Backup サポートです。<br>今回は、Azure VM Backup にて、もともとクラシック VM ( = Azure Service Manager (ASM) を介した IaaS 仮想マシン) をバックアップしている場合に、ARM (Azure Resource Manager) VM へと移行する場合の注意点をお伝えします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. はじめに : Azure のクラシック VM は 2023 年 9 月 6 日を持ちまして廃止となりました</a><br><a href="#2">2. バックアップしているクラシック VM を ARM VM へ移行する際の注意点</a></p><hr><h3 id="1-はじめに-Azure-のクラシック-VM-は-2023-年-9-月-6-日を持ちまして廃止となりました"><a href="#1-はじめに-Azure-のクラシック-VM-は-2023-年-9-月-6-日を持ちまして廃止となりました" class="headerlink" title="1. はじめに : Azure のクラシック VM は 2023 年 9 月 6 日を持ちまして廃止となりました"></a><a id="1"></a>1. はじめに : Azure のクラシック VM は 2023 年 9 月 6 日を持ちまして廃止となりました</h3><p>Azure のクラシック VM は 2023 年 9 月 6 日を持ちまして廃止となりました。<br>そのためこれ以降サポートされる VM は ARM の Azure VM となります。<br>クラシック VM の ARM VM への移行詳細については以下の通りドキュメント等がございます。</p><p>・(参考 公開ドキュメント) 2023 年 9 月 6 日までに IaaS リソースを Azure Resource Manager に移行する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/classic-vm-deprecation">https://learn.microsoft.com/ja-jp/azure/virtual-machines/classic-vm-deprecation</a></p><p>・(参考 弊社ブログ) Classic VM から ARM への移行についての注意事項 (VM、ストレージ編) | Japan Azure IaaS Core Support Blog (jpaztech.github.io)<br>　<a href="https://jpaztech.github.io/blog/vm/migrate_classic_vm_and_storage/">https://jpaztech.github.io/blog/vm/migrate_classic_vm_and_storage/</a></p><p>・(参考 弊社ブログ) クラシック VM で使用していた VHD から ARM VM を作成する手順 | Japan Azure IaaS Core Support Blog (jpaztech.github.io)<br>　<a href="https://jpaztech.github.io/blog/vm/classic-vhd-to-arm-vm/">https://jpaztech.github.io/blog/vm/classic-vhd-to-arm-vm/</a></p><h3 id="2-バックアップしているクラシック-VM-を-ARM-VM-へ移行する際の注意点"><a href="#2-バックアップしているクラシック-VM-を-ARM-VM-へ移行する際の注意点" class="headerlink" title="2. バックアップしているクラシック VM を ARM VM へ移行する際の注意点"></a><a id="2"></a>2. バックアップしているクラシック VM を ARM VM へ移行する際の注意点</h3><h3 id="ポイント"><a href="#ポイント" class="headerlink" title="ポイント"></a>ポイント</h3><ul><li>ARM 移行作業を行う前に、一度「バックアップ データの保持」「バックアップの停止」を行ってください</li><li>ARM 移行後、再度「バックアップの有効化」を行ってください</li><li>クラシック VM にこれまで対応していたストレージとネットワークの情報も ARM へと移行ください</li></ul><p>下記ドキュメントの説明もご一読ください。</p><p>・クラシック VM をコンテナーにバックアップしてあります。 クラシック モードから Resource Manager モードに VM を移行して、Recovery Services コンテナーで保護することはできますか。<br>　<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/migration-classic-resource-manager-faq#------vm----------------------------------resource-manager------vm-------recovery-services--------------------">https://learn.microsoft.com/ja-jp/azure/virtual-machines/migration-classic-resource-manager-faq#------vm----------------------------------resource-manager------vm-------recovery-services--------------------</a></p><p>・クラシック VM とクラシック ストレージ アカウントが廃止されたら、クラシック VM のバックアップはどのように復元できますか?<br>　<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/migration-classic-resource-manager-faq#------vm---------------------------------vm----------------------">https://learn.microsoft.com/ja-jp/azure/virtual-machines/migration-classic-resource-manager-faq#------vm---------------------------------vm----------------------</a></p><h4 id="事例-Azure-VM-自体は-ARM-へ移行したが、VM-にアタッチされているディスクのストレージ-アカウントがクラシック-ストレージ-アカウントのままである"><a href="#事例-Azure-VM-自体は-ARM-へ移行したが、VM-にアタッチされているディスクのストレージ-アカウントがクラシック-ストレージ-アカウントのままである" class="headerlink" title="(事例) Azure VM 自体は ARM へ移行したが、VM にアタッチされているディスクのストレージ アカウントがクラシック ストレージ アカウントのままである"></a>(事例) Azure VM 自体は ARM へ移行したが、VM にアタッチされているディスクのストレージ アカウントがクラシック ストレージ アカウントのままである</h4><p>このような場合、Azure VM を再度「バックアップの有効化」しようとしても、失敗します。</p><p>(「バックアップの有効化」デプロイ エラー メッセージ例)<br>‘The resource write operation failed to complete successfully, because it reached terminal provisioning state ‘Failed’.’</p><p>Azure VM Backup では、クラシック デプロイ モデルのストレージ アカウントで構成された ARM Azure VM のバックアップをサポートしておりませんので、ストレージ アカウントを ARM へ移行ください。<br>・ストレージ アカウントの移行<br>　<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/migration-classic-resource-manager-overview#migration-of-storage-accounts">https://learn.microsoft.com/ja-jp/azure/virtual-machines/migration-classic-resource-manager-overview#migration-of-storage-accounts</a></p><p>バックアップしているクラシック VM を ARM VM へ移行する際の注意点について、ご案内は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;みなさんこんにちは、Azure Backup サポートです。&lt;br&gt;今回は、Azure VM Backup にて、もともとクラシック VM ( = Azure Service Manager (ASM) を介した IaaS 仮</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの料金の違い</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_billing/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_billing/</id>
    <published>2023-09-27T03:00:00.000Z</published>
    <updated>2023-10-30T10:53:16.247Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、Azure VM Backup において、<br>「Standard バックアップ ポリシー (標準ポリシー) 」でバックアップを取得した場合と<br>「Enhanced バックアップ ポリシー (拡張ポリシー) 」でバックアップを取得した場合の、それぞれの料金の違いについて説明します。<br>※　料金の違いは、現在公開ドキュメント上にも明記するよう、計画中です。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/8ccd86d4-3e8e-4f19-9155-27ae50c50b9a" alt="image"></p><p>(参考 関連ブログ記事)<br>・料金計算ツールを用いた Azure VM Backup の料金見積もりについて | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br>　<a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_calculator/">https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_calculator/</a></p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. はじめに : Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの機能の違いについて</a><br><a href="#2">2. Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの料金の違い</a><br><a href="#3">3. Enhanced バックアップ ポリシー利用時の料金算出方法</a></p><hr><h2 id="1-はじめに-Standard-バックアップ-ポリシーと-Enhanced-バックアップ-ポリシーの機能の違いについて"><a href="#1-はじめに-Standard-バックアップ-ポリシーと-Enhanced-バックアップ-ポリシーの機能の違いについて" class="headerlink" title="1. はじめに : Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの機能の違いについて"></a>1. はじめに : Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの機能の違いについて<a id="1"></a></h2><p>それぞれのバックアップ ポリシーで Azure VM Backup を取得する場合の、機能の違いは下記公開ドキュメントをご参照ください。<br>・拡張ポリシーを使用して Azure VM をバックアップする - Azure Backup | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal</a></p><h2 id="2-Standard-バックアップ-ポリシーと-Enhanced-バックアップ-ポリシーの料金の違い"><a href="#2-Standard-バックアップ-ポリシーと-Enhanced-バックアップ-ポリシーの料金の違い" class="headerlink" title="2. Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの料金の違い"></a>2. Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの料金の違い<a id="2"></a></h2><h3 id="Azure-VM-Backup-の料金"><a href="#Azure-VM-Backup-の料金" class="headerlink" title="Azure VM Backup の料金"></a>Azure VM Backup の料金</h3><p>Azure VM Backup を利用する場合、その料金を見積もる際には以下 3 点が課金項目となります。<br>(1) Azure 仮想マシンのインスタンスに対する課金<br>(2) Recovery Services コンテナーに保管されるバックアップ データに対する課金<br>(3) Azure VM Backup の機能で取得されるスナップショットに対する課金</p><p>(1) と (2) の課金は、「Standard バックアップ ポリシー」でバックアップ取得しても、「Enhanced バックアップ ポリシー」でバックアップ取得しても、どちらも同じ料金計算方式となります。</p><p>この 2 項目は、下記公開ドキュメント上で説明している「保護されたインスタンス サイズ (1) 」「バックアップ ストレージの課金 (2) 」箇所に相当します。</p><p>・バックアップのコスト<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-costs">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-costs</a><br>　“保護されたインスタンス サイズの計算は、”実際の” VM のサイズに基づきます。”<br>　“同様に、バックアップ ストレージの課金は、Azure Backup に格納されているデータ量 (各回復ポイントの実際のデータの合計) に基づきます。”</p><p>いっぽう (3) の課金は、「Standard バックアップ ポリシー」でバックアップ取得する場合と、「Enhanced バックアップ ポリシー」でバックアップ取得する場合とで、料金の加算方法が変わってきます。</p><h3 id="「Azure-VM-Backup-の機能で取得されるスナップショットに対する課金」の加算方法の違い"><a href="#「Azure-VM-Backup-の機能で取得されるスナップショットに対する課金」の加算方法の違い" class="headerlink" title="「Azure VM Backup の機能で取得されるスナップショットに対する課金」の加算方法の違い"></a>「Azure VM Backup の機能で取得されるスナップショットに対する課金」の加算方法の違い</h3><p>「Standard バックアップ ポリシー」では、最初に取得されるスナップショットに対して料金はかかりません。<br>「Enhanced バックアップ ポリシー」では、初回のスナップショット取得時点で、使用データ量分のスナップショットに対して料金が発生します。</p><p>また、1 GB あたりの課金額は以下の通りそれぞれ違いがあります。</p><p>標準ポリシー:  0.12 ドル/ 1 GB<br>拡張ポリシー:  0.05 ドル/ 1 GB</p><ul><li>リージョンにより料金が異なる場合がございます。(上記 および 以下の参考例は、USEast2 の価格となります。)</li></ul><p>下記の表は 100 GB の容量をもつ Azure 仮想マシンに対して、毎日 1 GB の増分が発生するケースにおいて、スナップショットを 4 日間保管した場合の比較表となります。<br>*表中の料金は月額を示しており、実際の料金は保存期間によって変動する場合があります。<br>(参考例)<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/c614385e-2489-40c9-9f2f-9a6a2e7c9b19" alt="image"></p><p>上記サンプルケースでは Enhanced バックアップ ポリシー 利用時の方が費用は高くなりますが、初回のバックアップデータ量が減った場合や、翌日以降の増分データ量が増加する場合は、Standard バックアップ ポリシー利用時の方が割高となるシナリオも考えられます。</p><p>「(3) Azure VM Backup の機能で取得されるスナップショットに対する課金」における<br>リージョン毎のスナップショット料金詳細は下記をご参照ください。</p><h4 id="Standard-バックアップ-ポリシー-スナップショットに対する料金"><a href="#Standard-バックアップ-ポリシー-スナップショットに対する料金" class="headerlink" title="Standard バックアップ ポリシー - スナップショットに対する料金"></a>Standard バックアップ ポリシー - スナップショットに対する料金</h4><p>下記リンクから、リージョン・通貨をご希望のものへと設定変更いただければ、スナップショットに対する料金を確認できます。<br>・Azure ページ BLOB Storage の価格 | Microsoft Azure<br>　<a href="https://azure.microsoft.com/ja-jp/pricing/details/storage/page-blobs/">https://azure.microsoft.com/ja-jp/pricing/details/storage/page-blobs/</a></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/727481b0-cbab-4f49-976a-2b8428d5f209" alt="image"></p><h4 id="Enhanced-バックアップ-ポリシー-スナップショットに対する料金"><a href="#Enhanced-バックアップ-ポリシー-スナップショットに対する料金" class="headerlink" title="Enhanced バックアップ ポリシー - スナップショットに対する料金"></a>Enhanced バックアップ ポリシー - スナップショットに対する料金</h4><p>下記リンクから、リージョン・通貨をご希望のものへと設定変更いただければ、スナップショットに対する料金を確認できます。<br>・料金 - Managed Disks | Microsoft Azure<br>　<a href="https://azure.microsoft.com/ja-jp/pricing/details/managed-disks/">https://azure.microsoft.com/ja-jp/pricing/details/managed-disks/</a></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/69d004e5-cef6-4930-a777-43a986c713ec" alt="image"></p><h2 id="3-Enhanced-バックアップ-ポリシー利用時の料金算出方法"><a href="#3-Enhanced-バックアップ-ポリシー利用時の料金算出方法" class="headerlink" title="3. Enhanced バックアップ ポリシー利用時の料金算出方法"></a>3. Enhanced バックアップ ポリシー利用時の料金算出方法<a id="3"></a></h2><p>現時点では、料金計算ツールは「Standard バックアップ ポリシー」利用時の料金計算見積もりとなっており<br>「Enhanced バックアップ ポリシー」利用時の料金計算ツールの用意がございません。</p><p>このため、「Enhanced バックアップ ポリシー」を利用して Azure VM Backup を取得する場合の料金見積もりは、下記のようにお見積りください。</p><p>(算出方法)<br>1 . 以下料金計算ツールにて、毎日 1 回バックアップをスケジュールする場合の金額を見積もる。(-&gt; これを A とします)<br>料金計算ツール<br><a href="https://azure.microsoft.com/ja-jp/pricing/calculator/">https://azure.microsoft.com/ja-jp/pricing/calculator/</a></p><p>2 . 初回バックアップ時の VM のインスタンスサイズに対し、スナップショット料金の加算分を計算する。<br>100 GB であれば 0.05($) を乗算し、5$ (-&gt; これを B とします) 。</p><p>3 . 日次の変更データ量に対するスナップショット料金の減額分を計算する。<br>「Standard バックアップ ポリシー」利用時の料金との差額は 1GB あたり 0.12 - 0.05 = 0.07 $ である為、日次で想定される変更データ量が 1GB の場合、毎日 0.07 $ x 1GB = 0.07$ の減額が発生する。<br>月間 31 日では、0.07 $ x 31 = 2.17 $ 発生。(-&gt; これを C とします)<br>※料金計算ツールの「平均日次データ チャーン」項目について、100 GB のインスタンスサイズに対し、1 GB の変更が生じる場合、一般的なチャーンレートとしては1% となる為、平均日次チャーンは “低” となります。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/1d5da2f1-93a6-4b35-9a9e-2d806c9c6450" alt="image"></p><p>4 . 料金計算ツールにて、A に、BならびにC を加え、概算費用を計算します。<br>・初月 A - C + B (「Azure VM Backup の機能で取得されるスナップショットに対する課金」部分が反映されることになります)<br>・2 か月目以降 A - C</p><p>本記事の内容は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、Azure VM Backup において、&lt;br&gt;「Standard バックアップ ポリシー (標準ポリシー) 」でバックアップを取得した場合と&lt;br&gt;「</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure Backup の障害調査に必要な情報</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigating/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigating/</id>
    <published>2023-09-27T03:00:00.000Z</published>
    <updated>2023-10-30T10:53:16.215Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートの山本です。<br>今回は Azure Backup のバックアップ失敗、リストア失敗の時の調査をするにあたり、提供いただきたい情報をお伝えいたします。<br>なお、 Azure Backup の障害調査にあたり NW 観点で取得いただきたいログに関しては下記をご覧ください<br>・Azure Backup の障害調査に必要な情報 (疎通確認)<br><a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/</a></p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Azure VM バックアップの障害調査に必要なログ</a><br>  <a href="#1-1">  1-1. Azure VM Backup の VSS 障害調査に追加で必要なログ</a><br><a href="#2">2.   Azure VM バックアップ の ファイルレベル リストア (ILRリストア) 失敗調査に必要なログ</a><br><a href="#3">3. Azure Backup for SAP HANA in Azure VM の障害調査に必要なログ</a><br><a href="#4">4. MARS Backup エージェントを利用したバックアップ の障害調査に必要なログ</a><br>  <a href="#4-1">4-1. Microsoft Azure Backup Agent のログ</a><br>  <a href="#4-2">4-2. システム情報</a><br>  <a href="#4-3">4-3. イベント ログ</a><br>  <a href="#4-4">4-4. 各種証明書の確認証跡およびインポート</a><br>   <a href="#4-4-1">4-4-1. 個人 ＞ 証明書</a><br>   <a href="#4-4-2">4-4-2. 信頼されたルート証明書 ＞ 証明書</a><br>   <a href="#4-4-3">4-4-3. 中間証明機関 ＞ 証明書</a><br>   <a href="#4-4-4">4-4-4. 証明書インポート手順</a></p><hr><h2 id="1-Azure-VM-バックアップの障害調査に必要なログ"><a href="#1-Azure-VM-バックアップの障害調査に必要なログ" class="headerlink" title="1. Azure VM バックアップの障害調査に必要なログ"></a>1. Azure VM バックアップの障害調査に必要なログ<a id="1"></a></h2><p>　*Azure VM Backup ではないですが  Azure Backup for SQL Server in Azure VM や Azure Backup for SAP HANA in Azure VM など Azure VM 上の DB のバックアップに関するものでも同様に必要です。<br>下記の <strong>環境情報</strong>と<strong>ログ情報</strong>の収集をお願いいたします。</p><p>*NVA などの場合、OS が対応していない可能性もございます。<br>(参考) 詳細は下記をご覧ください<br>・NVA のバックアップについて<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/NVA_backup/">https://jpabrs-scem.github.io/blog/AzureVMBackup/NVA_backup/</a></p><h3 id="環境情報"><a href="#環境情報" class="headerlink" title="環境情報"></a>環境情報</h3><p>・Subscription ID<br>・Recovery Services コンテナー名、およびそのリソースグループ名<br>・バックアップ対象 VM 名、およびそのリソースグループ名<br>・OS およびバージョン情報</p><h4 id="ログ情報"><a href="#ログ情報" class="headerlink" title="ログ情報"></a>ログ情報</h4><p>下記を参考に zip などにまとめてご提供いただけますと幸いです。</p><h4 id="・Windows-の場合"><a href="#・Windows-の場合" class="headerlink" title="・Windows の場合"></a>・Windows の場合</h4><blockquote><p>C:\Windows\System32\winevt\Logs<br>C:\WindowsAzure\</p></blockquote><h4 id="・Linuxの場合"><a href="#・Linuxの場合" class="headerlink" title="・Linuxの場合"></a>・Linuxの場合</h4><blockquote><p>/var/log/</p></blockquote><p>全量いただけることが望ましいですが、全量が困難な場合は下記をご提供ください。</p><blockquote><p>/var/log/azure/*<br>/var/log/syslog*<br>/var/log/waagent.*</p></blockquote><h3 id="1-1-Azure-VM-Backup-の-VSS-障害調査に追加で必要なログ"><a href="#1-1-Azure-VM-Backup-の-VSS-障害調査に追加で必要なログ" class="headerlink" title="1-1 . Azure VM Backup の VSS 障害調査に追加で必要なログ"></a>1-1 . Azure VM Backup の VSS 障害調査に追加で必要なログ<a id="1-1"></a></h3><p>Azure VM Backupの下記のようなエラーが出ることがございます。<br>その場合には VSS 観点での調査が必要であるため、そのため上記 <a href="#1">1. Azure VM バックアップの障害調査に必要なログ</a> に加えて下記のログの採取もお願いします。</p><blockquote><p>Error Code ：Snapshot operation failed due to VSS Writers in bad state.<br>Error Message ：ExtensionFailedVssWriterInBadState</p></blockquote><p>VSS 観点での調査のためには下記 URL 先のログの採取をお願いします。<br> <strong>可能な限り “[A]”が望ましいですが、”[B]” の方法で採取いただいても、ある程度は調査が可能な場合がございます。</strong><br>・VSS エラーが発生している事象の調査<br><a href="https://jpwinsup.github.io/mslog/storage/vss/vss-error.html">https://jpwinsup.github.io/mslog/storage/vss/vss-error.html</a></p><p>また合わせて下記も関連するブログでございます。<br>・Azure VM Backupにおける整合性について<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#1-1-VSS-%E8%A6%B3%E7%82%B9%E3%81%A7%E3%81%AE%E8%AA%BF%E6%9F%BB%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#1-1-VSS-%E8%A6%B3%E7%82%B9%E3%81%A7%E3%81%AE%E8%AA%BF%E6%9F%BB%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6</a></p><h2 id="2-Azure-VM-バックアップ-の-ファイルレベル-リストア-ILRリストア-失敗調査に必要なログ"><a href="#2-Azure-VM-バックアップ-の-ファイルレベル-リストア-ILRリストア-失敗調査に必要なログ" class="headerlink" title="2.   Azure VM バックアップ の ファイルレベル リストア (ILRリストア) 失敗調査に必要なログ"></a>2.   Azure VM バックアップ の ファイルレベル リストア (ILRリストア) 失敗調査に必要なログ<a id="2"></a></h2><p>下記の <strong>環境情報</strong>と<strong>ログ情報</strong>の収集をお願いいたします。</p><h3 id="環境情報-1"><a href="#環境情報-1" class="headerlink" title="環境情報"></a>環境情報</h3><p>・Subscription ID<br>・Recovery Services コンテナー名、およびそのリソースグループ名<br>・バックアップ対象 VM 名、およびそのリソースグループ名、OS 名<br>・リストア先の VM 名、およびそのリソースグループ名、OS 名</p><h3 id="ログ情報-1"><a href="#ログ情報-1" class="headerlink" title="ログ情報"></a>ログ情報</h3><p>zip などにまとめてご提供いただけますと幸いです。</p><h4 id="・-Windows-の場合-“ディスクの管理”-の画面の画面ショット"><a href="#・-Windows-の場合-“ディスクの管理”-の画面の画面ショット" class="headerlink" title="・(Windows の場合) “ディスクの管理” の画面の画面ショット"></a>・(Windows の場合) “ディスクの管理” の画面の画面ショット</h4><p><img src="https://user-images.githubusercontent.com/71251920/153464381-6ba8f9bf-56fd-48fd-9784-b819d8a4f79c.png" alt="参考画像"></p><h4 id="・実行したスクリプト、および実行後に作成されたフォルダ一式"><a href="#・実行したスクリプト、および実行後に作成されたフォルダ一式" class="headerlink" title="・実行したスクリプト、および実行後に作成されたフォルダ一式"></a>・実行したスクリプト、および実行後に作成されたフォルダ一式</h4><ul><li><strong>Windowsの場合</strong><br>・スクリプトファイル：IaaSVMILRExeForWindows.exe<br>・スクリプト実行後に作成されるフォルダー：”仮想マシン名(小文字)”+”スクリプトファイル実行日時”</li></ul><p>　下記例では “okt-temp-win-20220212145642” が作成されています。<br><img src="https://user-images.githubusercontent.com/71251920/153714819-e9f24f63-75f0-4268-b0fc-ac6e43155cc1.png"></p><p>“okt-temp-win-20220212145642”の中身<br><img src="https://user-images.githubusercontent.com/71251920/153714818-906282be-7acc-4e9f-9d4e-62d5b2b369a0.png" alt="&quot;okt-temp-win-20220212145642&quot;の中身"></p><ul><li><strong>Linux の場合</strong><br>・ILRのスクリプトファイル：例)　<strong>vm02kensho(小文字VM名)_1_jpe_6591639015130036692_802427195716_899298aac7c04bf094ad68bfc5b9584ed206b94b62d965.py</strong><br>・作成されたディレクトリの <strong>Scripts ディレクトリ一式</strong>：例） <strong>vm02kensho-20220212151619/Script</strong><br>スクリプトを実行後、「<strong>vm02kensho-20220212151619</strong>」ディレクトリが自動生成されていることがわかる。<br><img src="https://user-images.githubusercontent.com/71251920/153714817-892202e9-3df5-4377-9276-42b16eb82fd4.png"></li></ul><blockquote><p>ls -all</p></blockquote><p><img src="https://user-images.githubusercontent.com/71251920/153714816-49b0446b-8728-498e-b51f-bff02f37f0a5.png" alt="「vm02kensho-20220212151619」ディレクトリが自動生成されている"></p><p>「vm02kensho-20220212151619」ディレクトリの中身、および作成されたディレクトリの <strong>Scripts ディレクトリ</strong>の中身は下記の通り</p><blockquote><p>ls -allR</p></blockquote><p><img src="https://user-images.githubusercontent.com/71251920/153714814-a652e630-b1c8-4e43-a96f-4d974c9d7cf4.png" alt="「vm02kensho-20220212151619」ディレクトリの中身,および作成されたディレクトリの Scripts ディレクトリの中身"></p><h2 id="3-Azure-Backup-for-SAP-HANA-in-Azure-VM-の障害調査に必要なログ"><a href="#3-Azure-Backup-for-SAP-HANA-in-Azure-VM-の障害調査に必要なログ" class="headerlink" title="3. Azure Backup for SAP HANA in Azure VM の障害調査に必要なログ"></a>3. Azure Backup for SAP HANA in Azure VM の障害調査に必要なログ<a id="3"></a></h2><p><span style="color: red; "> <a href="#1">1. Azure VM バックアップの障害調査に必要なログ</a> の <strong>環境情報</strong> ならびに <strong>ログ情報 - Linuxの場合</strong> に加えて</span>下記もご対応お願いします。</p><p>*お手数ですが、全ての DB の backup.log 及び backint.log の採取をお願いします。</p><h3 id="SAP-HANAのbackup-log-及び-backint-log"><a href="#SAP-HANAのbackup-log-及び-backint-log" class="headerlink" title="SAP HANAのbackup.log 及び backint.log"></a>SAP HANAのbackup.log 及び backint.log</h3><blockquote><ul><li>xxにはインスタンスナンバーが入ります。<br>  ・/hana/shared/HXE/HDBxx/(hostname)/trace/backup.log<br>  ・/hana/shared/HXE/HDBxx/(hostname)/trace/DB_&lt;DB名&gt;/backup.log<br>  ・/hana/shared/HXE/HDBxx/(hostname)/trace/backint.log<br>  ・/hana/shared/HXE/HDBxx/(hostname)/trace/DB_&lt;DB名&gt;/backint.log</li></ul></blockquote><p>*上記パスに該当のログが無い場合は以下を試し、コマンド実行結果に表示されるディレクトリの場所の log をアップロードしてください。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo -i (rootユーザーに切り替えます)</span><br><span class="line">cd / (ディレクトリの最上層に移動します)</span><br><span class="line">find ./ -name &quot;backup.log&quot; (findコマンドにより該当のログの場所を特定します)</span><br><span class="line">find ./ -name &quot;backint.log&quot; (findコマンドにより該当のログの場所を特定します)</span><br></pre></td></tr></table></figure><h3 id="opt-配下の-log"><a href="#opt-配下の-log" class="headerlink" title="opt 配下の log"></a>opt 配下の log</h3><p>・/opt/msawb/var/log ディレクトリ配下のファイルを zip 等におまとめのうえで、アップロードしてください。</p><h2 id="4-MARS-Backup-エージェントを利用したバックアップ-の障害調査に必要なログ"><a href="#4-MARS-Backup-エージェントを利用したバックアップ-の障害調査に必要なログ" class="headerlink" title="4. MARS Backup エージェントを利用したバックアップ の障害調査に必要なログ"></a>4. MARS Backup エージェントを利用したバックアップ の障害調査に必要なログ<a id="4"></a></h2><h2 id="4-0-環境情報とWindowsログ"><a href="#4-0-環境情報とWindowsログ" class="headerlink" title="4.0 環境情報とWindowsログ"></a>4.0 環境情報とWindowsログ</h2><p><a href="#1">1. Azure VM バックアップの障害調査に必要なログ</a> の <strong>環境情報</strong> ならびに <strong>ログ情報 - Windows の場合</strong> の取得をお願いします。<br>*MARS バックアップ のバックアップ対象の環境が Azure VM でない場合は Azure VM 名 / VM リソース グループ名は不要です。</p><p>上記に加えて下記もご対応お願いします。</p><h3 id="4-1-Microsoft-Azure-Backup-Agent-のログ"><a href="#4-1-Microsoft-Azure-Backup-Agent-のログ" class="headerlink" title="4.1 Microsoft Azure Backup Agent のログ　"></a>4.1 Microsoft Azure Backup Agent のログ　<a id="4-1"></a></h3><p> まず、下記 リンク先から調査用スクリプトのダウンロードをお願いします。<br><a href="https://github.com/jpabrs-scem/blog/files/10148102/WABDiag.zip">WABDiag.zip</a></p><p>ダウンロードいただきました WABDiag.tx を .ps1 に変更して使用し、問題が発生しているマシンより Azure Backup ログの収集をお願いいたします。<br>※ ファイルの解凍パスワードは “AzureBackup” となります。</p><ol><li>WABDiag.ps1 を管理者権限の PowerShell で実行します。</li></ol><blockquote><p>実行コマンド: &lt;スクリプトのパス&gt;\WABDiag.ps1 &lt;パス\保存するフォルダ名&gt;<br>   実行例: C:\WABDiag\WABDiag.ps1 C:\Logs</p></blockquote><p>   実行結果にファイル パスが無い旨のメッセージが表示される可能性がございますが、対象のファイル自体が無い事を示すメッセージとなりますので、無視していただいて問題ございません。</p><p><img src="https://user-images.githubusercontent.com/96324317/198866368-03062da1-142c-47a6-8d36-aed1a2027d4a.png" alt="WABDiag.ps1出力ファイル"></p><h4 id="PowerShell-の実行ポリシーの制限によりスクリプトが実行できない場合"><a href="#PowerShell-の実行ポリシーの制限によりスクリプトが実行できない場合" class="headerlink" title="PowerShell の実行ポリシーの制限によりスクリプトが実行できない場合"></a>PowerShell の実行ポリシーの制限によりスクリプトが実行できない場合</h4><p>PowerShellを管理者権限で起動し、下記コマンドを実行し実行ポリシーを変更後、再度実行していただけますでしょうか。</p><blockquote><p>コマンド：Set-ExecutionPolicy Unrestricted</p></blockquote><p>また現在の実行ポリシーを後ほど元に戻す場合は、変更前に下記コマンドを実行し、設定されているポリシーを確認、メモし、スクリプト実行後に同様の手順で変更していただきますようお願いいたします。</p><blockquote><p>コマンド：Get-ExecutionPolicy </p></blockquote><ul><li>参考<br>・実行ポリシーについて - PowerShell<br><a href="https://docs.microsoft.com/ja-jp/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.2">https://docs.microsoft.com/ja-jp/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.2</a></li></ul><h3 id="4-2-システム情報"><a href="#4-2-システム情報" class="headerlink" title="4.2 システム情報 "></a>4.2 システム情報 <a id="4-2"></a></h3><ol><li>対象のマシンに管理者権限を保持するユーザーでログオンします。</li><li>管理者権限でコマンド プロンプトを起動し、以下のコマンドで取得します。<blockquote><p>msinfo32 /nfo &lt;出力ファイル名&gt;<br>実行例)  &gt; msinfo32 /nfo SVR_msinfo32.nfo</p></blockquote></li><li>生成されたファイルをご提供ください。<br><img src="https://user-images.githubusercontent.com/96324317/198866419-6188fb3e-d260-44b5-87b9-18a0ec2ac927.png" alt="システム情報"></li></ol><h3 id="4-3-イベント-ログ"><a href="#4-3-イベント-ログ" class="headerlink" title="4.3 イベント ログ"></a>4.3 イベント ログ<a id="4-3"></a></h3><ol><li>対象のマシンに管理者権限を保持するユーザーでログオンします。</li><li>[スタート] - [管理ツール] - [イベント ビューアー] を開きます。</li><li>左側ペインの以下のイベントに対して、右クリックをし、[すべてのイベントを名前をつけて保存] を選択し、ファイルの種類が “イベント ファイル (<em>.evtx)” であることを確認し、任意の名前を付けて、[保存] をクリックします。<br>(ファイルの種類が “イベント ファイル (</em>.csv)” も併せて取得をお願いいたします)<br>a) [イベント ビューアー (ローカル)] - [Windows ログ] - [システム]<br>b) [イベント ビューアー (ローカル)] - [Windows ログ] - [Application]</li><li>保存したイベント ログ ファイルをご提供ください。</li></ol><h3 id="4-4-各種証明書の確認証跡およびインポート"><a href="#4-4-各種証明書の確認証跡およびインポート" class="headerlink" title="4.4 各種証明書の確認証跡およびインポート"></a>4.4 各種証明書の確認証跡およびインポート<a id="4-4"></a></h3><p>下記詳細手順のもと、証明書 および 権限の確認を確認のうえ、画面ショットを zip などにおまとめの上ご提供お願いいたします。</p><p>*該当の証明書がない場合は下記 URL よりダウンロードしインポートをお願いします。<br>これによりMARS エージェントが立ち上がらないなどの場合の場合改善することがございます。</p><p>対象マシン上の「スタート」ボタンを右クリック＞「ファイル名を指定して実行」＞「certlm.msc」と入力して「OK」し、以下すべての証明書が存在するかご確認ください。<br><strong>（※ Windows Server 2012 以前の OS の場合は、MMC スナップインより証明書スナップインを起動してください）</strong></p><p><img src="https://user-images.githubusercontent.com/71251920/182520764-1ed4e4ab-c925-4a87-b905-1414bab17e47.png"></p><p><img src="https://user-images.githubusercontent.com/71251920/182520768-feacd580-7217-4148-af08-27cab663d93f.png"></p><h3 id="4-4-1-個人-＞-証明書"><a href="#4-4-1-個人-＞-証明書" class="headerlink" title="4.4.1 個人 ＞ 証明書"></a>4.4.1 個人 ＞ 証明書<a id="4-4-1"></a></h3><blockquote><p>・CB_&lt;MARSのバックアップを実施する予定のRecovery Services コンテナー名 → -x-x-xxxx-vaultcredentials<br>・CB_&lt;ホスト名&gt;._xxxxxxxxxxxxxxxxxx<br>※　上記 2 が存在していることを確認の上、その画面スクリーンショットをご提供ください<br>（存在していない場合もございますので、その場合は、その点ご返信いただけますと幸いです。）<br><img src="https://user-images.githubusercontent.com/71251920/182520770-6e2bac01-d72e-4a3a-b358-56f853538f5a.png"></p></blockquote><p>“<strong>・CB_&lt;ホスト名&gt;._xxxxxxxxxxxxxxxxxx</strong> の期限がきれている場合は正常に MARS エージェントが正常に起動しないことがあります。<br>下記を参考に再インストール をご実施ください。それにより証明書がインストールされます。<br>・MARS エージェントの再インストール手順<br><a href="https://jpabrs-scem.github.io/blog/MARSBackup/How_to_re-install/">https://jpabrs-scem.github.io/blog/MARSBackup/How_to_re-install/</a></p><h3 id="4-4-2-信頼されたルート証明書-＞-証明書"><a href="#4-4-2-信頼されたルート証明書-＞-証明書" class="headerlink" title="4.4.2 信頼されたルート証明書 ＞ 証明書 "></a>4.4.2 信頼されたルート証明書 ＞ 証明書 <a id="4-4-2"></a></h3><p>[参考]<br>・Azure TLS 証明書の変更<br><a href="https://learn.microsoft.com/ja-jp/azure/security/fundamentals/tls-certificate-changes#what-changed">https://learn.microsoft.com/ja-jp/azure/security/fundamentals/tls-certificate-changes#what-changed</a></p><p>[証明書zipダウンロード先]<br><a href="https://github.com/jpabrs-scem/blog/files/9615338/root.certificate.zip">root certificate.zip</a></p><blockquote><p>ルート証明書名    証明書の拇印<br><a href="https://cacerts.digicert.com/DigiCertGlobalRootG2.crt">DigiCert Global Root G2    : df3c24f9bfd666761b268073fe06d1cc8d4f82a4</a><br><a href="https://cacerts.digicert.com/DigiCertGlobalRootCA.crt">DigiCert Global Root CA    : a8985d3a65e5e5c4b2d7d66d40c6dd2fb19c5436</a><br><a href="https://cacerts.digicert.com/BaltimoreCyberTrustRoot.crt">Baltimore CyberTrust Root    : d4de20d05e66fc53fe1a50882c78db2852cae474</a><br><a href="https://www.d-trust.net/cgi-bin/D-TRUST_Root_Class_3_CA_2_2009.crt">D-TRUST Root Class 3 CA 2 2009    : 58e8abb0361533fb80f79b1b6d29d3ff8d5f00f0</a><br><a href="https://www.microsoft.com/pkiops/certs/Microsoft%20RSA%20Root%20Certificate%20Authority%202017.crt">Microsoft RSA Root Certificate Authority2017    : 73a5e64a3bff8316ff0edccc618a906e4eae4d74</a><br><a href="https://www.microsoft.com/pkiops/certs/Microsoft%20ECC%20Root%20Certificate%20Authority%202017.crt">Microsoft ECC Root Certificate Authority 2017    : 999a64c37ff47d9fab95f14769891460eec4c3c5</a></p></blockquote><p><img src="https://user-images.githubusercontent.com/71251920/182520772-59ba76df-31cf-488d-bfec-066830b44698.png"></p><p>※　上記 6 つすべての証明書が存在していること (存在していない場合もございます)<br>・証明書をダブルクリックし、「詳細」タブ ＞ スクロールして下の方に「拇印」がありますので、値が上記と同一であることが確認し、その画面ショットをご提供ください。<br>（存在していない場合もございますので、その場合は、その点ご返信いただけますと幸いです。）</p><p><img src="https://user-images.githubusercontent.com/71251920/182520776-8f30a8f5-67d5-4bfd-a264-590ca251689d.png"></p><h3 id="4-4-3-中間証明機関-＞-証明書"><a href="#4-4-3-中間証明機関-＞-証明書" class="headerlink" title="4.4.3 中間証明機関 ＞ 証明書 "></a>4.4.3 中間証明機関 ＞ 証明書 <a id="4-4-3"></a></h3><p>[参考]<br>・Azure Storage TLS: Changes are coming! (…and why you care)<br><a href="https://techcommunity.microsoft.com/t5/azure-storage-blog/azure-storage-tls-changes-are-coming-and-why-you-care/ba-p/1705518">https://techcommunity.microsoft.com/t5/azure-storage-blog/azure-storage-tls-changes-are-coming-and-why-you-care/ba-p/1705518</a></p><p>[証明書zipダウンロード先]<br><a href="https://github.com/jpabrs-scem/blog/files/9615291/intermediate.certificate.zip">intermediate certificate.zip</a></p><blockquote><p>中間証明書名    証明書の拇印<br><a href="http://www.microsoft.com/pki/mscorp/Microsoft%20RSA%20TLS%20CA%2001.crt">Microsoft RSA TLS CA 01    : 703d7a8f0ebf55aaa59f98eaf4a206004eb2516a</a><br><a href="http://www.microsoft.com/pki/mscorp/Microsoft%20RSA%20TLS%20CA%2002.crt">Microsoft RSA TLS CA 02    : b0c2d2d13cdd56cdaa6ab6e2c04440be4a429c75</a></p></blockquote><p>※　上記 2 つすべての証明書が存在していること<br>・証明書をダブルクリックし、「詳細」タブ ＞ スクロールして下の方に「拇印」がありますので、値が上記と同一であることが確認できる画面スクリーンショットをご提供ください。</p><p><img src="https://user-images.githubusercontent.com/71251920/182520778-a9e6e160-5830-4cf5-a6c3-00acf7ce0941.png"></p><h3 id="4-4-4-証明書インポート手順"><a href="#4-4-4-証明書インポート手順" class="headerlink" title="4.4.4 証明書インポート手順 "></a>4.4.4 証明書インポート手順 <a id="4-4-4"></a></h3><ol><li>証明書をエクスポートしたいマシンに、管理者権限でログインします。</li><li>[スタート] - [ファイル名を指定して実行] から、certlm.msc と入力して、[Enter]キーを押します。<strong>（※ Windows Server 2012 以前の OS の場合は、MMC スナップインより証明書スナップインを起動してください）</strong></li><li>ユーザーアカウント制御 が起動する場合は管理者権限での実行を許可します。</li><li>左側の [証明書 (ローカル コンピューター)]を展開して、 [信頼されたルート証明機関] - [証明書] を開きます。</li><li>[証明書] を右クリックし [すべてのタスク] – [インポート] と選択します。</li><li>証明書のインポートウィザードが起動しますので以下の様に進めます。<br>・ 「証明書のインポート ウィザードの開始」画面で [次へ] をクリック。<br>・ インポートする証明書のファイル  -&gt;  (上記公開情報よりダウンロードした各証明書を保存したパス)<br>・ 証明書ストア -&gt; (“信頼されたルート証明機関” となっていることを確認)</li><li>「信頼されたルート証明機関」証明書ストアに証明書がインポートされた事を確認します。</li></ol><ul><li>中間証明書のインポート手順は、上記の「信頼されたルート証明機関」の箇所を「中間証明機関」にお読み替えいただけますようお願いいたします。</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートの山本です。&lt;br&gt;今回は Azure Backup のバックアップ失敗、リストア失敗の時の調査をするにあたり、提供いただきたい情報をお伝えいたします。&lt;br&gt;なお、 Azur</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="情報採取" scheme="https://jpabrs-scem.github.io/blog/tags/%E6%83%85%E5%A0%B1%E6%8E%A1%E5%8F%96/"/>
    
  </entry>
  
  <entry>
    <title>HSR に対する Azure Workload Backup</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureSAPBackup/How_to_HSR_workload_backup/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureSAPBackup/How_to_HSR_workload_backup/</id>
    <published>2023-09-13T03:00:00.000Z</published>
    <updated>2023-10-30T10:53:16.243Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、HSR に対する Azure Workload Backup を構成するにあたって、実際のバックアップ構成手順を作業例交えてお伝えします。</p><h4 id="ポイント"><a href="#ポイント" class="headerlink" title="ポイント"></a>ポイント</h4><ul><li>HANA システム レプリケーション (HSR) データベースの仕様上、HANA DB のユーザー名とパスワードは、Primary → Secondary へレプリケートされますが、hdbuserstore の情報（＝つまり、作成したキー情報）はレプリケートされません。</li><li>Azure Backup では、Primary/Seconday すべての ノード 上に対してバックアップ操作をさせるために、ユーザー名/パスワード 入力での操作ではなく、hdbuserstore キーの入力での操作を行う仕組みになっています。<br>このため、Azure Backup の事前登録スクリプト (msawb-plugin-config-com-sap-hana.sh) を実行する前に、2 種類のキーを Azure Backup 対象となる<font color="DeepPink">全ての</font> Azure 仮想マシン上 (ノード上) でも作成する必要があります。</li><li>下記の公開ドキュメントは必ずご一読の上で、作業ください。<br>・Azure VM 上の SAP HANA システム レプリケーション データベースをバックアップする<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup</a></li></ul><h4 id="環境構成"><a href="#環境構成" class="headerlink" title="環境構成"></a>環境構成</h4><p>今回は、同一 リージョン・サブスクリプション・VNET 上に 2 つの Azure 仮想マシンを作成し、それぞれ Primary ノード・Secondary ノードとします。</p><table><thead><tr><th>Azure 仮想マシン名</th><th>役割</th></tr></thead><tbody><tr><td>SAPHANA23</td><td>HSR Primary</td></tr><tr><td>SAPHANA24</td><td>HSR Secondary</td></tr></tbody></table><p>SAP HANA SID： hxe<br>SAP HANA インスタンス番号： 90<br>マルチデータベースコンテナー (MDC)</p><table><thead><tr><th>ユーザー</th><th>概要</th><th>作成するキー名</th></tr></thead><tbody><tr><td>SYSTEM</td><td>システムユーザー</td><td>SYSTEM</td></tr><tr><td>OKTBK</td><td>カスタム バックアップ ユーザー<br>新規で手動作成が必要<br>任意のユーザーを指定可能</td><td>OKTBKKEY</td></tr></tbody></table><h2 id="目次-手順概略"><a href="#目次-手順概略" class="headerlink" title="目次 - 手順概略"></a>目次 - 手順概略</h2><hr><p><a href="#1">1. (Primary マシン上) SYSTEM ユーザーに対してキーを設定する</a><br><a href="#2">2. (Primary マシン上) カスタム バックアップ ユーザーを作成・パスワード管理・ロールなどの設定を行う</a><br><a href="#3">3. (Primary マシン上) カスタム バックアップ ユーザーに対してキーを設定する</a><br><a href="#4">4. (Secondary マシン上) SYSTEM ユーザーに対してキーを設定する</a><br><a href="#5">5. (Secondary マシン上) カスタム バックアップ ユーザーに対してキーを設定する</a><br><a href="#6">6. (これまで Azure Backup 構成していた場合)「バックアップの停止」を行う</a><br><a href="#7">7. (Primary マシン上) 事前登録スクリプトをダウンロード・実行する</a><br><a href="#8">8. (Secondary マシン上) 事前登録スクリプトをダウンロード・実行する</a><br><a href="#9">9. Recovery Services コンテナー上で「データベースを検出」「バックアップの有効化」「今すぐバックアップ」を行う</a><br><a href="#10">10. FAQ</a></p><hr><p>※　SAP HANA 自体の環境構築・HSR の設定は、Azure Backup とは関りが無いため、すでに HSR 設定が完了している前提で本記事では説明を開始します。<br>　　記事内の<font color="Red">赤文字</font>・<font color="MediumBlue">青文字</font>などは、ユーザーの環境に依って異なります。</p><h2 id="1-Primary-マシン上-SYSTEM-ユーザーに対してキーを設定する"><a href="#1-Primary-マシン上-SYSTEM-ユーザーに対してキーを設定する" class="headerlink" title=" 1. (Primary マシン上) SYSTEM ユーザーに対してキーを設定する"></a><a id="1"></a> 1. (Primary マシン上) SYSTEM ユーザーに対してキーを設定する</h2><p>(参考) 公開ドキュメント - 事前登録スクリプトで実行される処理<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/tutorial-backup-sap-hana-db#what-the-pre-registration-script-does">https://learn.microsoft.com/ja-jp/azure/backup/tutorial-backup-sap-hana-db#what-the-pre-registration-script-does</a><br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/45d9f60f-7f1d-4b16-83a2-dd234aed1a45" alt="image"></p><p>※ 仮想 IP を使用して クラスタ構成・HSR 構成を行っている場合、公開ドキュメントのとおりローカル ホストではなくロード バランサーのホスト/IP を使用してキーを作成してください。<br>　　今回は、仮想 IP は使用していない前提のコマンド例を記載しています。</p><p>HANA DB を立ち上げ、設定します。<br>(Primary マシン上で実行するコマンド 例)<br>su <font color="Red">hxe</font>adm -<br>HDB start<br>hdbuserstore list<br>この時点では何もキーはありません。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/29659ca7-f81f-405e-8814-f116bbf83e81" alt="image"></p><p>(Primary マシン上で実行するコマンド 例)<br>hdbuserstore Set <font color="Red">SYSTEM</font> <font color="MediumBlue">saphana23</font>:3<font color="Red">90</font>13 <font color="MediumBlue">&lt;キー名&gt;</font> <font color="Red">&lt;パスワード&gt;</font><br>hdbuserstore list</p><p>今回は、SYSTEM ユーザーに対して設定するキーの名前も「SYSTEM」としています。<br>下図の通り、「SYSTEM」という名前のキーが作成されていることを確認します。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/ee9d49f2-9d62-4bb3-9078-be1a472c4d4c" alt="image"></p><h2 id="2-Primary-マシン上-カスタム-バックアップ-ユーザーを作成・パスワード管理・ロールなどの設定を行う"><a href="#2-Primary-マシン上-カスタム-バックアップ-ユーザーを作成・パスワード管理・ロールなどの設定を行う" class="headerlink" title=" 2. (Primary マシン上) カスタム バックアップ ユーザーを作成・パスワード管理・ロールなどの設定を行う"></a><a id="2"></a> 2. (Primary マシン上) カスタム バックアップ ユーザーを作成・パスワード管理・ロールなどの設定を行う</h2><p>・(参考) 事前登録スクリプトを実行する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script</a><br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/974231ad-cf09-45e5-8e37-ef96d3cb017d" alt="image"></p><p>カスタム バックアップ ユーザー名は、特に名前の制約はありません。<br>今回は例として「OKTBK」という名前のカスタム バックアップ ユーザーを作成します。</p><p>(Primary マシン上で実行するコマンド 例)<br>hdbsql -t -U <font color="Red">SYSTEM</font> CREATE USER <font color="MediumBlue">OKTBK</font> PASSWORD <font color="Red">&lt;パスワード&gt;</font> NO FORCE_FIRST_PASSWORD_CHANGE</p><p>「-U」の引数として、前段で作成済のキー「SYSTEM」を渡すことで、新しいユーザーをキーを使って作成することができます。<br>「NO FORCE_FIRST_PASSWORD_CHANGE」句は必須ではありませんが、設定することで、ユーザー「OKTBK」が初めてログインした際に、パスワード変更を求められることが無くなります。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/7bd38d80-df7a-403a-bb9f-7cc65d684231" alt="image"></p><p>下図は念のため、「USERS」テーブル上にカスタム バックアップ ユーザー「OKTBK」が作成されたことを確認しています。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/ef87b2da-d2b9-4c26-bc62-f445e3cdcbb6" alt="image"></p><p>付与すべきロールは公開ドキュメントに記載があるので、今回は SQL を使用してロールを付与していきます。</p><p>〇　カスタム バックアップ ユーザー「OKTBK」のパスワードの期限を無効化する<br>hdbsql -t -U <font color="Red">SYSTEM</font> “ALTER USER <font color="Red">OKTBK</font> DISABLE PASSWORD LIFETIME”</p><p>・(参考) 事前登録スクリプトを実行する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script</a><br>　“このカスタム バックアップ キーのパスワード有効期限が切れると、バックアップと復元操作は失敗します。”</p><p>〇　カスタム バックアップ ユーザー「OKTBK」を Activate する<br>hdbsql -t -U <font color="Red">SYSTEM</font> “ALTER USER <font color="Red">OKTBK</font> ACTIVATE USER NOW”</p><p>〇　カスタム バックアップ ユーザー「OKTBK」に対して「データベース管理者」ロールを付与する<br>hdbsql -t -U <font color="Red">SYSTEM</font> “GRANT <font color="Green">DATABASE ADMIN</font> TO <font color="Red">OKTBK</font>“</p><p>〇　カスタム バックアップ ユーザー「OKTBK」に対して「CATALOG READ（＝バックアップ カタログを読み取れる）」ロールを付与する<br>hdbsql -t -U <font color="Red">SYSTEM</font> “GRANT <font color="Green">CATALOG READ</font> TO <font color="Red">OKTBK</font>“<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/b52f7628-7558-4d72-a09c-64db67794836" alt="image"></p><p>〇　カスタム バックアップ ユーザー「OKTBK」に対して「バックアップ管理者」ロールを付与する<br>HANA の SPS バージョンが「05」以上であれば「バックアップ管理者」ロールの付与も必要です。<br>今回の環境だと「SPS ：06」のため、「バックアップ管理者」ロールの付与も必要です。</p><p>HDB version<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/14efaed5-afbf-4c04-acef-ad85e7eed4e3" alt="image"></p><p>・(外部サイト 参考) GRANT Statement (Access Control) | SAP Help Portal<br>　<a href="https://help.sap.com/docs/SAP_HANA_PLATFORM/4fe29514fd584807ac9f2a04f6754767/20f674e1751910148a8b990d33efbdc5.html">https://help.sap.com/docs/SAP_HANA_PLATFORM/4fe29514fd584807ac9f2a04f6754767/20f674e1751910148a8b990d33efbdc5.html</a> </p><p>hdbsql -t -U <font color="Red">SYSTEM</font> “GRANT <font color="Green">BACKUP ADMIN</font> TO <font color="Red">OKTBK</font>“<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/65fe75f1-d9f8-4ae5-b26c-117603f154e2" alt="image"></p><p>念のためカスタム バックアップ ユーザー「OKTBK」に、現時点で付与されているロールを「GRANTED_PRIVILEGES」テーブルから確認してみます。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/bd59f7c4-e1d3-4c2d-aa30-97da40675eff" alt="image"></p><h2 id="3-Primary-マシン上-カスタム-バックアップ-ユーザーに対してキーを設定する"><a href="#3-Primary-マシン上-カスタム-バックアップ-ユーザーに対してキーを設定する" class="headerlink" title=" 3. (Primary マシン上) カスタム バックアップ ユーザーに対してキーを設定する"></a><a id="3"></a> 3. (Primary マシン上) カスタム バックアップ ユーザーに対してキーを設定する</h2><p>・(参考) 事前登録スクリプトを実行する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script</a><br>　“カスタム バックアップ ユーザーの hdbuserstore にキーを追加します。これにより、HANA バックアップ プラグインですべての操作 (データベース クエリ、復元操作、構成、バックアップの実行) を管理できるようになります。”</p><p>(実行するコマンド)<br>hdbuserstore Set &lt;作成するキー名&gt; &lt;作成先HANA DB のホスト名&gt;:3&lt;インスタンス番号&gt;13 &lt;カスタム バックアップ ユーザー名&gt; &lt;カスタム バックアップ ユーザーのパスワード&gt;</p><p>※ 仮想 IP を使用して クラスタ構成・HSR 構成を行っている場合、公開ドキュメントのとおりローカル ホストではなくロード バランサーのホスト/IP を使用してカスタム バックアップ キーを作成してください。<br>　　今回は、仮想 IP は使用していない前提のコマンド例を記載しています。</p><p>(Primary マシン上で実行するコマンド 例)<br>hdbuserstore Set <font color="Red">OKTBKKEY</font> <font color="MediumBlue">saphana23</font>:3<font color="Red">90</font>13 <font color="MediumBlue">OKTBK</font> <font color="Red">&lt;パスワード&gt;</font></p><p>キーが作成されているかどうかを確認します。<br>hdbuserstore list<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/5d2bd215-f82a-4d53-b6b3-78f31d202a9c" alt="image"></p><h2 id="4-Secondary-マシン上-SYSTEM-ユーザーに対してキーを設定する"><a href="#4-Secondary-マシン上-SYSTEM-ユーザーに対してキーを設定する" class="headerlink" title=" 4. (Secondary マシン上) SYSTEM ユーザーに対してキーを設定する"></a><a id="4"></a> 4. (Secondary マシン上) SYSTEM ユーザーに対してキーを設定する</h2><p>Primary マシン上で、SYSTEM ユーザーに対して設定したものと同じキー名のキーを作成・設定します。</p><p>※ 仮想 IP を使用して クラスタ構成・HSR 構成を行っている場合、公開ドキュメントのとおりローカル ホストではなくロード バランサーのホスト/IP を使用してキーを作成してください。<br>　　今回は、仮想 IP は使用していない前提のコマンド例を記載しています。</p><p>(Secondary マシン上で実行するコマンド 例)<br>hdbuserstore Set <font color="Red">SYSTEM</font> <font color="MediumBlue">saphana24</font>:3<font color="Red">90</font>13 SYSTEM <font color="MediumBlue">&lt;パスワード&gt;</font><br>hdbuserstore list<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/93a9a515-bcc4-4081-8c01-1ef1c9f54e19" alt="image"></p><h2 id="5-Secondary-マシン上-カスタム-バックアップ-ユーザーに対してキーを設定する"><a href="#5-Secondary-マシン上-カスタム-バックアップ-ユーザーに対してキーを設定する" class="headerlink" title=" 5. (Secondary マシン上) カスタム バックアップ ユーザーに対してキーを設定する"></a><a id="5"></a> 5. (Secondary マシン上) カスタム バックアップ ユーザーに対してキーを設定する</h2><p>（補足）<br>Primary マシン上で作成したカスタム バックアップ ユーザーとそのパスワードは、HSR の機能によって、自動的に Secondary マシンへレプリケートされます。<br>このためすでに HSR 設定済であれば Secondary マシン上では再度「カスタム バックアップ ユーザーの作成」を行う必要はありませんが、この段階でもし HSR 設定が完了しておらず、レプリケートしていない場合は、ユーザーにて Secondary マシン上にも再度「カスタム バックアップ ユーザーの作成」から作業ください。<br>ここでは、すでに HSR 機能にてカスタム バックアップ ユーザーはレプリケートされている前提で、Secondary マシン上での「カスタム バックアップ ユーザーの作成」部分はスキップします。</p><p>※ 仮想 IP を使用して クラスタ構成・HSR 構成を行っている場合、公開ドキュメントのとおりローカル ホストではなくロード バランサーのホスト/IP を使用してカスタム バックアップ キーを作成してください。<br>　　今回は、仮想 IP は使用していない前提のコマンド例を記載しています。</p><p>(実行するコマンド)<br>hdbuserstore Set &lt;作成するキー名&gt; &lt;作成先HANA DB のホスト名&gt;:3&lt;インスタンス番号&gt;13 &lt;カスタム バックアップ ユーザー名&gt; &lt;カスタム バックアップ ユーザーのパスワード&gt;</p><p>(Secondary マシン上で実行するコマンド 例)<br>hdbuserstore Set <font color="Red">OKTBKKEY</font> <font color="MediumBlue">saphana24</font>:3<font color="Red">90</font>13 <font color="MediumBlue">OKTBK</font> <font color="Red">&lt;パスワード&gt;</font><br>hdbuserstore list<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/0de489dd-2806-41b0-9b74-22426fe82993" alt="image"></p><h2 id="6-これまで-Azure-Backup-構成していた場合-「バックアップの停止」を行う"><a href="#6-これまで-Azure-Backup-構成していた場合-「バックアップの停止」を行う" class="headerlink" title=" 6. (これまで Azure Backup 構成していた場合)「バックアップの停止」を行う"></a><a id="6"></a> 6. (これまで Azure Backup 構成していた場合)「バックアップの停止」を行う</h2><p>『これまで スタンドアロンの SAP HANA DB として、Azure workload Backup を構成していた』<br>という場合、対象の SAP HANA DB は今後「HSR に対する Azure Workload Backup」としてバックアップ構成しなおすことになります。<br>このため、一度、これまでバックアップ取得していたスタンドアロンの SAP HANA DB に対しては<br>「バックアップ データの保持」・「バックアップの停止」を行ってください。</p><p>・(参考 「バックアップの停止」部分まで) 2 つのスタンドアロン VM/1 つのスタンドアロン VM が Azure VM 上の SAP HANA Database バックアップを使用して既に保護されている<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#two-standalone-vms-one-standalone-vm-already-protected-using-sap-hana-database-backup-on-azure-vm">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#two-standalone-vms-one-standalone-vm-already-protected-using-sap-hana-database-backup-on-azure-vm</a></p><p>『これまで一度も、対象 DB に対して Azure Workload Backup を構成したことが無い』<br>『今回初めて HSR 構成・HSR に対する Azure Workload Backup を行う』<br>という場合は、「6」手順はスキップし、「7. (Primary マシン上) 事前登録スクリプトをダウンロード・実行する」より作業を再開ください。</p><h2 id="7-Primary-マシン上-事前登録スクリプトをダウンロード・実行する"><a href="#7-Primary-マシン上-事前登録スクリプトをダウンロード・実行する" class="headerlink" title=" 7. (Primary マシン上) 事前登録スクリプトをダウンロード・実行する"></a><a id="7"></a> 7. (Primary マシン上) 事前登録スクリプトをダウンロード・実行する</h2><p>・(参考) 事前登録スクリプトを実行する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script</a></p><p>(ルートユーザーで実行するコマンド)<br>./msawb-plugin-config-com-sap-hana.sh -sn -bk &lt;カスタム バックアップ ユーザー向けに作成したキー名&gt; -hn (HSR ID)</p><p>【引数の説明】<br>■　-sn ( –skip-network-checks )： ネットワーク要件を満たしているかどうかのチェック処理をスキップしたい場合、追加ください<br>■　-bk ( -backup-key )：カスタム バックアップ ユーザー向けに作成したキー名を引数として渡してください<br>■　-hn (–hsr-unique-value)：HSR ID。Recovery Services コンテナー上での論理名を引数として渡します。この値はユーザーにて自由に決定ください</p><p>・(コマンド引数の参考) 事前登録スクリプトを実行する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script</a><br>　“このカスタム バックアップ ユーザー キーを、パラメーターとしてスクリプトに渡します。<br>　 -bk CUSTOM_BACKUP_KEY_NAME または -backup-key CUSTOM_BACKUP_KEY_NAME”</p><p>そのほか引数の説明は、事前登録スクリプト内に詳しく記載されています。</p><p>今回は例として「Hana2324LC」を HSR ID として、バックアップ構成します。</p><p>(Primary マシン上で実行するコマンド 例)<br>sudo su -<br>chmod 755 msawb-plugin-config-com-sap-hana.sh<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/8be08d61-6df3-48b3-9fdc-dc37402af1e5" alt="image"></p><p>./msawb-plugin-config-com-sap-hana.sh -sn -bk <font color="Red">OKTBKKEY</font> -hn <font color="Red">Hana2324LC</font><br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/e57524ee-f9b2-4e47-8e57-1f9760fb2a7b" alt="image"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/e2d81c4c-fbc9-4cd2-a80f-9e425a3f7ecb" alt="image"></p><p>事前登録スクリプト実行完了後、下記 ファイル上で、Azure Backup 構成における HSR ID やカスタム バックアップ ユーザーの設定値を確認できます。</p><p>(Primary マシン上で実行するコマンド 例)<br>cat /opt/msawb/etc/config/SAPHana/config.json<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/25d5e330-8e88-492c-a9ae-f77eeda8f497" alt="image"></p><p>Primary 側で事前登録スクリプトを実行後、カスタム バックアップ ユーザーに対して、「INIFILE ADMIN」ロールなどが追加付与されていることが分かります。<br>(事前登録スクリプトにて追加付与されました)<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/bd501b56-4d45-452e-8008-a8314e711c5a" alt="image"></p><h2 id="8-Secondary-マシン上-事前登録スクリプトをダウンロード・実行する"><a href="#8-Secondary-マシン上-事前登録スクリプトをダウンロード・実行する" class="headerlink" title=" 8. (Secondary マシン上) 事前登録スクリプトをダウンロード・実行する"></a><a id="8"></a> 8. (Secondary マシン上) 事前登録スクリプトをダウンロード・実行する</h2><p><font color="DeepPink">「-hn」引数に渡す、一意の HSR ID は、必ず Primary 側にて設定したものとおなじ HSR ID にしてください。</font></p><p>(ルートユーザーで実行するコマンド)<br>./msawb-plugin-config-com-sap-hana.sh -sn -bk &lt;カスタム バックアップ ユーザー向けに作成したキー名&gt; -hn (HSR ID) -p &lt;ポート番号&gt;</p><p>・(参考) 事前登録スクリプトを実行する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-the-preregistration-script</a><br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/c445fc40-5f3a-4c44-8c73-ac7767c3fada" alt="image"></p><p>(Secondary マシン上で実行するコマンド 例)<br>sudo su -<br>./msawb-plugin-config-com-sap-hana.sh -sn -bk <font color="Red">OKTBKKEY</font> -hn <font color="MediumBlue">Hana2324LC</font> -p 3<font color="Red">90</font>13<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/f5d3b4f3-8d3e-40e3-82a7-592a2f8dfead" alt="image"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/2bf1b252-b022-450f-adf1-61017a25bf15" alt="image"></p><p>cat /opt/msawb/etc/config/SAPHana/config.json<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/f724da83-be23-480c-9e2a-4340f8523bda" alt="image"></p><h2 id="9-Recovery-Services-コンテナー上で「データベースを検出」「バックアップの有効化」「今すぐバックアップ」を行う"><a href="#9-Recovery-Services-コンテナー上で「データベースを検出」「バックアップの有効化」「今すぐバックアップ」を行う" class="headerlink" title=" 9. Recovery Services コンテナー上で「データベースを検出」「バックアップの有効化」「今すぐバックアップ」を行う"></a><a id="9"></a> 9. Recovery Services コンテナー上で「データベースを検出」「バックアップの有効化」「今すぐバックアップ」を行う</h2><p>ここからは下記公開ドキュメントに沿って、Azure ポータル画面上で操作ください。</p><p>・データベースを検出する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#discover-the-databases">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#discover-the-databases</a></p><p>(英語版となり恐縮ですが) Azure ポータル画面上の作業例です<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/89d246f6-aac6-4661-87d4-5116106dcbab" alt="image"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/4e1b441f-7332-4acd-b270-a4684ce6ca4e" alt="image"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/cc0c270e-7e33-472d-b45c-a200b80c73dc" alt="image"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/1150d3f1-9cc6-479d-90f0-ef7c6f3ef27e" alt="image"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/e2871c2f-6764-4eba-b746-1090a7a32130" alt="image"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/2f1e1dd0-d9af-4b3c-b07c-33948640c43e" alt="image"></p><p>(バックアップ取得後)<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/9140d011-8bf5-45ef-838a-49c1dfed10ce" alt="image"></p><h2 id="10-FAQ"><a href="#10-FAQ" class="headerlink" title=" 10. FAQ"></a><a id="10"></a> 10. FAQ</h2><h3 id="Q1-HSR-構成に伴い、クラスタ-ソフトウェアは-Pacemaker-Lifekeeper-など制限はありますか？"><a href="#Q1-HSR-構成に伴い、クラスタ-ソフトウェアは-Pacemaker-Lifekeeper-など制限はありますか？" class="headerlink" title="Q1. HSR 構成に伴い、クラスタ ソフトウェアは Pacemaker, Lifekeeper など制限はありますか？"></a>Q1. HSR 構成に伴い、クラスタ ソフトウェアは Pacemaker, Lifekeeper など制限はありますか？</h3><p>A1. 「HSR に対する Azure Workload Backup」の観点においては、クラスタ ソフトウェアの制限はありません。<br>ユーザー側にて HSR を構成し、HSR が機能しているのであれば、 Azure Backup としてはバックアップ取得が可能です。</p><h3 id="Q2-事前登録スクリプトを実行する前に、HANA-側で-HSR-設定を完了しておく必要はありますか？"><a href="#Q2-事前登録スクリプトを実行する前に、HANA-側で-HSR-設定を完了しておく必要はありますか？" class="headerlink" title="Q2. 事前登録スクリプトを実行する前に、HANA 側で HSR 設定を完了しておく必要はありますか？"></a>Q2. 事前登録スクリプトを実行する前に、HANA 側で HSR 設定を完了しておく必要はありますか？</h3><p>A2. いいえ、下記順序でも構いません。<br>　事前登録スクリプト実行<br>　　↓<br>　HSR 構成<br>　　↓<br>　「データベースを検出」「バックアップの有効化」バックアップ取得</p><p>・Azure Backup のデータベースで SAP HANA ネイティブ クライアント バックアップを実行する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-sap-hana-native-clients-backup-on-a-database-with-azure-backup">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-with-hana-system-replication-backup#run-sap-hana-native-clients-backup-on-a-database-with-azure-backup</a></p><h3 id="Q3-HANA-Studio-からバックアップ・復元操作はできますか？"><a href="#Q3-HANA-Studio-からバックアップ・復元操作はできますか？" class="headerlink" title="Q3. HANA Studio からバックアップ・復元操作はできますか？"></a>Q3. HANA Studio からバックアップ・復元操作はできますか？</h3><p>A3. いいえ、HSR に対する Azure Workload Backup 構成をしている場合は、HANA Studio からの操作はサポートいたしておりません。</p><p>・(参考) SAP HANA ネイティブ クライアントを使用して操作を管理する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-manage#manage-operations-using-sap-hana-native-clients">https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-manage#manage-operations-using-sap-hana-native-clients</a><br>　“HANA ネイティブ クライアントは、Backint ベースの操作用のみに統合されています。<br>　　スナップショットと HANA システム レプリケーション モードに関連する操作は、現在サポートされていません。”</p><p>HSR に対する Azure Workload Backup の設定方法は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、HSR に対する Azure Workload Backup を構成するにあたって、実際のバックアップ構成手順を作業例交えてお伝えします。&lt;/p&gt;
&lt;h4</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure SAPHANA Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-SAPHANA-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure Backup の 保持期間について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/Backup_RetentionPeriod/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/Backup_RetentionPeriod/</id>
    <published>2023-08-24T03:00:00.000Z</published>
    <updated>2023-10-30T10:53:16.211Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートです。<br>今回は、よくお問い合わせをうける「保持期限」について、取りまとめてお伝えします。<br>公開ドキュメント上では、下記のように「最大保有期間：バックアップ頻度次第」と記載が書かれており、実際に「毎日」「毎週」のバックアップを構成した場合の最大保有期間は、ポリシー作成画面で確認するのみとなっております。</p><p>・保有の制限<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix#retention-limits">https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix#retention-limits</a></p><p><img src="https://user-images.githubusercontent.com/96324317/197381027-dcf0c231-950e-4b50-a14f-4f2d991c9616.png"></p><p>（図例：Azure VM Backup の場合）<br><img src="https://user-images.githubusercontent.com/96324317/197453814-73c643d9-ad3f-458c-b729-4fb7a409aab6.png"></p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Azure VM Backup の場合</a><br><a href="#2">2. Azure ファイル共有に対する Azure Backup の場合</a><br><a href="#3">3. SQL Server DB に対する Azure Backup の場合</a><br><a href="#4">4. SAP HANA DB に対する Azure Backup の場合</a><br><a href="#5">5. Microsoft Azure Recovery Services (MARS) の場合</a><br><a href="#6">6. Azure ディスク バックアップの場合</a><br><a href="#7">7. Azure BLOB バックアップ の場合</a><br><a href="#8">8. Microsoft Azure Backup Server (MABS) または System Center Data Protection Manager (DPM) の場合</a></p><hr><h2 id="1-Azure-VM-Backup-の場合"><a href="#1-Azure-VM-Backup-の場合" class="headerlink" title=" 1. Azure VM Backup の場合"></a><a id="1"></a> 1. Azure VM Backup の場合</h2><h3 id="ポリシーのサブタイプ：Standard-の場合"><a href="#ポリシーのサブタイプ：Standard-の場合" class="headerlink" title="ポリシーのサブタイプ：Standard の場合"></a>ポリシーのサブタイプ：Standard の場合</h3><h4 id="インスタント回復スナップショットの保持期間"><a href="#インスタント回復スナップショットの保持期間" class="headerlink" title="インスタント回復スナップショットの保持期間"></a>インスタント回復スナップショットの保持期間</h4><table><thead><tr><th>バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日</td><td>1 日</td><td>5 日</td></tr><tr><td>毎週</td><td>5 日</td><td>5 日</td></tr></tbody></table><h4 id="Recovery-Services-コンテナー層上の保持期間"><a href="#Recovery-Services-コンテナー層上の保持期間" class="headerlink" title="Recovery Services コンテナー層上の保持期間"></a>Recovery Services コンテナー層上の保持期間</h4><table><thead><tr><th>バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日</td><td>7 日</td><td>9999 日</td></tr><tr><td>毎週</td><td>1 週</td><td>5163 週</td></tr><tr><td>毎月</td><td>1 ヶ月</td><td>1188 ヶ月</td></tr><tr><td>毎年</td><td>1 年</td><td>99 年</td></tr></tbody></table><h3 id="ポリシーのサブタイプ：Enhanced-の場合"><a href="#ポリシーのサブタイプ：Enhanced-の場合" class="headerlink" title="ポリシーのサブタイプ：Enhanced の場合"></a>ポリシーのサブタイプ：Enhanced の場合</h3><h4 id="インスタント回復スナップショットの保持期間-1"><a href="#インスタント回復スナップショットの保持期間-1" class="headerlink" title="インスタント回復スナップショットの保持期間"></a>インスタント回復スナップショットの保持期間</h4><table><thead><tr><th>バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>4 時間ごと</td><td>1 日</td><td>11 日</td></tr><tr><td>6 時間ごと</td><td>1 日</td><td>17 日</td></tr><tr><td>8 時間ごと</td><td>1 日</td><td>22 日</td></tr><tr><td>12 時間ごと</td><td>1 日</td><td>30 日</td></tr><tr><td>毎日</td><td>1 日</td><td>30 日</td></tr><tr><td>毎週</td><td>5 日</td><td>30 日</td></tr></tbody></table><h4 id="Recovery-Services-コンテナー層上の保持期間-1"><a href="#Recovery-Services-コンテナー層上の保持期間-1" class="headerlink" title="Recovery Services コンテナー層上の保持期間"></a>Recovery Services コンテナー層上の保持期間</h4><table><thead><tr><th>バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日</td><td>7 日</td><td>9999 日</td></tr><tr><td>毎週</td><td>1 週</td><td>5163 週</td></tr><tr><td>毎月</td><td>1 ヶ月</td><td>1188 ヶ月</td></tr><tr><td>毎年</td><td>1 年</td><td>99 年</td></tr></tbody></table><p>（補足）Enhanced バックアップ ポリシーの場合、「〇時間ごと」というような頻度を選択可能です。<br>　1 日に複数回のバックアップ取得を設定した場合、バックアップ ポリシー上の周期から計算して「その日の最後のバックアップ」のみが Recovery Services コンテナー層に保管されます。</p><p>・拡張ポリシーを使用して Azure VM をバックアップする - Azure Backup | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal#create-an-enhanced-policy-and-configure-vm-backup">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal#create-an-enhanced-policy-and-configure-vm-backup</a><br>　“毎時間のバックアップの場合、その日の最後のバックアップがコンテナーに転送されます。 バックアップが失敗すると、次の日の最初のバックアップがコンテナーに転送されます。”</p><p>(Enhanced バックアップ ポリシー の設定例)<br>開始時刻：JST 16時<br>スケジュール：4時間ごと<br>バックアップ期間：24時間</p><p>スナップショット① = JST 6/27 16:00 ごろ取得 → Recovery Services コンテナーには転送されず、スナップショット層にのみ保管される<br>スナップショット② = JST 6/27 20:00 ごろ取得 → Recovery Services コンテナーには転送されず、スナップショット層にのみ保管される<br>スナップショット③ = JST 6/28 0:00 ごろ取得   → Recovery Services コンテナーには転送されず、スナップショット層にのみ保管される<br>スナップショット④ = JST 6/28 4:00 ごろ取得   → Recovery Services コンテナーには転送されず、スナップショット層にのみ保管される<br>スナップショット⑤ = JST 6/28 8:00 ごろ取得   → Recovery Services コンテナーには転送されず、スナップショット層にのみ保管される<br>スナップショット⑥ = JST 6/28 12:00 ごろ取得  → <font color="OrangeRed">Recovery Services コンテナーへ転送される</font></p><p>（補足）オンデマンド バックアップの場合、最大 99 年まで保持期間を指定可能です。<br><img src="https://user-images.githubusercontent.com/96324317/197448093-5b532557-b4e6-44de-b837-01993756862a.png"></p><h2 id="2-Azure-ファイル共有に対する-Azure-Backup-の場合"><a href="#2-Azure-ファイル共有に対する-Azure-Backup-の場合" class="headerlink" title=" 2. Azure ファイル共有に対する Azure Backup の場合"></a><a id="2"></a> 2. Azure ファイル共有に対する Azure Backup の場合</h2><table><thead><tr><th>Azure ファイル共有 に対するバックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日</td><td>1 日</td><td>200 日</td></tr><tr><td>毎週</td><td>1 週</td><td>200 週</td></tr><tr><td>毎月</td><td>1 ヶ月</td><td>120 ヶ月</td></tr><tr><td>毎年</td><td>1 年</td><td>10 年</td></tr></tbody></table><h2 id="3-SQL-Server-DB-に対する-Azure-Backup-の場合"><a href="#3-SQL-Server-DB-に対する-Azure-Backup-の場合" class="headerlink" title=" 3. SQL Server DB に対する Azure Backup の場合"></a><a id="3"></a> 3. SQL Server DB に対する Azure Backup の場合</h2><table><thead><tr><th>完全バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日</td><td>7 日</td><td>9999 日</td></tr><tr><td>毎週</td><td>1 週</td><td>5163 週</td></tr><tr><td>毎月</td><td>1 ヶ月</td><td>1188 ヶ月</td></tr><tr><td>毎年</td><td>1 年</td><td>99 年</td></tr></tbody></table><table><thead><tr><th>差分バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎週</td><td>7 日</td><td>180 日</td></tr></tbody></table><table><thead><tr><th>ログバックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎分/毎時</td><td>7 日</td><td>35 日</td></tr></tbody></table><h2 id="4-SAP-HANA-DB-に対する-Azure-Backup-の場合"><a href="#4-SAP-HANA-DB-に対する-Azure-Backup-の場合" class="headerlink" title=" 4. SAP HANA DB に対する Azure Backup の場合"></a><a id="4"></a> 4. SAP HANA DB に対する Azure Backup の場合</h2><table><thead><tr><th>完全バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日</td><td>7 日</td><td>9999 日</td></tr><tr><td>毎週</td><td>1 週</td><td>5163 週</td></tr><tr><td>毎月</td><td>1 ヶ月</td><td>1188 ヶ月</td></tr><tr><td>毎年</td><td>1 年</td><td>99 年</td></tr></tbody></table><table><thead><tr><th>差分バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎週</td><td>7 日</td><td>180 日</td></tr></tbody></table><table><thead><tr><th>増分バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎週</td><td>7 日</td><td>180 日</td></tr></tbody></table><table><thead><tr><th>ログバックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎分/毎時</td><td>7 日</td><td>35 日</td></tr></tbody></table><h2 id="5-Microsoft-Azure-Recovery-Services-MARS-の場合"><a href="#5-Microsoft-Azure-Recovery-Services-MARS-の場合" class="headerlink" title=" 5. Microsoft Azure Recovery Services (MARS) の場合"></a><a id="5"></a> 5. Microsoft Azure Recovery Services (MARS) の場合</h2><table><thead><tr><th>MARS バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日</td><td>7 日</td><td>9999 日</td></tr><tr><td>毎週</td><td>4 週</td><td>5163 週</td></tr><tr><td>毎月</td><td>3 ヶ月</td><td>1316 ヶ月</td></tr><tr><td>毎年</td><td>1 年</td><td>100 年</td></tr></tbody></table><h2 id="6-Azure-ディスク-バックアップの場合"><a href="#6-Azure-ディスク-バックアップの場合" class="headerlink" title=" 6. Azure ディスク バックアップの場合"></a><a id="6"></a> 6. Azure ディスク バックアップの場合</h2><table><thead><tr><th>Azure ディスク バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>1 時間ごと</td><td>1 日</td><td>18 日</td></tr><tr><td>2 時間ごと</td><td>1 日</td><td>37 日</td></tr><tr><td>4 時間ごと</td><td>1 日</td><td>75 日</td></tr><tr><td>6 時間ごと</td><td>1 日</td><td>112 日</td></tr><tr><td>8 時間ごと</td><td>1 日</td><td>150 日</td></tr><tr><td>12 時間ごと</td><td>1 日</td><td>225 日</td></tr><tr><td>毎日</td><td>1 日</td><td>450 日</td></tr></tbody></table><p>(補足 1 )<br>Azure ディスク バックアップでは、ディスクあたりのスナップショット合計数が 500 までとなるよう、バックアップ ポリシー上で制限されています。<br>・ディスク バックアップのスケジュールと保持期間はどのように機能しますか?<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-overview#how-does-the-disk-backup-scheduling-and-retention-period-work">https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-overview#how-does-the-disk-backup-scheduling-and-retention-period-work</a><br>　“スナップショットの保持期間は、ディスクのスナップショット制限によって制御されます。”</p><p>(補足 2 )<br>バックアップ ポリシー作成時、「保持規則の追加」をクリックすることで、<br>「毎日」もしくは「毎週」作成される、特定のバックアップについては、追加で保持期間を設定することができます。</p><p>・バックアップ ポリシーを作成する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-managed-disks#create-backup-policy">https://learn.microsoft.com/ja-jp/azure/backup/backup-managed-disks#create-backup-policy</a><br>　“最初に正常に作成された日単位または週単位のバックアップを選択して、特定のバックアップが削除される前に保持されるリテンション期間を指定できます。<br>　 このオプションは、日または週の特定のバックアップを長期間保持するのに便利です。<br>　 その他のバックアップについては、保持期間を短くすることができます。”</p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/f5b8eb75-5796-4f5f-8658-964f44d88159" alt="image"></p><h2 id="7-Azure-BLOB-バックアップ-の場合"><a href="#7-Azure-BLOB-バックアップ-の場合" class="headerlink" title=" 7. Azure BLOB バックアップ の場合"></a><a id="7"></a> 7. Azure BLOB バックアップ の場合</h2><h3 id="運用バックアップの場合"><a href="#運用バックアップの場合" class="headerlink" title="運用バックアップの場合"></a>運用バックアップの場合</h3><p>バックアップ対象ストレージ アカウント上にのみバックアップ データを保管します。<br>「1 日に 1 回のバックアップ」などではなく、継続的なバックアップ取得となるため、「バックアップ頻度」というものはございません。<br>最小保持期間は 1 日、最大保持期間は 360 日、またはそれに相当する数の週 (51) または月 (11) です。</p><h3 id="保管済みバックアップの場合"><a href="#保管済みバックアップの場合" class="headerlink" title="保管済みバックアップの場合"></a>保管済みバックアップの場合</h3><p>バックアップ対象ストレージ アカウント上および バックアップ コンテナー上にバックアップ データを保管します。</p><table><thead><tr><th>保管済みバックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日</td><td>7 日</td><td>3650 日</td></tr><tr><td>毎週</td><td>4 週</td><td>521 週</td></tr></tbody></table><p>(補足)<br>保持期間は日、週、月、年 単位で設定することも可能です。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/fff5ac05-c0e1-4b3b-b5f2-7f442aaf4bfa" alt="image"></p><p>「保持規則の追加」をクリックすることで、「毎週」、「毎月」もしくは「毎年」作成される、特定のバックアップについては、追加で保持期間を設定することができます。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/409bcd0f-66b7-414d-9e0b-a451f6cb73d1" alt="image"></p><h2 id="8-Microsoft-Azure-Backup-Server-MABS-または-System-Center-Data-Protection-Manager-DPM-の場合"><a href="#8-Microsoft-Azure-Backup-Server-MABS-または-System-Center-Data-Protection-Manager-DPM-の場合" class="headerlink" title=" 8. Microsoft Azure Backup Server (MABS) または System Center Data Protection Manager (DPM) の場合"></a><a id="8"></a> 8. Microsoft Azure Backup Server (MABS) または System Center Data Protection Manager (DPM) の場合</h2><h3 id="DPM-MABS-ローカルディスクへのバックアップ"><a href="#DPM-MABS-ローカルディスクへのバックアップ" class="headerlink" title="(DPM / MABS) ローカルディスクへのバックアップ"></a>(DPM / MABS) ローカルディスクへのバックアップ</h3><table><thead><tr><th>バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>(*1)</td><td>1 日 (*2)</td><td>448 日</td></tr></tbody></table><p>(*1) 保護対象のワークロードにより、指定可能な間隔が異なります。たとえば SQL Server の場合、最短 15 分間隔が指定できます。<br>また、保護対象がファイル データの場合、回復ポイントの最大数は 64 個、保護対象がアプリケーション データの場合は最大 448 個の制限がございます。</p><p>(*2) DPM / MABS における保持期間の考え方は、カレンダー上の経過日数ではなく、正常に回復ポイントが取得された日数をカウントします。<br>たとえば、保持期間を 1 日に設定し、月曜日に回復ポイントを取得した場合、1 日分としてカウントされ、バックアップ データは火曜日以降も保持されます。<br>保持日数のカウント数を超えた場合 (たとえば次の月曜日に回復ポイントを作成)、メンテナンス ジョブ (毎日深夜 0 時に自動実行) によって、古いものから削除されます。</p><h3 id="DPM-Tape-への長期保護バックアップ-保護対象をディスクにバックアップしてからテープにバックアップ"><a href="#DPM-Tape-への長期保護バックアップ-保護対象をディスクにバックアップしてからテープにバックアップ" class="headerlink" title="(DPM)  Tape への長期保護バックアップ (保護対象をディスクにバックアップしてからテープにバックアップ)"></a>(DPM)  Tape への長期保護バックアップ (保護対象をディスクにバックアップしてからテープにバックアップ)</h3><table><thead><tr><th>バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日</td><td>7 日</td><td>28 日</td></tr><tr><td>毎週</td><td>1 週</td><td>4 週</td></tr><tr><td>毎月</td><td>1 ヶ月</td><td>11 ヶ月</td></tr><tr><td>毎年</td><td>1 年</td><td>99 年</td></tr></tbody></table><h3 id="DPM-Tape-への短期保護バックアップ-保護対象を直接テープにバックアップ"><a href="#DPM-Tape-への短期保護バックアップ-保護対象を直接テープにバックアップ" class="headerlink" title="(DPM)  Tape への短期保護バックアップ (保護対象を直接テープにバックアップ)"></a>(DPM)  Tape への短期保護バックアップ (保護対象を直接テープにバックアップ)</h3><table><thead><tr><th>バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日</td><td>7 日</td><td>84 日</td></tr><tr><td>毎週</td><td>1 週</td><td>12 週</td></tr></tbody></table><h3 id="DPM-MABS-オンライン-バックアップ-保護対象をディスクにバックアップしてから-Recovery-Services-コンテナーにバックアップ"><a href="#DPM-MABS-オンライン-バックアップ-保護対象をディスクにバックアップしてから-Recovery-Services-コンテナーにバックアップ" class="headerlink" title="(DPM / MABS) オンライン バックアップ (保護対象をディスクにバックアップしてから Recovery Services コンテナーにバックアップ)"></a>(DPM / MABS) オンライン バックアップ (保護対象をディスクにバックアップしてから Recovery Services コンテナーにバックアップ)</h3><table><thead><tr><th>バックアップの頻度</th><th>最小保持期間</th><th>最大保持期間</th></tr></thead><tbody><tr><td>毎日　(一日最大 2 回)</td><td>7 日</td><td>9999 日</td></tr><tr><td>毎週</td><td>4 週</td><td>9999 週</td></tr><tr><td>毎月</td><td>3 ヶ月</td><td>9999 ヶ月</td></tr><tr><td>毎年</td><td>1 年</td><td>9999 年</td></tr></tbody></table><p>Azure Backup における保有期間について、以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートです。&lt;br&gt;今回は、よくお問い合わせをうける「保持期限」について、取りまとめてお伝えします。&lt;br&gt;公開ドキュメント上では、下記のように「最大保有期間：バックアップ頻度次第」</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup と Azure Site Recovery による DR 要件について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/DR_ASR_or_VMBackup/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/DR_ASR_or_VMBackup/</id>
    <published>2023-08-04T03:00:00.000Z</published>
    <updated>2023-10-30T10:53:16.211Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは。Azure VM 、Azure Site Recovery 担当です。<br>今回は Azure のリージョン障害などを想定した Azure VM の Disaster Recovery (DR) 対策を検討中のお客様よりお問合せをいただきます「Azure VM Backup と Azure Site Recovery どちらを利用すればいいのか？」について解説させていただきます。</p><p>結論としては、お客様の DR 要件である RTO, RPO をクリアにしていただく必要があり、ここがクリアになれば Azure VM Backup と Azure Site Recovery どちらを選択すればいいか判断できるようになると存じます。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. DR, RTO, RPO について</a><br>   <a href="#1-1">  1.1 Disaster Recovery (DR)</a><br>   <a href="#1-2">  1.2 Recovery Time Objective (RTO)</a><br>   <a href="#1-3">  1.3 Recovery Point Objective (RPO)</a><br><a href="#2">2. Azure VM Backup と Azure Site Recovery の比較</a><br><a href="#2">3. 参考情報 : DR 対策のための Azure VM のディスクの冗長構成は非推奨</a></p><hr><h2 id="1-DR-RTO-RPO-について"><a href="#1-DR-RTO-RPO-について" class="headerlink" title=" 1. DR, RTO, RPO について"></a><a id="1"></a> 1. DR, RTO, RPO について</h2><p>まずは前提知識について DR, RTO, RPO について簡単に説明いたします。</p><h3 id="Disaster-Recovery-DR"><a href="#Disaster-Recovery-DR" class="headerlink" title=" Disaster Recovery (DR)"></a><a id="1-1"></a> Disaster Recovery (DR)</h3><p>大規模災害などの影響によりシステムやデータセンターが障害を受けた際に、利用できなくなったシステムを素早く復旧するための計画やそのような状態を未然に防ぐことを指します。<br>事業者様によって整備されている、BCP (事業継続計画) をご確認いただくことで後の RTO, RPO の指標が明確になるかと存じます。</p><h3 id="Recovery-Time-Objective-RTO"><a href="#Recovery-Time-Objective-RTO" class="headerlink" title=" Recovery Time Objective (RTO)"></a><a id="1-2"></a> Recovery Time Objective (RTO)</h3><p>「目標復旧時間」のことで、大規模災害などの影響によりシステムやデータセンターが障害を受けシステムが停止した時に、その時点から復旧までにかかる時間のことを指します。どのくらいの時間がダウンタイムとして許容できるかをご確認いただくのが良いかと存じます。</p><ul><li>ダウンタイムの許容時間は最大 24 時間。など</li></ul><p>・RTO (目標復旧時間)<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-backup-glossary#rto-recovery-time-objective">https://learn.microsoft.com/ja-jp/azure/backup/azure-backup-glossary#rto-recovery-time-objective</a></p><h3 id="Recovery-Point-Objective-RPO"><a href="#Recovery-Point-Objective-RPO" class="headerlink" title=" Recovery Point Objective (RPO)"></a><a id="1-3"></a> Recovery Point Objective (RPO)</h3><p>「目標復旧時点」のことで、大規模災害などの影響によりシステムやデータセンターが障害を受けシステムが停止した時に、過去のどの時点のデータまでを復旧できるかを指します。障害時点から復旧ポイントまでの間の時間のデータは復旧できないことになるため、データ復旧ができなくても許容できる時間をご確認いただくのが良いかと存じます。</p><ul><li>データ損失の許容時間は直前 12 時間以内。など</li></ul><p>・RPO (復旧ポイントの目標)<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-backup-glossary#rpo-recovery-point-objective">https://learn.microsoft.com/ja-jp/azure/backup/azure-backup-glossary#rpo-recovery-point-objective</a></p><h2 id="2-Azure-VM-Backup-と-Azure-Site-Recovery-の比較"><a href="#2-Azure-VM-Backup-と-Azure-Site-Recovery-の比較" class="headerlink" title=" 2. Azure VM Backup と Azure Site Recovery の比較"></a><a id="2"></a> 2. Azure VM Backup と Azure Site Recovery の比較</h2><p>以下は Azure VM Backup と Azure Site Recovery の比較表です。<br>2 時間以上のダウンタイム (RTO) が許容されない場合や、24 時間以上のデータ損失が許容されない場合など Azure VM Backup で対応できない場合には Azure Site Recovery の採用をご検討いただければと存じます。</p><table><thead><tr><th align="left">#</th><th align="left">Azure VM Backup</th><th align="left">Azure Site Recovery</th></tr></thead><tbody><tr><td align="left">機能</td><td align="left">Azure VM のバックアップを取得します。<br>Recovery Services コンテナーを GRS (または RA-GRS) にすることで、ペア リージョンへのバックアップ データのレプリケーションが行われペア リージョンでの復元ができるようになります。<br>[ご参考] ・ Azure VM Backup における CRR (クロスリージョン リストア) について<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/CRR/">https://jpabrs-scem.github.io/blog/AzureVMBackup/CRR/</a></td><td align="left">Azure VM のデータをターゲット リージョンのディスクへレプリケーションします。</td></tr><tr><td align="left">復旧ポイントの保持期間</td><td align="left">最大 99 年保持することができます。</td><td align="left">Unmanaged Disk では最大 72 時間 (3 日) 保持することができます。<br>Managed Disk では最大 15 日保持することができます。</td></tr><tr><td align="left">RTO に関する SLA</td><td align="left">RTO について SLA はありません。</td><td align="left">SLA で 2 時間以内の RTO を保証します。<br> [ご参考] ・Azure Site Recovery の SLA<br><a href="https://azure.microsoft.com/ja-jp/support/legal/sla/site-recovery/v1_2/">https://azure.microsoft.com/ja-jp/support/legal/sla/site-recovery/v1_2/</a><br>&gt;オンプレミスと Azure 間の計画上および計画外のフェールオーバー用に構成された保護された各インスタンスにつき、マイクロソフトは、2 時間の目標復旧時間を保証します。</td></tr><tr><td align="left">Recovery Time Objective (RTO)</td><td align="left">明確には定めておりません。<br> <strong>大容量の VM では復元に 24 時間以上かかる場合がございます。</strong><br>[ご参考] ・1.1 Azure VM Backup のバックアップ時間について<br>Azure Backup の バックアップ / リストア 所要時間について　<br><a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/Backup_RecoveryTIme/#1-1">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/Backup_RecoveryTIme/#1-1</a></td><td align="left">2 時間以内の RTO を提供します。</td></tr><tr><td align="left">Recovery Point Objective (RPO)</td><td align="left">スタンダード バックアップ ポリシーをご利用の場合、バックアップのスケジュールは 1 日 1 回となります。<br>その場合、最短の復元ポイント時点が 24 時間以上前となる場合がございます。<br>拡張バックアップ ポリシーをご利用の場合、バックアップのスケジュールは最短 4 時間おきのバックアップが可能です。<br> [ご参考] ・拡張ポリシーを使用して Azure VM をバックアップする<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal</a></td><td align="left">クラッシュ整合性復旧ポイントは 5 分ごとに取得されます。<br>アプリ整合性復旧ポイントは、レプリケーション ポリシーにて設定でき最短で 1 時間ごとにスケジュールできます。</td></tr></tbody></table><h2 id="3-参考情報-DR-対策のための-Azure-VM-のディスクの冗長構成は非推奨"><a href="#3-参考情報-DR-対策のための-Azure-VM-のディスクの冗長構成は非推奨" class="headerlink" title=" 3. 参考情報 : DR 対策のための Azure VM のディスクの冗長構成は非推奨"></a><a id="3"></a> 3. 参考情報 : DR 対策のための Azure VM のディスクの冗長構成は非推奨</h2><p>Azure VM では、Unmanaged Disk を利用している場合にストレージ アカウントの GRS は非推奨構成です。<br>そのため、Azure VM の DR 要件に関してはディスクの Azure VM Backup または ASR の利用をご検討いただき、ディスク単位での冗長構成については検討対象から外していただいた方が良いかと存じます。 </p><p>・ローカル冗長ストレージ - ローカル冗長ストレージ<br>　<a href="https://learn.microsoft.com/ja-jp/azure/storage/common/storage-redundancy#locally-redundant-storage">https://learn.microsoft.com/ja-jp/azure/storage/common/storage-redundancy#locally-redundant-storage</a></p><blockquote><p>シナリオで Azure アンマネージド ディスクを使用している場合は、LRS を選択できます。 GRS を使用する Azure アンマネージド ディスクのストレージ アカウントを作成することはできますが、非同期 geo レプリケーションの整合性に関する潜在的な問題のため、お勧めしません。</p></blockquote><p>本記事の内容は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは。Azure VM 、Azure Site Recovery 担当です。&lt;br&gt;今回は Azure のリージョン障害などを想定した Azure VM の Disaster Recovery (DR) 対策を検討中のお</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>Azure Backup におけるウイルス除外設定について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/AV_ExcludeSetting/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/AV_ExcludeSetting/</id>
    <published>2023-08-04T03:00:00.000Z</published>
    <updated>2023-10-30T10:53:16.243Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートの山本です。<br>今回はお問い合わせをいただくことが多い、 <strong>Azure Backup を利用する際のウイルス検知の除外設定</strong>  について、Azure VM Backup と MARS バックアップの場合それぞれについてご説明させていただきます。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Azure VM Backup の場合のウイルス検知除外設定</a><br> <a href="#1-1">1-1. Windows OS の場合</a><br> <a href="#1-2">1-2. Linux OS の場合</a><br><a href="#2">2. MARS バックアップの場合のウイルス検知除外設定</a></p><hr><h2 id="1-Azure-VM-Backup-の場合のウイルス検知除外設定"><a href="#1-Azure-VM-Backup-の場合のウイルス検知除外設定" class="headerlink" title="1. Azure VM Backup の場合のウイルス検知除外設定"></a>1. Azure VM Backup の場合のウイルス検知除外設定<a id="1"></a></h2><p>Azure VM Backup とは Azure 上の VM に対するバックアップサービスです。<br>・Azure VM バックアップの概要<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction</a></p><p>Windows OS と Linux OS に場合分けしてお伝えします。</p><h3 id="1-1-Windows-OS-の場合"><a href="#1-1-Windows-OS-の場合" class="headerlink" title="1-1. Windows OS の場合"></a>1-1. Windows OS の場合<a id="1-1"></a></h3><p>Windows OS の場合、下記をアンチウイルス ソフトの除外設定にいれてください。</p><blockquote><p>C:\Packages\Plugins\Microsoft.Azure.RecoveryServices.VMSnapshot<br>C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.RecoveryServices.VMSnapshot</p></blockquote><p>なお、上記は下記の公式ドキュメントにも記載されております。<br>・Azure Backup の失敗のトラブルシューティング:エージェント/拡張機能に関する問題 - 手順 4:Azure Backup VM 拡張機能の正常性を確認する<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout#step-4-check-azure-backup-extension-health">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-troubleshoot-vm-backup-fails-snapshot-timeout#step-4-check-azure-backup-extension-health</a></p><p>・VMRestorePointInternalError - VM で構成されているウイルス対策により、バックアップ拡張機能の実行が制限されています<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#vmrestorepointinternalerror---antivirus-configured-in-the-vm-is-restricting-the-execution-of-backup-extension">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#vmrestorepointinternalerror---antivirus-configured-in-the-vm-is-restricting-the-execution-of-backup-extension</a></p><h3 id="1-2-Linux-OS-の場合"><a href="#1-2-Linux-OS-の場合" class="headerlink" title="1-2. Linux OS の場合"></a>1-2. Linux OS の場合<a id="1-2"></a></h3><p>Linux OS の場合、下記をアンチウイルス ソフトの除外設定にいれてください。</p><blockquote><p>/var/lib/waagent/WALinuxAgent<br>/var/lib/waagent/Microsoft.Azure.RecoveryServices.VMSnapshotLinux</p></blockquote><h3 id="2-MARS-バックアップの場合のウイルス検知除外設定"><a href="#2-MARS-バックアップの場合のウイルス検知除外設定" class="headerlink" title="2 .MARS バックアップの場合のウイルス検知除外設定"></a>2 .MARS バックアップの場合のウイルス検知除外設定<a id="2"></a></h3><p>MARS バックアップ (Azure MARS Backup エージェントを利用したバックアップ) とはクラウドかオンプレミス環境かを問わず、Windows OS において、ファイルとフォルダー単位のバックアップやシステム状態のバックアップを 取得し Azure 上に保存するバックアップサービスです。</p><p>・Microsoft Azure Recovery Services (MARS) エージェントを使用したバックアップのサポート マトリックス<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mars-agent">https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-mars-agent</a></p><p>MARS バックアップをお使いの場合、下記をアンチウイルス ソフトの除外設定にいれてください。</p><blockquote><p>C:\Program Files\Microsoft Azure Recovery Services Agent\bin\cbengine.exe (プロセスとして除外)<br>C:\Program Files\Microsoft Azure Recovery Services Agent\<br>スクラッチ場所 (標準的の場所を使用していない場合)</p></blockquote><p>なお、上記は下記の公式ドキュメントにも記載されております。<br>・Azure Backup でファイルとフォルダーのバックアップが遅い場合のトラブルシューティング - 原因: Azure Backup の妨げになっている別のプロセスまたはウイルス対策ソフトウェア<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-troubleshoot-slow-backup-performance-issue#cause-another-process-or-antivirus-software-interfering-with-azure-backup">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-troubleshoot-slow-backup-performance-issue#cause-another-process-or-antivirus-software-interfering-with-azure-backup</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートの山本です。&lt;br&gt;今回はお問い合わせをいただくことが多い、 &lt;strong&gt;Azure Backup を利用する際のウイルス検知の除外設定&lt;/strong&gt;  について、Az</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>ドメインに参加しているVMのAzure VM Backupリストアについて</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/ActiveDirectory_backup/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/ActiveDirectory_backup/</id>
    <published>2023-08-04T03:00:00.000Z</published>
    <updated>2023-10-30T10:53:16.247Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>みなさんこんにちは、Azure Backup サポートです。<br>今回は、Active Directory ( 以下、AD ) のドメインに参加している Azure 仮想マシンを、Azure VM Backup にて保護する場合に、よくお問い合わせいただく内容についてご案内いたします。</p><h4 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h4><p>Azure VM Backupにて保護することを前提とすると、「ドメインに参加している Azure 仮想マシンを、Azure VM Backup にてバックアップ・リストアする場合の考慮事項」というのは特にございません。<br>ただし、リストア (=復元) 後は Active Directory の観点で、環境に合わせた考慮事項が発生いたします。<br>Widnows OS 上の作業詳細についてご不明点がございます場合は、恐縮ながら Azure Backup チームではなく、 Active Directory を取り扱う部署にて対応いたしております。<br>Active Directory 観点でのサポートについては、お客様の契約次第ではオンプレミス チームでの有償対応が必要となることがございます。<br>また、お客様のご契約が Azure 製品のサポート契約のみの場合は、オンプレミス範囲のサポート契約がないために、詳細なサポート対応・調査が行えない可能性がございます。<br>お客様にてご契約内容をご確認の上で、「復元」ジョブ完了後の Active Directory 観点の考慮点・作業詳細については、Windows OS - Active Directory 向けへお問い合わせを起票いただきますよう、よろしくお願い申し上げます。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#Q1">Q1. ドメインに参加している Azure 仮想マシンを、Azure VM Backup にてバックアップ・リストアする場合の考慮事項はありますか？</a><br><a href="#Q2">Q2. 「復元」ジョブ完了後は、ドメインの再参加は必要ですか？</a><br><a href="#Q3">Q3. ドメインに参加している Azure 仮想マシンを、Azure VM Backup にてバックアップ・リストアする場合、「復元」後は ドメイン ID は変わってしまいますか？</a><br><a href="#Q4">Q4. ドメイン コントローラー ( = DC ) 自体の Azure VM Backup におけるバックアップ・復元について詳細を教えてください</a><br><a href="#Q5">Q5. ドメイン内のひとつの ドメイン コントローラーを復元する場合、何らかの考慮が必要になりますか？</a><br><a href="#Q6">Q6. ドメイン内のすべての ドメイン コントローラーを復元する場合、何らかの考慮が必要になりますか？</a><br><a href="#Q7">Q7. Azure AD Connect (=AADC) をインストールして使用している Azure 仮想マシンがあります。AADC の復旧手順を教えてください。</a></p><hr><h2 id="Q1-ドメインに参加している-Azure-仮想マシンを、Azure-VM-Backup-にてバックアップ・リストアする場合の考慮事項はありますか？"><a href="#Q1-ドメインに参加している-Azure-仮想マシンを、Azure-VM-Backup-にてバックアップ・リストアする場合の考慮事項はありますか？" class="headerlink" title="Q1. ドメインに参加している Azure 仮想マシンを、Azure VM Backup にてバックアップ・リストアする場合の考慮事項はありますか？"></a><a id="Q1"></a>Q1. ドメインに参加している Azure 仮想マシンを、Azure VM Backup にてバックアップ・リストアする場合の考慮事項はありますか？</h2><h4 id="「構成の復元：新規作成」「構成の復元：既存を置換」など、どの復元オプションで復元すべきですか？"><a href="#「構成の復元：新規作成」「構成の復元：既存を置換」など、どの復元オプションで復元すべきですか？" class="headerlink" title="「構成の復元：新規作成」「構成の復元：既存を置換」など、どの復元オプションで復元すべきですか？"></a>「構成の復元：新規作成」「構成の復元：既存を置換」など、どの復元オプションで復元すべきですか？</h4><p><strong>A1</strong> Azure VM Backupにて保護することを前提とすると、「バックアップ取得する際」「復元時」について、Azure Backup 観点では特に注意点、考慮事項はございません。<br>復元オプションには以下いずれかを選択いただいて構いませんので、お客様のご要件に従って決定ください。<br>（復元オプション）<br>・「構成の復元：新規作成」「復元の種類：新しい仮想マシンの作成」<br>・「構成の復元：新規作成」「復元の種類：ディスクの復元」<br>・「構成の復元：既存を置換」「復元の種類：ディスクの置換」</p><p>・Azure portal で Azure VM データを復元する方法<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-vms-with-special-configurations">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-vms-with-special-configurations</a></p><p>ただし、〈前提〉に記載の通り、「復元」ジョブ完了後の Windows OS 上での作業詳細や考慮事項については、Azure サポートではなく、Windows OS - Active Directory 向けへお問い合わせを起票いただきますよう、よろしくお願い申し上げます。</p><h5 id="「復元の種類：新しい仮想マシンの作成」にて復元する場合の考慮点"><a href="#「復元の種類：新しい仮想マシンの作成」にて復元する場合の考慮点" class="headerlink" title="「復元の種類：新しい仮想マシンの作成」にて復元する場合の考慮点"></a>「復元の種類：新しい仮想マシンの作成」にて復元する場合の考慮点</h5><p>この場合、復元される Azure 仮想マシンのホスト名や、SID識別子は復元もとと同一となります。<br>SID 識別子やユーザ固有の情報が重複する為、同一のネットワーク上に「復元の種類：新しい仮想マシンの作成」での復元を行った場合、なんらかの問題が起こる可能性、懸念が考えられます。<br>そのため、復元もとの Azure 仮想マシンが破損などにより起動できない状態などでの復元シナリオでは、重複トラブルは避けられますが、それ以外の目的で復元する場合は、この状態を避けるため、通常は一般化の上利用いただく必要がございます。</p><p>一般化に関しては下記ブログ記事をご覧のうえ、下記の詳細については、新規サービスリクエストを起票の上、Azure VM 担当部署までご相談いただくようお願いいたします。<br>・VM 複製方法について part.1/3 2 つの方法の紹介<br>　<a href="https://jpaztech.github.io/blog/vm/vm-replica-1/">https://jpaztech.github.io/blog/vm/vm-replica-1/</a></p><p>また、「復元の種類：新しい仮想マシンの作成」にて復元した場合は、デフォルトで NIC が新たに作成される点に関するブログ記事を公開しておりますので、下記ご参考になれば幸いです。<br>・Azure VM のリストアの際 NIC の設定が消えてしまう | Japan CSS ABRS &amp; SCEM Support Blog (jpabrs-scem.github.io)<br>　<a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/VMRestoring_NIC_Configuration/">https://jpabrs-scem.github.io/blog/AzureVMBackup/VMRestoring_NIC_Configuration/</a></p><h5 id="「復元の種類：新しい仮想マシンの作成」かつ、復元した-Azure-仮想マシンはネットワーク的に元の環境と疎通がとれる場合"><a href="#「復元の種類：新しい仮想マシンの作成」かつ、復元した-Azure-仮想マシンはネットワーク的に元の環境と疎通がとれる場合" class="headerlink" title="「復元の種類：新しい仮想マシンの作成」かつ、復元した Azure 仮想マシンはネットワーク的に元の環境と疎通がとれる場合"></a>「復元の種類：新しい仮想マシンの作成」かつ、復元した Azure 仮想マシンはネットワーク的に元の環境と疎通がとれる場合</h5><p>「復元」指示時に、Azure 仮想マシン名を復元もと とは異なる名前にしていても、ホスト名・SID は復元もと と同一ですので、既存ドメインのドメインアカウントを有した状態で、ドメイン上に戻されることとなります。<br>仮に復元時、復元もとの Azure 仮想マシンも「実行中」の状態で、「復元」してしまうと、ドメイン上に戻される＆同一のホスト/ SID 名のマシンがドメインネットワーク内に 2 つ存在することとなるため、予期せぬトラブルを招く恐れがあるかと存じます。<br>同一のドメインネットワーク上に「復元」を希望される場合は、一度 ネットワーク 的に分離された環境でリストアしていただき、一般化  ( AD 観点では少なくともホスト名の変更 ) を した上で元のネットワークに参加させる、もとのVM を停止した状態にするなどの方法が考えられます。</p><h5 id="「復元の種類：新しい仮想マシンの作成」にて復元、かつ、復元した-Azure-仮想マシンはネットワーク的に元の環境と疎通ができない場合"><a href="#「復元の種類：新しい仮想マシンの作成」にて復元、かつ、復元した-Azure-仮想マシンはネットワーク的に元の環境と疎通ができない場合" class="headerlink" title="「復元の種類：新しい仮想マシンの作成」にて復元、かつ、復元した Azure 仮想マシンはネットワーク的に元の環境と疎通ができない場合"></a>「復元の種類：新しい仮想マシンの作成」にて復元、かつ、復元した Azure 仮想マシンはネットワーク的に元の環境と疎通ができない場合</h5><p>既存ドメインのドメインアカウントを有した状態にて復元されますが、ネットワークが異なることによってドメイン コントローラーとの疎通ができないため、同じドメイン上には戻されません。</p><h5 id="「復元の種類：ディスクの置換」の場合"><a href="#「復元の種類：ディスクの置換」の場合" class="headerlink" title="「復元の種類：ディスクの置換」の場合"></a>「復元の種類：ディスクの置換」の場合</h5><p>IP アドレスや NSG の設定は、「復元」ジョブ指示前と同じものを利用できます。<br>また、可用性セットを設定していた場合も、再び可用性セットの構成を利用することが可能です。</p><h2 id="Q2-「復元」ジョブ完了後は、ドメインの再参加は必要ですか？"><a href="#Q2-「復元」ジョブ完了後は、ドメインの再参加は必要ですか？" class="headerlink" title="Q2. 「復元」ジョブ完了後は、ドメインの再参加は必要ですか？"></a><a id="Q2"></a>Q2. 「復元」ジョブ完了後は、ドメインの再参加は必要ですか？</h2><p><strong>A2</strong>  下記ドキュメントの通り、復元によってセキュア チャネルが破損する可能性もございますので、基本的には再度ドメイン参加を実施ください。<br>・ドメインにログオンできない ～ セキュア チャネルの破損 ～ | Microsoft Docs<br>　<a href="https://learn.microsoft.com/en-us/archive/blogs/jpntsblog/256">https://learn.microsoft.com/en-us/archive/blogs/jpntsblog/256</a></p><h2 id="Q3-ドメインに参加している-Azure-仮想マシンを、Azure-VM-Backup-にてバックアップ・リストアする場合、「復元」後は-ドメイン-ID-は変わってしまいますか？"><a href="#Q3-ドメインに参加している-Azure-仮想マシンを、Azure-VM-Backup-にてバックアップ・リストアする場合、「復元」後は-ドメイン-ID-は変わってしまいますか？" class="headerlink" title="Q3. ドメインに参加している Azure 仮想マシンを、Azure VM Backup にてバックアップ・リストアする場合、「復元」後は ドメイン ID は変わってしまいますか？"></a><a id="Q3"></a>Q3. ドメインに参加している Azure 仮想マシンを、Azure VM Backup にてバックアップ・リストアする場合、「復元」後は ドメイン ID は変わってしまいますか？</h2><p><strong>A3</strong> 「復元」を指示する際に、ユーザーにて選択した「復元ポイント」時点のドメイン ID にて復元されます。<br><img src="https://user-images.githubusercontent.com/96324317/204124178-ccfee87e-1cf2-4de9-8cb9-4a1053847bf9.png" alt="RestoreVM"></p><h2 id="Q4-ドメイン-コントローラー-DC-自体の-Azure-VM-Backup-におけるバックアップ・復元について詳細を教えてください"><a href="#Q4-ドメイン-コントローラー-DC-自体の-Azure-VM-Backup-におけるバックアップ・復元について詳細を教えてください" class="headerlink" title="Q4. ドメイン コントローラー ( = DC ) 自体の Azure VM Backup におけるバックアップ・復元について詳細を教えてください"></a><a id="Q4"></a>Q4. ドメイン コントローラー ( = DC ) 自体の Azure VM Backup におけるバックアップ・復元について詳細を教えてください</h2><p><strong>A4</strong> 詳細は下記公開ドキュメントに取りまとめていますので、こちらをご参照ください。<br>・Active Directory ドメイン コントローラーのバックアップおよび復元<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/active-directory-backup-restore">https://learn.microsoft.com/ja-jp/azure/backup/active-directory-backup-restore</a></p><h2 id="Q5-ドメイン内のひとつの-ドメイン-コントローラーを復元する場合、何らかの考慮が必要になりますか？"><a href="#Q5-ドメイン内のひとつの-ドメイン-コントローラーを復元する場合、何らかの考慮が必要になりますか？" class="headerlink" title="Q5. ドメイン内のひとつの ドメイン コントローラーを復元する場合、何らかの考慮が必要になりますか？"></a><a id="Q5"></a>Q5. ドメイン内のひとつの ドメイン コントローラーを復元する場合、何らかの考慮が必要になりますか？</h2><p><strong>A5</strong> ドメイン内に生存している DC が存在している場合、ひとつの DC を復元する方法に配慮は不要です。<br>例えば同一ドメイン内に DC が 2 台存在する構成の場合には、片方の DC だけ障害が発生する分には Azure Portal からの復元を実施できます。</p><h2 id="Q6-ドメイン内のすべての-ドメイン-コントローラーを復元する場合、何らかの考慮が必要になりますか？"><a href="#Q6-ドメイン内のすべての-ドメイン-コントローラーを復元する場合、何らかの考慮が必要になりますか？" class="headerlink" title="Q6. ドメイン内のすべての ドメイン コントローラーを復元する場合、何らかの考慮が必要になりますか？"></a><a id="Q6"></a>Q6. ドメイン内のすべての ドメイン コントローラーを復元する場合、何らかの考慮が必要になりますか？</h2><p><strong>A6</strong> 考慮が必要です。<br>下記は必要な作業として記載しておりますが、その他に必要な作業は、お客様の環境によって異なってまいりますので、お手数をおかけしますが Azure サポートではなく、Windows OS - Active Directory 向けへお問い合わせを起票いただきますよう、よろしくお願い申し上げます。<br>===<br>すべての DC を復元する場合、グループ ポリシー オブジェクトに関する情報が格納されている SYSVOL 共有の複製において、SYSVOL 共有の　“親” を定義する必要がございます。<br>生存した DC が存在する場合は、生存した DC が自動的に “親” となりますが、すべての DC を復元した場合は、すべての DC が “子” として復元されるため、明示的に “親” を定義する作業が必要になります。<br>簡単ではございますが、手順を作成いたしましたので、ご案内させていただきます。</p><h5 id="留意事項"><a href="#留意事項" class="headerlink" title="留意事項"></a>留意事項</h5><p>最初の DC を Azure VM Backup から復元した後に、SYSVOL を複製しているオブジェクトを<br>編集することによって、SYSVOL のマスターを定義する必要があります。<br>なお、SYSVOL 複製方式は、一般的である DFSR を使用していることを前提とします。</p><h5 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順</h5><ol><li>1 台目のドメイン コントローラーをバックアップから復元します。</li><li>1 台目のドメイン コントローラー上で DFSR の Authoritative Restore を実施します。</li><li>2 台目以降のドメイン コントローラーをバックアップから復元します。<br>ここで、上記の手順 2) の DFSR の Authoritative Restore に関しては、具体的に下記のような手順を実施します。</li></ol><h5 id="DFSR-の-Authoritative-Restore"><a href="#DFSR-の-Authoritative-Restore" class="headerlink" title="DFSR の Authoritative Restore"></a>DFSR の Authoritative Restore</h5><ol><li>対象のドメイン コントローラーに、管理者権限を持つユーザーでログオンします。</li><li>[ファイル名を指定して実行] から dsa.msc を実行します。</li><li>[表示] メニューの [コンテナーとしてのユーザー、連絡先、グループ、コンピューター] および [拡張機能] をオンにします。</li><li>左ペインのツリーを [Active Directory ユーザーとコンピューター] - [&lt;ドメイン名&gt;] - [Domain Controllers] – [&lt;リストアを実施したドメイン コントローラー&gt;] - [DFSR-LocalSettings] - [Domain System Volume] の順に展開します。</li><li>右ペインの [SYSVOL Subscriptions] を右クリックし、[プロパティ] をクリックします。</li><li>[属性エディター] タブの [属性] 列が [msDFSR-Options] となっている行をダブルクリックします。</li><li>[値] に 1 と入力し、[OK] をクリックします。</li><li>[OK] をクリックします。</li><li>[管理者として実行] からコマンド プロンプトを起動します。</li><li>下記のコマンドを実行し、DFS Replication サービスを再起動します。<br>net stop dfsr &amp;&amp; net start dfsr</li></ol><p>・AD フォレストの回復-DFSR によってレプリケートされた SYSVOL の権限のある同期を実行する<br>　<a href="https://learn.microsoft.com/ja-jp/windows-server/identity/ad-ds/manage/forest-recovery-guide/ad-forest-recovery-authoritative-recovery-sysvol">https://learn.microsoft.com/ja-jp/windows-server/identity/ad-ds/manage/forest-recovery-guide/ad-forest-recovery-authoritative-recovery-sysvol</a></p><h2 id="Q7-Azure-AD-Connect-AADC-をインストールして使用している-Azure-仮想マシンがあります。AADC-の復旧手順を教えてください。"><a href="#Q7-Azure-AD-Connect-AADC-をインストールして使用している-Azure-仮想マシンがあります。AADC-の復旧手順を教えてください。" class="headerlink" title="Q7. Azure AD Connect (=AADC) をインストールして使用している Azure 仮想マシンがあります。AADC の復旧手順を教えてください。"></a><a id="Q7"></a>Q7. Azure AD Connect (=AADC) をインストールして使用している Azure 仮想マシンがあります。AADC の復旧手順を教えてください。</h2><p><strong>A7</strong> AADC に対しては、「Azure VM Backup」機能を利用したバックアップ・リストアではなく、AADC における Export/Import での再構築が必要となります。<br>AADC に対するバックアップ運用については、下記をご参照ください。</p><p>・Azure AD Connect 設定の Export / Import | Japan Azure Identity Support Blog (jpazureid.github.io)<br>　<a href="https://jpazureid.github.io/blog/azure-active-directory-connect/aadc-import-export-config/">https://jpazureid.github.io/blog/azure-active-directory-connect/aadc-import-export-config/</a></p><p>なお、AADC に対するバックアップ/復旧手順について詳細を確認なされたい場合は、Azure Identity 宛へお問い合わせを起票いただきますよう、よろしくお願い申し上げます。<br>（補足）<br>Azure AD Connect をドメイン コントローラー上にインストールすることは推奨しておりません。</p><p>・Azure AD Connect インストール前の確認事項 | Japan Azure Identity Support Blog (jpazureid.github.io)<br>　<a href="https://jpazureid.github.io/blog/azure-active-directory-connect/checklist-before-installing-aad-connect/#Q-amp-A">https://jpazureid.github.io/blog/azure-active-directory-connect/checklist-before-installing-aad-connect/#Q-amp-A</a><br>　“Q. Azure AD Connect をドメイン コントローラー上にインストールして問題ないか ?<br>　  A. 弊社としては推奨していません。”</p><p>AD 関連の Azure VM Backup について、よくお問い合わせいただく内容の案内としては、以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;みなさんこんにちは、Azure Backup サポートです。&lt;br&gt;今回は、Active Directory ( 以下、AD ) のドメインに参加している Azure 仮想マシンを、Azure VM Backup にて保護する</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup [既存を置換] リストア について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/restore_swapdsik/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/restore_swapdsik/</id>
    <published>2023-07-10T03:00:00.000Z</published>
    <updated>2023-10-30T10:53:16.299Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートです。<br>今回は、Azure VM Backup で　[既存を置換] を用いる場合にいただくご質問について下記の通りご案内いたします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. [既存を置換]の際、元のディスクはどうなるのか</a><br><a href="#2">2. [既存を置換]の際、 バックアップが走る件について</a><br><a href="#2-1">2.1. バックアップを走らせたくない場合の代替案 </a></p><hr><h2 id="1-既存を置換-の際、元のディスクはどうなるのか"><a href="#1-既存を置換-の際、元のディスクはどうなるのか" class="headerlink" title=" 1. [既存を置換]の際、元のディスクはどうなるのか"></a><a id="1"></a> 1. [既存を置換]の際、元のディスクはどうなるのか</h2><p>結論から申し上げますと削除されずに残ります。<br>Azure VM Backup のリストアの [既存を置換] はバックアップ データよりディスクを復元し、 Azure VM のディスクを置き換えるまでを行います。<br>そのため、元の古いディスクは削除されずにディスク リソースとして残り続けます (課金も行われます)。そのため、不要な場合は手動で削除いただく必要がございます。</p><p>なお、リストアによって復元されるディスクの命名規則に関しては下記をご覧ください。<br>・Azure VM Backupでリストアされるディスク名に関して<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/About_Restored_Disk/">https://jpabrs-scem.github.io/blog/AzureVMBackup/About_Restored_Disk/</a></p><p>下記公開情報にも記載されております。<br>・既存のものを置き換える - 復元オプション- Azure portal で Azure VM データを復元する方法<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms</a></p><blockquote><p>ディスクの交換操作の後、元のディスクはリソース グループに保持されます。 元のディスクが必要ない場合は、それを手動で削除することを選択できます。</p></blockquote><h2 id="2-既存を置換-の際、-バックアップが走る件について"><a href="#2-既存を置換-の際、-バックアップが走る件について" class="headerlink" title=" 2. [既存を置換]の際、 バックアップが走る件について"></a><a id="2"></a> 2. [既存を置換]の際、 バックアップが走る件について</h2><p>現在の仕様として[既存を置換] のリストアを行う際にディスクを置き換える前の状態のバックアップを取得するために自動でリストアジョブと並行してバックアップ ジョブも実施されます。<br>このバックアップ ジョブを実施させない方法はございません。<br>またそのため、バックアップを無効にしている場合はバックアップ ジョブが失敗するためリストア ジョブも正常に完了しません。</p><p>詳細については下記をご覧ください<br>・Azure VM のリストア (既存を置換) が失敗する<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Restorefail_invalid_protection/">https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Restorefail_invalid_protection/</a></p><h2 id="2-1-バックアップを走らせたくない場合の代替案"><a href="#2-1-バックアップを走らせたくない場合の代替案" class="headerlink" title=" 2.1. バックアップを走らせたくない場合の代替案"></a><a id="2-1"></a> 2.1. バックアップを走らせたくない場合の代替案</h2><p>なお、上記の自動で走るバックアップ ジョブを走らせたくない場合は [既存を置換] ではなく、[ディスクの復元] を実施いただき、復元したディスクを手動で Azure VM に対してスワップしていただくことが可能です。</p><p>Azure Portal ＞ 対象の仮想マシン ＞ 左ペインのディスク からディスクのスワップ、デタッチ＆アタッチ が可能です。<br>※　本作業を行った場合も、元々アタッチされていた OS ディスク・ データ ディスクはディスク リソースとして残り続けます。<br>　　ディスクのスワップ・デタッチ＆アタッチ後、元々アタッチされていた OS ディスク・ データ ディスクに対しては、お客様にて不要であれば削除いただけます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートです。&lt;br&gt;今回は、Azure VM Backup で　[既存を置換] を用いる場合にいただくご質問について下記の通りご案内いたします。&lt;/p&gt;
&lt;h2 id=&quot;目次&quot;&gt;&lt;a</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>「Azure Monitor を使用した組み込みのアラート」を利用したバックアップ ジョブ失敗のアラート通知作成例</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/How_to_set_Backup_Alert/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/How_to_set_Backup_Alert/</id>
    <published>2023-06-30T03:00:00.000Z</published>
    <updated>2023-10-30T10:53:16.215Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、<strong>「Azure Monitor を使用した組み込みのアラート」を利用して、Recovery Services コンテナーにてバックアップ構成済のバックアップ ジョブが失敗した際にメール通知を出すよう、アラート処理ルールを作成する例</strong> をご紹介します。</p><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><ul><li><p>Azure Backup にてこれまで存在していた「クラシック アラート」は、今後廃止される見込みです</p></li><li><p>お客様にて「バックアップ ジョブ失敗のアラートを発生させたい」「発生したアラートをメール通知したい」といった場合<br>　今後は「クラシック アラート」ではなく<br>　「Azure Monitor を使用した組み込みのアラート」を利用してアラートを構成いただく必要があります</p></li><li><p>作成概要は公開ドキュメントでも説明しております<br>　・ジョブの失敗のシナリオに対して Azure Monitor のアラートを有効にする<br>　　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults#turning-on-azure-monitor-alerts-for-job-failure-scenarios">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults#turning-on-azure-monitor-alerts-for-job-failure-scenarios</a></p></li><li><p>アラート処理ルールの作成例として、今回はバックアップを構成している対象のRecovery Services コンテナーをスコープとして指定し、バックアップ ジョブが失敗した際に、指定のメールアドレスへ通知メールを送信させます</p></li></ul><h2 id="アラート処理ルール-作成手順"><a href="#アラート処理ルール-作成手順" class="headerlink" title="アラート処理ルール 作成手順"></a>アラート処理ルール 作成手順</h2><p>Azure Backup にて、バックアップ ジョブが失敗した際にアラート通知を出す手段は、下記ドキュメントの通り複数種類ございます。<br>今回は「Azure Backup ジョブの失敗を検知したい」という要件である前提で、 <strong>「Azure Monitor を使用した組み込みのアラート」</strong> を利用します。<br>・Azure Backup の監視とレポートのソリューション<br><a href="https://docs.microsoft.com/ja-jp/azure/backup/monitoring-and-alerts-overview#monitoring-and-reporting-scenarios">https://docs.microsoft.com/ja-jp/azure/backup/monitoring-and-alerts-overview#monitoring-and-reporting-scenarios</a></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/5ca76af3-d9f4-419f-80f8-3f6812b63764"></p><p>作成手順の公開ドキュメントは下記ですので、基本的に下記ドキュメントの説明に従って設定いただければアラート構成・通知構成が可能です。<br>・ジョブの失敗のシナリオに対して Azure Monitor のアラートを有効にする<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor#turning-on-azure-monitor-alerts-for-job-failure-scenarios">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor#turning-on-azure-monitor-alerts-for-job-failure-scenarios</a></p><h3 id="Azure-Monitor-を使用した組み込みのアラート構成-作業例"><a href="#Azure-Monitor-を使用した組み込みのアラート構成-作業例" class="headerlink" title="Azure Monitor を使用した組み込みのアラート構成　作業例"></a>Azure Monitor を使用した組み込みのアラート構成　作業例</h3><p>Recovery Services コンテナー上でアラートを有効化します。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/e914c143-5391-43da-aea4-ce80006221fd"></p><p>有効化することで、バックアップ ジョブが失敗した場合などに、アラートが生成されます。</p><p>・Azure portal 内で始動したアラートを確認<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults#viewing-fired-alerts-in-the-azure-portal">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults#viewing-fired-alerts-in-the-azure-portal</a></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/42c3d590-7452-456d-ae3e-4cde1a8803e4"></p><p>バックアップ センター ＞ アラート処理ルール にて、新しいアラート処理ルールを作成することができます。</p><p>・アラートの通知を構成する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults#configuring-notifications-for-alerts">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults#configuring-notifications-for-alerts</a></p><p><img src="https://user-images.githubusercontent.com/96324317/205475247-3c6c2195-4eac-4d0e-b1b7-91ca7b8f6f83.png"></p><p><img src="https://user-images.githubusercontent.com/96324317/205475279-c6bbffff-1b22-482f-9052-478362ba48b4.png"></p><p>今回は、Recovery Services コンテナー「RSV-JPE-LRS」にてバックアップ構成しているため、スコープを「Recovery Services コンテナー：RSV-JPE-LRS」としています。</p><p><img src="https://user-images.githubusercontent.com/71251920/151009992-071f529c-b069-4e95-b579-57e41d858db5.png"></p><p>また、バックアップ ジョブのエラーを検知した際にアラート通知を発報したいため、「フィルター：重要度」とし、「階層：１ - エラー」を選択します。<br>・Azure Backup で保護されたワークロードの監視<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor#azure-monitor-alerts-for-azure-backup-preview">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor#azure-monitor-alerts-for-azure-backup-preview</a></p><p><img src="https://user-images.githubusercontent.com/71251920/151009994-805f0f47-4085-4c6b-b1e0-5453f242f62f.png"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/afd34bb8-ccd9-458f-bc03-3b1f85fa85ef"></p><p>「アクション グループ」には、送信したいメールアドレスを設定しているアクション グループを追加する、もしくは新規作成します。<br>今回はあらかじめ作成済のアクション グループを選択しています。</p><p><img src="https://user-images.githubusercontent.com/71251920/151010003-78799d24-3c6a-4ff6-a8ff-39c7c7c95e90.png"></p><p> （補足）アクショングループには、下図のように電子メールへの通知を設定済となっています。</p><p><img src="https://user-images.githubusercontent.com/71251920/151010005-e0d96c25-d7cc-4789-9b1e-6be5458b86f6.png"></p><p><img src="https://user-images.githubusercontent.com/71251920/151010009-0b53d0c3-1d15-4902-9059-ad96f54cb6e6.png"></p><p><img src="https://user-images.githubusercontent.com/71251920/151010014-e76647b0-3eb5-4cc8-8558-b38636996f48.png"></p><p>アクション グループも有効化されていることを確認しておきます。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/7dfc8bb6-bf41-4135-a194-17a4063c3839"></p><p>上図のように設定することで、Recovery Services コンテナー「RSV-JPE-LRS」にてバックアップ構成済のバックアップ ジョブが失敗した際に、指定した電子メール宛先へ、通知メールが送信されるようになります。</p><p><img src="https://user-images.githubusercontent.com/71251920/151009979-8f6868a8-2edd-4d08-86a5-ef843a877bda.png"></p><p> （補足）Azure Backup を意図的に失敗させる手順は下記をご参照ください。</p><p>・Azure VM Backup を意図的に失敗させる方法 | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br>　<a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/">https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/</a></p><p>・Azure VM Backup のデータ転送フェーズを意図的に失敗させる方法 | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br>　<a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_ttv/">https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_ttv/</a></p><p>・MARS バックアップ を意図的に失敗させる方法 | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br>　<a href="https://jpabrs-scem.github.io/blog/MARSBackup/How_to_fail_MARS_backup/">https://jpabrs-scem.github.io/blog/MARSBackup/How_to_fail_MARS_backup/</a></p><p>・Azure Files Backup を意図的に失敗させる方法 | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br>　<a href="https://jpabrs-scem.github.io/blog/AzureFilesBackup/How_to_fail_AFS_backup/">https://jpabrs-scem.github.io/blog/AzureFilesBackup/How_to_fail_AFS_backup/</a></p><p>・Azure Disk Backup を意図的に失敗させる方法 | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br>　<a href="https://jpabrs-scem.github.io/blog/AzureDiskBackup/How_to_fail_Asure_Disk_backup/">https://jpabrs-scem.github.io/blog/AzureDiskBackup/How_to_fail_Asure_Disk_backup/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、&lt;strong&gt;「Azure Monitor を使用した組み込みのアラート」を利用して、Recovery Services コンテナーにてバックアップ構成</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>MARS バックアップ を意図的に失敗させる方法</title>
    <link href="https://jpabrs-scem.github.io/blog/MARSBackup/How_to_fail_MARS_backup/"/>
    <id>https://jpabrs-scem.github.io/blog/MARSBackup/How_to_fail_MARS_backup/</id>
    <published>2023-06-30T03:00:00.000Z</published>
    <updated>2023-10-30T10:53:16.299Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートの 山本 です。<br>アラートのテスト等のため “Azure MARS Backup エージェントを利用したバックアップ (以下 MARS バックアップ) を失敗させたい” というお問い合わせをよくいただきます。<br>今回は、<strong>MARS バックアップ を意図的に失敗させる方法</strong>について、ご案内いたします。</p><h3 id="意図的に-MARS-バックアップ-エラーを発生させる仕組み"><a href="#意図的に-MARS-バックアップ-エラーを発生させる仕組み" class="headerlink" title="意図的に MARS バックアップ エラーを発生させる仕組み"></a>意図的に MARS バックアップ エラーを発生させる仕組み</h3><p>バックアップ対象にフォルダを指定し、バックアップ ポリシーを設定した後、対象のフォルダ名を変更します。<br>そうすることでバックアップ対象のフォルダがない為にバックアップ ジョブを失敗させます。</p><h3 id="MARS-バックアップ-を失敗させる方法-手順"><a href="#MARS-バックアップ-を失敗させる方法-手順" class="headerlink" title="MARS バックアップ を失敗させる方法(手順)"></a>MARS バックアップ を失敗させる方法(手順)</h3><ul><li>以下は MARS エージェントがインストールされているマシン上での作業となります。</li></ul><h4 id="1-MARSエージェントのスケジュール-バックアップ設定よりテスト用のフォルダをバックアップ対象として選択し、設定します。"><a href="#1-MARSエージェントのスケジュール-バックアップ設定よりテスト用のフォルダをバックアップ対象として選択し、設定します。" class="headerlink" title="1. MARSエージェントのスケジュール バックアップ設定よりテスト用のフォルダをバックアップ対象として選択し、設定します。"></a>1. MARSエージェントのスケジュール バックアップ設定よりテスト用のフォルダをバックアップ対象として選択し、設定します。</h4><p>その他の設定は任意の設定で問題ございません。<br>(画像では Test1 フォルダを対象として選択しています)<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/7d411329-6157-496b-8e20-f4c4d6d405e7"></p><h4 id="2-上記でバックアップ対象としたフォルダ名を変更します。"><a href="#2-上記でバックアップ対象としたフォルダ名を変更します。" class="headerlink" title="2. 上記でバックアップ対象としたフォルダ名を変更します。"></a>2. 上記でバックアップ対象としたフォルダ名を変更します。</h4><p>(画像では Test1 フォルダを Test1<span style="color: red; ">Test1</span> フォルダと変更しました)<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/637e0e84-bb2f-4c06-b5a0-fb121e1d51bc"></p><h4 id="3-今すぐバックアップを実行します。"><a href="#3-今すぐバックアップを実行します。" class="headerlink" title="3. 今すぐバックアップを実行します。"></a>3. 今すぐバックアップを実行します。</h4><p>バックアップ期間は任意の期間で問題ありません。<br>確認画面にて、手順 1 で設定した名前変更前のフォルダが指定されてることを確認し、バックアップを実施してください。</p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/541354a9-8367-44d3-8672-7cec4c8a7b6c"></p><h4 id="4-バックアップの失敗のメッセージが現れることを確認してください。"><a href="#4-バックアップの失敗のメッセージが現れることを確認してください。" class="headerlink" title="4. バックアップの失敗のメッセージが現れることを確認してください。"></a>4. バックアップの失敗のメッセージが現れることを確認してください。</h4><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/9c74ce5b-b778-4976-a07c-0c917e10f939"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/1b09c4c6-3a9d-460f-abfd-f330215e834d"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/c079b915-e93d-46a9-8e55-3d49773e76cf"></p><h3 id="Azure-Monitor-を使用した組み込みのアラート-メール通知例"><a href="#Azure-Monitor-を使用した組み込みのアラート-メール通知例" class="headerlink" title="Azure Monitor を使用した組み込みのアラート メール通知例"></a>Azure Monitor を使用した組み込みのアラート メール通知例</h3><p>MARS バックアップを構成している Recovery Services コンテナーをスコープに含めた Azure Monitor を使用した組み込みのアラートを構成している場合、下図のようなメール通知が発報されます。</p><p>・ジョブの失敗のシナリオに対して Azure Monitor のアラートを有効にする<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults#turning-on-azure-monitor-alerts-for-job-failure-scenarios">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults#turning-on-azure-monitor-alerts-for-job-failure-scenarios</a></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/b2200f28-5b70-42ce-9dd8-12072a03261f"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/69860bc1-ec96-4e26-b2e2-72a000b81e8b"></p><p>以上で MARS バックアップ を意図的に失敗させる方法に関しましてのご説明は終了となります。<br>ぜひお試しいただければと思います。</p><p> （補足）その他の Azure Backup を意図的に失敗させる手順は下記にてご紹介しております。</p><p>・Azure VM Backup を意図的に失敗させる方法 | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br>　<a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/">https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/</a></p><p>・Azure VM Backup のデータ転送フェーズを意図的に失敗させる方法 | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br>　<a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_ttv/">https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_ttv/</a></p><p>・Azure Files Backup を意図的に失敗させる方法 | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br>　<a href="https://jpabrs-scem.github.io/blog/AzureFilesBackup/How_to_fail_AFS_backup/">https://jpabrs-scem.github.io/blog/AzureFilesBackup/How_to_fail_AFS_backup/</a></p><p>・Azure Disk Backup を意図的に失敗させる方法 | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br>　<a href="https://jpabrs-scem.github.io/blog/AzureDiskBackup/How_to_fail_Asure_Disk_backup/">https://jpabrs-scem.github.io/blog/AzureDiskBackup/How_to_fail_Asure_Disk_backup/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートの 山本 です。&lt;br&gt;アラートのテスト等のため “Azure MARS Backup エージェントを利用したバックアップ (以下 MARS バックアップ) を失敗させたい” </summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="MARS Backup" scheme="https://jpabrs-scem.github.io/blog/tags/MARS-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup を意図的に失敗させる方法</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/</id>
    <published>2023-06-22T03:00:00.000Z</published>
    <updated>2023-10-30T10:53:16.247Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートの 相田 です。<br>アラートのテスト等のため “Azure VM Backup を失敗させたい” というお問い合わせをよくいただきます。<br>今回は、<strong>Azure VM Backup を意図的に失敗させる方法</strong>について、ご案内いたします。</p><p>(その他ブログで公開している Azure Backup の失敗方法)<br>・Azure VM Backup のデータ転送フェーズを意図的に失敗させる方法<br>　<a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_ttv/">https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_ttv/</a></p><p>・MARS バックアップ を意図的に失敗させる方法<br>　<a href="https://jpabrs-scem.github.io/blog/MARSBackup/How_to_fail_MARS_backup/">https://jpabrs-scem.github.io/blog/MARSBackup/How_to_fail_MARS_backup/</a></p><p>・Azure Files Backup を意図的に失敗させる方法<br>　<a href="https://jpabrs-scem.github.io/blog/AzureFilesBackup/How_to_fail_AFS_backup/">https://jpabrs-scem.github.io/blog/AzureFilesBackup/How_to_fail_AFS_backup/</a></p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Azure Guest Agent を停止して意図的にAzure VM Backup エラーを発生させる仕組み</a><br><a href="#2">2. Azure Guest Agent を停止してバックアップを故意に失敗させる方法 (手順概略) </a><br><a href="#3">3. バックアップを故意に失敗させる方法 (Windows VM の場合)</a><br>  <a href="#3-1">【補足】 Windows Firewall を用いた方法</a><br><a href="#4">4. バックアップを故意に失敗させる方法 (Linux VM の場合)</a><br><a href="#5">5. バックアップを故意に失敗させる方法 (共有ディスクをアタッチする)</a></p><hr><h2 id="1-Azure-Guest-Agent-を停止して意図的にAzure-VM-Backup-エラーを発生させる仕組み"><a href="#1-Azure-Guest-Agent-を停止して意図的にAzure-VM-Backup-エラーを発生させる仕組み" class="headerlink" title="1. Azure Guest Agent を停止して意図的にAzure VM Backup エラーを発生させる仕組み "></a>1. Azure Guest Agent を停止して意図的にAzure VM Backup エラーを発生させる仕組み <a id="1"></a></h2><p>VM 内の Windows Azure Guest Agent (VM agent) が停止させ、Azure 側の Recovery Services コンテナー (Azure Backup service) との通信ができない状態を作ります。<br>この状態で Backup 取得をしようとすると、VM agent と通信できないためにエラー (Error Code ”UserErrorGuestAgentStatusUnavailable”) が発生し、Backup が失敗となります。<br><img src="https://user-images.githubusercontent.com/71251920/142736316-5995d329-63d1-4b63-acd5-7f3da9f90cf9.png" alt="How_to_Backup_Fail"></p><p>*VM 電源状態 がオンライン状態でなければこの方法は使えません。オフライン状態では成功してしまいます。そのため、必ずオンライン (電源起動) 状態でご実施ください。<br>下記ご参考になれば幸いです。<br>・Azure VM Backup では オフライン バックアップができるのか<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Azure_VM_Offline_backup/">https://jpabrs-scem.github.io/blog/AzureVMBackup/Azure_VM_Offline_backup/</a></p><h2 id="2-Azure-Guest-Agent-を停止してバックアップを故意に失敗させる方法-手順概略"><a href="#2-Azure-Guest-Agent-を停止してバックアップを故意に失敗させる方法-手順概略" class="headerlink" title="2. Azure Guest Agent を停止してバックアップを故意に失敗させる方法 (手順概略) "></a>2. Azure Guest Agent を停止してバックアップを故意に失敗させる方法 (手順概略) <a id="2"></a></h2><p>・「バックアップを故意に失敗させる方法 (Windows VM の場合) 」</p><blockquote><p>   1.Backup 対象の VM にリモート ログイン<br>   2.Services 内で “RdAgent” と “Windows Azure Guest Agent” の停止、スタートアップの無効化<br>   3.Backup を実施し、エラーの確認<br>   4.Agent の再度起動</p></blockquote><p>・「バックアップを故意に失敗させる方法 (Linux VM の場合) 」</p><blockquote><p>   1.Backup 対象の VM に SSH 接続<br>   2.Agent の停止、および自動起動停止<br>   3.Agent の Service を停止<br>   　（Ubuntu の場合）<code> </code> <code>sudo systemctl stop walinuxagent </code> <code> </code><br>   　（Ubuntu 以外の場合）<code> </code> <code>sudo systemctl stop waagent</code> <code> </code><br>   4.自動起動を停止<br>   　（Ubuntu の場合）<code> </code> <code>sudo systemctl disable walinuxagent </code> <code> </code><br>   　（Ubuntu 以外の場合）<code> </code> <code>sudo systemctl disable waagent</code> <code> </code><br>   5.Backup を実行し、エラーの確認<br>   ・Agent の再起動<br>   （Ubuntu の場合）<br>   　　<code> </code> <code>sudo systemctl start walinuxagent </code> <code> </code><br>       　　<code> </code> <code>sudo systemctl enable walinuxagent </code> <code> </code><br>       　　<code> </code> <code>systemctl status walinuxagent </code> <code> </code><br>       （Ubuntu 以外の場合）<br>       　　<code> </code> <code>sudo systemctl start waagent</code> <code> </code><br>       　　<code> </code> <code>sudo systemctl enable waagent</code> <code> </code><br>   　  　<code> </code> <code>systemctl status waagent</code> <code> </code></p></blockquote><h2 id="3-バックアップを故意に失敗させる方法-Windows-VM-の場合-所要時間-2時間～6時間"><a href="#3-バックアップを故意に失敗させる方法-Windows-VM-の場合-所要時間-2時間～6時間" class="headerlink" title="3. バックアップを故意に失敗させる方法 (Windows VM の場合)  (所要時間 : 2時間～6時間)"></a>3. バックアップを故意に失敗させる方法 (Windows VM の場合)  (所要時間 : 2時間～6時間)<a id="3"></a></h2><h3 id="3-1-環境"><a href="#3-1-環境" class="headerlink" title="3.1. 環境"></a>3.1. 環境</h3><p>本項目では以下の環境で検証を実施しております。<br>VM名 : vm-BackupFailTest-win2016<br>OS : Windows (Windows Server 2016 Datacenter) Version 1607<br>Recovery Service コンテナー名 : vault-BackupFailTest<br>VM 電源状態 : オンライン (起動状態)</p><h3 id="3-2-手順概略"><a href="#3-2-手順概略" class="headerlink" title="3.2.手順概略"></a>3.2.手順概略</h3><p>“サービス” から プロセス “RdAgent”、”Windows Azure Guest Agent” を停止し、スタートアップを無効化しバックアップを実行します。<br>バックアップが失敗したらそれぞれをもとに戻します。</p><blockquote><ol><li>Backup 対象の VM にリモート ログイン</li><li>Services 内で “RbAgent” と “Windows Azure Guest Agent” の停止、スタートアップを無効化</li><li>Portal にて Backup を実施し、エラーの確認</li><li>Agent の再起動</li></ol></blockquote><h3 id="3-3-詳細手順"><a href="#3-3-詳細手順" class="headerlink" title="3.3.詳細手順"></a>3.3.詳細手順</h3><p>Backup 対象の VM : Azure portal上で作成した、Backup 対象の VM<br>Backup 対象の VM にリモートログインし、Services を開き、下記 2 つのサービスに対し設定を行います。</p><h4 id="RdAgent"><a href="#RdAgent" class="headerlink" title="RdAgent"></a>RdAgent</h4><p>最初に “RdAgent” を停止、スタートアップ無効にします。<br>・Sercives 一覧の画面で “RdAgent” を右クリック → “Properties” を選択します。<br>・Startup type で “Disabled” を選択 → Service status で Stop を選択 → Service 停止プロセスが完了した後、”OK” を選択します。<br>・Services 一覧の画面にて、 RbAgent の Status の Running が消えており、Startup Type が Disabled 場合、 RbAgent の停止が完了となります。</p><p><img src="https://user-images.githubusercontent.com/71251920/142736495-97875c34-577f-483d-a46e-c1f7c53d5133.png" alt="RdAgent"></p><h4 id="Windows-Azure-Guest-Agent"><a href="#Windows-Azure-Guest-Agent" class="headerlink" title="Windows Azure Guest Agent"></a>Windows Azure Guest Agent</h4><p>次に “Windows Azure Guest Agent” を停止、スタートアップ無効にします。<br>・Sercives 一覧の画面で “Windows Azure Guest Agent” を右クリック → “Properties” を選択します。<br>・Startup type で “Disabled” を選択 → Service status で Stop を選択 → Service 停止プロセスが完了した後、 “OK” を選択します。<br>・Services 一覧の画面にて、 Windows Azure Guest Agent の Status の Running が消えており、Startup Type が Disabled 場合、 Windows Azure Guest Agent の停止が完了となります。</p><p><img src="https://user-images.githubusercontent.com/71251920/142736485-37260305-e959-4d30-ab6d-d2167dc8096c.png" alt="WindowsAzureGuestAgent"></p><p>以上で、VM 側の設定は完了となります。</p><h4 id="Backup-を実施し、エラーの確認"><a href="#Backup-を実施し、エラーの確認" class="headerlink" title="Backup を実施し、エラーの確認"></a>Backup を実施し、エラーの確認</h4><p>・Azure portal を開いていただき、VM のページに移動 → “バックアップ” を選択 → “今すぐパックアップ” を選択。<br>この操作により、バックアップが開始されます。<br>・ 次に Backup の状態を確認します。<br>　Recovery Services コンテナーのページへ移動 → “バックアップ ジョブ” を選択後、最新の Backup の “View details” を選択します。<br>このページで Backup の状態を確認することができます。<br>結果が表示されるまで数時間掛かりますので、 定期的に (1 時間おきなど) 更新して確認することをお勧めいたします。</p><p><img src="https://user-images.githubusercontent.com/71251920/142736544-cc800afd-14c5-400d-9b9c-74d535fdf1f4.png" alt="FailCheck_01"></p><p>・Take Snapshot の Status が Failed 、Error Code <strong>”UserErrorGuestAgentStatusUnavailable”</strong> となり、失敗し完了となります。本環境では 5 時間 25 分かかりました。　</p><p><img src="https://user-images.githubusercontent.com/71251920/142736548-c5cc94e5-4343-4c81-9b8b-52ef8c46f4d8.png" alt="FailCheck_02"></p><h4 id="Agentの再起動"><a href="#Agentの再起動" class="headerlink" title="Agentの再起動"></a>Agentの再起動</h4><p>・エラーの発生確認完了後は、 VM に再度ログインして頂き、各 Agent の Service properties 画面で、Start up type を <strong>“Automatic”</strong> に、Service Status で <strong>“Start”</strong> を選択し、 Agent を再度起動させてください。</p><h2 id="【補足】-Windows-Firewall-を用いた方法"><a href="#【補足】-Windows-Firewall-を用いた方法" class="headerlink" title="【補足】 Windows Firewall を用いた方法 "></a>【補足】 Windows Firewall を用いた方法 <a id="3-1"></a></h2><p>なお、Windows 内部 のローカルファイアウォールから 宛先 168.63.129.16 宛の通信をブロックしていただくことでも同様にエラーを発生させることが可能です。</p><blockquote><p>リモートアドレス (宛先 IP) :  168.63.129.16<br>操作 : ブロック<br>上記以外はすべて 任意 </p></blockquote><p>Windows Server　2016 をご利用の場合は虫眼鏡窓から “Firewall” と検索いただくことで設定可能です。<br><img src="https://user-images.githubusercontent.com/71251920/158552820-74147994-3072-4ee8-ae17-c6b92f9b7e36.png" alt="WindowsFW_01"></p><p>下記例ではすでに、”Block 168.63.129.16” という規則を作成した後の画面ショットです。<br>設定内容は上述の通りでございます。送信の規則 → 新しい規則 から設定ください。<br><img src="https://user-images.githubusercontent.com/71251920/158552815-e3b99fb6-78ec-4c3e-ba4e-616777a25e03.png" alt="WindowsFW_02"></p><p>なお、 168.63.129.16 への通信は特殊な通信のため、NSG では制御することができません。<br>下記ご参考にしてくだされば幸いです。<br>・1. Azure VM Backup の 通信要件について - Azure VM Backup の通信要件や処理の流れについて<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#1">https://jpabrs-scem.github.io/blog/AzureVMBackup/NWRequirementAndProcess/#1</a></p><h2 id="4．バックアップを故意に失敗させる方法-Linux-VM-の場合-所要時間-2時間～6時間"><a href="#4．バックアップを故意に失敗させる方法-Linux-VM-の場合-所要時間-2時間～6時間" class="headerlink" title="4．バックアップを故意に失敗させる方法 (Linux VM の場合) (所要時間 : 2時間～6時間) "></a>4．バックアップを故意に失敗させる方法 (Linux VM の場合) (所要時間 : 2時間～6時間) <a id="4"></a></h2><h3 id="4-1-環境"><a href="#4-1-環境" class="headerlink" title="4.1. 環境"></a>4.1. 環境</h3><p>本項目では以下の環境で検証を実施しております。</p><h4 id="OS"><a href="#OS" class="headerlink" title="OS"></a>OS</h4><blockquote><p>VM名 : vm-BackupFailTest-linux-suse / OS : Linux (sles 15.2)<br>VM 名 : vm-BackupFailTest-linux-rhel / OS : Linux (redhat 8.2)<br>VM 名 : vm-BackupFailTest-linux-ubuntu /OS : Linux (ubuntu 20.04)<br>VM 名 : vm-BackupFailTest-linux-centos / OS : Linux (centos 7.9.2009)</p></blockquote><h4 id="Recovery-Services-コンテナー"><a href="#Recovery-Services-コンテナー" class="headerlink" title="Recovery Services コンテナー"></a>Recovery Services コンテナー</h4><blockquote><p>Recovery Service コンテナー名 : vault-BackupFailTest</p></blockquote><h3 id="4-2-手順概略"><a href="#4-2-手順概略" class="headerlink" title="4.2. 手順概略"></a>4.2. 手順概略</h3><p>下記コマンドを実行しagent プロセスを停止しバックアップを失敗させます。<br>失敗したのを確認したのち、Agent の再起動を行います。</p><h4 id="Agent-の停止"><a href="#Agent-の停止" class="headerlink" title="Agent の停止"></a>Agent の停止</h4><blockquote><p>Backup 対象の VM に SSH 接続します。</p></blockquote><blockquote><p>・以下のコマンドで、 Agent の Service を停止します。<br>（Ubuntu の場合）sudo systemctl stop walinuxagent<br>（Ubuntu 以外の場合）sudo systemctl stop waagent</p></blockquote><blockquote><p>・以下のコマンドで、自動起動を停止します。<br>（Ubuntu の場合）sudo systemctl disable walinuxagent<br>（Ubuntu 以外の場合）sudo systemctl disable waagent</p></blockquote><h4 id="Agent-の再起動"><a href="#Agent-の再起動" class="headerlink" title="Agent の再起動"></a>Agent の再起動</h4><p>バックアップ エラーの検証後は、以下コマンドで waagent を再開します。</p><blockquote><p>（Ubuntu の場合）<br>    sudo systemctl start walinuxagent<br>    sudo systemctl enable walinuxagent<br>    systemctl status walinuxagent<br>（Ubuntu 以外の場合）<br>    sudo systemctl start waagent<br>    sudo systemctl enable waagent<br>    systemctl status waagent</p></blockquote><h3 id="4-3-詳細手順"><a href="#4-3-詳細手順" class="headerlink" title="4.3. 詳細手順"></a>4.3. 詳細手順</h3><p>Linux の場合、 OS により Agent のプロセス名が異なります。</p><h4 id="Agent-プロセス名"><a href="#Agent-プロセス名" class="headerlink" title="Agent プロセス名"></a>Agent プロセス名</h4><p>Ubuntu の場合</p><blockquote><p>walinuxagent.service</p></blockquote><p>Suse &amp; RHEL &amp; CentOS の場合</p><blockquote><p>waagent.service</p></blockquote><p>下記の手順で agentのプロセスを停止し、バックアップを失敗させます。</p><h4 id="Agent-の停止-1"><a href="#Agent-の停止-1" class="headerlink" title="Agent の停止"></a>Agent の停止</h4><p>・Backup 対象の VM に SSH 接続します。</p><blockquote><p>・以下のコマンドで、 Agent の Service を停止します。<br>（Ubuntu の場合）sudo systemctl stop walinuxagent<br>（Ubuntu 以外の場合）sudo systemctl stop waagent</p></blockquote><blockquote><p>・以下のコマンドで、自動起動を停止します。<br>（Ubuntu の場合）sudo systemctl disable walinuxagent<br>（Ubuntu 以外の場合）sudo systemctl disable waagent</p></blockquote><blockquote><p>・以下のコマンドで、 Agent の Service の状態を確認できます。<br>（Ubuntu の場合）systemctl status walinuxagent<br>（Ubuntu 以外の場合）systemctl status waagent</p></blockquote><h4 id="Ubuntu-環境の実行例"><a href="#Ubuntu-環境の実行例" class="headerlink" title="Ubuntu 環境の実行例"></a>Ubuntu 環境の実行例</h4><p><img src="https://user-images.githubusercontent.com/71251920/142736815-a24dfbd6-e29c-4a08-8c90-604a8fdbae81.png" alt="Ubuntu_agent_stop_01"></p><p><img src="https://user-images.githubusercontent.com/71251920/142736817-6a1fee8c-7bd2-4d5b-9bc5-c9e8ffda6f7b.png" alt="Ubuntu_agent_stop_02"><br>RHEL 環境の実行例<br><img src="https://user-images.githubusercontent.com/71251920/142736834-94f46a91-f554-4de5-b6ea-7089b9607ff5.png" alt="RHEL_agent_stop_01"></p><p><img src="https://user-images.githubusercontent.com/71251920/142736825-0e6032e3-f26f-4760-9f0b-5772d4a02168.png" alt="RHEL_agent_stop_02"></p><h4 id="バックアップの実行-amp-失敗確認"><a href="#バックアップの実行-amp-失敗確認" class="headerlink" title="バックアップの実行 &amp; 失敗確認"></a>バックアップの実行 &amp; 失敗確認</h4><p>バックアップを実行し、バックアップ ジョブ が失敗したことを確認します。<br>*バックアップの実行から失敗まで数時間かかる場合がございます。<br>Status が Failed 、Error Code <strong>”UserErrorGuestAgentStatusUnavailable”</strong> となり、失敗し完了となります。本環境では 4 時間 20 分かかりました。　</p><p><img src="https://user-images.githubusercontent.com/71251920/142736877-fd3190e0-596a-4a51-b0d2-f682b2a34a3e.png" alt="FailCheck_03"></p><h4 id="Agent-の再起動-1"><a href="#Agent-の再起動-1" class="headerlink" title="Agent の再起動"></a>Agent の再起動</h4><p>バックアップ エラーの検証後は、以下コマンドで waagent を再開します。</p><blockquote><p>（Ubuntu の場合）<br>   sudo systemctl start walinuxagent<br>   sudo systemctl enable walinuxagent<br>   systemctl status walinuxagent<br>（Ubuntu 以外の場合）<br>   sudo systemctl start waagent<br>   sudo systemctl enable waagent<br>   systemctl status waagent</p></blockquote><h4 id="Ubuntu-環境の実行例-1"><a href="#Ubuntu-環境の実行例-1" class="headerlink" title="Ubuntu 環境の実行例"></a>Ubuntu 環境の実行例</h4><p><img src="https://user-images.githubusercontent.com/71251920/142736924-8e033f57-60aa-449e-bb34-2fb5c410d633.png" alt="Ubuntu_agent_start"></p><h4 id="RHEL-環境の実行例"><a href="#RHEL-環境の実行例" class="headerlink" title="RHEL 環境の実行例"></a>RHEL 環境の実行例</h4><p><img src="https://user-images.githubusercontent.com/71251920/142736923-43d72bbc-e3cb-46a4-825b-a4b71fe61d9a.png" alt="RHEL_agent_start"></p><h2 id="5-バックアップを故意に失敗させる方法-共有ディスクをアタッチする"><a href="#5-バックアップを故意に失敗させる方法-共有ディスクをアタッチする" class="headerlink" title="5. バックアップを故意に失敗させる方法 (共有ディスクをアタッチする)"></a>5. バックアップを故意に失敗させる方法 (共有ディスクをアタッチする)<a id="5"></a></h2><p>Guest Agent を手動で停止させる方法以外に「共有ディスクを一時的にアタッチしてバックアップ ジョブを失敗させる」方法もご紹介します。<br>こちらはバックアップ ジョブ開始直後 ～ 30 分程度で「UserErrorSharedDiskBackupNotSupported」エラーで失敗する見込みです。</p><h3 id="5-1-詳細手順"><a href="#5-1-詳細手順" class="headerlink" title="5.1.詳細手順"></a>5.1.詳細手順</h3><p>バックアップ 対象の VM に、Azure ポータル画面上で一時的に共有ディスクを追加アタッチします。<br>・Azure マネージド ディスクに対して共有ディスクを有効にする - Azure Virtual Machines | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/disks-shared-enable?tabs=azure-portal">https://learn.microsoft.com/ja-jp/azure/virtual-machines/disks-shared-enable?tabs=azure-portal</a></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/cc0c7196-64d1-482d-9c7d-c8b4d959eedf" alt="image01"></p><p>(「SharedDisk02」は、共有ディスクリソースになっています)<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/81a8a957-edca-4ef5-9858-ea29cacd4df5" alt="image02"></p><p>「今すぐバックアップ」をトリガーします。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/7d5e8fc1-7f76-4be0-9839-a1bd8c4ec62b" alt="image03"></p><p>バックアップ ジョブ開始直後 ～ 30 分程度でバックアップ ジョブが「UserErrorSharedDiskBackupNotSupported」エラーにて失敗する見込みです。<br><img src="https://github.com/jpabrs-scem/blog/assets/96324317/682e85d2-1814-4ce8-84a4-6fc45dc98dcb" alt="image04"></p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/464d5257-728b-4411-ac76-559b9b07c93a" alt="image05"></p><p>バックアップ ジョブ エラーを確認した後は、一時的にアタッチしていた共有ディスクをデタッチします。</p><p>Azure VM Backup を意図的に失敗させる方法について、ご案内は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートの 相田 です。&lt;br&gt;アラートのテスト等のため “Azure VM Backup を失敗させたい” というお問い合わせをよくいただきます。&lt;br&gt;今回は、&lt;strong&gt;Az</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM BackupにおけるRecovery Services コンテナーの変更について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Change_RSV_for_VM/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/Change_RSV_for_VM/</id>
    <published>2023-06-08T03:00:00.000Z</published>
    <updated>2023-10-30T10:53:16.247Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートです。<br>今回はお問い合わせをいただくことが多い、<strong>Azure VM Backup を取得している Recovery Services コンテナーを変更することは可能か？</strong>について説明させていただきます。</p><p>なんらかのバックアップ構成を行ったあとは、Recovery Services コンテナー上の冗長性の変更をいただくことが出来ないため、 Recovery Services コンテナー自体を変更いただく必要がございます。<br>ただし、CRR の「無効化」→「有効化」への切り替えのみは、バックアップ アイテムを保護した後でも変更が可能です。</p><p>・ストレージ冗長性の設定<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault#set-storage-redundancy">https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault#set-storage-redundancy</a></p><blockquote><p>コンテナーでバックアップを構成する前に、必ず Recovery Services コンテナーのストレージ レプリケーションの種類を変更してください。 バックアップを構成した後、変更するオプションは無効になります。</p></blockquote><p>結論から申し上げますと <strong>Recovery Services コンテナーを変更することは可能</strong>です。</p><p>なお、本件に関連した公式ドキュメントは下記でございます。<br>・Recovery Services コンテナーを作成して構成する - 既定の設定を変更する<br>  <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault#modify-default-settings">https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault#modify-default-settings</a></p><p>すでにバックアップを構成している　VM に対して Recovery Services コンテナー を変更するには、VM と 既存のRecovery Services コンテナーとの紐づけを解除する必要がございます。<br>紐づけを解除することで、新たに別の Recovery Services コンテナーに紐づけることが可能です。</p><p>紐づけを解除する方法としては 後述の通り ２ 種類ございます。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. 既存のバックアップデータを [維持] する方法</a><br> <a href="#1-1"> 1.1 注意事項</a><br> <a href="#1-2"> 1.2 変更手順概要</a><br> <a href="#1-3"> 1.3 手順</a><br><a href="#2">2. 既存のバックアップデータを [削除] する方法</a><br> <a href="#2-1"> 2.1 注意事項</a><br> <a href="#2-2"> 2.2 変更手順概要</a><br> <a href="#2-3"> 2.3 手順</a><br> <a href="#2-3-1"> 2.3.1 論理削除状態について</a><br><a href="#3">3. (補足) バックアップデータを残しつつリソースグループを変更しない方法</a><br> <a href="#3-1"> 3.1 手順</a></p><hr><h2 id="1-既存のバックアップデータを-維持-する方法"><a href="#1-既存のバックアップデータを-維持-する方法" class="headerlink" title="1. 既存のバックアップデータを [維持] する方法"></a>1. 既存のバックアップデータを [維持] する方法<a id="1"></a></h2><p> Recovery Services コンテナーと VM の紐づけは VM のリソースグループ名と VM 名によって行っています。<br>この方法では対象の VM のリソースグループを変更することにより、既存の Recovery Services コンテナーとの紐づけを解除します。<br>なお、リソースグループを変更し新しい Recovery Services コンテナーにてバックアップを構成した場合でも、VM のリソースグループ名を 元のリソースグループに戻した場合、既存の Recovery Services コンテナーと紐づいている状態になります。</p><h3 id="1-1-注意事項"><a href="#1-1-注意事項" class="headerlink" title="1.1 注意事項"></a>1.1 注意事項<a id="1-1"></a></h3><p>こちらの方法では対象の VM のリソースグループの変更が必要です。<br>・Recovery Services コンテナーを作成して構成する<br>    <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault#must-preserve-previous-backed-up-data">https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault#must-preserve-previous-backed-up-data</a></p><blockquote><p>Azure VM の場合は、GRS コンテナー内の VM に対して保護を停止してデータを保持し、VM を別のリソース グループに移動してから、LRS コンテナー内の VM を保護することができます。</p></blockquote><p>Recovery Services コンテナー変更のために、リソース グループの変更が必要なものは、「Azure VM」リソースのみで、VM にアタッチされているディスクや NIC のリソース グループを変更する必要はございません。<br>お客様の管理上、VM にアタッチされているディスクも含めてリソース グループを変更されたい場合、Azure VM Backup にて取得した復元ポイント コレクションが存在している状態では、アタッチされているディスクのリソース グループの変更がかないません。<br>もし、Azure VM Backup にてバックアップ構成している VM にアタッチされているディスクのリソース グループを変更されたい場合は、Azure ポータル画面 ＞ 復元ポイント コレクションへ移動し、対象 VM の復元ポイント コレクションを削除すれば、ディスクのリソース グループを変更することができます。<br>ただし、復元ポイント コレクションを削除した場合は、スナップショット層に格納されている復元ポイントを削除することになりますので、削除した復元ポイントについては、インスタント リストア機能による「復元」ができなくなります。（Recovery Services コンテナー層からの復元のみとなります。）<br>また、回復の種類が “スナップショット” のみの復元ポイントがある場合に復元ポイント コレクションを削除した場合には、該当の復元ポイントより復元ができなくなりますのでご留意ください。（回復の種類が “スナップショットと標準コンテナー”、”標準コンテナー” となっている復元ポイントに関しては、Recovery Services コンテナー層からの復元は可能でございます）</p><h3 id="1-2-変更手順概要"><a href="#1-2-変更手順概要" class="headerlink" title="1.2 変更手順概要"></a>1.2 変更手順概要<a id="1-2"></a></h3><ol><li>古いRecovery Services コンテナーでのバックアップ停止する</li><li>バックアップ対象の VM のリソースグループを変更する</li><li>新しいRecovery Services コンテナーにてバックアップを構成する</li></ol><h3 id="1-3-手順"><a href="#1-3-手順" class="headerlink" title="1.3 手順"></a>1.3 手順<a id="1-3"></a></h3><p>0-1. Recovery Services コンテナー変更対象の VM の状態を確認 (リソースグループ : rg-1 )<br><img src="https://user-images.githubusercontent.com/71251920/153033255-67f50490-d9e1-4da1-bd32-38b90169176f.jpg" alt="Change_RSV_for_VM_01"></p><p>0-2. Recovery Services コンテナー: rsv-1 にてバックアップ有効化、復元ポイント作成済み<br><img src="https://user-images.githubusercontent.com/71251920/153033252-b754f533-636e-48b7-954a-64d05b206926.jpg" alt="Change_RSV_for_VM_02"></p><p>1-1. VM のバックアップを停止<br><img src="https://user-images.githubusercontent.com/71251920/153033249-43853045-8fe5-45db-81f8-192f132642c6.jpg" alt="Change_RSV_for_VM_03"></p><p>1-2. 停止の際、バックアップデータ (復元ポイント) の保持を選択し、理由を記入してバックアップの停止をクリック<br><img src="https://user-images.githubusercontent.com/71251920/153033247-afd58826-d3ab-4a12-a97f-200aed5e8080.jpg" alt="Change_RSV_for_VM_04"></p><p>1-3. バックアップの無効化完了を確認</p><p>1-4. この状態ではまだ別のRecovery Services コンテナーにて「バックアップの有効化」を試みても、VM が対象として表示されません<br><img src="https://user-images.githubusercontent.com/71251920/153033243-14e0e75a-aeee-4fa6-9e31-c2d74e63f494.jpg" alt="Change_RSV_for_VM_06"></p><p>2-1. VM &gt; 概要 &gt; リソースグループ 横の移動をクリック<br><img src="https://user-images.githubusercontent.com/71251920/153033242-3bec21b2-4884-49f0-b4a3-79f618e886c8.jpg" alt="Change_RSV_for_VM_07"></p><p>2-2. 移動させたいリソースグループを選択し、次へ<br>2-3. 検証が完了するのを待ち、次へ<br>2-4. 内容を確認し、下部チェックを選択して、移動をクリック<br><img src="https://user-images.githubusercontent.com/71251920/153033238-2dd487ff-b8e1-44b9-af62-2ec16276a830.jpg" alt="Change_RSV_for_VM_08"></p><p>2-5. リソースグループの移動完了を確認<br><img src="https://user-images.githubusercontent.com/71251920/153033235-749eb8ff-5a0e-4573-b736-01bb9232fd8e.jpg" alt="Change_RSV_for_VM_09"></p><p>3-1. 新たにバックアップを取得したい別の Recovery Services コンテナーにて該当の VM のバックアップを有効化<br>    (この時点で別の Recovery Services コンテナーのバックアップ構成の仮想マシン選択欄に該当の VM が表示されるようになります)<br><img src="https://user-images.githubusercontent.com/71251920/153033232-ea02b8b6-f6a5-48d5-b59a-8cd6f20bd115.jpg" alt="Change_RSV_for_VM_10"></p><p>3-2. 今すぐバックアップにてバックアップ完了。<br>新たなRecovery Services コンテナーにて問題なくバックアップできることを確認</p><p><img src="https://user-images.githubusercontent.com/71251920/153033229-353621e5-0fa7-4ffc-9e24-23650542bc4e.jpg" alt="Change_RSV_for_VM_11"></p><p>3-3. 古いRecovery Services コンテナーには過去の復元ポイントは残存したままで、この復元ポイントからも VM を復元することが可能です。<br><img src="https://user-images.githubusercontent.com/71251920/153033227-2c45fbbd-0036-429a-8a33-9dbf06cce622.jpg" alt="Change_RSV_for_VM_12"></p><h2 id="2-既存のバックアップデータを-削除-する方法"><a href="#2-既存のバックアップデータを-削除-する方法" class="headerlink" title="2. 既存のバックアップデータを [削除] する方法"></a>2. 既存のバックアップデータを [削除] する方法<a id="2"></a></h2><p> 既存の Recovery Services コンテナーに保存された対象 VM のバックアップデータを削除することによって、既存の Recovery Services コンテナーと対象の VM との紐づけを解除します。 </p><h3 id="2-1-注意事項"><a href="#2-1-注意事項" class="headerlink" title="2.1 注意事項"></a>2.1 注意事項<a id="2-1"></a></h3><p>こちらの方法では対象 VMの 既存のバックアップデータの削除が必要です。<br>・Recovery Services コンテナーを作成して構成する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault#dont-need-to-preserve-previous-backed-up-data">https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault#dont-need-to-preserve-previous-backed-up-data</a></p><blockquote><p>新しい LRS コンテナーのワークロードを保護するには、GRS コンテナー内の現在の保護とデータを削除し、バックアップを再構成する必要があります。</p></blockquote><p>また本作業を行う際、バックアップアラートを設定していない場合でも発砲されます。<br>詳細につきましては下記をご確認ください。<br>・バックアップ アラートの通知<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults#notification-for-backup-alerts">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults#notification-for-backup-alerts</a></p><blockquote><p>“破壊的な操作 (データを削除して保護を停止など) が実行されると、アラートが生成され、Recovery Services コンテナー用に通知が構成されていない場合でも、サブスクリプションの所有者、管理者、共同管理者にメールが送信されます。</p></blockquote><h3 id="2-2-変更手順概要"><a href="#2-2-変更手順概要" class="headerlink" title="2.2 変更手順概要"></a>2.2 変更手順概要<a id="2-2"></a></h3><ol><li>古いRecovery Services コンテナーでのバックアップを停止し、バックアップ データを削除する</li><li>新しいRecovery Services コンテナーにてバックアップを構成する</li></ol><h3 id="2-3-手順"><a href="#2-3-手順" class="headerlink" title="2.3 手順"></a>2.3 手順<a id="2-3"></a></h3><p>0-1. Recovery Services コンテナー変更対象の VM の状態を確認 (リソースグループ : rg-1 )<br><img src="https://user-images.githubusercontent.com/71251920/153033224-cee11ab5-892f-4ed0-b085-2222c859c83b.jpg" alt="Change_RSV_for_VM_13"></p><p>0-2. Recovery Services コンテナー: rsv-1 にてバックアップ有効化、復元ポイント作成済み<br><img src="https://user-images.githubusercontent.com/71251920/153033220-1a7bdbaa-c235-47c1-a999-04ecff700e92.jpg" alt="Change_RSV_for_VM_14"></p><p>1-1. 復元ポイントを即時に削除するために、一時的に「論理削除」設定を無効化します。<br>Recovery Services コンテナー &gt; プロパティ &gt; セキュリティ設定 更新 へと移動し<br>下記チェックボックスを一時的に「チェック OFF」へと変更しておきます。</p><p>・クラウド ワークロードの論理的な削除を有効にする</p><p><img src="https://github.com/jpabrs-scem/blog/assets/96324317/15983e5f-acea-4970-974f-e8e722a23f70" alt="Change_RSV_for_VM_17"></p><ul><li>注意事項： 論理削除状態について<a id="2-3-1"></a><br>論理削除状態 (論理削除が有効な状態で削除した状態) では完全にバックアップデータが消えず、対象 VM と  Recovery Services コンテナーの紐づけが解除されません。その際は下記 URL を参考にして論理削除状態のバックアップアイテムを完全に削除してください。</li></ul><p>・論理的に削除されたバックアップ項目を完全に削除する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-security-feature-cloud#permanently-deleting-soft-deleted-backup-items">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-security-feature-cloud#permanently-deleting-soft-deleted-backup-items</a></p><p>1-2. VM のバックアップを停止<br><img src="https://user-images.githubusercontent.com/71251920/153033219-95548634-88d5-4dd1-a6b1-f2a3287402c1.jpg" alt="Change_RSV_for_VM_15"></p><p>1-3. 停止の際、バックアップデータ (復元ポイント) の削除を選択し、理由を記入してバックアップの停止をクリック<br><img src="https://user-images.githubusercontent.com/71251920/153033215-abe38422-30ba-450e-a27e-773957273cf8.jpg" alt="Change_RSV_for_VM_16"></p><p>1-5. バックアップデータの削除完了を”  Azure Portal &gt; 対象のRecovery Services コンテナー &gt; バックアップアイテム &gt; Azure Virtual Machines” から、対象のVMが表示されないことを確認します。</p><p>2-1. 新たにバックアップを取得したい別の Recovery Servics コンテナーにて該当の VM のバックアップを有効化<br>    (この時点で別の Recovery Services コンテナーのバックアップ構成の仮想マシン選択欄に該当の VM が表示されるようになります)<br><img src="https://user-images.githubusercontent.com/71251920/153033209-9d8daa07-6052-49e7-ae71-0ba5a7e3a15e.jpg" alt="Change_RSV_for_VM_18"></p><p>2-2. 今すぐバックアップにてバックアップ完了。<br>新たなRecovery Services コンテナーにて問題なくバックアップできることを確認<br><img src="https://user-images.githubusercontent.com/71251920/153033202-587b9bd3-bcd5-41a6-a10f-d6a1bffdbca4.jpg" alt="Change_RSV_for_VM_19"></p><p>2-3. 古い Recovery Services コンテナー上で「チェック OFF」としていた、下記項目をもとの設定値に戻します。<br>Recovery Services コンテナー &gt; プロパティ &gt; セキュリティ設定 更新 &gt; 「クラウド ワークロードの論理的な削除を有効にする」</p><h2 id="3-補足-バックアップデータを残しつつリソースグループを変更しない方法"><a href="#3-補足-バックアップデータを残しつつリソースグループを変更しない方法" class="headerlink" title="3. (補足) バックアップデータを残しつつリソースグループを変更しない方法"></a>3. (補足) バックアップデータを残しつつリソースグループを変更しない方法<a id="3"></a></h2><p><strong>バックアップ データは残したまま＋ VM のリソースグループを変更しない ＋ 新しい Recovery Services コンテナーに紐づける　ということはこれまで説明した通りかないません</strong><br><a href="#1">1. 既存のバックアップデータを [維持] する方法</a> によって変更後、リソース グループを戻してしまうと、古い Recovery Services コンテナーが残っている場合には、古い Recovery Services コンテナー側にて再度紐づいてしまいます。<br>また、もとの Recovery Services コンテナーが削除された場合には新しい Recovery Services コンテナーとの紐づけが切れ、 Azure VM のバックアップメニューからはバックアップが構成されていない状態になります。</p><p>そのため方法としては、<strong>既存のバックアップデータを一度ディスクとして復元して保存いただくことで可能です</strong>。<br>特定の復元ポイントだけを保存しておけばよいという場合はこちらの方法をご検討ください。<br>もちろん、すべての復元ポイントからディスクとして復元いただければ、すべての バックアップデータを保存することは可能です。</p><p>具体的な手順としては下記です。</p><h4 id="手順"><a href="#手順" class="headerlink" title="手順"></a>手順<a id="3-1"></a></h4><ol><li>保存したい復元ポイントからディスクとしてリストアする。<br>詳細は下記をご覧ください<br>・代替案 - Azure VM Backup で取得した復旧ポイントの保持期間の延長について<br>　<a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToExtendVMRetentionPeriod/#4">https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToExtendVMRetentionPeriod/#4</a></li></ol><ol start="2"><li>その後 上述の<a href="#2">2. 既存のバックアップデータを [削除] する方法</a>によって Recovery Services コンテナーを変更する。</li></ol><hr>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートです。&lt;br&gt;今回はお問い合わせをいただくことが多い、&lt;strong&gt;Azure VM Backup を取得している Recovery Services コンテナーを変更するこ</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>QL4L-5D8 クラシック アラートから Azure Monitor を使用した組み込みのアラートへの移行について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/HowToMoveClassicAlert/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/HowToMoveClassicAlert/</id>
    <published>2023-04-10T03:00:00.000Z</published>
    <updated>2023-10-30T10:53:16.215Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Backup サポートです。<br>今回は、2023 年 3 月末より弊社から発行されている、アラート追跡 ID 「QL4L-5D8」について説明いたします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#Q1">Q1. 「QL4L-5D8」このアラートは何ですか？</a><br><a href="#Q2">Q2. どのRecovery Services コンテナーが「クラシック アラート設定」になっていますか？</a><br><a href="#Q3">Q3. クラシック アラートから Azure Monitor を使用した組み込みのアラートへと移行した場合のコストはどうなりますか？</a><br><a href="#Q4">Q4. クラシック アラートの「通知の構成」をしているかどうかは 1 つ 1 つの Recovery Services コンテナーを確認する必要がありますか？</a></p><hr><h2 id="Q1-「QL4L-5D8」このアラートは何ですか？"><a href="#Q1-「QL4L-5D8」このアラートは何ですか？" class="headerlink" title="Q1. 「QL4L-5D8」このアラートは何ですか？"></a><a id="Q1"></a>Q1. 「QL4L-5D8」このアラートは何ですか？</h2><p><strong>A1</strong> クラシック アラートから、Azure Monitor を使用した組み込みのアラートへと移行するよう、お知らせするためのものです。<br>Recovery Services コンテナーでは、クラシック アラートが<span style="color: red; ">既定</span>で存在しており、かつ、利用可能な状態となっております。<br>後述 「Q2. どのRecovery Services コンテナーが「クラシック アラート設定」になっていますか？」 をご参照いただき、クラシック アラートを利用した通知の設定有無をまずはご確認くださいますようお願いいたします。</p><h4 id="・クラシック-アラート機能用いて、現在メールへのアラート通知を構成している場合"><a href="#・クラシック-アラート機能用いて、現在メールへのアラート通知を構成している場合" class="headerlink" title="・クラシック アラート機能用いて、現在メールへのアラート通知を構成している場合"></a>・クラシック アラート機能用いて、現在メールへのアラート通知を構成している場合</h4><p>クラシック アラートは、2026 年 3 月 31 日をもって廃止する予定です。<br>監視設定を継続してご利用になられる場合は、お手数ではございますが、「Azure Monitor を使用した組み込みのアラート」への切り替えを事前にご検討くださいますようお願いいたします。</p><h4 id="・クラシック-アラート機能用いて、現在メールへのアラート通知を構成していないが、今後はバックアップ-ジョブ失敗時にメール通知などのアラートをご希望の場合"><a href="#・クラシック-アラート機能用いて、現在メールへのアラート通知を構成していないが、今後はバックアップ-ジョブ失敗時にメール通知などのアラートをご希望の場合" class="headerlink" title="・クラシック アラート機能用いて、現在メールへのアラート通知を構成していないが、今後はバックアップ ジョブ失敗時にメール通知などのアラートをご希望の場合"></a>・クラシック アラート機能用いて、現在メールへのアラート通知を構成していないが、今後はバックアップ ジョブ失敗時にメール通知などのアラートをご希望の場合</h4><p>クラシック アラートから、「Azure Monitor を使用した組み込みのアラート」へと切り替え設定することをご検討ください。</p><h4 id="・クラシック-アラート機能用いて、現在メールへのアラート通知を構成していない、かつ今後もバックアップ-ジョブ失敗時にメール通知などのアラートをご希望でない場合"><a href="#・クラシック-アラート機能用いて、現在メールへのアラート通知を構成していない、かつ今後もバックアップ-ジョブ失敗時にメール通知などのアラートをご希望でない場合" class="headerlink" title="・クラシック アラート機能用いて、現在メールへのアラート通知を構成していない、かつ今後もバックアップ ジョブ失敗時にメール通知などのアラートをご希望でない場合"></a>・クラシック アラート機能用いて、現在メールへのアラート通知を構成していない、かつ今後もバックアップ ジョブ失敗時にメール通知などのアラートをご希望でない場合</h4><p><span style="color: red; ">特段ユーザー様にて追加作業は不要です。</span></p><p>・監視とレポートのシナリオ<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/monitoring-and-alerts-overview#monitoring-and-reporting-scenarios">https://learn.microsoft.com/ja-jp/azure/backup/monitoring-and-alerts-overview#monitoring-and-reporting-scenarios</a></p><p><img src="https://user-images.githubusercontent.com/96324317/230756428-28f8085a-16bf-49ab-aa50-8659f342b81e.png" alt="image01"></p><p><img src="https://user-images.githubusercontent.com/96324317/230756444-3a95a6b5-dd4d-47e0-b3d1-ea3ffe54fa49.png" alt="image02"></p><p><img src="https://user-images.githubusercontent.com/96324317/230756450-5d78ebd9-19e0-455b-9ba6-6f079f9cf65d.png" alt="image03"></p><h2 id="Q2-どの-Recovery-Services-コンテナーが「クラシック-アラート設定」になっていますか？"><a href="#Q2-どの-Recovery-Services-コンテナーが「クラシック-アラート設定」になっていますか？" class="headerlink" title="Q2.どの Recovery Services コンテナーが「クラシック アラート設定」になっていますか？"></a><a id="Q2"></a>Q2.どの Recovery Services コンテナーが「クラシック アラート設定」になっていますか？</h2><p><strong>A2</strong><br>・既定ですべての Recovery Services コンテナーにおいて、「Azure Monitor を使用した組み込みのアラート」へと移行していない Recovery Services コンテナーは、「クラシック アラート」が有効になっており、今回の正常性アラート対象となっております<br>・実際に「クラシック アラート」を用いてメールへの通知構成をしているかどうかは、ユーザー様の設定次第です</p><h4 id="【どの-Recovery-Services-コンテナーが「Azure-Monitor-を使用した組み込みのアラート」へと移行しておらず、クラシック-アラートが有効になっているのか-確認方法】"><a href="#【どの-Recovery-Services-コンテナーが「Azure-Monitor-を使用した組み込みのアラート」へと移行しておらず、クラシック-アラートが有効になっているのか-確認方法】" class="headerlink" title="【どの Recovery Services コンテナーが「Azure Monitor を使用した組み込みのアラート」へと移行しておらず、クラシック アラートが有効になっているのか　確認方法】"></a>【どの Recovery Services コンテナーが「Azure Monitor を使用した組み込みのアラート」へと移行しておらず、クラシック アラートが有効になっているのか　確認方法】</h4><p> [バックアップ センター] ブレードの[概要] タブより、”アクティブなアラート” 項目に[以前のアラート ソリューションであるクラシック アラートを使用しているコンテナーがxx 個あります。]<br>と表示されている場合、クラシック アラートが有効・利用可能となっているRecovery Services コンテナーが存在しています。</p><p>この記述がある場合は、後述される [アクションを起こすには、ここをクリック] をクリックします。</p><p><img src="https://user-images.githubusercontent.com/96324317/230756521-74ec97f7-1147-4799-aa66-59b789ab3f69.png" alt="image04"></p><p><img src="https://user-images.githubusercontent.com/96324317/230756529-fbb23335-c992-4b39-b4b9-071e280168f8.png" alt="image05"></p><p>[Azure Monitor アラートのみの使用をオプトイン] 画面にて、リストされているRecovery Services コンテナーを確認します。<br><img src="https://user-images.githubusercontent.com/96324317/230756537-0108ce69-1a21-4052-8984-cb5833ee69f6.png" alt="image06"></p><h4 id="【どの-Recovery-Services-コンテナーが、クラシック-アラートの「通知の構成」を行っているのか-確認方法】"><a href="#【どの-Recovery-Services-コンテナーが、クラシック-アラートの「通知の構成」を行っているのか-確認方法】" class="headerlink" title="【どの Recovery Services コンテナーが、クラシック アラートの「通知の構成」を行っているのか　確認方法】"></a>【どの Recovery Services コンテナーが、クラシック アラートの「通知の構成」を行っているのか　確認方法】</h4><p>リストされた Recovery Services コンテナーが実際に通知の構成をしているかどうかは、上記でリストされたRecovery Services コンテナー＞[バックアップ アラート] ＞ ”通知の構成” ＞「メールの通知：オン」となっているかどうかで確認可能です。<br><img src="https://user-images.githubusercontent.com/96324317/230756566-faba366c-1f68-4034-8f4e-bbc1f9e7bc2f.png" alt="image07"></p><p>通知の構成をしている Recovery Services コンテナーがある場合、[Azure Monitor アラートのみの使用をオプトイン] 画面にて、アラートの設定の更新を行います。<br>”通知の構成” ＞「メールの通知：オン」をしている Recovery Services コンテナーが無い場合、かつ、今後バックアップジョブの監視設定をする必要が無い場合は、下記対応は不要です。<br><img src="https://user-images.githubusercontent.com/96324317/230756596-d48ec392-d5c3-4a6b-9b84-73a7e7db4b49.png" alt="image08"></p><p>なお、[Azure Monitor アラートのみの使用をオプトイン] 画面より、アラート設定の更新をする場合、下記の赤枠に記載されているように、メールなどの通知が必要な場合は、別途設定していただく必要があります。</p><p>詳細は下記のドキュメントを参照いただければと存じます。<br>・クラシック アラートから組み込みのAzure Monitor アラートに移行する<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/move-to-azure-monitor-alerts#migrate-from-classic-alerts-to-built-in-azure-monitor-alerts">https://learn.microsoft.com/ja-jp/azure/backup/move-to-azure-monitor-alerts#migrate-from-classic-alerts-to-built-in-azure-monitor-alerts</a></p><p><img src="https://user-images.githubusercontent.com/96324317/230756610-2254377b-37ea-4205-a6e2-f6b04e959ced.png" alt="image09"></p><h2 id="Q3-クラシック-アラートから-Azure-Monitor-を使用した組み込みのアラートへと移行した場合のコストはどうなりますか？"><a href="#Q3-クラシック-アラートから-Azure-Monitor-を使用した組み込みのアラートへと移行した場合のコストはどうなりますか？" class="headerlink" title="Q3.クラシック アラートから Azure Monitor を使用した組み込みのアラートへと移行した場合のコストはどうなりますか？"></a><a id="Q3"></a>Q3.クラシック アラートから Azure Monitor を使用した組み込みのアラートへと移行した場合のコストはどうなりますか？</h2><p><strong>A3</strong> 「Azure Monitor を使用した組み込みのアラートが生成されること」自体に料金は発生しません。<br>　　一方、メールなどへアラートを通知させる場合は、少額の料金が発生いたします。<br>　　詳細は下記ドキュメントよりご参照ください。</p><p>・クラシック アラートから組み込みの Azure Monitor アラートに移行する<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/move-to-azure-monitor-alerts#migrate-from-classic-alerts-to-built-in-azure-monitor-alerts">https://learn.microsoft.com/ja-jp/azure/backup/move-to-azure-monitor-alerts#migrate-from-classic-alerts-to-built-in-azure-monitor-alerts</a></p><p><img src="https://user-images.githubusercontent.com/96324317/230756632-22b2968e-d899-44f4-8472-c0c5db56f0c9.png" alt="image10"></p><p>Free レベル (1 か月あたり 1,000 メール) を超える通知に対しては、下記の料金が発生します。</p><p>・価格 - Azure Monitor | Microsoft Azure<br><a href="https://azure.microsoft.com/ja-jp/pricing/details/monitor/">https://azure.microsoft.com/ja-jp/pricing/details/monitor/</a><br>“メール            1 か月あたりメール 1,000 通         メール 100,000 通につき $2”<br><img src="https://user-images.githubusercontent.com/96324317/234444128-ca0d6690-a6a8-4bcf-9e9e-7e63cf44ce49.png" alt="image10-1"></p><h2 id="Q4-クラシック-アラートの「通知の構成」をしているかどうかは-1-つ-1-つの-Recovery-Services-コンテナーを確認する必要がありますか？"><a href="#Q4-クラシック-アラートの「通知の構成」をしているかどうかは-1-つ-1-つの-Recovery-Services-コンテナーを確認する必要がありますか？" class="headerlink" title="Q4.クラシック アラートの「通知の構成」をしているかどうかは 1 つ 1 つの Recovery Services コンテナーを確認する必要がありますか？"></a><a id="Q4"></a>Q4.クラシック アラートの「通知の構成」をしているかどうかは 1 つ 1 つの Recovery Services コンテナーを確認する必要がありますか？</h2><p><strong>A4</strong> 恐縮ながら、現状はクラシック アラートの「通知の構成」部分を照会するような Azure PowerShell ・Azure CLI コマンドのご用意が無いため、ユーザー様には Azure ポータル画面の Recovery Services コンテナーを 1 つ 1 つ確認いただく必要がございます。<br>※　前提としてクラシック アラートの「通知の構成」をされているのであれば、ユーザー様が設定されたメールアドレスの宛先へと、バックアップ ジョブ失敗時などに通知がなされています。</p><p>その他確認手段の 1 つとして、以下のような REST API を発行することで確認が可能ですので、参考として紹介いたします。<br>※　以下 REST API は、本ブログ発行時点で確認可能な手段であり、事前予告なく返却値が変わる可能性がありますこと、ご了承ください。<br>　　以下 REST API は、あくまで参考としてご連携するサンプル コマンドでございます。<br>　　コマンド実装をされる場合は貴社にて検証のうえ、実施いただきますようご留意ください。<br>　　また、Azure サポートでは主に Post Production の Break &amp; Fix を担当しており、スクリプトのコードレビューのサポートは承っておりませんので、ご理解をいただけますと幸いです。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">### クラシックアラートのメール通知が有効化されているかを確認する </span><br><span class="line">### ※ (前提) Connect-AzAccount コマンドにて、 Azure に接続可能な状態で実行すること</span><br><span class="line"></span><br><span class="line">$RSVList = Get-AzRecoveryServicesVault | Select-Object Name, ResourceGroupName, SubscriptionId</span><br><span class="line"></span><br><span class="line"># リクエスト ヘッダーを作成</span><br><span class="line">$headers = @&#123;</span><br><span class="line">    &#x27;Content-type&#x27;  = &#x27;application/json&#x27;</span><br><span class="line">    &#x27;Authorization&#x27; = &#x27;Bearer &#x27; + (Get-AzAccessToken).Token</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 結果出力先のオブジェクトを作成</span><br><span class="line">$results = @()</span><br><span class="line"></span><br><span class="line"># Recovery Services コンテナーごとに API へリクエストを送り、結果を取得する ※1</span><br><span class="line">foreach ( $rsv in $RSVList ) &#123;</span><br><span class="line">    $uri = &quot;https://management.azure.com/subscriptions/$($rsv.SubscriptionId)/resourceGroups/$($rsv.ResourceGroupName)/providers/Microsoft.RecoveryServices/vaults/$($rsv.Name)/monitoringConfigurations/notificationConfiguration?api-version=2017-07-01-preview&quot;</span><br><span class="line">    $response = (Invoke-RestMethod -Uri $uri -Method Get -Headers $headers).properties</span><br><span class="line">    $results += @([pscustomobject]@&#123;subscriptionID = $rsv.SubscriptionId; resourceGroupName = $rsv.ResourceGroupName; recoveryServicesContainerName = $rsv.Name; isClassicAlertNotificationEnabled = $response.areNotificationsEnabled; mailRecipients = $response.additionalRecipients -join &#x27;; &#x27; &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 全ての結果をコンソール出力</span><br><span class="line">$results | Sort-Object isClassicAlertNotificationEnabled -Descending | ForEach-Object &#123; Write-Output $_ | Format-Table &#125;</span><br></pre></td></tr></table></figure><p>上記 REST API を発行した場合、「isClassicAlertNotificationEnabled：True」となっている Recovery Services コンテナーが「通知の構成：オン」となっているものとなります。<br><img src="https://user-images.githubusercontent.com/96324317/230820217-777e48c3-f704-4e83-9aeb-1a5b107633af.png" alt="image11"></p><p><img src="https://user-images.githubusercontent.com/96324317/230820265-bcb0a6df-eae6-4946-b0f9-c1f905a539d4.png" alt="image12"></p><p><img src="https://user-images.githubusercontent.com/96324317/230820287-06940bef-a423-4202-a016-e3ec7bd79489.png" alt="image13"></p><p><img src="https://user-images.githubusercontent.com/96324317/230820315-3f9dc117-bfac-4e73-b0aa-d37a12503390.png" alt="image14"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、2023 年 3 月末より弊社から発行されている、アラート追跡 ID 「QL4L-5D8」について説明いたします。&lt;/p&gt;
&lt;h2 id=&quot;目次&quot;&gt;&lt;a hr</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>Recovery Services コンテナーとバックアップ コンテナーについて</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RSV_BV/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RSV_BV/</id>
    <published>2023-03-23T03:00:00.000Z</published>
    <updated>2023-10-30T10:53:16.215Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Backup サポートの山本です。<br>今回は、 Azure バックアップソリューションので利用する Recovery Services コンテナーとバックアップ コンテナーのバックアップ対象の違いについてご説明させていただきます。<br> Recovery Services コンテナーとバックアップ コンテナーはバックアップ対象(バックアップソリューション)の違いにより使い分ける必要がございます。<br> また、<strong>バックアップセンターは サブスクリプション内の Recovery Services コンテナーやバックアップ コンテナー (およびそれぞれのコンテナーでバックアップしているバックアップアイテム) を統合管理するための管理画面です。</strong></p><p><img src="https://user-images.githubusercontent.com/71251920/216895782-33a2539d-b199-466a-ba15-1184b2ad0552.png" alt=" Azure Backup 関連のリソース"></p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. バックアップソリューションとコンテナー、およびデータ保存先の比較表</a><br><a href="#2">2. コンテナーにバックアップデータが保存されないもの</a><br><a href="#2-1">2-1. Azure ファイル共有バックアップ</a><br><a href="#2-2">2-2. Azure Blob バックアップ</a><br><a href="#2-3">2-3. Azure ディスク バックアップ</a></p><hr><h3 id="1-バックアップソリューションとコンテナー、およびデータ保存先の比較表"><a href="#1-バックアップソリューションとコンテナー、およびデータ保存先の比較表" class="headerlink" title="1. バックアップソリューションとコンテナー、およびデータ保存先の比較表"></a><a id="1"></a>1. バックアップソリューションとコンテナー、およびデータ保存先の比較表</h3><p> 各 Azure バックアップのソリューションがどのコンテナーを利用するか、またデータの保存先についても下記の通りおまとめいたしました。<br> また、各ソリューションには各ソリューションの Docs へのリンクも付けております。</p><table><thead><tr><th align="left">#</th><th align="left">バックアップソリューション</th><th align="left">利用するコンテナー</th><th align="left">コンテナーにバックアップデータを保存するか</th></tr></thead><tbody><tr><td align="left">1</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction">Azure VM バックアップ</a></td><td align="left">Recovery Services コンテナー</td><td align="left">する</td></tr><tr><td align="left">2</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-about-mars">MARS バックアップ</a></td><td align="left">Recovery Services コンテナー</td><td align="left">する</td></tr><tr><td align="left">3</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-microsoft-azure-backup">MABS バックアップ</a></td><td align="left">Recovery Services コンテナー</td><td align="left">する</td></tr><tr><td align="left">4</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-sql-database">SQL in Azure VM バックアップ</a></td><td align="left">Recovery Services コンテナー</td><td align="left">する</td></tr><tr><td align="left">5</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-about">SAP HANA DB in Azure VM バックアップ</a></td><td align="left">Recovery Services コンテナー</td><td align="left">する</td></tr><tr><td align="left">6</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-file-share-backup-overview">Azure ファイル共有バックアップ</a></td><td align="left">Recovery Services コンテナー</td><td align="left"><strong>しない(注1)</strong></td></tr><tr><td align="left">7</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-overview">Azure Blob バックアップ</a></td><td align="left">バックアップ コンテナー</td><td align="left"><strong>しない(注2)</strong></td></tr><tr><td align="left">8</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-overview">Azure ディスク バックアップ</a></td><td align="left">バックアップ コンテナー</td><td align="left"><strong>しない</strong></td></tr><tr><td align="left">9</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-database-postgresql-overview">Azure PosgreSQL バックアップ</a></td><td align="left">バックアップ コンテナー</td><td align="left">する</td></tr></tbody></table><ul><li><p><strong>(注1) 2023年3月現在  Azure ファイル共有バックアップ のコンテナー層へのBackup機能が Private Preview となりました。</strong><br>・Private Preview: Azure Backup enables vaulted backups for Azure Files for comprehensive data protection.<br><a href="https://azure.microsoft.com/ja-JP/updates/azurefilesvaultedbackups-2/">https://azure.microsoft.com/ja-JP/updates/azurefilesvaultedbackups-2/</a></p></li><li><p><strong>(注2) 2023年3月現在  Azure Blob バックアップのコンテナー層へのBackup機能が Public Preview となりました。</strong><br>・Public Preview: Azure Backup enables vaulted backups for Azure Blob for comprehensive data protection.<br><a href="https://azure.microsoft.com/ja-JP/updates/azureblobvaultedbackups/">https://azure.microsoft.com/ja-JP/updates/azureblobvaultedbackups/</a></p></li></ul><h3 id="2-コンテナーにバックアップデータが保存されないもの"><a href="#2-コンテナーにバックアップデータが保存されないもの" class="headerlink" title="2.コンテナーにバックアップデータが保存されないもの"></a><a id="2"></a>2.コンテナーにバックアップデータが保存されないもの</h3><p>上述のとおり、Azure ファイル共有バックアップ、Azure Blob バックアップ、Azure ディスク バックアップは各コンテナーにはバックアップデータは転送されません。<br>それぞれについて簡単にご説明させていただきます。<br>共通している点はそれぞれのソリューションはコアとなる別のソリューションをバックアップサービス側からトリガーし実現している点でございます。</p><h4 id="2-1-Azure-ファイル共有バックアップ"><a href="#2-1-Azure-ファイル共有バックアップ" class="headerlink" title="2-1. Azure ファイル共有バックアップ"></a><a id="2-1"></a>2-1. Azure ファイル共有バックアップ</h4><p>Azure ファイル共有 バックアップは Azure Files の共有スナップショットの機能をバックアップサービスと連携することによりスナップショット取得の自動化、スナップショットの削除の自動化を実現したバックアップソリューションです。</p><p>そのため、バックアップデータ (スナップショットデータ) の保存先はAzure Files の共有スナップショットと同じく、そのストレージ アカウント自身 (のスナップショット領域)となります。<br>そのため、 Recovery Services コンテナーには転送されません。<br>下記のように<strong>Azure ファイル共有のスナップショット リソースとしてよって、Azure ファイル共有バックアップにて取得されたスナップショットも確認可能です</strong>。(“発信側” が “AzureBackup” となっているものです)<br><img src="https://user-images.githubusercontent.com/71251920/198350606-969ef3b9-0c2a-4744-9940-87c41936cb09.png"></p><p>・バックアップ プロセスのしくみ - Azure ファイル共有のバックアップについて<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-file-share-backup-overview">https://learn.microsoft.com/ja-jp/azure/backup/azure-file-share-backup-overview</a></p><blockquote><p>抜粋：ファイル共有データは Backup サービスには転送されません。これは、Backup サービスでは、ストレージ アカウントの一部であるスナップショットの作成および管理が行われ、バックアップはコンテナーに転送されないからです。</p></blockquote><p>・Azure Files の共有スナップショット<br><a href="https://learn.microsoft.com/ja-jp/azure/storage/files/storage-snapshots-files">https://learn.microsoft.com/ja-jp/azure/storage/files/storage-snapshots-files</a></p><h4 id="2-2-Azure-Blob-バックアップ"><a href="#2-2-Azure-Blob-バックアップ" class="headerlink" title="2-2. Azure Blob バックアップ"></a><a id="2-2"></a>2-2. Azure Blob バックアップ</h4><p>Azure Blob バックアップ は Azure Blob のポイントインタイムリストアの機能をバックアップサービスと連携することにより実現したバックアップソリューションです。</p><p>そのため、バックアップデータ (リストアに必要なデータ) の保存先は Azure Blob のポイントインタイムリストアと同じく、そのストレージ アカウント自身となります。<br>そのため、バックアップ コンテナーには転送されません。</p><p>・運用バックアップのしくみ - Azure Blob の運用バックアップの概要<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-overview">https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-overview</a></p><blockquote><p>抜粋：BLOB の運用バックアップは、ローカル バックアップ ソリューションです。 そのため、バック アップデータはバックアップ コンテナーには転送されず、ソース ストレージ アカウント自体に格納されます。 ただし、バックアップ コンテナーは引き続きバックアップ管理の単位として機能します。 また、これは継続的バックアップ ソリューションです。つまり、バックアップをスケジュール設定する必要がなく、すべての変更内容が保持され、選択した時点の状態から復元できます。</p></blockquote><p>・ブロック BLOB のポイントインタイム リストア<br><a href="https://learn.microsoft.com/ja-jp/azure/storage/blobs/point-in-time-restore-overview">https://learn.microsoft.com/ja-jp/azure/storage/blobs/point-in-time-restore-overview</a></p><h4 id="2-3-Azure-ディスク-バックアップ"><a href="#2-3-Azure-ディスク-バックアップ" class="headerlink" title="2-3. Azure ディスク バックアップ"></a><a id="2-3"></a>2-3. Azure ディスク バックアップ</h4><p>Azure ディスク バックアップ は マネージドディスクの増分スナップショットの機能とバックアップサービスと連携することによりスナップショット取得の自動化、スナップショットの削除の自動化を実現したバックアップソリューションです。</p><p>そのため、バックアップデータ (スナップショット データ) の保存先は マネージドディスクのスナップショットと同じく、マネージドディスクのスナップショットの専用領域 (運用層) となります。そのため、 Recovery Services コンテナーには転送されません。<br>また、下記のように<strong>スナップショットリソースとして Azure ディスクのバックアップによって取得されたスナップショットも確認可能です</strong>。(タグが “CreatedBy：AzureBackup” となっているものです)<br><img src="https://user-images.githubusercontent.com/71251920/198349785-951e0497-fe17-46e5-9714-53f2daf30344.png"></p><p>・バックアップと復元のプロセスのしくみ - Azure ディスク バックアップの概要<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-overview#how-the-backup-and-restore-process-works">https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-overview#how-the-backup-and-restore-process-works</a></p><blockquote><p>抜粋： Azure ディスク バックアップでは、運用層のバックアップのみがサポートされています。 コンテナー ストレージ層へのバックアップのコピーはサポートされていません。</p></blockquote><p>・マネージド ディスクの増分スナップショットの作成<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/disks-incremental-snapshots?tabs=azure-cli">https://learn.microsoft.com/ja-jp/azure/virtual-machines/disks-incremental-snapshots?tabs=azure-cli</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Backup サポートの山本です。&lt;br&gt;今回は、 Azure バックアップソリューションので利用する Recovery Services コンテナーとバックアップ コンテナーのバックアップ対象の違いに</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>ASR 自動更新に利用する Automation アカウントの Managed ID への移行方法について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureSiteRecovery/HowToChangeAzureAutomationManagedId/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureSiteRecovery/HowToChangeAzureAutomationManagedId/</id>
    <published>2023-03-14T03:00:00.000Z</published>
    <updated>2023-10-30T10:53:16.243Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>みなさんこんにちは、Azure Site Recovery サポートです。<br>今回は、Azure Site Recovery ( 以下、ASR ) にて使用される、マネージド ID の設定についてのご案内です。</p><p>ASR 自動更新には Azure Automation の実行アカウントが利用されますが、Azure Automation 実行アカウントは 2023 年 9 月 30 日に廃止されることが決まっており、マネージド ID へ移行する必要がございます。<br>2023/3/14 時点では ASR の自動更新に利用する Azure Automation を手動でマネージド ID へ移行する必要がございますので、その移行手順についてご案内いたします。</p><p>なお、今後は ASR 有効化時に自動でマネージド ID の Azure Automation が作成されるように開発部門と対応を継続しておりますので、進展がありましたら本ブログにて Update をお知らせいたします。</p><p>・マネージド ID への移行に関する公開情報<br>　<a href="https://learn.microsoft.com/ja-jp/azure/automation/migrate-run-as-accounts-managed-identity?tabs=sa-managed-identity">https://learn.microsoft.com/ja-jp/azure/automation/migrate-run-as-accounts-managed-identity?tabs=sa-managed-identity</a></p><h3 id="作業手順"><a href="#作業手順" class="headerlink" title="作業手順"></a>作業手順</h3><ol><li>Azure Portal から Recovery Services コンテナーに移動し、[概要] の JSON ビューをクリックし、ID の行に表示される /subscriptions/ から始まるリソース ID をメモします。<br>※ 手順 8 で利用します。</li></ol><p><img src="https://user-images.githubusercontent.com/96324317/224874128-5a6427e3-6899-4cf8-bfbd-024334f58aaf.png" alt="image1"></p><p><img src="https://user-images.githubusercontent.com/96324317/224874595-4ed973c2-4611-4548-8591-da9a1cb087e6.png" alt="image2"></p><ol start="2"><li>Recovery Services コンテナーの [Site Recovery インフラストラクチャ] - [拡張機能の更新の設定] 画面ご利用の Automation アカウント名をご確認ください。</li></ol><p><img src="https://user-images.githubusercontent.com/96324317/224874725-db03352c-829b-449a-ba34-88303a551f6d.png" alt="image3"></p><ol start="3"><li>手順 2 で確認した Automation アカウントに移動し、  JSON ビューをクリックし、ID の行に表示される /subscriptions/ から始まるリソース ID をメモします。<br>※ 手順 9 で利用します。</li></ol><p><img src="https://user-images.githubusercontent.com/96324317/224874882-b6ccc582-13c4-4553-9d1f-9b9e4425b6db.png" alt="image4"></p><p><img src="https://user-images.githubusercontent.com/96324317/224874916-5df9c1cb-92c0-4263-9f9c-16ece1912dd9.png" alt="image5"></p><ol start="4"><li>Automation アカウントの [ID] - [システム割り当て済み] 画面から状態が [オン] に選択されていない場合には、[オン] を選択し、[保存] をクリックします。</li></ol><p><img src="https://user-images.githubusercontent.com/96324317/224874986-a883cb50-8fe5-4f05-b0c4-4c72cdc8d2f4.png" alt="image6"></p><ol start="5"><li>Recovery Services コンテナーに戻り、[アクセス制御 (IAM)] から、Automation アカウントのマネージド ID に対して共同作成者ロールを付与します。</li></ol><p>・ロール : 共同作成者<br>・アクセスの割り当て先 : マネージド ID<br>・メンバー :Automation アカウント</p><p><img src="https://user-images.githubusercontent.com/96324317/224875166-74a13c8e-d825-4bf7-97a5-18dd1855a576.png" alt="image7"></p><p><img src="https://user-images.githubusercontent.com/96324317/224875187-021d493c-8ef9-4370-af8d-3aaedb04b611.png" alt="image8"></p><p><img src="https://user-images.githubusercontent.com/96324317/224875252-a24fbdc4-2e71-4c89-9890-7b75530eb754.png" alt="image9"></p><p><img src="https://user-images.githubusercontent.com/96324317/224875281-150ab88d-36b1-4b95-a9a2-c4a17cbc116b.png" alt="image10"></p><ol start="6"><li>Automation アカウントに戻り、[Runbook] - [Runbook の作成] から新しい Runbook を作成します。</li></ol><p><img src="https://user-images.githubusercontent.com/96324317/224875348-6f138351-c0af-43ac-bd3c-8ef25d3372f0.png" alt="image11"></p><p>・Runbook 名 : &lt;任意&gt;<br>・Runbook の種類 : PowerShell<br>・ランタイムのバージョン : 5.1</p><p><img src="https://user-images.githubusercontent.com/96324317/224875466-44010fb0-2420-4753-b804-7130434a902a.png" alt="image12"></p><ol start="7"><li>作成された Runbook に、下記 Github に公開されている UpdateAutomationAccount.ps1 の PowerShell スクリプトをコピーして貼り付け [保存] します。</li></ol><p>・PowerShell スクリプト<br>　<a href="https://github.com/AsrOneSdk/published-scripts/blob/master/automationAccount/UpdateAutomationAccount.ps1">https://github.com/AsrOneSdk/published-scripts/blob/master/automationAccount/UpdateAutomationAccount.ps1</a></p><p><img src="https://user-images.githubusercontent.com/96324317/224875619-9e10064b-923a-4fdc-a6d9-5d641a04f188.png" alt="image13"></p><ol start="8"><li>上部 [テスト ウィンドウ] からテスト画面に移動し、パラメーターを入力し [開始] をクリックします。</li></ol><p><img src="https://user-images.githubusercontent.com/96324317/224875673-cd3d487c-21bf-448c-9536-3cfecf19f2cb.png" alt="image14"></p><p>・VAULTRESOURCEID : 手順 1 で確認した Recovery Services コンテナーのリソース ID<br>・AUTOUPDATEACTION : Disabled<br>・AUTOMATIONACCOUNTARMID : 入力なし</p><p><img src="https://user-images.githubusercontent.com/96324317/224875714-04847fc0-45fc-4aae-9d61-584fbe1a9768.png" alt="image15"></p><p>完了と表示されるとテスト成功です。</p><p><img src="https://user-images.githubusercontent.com/96324317/224875759-fb94ba3e-061d-4ffe-b2b3-1407ad881b8d.png" alt="image16"></p><ol start="9"><li>パラメータ AUTOUPDATEACTION を Enabled に変更し、AUTOMATIONACCOUNTARMID にリソース ID を入力し、再度 [開始] をクリックします。</li></ol><p>・VAULTRESOURCEID : 手順 1 で確認した Recovery Services コンテナーのリソース ID<br>・AUTOUPDATEACTION : Enabled<br>・AUTOMATIONACCOUNTARMID : 手順 3 で確認した Automation アカウントのリソース ID</p><p><img src="https://user-images.githubusercontent.com/96324317/224875812-93a0ec82-db28-4b82-b5c5-dc930d084dde.png" alt="image17"></p><p>完了と表示されるとテスト成功です。</p><p><img src="https://user-images.githubusercontent.com/96324317/224875967-f561d126-42e6-4c70-9889-39f4e94793f8.png" alt="image"></p><ol start="10"><li>画面右上の [X] から画面を一度閉じ、Runbook に戻り [公開] をクリックします。</li></ol><p><img src="https://user-images.githubusercontent.com/96324317/224876010-8b07de47-3926-4233-8e3f-c188552281bc.png" alt="image"></p><ol start="11"><li>Runbook のステータスが “発行済み” になっていることを確認し、[スケジュールへのリンク] をクリックし、スケジュールを設定します。</li></ol><p><img src="https://user-images.githubusercontent.com/96324317/224876087-d5649f14-4b30-441b-8bb6-6e2b73c4b1cd.png" alt="image"></p><ol start="12"><li>[スケジュール] をクリックし、既存のスケジュールを利用するか新規スケジュールを作成します。<br>※ 既定では 0:00 に毎日ジョブが実行され、最新バージョンでない保護されたアイテムがある場合に ASR モビリティ サービス エージェントを更新する処理がトリガーされます。</li></ol><p><img src="https://user-images.githubusercontent.com/96324317/224876152-99f45670-ee44-4220-8127-a976ab9fe546.png" alt="image"></p><p>新規スケジュールを作成する場合には、任意のスケジュールを設定します。<br>例えば、日本時刻 0:00 に毎日ジョブを実行する場合、下記のように入力します。</p><p><img src="https://user-images.githubusercontent.com/96324317/224876230-77381459-a13e-45d2-a89f-16d85f54d8b8.png" alt="image"></p><ol start="13"><li>[パラメーターと実行設定] をクリックし、手順 9 で入力したパラメータを以下の通り再度入力し [OK] をクリックします。</li></ol><p>・VAULTRESOURCEID : 手順 1 で確認した Recovery Services コンテナーのリソース ID<br>・AUTOUPDATEACTION : Enabled<br>・AUTOMATIONACCOUNTARMID : 手順 3 で確認した Automation アカウントのリソース ID</p><p><img src="https://user-images.githubusercontent.com/96324317/224876291-5fab5687-0573-484c-b369-d26907b94b0d.png" alt="image"></p><p><img src="https://user-images.githubusercontent.com/96324317/224876315-d42595ed-2813-4fd4-99c0-163c6b9d4705.png" alt="image"></p><p>上記作業が完了したら、次のスケジュール日時からマネージド ID を使用した Runbook にて更新ジョブが実行されます。</p><p>ASR にて使用される、マネージド ID 設定の案内は、以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;みなさんこんにちは、Azure Site Recovery サポートです。&lt;br&gt;今回は、Azure Site Recovery ( 以下、ASR ) にて使用される、マネージド ID の設定についてのご案内です。&lt;/p&gt;
&lt;</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure Site Recovery" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Site-Recovery/"/>
    
  </entry>
  
  <entry>
    <title>Azure Disk Backup を意図的に失敗させる方法</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureDiskBackup/How_to_fail_Asure_Disk_backup/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureDiskBackup/How_to_fail_Asure_Disk_backup/</id>
    <published>2023-01-11T03:00:00.000Z</published>
    <updated>2023-10-30T10:53:16.227Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>アラートのテスト等のため “Azure Disk Backup を失敗させたい” というお問い合わせをよくいただきます。<br>今回は、Azure Disk Backup を意図的に失敗させる方法として、Azure Disk Backup 構成したディスクを削除して、バックアップ ジョブを失敗させる方法をご紹介いたします。</p><p>・Azure ディスク バックアップの概要<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-overview">https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-overview</a></p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Azure Disk Backup を意図的に失敗させる方法</a><br><a href="#2">2. その他ブログで公開している Azure Backup の失敗方法</a></p><hr><h3 id="1-Azure-Disk-Backup-を意図的に失敗させる方法"><a href="#1-Azure-Disk-Backup-を意図的に失敗させる方法" class="headerlink" title=" 1. Azure Disk Backup を意図的に失敗させる方法"></a><a id="1"></a> 1. Azure Disk Backup を意図的に失敗させる方法</h3><p>(1) とある Azure Managed Disk に対して、Azure Disk Backup を構成し、バックアップ取得しておきます。</p><p>・Azure Managed Disks のバックアップ<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-managed-disks">https://learn.microsoft.com/ja-jp/azure/backup/backup-managed-disks</a></p><p>下図は例として、Azure Managed Disk「tmpDiskforAzureDiskBackup01」を Azure Disk Backup にてバックアップ構成している状態です。<br><img src="https://user-images.githubusercontent.com/96324317/211466707-79d9b00e-4aef-44ee-96be-a1b8a9c4fd4f.png" alt="バックアップ構成済"></p><p>アラートが生成されることを確認するため、今回は「Azure Monitor を使用した組み込みのアラート」を、「スコープ：Azure Disk Backup を構成しているバックアップ コンテナー」にて構成しています。</p><p>・Azure Backup の Azure Monitor アラート<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults#azure-monitor-alerts-for-azure-backup">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-built-in-monitor?tabs=recovery-services-vaults#azure-monitor-alerts-for-azure-backup</a></p><p>・「Azure Monitor を使用した組み込みのアラート」を利用したバックアップ ジョブ失敗のアラート通知作成例<br>　<a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/How_to_set_Backup_Alert/">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/How_to_set_Backup_Alert/</a></p><p><img src="https://user-images.githubusercontent.com/96324317/211467521-063fe1a2-4480-4191-b7cc-8caad114dbb8.png" alt="アラート 処理ルール"></p><p>(2) バックアップ構成した Azure Managed Disk リソースを削除します。<br><img src="https://user-images.githubusercontent.com/96324317/211467577-a01b51c5-a837-4816-b6d8-8a7625667485.png" alt="ディスク削除01"></p><p><img src="https://user-images.githubusercontent.com/96324317/211467614-9a5f9cc7-743b-4e08-8497-923fe41a6f09.png" alt="ディスク削除02"></p><p>(3) Azure Disk Backup の「今すぐバックアップ」を実行します。</p><p><img src="https://user-images.githubusercontent.com/96324317/211467662-9e0fa822-6330-4f9f-b078-c5acaf0ccefb.png" alt="今すぐバックアップ"></p><p>(4) 約 1 - 2 分後に、バックアップ ジョブが「UserErrorManagedDiskNotFound」エラーにて失敗します。<br><img src="https://user-images.githubusercontent.com/96324317/211467719-ddb8638a-3527-4c8f-bda2-20c97c37ade1.png" alt="バックアップ ジョブ01"></p><p><img src="https://user-images.githubusercontent.com/96324317/211467751-01b098ab-7af6-43bb-a1ed-c9c24838d0c2.png" alt="バックアップ ジョブ02"></p><p>(5) 「Azure Monitor を使用した組み込みのアラート」などのアラートにて、アラートを構成/メール通知構成をしていれば、下図のようなメールにてアラートが通知されます。<br><img src="https://user-images.githubusercontent.com/96324317/211467800-547d8351-3bd6-47f5-b0ca-7b475d0b7542.png" alt="アラート メール"></p><h3 id="2-その他ブログで公開している-Azure-Backup-の失敗方法"><a href="#2-その他ブログで公開している-Azure-Backup-の失敗方法" class="headerlink" title=" 2. その他ブログで公開している Azure Backup の失敗方法"></a><a id="2"></a> 2. その他ブログで公開している Azure Backup の失敗方法</h3><p>・Azure VM Backup を意図的に失敗させる方法<br>　<a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/">https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/</a></p><p>・Azure VM Backup のデータ転送フェーズを意図的に失敗させる方法<br>　<a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_ttv/">https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_ttv/</a></p><p>・MARS バックアップ を意図的に失敗させる方法<br>　<a href="https://jpabrs-scem.github.io/blog/MARSBackup/How_to_fail_MARS_backup/">https://jpabrs-scem.github.io/blog/MARSBackup/How_to_fail_MARS_backup/</a></p><p>・Azure Files Backup を意図的に失敗させる方法<br>　<a href="https://jpabrs-scem.github.io/blog/AzureFilesBackup/How_to_fail_AFS_backup/">https://jpabrs-scem.github.io/blog/AzureFilesBackup/How_to_fail_AFS_backup/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;アラートのテスト等のため “Azure Disk Backup を失敗させたい” というお問い合わせをよくいただきます。&lt;br&gt;今回は、Azure Disk Ba</summary>
      
    
    
    
    
    <category term="Azure Disk Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Disk-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup のジョブ前後で任意の処理を行いたい</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToConfigureOptionalProcess/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToConfigureOptionalProcess/</id>
    <published>2023-01-11T03:00:00.000Z</published>
    <updated>2023-10-30T10:53:16.247Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Backup サポートです。<br>今回は、よくお問い合わせをいただく、下記 2 種類をお客様要件で実現されたい場合について、ご説明します。<br>１．何らかの処理 (ジョブ・サービス) が終了したあとに ⇒ Azure VM Backup を開始させたいが、Azure Backup としてそのような機能の用意があるか？<br>２．Azure VM Backup のジョブが成功したあとに ⇒ 何らかの処理 (ジョブ・サービス) を開始させたいが、Azure Backup としてそのような機能の用意があるか？</p><p>結論から申し上げますと、上記１．２．どちらも実現できるようなものは、残念ながら Azure VM Backup としては特定の機能のご用意がございません。<br>考えられる案や考慮事項がありますので、詳しく説明します。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. 何らかの処理 (ジョブ・サービス) が終了したあとに ⇒ Azure VM Backup を開始させたいが、Azure Backup としてそのような機能の用意があるか？</a><br><a href="#2">2. バックアップ ポリシーに従って取得済の復元ポイントの中の、特定の復元ポイントのみの保持期間を延長して保持しておくことは可能か</a></p><hr><h2 id="1-何らかの処理-ジョブ・サービス-が終了したあとに-⇒-Azure-VM-Backup-を開始させたいが、Azure-Backup-としてそのような機能の用意があるか？"><a href="#1-何らかの処理-ジョブ・サービス-が終了したあとに-⇒-Azure-VM-Backup-を開始させたいが、Azure-Backup-としてそのような機能の用意があるか？" class="headerlink" title="1. 何らかの処理 (ジョブ・サービス) が終了したあとに ⇒ Azure VM Backup を開始させたいが、Azure Backup としてそのような機能の用意があるか？"></a>1. 何らかの処理 (ジョブ・サービス) が終了したあとに ⇒ Azure VM Backup を開始させたいが、Azure Backup としてそのような機能の用意があるか？<a id="1"></a></h2><h3 id="〈バックアップ対象が-Linux-OS-の-Azure-仮想マシンの場合〉"><a href="#〈バックアップ対象が-Linux-OS-の-Azure-仮想マシンの場合〉" class="headerlink" title="〈バックアップ対象が Linux OS の Azure 仮想マシンの場合〉"></a>〈バックアップ対象が Linux OS の Azure 仮想マシンの場合〉</h3><p>対象 Azure 仮想マシン内に、事前スクリプト・事後スクリプトを貴社にて構築させることによって可能です。<br>事前・事後スクリプトは、元々 Linux OS の仮想マシンを、アプリケーション整合性にて取得したい場合に組み込むものでございます。</p><h4 id="処理概要"><a href="#処理概要" class="headerlink" title="(処理概要)"></a>(処理概要)</h4><p>（０）事前準備として、事前/事後スクリプトを構成しておく<br>（１）バックアップ ポリシーに従ってAzure VM Backup (スケジュール バックアップ) を開始させる<br>（２）Azure VM Backup 処理内で事前スクリプトが起動<br>（３）事前スクリプト内にて、【★ご要件の何らかの処理 (ジョブ・サービス) 】が正常終了しているかどうかを確認する<br>（４）★が正常終了している場合は、事前スクリプトを終了させ、Azure VM Backup の処理 (スナップショット取得) を続ける<br>（５）スナップショット取得処理終了後、事後スクリプト開始・終了<br>（６）Azure VM Backup のジョブ自体がすべて終了</p><p>事前/事後スクリプト構成詳細は以下公開ドキュメントをご参考ください。<br>・Linux VM のアプリケーション整合性バックアップ - Azure Backup | Microsoft Docs<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-linux-app-consistent#steps-to-configure-pre-script-and-post-script">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-linux-app-consistent#steps-to-configure-pre-script-and-post-script</a></p><h3 id="〈バックアップ対象が-Windows-OS-の-Azure-仮想マシンの場合〉"><a href="#〈バックアップ対象が-Windows-OS-の-Azure-仮想マシンの場合〉" class="headerlink" title="〈バックアップ対象が Windows OS の Azure 仮想マシンの場合〉"></a>〈バックアップ対象が Windows OS の Azure 仮想マシンの場合〉</h3><p>Azure Backup としては、残念ながら機能のご用意がございません。</p><h3 id="〈そのほかの案〉"><a href="#〈そのほかの案〉" class="headerlink" title="〈そのほかの案〉"></a>〈そのほかの案〉</h3><p>Linux / Winodws OS に関わらず、その他考えられる案としては下記が挙げられます。</p><h4 id="〈案-1-〉"><a href="#〈案-1-〉" class="headerlink" title="〈案 1 〉"></a>〈案 1 〉</h4><p>お客様にてスクリプトを構成し、スクリプト内部にて【★ご要件の何らかの処理 (ジョブ・サービス) 】が終了したことを確認後、Azure VM Backup をトリガーする。<br>(処理概要)<br>（１）【★ご要件の何らかの処理 (ジョブ・サービス) 】を開始・正常終了させる<br>（２）お客様にてスクリプトを構成し、スクリプト内にて、★が正常終了していることを確認する<br>（３）スクリプト内から Azure VM Backup を「オンデマンド バックアップ」としてトリガーさせる<br>　＋　バックアップ ポリシーにて、週に 1 回スケジュール バックアップを実行させるよう構成する。(※)<br>　＋　週に 1 度はスケジュール バックアップを実行させる。</p><p>コマンドラインからバックアップを実行する場合は必ず「オンデマンド バックアップ (今すぐバックアップ) 」というバックアップの種類となります。<br>Azure VM Backup では、Azure CLI ・Azure PowerShell コマンドなどを用いてオンデマンド バックアップをトリガーすることが可能です。</p><p>・クイックスタート - PowerShell で VM をバックアップする - Azure Backup | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/quick-backup-vm-powershell#start-a-backup-job">https://learn.microsoft.com/ja-jp/azure/backup/quick-backup-vm-powershell#start-a-backup-job</a></p><p>・クイックスタート - Azure CLI で VM をバックアップする - Azure Backup | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/quick-backup-vm-cli#start-a-backup-job">https://learn.microsoft.com/ja-jp/azure/backup/quick-backup-vm-cli#start-a-backup-job</a></p><p>(※) 以下ブログに記載の通り、スケジュールされたバックアップを週に 1 度は実行いただきたい理由がございますので、ブログ説明もご参照いただけますと幸いです。<br>・Azure VM バックアップを任意のタイミングのみで取得したい | Japan CSS ABRS &amp; SCEM Support Blog (jpabrs-scem.github.io)<br>　<a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/invalid_schedule/">https://jpabrs-scem.github.io/blog/AzureVMBackup/invalid_schedule/</a></p><p>また、〈案 1 〉のスクリプト構成は、Azure Automation にて展開している Runbook の機能を使って構成することも可能です。<br>下記に、Runbook のスケジュール説明も含めた Azure Automation の参考ドキュメントがございますので、ご参考いただけますと幸いです。<br>・Azure Automation で Runbook を管理する | Microsoft Docs<br>　<a href="https://learn.microsoft.com/ja-jp/azure/automation/manage-runbooks">https://learn.microsoft.com/ja-jp/azure/automation/manage-runbooks</a></p><p>なお、 Azure Automation ならびに Runbook に関するご質問がございます場合には、弊社サポート サービスまでお問合せいただけますと幸いです。</p><h4 id="〈案-2-〉"><a href="#〈案-2-〉" class="headerlink" title="〈案 2 〉"></a>〈案 2 〉</h4><p>★が確実に終了している時間帯に、バックアップポリシーに従って、Azure VM Backup （スケジュール バックアップ）を 開始させるよう、バックアップ ポリシーの開始時間を設定しておく。<br>この場合、〈案 1 〉のブログに記載している「Garbage Collection」の問題は (必ずスケジュール バックアップを実行させているため) 回避できますが、★の成功・失敗に関わらず、バックアップ ポリシーに従って必ず Azure VM Backup が開始される、という懸念点がございます。</p><h2 id="2-Azure-VM-Backup-のジョブが成功したあとに-⇒-何らかの処理-ジョブ・サービス-を開始させたいが、Azure-Backup-としてそのような機能の用意があるか？"><a href="#2-Azure-VM-Backup-のジョブが成功したあとに-⇒-何らかの処理-ジョブ・サービス-を開始させたいが、Azure-Backup-としてそのような機能の用意があるか？" class="headerlink" title="2. Azure VM Backup のジョブが成功したあとに ⇒ 何らかの処理 (ジョブ・サービス) を開始させたいが、Azure Backup としてそのような機能の用意があるか？"></a>2. Azure VM Backup のジョブが成功したあとに ⇒ 何らかの処理 (ジョブ・サービス) を開始させたいが、Azure Backup としてそのような機能の用意があるか？<a id="2"></a></h2><p>残念ながら、Azure Backup サービスの単体としては機能のご用意がございませんこと、お伝えいたします。<br>そのうえで、考えられる案としては下記がございます。</p><h3 id="〈案-3-〉"><a href="#〈案-3-〉" class="headerlink" title="〈案 3 〉"></a>〈案 3 〉</h3><p>Azure VM Backup のバックアップ ジョブ ステータスを確認するコマンドにてバックアップ ジョブのステータスを確認後、【★ご要件の何らかの処理 (ジョブ・サービス) 】を開始させるるようなスクリプトをお客様にて構成する。</p><h4 id="処理概要-1"><a href="#処理概要-1" class="headerlink" title="(処理概要)"></a>(処理概要)</h4><p>（１）Azure VM Backup のスケジュール バックアップが開始<br>（２）お客様にて別途実装されたスクリプトを起動する<br>（３）スクリプト内で、バックアップ ジョブのステータスを確認するコマンドを実行し「Take Snapshot」フェーズが「Completed」となっているかどうか確認する<br>（４）スクリプト内で、「Take Snapshot : Completed」となっていることを確認したら、★を開始させる</p><p>Azure VM Backup のバックアップ ジョブには「Take Snapshot」フェーズと、「Transfer data to vault」フェーズという、2 つのフェーズで構成されています。<br>1 つ目の「Take Snapshot」フェーズが「完了 Completed」となれば、Azure 仮想マシンの再起動含めた その他★の作業を実施いただいて構いません。</p><p>・Azure VM Backup における Take Snapshot フェーズの確認方法 | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br>　<a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_check_VM_backup_Subtask/">https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_check_VM_backup_Subtask/</a></p><h3 id="Azure-VM-Backup-はバックアップ-ポリシー通りの時間に開始されるのか？"><a href="#Azure-VM-Backup-はバックアップ-ポリシー通りの時間に開始されるのか？" class="headerlink" title="Azure VM Backup はバックアップ ポリシー通りの時間に開始されるのか？"></a>Azure VM Backup はバックアップ ポリシー通りの時間に開始されるのか？</h3><p>通常、バックアップ ポリシーにて設定した時間のおよそ 5 分～ 20 分以内程でバックアップ ジョブが開始いたしますが、最大では 2 時間以内にバックアップ ジョブを開始するしくみとなっております。</p><p>・自分の VM バックアップ ポリシーで設定した、スケジュールされたバックアップ時刻からバックアップ開始時刻までの最大遅延時間はどれぐらいですか。<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#----vm-----------------------------------------------------------------">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#----vm-----------------------------------------------------------------</a><br>　“スケジュールされたバックアップは、スケジュールされたバックアップ時刻から 2 時間以内にトリガーされます。”</p><h3 id="Azure-VM-Backup-は通常どれくらいの時間でバックアップ-ジョブが終了するのか？"><a href="#Azure-VM-Backup-は通常どれくらいの時間でバックアップ-ジョブが終了するのか？" class="headerlink" title="Azure VM Backup は通常どれくらいの時間でバックアップ ジョブが終了するのか？"></a>Azure VM Backup は通常どれくらいの時間でバックアップ ジョブが終了するのか？</h3><p>初回バックアップ以降の、毎回のバックアップ ジョブが完了するまでの時間は最大 24 時間以内となっております。<br>リストアやバックアップにかかる時間については、恐縮ながら弊社としては指標を出しておりません。<br>Azure サービスはマルチテナント サービスであるため、バックアップ アイテム (VM) のデータサイズのみではなく、他のリソース、他のユーザー様の稼働状況、帯域の状況などにも処理時間は左右されるためでございます。<br>一方、「Take Snapshot」フェーズのみについて言及しますと、こちらも「必ず〇分に終わる」というベンチマークなどは公開いたしておりませんが、基本的には 5 – 15 分程度で「Take Snapshot」フェーズは完了することが多くございます。</p><p>・初回バックアップの完了に時間がかかるのはなぜですか?<br>　<a href="https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#-------------------------">https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#-------------------------</a><br>　“増分バックアップの合計バックアップ時間は 24 時間未満ですが、初回バックアップではそうはならないことがあります。”</p><p>・Azure Backup での自動化 - Azure Backup | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/automation-backup">https://learn.microsoft.com/ja-jp/azure/backup/automation-backup</a></p><p>・Azure Backup の バックアップ / リストア 所要時間について<br>　<a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/Backup_RecoveryTIme/">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/Backup_RecoveryTIme/</a></p><h3 id="〈注意事項〉"><a href="#〈注意事項〉" class="headerlink" title="〈注意事項〉"></a>〈注意事項〉</h3><p>Linux OS に対する事前/事後スクリプトの実装や、スクリプトの構成についてはお客様の責任のもと、お客様に検証のうえ、実装いただきますようご留意くださいませ。<br>Azure サポートでは主に Post Production の Break &amp; Fix を担当しており、スクリプトのコードレビューのサポートは承っておりませんので、ご理解をいただけますと幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、よくお問い合わせをいただく、下記 2 種類をお客様要件で実現されたい場合について、ご説明します。&lt;br&gt;１．何らかの処理 (ジョブ・サービス) が終了したあと</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
</feed>
