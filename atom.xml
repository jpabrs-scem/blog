<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan CSS ABRS  Support Blog !!</title>
  
  <subtitle>Azure Backup , Azure Site Recovery , Azure Migrate に関するサポート情報を発信します。</subtitle>
  <link href="https://jpabrs-scem.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpabrs-scem.github.io/blog/"/>
  <updated>2026-01-29T02:14:33.186Z</updated>
  <id>https://jpabrs-scem.github.io/blog/</id>
  
  <author>
    <name>Japan CSS ABRS &amp; SCEM Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>停止状態で VM を復元する方法</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToRestoreVmsInStoppedStates/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToRestoreVmsInStoppedStates/</id>
    <published>2026-01-20T03:00:00.000Z</published>
    <updated>2026-01-29T02:14:33.186Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポート チームです。<br>今回は、<strong>Azure VM Backup において、停止状態で VM を復元する方法</strong> についてご紹介します。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. 概要</a><br><a href="#2">2. 「新しい仮想マシンの作成」で復元した際の挙動</a><br><a href="#3">3. 停止状態で復元したい場合の代替策</a><br><a href="#3-1">3-1. 「既存の置換」オプションを利用する</a><br><a href="#3-2">3-2. 別ネットワークへ新規作成して影響を隔離する</a></p><hr><h2 id="1-概要"><a href="#1-概要" class="headerlink" title="1. 概要"></a><a id="1"></a>1. 概要</h2><p>Azure VM Backup では、復元時に「新しい仮想マシンの作成」オプションを選択すると、復元された VM は自動的に実行状態になります。<br>一方で、「復元後の VM は停止状態にしたい」というご要望をいただくことがあります。</p><p>結論から申し上げますと、<strong>停止状態で新規 VM を復元することはかないません</strong>。</p><p>本記事では、代替案を 2 つご紹介します。</p><h2 id="2-「新しい仮想マシンの作成」で復元した際の挙動"><a href="#2-「新しい仮想マシンの作成」で復元した際の挙動" class="headerlink" title="2. 「新しい仮想マシンの作成」で復元した際の挙動"></a><a id="2"></a>2. 「新しい仮想マシンの作成」で復元した際の挙動</h2><p>はじめに、<strong>「新しい仮想マシンの作成」オプション</strong>を選択して VM を復元した場合の挙動を確認します。<br><img src="/blog/AzureVMBackup/HowToRestoreVmsInStoppedStates/2_restore.png"></p><p>この方法では、新しい VM を作成できますが、VM は実行状態で復元されます。<br><img src="/blog/AzureVMBackup/HowToRestoreVmsInStoppedStates/2_restoredVm.png"></p><p>復元完了後に手動で停止することは可能ですが、「停止状態で復元する」ことは現時点 (2026 年 1 月時点) ではかないません。</p><h2 id="3-停止状態で復元したい場合の代替策"><a href="#3-停止状態で復元したい場合の代替策" class="headerlink" title="3. 停止状態で復元したい場合の代替策"></a><a id="3"></a>3. 停止状態で復元したい場合の代替策</h2><p>「VM を停止状態で復元したい場合」の 2 つの代替案をご紹介します。</p><ol><li>「既存の置換」オプションを利用する</li><li>別ネットワークへ新規作成して影響を隔離する</li></ol><h3 id="3-1-「既存の置換」オプションを利用する"><a href="#3-1-「既存の置換」オプションを利用する" class="headerlink" title="3-1. 「既存の置換」オプションを利用する"></a><a id="3-1"></a>3-1. 「既存の置換」オプションを利用する</h3><p>一つ目は、<strong>「既存を置換」オプション</strong>を選択して VM を復元する方法です。<br><img src="/blog/AzureVMBackup/HowToRestoreVmsInStoppedStates/3_1_restore.png"><br>この方法で復元すると、バックアップ元の VM は上書きされますが、VM は停止状態で復元することができます。<br>なお「既存を置換」オプションを利用する場合、<strong>バックアップ元の VM は事前に停止しておく</strong>必要がございます。</p><h3 id="3-2-別ネットワークへ新規作成して影響を隔離する"><a href="#3-2-別ネットワークへ新規作成して影響を隔離する" class="headerlink" title="3-2. 別ネットワークへ新規作成して影響を隔離する"></a><a id="3-2"></a>3-2. 別ネットワークへ新規作成して影響を隔離する</h3><p>二つ目は、<strong>別ネットワークに</strong>新規 VM として復元する方法です。<br>「VM を復元してバックアップ データを確かめたいが、バックアップ元であった VM 上に復元することによって、予期せぬ影響が出るのを避けたい」といったニーズの場合、この代替案を推奨いたします。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>この方法では、新規 VM を停止状態で復元することはできません。予めご注意ください。</p></div><p>まず、「仮想ネットワーク」 → 「作成」より、新しく仮想ネットワークを作成してください。</p><p>仮想ネットワーク作成後、サブネットに対して、 ネットワーク セキュリティ グループを追加し、外部（Outbound）への接続を「拒否」するルールを付与しておきます。<br>これによって、このサブネット上に配置されるVMは、サブネット上から外部への接続ができなくなります。</p><ul><li>(参考) ネットワーク セキュリティ グループの作成<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/manage-network-security-group?tabs=network-security-group-portal#create-a-network-security-group">https://learn.microsoft.com/ja-jp/azure/virtual-network/manage-network-security-group?tabs=network-security-group-portal#create-a-network-security-group</a></li></ul><p>次に、VM の復元において、新しく作成した仮想ネットワークを選択したうえで、新規 VM の作成をしてください。<br><img src="/blog/AzureVMBackup/HowToRestoreVmsInStoppedStates/3_2_restore.png"></p><p>この方法で復元すると、作られる VM は実行状態となりますが、別の仮想ネットワークに作成されます。<br>そのため、元々のバックアップ対象である VM に極力影響を与えることなく、バックアップ データをご確認いただけます。</p><p>Azure VM のデータを復元する方法の詳細につきましては、以下の公式ドキュメントをご確認ください。</p><ul><li>(参考) Azure Backup を使用して Azure portal を使用して VM を復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポート チームです。&lt;br&gt;今回は、&lt;strong&gt;Azure VM Backup において、停止状態で VM を復元する方法&lt;/strong&gt; についてご紹介します。&lt;/p&gt;
&lt;h</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>ASR フェールオーバー前後で変更されるマシン上の情報について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureSiteRecovery/whatchangedafterfailover/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureSiteRecovery/whatchangedafterfailover/</id>
    <published>2026-01-19T03:00:00.000Z</published>
    <updated>2026-01-29T02:14:33.128Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>みなさんこんにちは、Azure Site Recovery サポートです。</p><p>今回は Azure Site Recovery (もしくは Azure Migrate) を利用して、マシンを Azure VM としてフェールオーバーした際に、マシン上で変更される情報と、そのまま変わらず引き継がれる情報を説明します。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. フェールオーバー前後で変更される情報</a><br><a href="#2">2. IP アドレスについて</a><br><a href="#3">3. UUID (GUID) について</a><br><a href="#4">4. MAC アドレスについて</a><br><a href="#5">5. SID について</a><br><a href="#6">6. ホスト名、Azure VM 名について</a></p><hr><h2 id="1-フェールオーバー前後で変更される情報"><a href="#1-フェールオーバー前後で変更される情報" class="headerlink" title=" 1. フェールオーバー前後で変更される情報"></a><a id="1"></a> 1. フェールオーバー前後で変更される情報</h2><ul><li>オンプレミス環境上のマシン</li><li>VMWare VM 上のマシン</li><li>Azure VM</li></ul><p>上記いずれかを、Azure VM としてフェールオーバーした際に、Azure VM 上で変わるものと、変わらずにそのままソース マシン上の情報を引き継ぐものをまとめました。</p><ul><li><p><strong>フェールオーバー前後で<font color="Blue">変わらない情報</font></strong><br><font color="Blue">プライベート IP アドレス<br>一時ディスク以外のディスクの UUID (GUID)<br>SID<br>ホスト名<br>Azure VM 名</font></p></li><li><p><strong>フェールオーバー済 Azure VM 上で<font color="DeepPink">変わる情報</font></strong><br><font color="DeepPink">パブリック IP アドレス<br>MAC アドレス<br>一時ディスクの UUID (GUID)</font></p></li></ul><p>SID や マシンのホスト名が変わらない理由は、 Azure Site Recovery (もしくは Azure Migrate) は、マシン固有の情報やアカウントを削除するプロセス (sysprep のような一般化のプロセス) は行わないためです。<br>下記、それぞれの項目について補足します。</p><h2 id="2-IP-アドレスについて"><a href="#2-IP-アドレスについて" class="headerlink" title=" 2. IP アドレスについて"></a><a id="2"></a> 2. IP アドレスについて</h2><ul><li><p>パブリック IPアドレス<br>フェールオーバー元となる、レプリケート対象のソース マシンと比べて、フェールオーバーされる Azure VM 上のパブリック IPアドレスは変更されます。</p></li><li><p>プライベート IPアドレス<br>ソース マシンと同じアドレスをフェールオーバー VM 上でも維持することが可能です。<br>ただし、フェールオーバー先の Azure Vnet に同じ IP アドレス空間のサブネットを用意いただく必要があります。</p></li></ul><p>なお、フェールオーバーされた Azure VM が、オンプレミスのソース マシンと同じ IP アドレス/サブネットを使用する場合は、アドレスが重複しているため、サイト間 VPN 接続または ExpressRoute を使用して、それらを接続することはできませんので、ご注意ください。</p><p>フェールオーバー後も、同一のプライベート IP アドレスを設定する手順は、以下公開情報をご参照ください。</p><ul><li><p>(参考) 内部アドレスの割り当て<br><a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/concepts-on-premises-to-azure-networking#assign-an-internal-address">https://learn.microsoft.com/ja-jp/azure/site-recovery/concepts-on-premises-to-azure-networking#assign-an-internal-address</a></p></li><li><p>(参考) Azure Site Recovery | Azure to Azure | サポート マトリックス | IP アドレス<br><a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/azure-to-azure-support-matrix#replicated-machines-networking">https://learn.microsoft.com/ja-jp/azure/site-recovery/azure-to-azure-support-matrix#replicated-machines-networking</a></p></li><li><p>(参考) フェールオーバー時に IP アドレスを保持する<br><a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/site-recovery-retain-ip-azure-vm-failover">https://learn.microsoft.com/ja-jp/azure/site-recovery/site-recovery-retain-ip-azure-vm-failover</a></p></li></ul><h2 id="3-UUID-GUID-について"><a href="#3-UUID-GUID-について" class="headerlink" title=" 3. UUID (GUID) について"></a><a id="3"></a> 3. UUID (GUID) について</h2><p>Linux OS / Windows OS どちらの環境においても、フェールオーバー前後でディスク・パーティションの UUID (GUID) は変わりません。<br>しかし、Azure VM にもともとアタッチされている「一時ディスク」については、フェールオーバーすると UUID (GUID) は変化します。<br>なお、Azure Site Recovery では Azure VM 上の一時ディスクに対しては、レプリケート対象ではなく、非サポートとなっております。<br>このため、レプリケートを希望する重要なデータを Azure VM の一時ディスク上には保管しないでください。</p><ul><li>(参考) Azure Site Recovery | Azure to Azure | サポート マトリックス | 一時ディスク<br><a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/azure-to-azure-support-matrix#replicated-machines-storage">https://learn.microsoft.com/ja-jp/azure/site-recovery/azure-to-azure-support-matrix#replicated-machines-storage</a><br><img src="/blog/AzureSiteRecovery/whatchangedafterfailover/001.png"></li></ul><div class="alert is-success"><p class="alert-title">ヒント</p><p>Linux OS (RHEL) の場合、RHEL では、/dev/disk/by-uuid 上で UUID / GUID を確認可能です。</p><p>Azure VM (Linux OS) の一時ディスクは、通常 /dev/sdb にマウントされています。</p><p></br></p><p>Windows OS の場合、mountvol コマンド使って UUID / GUID を確認可能です。</p><p>Azure VM (Windows OS) の一時ディスクは、既定で D: となります。</p></div><h2 id="4-MAC-アドレスについて"><a href="#4-MAC-アドレスについて" class="headerlink" title=" 4. MAC アドレスについて"></a><a id="4"></a> 4. MAC アドレスについて</h2><p>Azure VM として、フェールオーバー VM が作成されるたびに、新しい Azure NIC が作成・付与されます。<br>この NIC の情報には MAC アドレスも含まれているため、MAC アドレスも変わることとなります。</p><p>Windows OS の場合、ipconfig/all コマンドにて MAC アドレスを確認ができます。</p><p>(例)<br><img src="/blog/AzureSiteRecovery/whatchangedafterfailover/002.png"></p><h2 id="5-SID-について"><a href="#5-SID-について" class="headerlink" title=" 5. SID について"></a><a id="5"></a> 5. SID について</h2><p>Azure Site Recovery の仕様上、フェールオーバー前後の SID は同様となります。<br>予期せぬ問題が発生しないよう、Azure Site Recovery (Azure Migrate)  観点では、下記を推奨しています。</p><ul><li><span style="color: red; ">ソース マシンをシャットダウンした状態で、フェールオーバーすること</span></li><li><span style="color: red; ">ソース マシンとフェールオーバー Azure VM が、それぞれ通信できないよう、ネットワークが分離された Vnet 上へまず「テスト フェールオーバー」して、動作確認すること</span></li></ul><ul><li><p>(参考) テスト フェールオーバー用のネットワークの作成<br><a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/site-recovery-test-failover-to-azure#create-a-network-for-test-failover">https://learn.microsoft.com/ja-jp/azure/site-recovery/site-recovery-test-failover-to-azure#create-a-network-for-test-failover</a></p></li><li><p>(参考) Active Directory と DNS のディザスター リカバリーを設定する | テスト フェールオーバーの考慮事項<br><a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/site-recovery-active-directory#test-failover-considerations">https://learn.microsoft.com/ja-jp/azure/site-recovery/site-recovery-active-directory#test-failover-considerations</a></p></li></ul><p>なお、sysprep を利用しない状態で、同じ Active Directory ネットワーク内で SID が重複するマシンが同時に起動している状態は、Windows OS としてはサポートされない構成となります。</p><h2 id="6-ホスト名、Azure-VM-名について"><a href="#6-ホスト名、Azure-VM-名について" class="headerlink" title="6. ホスト名、Azure VM 名について"></a><a id="6"></a>6. ホスト名、Azure VM 名について</h2><p>ソース マシンと同じホスト名の Azure VM がフェールオーバー VM として新規作成されます。</p><ul><li>(参考) Azure VM のホスト名を表示する<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-viewing-and-modifying-hostnames#view-hostnames">https://learn.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-viewing-and-modifying-hostnames#view-hostnames</a></li></ul><p>※ 「Azure VM 名」と「ホスト名」は異なりますので、混同しないようにご注意ください。</p><p>Azure VM 名は、レプリケートを構成する際に、ソース マシンと同名にすることも、異なる名前にすることも、どちらも可能です。<br><img src="/blog/AzureSiteRecovery/whatchangedafterfailover/003.png"></p><p>本記事の内容は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;みなさんこんにちは、Azure Site Recovery サポートです。&lt;/p&gt;
&lt;p&gt;今回は Azure Site Recovery (もしくは Azure Migrate) を利用して、マシンを Azure VM として</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure Site Recovery" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Site-Recovery/"/>
    
  </entry>
  
  <entry>
    <title>ログ バックアップのジョブを確認する方法</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/How_To_Check_Log_Backup_Jobs/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/How_To_Check_Log_Backup_Jobs/</id>
    <published>2025-12-29T07:00:00.000Z</published>
    <updated>2026-01-29T02:14:32.969Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートです。<br> 今回はお問合せをいただくことが多い、Azure Backup による SQL Server DB や SAP HANA DB のログ バックアップのジョブを確認する方法をご案内いたします。  </p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. 概要</a><br><a href="#2">2. 設定方法</a><br><a href="#3">3. ログ バックアップのジョブの確認方法</a>  </p><hr><h2 id="1-概要"><a href="#1-概要" class="headerlink" title=" 1. 概要"></a><a id="1"></a> 1. 概要</h2><p>Azure Backup による SQL Server DB や SAP HANA DB のログ バックアップのジョブは、実行回数が比較的多くなる傾向にあるため、<strong>Azure Portal の Recovery Services コンテナーや回復性 (Resiliency, ビジネス継続センター) のバックアップ ジョブ一覧には表示されません</strong>。  </p><p>ログ バックアップのジョブをご確認いただくには、Recovery Services コンテナーの診断設定を構成し、Recovery Services コンテナーの診断イベントを Log Analytics ワークスペースへ送信していただく必要がございます。  </p><h2 id="2-設定方法"><a href="#2-設定方法" class="headerlink" title=" 2. 設定方法"></a><a id="2"></a> 2. 設定方法</h2><p>ご利用の Recovery Services コンテナーの診断設定を構成する方法をご案内いたします。  </p><ul><li><ol><li>Azure Portal にてご利用の Recovery Services コンテナーを表示します  </li></ol></li><li><ol start="2"><li>Recovery Services コンテナーの [監視] &gt; [診断設定] &gt; [診断設定を追加する]  を選択します<br><img src="/blog/AzureBackupGeneral/How_To_Check_Log_Backup_Jobs/Setting_Rsv_diagnostics_01.png"></li></ol></li><li><ol start="3"><li>診断設定画面にて、まず [診断設定の名前] に任意の値を入力します  </li></ol></li><li><ol start="4"><li>次に、[ログ] にて取得したいログのカテゴリを選択します  </li></ol><ul><li>ログ バックアップ ジョブのデータが含まれるカテゴリ <code>Addon Azure Backup Job Data</code> は必ずチェックを入れてください  </li></ul></li><li><ol start="5"><li>最後に [宛先の詳細] に診断イベントの送信先となる Log Analytics ワークスペースを設定します  </li></ol><ul><li>項目 [ターゲット テーブル] には、<code>リソース固有</code> を選択します<br><img src="/blog/AzureBackupGeneral/How_To_Check_Log_Backup_Jobs/Setting_Rsv_diagnostics_02.png"></li></ul></li></ul><p>診断設定の詳細につきましては、下記公式ドキュメントにも説明がございますので適宜ご確認ください。<br>・ Azure Backup ユーザー向けの診断イベント - Azure Backup | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-diagnostic-events?tabs=recovery-services-vaults">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-diagnostic-events?tabs=recovery-services-vaults</a><br>・ AddonAzureBackupJobs / リソース固有の診断イベントのデータ モデル - Azure Backup | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-reports-data-model?tabs=recovery-services-vaults#addonazurebackupjobs">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-reports-data-model?tabs=recovery-services-vaults#addonazurebackupjobs</a>  </p><h2 id="3-ログ-バックアップのジョブの確認方法"><a href="#3-ログ-バックアップのジョブの確認方法" class="headerlink" title=" 3. ログ バックアップのジョブの確認方法"></a><a id="3"></a> 3. ログ バックアップのジョブの確認方法</h2><p>Recovery Services コンテナーの診断イベント (特にカテゴリ <code>Addon Azure Backup Job Data</code> を含む) を Log Analytics ワークスペースへ送信する診断設定を行われている場合には、Log Analytics ワークスペースに保持されているテーブル <code>AddonAzureBackupJobs</code> から SQL Server DB や SAP HANA DB のログ バックアップ ジョブをご確認いただくことが可能でございます。<br>以下に、ログ バックアップ ジョブを確認するサンプル クエリ、および実行結果をご紹介いたします。  </p><div class="alert is-important"><p class="alert-title">重要</p><p>SQL Server DB や SAP HANA DB の完了したログ バックアップ ジョブの情報は、6 時間毎のバッチ処理にて、Log Analytics ワークスペースへ送信されます。</p><p>そのため、Log Analytics ワークスペースにてログ バックアップ ジョブの情報が確認できるようになるまで、最大 6 時間の遅延が発生する可能性がございますので、あらかじめご留意ください。</p><p>・ 監視とレポートに関する FAQ - Azure Backup | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitor-alert-faq#log-analytics-------------------------------">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitor-alert-faq#log-analytics-------------------------------</a></p><p>　 抜粋 : <code>SQL バックアップでは、15 分ごとにログ バックアップを行うことができるため、完了したすべてのスケジュール済みバックアップ ジョブの情報は、ログも含めて 6 時間ごとにバッチ処理されてプッシュされます。</code></p></div><ul><li>サンプル クエリ<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AddonAzureBackupJobs</span><br><span class="line">| where BackupManagementType == &quot;AzureWorkload&quot;</span><br><span class="line">| where JobOperationSubType == &quot;Log&quot;</span><br><span class="line">| project JobStartDateTime, BackupItemUniqueId, OperationName, JobOperation, JobOperationSubType, JobStatus, JobFailureCode</span><br><span class="line">| sort by JobStartDateTime asc</span><br></pre></td></tr></table></figure></li><li>実行結果例<br><img src="/blog/AzureBackupGeneral/How_To_Check_Log_Backup_Jobs/Result_LA.png"></li></ul><div class="alert is-warning"><p class="alert-title">警告</p><p>本記事でご案内しているクエリについては、お客様の責任のもと、ご利用いただきますようお願い申し上げます。</p><p>クエリ実行時のエラーや、想定外の問題について、当社は責任を負いかねますのでご了承ください。  </p></div><p>そのほか、サンプル クエリを下記公式ドキュメントにてご案内しておりますので必要に応じてご活用ください。<br>・ Recovery Services コンテナーのワークロードに固有のクエリ / Azure Backup の Azure Monitor ログ - Azure Backup | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-use-azuremonitor#queries-specific-to-recovery-services-vault-workloads">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-use-azuremonitor#queries-specific-to-recovery-services-vault-workloads</a>  </p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートです。&lt;br&gt; 今回はお問合せをいただくことが多い、Azure Backup による SQL Server DB や SAP HANA DB のログ バックアップのジョブを確認</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Information" scheme="https://jpabrs-scem.github.io/blog/tags/Information/"/>
    
  </entry>
  
  <entry>
    <title>「Azure Monitor を使用した組み込みのアラート」を利用したバックアップ ジョブ失敗のアラート通知作成例</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/How_to_set_Backup_Alert/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/How_to_set_Backup_Alert/</id>
    <published>2025-12-29T07:00:00.000Z</published>
    <updated>2026-01-29T02:14:32.970Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、<strong>「Azure Monitor を使用した組み込みのアラート」を利用して、Recovery Services コンテナー / バックアップ コンテナーにてバックアップ ジョブが失敗した際にメール通知を出すよう、アラート処理ルールを作成する例</strong> をご紹介します。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. 概要</a><br><a href="#2">2. アラート処理ルール 作成手順</a><br><a href="#2-1">2-1. Azure Monitor を使用した組み込みのアラート構成　作業例</a></p><hr><h2 id="1-概要"><a href="#1-概要" class="headerlink" title="1. 概要"></a><a id="1"></a>1. 概要</h2><ul><li>Azure Backup にてこれまで存在していた「クラシック アラート」は、今後廃止される見込みです</li><li>お客様にて「バックアップ ジョブ失敗のアラートを発生させたい」「発生したアラートをメール通知したい」といった場合<br>　今後は「クラシック アラート」ではなく<br>　「Azure Monitor を使用した組み込みのアラート」を利用してアラートを構成いただく必要があります</li><li>アラート処理ルールの作成例として、今回はバックアップを構成している対象の Recovery Services コンテナー / バックアップ コンテナーをスコープとして指定し、バックアップ ジョブが失敗した際に、指定のメールアドレスへ通知メールを送信させます</li></ul><h2 id="2-アラート処理ルール-作成手順"><a href="#2-アラート処理ルール-作成手順" class="headerlink" title="2. アラート処理ルール 作成手順"></a><a id="2"></a>2. アラート処理ルール 作成手順</h2><p>Azure Backup にて、バックアップ ジョブが失敗した際にアラート通知を出す手段は、下記ドキュメントのとおり複数種類ございます。<br>今回は「Azure Backup ジョブの失敗を検知したい」という要件である前提で、 <strong>「Azure Monitor を使用した組み込みのアラート」</strong> を利用します。  </p><p>・ Azure Backup の監視とレポートのソリューション<br>　 <a href="https://docs.microsoft.com/ja-jp/azure/backup/monitoring-and-alerts-overview#monitoring-and-reporting-scenarios">https://docs.microsoft.com/ja-jp/azure/backup/monitoring-and-alerts-overview#monitoring-and-reporting-scenarios</a><br>　 抜粋 :  </p><blockquote><p>- Azure Monitor を使用した組み込みアラート<br>- カスタム アラート<br>- Azure Monitor を使用した Azure Backup メトリック アラート (プレビュー)<br>- クラシック アラート</p></blockquote><p>「Azure Monitor を使用した組み込みのアラート」の有効化手順やアラート処理ルールの作成手順は、下記 2 点の公開ドキュメントにてご案内しております。<br>基本的にはドキュメントの説明に従って設定いただければアラート構成・通知構成が可能です。   </p><p>・ 1. ジョブ失敗のシナリオに対して Azure Monitor のアラートを有効にする / Azure Backup 用に Azure Monitor ベースのアラートを管理する - Azure Backup | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-alerts?tabs=recovery-services-vaults#turn-on-azure-monitor-alerts-for-job-failure-scenarios">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-alerts?tabs=recovery-services-vaults#turn-on-azure-monitor-alerts-for-job-failure-scenarios</a><br>・ 2. 通知を構成する / チュートリアル - 回復性でアラートとメトリックを監視する | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/resiliency/tutorial-monitor-alerts-metrics#configure-notifications">https://learn.microsoft.com/ja-jp/azure/resiliency/tutorial-monitor-alerts-metrics#configure-notifications</a></p><h3 id="2-1-Azure-Monitor-を使用した組み込みのアラート構成-作業例"><a href="#2-1-Azure-Monitor-を使用した組み込みのアラート構成-作業例" class="headerlink" title="2-1. Azure Monitor を使用した組み込みのアラート構成　作業例"></a><a id="2-1"></a>2-1. Azure Monitor を使用した組み込みのアラート構成　作業例</h3><ul><li><ol><li><p>Recovery Services コンテナーもしくバックアップ コンテナー上で 「Backup のジョブ エラーに関する組み込みの Azure Monitor アラート」設定を有効化します  </p><ul><li>Recovery Services コンテナーの場合<br><img src="/blog/AzureBackupGeneral/How_to_set_Backup_Alert/How_to_set_Backup_Alert_02.png">  </li><li>バックアップ コンテナーの場合<br><img src="/blog/AzureBackupGeneral/How_to_set_Backup_Alert/How_to_set_Backup_Alert_01.png">  </li></ul><p>「Backup のジョブ エラーに関する組み込みの Azure Monitor アラート」設定を有効化することで、バックアップ ジョブが失敗した場合などに、アラートが生成されます。<br>・ 監視アラート / チュートリアル - 回復性でアラートとメトリックを監視する | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/resiliency/tutorial-monitor-alerts-metrics#monitor-alerts">https://learn.microsoft.com/ja-jp/azure/resiliency/tutorial-monitor-alerts-metrics#monitor-alerts</a><br>例)<br>   <img src="/blog/AzureBackupGeneral/How_to_set_Backup_Alert/How_to_set_Backup_Alert_03.png">  </p></li></ol></li><li><ol start="2"><li>回復性 (Resiliency) の [監視とレポート] &gt; [警告] &gt; [アラートの管理] &gt; [アラート処理ルールの管理] にて、新しいアラート処理ルールを作成します<br><img src="/blog/AzureBackupGeneral/How_to_set_Backup_Alert/How_to_set_Backup_Alert_04.png"><br><img src="/blog/AzureBackupGeneral/How_to_set_Backup_Alert/How_to_set_Backup_Alert_05.png"><br>・ 通知の構成 / チュートリアル - 回復性でアラートとメトリックを監視する | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/resiliency/tutorial-monitor-alerts-metrics#configure-notifications">https://learn.microsoft.com/ja-jp/azure/resiliency/tutorial-monitor-alerts-metrics#configure-notifications</a></li></ol></li><li><ol start="3"><li><p>アラート処理ルールの設定を行います  </p><ul><li><p>今回は、Recovery Services コンテナー「rsv-01」およびバックアップ コンテナー「bpv-01」にてバックアップ構成しているため、スコープを「Recovery Services コンテナー : rsv-01」と「バックアップ コンテナー : bpv-01」とします<br><img src="/blog/AzureBackupGeneral/How_to_set_Backup_Alert/How_to_set_Backup_Alert_06.png">  </p></li><li><p>さらに、バックアップ ジョブのエラーを検知した際にアラート通知を発報したいため、「フィルター：重要度」に「階層：１ - エラー」を選択します<br><img src="/blog/AzureBackupGeneral/How_to_set_Backup_Alert/How_to_set_Backup_Alert_07.png"><br>・ Azure Backup の Azure Monitor アラート / Azure Backup の監視とレポートのソリューション - Azure Backup | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/monitoring-and-alerts-overview#azure-monitor-alerts-for-azure-backup">https://learn.microsoft.com/ja-jp/azure/backup/monitoring-and-alerts-overview#azure-monitor-alerts-for-azure-backup</a><br>　 抜粋 : <code>ジョブの失敗のアラート: バックアップ エラーや復元エラーなどのシナリオの場合、Azure Backup は、Azure Monitor 経由で組み込みアラート (重大度 1) を提供します。</code></p></li><li><p>次にアラートの通知先を設定するため、アクション グループを設定します  </p><ul><li><p>アクション グループを新規作成する場合には、[アクション グループの作成] を選択し、アクション グループを作成します<br><img src="/blog/AzureBackupGeneral/How_to_set_Backup_Alert/How_to_set_Backup_Alert_08.png"><br>・ Azure portal でアクション グループを作成する / Azure Monitor のアクション グループ - Azure Monitor | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups#create-an-action-group-in-the-azure-portal">https://learn.microsoft.com/ja-jp/azure/azure-monitor/alerts/action-groups#create-an-action-group-in-the-azure-portal</a>  </p></li><li><p>既存のアクション グループを利用する場合には、[アクション グループの選択] を選択し、アクション グループを選択します<br><img src="/blog/AzureBackupGeneral/How_to_set_Backup_Alert/How_to_set_Backup_Alert_09.png">  </p><p>補足) アクション グループには、下図のように電子メールへの通知を設定済となっています。<br><img src="/blog/AzureBackupGeneral/How_to_set_Backup_Alert/How_to_set_Backup_Alert_10.png">  </p></li></ul></li></ul></li></ol><ul><li>そのほか、スケジュールや詳細などのタブの設定を適宜実施し、アラート処理ルールを作成します<br><img src="/blog/AzureBackupGeneral/How_to_set_Backup_Alert/How_to_set_Backup_Alert_11.png">  </li></ul></li><li><ol start="4"><li>アラート処理ルール / アクション グループが作成および有効化されていることを確認します<br>アラート処理ルールの例)<br>  <img src="/blog/AzureBackupGeneral/How_to_set_Backup_Alert/How_to_set_Backup_Alert_12.png"><br>アクション グループの例)<br>  <img src="/blog/AzureBackupGeneral/How_to_set_Backup_Alert/How_to_set_Backup_Alert_13.png"></li></ol></li></ul><p>上記の手順のように設定することで、「Recovery Services コンテナー : rsv-01」と「バックアップ コンテナー : bpv-01」にてバックアップ ジョブが失敗した際に、指定した電子メール宛先へ通知メールが送信されるようになります。</p><p><img src="/blog/AzureBackupGeneral/How_to_set_Backup_Alert/How_to_set_Backup_Alert_14.png"><br><img src="/blog/AzureBackupGeneral/How_to_set_Backup_Alert/How_to_set_Backup_Alert_15.png"></p><hr><p> （補足）Azure Backup を意図的に失敗させる手順は下記をご参照ください。</p><p>・Azure VM Backup を意図的に失敗させる方法 | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br>　<a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/">https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_VM_backup/</a></p><p>・Azure VM Backup のデータ転送フェーズを意図的に失敗させる方法 | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br>　<a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_ttv/">https://jpabrs-scem.github.io/blog/AzureVMBackup/How_to_fail_ttv/</a></p><p>・MARS バックアップ を意図的に失敗させる方法 | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br>　<a href="https://jpabrs-scem.github.io/blog/MARSBackup/How_to_fail_MARS_backup/">https://jpabrs-scem.github.io/blog/MARSBackup/How_to_fail_MARS_backup/</a></p><p>・Azure Files Backup を意図的に失敗させる方法 | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br>　<a href="https://jpabrs-scem.github.io/blog/AzureFilesBackup/How_to_fail_AFS_backup/">https://jpabrs-scem.github.io/blog/AzureFilesBackup/How_to_fail_AFS_backup/</a></p><p>・Azure Disk Backup を意図的に失敗させる方法 | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br>　<a href="https://jpabrs-scem.github.io/blog/AzureDiskBackup/How_to_fail_Asure_Disk_backup/">https://jpabrs-scem.github.io/blog/AzureDiskBackup/How_to_fail_Asure_Disk_backup/</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、&lt;strong&gt;「Azure Monitor を使用した組み込みのアラート」を利用して、Recovery Services コンテナー / バックアップ </summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>Recovery Services コンテナーとバックアップ コンテナーについて</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RSV_BV/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RSV_BV/</id>
    <published>2025-12-29T07:00:00.000Z</published>
    <updated>2026-01-29T02:14:32.982Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Backup サポートです。<br>今回は、 Azure バックアップ ソリューションで利用する Recovery Services コンテナーとバックアップ コンテナーのバックアップ対象の違いについてご説明します。<br>Recovery Services コンテナーとバックアップ コンテナーはバックアップ対象 (バックアップ ソリューション) の違いにより使い分ける必要がございます。<br>また、<strong>回復性 (Resiliency)  は サブスクリプション内の Recovery Services コンテナーやバックアップ コンテナー (およびそれぞれのコンテナーでバックアップしているバックアップ アイテム) を統合管理するための管理画面です。</strong><br><img src="/blog/AzureBackupGeneral/RSV_BV/RSV_BV_01.png" alt=" Azure Backup 関連のリソース"></p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. バックアップ ソリューションとコンテナー、およびデータ保存先の比較表</a><br><a href="#2">2. コンテナーにバックアップ データが保存されないもの</a><br><a href="#2-1">2-1. Azure ファイル共有バックアップ (スナップショット レベル)</a><br><a href="#2-2">2-2. Azure Blob バックアップ (運用バックアップ)</a><br><a href="#2-3">2-3. Azure ディスク バックアップ</a></p><hr><h3 id="1-バックアップ-ソリューションとコンテナー、およびデータ保存先の比較表"><a href="#1-バックアップ-ソリューションとコンテナー、およびデータ保存先の比較表" class="headerlink" title="1. バックアップ ソリューションとコンテナー、およびデータ保存先の比較表"></a><a id="1"></a>1. バックアップ ソリューションとコンテナー、およびデータ保存先の比較表</h3><p> 各 Azure バックアップのソリューションがどのコンテナーを利用するか、またデータの保存先については下記の通りです。<br> また、各ソリューションには各公開ドキュメントへのリンクを付けています。</p><table><thead><tr><th align="left">#</th><th align="left">バックアップ ソリューション</th><th align="left">利用するコンテナー</th><th align="left">コンテナーにバックアップ データを保存するか</th></tr></thead><tbody><tr><td align="left">1</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction">Azure VM バックアップ</a></td><td align="left">Recovery Services コンテナー</td><td align="left">する</td></tr><tr><td align="left">2</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-about-mars">MARS バックアップ</a></td><td align="left">Recovery Services コンテナー</td><td align="left">する</td></tr><tr><td align="left">3</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-microsoft-azure-backup">MABS バックアップ</a></td><td align="left">Recovery Services コンテナー</td><td align="left">する</td></tr><tr><td align="left">4</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-sql-database">SQL in Azure VM バックアップ</a></td><td align="left">Recovery Services コンテナー</td><td align="left">する</td></tr><tr><td align="left">5</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/sap-hana-database-about">SAP HANA DB in Azure VM バックアップ</a></td><td align="left">Recovery Services コンテナー</td><td align="left">する</td></tr><tr><td align="left">6</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-file-share-backup-overview">Azure ファイル共有バックアップ</a></td><td align="left">Recovery Services コンテナー</td><td align="left">「スナップショット レベル」のバックアップ：しない<br>「Vault-Standard レベル」のバックアップ：する (注 1)</td></tr><tr><td align="left">7</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-overview">Azure Blob バックアップ</a></td><td align="left">バックアップ コンテナー</td><td align="left">運用バックアップ：しない<br>保管済みバックアップ：する</td></tr><tr><td align="left">8</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-overview">Azure ディスク バックアップ</a></td><td align="left">バックアップ コンテナー</td><td align="left"><strong>しない</strong></td></tr><tr><td align="left">9</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-database-postgresql-overview">Azure PostgreSQL バックアップ</a></td><td align="left">バックアップ コンテナー</td><td align="left">する</td></tr><tr><td align="left">10</td><td align="left"><a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-kubernetes-service-backup-overview">Azure Kubernetes Service バックアップ</a></td><td align="left">バックアップ コンテナー</td><td align="left">運用層のバックアップ : しない<br>コンテナー層のバックアップ : する (注 2)</td></tr></tbody></table><p>(注 1) 2025 年 3 月現在、Azure Premium ファイル共有のコンテナー層へのバックアップ機能は Public Preview となっております<br>一方、Azure Standard ファイル共有のコンテナー層へのバックアップ機能は Generally Available となっております  </p><ul><li>Generally Available: Vaulted Backup Support for Azure Files Standard Shares | Azure updates | Microsoft Azure<br><a href="https://azure.microsoft.com/en-US/updates?id=482659">https://azure.microsoft.com/en-US/updates?id=482659</a></li></ul><p>(注 2) AKS のバックアップにおいて、運用層のバックアップは必須で取得いただく必要がございますが、コンテナー層のバックアップは任意での取得が可能となっております  </p><h3 id="2-コンテナーにバックアップ-データが保存されないもの"><a href="#2-コンテナーにバックアップ-データが保存されないもの" class="headerlink" title="2.コンテナーにバックアップ データが保存されないもの"></a><a id="2"></a>2.コンテナーにバックアップ データが保存されないもの</h3><p>上述のとおり、現在 一般公開されている (プレビュー機能ではない) Azure ファイル共有バックアップ (スナップショット レベル) 、Azure Blob バックアップ (運用バックアップ)、Azure ディスク バックアップは各コンテナーにはバックアップ データは転送されません。<br>それぞれについて簡単にご説明させていただきます。<br>共通している点はそれぞれのソリューションはコアとなる別のソリューションをバックアップ サービス側からトリガーし実現している点でございます。</p><h4 id="2-1-Azure-ファイル共有バックアップ-スナップショット-レベル"><a href="#2-1-Azure-ファイル共有バックアップ-スナップショット-レベル" class="headerlink" title="2-1. Azure ファイル共有バックアップ (スナップショット レベル)"></a><a id="2-1"></a>2-1. Azure ファイル共有バックアップ (スナップショット レベル)</h4><p>Azure ファイル共有 バックアップ (スナップショット レベル) は Azure Files の共有スナップショットの機能をバックアップ サービスと連携することによりスナップショット取得・削除の自動化を実現したバックアップ ソリューションです。</p><p>そのため、バックアップ データ (スナップショット データ) の保存先は Azure Files の共有スナップショットと同じく、そのストレージ アカウント自身 (のスナップショット領域)となります。<br>そのため、 Recovery Services コンテナーには転送されません。<br>下記のように<strong>Azure ファイル共有のスナップショット リソースとして、Azure ファイル共有バックアップにて取得されたスナップショットも確認可能です</strong>。(“発信側” が “AzureBackup” となっているものです)<br><img src="/blog/AzureBackupGeneral/RSV_BV/RSV_BV_02.png"></p><ul><li><p>バックアップ プロセスのしくみ - Azure ファイル共有のバックアップについて<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-file-share-backup-overview">https://learn.microsoft.com/ja-jp/azure/backup/azure-file-share-backup-overview</a></p><blockquote><p>抜粋：スナップショット レベル | ファイル共有 API を使ってファイル共有のスナップショットが作成されます。 スナップショットの URL は、メタデータ ストアだけに格納されます。</p></blockquote></li><li><p>Azure Files の共有スナップショット<br><a href="https://learn.microsoft.com/ja-jp/azure/storage/files/storage-snapshots-files">https://learn.microsoft.com/ja-jp/azure/storage/files/storage-snapshots-files</a></p></li></ul><h4 id="2-2-Azure-Blob-バックアップ-運用バックアップ"><a href="#2-2-Azure-Blob-バックアップ-運用バックアップ" class="headerlink" title="2-2. Azure Blob バックアップ (運用バックアップ)"></a><a id="2-2"></a>2-2. Azure Blob バックアップ (運用バックアップ)</h4><p>Azure Blob バックアップ (運用バックアップ) は Azure Blob のポイントインタイム リストアの機能をバックアップ サービスと連携することにより実現したバックアップ ソリューションです。</p><p>バックアップ データ (リストアに必要なデータ) の保存先は Azure Blob のポイントインタイム リストアと同じく、そのストレージ アカウント自身となります。<br>バックアップ コンテナーには転送されません。</p><ul><li><p>運用バックアップのしくみ - Azure Blob の運用バックアップの概要<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-overview">https://learn.microsoft.com/ja-jp/azure/backup/blob-backup-overview</a></p><blockquote><p>抜粋：継続的バックアップ: 運用バックアップ (マネージド ローカル データ保護ソリューション) を構成して、ブロック BLOB の偶発的な削除や破損から保護できます。 データはソース ストレージ アカウント内にローカルに格納され、バックアップ コンテナーには転送されません。</p></blockquote></li><li><p>ブロック BLOB のポイントインタイム リストア<br><a href="https://learn.microsoft.com/ja-jp/azure/storage/blobs/point-in-time-restore-overview">https://learn.microsoft.com/ja-jp/azure/storage/blobs/point-in-time-restore-overview</a></p></li></ul><h4 id="2-3-Azure-ディスク-バックアップ"><a href="#2-3-Azure-ディスク-バックアップ" class="headerlink" title="2-3. Azure ディスク バックアップ"></a><a id="2-3"></a>2-3. Azure ディスク バックアップ</h4><p>Azure ディスク バックアップ は マネージド ディスクの増分スナップショットの機能とバックアップ サービスを連携することによりスナップショット取得・削除の自動化を実現したバックアップ ソリューションです。</p><p>そのため、バックアップ データ (スナップショット データ) の保存先は マネージド ディスクのスナップショットと同じく、マネージド ディスクのスナップショットの専用領域 (運用層) となります。<br>Recovery Services コンテナーには転送されません。<br>また、下記のように<strong>スナップショット リソースとして Azure ディスクのバックアップによって取得されたスナップショットも確認可能です</strong>。(タグが “CreatedBy：AzureBackup” となっているものです)<br><img src="/blog/AzureBackupGeneral/RSV_BV/RSV_BV_03.png"></p><ul><li><p>バックアップと復元のプロセスのしくみ - Azure ディスク バックアップの概要<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-overview#how-the-backup-and-restore-process-works">https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-overview#how-the-backup-and-restore-process-works</a></p><blockquote><p>抜粋： Azure ディスク バックアップでは、運用層のバックアップのみがサポートされています。 コンテナー ストレージ層へのバックアップのコピーはサポートされていません。 そのため、バックアップ コンテナーのストレージ冗長設定 (LRS/GRS) は、運用層に格納されているバックアップには適用されません。</p></blockquote></li><li><p>マネージド ディスクの増分スナップショットの作成<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/disks-incremental-snapshots?tabs=azure-cli">https://learn.microsoft.com/ja-jp/azure/virtual-machines/disks-incremental-snapshots?tabs=azure-cli</a></p></li></ul><p>本ブログ記事の説明は以上です。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、 Azure バックアップ ソリューションで利用する Recovery Services コンテナーとバックアップ コンテナーのバックアップ対象の違いについて</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>QL4L-5D8 XNV5-HTZ クラシック アラートから Azure Monitor を使用した組み込みのアラートへの移行について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/HowToMoveClassicAlert/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/HowToMoveClassicAlert/</id>
    <published>2025-12-29T07:00:00.000Z</published>
    <updated>2026-01-29T02:14:32.945Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Backup サポートです。<br>今回は、2023 年 3 月末より弊社から発行されているアラート追跡 ID 「QL4L-5D8」、「XNV5-HTZ」について説明いたします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#Q1">Q1. 「QL4L-5D8」「XNV5-HTZ」このアラートは何ですか？</a><br><a href="#Q2">Q2. どの Recovery Services コンテナーが「クラシック アラート設定」になっていますか？</a><br><a href="#Q3">Q3. クラシック アラートから Azure Monitor を使用した組み込みのアラートへと移行した場合のコストはどうなりますか？</a><br><a href="#Q4">Q4. クラシック アラートの「通知の構成」をしているかどうかは 1 つ 1 つの Recovery Services コンテナーを確認する必要がありますか？</a><br><a href="#Q5">Q5. Azure Monitor を使用した組み込みのアラートで、クラシック アラートと同じ重要度のアラート メールを通知するには？</a></p><hr><h2 id="Q1-「QL4L-5D8」「XNV5-HTZ」このアラートは何ですか？"><a href="#Q1-「QL4L-5D8」「XNV5-HTZ」このアラートは何ですか？" class="headerlink" title="Q1. 「QL4L-5D8」「XNV5-HTZ」このアラートは何ですか？"></a><a id="Q1"></a>Q1. 「QL4L-5D8」「XNV5-HTZ」このアラートは何ですか？</h2><p><strong>A1</strong> クラシック アラートから Azure Monitor を使用した組み込みのアラートへと移行するよう、お知らせするためのものです。<br>Recovery Services コンテナーでは、クラシック アラートが<span style="color: red; ">既定</span>で存在しており、利用可能な状態となっております。<br>後述 「Q2. どの Recovery Services コンテナーが「クラシック アラート設定」になっていますか？」 をご参照いただき、クラシック アラートを利用した通知の設定有無をまずはご確認くださいますようお願いいたします。</p><h4 id="・-クラシック-アラート機能用いて、現在メールへのアラート通知を構成している場合"><a href="#・-クラシック-アラート機能用いて、現在メールへのアラート通知を構成している場合" class="headerlink" title="・ クラシック アラート機能用いて、現在メールへのアラート通知を構成している場合"></a>・ クラシック アラート機能用いて、現在メールへのアラート通知を構成している場合</h4><p>クラシック アラートは、2026 年 3 月 31 日をもって廃止する予定です。<br>監視設定を継続してご利用になられる場合は、お手数ではございますが、「Azure Monitor を使用した組み込みのアラート」への切り替えを事前にご検討くださいますようお願いいたします。</p><h4 id="・-クラシック-アラート機能用いて、現在メールへのアラート通知を構成していないが、今後はバックアップ-ジョブ失敗時にメール通知などのアラートをご希望の場合"><a href="#・-クラシック-アラート機能用いて、現在メールへのアラート通知を構成していないが、今後はバックアップ-ジョブ失敗時にメール通知などのアラートをご希望の場合" class="headerlink" title="・ クラシック アラート機能用いて、現在メールへのアラート通知を構成していないが、今後はバックアップ ジョブ失敗時にメール通知などのアラートをご希望の場合"></a>・ クラシック アラート機能用いて、現在メールへのアラート通知を構成していないが、今後はバックアップ ジョブ失敗時にメール通知などのアラートをご希望の場合</h4><p>クラシック アラートから「Azure Monitor を使用した組み込みのアラート」へと切り替え設定することをご検討ください。</p><h4 id="・-クラシック-アラート機能用いて、現在メールへのアラート通知を構成していない、かつ今後もバックアップ-ジョブ失敗時にメール通知などのアラートをご希望でない場合"><a href="#・-クラシック-アラート機能用いて、現在メールへのアラート通知を構成していない、かつ今後もバックアップ-ジョブ失敗時にメール通知などのアラートをご希望でない場合" class="headerlink" title="・ クラシック アラート機能用いて、現在メールへのアラート通知を構成していない、かつ今後もバックアップ ジョブ失敗時にメール通知などのアラートをご希望でない場合"></a>・ クラシック アラート機能用いて、現在メールへのアラート通知を構成していない、かつ今後もバックアップ ジョブ失敗時にメール通知などのアラートをご希望でない場合</h4><p><span style="color: red; ">特段お客様での追加作業は不要です。</span></p><p>QL4L-5D8」「XNV5-HTZ」アラートの例)<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_01.png"><br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_02.png"></p><h2 id="Q2-どの-Recovery-Services-コンテナーが「クラシック-アラート設定」になっていますか？"><a href="#Q2-どの-Recovery-Services-コンテナーが「クラシック-アラート設定」になっていますか？" class="headerlink" title="Q2.どの Recovery Services コンテナーが「クラシック アラート設定」になっていますか？"></a><a id="Q2"></a>Q2.どの Recovery Services コンテナーが「クラシック アラート設定」になっていますか？</h2><p><strong>A2</strong><br>・ 既定ですべての Recovery Services コンテナーにおいて、「Azure Monitor を使用した組み込みのアラート」へと移行していない Recovery Services コンテナーは「クラシック アラート」が有効になっており、今回の正常性アラート対象となっております<br>・ 実際に「クラシック アラート」を用いてメールへの通知構成をしているかどうかは、お客様環境の設定次第です</p><h4 id="【どの-Recovery-Services-コンテナーでクラシック-アラートが有効になっているのかを確認する方法】"><a href="#【どの-Recovery-Services-コンテナーでクラシック-アラートが有効になっているのかを確認する方法】" class="headerlink" title="【どの Recovery Services コンテナーでクラシック アラートが有効になっているのかを確認する方法】"></a>【どの Recovery Services コンテナーでクラシック アラートが有効になっているのかを確認する方法】</h4><ul><li><ol><li>Azure ポータルにて回復性 (Resiliency) を開き、[監視とレポート] &gt; [警告] &gt; [アラートの管理] &gt; [リソースの組み込みのアラート設定の管理] を選択します<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_03.png"></li></ol></li><li><ol start="2"><li>[Azure Monitor アラートのみの使用をオプトイン] 画面にて、リストされている Recovery Services コンテナーを確認します<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_04.png"></li></ol></li></ul><div class="alert is-warning"><p class="alert-title">警告</p><p>項目 <code>クラシック アラートのバックアップ</code> が「はい」となっている Recovery Services コンテナーが対象となります。  </p></div><h4 id="【どの-Recovery-Services-コンテナーがクラシック-アラートの「通知の構成」を行っているのかを確認する方法】"><a href="#【どの-Recovery-Services-コンテナーがクラシック-アラートの「通知の構成」を行っているのかを確認する方法】" class="headerlink" title="【どの Recovery Services コンテナーがクラシック アラートの「通知の構成」を行っているのかを確認する方法】"></a>【どの Recovery Services コンテナーがクラシック アラートの「通知の構成」を行っているのかを確認する方法】</h4><p>リストされた Recovery Services コンテナーが実際に通知の構成をしているかどうかは、上記でリストされた Recovery Services コンテナー &gt; [バックアップ アラート] &gt; [通知の構成] &gt; 「メールの通知：オン」 となっているかどうかで確認可能です。<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_05.png"></p><h4 id="【クラシック-アラートが有効になっている-Recovery-Services-コンテナーにて、クラシック-アラートを無効化する方法】"><a href="#【クラシック-アラートが有効になっている-Recovery-Services-コンテナーにて、クラシック-アラートを無効化する方法】" class="headerlink" title="【クラシック アラートが有効になっている Recovery Services コンテナーにて、クラシック アラートを無効化する方法】"></a>【クラシック アラートが有効になっている Recovery Services コンテナーにて、クラシック アラートを無効化する方法】</h4><p>クラシック アラートの通知の構成をしている Recovery Services コンテナーがある場合、[Azure Monitor アラートのみの使用をオプトイン] 画面にて、アラートの設定の更新を行います。</p><div class="alert is-info"><p class="alert-title">Note</p><p>[通知の構成] &gt;「メールの通知：オン」をしている Recovery Services コンテナーが無い場合、かつ今後バックアップジョブの監視設定をする必要が無い場合は、下記対応は不要です。</p></div><ul><li><ol><li>まず、対象 Recovery Services コンテナーを選択して、”アラートの設定” 列の “更新” を押下してください。<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_06.png"></li></ol></li><li><ol start="2"><li>表示された [監視の設定] 画面にて 「Backup 用の Azure Monitor アラートのみを使用」 にチェックを入れてください。<br>また 「Backup のジョブ エラーに関する組み込みの Azure Monitor アラート」 も有効化してください。<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_07.png"></li></ol></li><li><ol start="3"><li>最後に画面下部の “更新” ボタンを押下していただければ、クラシック アラートの廃止は完了いたします。</li></ol></li></ul><div class="alert is-warning"><p class="alert-title">警告</p><p>Recovery Services コンテナーの [監視の設定] の下記どちらかの設定が無効化されていると、[Azure Monitor アラートのみの使用をオプトイン] 画面ではクラシック アラートを使用しているコンテナーとしてカウントされたままとなりますのでご注意ください。</p><p>・ 「Backup 用の Azure Monitor アラートのみを使用」</p><p>・ 「Site Recovery 用の Azure Monitor アラートのみを使用」</p><p>例)</p><p><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_08.png">  </p></div><p>なお、 [監視の設定] 画面に記載されているように、メールなどの通知が必要な場合は、別途設定していただく必要があります。<br>詳細は下記のドキュメントを参照いただければと存じます。</p><p>・ 通知の構成 / チュートリアル - 回復性でアラートとメトリックを監視する | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/resiliency/tutorial-monitor-alerts-metrics#configure-notifications">https://learn.microsoft.com/ja-jp/azure/resiliency/tutorial-monitor-alerts-metrics#configure-notifications</a></p><h2 id="Q3-クラシック-アラートから-Azure-Monitor-を使用した組み込みのアラートへと移行した場合のコストはどうなりますか？"><a href="#Q3-クラシック-アラートから-Azure-Monitor-を使用した組み込みのアラートへと移行した場合のコストはどうなりますか？" class="headerlink" title="Q3.クラシック アラートから Azure Monitor を使用した組み込みのアラートへと移行した場合のコストはどうなりますか？"></a><a id="Q3"></a>Q3.クラシック アラートから Azure Monitor を使用した組み込みのアラートへと移行した場合のコストはどうなりますか？</h2><p><strong>A3</strong> 「Azure Monitor を使用した組み込みのアラートが生成されること」自体に料金は発生しません。<br>一方、メールなどへアラートを通知させる場合は少額の料金が発生いたします。<br>詳細は下記ドキュメントをご参照ください。</p><p>・ クラシック アラートから組み込みの Azure Monitor アラートに移行する / Azure Backup 用に Azure Monitor ベースのアラートを管理する - Azure Backup | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-alerts?tabs=recovery-services-vaults#migrate-from-classic-alerts-to-built-in-azure-monitor-alerts">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-alerts?tabs=recovery-services-vaults#migrate-from-classic-alerts-to-built-in-azure-monitor-alerts</a><br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_09.png">  </p><p>Free レベル (1 か月あたり 1,000 メール) を超える通知に対しては、下記の料金が発生します。</p><p>・ 価格 - Azure Monitor | Microsoft Azure<br>　 <a href="https://azure.microsoft.com/ja-jp/pricing/details/monitor/">https://azure.microsoft.com/ja-jp/pricing/details/monitor/</a><br>　 抜粋 : <code>メール            1 か月あたりメール 1,000 通         メール 100,000 通につき $2</code><br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_10.png"></p><h2 id="Q4-クラシック-アラートの「通知の構成」をしているかどうかは-1-つ-1-つの-Recovery-Services-コンテナーを確認する必要がありますか？"><a href="#Q4-クラシック-アラートの「通知の構成」をしているかどうかは-1-つ-1-つの-Recovery-Services-コンテナーを確認する必要がありますか？" class="headerlink" title="Q4.クラシック アラートの「通知の構成」をしているかどうかは 1 つ 1 つの Recovery Services コンテナーを確認する必要がありますか？"></a><a id="Q4"></a>Q4.クラシック アラートの「通知の構成」をしているかどうかは 1 つ 1 つの Recovery Services コンテナーを確認する必要がありますか？</h2><p><strong>A4</strong> 恐縮ながら、現状はクラシック アラートの「通知の構成」部分を照会するような Azure PowerShell / Azure CLI コマンドのご用意が無いため、お客様には Azure ポータル画面の Recovery Services コンテナーを 1 つ 1 つ確認いただく必要がございます。<br>※ 前提としてクラシック アラートの「通知の構成」をされているのであれば、お客様が設定されたメールアドレスの宛先へと、バックアップ ジョブ失敗時などに通知がなされています。</p><p>その他確認手段の 1 つとして、以下のような REST API を発行することで確認が可能ですので、参考として紹介いたします。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>以下 REST API は、本ブログ発行時点で確認可能な手段であり、事前予告なく返却値が変わる可能性がありますこと、ご了承ください。</p><p>さらに、以下 REST API は、あくまで参考としてご連携するサンプル コマンドでございます。</p><p>コマンド実装をされる場合は貴社にて検証のうえ、実施いただきますようご留意ください。</p><p>また、Azure サポートでは主に Post Production の Break &amp; Fix を担当しており、スクリプトのコードレビューのサポートは承っておりませんので、予めご理解をいただけますと幸いでございます。</p></div><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">### クラシック アラートのメール通知が有効化されているかを確認する </span><br><span class="line">### ※ (前提) Connect-AzAccount コマンドにて、 Azure に接続可能な状態で実行すること</span><br><span class="line"></span><br><span class="line">$RSVList = Get-AzRecoveryServicesVault | Select-Object Name, ResourceGroupName, SubscriptionId</span><br><span class="line"></span><br><span class="line"># リクエスト ヘッダーを作成</span><br><span class="line">$accesstoken = Get-AzAccessToken</span><br><span class="line">$token = ConvertFrom-SecureString -SecureString $accesstoken.Token -AsPlainText</span><br><span class="line">$headers = @&#123;</span><br><span class="line">   &quot;Authorization&quot; = &quot;Bearer $token&quot;; &quot;Content-Type&quot; = &quot;application/json&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 結果出力先のオブジェクトを作成</span><br><span class="line">$results = @()</span><br><span class="line"></span><br><span class="line"># Recovery Services コンテナーごとに API へリクエストを送り、結果を取得する</span><br><span class="line">foreach ( $rsv in $RSVList ) &#123;</span><br><span class="line">    $uri = &quot;https://management.azure.com/subscriptions/$($rsv.SubscriptionId)/resourceGroups/$($rsv.ResourceGroupName)/providers/Microsoft.RecoveryServices/vaults/$($rsv.Name)/monitoringConfigurations/notificationConfiguration?api-version=2017-07-01-preview&quot;</span><br><span class="line">    $response = (Invoke-RestMethod -Uri $uri -Method Get -Headers $headers).properties</span><br><span class="line">    $results += @([pscustomobject]@&#123;subscriptionID = $rsv.SubscriptionId; resourceGroupName = $rsv.ResourceGroupName; recoveryServicesContainerName = $rsv.Name; isClassicAlertNotificationEnabled = $response.areNotificationsEnabled; mailRecipients = $response.additionalRecipients -join &#x27;; &#x27; &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 全ての結果をコンソール出力</span><br><span class="line">$results | Sort-Object isClassicAlertNotificationEnabled -Descending | ForEach-Object &#123; Write-Output $_ | Format-Table &#125;</span><br></pre></td></tr></table></figure><p>上記 REST API を発行した場合、「isClassicAlertNotificationEnabled：True」となっている Recovery Services コンテナーが「通知の構成：オン」となっているものとなります。</p><p>Recovery Services コンテナーの設定例)</p><ul><li>Recovery Services コンテナー : RSV-JPE-GRS は「通知の構成：オン」となっています<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_11.png"></li><li>Recovery Services コンテナー : RSV-EUS-GRS は「通知の構成：オフ」となっています<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_12.png"></li></ul><p>API 実行例)</p><ul><li>Recovery Services コンテナーの一覧<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_13.png"></li><li>Recovery Services コンテナー : RSV-JPE-GRS は「isClassicAlertNotificationEnabled：True」、<br>Recovery Services コンテナー : RSV-EUS-GRS は「isClassicAlertNotificationEnabled：False」となっています<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_14.png"></li></ul><h2 id="Q5-Azure-Monitor-を使用した組み込みのアラートで、クラシック-アラートと同じ重要度のアラート-メールを通知するには？"><a href="#Q5-Azure-Monitor-を使用した組み込みのアラートで、クラシック-アラートと同じ重要度のアラート-メールを通知するには？" class="headerlink" title="Q5. Azure Monitor を使用した組み込みのアラートで、クラシック アラートと同じ重要度のアラート メールを通知するには？"></a><a id="Q5"></a>Q5. Azure Monitor を使用した組み込みのアラートで、クラシック アラートと同じ重要度のアラート メールを通知するには？</h2><p><strong>A5</strong><br>まず、クラシック アラートと Azure Monitor アラートの重要度につきまして、以下にご案内いたします。</p><div class="alert is-info"><p class="alert-title">Note</p><p>お急ぎの方は、下記各アラートの重要度に関する説明は省略いただいて問題ございません。設定方法をご案内している <a href="#Q5.1">【Azure Monitor を使用した組み込みのアラートで、クラシック アラートと同じ重要度のアラート メールを通知する設定方法】</a> をご確認ください。</p></div><h4 id="クラシック-アラートの重要度について"><a href="#クラシック-アラートの重要度について" class="headerlink" title="クラシック アラートの重要度について"></a>クラシック アラートの重要度について</h4><p>クラシック アラートでは、「重大」、「警告」の 2 種のアラートが以下のタイミングで発報されます。  </p><ul><li>「重大」 : バックアップやリストアの失敗、バックアップ データの削除などの破壊的操作が行われたとき  </li><li>「警告」 : MARS エージェントでのバックアップ操作で警告が発生したとき  </li></ul><p>・ アラートの種類 / Azure Backup を使用してクラシック アラートをバックアップする - Azure Backup | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/move-to-azure-monitor-alerts#alert-types">https://learn.microsoft.com/ja-jp/azure/backup/move-to-azure-monitor-alerts#alert-types</a><br>　 抜粋 :</p><blockquote><p><strong>重大</strong>: 原則として、(スケジュールされたかユーザーがトリガーしたかを問わず) バックアップまたは回復が失敗すると、アラートが生成されて “重大” アラートとして表示されます。 アラートは、バックアップの削除などの破壊的な操作でも生成されます。<br><strong>警告</strong>: バックアップ操作が成功したもののいくつかの警告を伴う場合、これらは “警告” アラートとして表示されます。 警告アラートは現在、Azure Backup エージェントのバックアップにのみ使用できます。<br><strong>情報</strong>: 現時点では、Azure Backup サービスで情報アラートは生成されません。</p></blockquote><h4 id="Azure-Monitor-の組み込みアラートの重要度について"><a href="#Azure-Monitor-の組み込みアラートの重要度について" class="headerlink" title="Azure Monitor の組み込みアラートの重要度について"></a>Azure Monitor の組み込みアラートの重要度について</h4><p>Azure Monitor の組み込みアラートでは、主に「セキュリティ アラート」、「ジョブの失敗のアラート」の 2 種のアラートが以下のタイミングで発報されます。  </p><ul><li>「セキュリティ アラート」(重要度 : 0 - 重大) : バックアップ データの削除や、コンテナーの論理的な削除機能が無効化されたとき  </li><li>「ジョブの失敗のアラート」(重要度 : 1 - エラー) : バックアップやリストアが失敗したとき  </li></ul><p>また、MARS エージェントでのバックアップ操作で警告が発生したときや、SQL Server バックアップでサポートされていないバックアップ タイプが設定されていたときには、警告 (重要度 : 2 - 警告) アラートが発報されます。  </p><p>・ Azure Backup の Azure Monitor アラート / Azure Backup の監視とレポートのソリューション - Azure Backup | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/monitoring-and-alerts-overview#azure-monitor-alerts-for-azure-backup">https://learn.microsoft.com/ja-jp/azure/backup/monitoring-and-alerts-overview#azure-monitor-alerts-for-azure-backup</a><br>　 抜粋 :  </p><blockquote><p><strong>セキュリティ アラート</strong>: バックアップ データの削除や、コンテナーの論理的な削除機能の無効化などのシナリオの場合、セキュリティ アラート (重大度 0) が発生し、Azure portal に表示されるか、他のクライアント (PowerShell、CLI、REST API) で使用されます。<br><strong>ジョブの失敗のアラート</strong>: バックアップ エラーや復元エラーなどのシナリオの場合、Azure Backup は、Azure Monitor 経由で組み込みアラート (重大度 1) を提供します。  </p></blockquote><p>・ SQL Server のデータベース バックアップに関するトラブルシューティング - Azure Backup | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-sql-server-azure-troubleshoot#backup-type-unsupported">https://learn.microsoft.com/ja-jp/azure/backup/backup-sql-server-azure-troubleshoot#backup-type-unsupported</a>  </p><h4 id="クラシック-アラートと-Azure-Monitor-を利用した組み込みのアラートの重要度の関係性について"><a href="#クラシック-アラートと-Azure-Monitor-を利用した組み込みのアラートの重要度の関係性について" class="headerlink" title="クラシック アラートと Azure Monitor を利用した組み込みのアラートの重要度の関係性について"></a>クラシック アラートと Azure Monitor を利用した組み込みのアラートの重要度の関係性について</h4><p>クラシック アラートと Azure Monitor を利用した組み込みのアラートの重要度は、おおよそ以下の関係性がございます。</p><ul><li>クラシック アラートの 「重大」 ≒  Azure Monitor を利用した組み込みのアラートの 「重大」 + 「エラー」  </li><li>クラシック アラートの 「警告」 ≒  Azure Monitor を利用した組み込みのアラートの 「警告」  </li></ul><h3 id="【Azure-Monitor-を使用した組み込みのアラートで、クラシック-アラートと同じ重要度のアラート-メールを通知する設定方法】"><a href="#【Azure-Monitor-を使用した組み込みのアラートで、クラシック-アラートと同じ重要度のアラート-メールを通知する設定方法】" class="headerlink" title="【Azure Monitor を使用した組み込みのアラートで、クラシック アラートと同じ重要度のアラート メールを通知する設定方法】"></a><a id="Q5.1"></a>【Azure Monitor を使用した組み込みのアラートで、クラシック アラートと同じ重要度のアラート メールを通知する設定方法】</h3><p>Azure Monitor を使用した組み込みのアラートで、クラシック アラートと同じ重要度のアラート メールを通知する設定方法を、以下にご案内いたします。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>下記ドキュメントに従って、クラシック アラートから組み込みの Azure Monnitor アラートへ移行する設定が完了していることが前提となります。</p><p>もし未設定である場合には、事前に下記ドキュメント 1 の手順 1 ~ 5 、ならびにドキュメント 2 の手順 1 ~ 9 を実行してください。</p><p>・ ドキュメント 1</p><p>　 クラシック アラートから組み込みの Azure Monitor アラートに移行する / Azure Backup 用に Azure Monitor ベースのアラートを管理する - Azure Backup | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-alerts?tabs=recovery-services-vaults#migrate-from-classic-alerts-to-built-in-azure-monitor-alerts">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-monitoring-alerts?tabs=recovery-services-vaults#migrate-from-classic-alerts-to-built-in-azure-monitor-alerts</a></p><p>・ ドキュメント 2</p><p>　 通知の構成 / チュートリアル - 回復性でアラートとメトリックを監視する | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/resiliency/tutorial-monitor-alerts-metrics#configure-notifications">https://learn.microsoft.com/ja-jp/azure/resiliency/tutorial-monitor-alerts-metrics#configure-notifications</a></p></div><h4 id="クラシック-アラートのメール通知設定を確認する"><a href="#クラシック-アラートのメール通知設定を確認する" class="headerlink" title="クラシック アラートのメール通知設定を確認する"></a>クラシック アラートのメール通知設定を確認する</h4><ul><li>Recovery Services コンテナーの [監視] &gt; [バックアップ アラート] &gt; [通知の構成] を表示し、項目「重要度」の設定内容を確認します<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_15.png"></li></ul><h4 id="Azure-Backup-用のアラート処理ルールの設定を変更する"><a href="#Azure-Backup-用のアラート処理ルールの設定を変更する" class="headerlink" title="Azure Backup 用のアラート処理ルールの設定を変更する"></a>Azure Backup 用のアラート処理ルールの設定を変更する</h4><ul><li><p>回復性 (Resiliency) の [監視とレポート] &gt; [警告] &gt; [アラートの管理] &gt; [アラート処理ルールの管理] を表示し、Azure Monitor アラートへ切り替えるときに作成したアラート処理ルールを編集します  </p><p><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_16.png"><br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_17.png"></p></li><li><p>項目 フィルター に、「重要度」フィルターを追加し、値として “0 - 重大”, “1 - エラー”, “2 - 警告” のいずれかを選択し、設定を保存します<br>(下記例においては、クラシック アラートの重要度設定が “クリティカル, 警告” となっていたため、”0 - 重大”, “1 - エラー”, “2 - 警告” の 3 点を選択しております)<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_18.png"></p></li></ul><p>以上で設定は完了です。  </p><h3 id="クラシック-アラートと-Azure-Monitor-を使用した組み込みのアラートの通知メールのサンプル"><a href="#クラシック-アラートと-Azure-Monitor-を使用した組み込みのアラートの通知メールのサンプル" class="headerlink" title="クラシック アラートと Azure Monitor を使用した組み込みのアラートの通知メールのサンプル"></a><a id="Q5.2"></a>クラシック アラートと Azure Monitor を使用した組み込みのアラートの通知メールのサンプル</h3><p>クラシック アラートと Azure Monitor を使用した組み込みのアラートの通知メールのサンプルを、以下のとおりご案内いたします。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>こちらのサンプル メールは 2024/8 頃に受信したものとなりますので、あくまで参考程度に留めてくださいますようお願い申し上げます。</p><p>より正確な内容をご確認いただくためにも、お客様ご自身で、アラート メールの受信検証を行っていただき、内容をご確認ください。</p></div><ul><li><p>バックアップ ジョブ失敗に関するアラート メール  </p><ul><li>クラシック アラート<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_19.png">  </li><li>Azure Monitor を使用した組み込みのアラート<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_20.png">  </li></ul></li><li><p>セキュリティ アラート メール  </p><ul><li>クラシック アラート<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_21.png">  </li><li>Azure Monitor を使用した組み込みのアラート<br><img src="/blog/AzureBackupGeneral/HowToMoveClassicAlert/HowToMoveClassicAlert_22.png">  </li></ul></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、2023 年 3 月末より弊社から発行されているアラート追跡 ID 「QL4L-5D8」、「XNV5-HTZ」について説明いたします。&lt;/p&gt;
&lt;h2 id=</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
  </entry>
  
  <entry>
    <title>VM ごとのバックアップ データ量の確認方法</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToCheckBackupDataSizePerVM/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToCheckBackupDataSizePerVM/</id>
    <published>2025-09-26T03:00:00.000Z</published>
    <updated>2026-01-29T02:14:33.173Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポート チームです。<br>今回は、<strong>Azure VM Backup における VM ごとのバックアップ データ量の確認方法</strong> についてご紹介します。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. 概要</a><br><a href="#2">2. バックアップ データの合計量を確認する方法</a><br><a href="#3">3. VM ごと のバックアップ データ量を確認する方法</a><br><a href="#3-1">3-1. 診断設定の構成方法</a><br><a href="#3-2">3-2. バックアップ レポートでのデータ量の確認方法</a><br><a href="#4">4. 現時点でできないこと</a></p><hr><h2 id="1-概要"><a href="#1-概要" class="headerlink" title="1. 概要"></a><a id="1"></a>1. 概要</h2><p>Azure VM Backup では、バックアップ データは <strong>Recovery Services コンテナー</strong>に保存されます。<br>このコンテナーで VM ごとのバックアップ データ量を確認するには、<strong>バックアップ レポート</strong>を利用する必要があります。<br>ただし、このレポートを使用するためには、事前にお客様ご自身で<strong>診断設定</strong>を構成していただく必要があります。<br>本記事では、診断設定の構成方法および、VM ごとのバックアップ データ量を確認する手順を解説します。</p><h2 id="2-バックアップ-データの合計量を確認する方法"><a href="#2-バックアップ-データの合計量を確認する方法" class="headerlink" title="2. バックアップ データの合計量を確認する方法"></a><a id="2"></a>2. バックアップ データの合計量を確認する方法</h2><p>まずは、<strong>Recovery Services コンテナーに保存されているバックアップ データの合計量</strong>を確認する方法をご紹介します。</p><p>この確認には、特別な設定は不要です。<br>Azure Portal で対象の <strong>Recovery Services コンテナー</strong>を開き、<strong>［概要］</strong> ページの <strong>［バックアップ］</strong> タブ下部に表示される情報から、<strong>Recovery Services コンテナーに保存されているバックアップ データの合計量</strong>を確認できます。<br><img src="/blog/AzureVMBackup/HowToCheckBackupDataSizePerVM/1_totalBackupSize.png"></p><h2 id="3-VM-ごとのバックアップ-データ量を確認する方法"><a href="#3-VM-ごとのバックアップ-データ量を確認する方法" class="headerlink" title="3. VM ごとのバックアップ データ量を確認する方法"></a><a id="3"></a>3. VM ごとのバックアップ データ量を確認する方法</h2><p>次に、<strong>Recovery Services コンテナーに保存されている各 VM のバックアップ データ量</strong>を確認する方法をご紹介します。</p><p>この確認には、<strong>診断設定の構成</strong>と、<strong>バックアップ レポートの利用</strong>が必要です。<br>以下の記事にて、設定から確認までの流れをご説明します。</p><h3 id="3-1-診断設定の構成方法"><a href="#3-1-診断設定の構成方法" class="headerlink" title="3-1. 診断設定の構成方法"></a><a id="3-1"></a>3-1. 診断設定の構成方法</h3><h4 id="1-Log-Analytics-ワークスペースの作成"><a href="#1-Log-Analytics-ワークスペースの作成" class="headerlink" title="1. Log Analytics ワークスペースの作成"></a>1. Log Analytics ワークスペースの作成</h4><p>まず、診断ログの送信先となる <strong>Log Analytics ワークスペース</strong>を作成します。<br>ワークスペース名は任意で構いません。</p><p>Log Analytics ワークスペースの作成方法の詳細につきましては、以下の公式ドキュメントをご覧ください。<br>・Log Analytics ワークスペースの作成 - Azure Monitor | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/quick-create-workspace?tabs=azure-portal">https://learn.microsoft.com/ja-jp/azure/azure-monitor/logs/quick-create-workspace?tabs=azure-portal</a></p><h4 id="2-Recovery-Services-コンテナーで診断設定を構成"><a href="#2-Recovery-Services-コンテナーで診断設定を構成" class="headerlink" title="2. Recovery Services コンテナーで診断設定を構成"></a>2. Recovery Services コンテナーで診断設定を構成</h4><p>次に、Recovery Services コンテナーの <strong>［監視］</strong> → <strong>［診断設定］</strong> を開き <strong>［診断設定を追加する］</strong> をクリックして構成を追加します。<br><img src="/blog/AzureVMBackup/HowToCheckBackupDataSizePerVM/3_1_diagnostics.png"><br>構成時には、以下の 3 項目にチェックを入れてください</p><ul><li><strong>Core Azure Backup Data</strong></li><li><strong>Addon Azure Backup Policy Data</strong></li><li><strong>Addon Azure Backup Storage Data</strong></li></ul><p>送信先には、先ほど作成した Log Analytics ワークスペースを選択します。<br>ターゲット テーブルの種類は<strong>リソース固有</strong>を選択してください。<br><img src="/blog/AzureVMBackup/HowToCheckBackupDataSizePerVM/3_1_diagnosticsSetting.png"></p><p>診断設定の詳細につきましては、以下の公式ドキュメントをご覧ください。<br>・Azure Backup ユーザー向けの診断イベント - Azure Backup | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-diagnostic-events?tabs=recovery-services-vaults">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-diagnostic-events?tabs=recovery-services-vaults</a></p><p>Log Analytics をご利用いただく場合、Azure VM Backup の費用に加えて、<strong>ログのインジェストおよびクエリに対して別途費用が発生します</strong>。<br>Log Analytics の費用に関する詳細は、以下の公式ドキュメントをご参照ください。<br>・価格 - Azure Monitor | Microsoft Azure<br>　<a href="https://azure.microsoft.com/ja-jp/pricing/details/monitor/">https://azure.microsoft.com/ja-jp/pricing/details/monitor/</a></p><h3 id="3-2-バックアップ-レポートでのデータ量の確認方法"><a href="#3-2-バックアップ-レポートでのデータ量の確認方法" class="headerlink" title="3-2. バックアップ レポートでのデータ量の確認方法"></a><a id="3-2"></a>3-2. バックアップ レポートでのデータ量の確認方法</h3><p>Recovery Services コンテナーの <strong>［管理］</strong> → <strong>［バックアップ レポート］</strong> を開き <strong>［作業の開始］</strong> タブにて、先ほど作成した Log Analytics ワークスペースを選択してください。<br><img src="/blog/AzureVMBackup/HowToCheckBackupDataSizePerVM/3_2_backupReport.png"></p><p>次に <strong>［バックアップ インスタンス］</strong> タブを選択してください。<br><img src="/blog/AzureVMBackup/HowToCheckBackupDataSizePerVM/3_2_backupReportBackupInstanceTab.png"></p><p>ページ下部にある <strong>バックアップ インスタンスごとのストレージ</strong> 欄にて、<strong>VM ごとのバックアップ データ量</strong>を確認することができます。<br><img src="/blog/AzureVMBackup/HowToCheckBackupDataSizePerVM/3_2_backupData.png"></p><p>ただし、Recovery Services コンテナーにて診断設定を構成した直後にバックアップ レポートを確認いただいても、<strong>レポートのデータがすぐに表示されない場合があります</strong>。<br>そのため、<strong>Log Analytics にデータ送信するように Recovery Services コンテナーの診断設定を構成した 2 日以上後からレポートを表示することを推奨</strong>いたします。</p><p>これは、診断設定後の初回データ送信に時間がかかるためであり、以下の点にご留意ください。</p><blockquote><p>診断を構成した後、最初のデータ プッシュが完了するまでに最大 24 時間かかることがあります。 Log Analytics ワークスペースへのデータの送信が開始された後、レポートのデータがすぐに表示されない場合があります。まだ終わっていない現在日のデータはレポートに表示されないためです。 詳細については、「バックアップ レポートで使用される規則」を参照してください。 Log Analytics にデータを送信するようにコンテナーを構成した 2 日後からレポートの表示を開始することをお勧めします。</p></blockquote><p>Azure Backup のレポート構成方法や、レポート表示までの時間に関することの詳細は、以下の公式ドキュメントをご覧ください。<br>・Azure Backup のレポートを構成する - Azure Backup | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/configure-reports?tabs=recovery-services-vaults">https://learn.microsoft.com/ja-jp/azure/backup/configure-reports?tabs=recovery-services-vaults</a></p><h2 id="4-現時点でできないこと"><a href="#4-現時点でできないこと" class="headerlink" title="4. 現時点でできないこと"></a><a id="4"></a>4. 現時点でできないこと</h2><p>上記にて VM ごとのバックアップ データ量の確認方法をご案内いたしました。<br>一方で、現時点 (2025年9月17日) では、 <strong>VM ごとのバックアップ費用</strong> を直接確認する方法は提供されておりません。<br>そのため、費用の算出につきましては、お客様ご自身で「Azure Backup の費用」に関する以下の公式サイトをご参照のうえ、VM ごとのバックアップ費用を計算いただく必要がございます。<br>・価格 – Azure Backup | Microsoft Azure<br>　<a href="https://azure.microsoft.com/ja-jp/pricing/details/backup/">https://azure.microsoft.com/ja-jp/pricing/details/backup/</a><br>なお、Recovery Services コンテナーごとの Azure VM Backup の合計費用につきましては、サブスクリプション → コスト分析よりご確認いただけます。<br>Azure VM Backup の合計費用の詳細は、以下の弊チーム ブログをご覧ください。<br>・Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの料金の違い | Japan CSS ABRS Support Blog !!<br>　<a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_billing/#2">https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_billing/#2</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポート チームです。&lt;br&gt;今回は、&lt;strong&gt;Azure VM Backup における VM ごとのバックアップ データ量の確認方法&lt;/strong&gt; についてご紹介します。&lt;</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure Site Recovery の障害調査に必要な情報 (疎通確認)</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/</id>
    <published>2025-09-16T03:00:00.000Z</published>
    <updated>2026-01-29T02:14:33.105Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Site Recovery サポートです。<br>今回は Azure Site Recovery (以下、ASR ) にて「レプリケーションの有効化 が失敗する」「レプリケートが失敗している」といった場合に調査をするにあたり、ネットワーク観点で提供いただきたい情報をお伝えいたします。<br>ネットワーク観点以外で、サポートにて調査時に必要なログは下記をご覧ください</p><ul><li>ASR の障害調査に必要な情報<br><a href="https://jpabrs-scem.github.io/blog/AzureSiteRecovery/RequestForInvestigating_ASR/">https://jpabrs-scem.github.io/blog/AzureSiteRecovery/RequestForInvestigating_ASR/</a></li></ul><p><strong>該当シナリオ</strong></p><ol><li>A2A : Azure Site Recovery 機能を利用して、「Azure 仮想マシン」をレプリケート構成するシナリオ (Azure to Azure)<ul><li>Azure から Azure へのディザスター リカバリー アーキテクチャ<br><a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/azure-to-azure-architecture">https://learn.microsoft.com/ja-jp/azure/site-recovery/azure-to-azure-architecture</a></li></ul></li><li>H2A : Azure Site Recovery 機能を利用して、「Hyper-V ゲスト マシン」をレプリケート構成するシナリオ (Hyper-V to Azure)<ul><li>Hyper-V から Azure へのディザスター リカバリー アーキテクチャ<br>　  <a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/hyper-v-azure-architecture">https://learn.microsoft.com/ja-jp/azure/site-recovery/hyper-v-azure-architecture</a></li></ul></li></ol><p><font color="MediumVioletRed">※　本ブログ記事は、「パブリック エンドポイント経由で ASR 構成する」場合の疎通確認スクリプトです。</font><br>　　プライベート エンドポイント経由で ASR 構成している場合のブログ記事ではありません。<br>　　プライベート エンドポイント構成の場合、ユーザーの環境毎に作成されているプライベート FQDN へ接続確立できているかどうかを、ユーザー側にて確認いただく必要があります。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Azure Site Recovery の A2A・H2A シナリオにおける通信要件</a><br><a href="#2">2. Windows OS における ASR 疎通確認スクリプト</a><br><a href="#3">3. Linux OS における ASR 疎通確認スクリプト</a><br><a href="#4">4. 疎通確認スクリプトの構成</a><br><a href="#4-1">4-1. Windows OS 向けの疎通確認スクリプト内の構成</a><br><a href="#4-2">4-2. Linux OS 向けの疎通確認スクリプト内の構成</a><br><a href="#5">5. 手動でキャッシュ用ストレージ アカウントへの疎通を確認する方法</a><br><a href="#5-1">5-1. コマンドを使った疎通確認 - 手順</a><br><a href="#5-2">5-2. Azure Storage Explorer を使った確認 - 手順</a></p><hr><h2 id="1-Azure-Site-Recovery-の-A2A・H2A-シナリオにおける通信要件"><a href="#1-Azure-Site-Recovery-の-A2A・H2A-シナリオにおける通信要件" class="headerlink" title="1. Azure Site Recovery の A2A・H2A シナリオにおける通信要件"></a>1. Azure Site Recovery の A2A・H2A シナリオにおける通信要件<a id="1"></a></h2><p>Azure 仮想マシンのレプリケートを構成したい場合には、レプリケート希望の Azure 仮想マシン上で、下記の通信要件を満たしている必要があります。</p><ul><li><p>A2A 接続の要件 (パブリック エンドポイント経由でレプリケート構成する場合)<br><a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/azure-to-azure-architecture#connectivity-requirements">https://learn.microsoft.com/ja-jp/azure/site-recovery/azure-to-azure-architecture#connectivity-requirements</a><br><img src="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/001.png"></p></li><li><p>H2A 接続の要件 (パブリック エンドポイント経由でレプリケート構成する場合)<br><a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/hyper-v-azure-architecture#set-up-outbound-network-connectivity">https://learn.microsoft.com/ja-jp/azure/site-recovery/hyper-v-azure-architecture#set-up-outbound-network-connectivity</a></p></li></ul><p>上図は、 A2A の通信要件ドキュメント (パブリック エンドポイント経由) の画像です。<br>黄色罫線箇所のアドレスは、「A2A」「H2A」どちらのシナリオであっても同様に必要となる通信要件です。<br>「Service Bus」は、「レプリケート処理」自体には必要はありませんが、Azure 仮想マシン上のレプリケート状態などを、Azure へと送信し、Azure ポータル画面の「レプリケート ヘルス」欄にて正しいレプリケート状態を確認するために必要な通信先となります。必ず疎通できるようご設定下さい。<br>レプリケート希望の Azure 仮想マシンが ADE 暗号化済なのであれば、「Key Vault」への通信確立も必要となります。<br>A2A シナリオにおいて、Azure 仮想マシンのレプリケートを構成する場合、Azure 仮想マシン上に「モビリティ サービス エージェント」がインストールされ、機能することとなりますが、このモビリティ サービス エージェントを自動的に更新したい場合には「Azure Automation」への接続も必要となります。</p><h2 id="2-Windows-OS-における-ASR-疎通確認スクリプト"><a href="#2-Windows-OS-における-ASR-疎通確認スクリプト" class="headerlink" title="2. Windows OS における ASR 疎通確認スクリプト"></a>2. Windows OS における ASR 疎通確認スクリプト<a id="2"></a></h2><p>※　本疎通確認スクリプトは、あくまで「パブリック エンドポイント経由での ASR 利用」を想定とした確認スクリプトです。</p><p>【スクリプト実行手順】</p><ol><li><p>下記 リンク先から疎通確認スクリプトをダウンロード・展開ください<br><a href="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/ASRNWCheck.zip">ASRNWCheck.zip</a><br>※ ファイルの解凍パスワードは <strong>“SiteRecovery”</strong> となります。</p></li><li><p>マシン上にて、管理者特権の PowerShell コンソール を立ち上げ、<strong>Check_ASR_NW_Windows_A2A_H2A_ver1.0.ps1</strong> を実行ください。<br>(スクリプト実行対象マシン)</p><ul><li>A2A (Azure to Azure) シナリオの場合：レプリケート希望の Azure 仮想マシン上</li><li>H2A (Hyper-V to Azure) シナリオの場合：対象の Hyper-V ホストマシン上</li></ul><p>(実行例 1)<br><code>.\Check_ASR_NW_Windows_A2A_H2A_ver1.0.ps1 &lt;キャッシュ用ストレージ アカウントとして設定しているストレージ アカウント名&gt;</code><br>(実行例 2)<br><code>.\Check_ASR_NW_Windows_A2A_H2A_ver1.0.ps1</code><br>※　引数にキャッシュ用ストレージ アカウント名を渡さない場合、キャッシュ用ストレージ アカウントへの通信確認は行われません。<br>(実行画面例 1)<br><img src="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/003.png"></p><p>(実行画面例 2)<br><img src="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/006.png"></p><p>※　スクリプト実施時に実行ポリシーの制限によりスクリプトが実行できない場合は、下記コマンドを実行して実行ポリシーを変更後、再度スクリプト実効をお試しください。<br><code>Set-ExecutionPolicy Unrestricted</code></p><p>(参考) Set-ExecutionPolicy<br><a href="https://learn.microsoft.com/ja-jp/powershell/module/microsoft.powershell.security/set-executionpolicy?view=powershell-7.5">https://learn.microsoft.com/ja-jp/powershell/module/microsoft.powershell.security/set-executionpolicy?view=powershell-7.5</a></p></li><li><p>“Script Completed” が出力されれば、スクリプトは終了です。<br>※　スクリプト実行完了までには、環境によっては 20 分ほど要する場合がございます。20 分経っても完了しない場合は、control + c を押下して強制終了してください。<br><img src="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/004.png"></p></li><li><p>スクリプト実行が完了すると、スクリプトと同じフォルダ内に以下のようなログファイルが出力されますので、弊社までご提供ください。<br>ログファイル名: ASR_Check_NW_yyyymmdd_hhmmss.log<br><img src="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/005.png"><br>※ control + c にて強制終了した場合においても該当のログファイルが出力されますので、弊社までご提供ください。</p></li></ol><h2 id="3-Linux-OS-における-ASR-疎通確認スクリプト"><a href="#3-Linux-OS-における-ASR-疎通確認スクリプト" class="headerlink" title="3. Linux OS における ASR 疎通確認スクリプト"></a>3. Linux OS における ASR 疎通確認スクリプト<a id="3"></a></h2><p>※　本疎通確認スクリプトは、あくまで「パブリック エンドポイント経由での ASR 利用」を想定とした確認スクリプトです。</p><p>【スクリプト実行手順】</p><ol><li><p>下記 リンク先から疎通確認スクリプトをダウンロード・展開ください<br><a href="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/ASRNWCheck.zip">ASRNWCheck.zip</a><br>※ ファイルの解凍パスワードは <strong>“SiteRecovery”</strong> となります。</p></li><li><p>レプリケート希望の Azure 仮想マシン (Linux OS) マシン上にて、<strong>Check_ASR_NW_Linux_A2A_ver1.0.sh</strong> を配置します。<br>必要に応じて chmod コマンドなどを用いてパーミッションを変更してください。<br><code>chmod 777 Check_ASR_NW_Linux_A2A_ver1.0.sh</code> </p></li><li><p>スクリプトを実行ください。<br>(実行例 1)<br><code>./Check_ASR_NW_Linux_A2A_ver1.0.sh -s &lt;キャッシュ用ストレージ アカウントとして設定しているストレージ アカウント名&gt;</code><br>(実行例 2)<br><code>Check_ASR_NW_Linux_A2A_ver1.0.sh</code><br>※　引数にキャッシュ用ストレージ アカウント名を渡さない場合、キャッシュ用ストレージ アカウントへの通信確認は行われません。<br>(実行画面例)<br><img src="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/020.png"></p></li><li><p>“Script Completed” が出力されれば、スクリプトは終了です。<br>※　スクリプト実行完了までには、環境によっては 20 分ほど要する場合がございます。20 分経っても完了しない場合は、control + c を押下して強制終了してください。</p></li><li><p>スクリプト実行が完了すると、スクリプトと同じフォルダ内に以下のようなログファイルが出力されますので、弊社までご提供ください。<br>ログファイル名: CheckNWResult_&lt;ホスト名&gt;_yyyymmddhhmm.log<br><img src="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/021.png"><br>※ control + c にて強制終了した場合においても該当のログファイルが出力されますので、弊社までご提供ください。</p></li></ol><h2 id="4-疎通確認スクリプトの構成"><a href="#4-疎通確認スクリプトの構成" class="headerlink" title="4. 疎通確認スクリプトの構成"></a>4. 疎通確認スクリプトの構成<a id="4"></a></h2><h3 id="4-1-Windows-OS-向けの疎通確認スクリプト内の構成"><a href="#4-1-Windows-OS-向けの疎通確認スクリプト内の構成" class="headerlink" title="4-1. Windows OS 向けの疎通確認スクリプト内の構成"></a>4-1. Windows OS 向けの疎通確認スクリプト内の構成<a id="4-1"></a></h3><p>Windows OS 向けの疎通確認スクリプト (Check_ASR_NW_Windows_A2A_H2A_ver1.0.ps1) では、下記を実施しています。</p><p>(1) 「HOSTNAME.EXE」「ipconfig.exe」実行によるマシン情報の出力<br>(2) プロキシ設定の確認<br>(3) Azure Site Recovery サービス (hypervrecoverymanager.windowsazure.com) への「tnc」「Invoke-webRequest」コマンド実行<br>(4) (ストレージ アカウントを引数に渡している場合) Azure ストレージ アカウント (XXX.blob.core.windows.net) への「tnc」「Invoke-webRequest」コマンド実行<br>(5) Microsoft Entra ID (login.microsoftonline.com) への「tnc」「Invoke-webRequest」コマンド実行<br>(6) TLS 設定 情報の出力</p><h3 id="4-2-Linux-OS-向けの疎通確認スクリプト内の構成"><a href="#4-2-Linux-OS-向けの疎通確認スクリプト内の構成" class="headerlink" title="4-2. Linux OS 向けの疎通確認スクリプト内の構成"></a>4-2. Linux OS 向けの疎通確認スクリプト内の構成<a id="4-2"></a></h3><p>Linux OS 向けの疎通確認スクリプト (Check_ASR_NW_Linux_A2A_ver1.0.sh) では、下記を実施しています。</p><p>(1) 「ip a」「hostnamectl」コマンドによるマシン情報の出力<br>(2) プロキシ設定の確認<br>(3) Microsoft Entra ID (login.microsoftonline.com) への「nslookup」「nc」「curl」コマンド結果<br>(4) Azure Site Recovery サービス (hypervrecoverymanager.windowsazure.com) への「nslookup」「nc」「curl」コマンド結果<br>(5) (ストレージ アカウントを引数に渡している場合) Azure ストレージ アカウント (XXX.blob.core.windows.net) への「nslookup」「nc」「curl」コマンド結果</p><h2 id="5-手動でキャッシュ用ストレージ-アカウントへの疎通を確認する方法"><a href="#5-手動でキャッシュ用ストレージ-アカウントへの疎通を確認する方法" class="headerlink" title="5. 手動でキャッシュ用ストレージ アカウントへの疎通を確認する方法"></a>5. 手動でキャッシュ用ストレージ アカウントへの疎通を確認する方法<a id="5"></a></h2><p>手動でストレージ アカウントへの接続を確認する方法を紹介します。</p><p>【確認オプション】</p><ul><li>(オプション 1 ) コマンドを使った疎通確認</li><li>(オプション 2 ) Azure Storage Explorer を使って、対象マシンから、適当なファイルをストレージ アカウントの BLOB コンテナーへとアップロードまでできるかを確認</li></ul><p>※ すでに「レプリケーションの有効化」作業を実施済の場合、「どのストレージ アカウントをキャッシュ用として設定したのか」は、Azure ポータル画面 &gt; 対象の Recovery Services コンテナー &gt; レプリケートされたアイテム &gt; [プロパティ]画面より確認可能です。<br><img src="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/002.png"></p><h3 id="5-1-コマンドを使った疎通確認-手順"><a href="#5-1-コマンドを使った疎通確認-手順" class="headerlink" title="5-1. コマンドを使った疎通確認 - 手順"></a>5-1. コマンドを使った疎通確認 - 手順<a id="5-1"></a></h3><p>OS 別に、下記コマンドを全て実行ください。<br>弊社サポートへのお問い合わせを希望される場合は、「実行コマンド」と「実行結果」が分かる内容をテキストファイル形式にて、弊社までご提供ください。</p><p>【Windows OS のマシンから確認する場合 - PowerShell にて確認】<br><code>nslookup &lt;ストレージ アカウント名&gt;.blob.core.windows.net</code><br><code>tnc -port 443 &lt;ストレージ アカウント名&gt;.blob.core.windows.net</code><br><code>Invoke-WebRequest https://&lt;ストレージ アカウント名&gt;.blob.core.windows.net</code></p><p>(※)プロキシを経由して、キャッシュ用ストレージ アカウントとの通信を行いたい場合は、追加で下記コマンドを実行ください。<br><code>Invoke-WebRequest https://&lt;ストレージ アカウント名&gt;.blob.core.windows.net -Proxy http://&lt;プロキシ サーバーの IP アドレス&gt;:&lt;プロキシ ポート&gt;</code></p><p>(実行結果例)<br><img src="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/018.png"></p><p>【Linux OS のマシンから確認する場合】<br><code>nslookup &lt;ストレージ アカウント名&gt;.blob.core.windows.net</code><br><code>nc -vz &lt;ストレージ アカウント名&gt;.blob.core.windows.net 443</code><br><code>curl -I https://&lt;ストレージ アカウント名&gt;.blob.core.windows.net</code></p><p>(※)プロキシを経由して、キャッシュ用ストレージ アカウントとの通信を行いたい場合は、追加で下記コマンドを実行ください。<br><code>curl -I --proxy http://&lt;プロキシ サーバーの IP アドレス&gt;:&lt;プロキシ ポート&gt; https://&lt;ストレージ アカウント名&gt;.blob.core.windows.net</code></p><p>(実行結果例)<br><img src="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/019.png"></p><h3 id="5-2-Azure-Storage-Explorer-を使った確認-手順"><a href="#5-2-Azure-Storage-Explorer-を使った確認-手順" class="headerlink" title="5-2. Azure Storage Explorer を使った確認 - 手順"></a>5-2. Azure Storage Explorer を使った確認 - 手順<a id="5-2"></a></h3><ol><li>対象マシン上で、次の URL から Azure Storage Explorer をインストールします。<br><a href="https://azure.microsoft.com/ja-jp/products/storage/storage-explorer/#overview">https://azure.microsoft.com/ja-jp/products/storage/storage-explorer/#overview</a></li><li>Azure ポータル画面 &gt; ストレージ アカウント &gt; [セキュリティとネットワーク] &gt; [アクセス キー] &gt; [ストレージ アカウント名] と [key] を確認しておきます。<br><img src="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/007.png"></li><li>対象マシン上で、インストールした Azure Storage Explorer を使って、接続テストを行います。<br>Azure Storage Explorer を起動し、Connect to Azure resources を選択します。<br><img src="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/008.png"></li><li>Storage account or service を選択します。<br><img src="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/009.png"></li><li>Account name and keyを選択し、Next をクリックします。<br><img src="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/010.png"></li><li>Account name に、手順「2」で確認した [ストレージ アカウント名] を、Account key に [key] を入力し、Next クリックします。<br><img src="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/011.png"></li><li>内容を確認し、Connect をクリックします。<br><img src="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/012.png"></li><li>Explorer より、接続したストレージ アカウントの Blob を確認します。<br>(Blob が未作成の場合) 任意の名前で Blob コンテナーを作成ください。<br><img src="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/013.png"></li><li>アップロードテスト用に 4 MB のファイルを生成します。PowerShell で、任意のディレクトリ上で次のコマンドを実行して下さい。<br><code>fsutil file createnew dummy4MB.dat 4194304</code><br><img src="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/014.png"><br><img src="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/015.png"></li><li>生成したファイルをストレージ アカウントの Blob コンテナー 上にアップロードします。<br>[Upload] &gt; [Upload Files…] をクリックし、ファイルのアップロードを行います。<br><img src="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/016.png"></li><li>各コンテナーへのアップロードが正常終了することを確認します。<br><img src="/blog/AzureSiteRecovery/RequestForInvestigatingNWASR/017.png"></li><li>BLOB コンテナーへのアップロードが正常に行えることを確認した後は、テスト目的で任意に作成した BLOB コンテナーとファイルは削除ください。</li></ol><p>ご案内は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Site Recovery サポートです。&lt;br&gt;今回は Azure Site Recovery (以下、ASR ) にて「レプリケーションの有効化 が失敗する」「レプリケートが失敗している」といっ</summary>
      
    
    
    
    
    <category term="情報採取" scheme="https://jpabrs-scem.github.io/blog/tags/%E6%83%85%E5%A0%B1%E6%8E%A1%E5%8F%96/"/>
    
    <category term="Azure Site Recovery" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Site-Recovery/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup でリストアする際にステージングの場所として利用するストレージ アカウントについて</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/RestoreStagingStorageAccount/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/RestoreStagingStorageAccount/</id>
    <published>2025-08-22T07:00:00.000Z</published>
    <updated>2026-01-29T02:14:33.209Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Backup サポートです。<br>今回は、Azure VM Backup でリストアする際にステージングの場所として利用するストレージ アカウントについて、下記のとおりお伝えします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. 公開情報 (Docs)</a><br><a href="#2">2. 利用できるストレージ アカウント</a><br><a href="#3">3. リストアされた後にストレージ アカウントに残るファイルについて</a><br><a href="#4">4. 参考画面ショット</a></p><hr><h3 id="1-公開情報-Docs"><a href="#1-公開情報-Docs" class="headerlink" title="1. 公開情報 (Docs)"></a><a id="1"></a>1. 公開情報 (Docs)</h3><p>まず最初に、本件に関する Docs は下記でございます。</p><p>・ ストレージ アカウント - Azure portal で Azure VM データを復元する方法<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#storage-accounts">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#storage-accounts</a></p><blockquote><p>抜粋:”Vault-Standard 復元ポイントからマネージド VM のディスクを復元するときに、マネージド ディスクと Azure Resource Manager (ARM) テンプレートが、ステージング場所にあるディスクの VHD ファイルと共に復元されます。 インスタント復元ポイントからディスクを復元する場合、マネージド ディスクと ARM テンプレートのみが復元されます。”</p></blockquote><blockquote><p>抜粋:リージョン間復元では、 ステージング場所 (ストレージ アカウントの場所) は、Recovery Services コンテナーが セカンダリ リージョンとして扱うリージョンに存在する必要があります。 たとえば、Recovery Services コンテナーは米国東部 2 リージョンにあります (geo 冗長性とリージョン間復元が有効になっています)。 これは、セカンダリ リージョンは米国中部であることを意味します。 そのため、VM のリージョン間復元を行なうには、米国中部でストレージ アカウントを作成する必要があります。<br><a href="https://learn.microsoft.com/ja-jp/azure/availability-zones/cross-region-replication-azure">すべての地域の Azure リージョン間レプリケーションのペアリングに関する記事</a>をご覧ください。</p></blockquote><h3 id="2-利用できるストレージ-アカウント"><a href="#2-利用できるストレージ-アカウント" class="headerlink" title="2. 利用できるストレージ アカウント"></a><a id="2"></a>2. 利用できるストレージ アカウント</h3><p>選択できるストレージ アカウントは下記の条件を満たすものです。<br>・ リストア先 (=ターゲット) のサブスクリプション内およびコンテナーと同じリージョンにある<br>・ LRS / ZRS / GRS の冗長性<br>・ Premium Storage アカウントではない<br>・ (ストレージアカウントのネットワーク設定でパブリックアクセスが制限されている場合) 例外の “信頼されたサービスの一覧にある Azure サービスがこのストレージ アカウントにアクセスすることを許可します” をチェックしている<br>・ 階層型名前空間 (HierarchicalNamespace) が有効化されていない</p><h3 id="3-リストアされた後にストレージ-アカウントに残るファイルについて"><a href="#3-リストアされた後にストレージ-アカウントに残るファイルについて" class="headerlink" title="3.リストアされた後にストレージ アカウントに残るファイルについて"></a><a id="3"></a>3.リストアされた後にストレージ アカウントに残るファイルについて</h3><p>マネージド ディスクの Azure VM の復元が完了しますと対象のストレージ アカウントの中に下記のファイルが残ります。<br>下記のとおり、ストレージ アカウントにファイルが残るかおよび、どのファイルが残るかはリストア シナリオによって異なります。</p><table><thead><tr><th align="left">#</th><th align="left">リストアシナリオ</th><th align="left">ステージングのストレージ アカウントに残るファイル</th></tr></thead><tbody><tr><td align="left"></td><td align="left"><strong>Recovery Services コンテナー (vault-standrd) 層からのリストア</strong></td><td align="left"></td></tr><tr><td align="left">1</td><td align="left">新規 VM 作成</td><td align="left">無し</td></tr><tr><td align="left">2</td><td align="left">ディスクの復元</td><td align="left">VHD ファイルと json ファイル</td></tr><tr><td align="left">3</td><td align="left">既存の置換え</td><td align="left">VHD ファイル</td></tr><tr><td align="left"></td><td align="left"><strong>スナップショット 層からのリストア (インスタントリストア)</strong></td><td align="left"></td></tr><tr><td align="left">4</td><td align="left">新規 VM 作成</td><td align="left">無し</td></tr><tr><td align="left">5</td><td align="left">ディスクの復元</td><td align="left">json ファイル</td></tr><tr><td align="left">6</td><td align="left">既存の置換え</td><td align="left">無し</td></tr><tr><td align="left"></td><td align="left"><strong>クロスリージョン リストア</strong></td><td align="left"></td></tr><tr><td align="left">7</td><td align="left">新規 VM 作成</td><td align="left">無し</td></tr><tr><td align="left">8</td><td align="left">ディスクの復元</td><td align="left">VHD ファイルと json ファイル</td></tr></tbody></table><div class="alert is-info"><p class="alert-title">Note</p><p>復元が正常に成功していることが確認でき次第、これらのファイルは削除いただいて問題ございません。</p><p>しかしながら、これらのファイルが自動で削除されることはございませんので、お手数ですがファイルが不要の場合手動での削除をお願いいたします。</p><p>また、ステージングの場所として使用したストレージ アカウントについても、復元が完了しましたら削除いただいて問題ございません。</p></div><h3 id="4-参考画面ショット"><a href="#4-参考画面ショット" class="headerlink" title="4.参考画面ショット"></a><a id="4"></a>4.参考画面ショット</h3><p> VM 名：vm-temp-01 という Azure VM (OS ディスク 1 つ、データディスク 2 つ) を (2) のディスクの復元にてリストアしたあとのストレージ アカウントです。</p><p> <img src="/blog/AzureVMBackup/RestoreStagingStorageAccount/RestoreStagingStorageAccount_01.png"></p><blockquote><p>コンテナー名：<br>vmtemp01-d90848d6dcef467a9624f5c9cbfc1ad7<br>上記の通り、Azure VM 名にランダムな文字列のコンテナー名のコンテナーが作成されます。</p></blockquote><blockquote><p>VHD：<br>vmtemp01-osdisk-20250822-025019.vhd<br>vmtemp01-datadisk-001-20250822-025019.vhd<br>vvmtemp01-datadisk-000-20250822-025019.vhd<br>上記の通り、Azure VM 名にディスク種別および LUN 番号リストア日時 (UTC表記) が付加された vhd ファイルが作成されます。</p></blockquote><blockquote><p>json：<br>azuredeployfe1ece11-f3b3-49cc-b7c4-04dc93f1afa2.json<br>config-vmtemp01-fe1ece11-f3b3-49cc-b7c4-04dc93f1afa2.json<br>parameterfe1ece11-f3b3-49cc-b7c4-04dc93f1afa2.json<br>上記の通り、<br>「azuredeploy&lt;リストア ジョブで使用されるJob ID&gt;」<br>「config-&lt;VM 名&gt;-&lt;リストア ジョブで使用されるJob ID&gt;」<br>「parameter&lt;リストア ジョブで使用されるJob ID&gt;」の名前から始まるファイルが 3 つ作成されます。</p></blockquote><p>「Job ID」は、コマンドからの確認や、Recovery Services コンテナー &gt; バックアップ ジョブ &gt; 「ジョブのエクスポート」より確認ができます。</p><p>・ジョブをエクスポートする<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-manage-windows-server#export-jobs">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-manage-windows-server#export-jobs</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、Azure VM Backup でリストアする際にステージングの場所として利用するストレージ アカウントについて、下記のとおりお伝えします。&lt;/p&gt;
&lt;h2 </summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure Backup の障害調査に必要な情報 (疎通確認)</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/</id>
    <published>2025-06-30T03:00:00.000Z</published>
    <updated>2026-01-29T02:14:32.990Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートです。<br>今回は Azure Backup のバックアップ失敗、リストア失敗の時の調査をするにあたり、NW 観点で提供いただきたい情報をお伝えいたします。<br>NW 観点以外の情報採集提供依頼については下記をご覧ください<br>・ Azure Backup の障害調査に必要な情報<br>　 <a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigating/">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigating/</a></p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Windows VM における Azure Backup 疎通確認</a><br><a href="#2">2. Linux VM における Azure Backup 疎通確認</a></p><hr><h2 id="1-Windows-VM-における-Azure-Backup-疎通確認"><a href="#1-Windows-VM-における-Azure-Backup-疎通確認" class="headerlink" title="1. Windows VM における Azure Backup 疎通確認"></a>1. Windows VM における Azure Backup 疎通確認<a id="1"></a></h2><p>まず、下記リンク先から疎通確認スクリプトのダウンロードをお願いします。<br><a href="https://github.com/jpabrs-scem/blog/files/11648460/Check_Backup_NW_ver1.7.zip">Check_Backup_NW_ver1.7.zip</a></p><p>(スクリプト実行手順)</p><ol><li><p>疎通確認スクリプトをダウンロードし、展開してください。<br>※ ファイルの解凍パスワードは <strong>“AzureBackup”</strong> となります。</p></li><li><p>PowerShell を右クリックし、管理者として実行をクリックしてください。<br><img src="/blog/AzureBackupGeneral/RequestForInvestigatingNW/RequestForInvestigatingNW_01.png"></p></li><li><p>PowerShell にて手順 1 で展開したスクリプトの場所に移動してください。<br>例) “Takato” というユーザーのデスクトップ上の PowerShell というフォルダ内にスクリプトをダウンロードしたときの移動コマンド</p><blockquote><p>cd C:\Users\Takato\Desktop\powershell</p></blockquote></li><li><p>以下コマンドを実行し、スクリプトを実行してください。<br>(現在画像とバージョンが異なりますが、同様の手順でございます。)</p><blockquote><p>.\Check_Backup_NW_ver1.3.ps1</p></blockquote><p><img src="/blog/AzureBackupGeneral/RequestForInvestigatingNW/RequestForInvestigatingNW_02.png"><br>※ 実行ポリシーの制限により上記スクリプトが実行できない場合には、PowerShell を管理者権限で起動し、下記コマンドより実行ポリシーの設定を変更後、再度スクリプトを実行していただけますと幸いです。</p><blockquote><p>Set-ExecutionPolicy Unrestricted</p></blockquote></li><li><p>以下のような “ScriptStart Completed” 出力がされるまで、お待ちください。<br>※ コマンドの実行には、環境によって 20 分ほど要する場合がございます。20 分経っても完了しない場合は、control + c を押下して強制終了してください。</p><p><img src="/blog/AzureBackupGeneral/RequestForInvestigatingNW/RequestForInvestigatingNW_03.png"></p></li><li><p>コマンド実行が完了すると、スクリプトと同じフォルダ内に以下のようなログ ファイルが出力されますので、弊社までご提供お願いいたします。<br>ログファイル名: AzureBackup_Check_NW_yyyymmdd_hhmmss.log</p><p><img src="/blog/AzureBackupGeneral/RequestForInvestigatingNW/RequestForInvestigatingNW_04.png"><br>※ control + c にて強制終了した場合においても該当のログ ファイルが出力されますので、弊社までご提供お願いいたします。</p></li></ol><h2 id="2-Linux-VM-における-Azure-Backup-疎通確認"><a href="#2-Linux-VM-における-Azure-Backup-疎通確認" class="headerlink" title="2. Linux VM における Azure Backup 疎通確認"></a>2. Linux VM における Azure Backup 疎通確認<a id="2"></a></h2><p>まず、下記 リンク先から疎通確認スクリプトのダウンロードをお願いします。<br><a href="https://github.com/jpabrs-scem/blog/files/13433813/Check_Backup_NW_Linux_ver1.5.zip">Check_Backup_NW_Linux_ver1.5.zip</a></p><p>(スクリプト実行手順)</p><ol><li><p>疎通確認スクリプトをダウンロードし、展開してください。<br>※ ファイルの解凍パスワードは <strong>“AzureBackup”</strong> となります。</p></li><li><p>対象の Linux マシンにスクリプトを移動し実行します。<br>必要に応じて chmod コマンドなどを用いてパーミッションを変更してください。</p><blockquote><p>chmod 777 Check_Backup_NW_Linux_ver1.4.sh </p></blockquote><p>下記のように実行します。</p><blockquote><p>./Check_Backup_NW_Linux_ver1.4.sh</p></blockquote></li><li><p>実行完了<br>実行が完了すれば下記のファイルが作成されますので、弊社までご提供お願いいたします。<br>ログファイル名: CheckNWResult_(ホスト名)_(YYYYMMDDHHMM).log</p><p><img src="/blog/AzureBackupGeneral/RequestForInvestigatingNW/RequestForInvestigatingNW_05.png"></p></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートです。&lt;br&gt;今回は Azure Backup のバックアップ失敗、リストア失敗の時の調査をするにあたり、NW 観点で提供いただきたい情報をお伝えいたします。&lt;br&gt;NW 観点</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="情報採取" scheme="https://jpabrs-scem.github.io/blog/tags/%E6%83%85%E5%A0%B1%E6%8E%A1%E5%8F%96/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup におけるクロス ゾーン リストア (CZR) について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/CZR/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/CZR/</id>
    <published>2025-06-30T03:00:00.000Z</published>
    <updated>2026-01-29T02:14:33.157Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure Backup サポートです。<br>今回は Azure Backup での異なる可用性ゾーンへの復元 ( = クロス ゾーン リストア / CZR ) についてご紹介します。<br>今回ご紹介する内容は、それぞれの公開情報に掲載されておりますが、一つのページに集約されておりません。<br>よくお問い合わせいただく内容ですので、本記事では情報を集約化してお伝えします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. CZR を行うための各条件</a><br>&emsp;<a href="#1-1">1-1. Azure VM の条件</a><br>&emsp;<a href="#1-2">1-2. Recovery Services コンテナーの条件</a><br>&emsp;<a href="#1-3">1-3. 利用できる復元オプション</a><br><a href="#2">2. 参考情報</a></p><hr><h2 id="1-CZR-を行うための各条件"><a href="#1-CZR-を行うための各条件" class="headerlink" title="1. CZR を行うための各条件"></a><a id="1"></a>1. CZR を行うための各条件</h2><p>CZR を利用することで、Azure VM バックアップによって保護されている VM またはディスクを、復旧ポイントから別のゾーンに復元することができます。<br>CZR を利用するために Recovery Services コンテナーおよび Azure VM バックアップにより保護されている VM が満たすべき条件を下記にまとめました。  </p><h3 id="1-1-Azure-VM-の条件"><a href="#1-1-Azure-VM-の条件" class="headerlink" title="1-1. Azure VM の条件"></a><a id="1-1"></a>1-1. Azure VM の条件</h3><p>CZR を行うためには、Azure VM バックアップにより保護されている VM が次の条件を満たす必要があります。</p><ul><li>マネージド VM であること</li><li>クロス リージョン リストア (CRR) を行う場合、ゾーン固定 VM であること</li><li><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#encryption-of-azure-vm-backups">暗号化された Azure VM</a> ではないこと</li></ul><h4 id="Azure-VM-が特定の可用性ゾーンに固定されているかどうかを確認する方法"><a href="#Azure-VM-が特定の可用性ゾーンに固定されているかどうかを確認する方法" class="headerlink" title="Azure VM が特定の可用性ゾーンに固定されているかどうかを確認する方法"></a>Azure VM が特定の可用性ゾーンに固定されているかどうかを確認する方法</h4><p>ご参考までに、Azure VM が可用性ゾーンに固定されているかどうかの、Azure ポータル画面での確認方法を説明いたします。<br>VMの概要欄に「可用性ゾーン xxx」 と表示されていれば、表示されているゾーンに固定されており、「可用性ゾーン xxx」 といった表示がない場合はゾーン固定されていないと判断できます。<br>たとえば、下記画像の VM 「CZR-stand-z1」は可用性ゾーン「ゾーン1」に固定されている状態です。<br><img src="/blog/AzureVMBackup/CZR/CZR_01.png"></p><p>一方で下記画像の VM 「CZR-standard」はどのゾーンにも固定されていない状態となります。<br>(この場合は可用性ゾーンは空欄になります。)<br><img src="/blog/AzureVMBackup/CZR/CZR_02.png"></p><h3 id="1-2-Recovery-Services-コンテナーの条件"><a href="#1-2-Recovery-Services-コンテナーの条件" class="headerlink" title="1-2. Recovery Services コンテナーの条件"></a><a id="1-2"></a>1-2. Recovery Services コンテナーの条件</h3><p>CZR は以下の条件を満たす Recovery Services コンテナーで行うことができます。  </p><ul><li>Recovery Services コンテナーのストレージ レプリケーションの種類が「ゾーン冗長」、または「geo 冗長」かつ <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault#set-cross-region-restore">CRR</a> が有効になっていること  </li><li>ただし、ストレージ レプリケーションの種類が「geo 冗長」かつ CRR が有効の場合は、<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region">セカンダリ リージョンへの復元</a>を行う際にのみゾーン指定して復元可能<br>※ <a href="#1-1">1-1. Azure VM の条件</a> で説明の通り、ゾーン固定 VM である必要有<br>※ プライマリ リージョンへは CRR を有効化していてもゾーン指定して復元することは不可能  </li><li>復旧ポイントの「回復の種類」が「スナップショットと Vault-Standard」もしくは「Vault-Standard」であること<br>※ 「スナップショット」のみの場合は、ゾーン指定して復元することは不可能  </li></ul><div class="alert is-success"><p class="alert-title">ヒント</p><p>CRR については下記の弊社ブログにて紹介しております。</p><p>・ Azure VM Backup におけるクロス リージョン リストア (CRR) について | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)</p><p>　 <a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/CRR/">https://jpabrs-scem.github.io/blog/AzureVMBackup/CRR/</a>  </p><hr><p>セカンダリ リージョン (ペア リージョン) について、および可用性ゾーンをサポートしているリージョンについては下記ドキュメントをご覧ください。</p><p>・ Azure のリージョン間レプリケーション | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/reliability/cross-region-replication-azure#azure-paired-regions">https://learn.microsoft.com/ja-jp/azure/reliability/cross-region-replication-azure#azure-paired-regions</a></p><p>・ Availability Zones をサポートする Azure サービス | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/reliability/availability-zones-service-support#azure-regions-with-availability-zone-support">https://learn.microsoft.com/ja-jp/azure/reliability/availability-zones-service-support#azure-regions-with-availability-zone-support</a>  </p></div><h4 id="Azure-Portal-で-Recovery-Services-コンテナー-の「ストレージ-レプリケーションの種類」を確認する方法"><a href="#Azure-Portal-で-Recovery-Services-コンテナー-の「ストレージ-レプリケーションの種類」を確認する方法" class="headerlink" title="Azure Portal で Recovery Services コンテナー の「ストレージ レプリケーションの種類」を確認する方法"></a>Azure Portal で Recovery Services コンテナー の「ストレージ レプリケーションの種類」を確認する方法</h4><p>ご参考までに、「ストレージ レプリケーションの種類」が「ゾーン冗長」に設定している場合の Azure ポータル画面上の見え方を説明いたします。<br>該当の Recovery Services コンテナー &gt; 設定 - プロパティ &gt; バックアップ構成 - 更新 ボタン から「ストレージ レプリケーションの種類」が確認できます。<br>たとえば、下記画像の Recovery Services コンテナーでは「ゾーン冗長」が設定されています。<br><img src="/blog/AzureVMBackup/CZR/CZR_03.png">  </p><div class="alert is-success"><p class="alert-title">ヒント</p><p>Recovery Services コンテナーで既にバックアップを構成している場合は「ストレージ レプリケーションの種類」を変更することができません。</p><p>「ストレージ レプリケーションの種類」の変更が必要な場合は下記ドキュメントをご参照ください。</p><p>・ Recovery Services コンテナーを作成して構成する - Azure Backup | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault#set-storage-redundancy">https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault#set-storage-redundancy</a></p></div><h4 id="Azure-Portal-で-復旧ポイントの「回復の種類」を確認する方法"><a href="#Azure-Portal-で-復旧ポイントの「回復の種類」を確認する方法" class="headerlink" title="Azure Portal で 復旧ポイントの「回復の種類」を確認する方法"></a>Azure Portal で 復旧ポイントの「回復の種類」を確認する方法</h4><p>ご参考までに、復旧ポイントの「回復の種類」を Azure ポータル画面にて確認する方法を説明いたします。  </p><p>まずは該当の Recovery Services コンテナー &gt; 保護されたアイテム - バックアップ アイテム &gt; Azure Virtual Machine ボタンを選択します。<br><img src="/blog/AzureVMBackup/CZR/CZR_04.png">  </p><p>続いて確認したい VM の行にて、詳細 - View details ボタンを選択します。<br><img src="/blog/AzureVMBackup/CZR/CZR_05.png"> </p><p>すると選択した VM の復旧ポイント一覧が表示され、ここから「回復の種類」を確認できます。<br><img src="/blog/AzureVMBackup/CZR/CZR_06.png"> </p><div class="alert is-success"><p class="alert-title">ヒント</p><p>「スナップショット」「Vault-Standard」についての説明は下記ドキュメントをご参照ください。</p><p>・ レベル | Azure Backup 用語集 - Azure Backup | Microsoft Learn</p><p>　 <a href="https://learn.microsoft.com/ja-jp/azure/backup/azure-backup-glossary#tier">https://learn.microsoft.com/ja-jp/azure/backup/azure-backup-glossary#tier</a></p></div><h3 id="1-3-利用できる復元オプション"><a href="#1-3-利用できる復元オプション" class="headerlink" title=" 1-3. 利用できる復元オプション"></a><a id="1-3"></a> 1-3. 利用できる復元オプション</h3><p>CZR は次の復元を行う場合にのみ利用できます。</p><ul><li>VM の作成</li><li>ディスクの復元</li></ul><p>なお、<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#replace-existing-disks">既存のディスクの置き換え</a> はサポートされていません。</p><h4 id="VM-の作成"><a href="#VM-の作成" class="headerlink" title="VM の作成"></a>VM の作成</h4><p>復旧ポイントから VM の新規作成を行う際、前述の条件を満たしている場合に、復元先の可用性ゾーンを指定することができます。<br><img src="/blog/AzureVMBackup/CZR/CZR_07.png"> </p><p>具体的な復元の手順は下記の公開情報をご覧ください。  </p><ul><li>VM の作成 | Azure Backup を使用して Azure portal を使用して VM を復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#create-a-vm">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#create-a-vm</a></li></ul><h4 id="ディスクの復元"><a href="#ディスクの復元" class="headerlink" title="ディスクの復元"></a>ディスクの復元</h4><p>復旧ポイントから ディスクの復元を行う際、前述の条件を満たしている場合に、復元先の可用性ゾーンを指定することができます。<br><img src="/blog/AzureVMBackup/CZR/CZR_08.png">  </p><p>具体的な復元の手順は下記の公開情報をご覧ください。  </p><ul><li>ディスクを復元する | Azure Backup を使用して Azure portal を使用して VM を復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-disks">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-disks</a></li></ul><h2 id="2-参考情報"><a href="#2-参考情報" class="headerlink" title="2. 参考情報"></a><a id="2"></a>2. 参考情報</h2><ul><li>復元オプション | Azure Backup を使用して Azure portal を使用して VM を復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-options">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-options</a>  </li><li>VM の作成 | Azure Backup を使用して Azure portal を使用して VM を復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#create-a-vm">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#create-a-vm</a>  </li><li>ディスクを復元する | Azure Backup を使用して Azure portal を使用して VM を復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-disks">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-disks</a>  </li><li>セカンダリ リージョンに復元する | Azure Backup を使用して Azure portal を使用して VM を復元する - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region</a>  </li><li>サポートされる復元方法 | Azure VM バックアップのサポート マトリックス - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#supported-restore-methods">https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#supported-restore-methods</a>  </li><li>FAQ-Azure VM をバックアップする - Azure Backup | Microsoft Learn<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#azure-------------------------">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vm-backup-faq#azure-------------------------</a>  </li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;こんにちは、Azure Backup サポートです。&lt;br&gt;今回は Azure Backup での異なる可用性ゾーンへの復元 ( = クロス ゾーン リストア / CZR ) についてご紹介します。&lt;br&gt;今回ご紹介する内容は</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>「VMSnapshot」拡張機能の再インストール手順 (Windows)</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToUninstallVMSnapshotExtension/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/HowToUninstallVMSnapshotExtension/</id>
    <published>2025-06-30T03:00:00.000Z</published>
    <updated>2026-01-29T02:14:33.187Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、「VMSnapshot」拡張機能の再インストール手順 (Windows OS の場合) についてご案内いたします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. 概要</a><br><a href="#2">2. 「VMSnapshot」拡張機能の再インストール手順 (Windows)</a>  </p><hr><h3 id="1-概要"><a href="#1-概要" class="headerlink" title="1. 概要"></a><a id="1"></a>1. 概要</h3><p>「VMSnapshot」拡張機能は、Azure VM Backup (Azure 仮想マシンをまるごとバックアップする機能) において、対象の Azure 仮想マシン上にインストールされる拡張機能です。<br>Azure VM Backup にて何らかのエラーが発生した場合、トラブルシューティングの一環として本記事の記載に従って「VMSnapshot」拡張機能を再インストールしていただき、再度バックアップを実行させることで、エラーが解消されるかを依頼する場合がございます。</p><p>・(参考) Azure VM バックアップについて - Azure Backup | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-process">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-process</a><br>　“Windows VM の場合、VMSnapshot 拡張機能がインストールされます。<br>　 Linux VM の場合、VMSnapshotLinux 拡張機能がインストールされます。”</p><p>・(参考) Azure Backup 用の VM スナップショットの Windows 拡張機能 - Azure Virtual Machines | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/extensions/vmsnapshot-windows">https://learn.microsoft.com/ja-jp/azure/virtual-machines/extensions/vmsnapshot-windows</a></p><p>なお、下記公開ドキュメント上では、Azure ポータル画面 &gt; Azure 仮想マシン &gt; [拡張機能とアプリケーション] 画面から、アンインストールすることができるという説明を記載しておりますが<br>これは <strong>アンマネージド ディスクから作成している Azure 仮想マシンの場合のみ</strong> となります。<br>マネージド ディスク の Azure 仮想マシンの場合は、本記事に従って 「VMSnapshot」拡張機能の再インストールをお試しください。</p><p>・(参考) ExtensionStuckInDeletionState - 拡張機能の状態がバックアップ操作に対応していません<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#extensionstuckindeletionstate---extension-state-is-not-supportive-to-the-backup-operation">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#extensionstuckindeletionstate---extension-state-is-not-supportive-to-the-backup-operation</a><br>　“バックアップ拡張機能 [VmSnapshot] または [VmSnapshotLinux] を選択し、 [アンインストール] を選択します。”</p><p>(画面例 : マネージド ディスク の Azure 仮想マシンの場合は、[拡張機能とアプリケーション] 画面上には「VMSnapshot」拡張機能は表示されません)<br><img src="/blog/AzureVMBackup/HowToUninstallVMSnapshotExtension/HowToUninstallVMSnapshotExtension_01.png"></p><h3 id="2-「VMSnapshot」拡張機能の再インストール手順-Windows"><a href="#2-「VMSnapshot」拡張機能の再インストール手順-Windows" class="headerlink" title="2. 「VMSnapshot」拡張機能の再インストール手順 (Windows)"></a><a id="2"></a>2. 「VMSnapshot」拡張機能の再インストール手順 (Windows)</h3><ul><li><ol><li><p>PowerShell にて Azure アカウントにログインし、下記コマンドを実行し、該当の Azure 仮想マシン上から「VMSnapshot」拡張機能を削除してください  </p><p>(実行コマンド)  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Remove-AzVMExtension -ResourceGroupName &quot;&lt;Azure 仮想マシンのリソース グループ&gt;&quot; -VMName &quot;&lt;Azure 仮想マシン名&gt;&quot; -Name &quot;VMSnapshot&quot;</span><br></pre></td></tr></table></figure><p>上記コマンド実行後、「Y」を入力して、拡張機能の削除を指示します<br><img src="/blog/AzureVMBackup/HowToUninstallVMSnapshotExtension/HowToUninstallVMSnapshotExtension_02.png"></p><p>・(参考) Remove-AzVMExtension (Az.Compute) | Microsoft Learn<br> <a href="https://learn.microsoft.com/ja-jp/powershell/module/az.compute/remove-azvmextension?view=azps-11.0.0">https://learn.microsoft.com/ja-jp/powershell/module/az.compute/remove-azvmextension?view=azps-11.0.0</a></p></li></ol></li></ul><ul><li><ol start="2"><li>該当の Azure 仮想マシン にサインインし、Windows + r を押下して “ファイル名を指定して実行” を開き “services.msc” と入力して、サービスを開いてください<br><img src="/blog/AzureVMBackup/HowToUninstallVMSnapshotExtension/HowToUninstallVMSnapshotExtension_03.png"></li></ol></li></ul><ul><li><ol start="3"><li><p>“Windows Azure Guest Agent” を右クリックし、停止をクリックして、サービスを停止してください<br><img src="/blog/AzureVMBackup/HowToUninstallVMSnapshotExtension/HowToUninstallVMSnapshotExtension_04.png"></p><p><img src="/blog/AzureVMBackup/HowToUninstallVMSnapshotExtension/HowToUninstallVMSnapshotExtension_05.png"></p><p><img src="/blog/AzureVMBackup/HowToUninstallVMSnapshotExtension/HowToUninstallVMSnapshotExtension_06.png"></p></li></ol></li></ul><ul><li><ol start="4"><li>Windows + r を押下して “ファイル名を指定して実行” を開き “regedit” と入力して、レジストリエディターを開いてください<br><img src="/blog/AzureVMBackup/HowToUninstallVMSnapshotExtension/HowToUninstallVMSnapshotExtension_09.png"></li></ol></li></ul><ul><li><ol start="5"><li><p>HKEY_LOCAL_MACHINE\Software\Microsoft\WindowsAzure に移動し、これを安全な場所にエクスポートしてください</p><p>(補足)<br>  レジストリ キーの値をあくまでバックアップ目的でエクスポート (退避) します<br>  「VMSnapshot」拡張機能が正常に再インストール完了すれば、こちらのエクスポートしたファイルは削除いただいて構いません</p><p><img src="/blog/AzureVMBackup/HowToUninstallVMSnapshotExtension/HowToUninstallVMSnapshotExtension_10.png"></p><p><img src="/blog/AzureVMBackup/HowToUninstallVMSnapshotExtension/HowToUninstallVMSnapshotExtension_11.png"></p></li></ol></li></ul><ul><li><ol start="6"><li><p>HKEY_LOCAL_MACHINE\Software\Microsoft\WindowsAzure\HandlerState に移動し、Microsoft.Azure.RecoveryServices.VMSnapshot_X.X.X.X を削除してください<br>(X.X.X.X は、マシン上の数字と読み替えてください)<br><img src="/blog/AzureVMBackup/HowToUninstallVMSnapshotExtension/HowToUninstallVMSnapshotExtension_12.png"></p><p><img src="/blog/AzureVMBackup/HowToUninstallVMSnapshotExtension/HowToUninstallVMSnapshotExtension_13.png"></p></li></ol></li></ul><ul><li><ol start="7"><li><p>管理者権限にてコマンドプロンプトを開き以下のコマンド (2 つ) を実行してください  </p><p>(実行コマンド)  </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">REG ADD &quot;HKLM\SOFTWARE\Microsoft\BcdrAgent&quot; /v IsProviderInstalled /t REG_SZ /d False /f</span><br><span class="line">REG ADD &quot;HKLM\SOFTWARE\Microsoft\BcdrAgentPersistentKeys&quot; /v IsCommonProviderInstalled /t REG_SZ /d False /f</span><br></pre></td></tr></table></figure><p><img src="/blog/AzureVMBackup/HowToUninstallVMSnapshotExtension/HowToUninstallVMSnapshotExtension_14.png"></p></li></ol></li></ul><ul><li><ol start="8"><li><p>サービスより “Windows Azure Guest Agent” を右クリックし、開始をクリックして、サービスを開始してください<br><img src="/blog/AzureVMBackup/HowToUninstallVMSnapshotExtension/HowToUninstallVMSnapshotExtension_15.png"></p><p><img src="/blog/AzureVMBackup/HowToUninstallVMSnapshotExtension/HowToUninstallVMSnapshotExtension_16.png"></p></li></ol></li></ul><ul><li><ol start="9"><li><p>Windows Azure Guest Agent が正常に開始した段階で、再度マシン上には「Microsoft.Azure.RecoveryServices.VMSnapshot_X.X.X.X」のレジストリ キーが自動追加される想定ですが、<br>念のため、次回の Azure VM Backup のスケジュール バックアップもしくは「今すぐバックアップ」より、バックアップをトリガーしてください  </p><p>・(参考) バックアップをすぐに実行する<br>  <a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-first-look-arm#run-a-backup-immediately">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-first-look-arm#run-a-backup-immediately</a> </p></li></ol></li></ul><ul><li><ol start="10"><li>Azure VM Backup ジョブが正常に完了することを確認してください<br>もしバックアップ ジョブが正常に完了した場合には、手順 5 でエクスポートした下記ファイルは削除いただいて構いません<br>・ エクスポートしていたレジストリ キーのファイル</li></ol></li></ul><p>「VMSnapshot」拡張機能の再インストール手順 (Windows OS の場合) は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、「VMSnapshot」拡張機能の再インストール手順 (Windows OS の場合) についてご案内いたします。&lt;/p&gt;
&lt;h2 id=&quot;目次&quot;&gt;&lt;a </summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの料金の違い</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_billing/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_billing/</id>
    <published>2025-06-30T03:00:00.000Z</published>
    <updated>2026-01-29T02:14:33.210Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は、Azure VM Backup において、<br>「Standard バックアップ ポリシー (標準ポリシー) 」でバックアップを取得した場合と<br>「Enhanced バックアップ ポリシー (拡張ポリシー) 」でバックアップを取得した場合のそれぞれの料金の違いについて説明します。<br><img src="/blog/AzureVMBackup/VM_Backup_billing/VM_Backup_billing_01.png" alt="image"></p><p>(参考 関連ブログ記事)<br>・料金計算ツールを用いた Azure VM Backup の料金見積もりについて | Japan CSS ABRS Support Blog !! (jpabrs-scem.github.io)<br>　<a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_calculator/">https://jpabrs-scem.github.io/blog/AzureVMBackup/VM_Backup_calculator/</a></p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの機能の違いについて</a><br><a href="#2">2. Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの料金の違い</a><br><a href="#3">3. スナップショット料金の請求先について</a></p><hr><h2 id="1-Standard-バックアップ-ポリシーと-Enhanced-バックアップ-ポリシーの機能の違いについて"><a href="#1-Standard-バックアップ-ポリシーと-Enhanced-バックアップ-ポリシーの機能の違いについて" class="headerlink" title="1. Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの機能の違いについて"></a>1. Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの機能の違いについて<a id="1"></a></h2><p>それぞれのバックアップ ポリシーで Azure VM Backup を取得する場合の機能の違いは下記公開ドキュメントをご参照ください。<br>・拡張ポリシーを使用して Azure VM をバックアップする - Azure Backup | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal</a></p><h2 id="2-Standard-バックアップ-ポリシーと-Enhanced-バックアップ-ポリシーの料金の違い"><a href="#2-Standard-バックアップ-ポリシーと-Enhanced-バックアップ-ポリシーの料金の違い" class="headerlink" title="2. Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの料金の違い"></a>2. Standard バックアップ ポリシーと Enhanced バックアップ ポリシーの料金の違い<a id="2"></a></h2><h3 id="Azure-VM-Backup-の料金"><a href="#Azure-VM-Backup-の料金" class="headerlink" title="Azure VM Backup の料金"></a>Azure VM Backup の料金</h3><p>Azure VM Backup を利用する場合、その料金を見積もる際には以下 3 点が課金項目となります。<br>　(1) Azure 仮想マシンのインスタンスに対する課金<br>　(2) Recovery Services コンテナーに保管されるバックアップ データに対する課金<br>　(3) Azure VM Backup の機能で取得されるスナップショットに対する課金</p><p>(1) と (2) の課金は、「Standard バックアップ ポリシー」でバックアップ取得しても、「Enhanced バックアップ ポリシー」でバックアップ取得しても、どちらも同じ料金計算方式となります。</p><p>この 2 項目は、下記公開ドキュメント上で説明している「保護されたインスタンス サイズ (1) 」「バックアップ ストレージの課金 (2) 」箇所に相当します。</p><p>(参考ドキュメント)<br>・バックアップのコスト<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-costs">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#backup-costs</a><br>　引用 : “保護されたインスタンス サイズの計算は、”実際の” VM のサイズに基づきます。”<br>　引用 : “同様に、バックアップ ストレージの課金は、Azure Backup に格納されているデータ量 (各回復ポイントの実際のデータの合計) に基づきます。”</p><p>いっぽう (3) の課金は、「Standard バックアップ ポリシー」でバックアップ取得する場合と、「Enhanced バックアップ ポリシー」でバックアップ取得する場合とで、料金の加算方法が変わってきます。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>Standard バックアップ ポリシーにてトラステッド起動 VM のバックアップを取得する場合にのみ、(3) の課金は「Enhanced バックアップ ポリシー」でバックアップを取得する場合と同じになります。</p><p>もし該当する場合には、以下説明は「Enhanced バックアップ ポリシー」の箇所をご確認ください。  </p></div><h3 id="「Azure-VM-Backup-の機能で取得されるスナップショットに対する課金」の加算方法の違い"><a href="#「Azure-VM-Backup-の機能で取得されるスナップショットに対する課金」の加算方法の違い" class="headerlink" title="「Azure VM Backup の機能で取得されるスナップショットに対する課金」の加算方法の違い"></a>「Azure VM Backup の機能で取得されるスナップショットに対する課金」の加算方法の違い</h3><p>「Standard バックアップ ポリシー」では、初回のスナップショット取得時点では料金は発生しません。<br>「Enhanced バックアップ ポリシー」では、初回のスナップショット取得時点で、使用データ量分のスナップショットに対して料金が発生します。</p><p>また、1 GB あたりの課金額は以下の通りそれぞれ違いがあります。</p><p>Standard (標準) ポリシー : 0.12 ドル/ 1 GB<br>Enhanced (拡張) ポリシー : 0.05 ドル/ 1 GB</p><p>※ リージョンにより料金が異なる場合がございます。(上記 および 以下の参考例は、USEast2 の価格となります。)</p><p>下記の表は 100 GB の容量をもつ Azure 仮想マシンに対して、毎日 1 GB の増分が発生するケースにおいて、スナップショットを 4 日間保管した場合の比較表となります。<br>※ 表中の料金は前日からの増分により発生した課金の月額を示しており、実際の料金は保存期間によって変動する場合があります。<br>(参考例)<br><img src="/blog/AzureVMBackup/VM_Backup_billing/VM_Backup_billing_02.png"><br>※1 便宜上 100 GB と記載しておりますが、より正確には初回のスナップショット取得時点では 0 GB となります。<br>(その後の変更ブロック発生によりスナップショット サイズが増大いたします)</p><p>上記サンプルケースでは Enhanced バックアップ ポリシー 利用時の方が費用は高くなりますが、初回のバックアップ データ量が減った場合や、翌日以降の増分データ量が増加する場合は、Standard バックアップ ポリシー利用時の方が割高となるシナリオも考えられます。</p><p>「(3) Azure VM Backup の機能で取得されるスナップショットに対する課金」における<br>リージョン毎のスナップショット料金詳細は下記をご参照ください。</p><h4 id="Standard-バックアップ-ポリシー-スナップショットに対する料金"><a href="#Standard-バックアップ-ポリシー-スナップショットに対する料金" class="headerlink" title="Standard バックアップ ポリシー - スナップショットに対する料金"></a>Standard バックアップ ポリシー - スナップショットに対する料金</h4><p>下記リンクから、リージョン・通貨をご希望のものへと設定変更いただければ、スナップショットに対する料金を確認できます。<br>・Azure ページ BLOB Storage の価格 | Microsoft Azure<br>　<a href="https://azure.microsoft.com/ja-jp/pricing/details/storage/page-blobs/">https://azure.microsoft.com/ja-jp/pricing/details/storage/page-blobs/</a></p><p><img src="/blog/AzureVMBackup/VM_Backup_billing/VM_Backup_billing_03.png"></p><h4 id="Enhanced-バックアップ-ポリシー-スナップショットに対する料金"><a href="#Enhanced-バックアップ-ポリシー-スナップショットに対する料金" class="headerlink" title="Enhanced バックアップ ポリシー - スナップショットに対する料金"></a>Enhanced バックアップ ポリシー - スナップショットに対する料金</h4><p>下記リンクから、リージョン・通貨をご希望のものへと設定変更いただければ、スナップショットに対する料金を確認できます。<br>・料金 - Managed Disks | Microsoft Azure<br>　<a href="https://azure.microsoft.com/ja-jp/pricing/details/managed-disks/">https://azure.microsoft.com/ja-jp/pricing/details/managed-disks/</a></p><p><img src="/blog/AzureVMBackup/VM_Backup_billing/VM_Backup_billing_04.png"></p><h2 id="3-スナップショット料金の請求先について"><a href="#3-スナップショット料金の請求先について" class="headerlink" title="3. スナップショット料金の請求先について"></a>3. スナップショット料金の請求先について<a id="3"></a></h2><p>　(1) Azure 仮想マシンのインスタンスに対する課金<br>　(2) Recovery Services コンテナーに保管されるバックアップ データに対する課金<br>　(3) Azure VM Backup の機能で取得されるスナップショットに対する課金</p><p>上記料金の請求書上では、各項目 および バックアップ ポリシーの違いによって、次に示す表のように表示されます。<br>Azure Backup の 料金として請求される項目は (1) (2) であり、(3) は スナップショットにかかった料金 として別の項目として請求されます。 </p><table><thead><tr><th align="left">課金項目</th><th align="left">バックアップ ポリシー</th><th align="left">サービス名</th><th align="left">請求上の表示 (Meter)</th><th align="left">請求されるリソースグループ</th></tr></thead><tbody><tr><td align="left">(1)</td><td align="left">Standard / Enhanced バックアップ ポリシー</td><td align="left">Backup</td><td align="left">Azure VM Protected Instances</td><td align="left">Recovery Services コンテナーのリソース グループ</td></tr><tr><td align="left">(2)</td><td align="left">Standard / Enhanced バックアップ ポリシー</td><td align="left">Backup</td><td align="left"><span style="color: red; ">LRS</span> Data Stored</td><td align="left">Recovery Services コンテナーのリソース グループ</td></tr><tr><td align="left">(3)</td><td align="left">Standard バックアップ ポリシー</td><td align="left">Storage</td><td align="left">LRS snapshots</td><td align="left">Managed Disk のリソース グループ</td></tr><tr><td align="left">(3)</td><td align="left">Enhanced バックアップ ポリシー</td><td align="left">Storage</td><td align="left">Snapshots ZRS Snapshots</td><td align="left">復元ポイント コレクションのリソース グループ</td></tr></tbody></table><p>　( <span style="color: red; ">赤文字</span>部分は、対象 Recovery Services コンテナーの「ストレージ レプリケーションの種類」によって変わります)</p><p>ご参考までに、弊社検証環境にて確認した各項目の表示例を以下に示します。<br>画像 1 : コスト分析画面にて確認した (1) および (2) の表示例（ストレージ レプリケーションの種類  : ローカル冗長 (LRS)）<br><img src="/blog/AzureVMBackup/VM_Backup_billing/VM_Backup_billing_05.png" alt="画像 1"></p><p> 画像 2 : コスト分析画面にて確認した (3) の表示例 (Standard バックアップ ポリシー)<br><img src="/blog/AzureVMBackup/VM_Backup_billing/VM_Backup_billing_06.png" alt="画像 2"></p><p>(参考) 画像 2 のバックアップ対象 の VM の Azure Managed Disk のリソース グループ名 : rgsqlag<br><img src="/blog/AzureVMBackup/VM_Backup_billing/VM_Backup_billing_07.png" alt="参考"></p><p>画像 3 : コスト分析画面にて確認した (3) の表示例 (Enhanced バックアップ ポリシー)<br><img src="/blog/AzureVMBackup/VM_Backup_billing/VM_Backup_billing_08.png" alt="画像 3"></p><p>(参考) 画像 3 の復元ポイント コレクションのリソース グループ名 : azurebackuprg_eastus_1<br><img src="/blog/AzureVMBackup/VM_Backup_billing/VM_Backup_billing_09.png" alt="参考"></p><p>(補足)<br>各バックアップ ポリシーにて取得されるスナップショットはそれぞれ以下のスナップショット層へ格納されます。<br>　・Standard バックアップ ポリシー : LRS のスナップショット層<br>　・Enhanced バックアップ ポリシー : ZRS のスナップショット層 </p><p>(参考ドキュメント)<br>・拡張ポリシーを使用して Azure VM をバックアップする<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-enhanced-policy?tabs=azure-portal</a><br>　引用 : “インスタント復元層では、ゾーン冗長ストレージ (ZRS) の回復性を使用してゾーン冗長性が確保されています。”</p><p>本記事の内容は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は、Azure VM Backup において、&lt;br&gt;「Standard バックアップ ポリシー (標準ポリシー) 」でバックアップを取得した場合と&lt;br&gt;「</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure Backup の障害調査に必要な情報</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigating/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigating/</id>
    <published>2025-06-30T03:00:00.000Z</published>
    <updated>2026-01-29T02:14:32.983Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>みなさんこんにちは、Azure Backup サポートです。<br>今回は Azure Backup のバックアップ失敗、リストア失敗の時の調査をするにあたり、提供いただきたい情報をお伝えいたします。<br>なお、 Azure Backup の NW 観点の障害調査に必要なログに関しては、下記をご覧ください。<br>・ Azure Backup の障害調査に必要な情報 (疎通確認)<br>　 <a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigatingNW/</a></p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Azure VM バックアップの障害調査に必要なログ</a><br>&emsp;<a href="#1-1">1-1. Azure VM バックアップ の VSS 障害調査に追加で必要なログ</a><br><a href="#2">2. Azure VM バックアップ の ファイル レベル リストア (ILR) 失敗調査に必要なログ</a><br><a href="#3">3. Azure Backup for SAP HANA in Azure VM の障害調査に必要なログ</a><br>&emsp;<a href="#3-1">3-1. SAP HANA の backup.log 及び backint.log</a><br>&emsp;<a href="#3-2">3-2. opt 配下の log</a><br><a href="#4">4. MARS (Microsoft Azure Recovery Services) エージェントを利用したバックアップ の障害調査に必要なログ</a><br>&emsp;<a href="#4-1">4-1. MARS (Microsoft Azure Recovery Services) エージェントのログ</a><br>&emsp;<a href="#4-2">4-2. システム情報</a><br>&emsp;<a href="#4-3">4-3. イベント ログ</a><br>&emsp;<a href="#4-4">4-4. 各種証明書の確認およびインポート</a><br>&emsp;&emsp;<a href="#4-4-1">4-4-1. 個人 &gt; 証明書</a><br>&emsp;&emsp;<a href="#4-4-2">4-4-2. 信頼されたルート証明書 &gt; 証明書</a><br>&emsp;&emsp;<a href="#4-4-3">4-4-3. 証明書インポート手順</a></p><hr><h2 id="1-Azure-VM-バックアップの障害調査に必要なログ"><a href="#1-Azure-VM-バックアップの障害調査に必要なログ" class="headerlink" title="1. Azure VM バックアップの障害調査に必要なログ"></a>1. Azure VM バックアップの障害調査に必要なログ<a id="1"></a></h2><p>下記の <strong>環境情報</strong> と <strong>ログ情報</strong> の収集をお願いいたします。</p><div class="alert is-info"><p class="alert-title">Note</p><p>Azure Backup for SQL Server in Azure VM や Azure Backup for SAP HANA in Azure VM など Azure VM 上の DB のバックアップの障害調査においても、本ログが同様に必要でございます。</p></div><h3 id="環境情報"><a href="#環境情報" class="headerlink" title="環境情報"></a>環境情報</h3><p>・ Subscription ID<br>・ Recovery Services コンテナー名、およびそのリソースグループ名<br>・ バックアップ対象 VM 名、およびそのリソースグループ名<br>・ OS およびバージョン情報</p><h3 id="ログ情報"><a href="#ログ情報" class="headerlink" title="ログ情報"></a>ログ情報</h3><p>下記を参考に zip などにまとめてご提供いただけますと幸いです。</p><h4 id="・Windows-の場合"><a href="#・Windows-の場合" class="headerlink" title="・Windows の場合"></a>・Windows の場合</h4><blockquote><p>C:\Windows\System32\winevt\Logs<br>C:\WindowsAzure\</p></blockquote><h4 id="・Linuxの場合"><a href="#・Linuxの場合" class="headerlink" title="・Linuxの場合"></a>・Linuxの場合</h4><blockquote><p>/var/log/</p></blockquote><p>全量いただけることが望ましいですが、全量が困難な場合は下記をご提供ください。</p><blockquote><p>/var/log/azure/*<br>/var/log/syslog*<br>/var/log/waagent.*</p></blockquote><div class="alert is-warning"><p class="alert-title">警告</p><p>NVA 等をご利用である場合には、Azure VM バックアップがサポートされていない可能性がございます。</p><p>詳細は下記をご覧ください。</p><p>・ NVA のバックアップについて</p><p>　 <a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/NVA_backup/">https://jpabrs-scem.github.io/blog/AzureVMBackup/NVA_backup/</a></p></div><h3 id="1-1-Azure-VM-バックアップ-の-VSS-障害調査に追加で必要なログ"><a href="#1-1-Azure-VM-バックアップ-の-VSS-障害調査に追加で必要なログ" class="headerlink" title="1-1. Azure VM バックアップ の VSS 障害調査に追加で必要なログ"></a>1-1. Azure VM バックアップ の VSS 障害調査に追加で必要なログ<a id="1-1"></a></h3><p>Azure VM バックアップの下記のようなエラーが出ることがございます。</p><blockquote><p>Error Code  : Snapshot operation failed due to VSS Writers in bad state.<br>Error Message  : ExtensionFailedVssWriterInBadState</p></blockquote><p>その場合には VSS 観点での調査が必要であるため、上記 <a href="#1">1. Azure VM バックアップの障害調査に必要なログ</a> に加えて下記 URL 先のログの採取をお願いいたします。<br> <strong>可能な限り “[A]”が望ましいですが、”[B]” の方法で採取いただいても、ある程度は調査が可能な場合がございます。</strong><br>・ VSS エラーが発生している事象の調査<br>　 <a href="https://jpwinsup.github.io/mslog/storage/vss/vss-error/">https://jpwinsup.github.io/mslog/storage/vss/vss-error/</a></p><hr><h2 id="2-Azure-VM-バックアップ-の-ファイルレベル-リストア-ILRリストア-失敗調査に必要なログ"><a href="#2-Azure-VM-バックアップ-の-ファイルレベル-リストア-ILRリストア-失敗調査に必要なログ" class="headerlink" title="2. Azure VM バックアップ の ファイルレベル リストア (ILRリストア) 失敗調査に必要なログ"></a>2. Azure VM バックアップ の ファイルレベル リストア (ILRリストア) 失敗調査に必要なログ<a id="2"></a></h2><p>下記の <strong>環境情報</strong> と <strong>ログ情報</strong> の収集をお願いいたします。</p><h3 id="環境情報-1"><a href="#環境情報-1" class="headerlink" title="環境情報"></a>環境情報</h3><p>・ Subscription ID<br>・ Recovery Services コンテナー名、およびそのリソースグループ名<br>・ バックアップ対象 VM 名、およびそのリソースグループ名、OS 名<br>・ リストア先の VM 名、およびそのリソースグループ名、OS 名</p><h3 id="ログ情報-1"><a href="#ログ情報-1" class="headerlink" title="ログ情報"></a>ログ情報</h3><p>zip などにまとめてご提供いただけますと幸いです。</p><ul><li><p><strong>(Windows の場合) “ディスクの管理” の画面の画面ショット</strong><br><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_01.png"></p></li><li><p><strong>実行したスクリプト、および実行後に作成されたフォルダ一式</strong></p><ul><li><p><strong>Windowsの場合</strong><br>・ スクリプトファイル : IaaSVMILRExeForWindows.exe<br>・ スクリプト実行後に作成されるフォルダー : <code>仮想マシン名(小文字)+スクリプトファイル実行日時</code></p><p>下記例では “okt-temp-win-20220212145642” が作成されています。<br><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_02.png"></p><p>“okt-temp-win-20220212145642”の中身<br><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_03.png"></p></li><li><p><strong>Linux の場合</strong><br>・ スクリプトファイル : </p><blockquote><p>例) <strong>vm02kensho_1_jpe_6591639015130036692_802427195716_899298aac7c04bf094ad68bfc5b9584ed206b94b62d965.py</strong><br>※ 上記「vm02kensho」の箇所に、小文字の仮想マシン名が含まれます</p></blockquote><p>・ スクリプト実行後に作成されるフォルダー : <code>仮想マシン名(小文字)+スクリプトファイル実行日時/Script</code></p><p>スクリプトを実行後、「<strong>vm02kensho-20220212151619</strong>」ディレクトリが自動生成されていることがわかる。<br><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_04.png"></p><blockquote><p>ls -all</p></blockquote><p><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_05.png" alt="「vm02kensho-20220212151619」ディレクトリが自動生成されている"></p><p>「vm02kensho-20220212151619」ディレクトリの中身、および作成されたディレクトリの <strong>Scripts ディレクトリ</strong>の中身は下記の通り</p><blockquote><p>ls -allR</p></blockquote><p><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_06.png" alt="「vm02kensho-20220212151619」ディレクトリの中身,および作成されたディレクトリの Scripts ディレクトリの中身"></p></li></ul></li></ul><hr><h2 id="3-Azure-Backup-for-SAP-HANA-in-Azure-VM-の障害調査に必要なログ"><a href="#3-Azure-Backup-for-SAP-HANA-in-Azure-VM-の障害調査に必要なログ" class="headerlink" title="3. Azure Backup for SAP HANA in Azure VM の障害調査に必要なログ"></a>3. Azure Backup for SAP HANA in Azure VM の障害調査に必要なログ<a id="3"></a></h2><h3 id="3-0-環境情報とログ"><a href="#3-0-環境情報とログ" class="headerlink" title="3.0 環境情報とログ"></a>3.0 環境情報とログ</h3><p><span style="color: red; "> <strong><a href="#1">1. Azure VM バックアップの障害調査に必要なログ</a> の 環境情報 ならびに ログ情報 - Linuxの場合</strong> </span> の取得をお願いいたします。</p><h3 id="3-1-SAP-HANA-の-backup-log-及び-backint-log"><a href="#3-1-SAP-HANA-の-backup-log-及び-backint-log" class="headerlink" title="3.1 SAP HANA の backup.log 及び backint.log "></a>3.1 SAP HANA の backup.log 及び backint.log <a id="3-1"></a></h3><blockquote><ul><li>xx にはインスタンスナンバーが入ります。<ul><li>/hana/shared/HXE/HDBxx/(hostname)/trace/backup.log</li><li>/hana/shared/HXE/HDBxx/(hostname)/trace/DB_&lt;DB名&gt;/backup.log</li><li>/hana/shared/HXE/HDBxx/(hostname)/trace/backint.log</li><li>/hana/shared/HXE/HDBxx/(hostname)/trace/DB_&lt;DB名&gt;/backint.log</li></ul></li></ul></blockquote><p>※ お手数ですが、全ての DB の backup.log 及び backint.log の採取をお願いいたします。<br>※ 上記パスに該当のログが無い場合は以下を試し、コマンド実行結果に表示されるディレクトリの場所のログをアップロードしてください。</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo -i # rootユーザーに切り替えます</span><br><span class="line">cd /    # ディレクトリの最上層に移動します</span><br><span class="line">find ./ -name &quot;backup.log&quot;  # findコマンドにより該当のログの場所を特定します</span><br><span class="line">find ./ -name &quot;backint.log&quot; # findコマンドにより該当のログの場所を特定します</span><br></pre></td></tr></table></figure><h3 id="3-2-opt-配下の-log"><a href="#3-2-opt-配下の-log" class="headerlink" title="3.2 opt 配下の log "></a>3.2 opt 配下の log <a id="3-2"></a></h3><p>/opt/msawb/var/log ディレクトリ配下のファイルを zip 等におまとめのうえで、アップロードしてください。</p><hr><h2 id="4-MARS-Microsoft-Azure-Recovery-Services-エージェントを利用したバックアップ-の障害調査に必要なログ"><a href="#4-MARS-Microsoft-Azure-Recovery-Services-エージェントを利用したバックアップ-の障害調査に必要なログ" class="headerlink" title="4. MARS (Microsoft Azure Recovery Services) エージェントを利用したバックアップ の障害調査に必要なログ"></a>4. MARS (Microsoft Azure Recovery Services) エージェントを利用したバックアップ の障害調査に必要なログ<a id="4"></a></h2><h3 id="4-0-環境情報と-Windows-ログ"><a href="#4-0-環境情報と-Windows-ログ" class="headerlink" title="4.0 環境情報と Windows ログ"></a>4.0 環境情報と Windows ログ</h3><p><span style="color: red; "> <strong><a href="#1">1. Azure VM バックアップの障害調査に必要なログ</a> の 環境情報 ならびに ログ情報 - Windows の場合</strong> </span> の取得をお願いいたします。<br>※ MARS バックアップ のバックアップ対象の環境が Azure VM でない場合は Azure VM 名 / VM リソース グループ名は不要です。</p><p>上記に加えて下記もご対応お願いいたします。</p><h3 id="4-1-MARS-Microsoft-Azure-Recovery-Services-エージェントのログ"><a href="#4-1-MARS-Microsoft-Azure-Recovery-Services-エージェントのログ" class="headerlink" title="4.1 MARS (Microsoft Azure Recovery Services) エージェントのログ "></a>4.1 MARS (Microsoft Azure Recovery Services) エージェントのログ <a id="4-1"></a></h3><p>まず、下記 リンク先から調査用スクリプトをダウンロードしてください。<br><a href="https://github.com/jpabrs-scem/blog/files/10148102/WABDiag.zip">WABDiag.zip</a></p><p>ダウンロードいただきました WABDiag.tx を .ps1 に変更して使用し、問題が発生しているマシンより Azure Backup ログの収集をお願いいたします。<br>※ ファイルの解凍パスワードは “AzureBackup” となります。</p><ol><li>WABDiag.ps1 を管理者権限の PowerShell で実行します。</li></ol><blockquote><p>実行コマンド : &lt;スクリプトのパス&gt;\WABDiag.ps1 &lt;パス\保存するフォルダ名&gt;<br>実行例 : C:\WABDiag\WABDiag.ps1 C:\Logs</p></blockquote><p>   実行結果にファイル パスが無い旨のメッセージが表示される可能性がございますが、対象のファイル自体が無い事を示すメッセージとなりますので、無視していただいて問題ございません。</p><p><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_07.png" alt="WABDiag.ps1出力ファイル"></p><h4 id="PowerShell-の実行ポリシーの制限によりスクリプトが実行できない場合"><a href="#PowerShell-の実行ポリシーの制限によりスクリプトが実行できない場合" class="headerlink" title="PowerShell の実行ポリシーの制限によりスクリプトが実行できない場合"></a>PowerShell の実行ポリシーの制限によりスクリプトが実行できない場合</h4><p>PowerShellを管理者権限で起動し、下記コマンドを実行し実行ポリシーを変更後、再度実行していただけますでしょうか。</p><blockquote><p>コマンド : Set-ExecutionPolicy Unrestricted</p></blockquote><p>また現在の実行ポリシーを後ほど元に戻す場合は、変更前に下記コマンドを実行し、設定されているポリシーを確認、メモし、スクリプト実行後に同様の手順で変更していただきますようお願いいたします。</p><blockquote><p>コマンド : Get-ExecutionPolicy </p></blockquote><ul><li>参考<br>実行ポリシーについて - PowerShell<br><a href="https://docs.microsoft.com/ja-jp/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.2">https://docs.microsoft.com/ja-jp/powershell/module/microsoft.powershell.core/about/about_execution_policies?view=powershell-7.2</a></li></ul><h3 id="4-2-システム情報"><a href="#4-2-システム情報" class="headerlink" title="4.2 システム情報 "></a>4.2 システム情報 <a id="4-2"></a></h3><ol><li>対象のマシンに管理者権限を保持するユーザーでログオンします。</li><li>管理者権限でコマンド プロンプトを起動し、以下のコマンドで取得します。<blockquote><p>msinfo32 /nfo &lt;出力ファイル名&gt;<br>実行例) msinfo32 /nfo SVR_msinfo32.nfo</p></blockquote></li><li>生成されたファイルをご提供ください。<br><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_08.png" alt="システム情報"></li></ol><h3 id="4-3-イベント-ログ"><a href="#4-3-イベント-ログ" class="headerlink" title="4.3 イベント ログ"></a>4.3 イベント ログ<a id="4-3"></a></h3><ol><li>対象のマシンに管理者権限を保持するユーザーでログオンします。</li><li>[スタート] &gt; [管理ツール] &gt; [イベント ビューアー] を開きます。</li><li>左側ペインの以下のイベントに対して、右クリックをし、[すべてのイベントを名前をつけて保存] を選択し、ファイルの種類が “イベント ファイル (<em>.evtx)” であることを確認し、任意の名前を付けて、[保存] をクリックします。<br>※ ファイルの種類が “イベント ファイル (</em>.csv)” も併せて取得をお願いいたします。<br>a) [イベント ビューアー (ローカル)] - [Windows ログ] - [システム]<br>b) [イベント ビューアー (ローカル)] - [Windows ログ] - [Application]</li><li>保存したイベント ログ ファイルをご提供ください。</li></ol><h3 id="4-4-各種証明書の確認およびインポート"><a href="#4-4-各種証明書の確認およびインポート" class="headerlink" title="4.4 各種証明書の確認およびインポート"></a>4.4 各種証明書の確認およびインポート<a id="4-4"></a></h3><p>下記詳細手順のもと、証明書をご確認いただき、その画面キャプチャを zip などにおまとめの上ご提供お願いいたします。</p><h4 id="証明書の確認方法"><a href="#証明書の確認方法" class="headerlink" title="証明書の確認方法"></a>証明書の確認方法</h4><p>対象マシン上で [スタート] &gt; [ファイル名を指定して実行] &gt; “certlm.msc” と入力して [OK] を選択し、以下項目 4.4.1, 4.4.2 の証明書が存在するかご確認ください。<br>※ Windows Server 2012 以前の OS の場合は、MMC スナップインより証明書スナップインを起動してください。</p><p><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_09.png"><br><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_10.png"></p><h3 id="4-4-1-個人-gt-証明書"><a href="#4-4-1-個人-gt-証明書" class="headerlink" title="4.4.1 個人 &gt; 証明書"></a>4.4.1 個人 &gt; 証明書<a id="4-4-1"></a></h3><p>[個人] &gt; [証明書] にて、下記 2 つの証明書が存在することを確認し、その画面キャプチャをご提供ください。<br>※ もし下記証明書が存在していなかった場合には、その点ご返信いただけますと幸いです。</p><blockquote><p>・ CB_&lt;MARS のバックアップを実施する予定の Recovery Services コンテナー名&gt;-xx-xx-xxxx-vaultcredentials<br>・ CB_&lt;ホスト名&gt;._xxxxxxxxxxxxxxxxxx</p></blockquote><p><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_11.png"></p><p>もし「CB_&lt;ホスト名&gt;._xxxxxxxxxxxxxxxxxx」の証明書の期限がきれている場合には、MARS エージェントが正常に起動しない可能性があります。<br>その際には、下記を参考に MARS エージェントの再インストールを実施してください。それにより証明書も再インストールされます。<br>・ MARS エージェントの再インストール手順<br>　 <a href="https://jpabrs-scem.github.io/blog/MARSBackup/How_to_re-install/">https://jpabrs-scem.github.io/blog/MARSBackup/How_to_re-install/</a></p><h3 id="4-4-2-信頼されたルート証明書-gt-証明書"><a href="#4-4-2-信頼されたルート証明書-gt-証明書" class="headerlink" title="4.4.2 信頼されたルート証明書 &gt; 証明書 "></a>4.4.2 信頼されたルート証明書 &gt; 証明書 <a id="4-4-2"></a></h3><p>[信頼されたルート証明機関] &gt; [証明書] にて、下記ドキュメントに記載されているルート証明書がすべて存在することを確認し、その画面キャプチャをご提供ください。</p><p>・ ルート証明機関 / Azure 証明機関の詳細 | Microsoft Learn<br>　 <a href="https://learn.microsoft.com/ja-jp/azure/security/fundamentals/azure-CA-details?tabs=root-and-subordinate-cas-list#root-certificate-authorities">https://learn.microsoft.com/ja-jp/azure/security/fundamentals/azure-CA-details?tabs=root-and-subordinate-cas-list#root-certificate-authorities</a></p><p>また、ドキュメントに記載されているルート証明書の “Thumbprint” の値と、対象のマシンにて証明書をダブル クリックし、[詳細] &gt; [拇印] で表示されている値が一致していることを確認し、その画面キャプチャを併せてご提供ください。</p><p><img src="/blog/AzureBackupGeneral/RequestForInvestigating/RequestForInvestigating_12.png"></p><p>もし上記ドキュメントに記載されているルート証明書が一部存在していない場合には、MARS エージェントが正常に起動しない可能性があります。<br>その際には、下記 <a href="#4-4-3">4-4-3. 証明書インポート手順</a> を参考に、証明書のインポートを実施してください。</p><h3 id="4-4-3-証明書インポート手順"><a href="#4-4-3-証明書インポート手順" class="headerlink" title="4.4.3 証明書インポート手順 "></a>4.4.3 証明書インポート手順 <a id="4-4-3"></a></h3><ol><li>証明書をインポートしたいマシンに、管理者権限でログインします。</li><li>[スタート] &gt; [ファイル名を指定して実行] &gt; “certlm.msc” と入力して [OK] を選択します。<br>※ Windows Server 2012 以前の OS の場合は、MMC スナップインより証明書スナップインを起動してください。</li><li>ユーザーアカウント制御が起動する場合は管理者権限での実行を許可します。</li><li>左側の [証明書 (ローカル コンピューター)] を展開し、[信頼されたルート証明機関] &gt; [証明書] を開きます。</li><li>[証明書] を右クリックし [すべてのタスク] &gt; [インポート] を選択します。</li><li>証明書のインポート ウィザードが起動しますので、下記の様に進めます。<ul><li>「証明書のインポート ウィザードの開始」画面で [次へ] をクリック。</li><li>「インポートする証明書のファイル」にて、上記ドキュメントよりダウンロードした証明書を選択します。</li><li>「証明書ストア」にて、[証明書をすべて次のストアに配置する] &gt; [信頼されたルート証明機関] を選択します。</li><li>「証明書のインポート ウィザードの完了」にて、[完了] を選択します。</li></ul></li><li>[信頼されたルート証明機関] &gt; [証明書] ストアに証明書がインポートされた事を確認します。</li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;みなさんこんにちは、Azure Backup サポートです。&lt;br&gt;今回は Azure Backup のバックアップ失敗、リストア失敗の時の調査をするにあたり、提供いただきたい情報をお伝えいたします。&lt;br&gt;なお、 Azure</summary>
      
    
    
    
    
    <category term="Azure Backup General" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Backup-General/"/>
    
    <category term="情報採取" scheme="https://jpabrs-scem.github.io/blog/tags/%E6%83%85%E5%A0%B1%E6%8E%A1%E5%8F%96/"/>
    
  </entry>
  
  <entry>
    <title>テナント制限により Microsoft Entra ID (旧称 Azure Active Directory) 向けの通信に失敗する</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureSQLBackup/CommunicationFails-DueTo-TenantRestrictions/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureSQLBackup/CommunicationFails-DueTo-TenantRestrictions/</id>
    <published>2025-03-17T03:00:00.000Z</published>
    <updated>2026-01-29T02:14:33.052Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>みなさんこんにちは、Azure Backup サポートです。</p><p>MARS バックアップや SQL Server バックアップなどのバックアップにおいて、お客様によってはバックアップや復元で使用する通信がプロキシを経由する構成とされていることがあります。<br>ご利用のプロキシでテナント制限の構成をしている場合、Microsoft Entra ID (旧称 Azure Active Directory) への通信ができず、バックアップ対象のサーバーからバックアップサービス利用のための Azure 認証が失敗することで、バックアップの有効化をはじめとした各種操作ができないことがあります。 </p><p>このブログでは、バックアップ対象のサーバーのプロキシ環境でテナント制限をしている場合のバックアップの失敗について、テナント制限が原因でバックアップが失敗しているかの判断方法と対応方法について記載してます。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. テナント制限とは</a><br><a href="#2">2. テナント制限されている場合の判断方法について (Azure Portal へのログインによる確認)</a><br><a href="#3">3. テナント制限されている場合の判断方法について (Backup のログからの確認)</a><br><a href="#4">4. 回避策について</a></p><hr><h2 id="1-テナント制限とは"><a href="#1-テナント制限とは" class="headerlink" title=" 1.  テナント制限とは"></a><a id="1"></a> 1.  テナント制限とは</h2><p>以下のブログ引用に記載がございますが、テナント制限をすることでプロキシを経由した通信について特定の Microsoft Entra ID テナント以外のアクセスが制限されます。　</p><p>・ブログ引用</p><blockquote><p>テナント制限の機能では、ユーザーがアクセス可能な Azure AD テナントを制限することが可能です。<br>具体的には、クライアント端末から Azure AD に対する認証の通信をプロキシ経由させ、そのプロキシから送信されるデータに許可対象の Azure AD テナントの情報を付与します。その結果、それ以外の Azure AD テナントへのアクセスがブロックされる動作となります。</p></blockquote><p>・テナント制限とは | テナント制限について<br><a href="https://jpazureid.github.io/blog/azure-active-directory/tenant-restriction/#%E3%83%86%E3%83%8A%E3%83%B3%E3%83%88%E5%88%B6%E9%99%90%E3%81%A8%E3%81%AF">https://jpazureid.github.io/blog/azure-active-directory/tenant-restriction/#%E3%83%86%E3%83%8A%E3%83%B3%E3%83%88%E5%88%B6%E9%99%90%E3%81%A8%E3%81%AF</a></p><h2 id="2．テナント制限されている場合の判断方法について-Azure-Portal-へのログインによる確認"><a href="#2．テナント制限されている場合の判断方法について-Azure-Portal-へのログインによる確認" class="headerlink" title=" 2．テナント制限されている場合の判断方法について (Azure Portal へのログインによる確認)"></a><a id="2"></a> 2．テナント制限されている場合の判断方法について (Azure Portal へのログインによる確認)</h2><p>バックアップ対象のサーバーから Azure Potal を利用しテナント制限によって許可されていないテナントへアクセスを試行すると、 「ネットワーク管理者によってアクセスがブロックされました」という以下のようなエラーメッセージが表示されます。 (エラーコード: AADSTS500021)<br>このメッセージを確認できた場合、テナント制限によりサーバーからのテナントアクセスが制限されていると判断できます。</p><p><img src="/blog/AzureSQLBackup/CommunicationFails-DueTo-TenantRestrictions/CommunicationFails-DueTo-TenantRestrictions_01.png" alt="image"></p><p>・テナント制限とは | テナント制限について<br><a href="https://jpazureid.github.io/blog/azure-active-directory/tenant-restriction/#%E3%83%86%E3%83%8A%E3%83%B3%E3%83%88%E5%88%B6%E9%99%90%E3%81%A8%E3%81%AF">https://jpazureid.github.io/blog/azure-active-directory/tenant-restriction/#%E3%83%86%E3%83%8A%E3%83%B3%E3%83%88%E5%88%B6%E9%99%90%E3%81%A8%E3%81%AF</a></p><p>以下のドキュメント引用からもテナント制限されている場合に出力されるエラーコードであることがわかります。</p><p>・ドキュメント引用</p><blockquote><p>AADSTS500021<br>‘{tenant}’ テナントへのアクセスが拒否されました。 AADSTS500021 は、テナント制限機能が構成されており、ユーザーが、ヘッダー Restrict-Access-To-Tenant で指定されている許可されたテナントの一覧にないテナントにアクセスしようとしていることを示します。 </p></blockquote><p>・Microsoft Entra 認証と承認のエラー コード<br><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/reference-error-codes">https://learn.microsoft.com/ja-jp/azure/active-directory/develop/reference-error-codes</a></p><h2 id="3．テナント制限されている場合の判断方法について-Backup-のログからの確認"><a href="#3．テナント制限されている場合の判断方法について-Backup-のログからの確認" class="headerlink" title=" 3．テナント制限されている場合の判断方法について (Backup のログからの確認)"></a><a id="3"></a> 3．テナント制限されている場合の判断方法について (Backup のログからの確認)</h2><p>バックアップ対象のサーバーのログからもテナント制限されているか確認することができます。<br>各ログに「AADSTS500021」の文字列がある場合、テナント制限されていると判断できます。</p><p>以下にログファイル名とログが格納されるディレクトリをご案内します。<br>(ログが格納されるディレクトリは既定の設定の場合を示しています)</p><h4 id="＜Azure-Backup-for-SQL-in-VM-の場合＞"><a href="#＜Azure-Backup-for-SQL-in-VM-の場合＞" class="headerlink" title="＜Azure Backup for SQL in VM の場合＞"></a>＜Azure Backup for SQL in VM の場合＞</h4><p>・ログファイル名<br>　WorkloadExtensionHandlerXX.log<br>・ディレクトリ<br>　WindowsAzure\Logs\Plugins\Microsoft.Azure.RecoveryServices.WorkloadBackup.AzureBackupWindowsWorkload\バージョン\WorkloadExtnLogFolder<br>・エラー出力例 </p><blockquote><p>Microsoft.IdentityModel.Clients.ActiveDirectory.AdalServiceException:<br>　AADSTS500021: Access to ‘IDMAADTenantjpepod01’ tenant is denied.</p></blockquote><h4 id="＜Microsoft-Azure-Recovery-Services-MARS-の場合＞"><a href="#＜Microsoft-Azure-Recovery-Services-MARS-の場合＞" class="headerlink" title="＜Microsoft Azure Recovery Services (MARS) の場合＞"></a>＜Microsoft Azure Recovery Services (MARS) の場合＞</h4><p>・ログファイル名<br>　CBEngine XX.errlog<br>・ディレクトリ<br>　C:\Program Files\Microsoft Azure Recovery Services Agent\Temp<br>・ディレクトリ(MABS)<br>　C:\Program Files\Microsoft Azure Backup Server\DPM\MARS\Microsoft Azure Recovery Services Agent\Temp\<br>・エラー出力例 </p><blockquote><p>WARNING Exception in GetAADToken | Params: {Data = }{Message = AADSTS500021: Access to ‘IDMAADTenantjpepod01’ tenant is denied.</p></blockquote><h2 id="4．回避策について"><a href="#4．回避策について" class="headerlink" title=" 4．回避策について"></a><a id="4"></a> 4．回避策について</h2><p>バックアップが失敗している対象サーバーから「AADSTS500021」のメッセージが出力されている場合、テナント制限が原因でバックアップが失敗している可能性がございます。<br>ご利用のプロキシ環境において、以下テナントへのアクセス許可設定についてご確認ください。 </p><p>Azure Backup では、O365 の以下のテナントに接続が必要です。<br>以下は、バックアップ利用の際に使用されるテナントになります。</p><p>IDMServiceAADTenant&lt;リージョン&gt;pod01.onmicrosoft.com</p><p>お客様の環境のリージョンに合わせて、以下テナントのアクセスを許可してください。<br>※現時点でテナント名やテナント ID の公開情報はないため、以下のリージョン以外のテナント名やテナント ID の確認がご希望の場合、Azure Backup の窓口へお問い合わせをお願いいたします。</p><h4 id="＜東日本リージョンの-Azure-Backup-のテナント情報＞"><a href="#＜東日本リージョンの-Azure-Backup-のテナント情報＞" class="headerlink" title="＜東日本リージョンの Azure Backup のテナント情報＞"></a>＜東日本リージョンの Azure Backup のテナント情報＞</h4><p>テナント名 : IDMServiceAADTenantjpepod01.onmicrosoft.com<br>テナント ID : 6e92595a-0b9c-49e4-a1e9-884d0ab4f4f0</p><h4 id="＜西日本リージョンの-Azure-Backup-のテナント情報＞"><a href="#＜西日本リージョンの-Azure-Backup-のテナント情報＞" class="headerlink" title="＜西日本リージョンの Azure Backup のテナント情報＞"></a>＜西日本リージョンの Azure Backup のテナント情報＞</h4><p>テナント名 : IDMServiceAADTenantjpwpod01.onmicrosoft.com<br>テナント ID : 4617fbbe-e76e-4071-90cd-6f5e7f5d5244</p><blockquote><p>備考：<br>テナント制限の操作に関してご確認したい場合、Entra ID のお問合せをお願いいたします。<br>専門のエンジニアが対応することで円滑で正確な対応が可能となります。</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;みなさんこんにちは、Azure Backup サポートです。&lt;/p&gt;
&lt;p&gt;MARS バックアップや SQL Server バックアップなどのバックアップにおいて、お客様によってはバックアップや復元で使用する通信がプロキシを経</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure SQL Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-SQL-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Oracle DB の Azure VM Backup について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Oracle_vm_backup/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/Oracle_vm_backup/</id>
    <published>2025-03-17T03:00:00.000Z</published>
    <updated>2026-01-29T02:14:33.209Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>みなさんこんにちは、Azure Backup サポートです。<br>今回は、「Oracle DB を導入している Azure 仮想マシンを Azure VM Backup でバックアップ/リストアすることは可能か」という点について説明します。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. Oracle DB を導入している Azure 仮想マシンを Azure VM Backup でバックアップ/リストアすることは可能か</a><br><a href="#1-1">1-1. Oracle DB が搭載される Azure 仮想マシンが Windows OS の場合</a><br><a href="#1-2">1-2. Oracle DB が搭載される Azure 仮想マシンが Linux OS の場合</a></p><hr><h3 id="1-Oracle-DB-を導入している-Azure-仮想マシンを-Azure-VM-Backup-でバックアップ-リストアすることは可能か"><a href="#1-Oracle-DB-を導入している-Azure-仮想マシンを-Azure-VM-Backup-でバックアップ-リストアすることは可能か" class="headerlink" title="1. Oracle DB を導入している Azure 仮想マシンを Azure VM Backup でバックアップ/リストアすることは可能か"></a><a id="1"></a>1. Oracle DB を導入している Azure 仮想マシンを Azure VM Backup でバックアップ/リストアすることは可能か</h3><p>「Azure VM Backup」は、Azure 仮想マシン単位でバックアップできるサービスです。<br>Azure 仮想マシン自体のバックアップ、リストアという観点では可能でございます。<br>ただし、対象 Azure 仮想マシン の OS が Windows か Linux かによって、取得されるスナップショットの整合性や、お客様にて参照いただきたい公開ドキュメントが異なってまいります。</p><p>・ スナップショットの整合性<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#snapshot-consistency">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#snapshot-consistency</a></p><p>Azure VM Backup をご利用いただくにあたって、前提となるサポート マトリックスや、一般的なバックアップ/リストア手順は下記をご参照ください。</p><p>・ Azure VM バックアップのサポート マトリックス - Azure Backup | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas">https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas</a></p><p>・ Recovery Services コンテナーに Azure VM をバックアップする - Azure Backup | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-vms-prepare">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-vms-prepare</a></p><p>・ Azure portal を使用して VM を復元する - Azure Backup | Microsoft Learn<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms</a></p><h4 id="1-1-Oracle-DB-が搭載される-Azure-仮想マシンが-Windows-OS-の場合"><a href="#1-1-Oracle-DB-が搭載される-Azure-仮想マシンが-Windows-OS-の場合" class="headerlink" title="1-1. Oracle DB が搭載される Azure 仮想マシンが Windows OS の場合"></a><a id="1-1"></a>1-1. Oracle DB が搭載される Azure 仮想マシンが Windows OS の場合</h4><p>Windows OS の Azure VM Backup を取得する際、仕様として OS 内部の VSS (ボリューム シャドウ コピー サービス) と呼ばれるサービスと連携してバックアップ データ (= スナップショット) を取得します。<br>VSS に対応したアプリケーションにおいては、アプリケーション レベルの整合性を担保したスナップショットを取得することが可能ですので、Oracle DB 側で VSS に対応していれば、「アプリケーション整合性」にてバックアップが取得可能です。<br>ご利用の Oracle DB が VSS に対応しているかが不明な場合は別途 Oracle 社にお問い合わせいただけますと幸いです。<br>もし、ご利用いただく予定の Oracle DB が VSS に対応していない場合、Oracle DB のアプリケーションの整合性は担保いたしませんが、Azure VM Backup 自体のバックアップ取得は可能でございます。</p><p>下記情報は弊社外のサイトでございますが、ご参考になれば幸いです。<br>弊社情報ではございませんのでその点ご留意ください。</p><p>・ (Oracle社) VSSを使用したデータベースのバックアップおよびリカバリの目的<br>  ※Oracle DB すべてが VSS に対応しているかはわかりかねますので、Oracle 社へとお問い合わせください。<br>　<a href="https://docs.oracle.com/cd/F19136_01/ntqrf/purpose-of-database-backup-and-recovery-with-vss.html#GUID-6A44D80C-0427-4DB8-AD3C-BD5426AECC2B">https://docs.oracle.com/cd/F19136_01/ntqrf/purpose-of-database-backup-and-recovery-with-vss.html#GUID-6A44D80C-0427-4DB8-AD3C-BD5426AECC2B</a></p><p>なおこの点は下記ブログにも同様の内容を説明しております。</p><p>・ 1.3 Oracle DB for Windows VM の Azure VM Backup について<br>　<a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#1-3">https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/#1-3</a></p><h4 id="1-2-Oracle-DB-が搭載される-Azure-仮想マシンが-Linux-OS-の場合"><a href="#1-2-Oracle-DB-が搭載される-Azure-仮想マシンが-Linux-OS-の場合" class="headerlink" title="1-2. Oracle DB が搭載される Azure 仮想マシンが Linux OS の場合"></a><a id="1-2"></a>1-2. Oracle DB が搭載される Azure 仮想マシンが Linux OS の場合</h4><p>以下二種類の方法いずれかで Oracle DB の「アプリケーション整合性」を担保したバックアップを取得することが可能となります。<br> （一種類目）Oracle データベースの バージョンが <strong><font color="DeepPink">12 未満</font></strong> の場合、貴社にて事前/事後スクリプトをご準備いただくことで、Azure VM Backup にて「アプリケーション整合性」のバックアップが可能となります。<br> （二種類目）OS が <strong><font color="DeepPink">「Oracle Linux」</font></strong> かつ、Oracle データベースの バージョンが <strong><font color="DeepPink">12.1 以上</font></strong> の場合、貴社にて事前/事後スクリプトをご準備する<span style="color: red; ">必要なく</span>、Azure VM Backup にて「アプリケーション整合性」のバックアップが可能となります。</p><p> 必要な事前作業と DB 復元時の作業詳細については、以下ドキュメントをご参照ください。</p><p>・（一種類目 参考）Linux VM のアプリケーション整合性バックアップ - Azure Backup | Microsoft Docs<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-linux-app-consistent">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-linux-app-consistent</a></p><p>・（二種類目 参考）Linux データベースのマネージド事前/事後スクリプトのサポート マトリックス<br>　<a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#support-matrix-for-managed-pre-and-post-scripts-for-linux-databases">https://learn.microsoft.com/ja-jp/azure/backup/backup-support-matrix-iaas#support-matrix-for-managed-pre-and-post-scripts-for-linux-databases</a><br>　 抜粋 :<br><img src="/blog/AzureVMBackup/Oracle_vm_backup/support-matrix-for-managed-pre-and-post-scripts-for-linux-databases.png"></p><p>・（二種類目 参考）Azure Backup を使用して Azure Linux VM で Oracle Database をバックアップおよび復旧する（作業詳細記載あり） - Azure Virtual Machines | Microsoft Docs<br>　<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/workloads/oracle/oracle-database-backup-azure-backup?msclkid=f5e49016bd1811ec9d618313a2d3bc55&amp;tabs=azure-portal">https://learn.microsoft.com/ja-jp/azure/virtual-machines/workloads/oracle/oracle-database-backup-azure-backup?msclkid=f5e49016bd1811ec9d618313a2d3bc55&amp;tabs=azure-portal</a><br>　“現在のところ、拡張フレームワークでサポートされているアプリケーションは Oracle 12.x 以降と MySQL です。”</p><p>説明は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;みなさんこんにちは、Azure Backup サポートです。&lt;br&gt;今回は、「Oracle DB を導入している Azure 仮想マシンを Azure VM Backup でバックアップ/リストアすることは可能か」という点につ</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backup [既存を置換] リストア について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/restore_swapdsik/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/restore_swapdsik/</id>
    <published>2025-03-17T03:00:00.000Z</published>
    <updated>2026-01-29T02:14:33.214Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートです。<br>今回は、Azure VM Backup で　[既存を置換] を用いる場合にいただくご質問について下記の通りご案内いたします。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. [既存を置換]の際、元のディスクはどうなるのか</a><br><a href="#2">2. [既存を置換]の際、 バックアップが走る件について</a><br><a href="#2-1">2.1. バックアップを走らせない方法 1</a><br><a href="#2-2">2.2. バックアップを走らせない方法 2</a></p><hr><h2 id="1-既存を置換-の際、元のディスクはどうなるのか"><a href="#1-既存を置換-の際、元のディスクはどうなるのか" class="headerlink" title=" 1. [既存を置換]の際、元のディスクはどうなるのか"></a><a id="1"></a> 1. [既存を置換]の際、元のディスクはどうなるのか</h2><p>結論から申し上げますと削除されずに残ります。<br>Azure VM Backup のリストアの [既存を置換] はバックアップ データよりディスクを復元し、 Azure VM のディスクを置き換えるまでを行います。<br>そのため、元の古いディスクは削除されずにディスク リソースとして残り続けます (課金も行われます)。そのため、不要な場合は手動で削除いただく必要がございます。</p><p>なお、リストアによって復元されるディスクの命名規則に関しては下記をご覧ください。<br>・Azure VM Backupでリストアされるディスク名に関して<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/About_Restored_Disk/">https://jpabrs-scem.github.io/blog/AzureVMBackup/About_Restored_Disk/</a></p><p>下記公開情報にも記載されております。<br>・既存のものを置き換える - 復元オプション- Azure portal で Azure VM データを復元する方法<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms</a></p><blockquote><p>ディスクの交換操作の後、元のディスクはリソース グループに保持されます。 元のディスクが必要ない場合は、それを手動で削除することを選択できます。</p></blockquote><h2 id="2-既存を置換-の際、-バックアップが走る件について"><a href="#2-既存を置換-の際、-バックアップが走る件について" class="headerlink" title=" 2. [既存を置換]の際、 バックアップが走る件について"></a><a id="2"></a> 2. [既存を置換]の際、 バックアップが走る件について</h2><p>現在の仕様として [既存を置換] のリストアを行う際には、ディスクを置き換える前の状態のバックアップを取得するために、リストアジョブと並行してバックアップ ジョブが自動で実施されます。</p><p>このバックアップ ジョブは、復元時のオプション <code>[復元前のバックアップをスキップする]</code> を有効化することで、スキップすることが可能でございます。<br>詳細につきましては、<a href="#2-1">2.1. バックアップを走らせない方法 1</a> にてご案内いたします。</p><p>なお、バックアップを無効にしている、且つ復元時のオプション <code>[復元前のバックアップをスキップする]</code> を無効化していた場合には、バックアップ ジョブが失敗 (※) いたしますのであらかじめご注意ください。<br>(※) : バックアップ ジョブは失敗いたしますが、[既存を置換] のリストアは成功いたします。  </p><h3 id="2-1-バックアップを走らせない方法-1"><a href="#2-1-バックアップを走らせない方法-1" class="headerlink" title=" 2.1. バックアップを走らせない方法 1"></a><a id="2-1"></a> 2.1. バックアップを走らせない方法 1</h3><p>[既存を置換] のリストア時のオプション <code>[復元前のバックアップをスキップする]</code> のチェックを有効化することで、リストア ジョブと並行して動作するバックアップ ジョブがスキップされます。  </p><p>例)<br><img src="/blog/AzureVMBackup/restore_swapdsik/skip_pre_restore_backup.png"></p><h3 id="2-2-バックアップを走らせない方法-2"><a href="#2-2-バックアップを走らせない方法-2" class="headerlink" title=" 2.2. バックアップを走らせない方法 2"></a><a id="2-2"></a> 2.2. バックアップを走らせない方法 2</h3><p>そのほか、[既存を置換] のリストア時の自動で走るバックアップ ジョブを走らせたくない場合は [既存を置換] ではなく、[ディスクの復元] を実施いただき、復元したディスクを手動で Azure VM に対してスワップしていただくことが可能です。</p><p>Azure Portal ＞ 対象の仮想マシン ＞ 左ペインのディスク からディスクのスワップ、デタッチ＆アタッチ が可能です。<br>※　本作業を行った場合も、元々アタッチされていた OS ディスク・ データ ディスクはディスク リソースとして残り続けます。<br>　　ディスクのスワップ・デタッチ＆アタッチ後、元々アタッチされていた OS ディスク・ データ ディスクに対しては、お客様にて不要であれば削除いただけます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートです。&lt;br&gt;今回は、Azure VM Backup で　[既存を置換] を用いる場合にいただくご質問について下記の通りご案内いたします。&lt;/p&gt;
&lt;h2 id=&quot;目次&quot;&gt;&lt;a</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Migrate 移行後の関連リソース削除時のチェックポイント</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureMigrate/howtodeleteRSV/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureMigrate/howtodeleteRSV/</id>
    <published>2025-02-04T03:00:00.000Z</published>
    <updated>2026-01-29T02:14:33.009Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>みなさんこんにちは、Azure Migrate サポートです。<br>今回は Azure Migrate 機能を使って Azure へとマシンを移行後、不要となった Recovery Services コンテナーや、関連する Azure リソースを削除するときのポイントを説明します。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">ポイント 1 : 削除可能な Azure リソースについて</a><br><a href="#2">ポイント 2 : Recovery Services コンテナー上の削除作業について</a></p><hr><h2 id="ポイント-1-削除可能な-Azure-リソースについて"><a href="#ポイント-1-削除可能な-Azure-リソースについて" class="headerlink" title=" ポイント 1 : 削除可能な Azure リソースについて"></a><a id="1"></a> ポイント 1 : 削除可能な Azure リソースについて</h2><p>Azure Migrate 機能を使って Azure へとマシンを移行後、Azure Migrate 関連のリソースを削除したいという場合には<br>削除すべき Azure リソースは「Recovery Services コンテナー」リソース以外にも複数あります。<br>また、以下に挙げるシナリオ例によって、削除対象となる Azure リソースが異なってまいります。</p><ul><li>プライベート エンドポイント経由で Azure へと移行したのか</li><li>物理マシンを Azure へと移行したのか</li><li>VMWare VM をエージェントレス方式で移行したのか</li></ul><p>どのシナリオで、どの Azure リソースが削除対象になるのかは下記ドキュメントにまとめておりますので、シナリオ毎に確認ください。</p><ul><li>(参考) Azure Migrate プロジェクトの削除<br><a href="https://learn.microsoft.com/ja-jp/azure/migrate/how-to-delete-project">https://learn.microsoft.com/ja-jp/azure/migrate/how-to-delete-project</a></li></ul><p>なお、Azure Migrate 関連の Azure リソースを確認する際には、Azure Migrate プロジェクトのリソース グループ &gt; <font color="Red">[非表示の型の表示] </font>をクリックすることで、関連するすべてのリソースが表示されるようになります。<br><img src="/blog/AzureMigrate/howtodeleteRSV/003.png"></p><p>上記のとおり、各種リソースの削除が必要となるため、Azure Migrate プロジェクト用にリソース グループを作成することもご検討ください。<br>Azure Migrate プロジェクト用にリソース グループを作成することで、Azure Migrate プロジェクトが不要になった際に、各種リソースをリソース グループごと削除できるようになります。</p><h2 id="ポイント-2-Recovery-Services-コンテナー上の削除作業について"><a href="#ポイント-2-Recovery-Services-コンテナー上の削除作業について" class="headerlink" title=" ポイント 2 : Recovery Services コンテナー上の削除作業について"></a><a id="2"></a> ポイント 2 : Recovery Services コンテナー上の削除作業について</h2><p>Azure Migrate プロジェクトに紐づいている Recovery Services コンテナーを削除する前には、Recovery Services コンテナー上に存在している複数項目の登録解除や削除作業が必要となります。<br>(先に削除しておかなければ、多くの場合 Recovery Services コンテナーの削除を指示してもエラーとなって Recovery Services コンテナーを削除できません。)<br><img src="/blog/AzureMigrate/howtodeleteRSV/001.png"></p><p>例えば下記作業などが事前に必要となります。</p><ul><li>Recovery Services コンテナーに登録されているレプリケーション ポリシーの削除</li><li>Recovery Services コンテナーに登録されている Hyper-V サイトの削除</li><li>Recovery Services コンテナーに紐づくプライベート エンドポイントの削除</li></ul><p>ただし、[PowerShell スクリプトを使用して削除する] をご利用いただく場合は、スクリプトによって<br>「Recovery Services コンテナー上の関連付け項目の削除」から「Recovery Services コンテナーの削除」まで自動的に行われ、より簡単に削除できます。 </p><ul><li><p>(参考) Site Recovery Services コンテナーを削除する<br><a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/delete-vault">https://learn.microsoft.com/ja-jp/azure/site-recovery/delete-vault</a></p></li><li><p>(参考) ポリシーを編集する | レプリケーション ポリシーの関連付け解除と削除<br><a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/vmware-azure-set-up-replication#edit-a-policy">https://learn.microsoft.com/ja-jp/azure/site-recovery/vmware-azure-set-up-replication#edit-a-policy</a></p></li><li><p>(参考) VMM サーバーの登録解除<br><a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/site-recovery-manage-registration-and-protection#unregister-a-vmm-server">https://learn.microsoft.com/ja-jp/azure/site-recovery/site-recovery-manage-registration-and-protection#unregister-a-vmm-server</a></p></li><li><p>(参考) Hyper-V サイト上の Hyper-V ホストの登録解除<br><a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/site-recovery-manage-registration-and-protection#unregister-a-hyper-v-host-in-a-hyper-v-site">https://learn.microsoft.com/ja-jp/azure/site-recovery/site-recovery-manage-registration-and-protection#unregister-a-hyper-v-host-in-a-hyper-v-site</a></p></li></ul><p>また、Recovery Services コンテナーと関連するリソースに対し、削除のロックがかかっている場合、ロックを解除してから削除する必要があります。<br>ロックについては、ご利用の Azure Migrate プロジェクトのリソース グループ &gt; ロックからロックされているリソースが確認できます。<br><img src="/blog/AzureMigrate/howtodeleteRSV/002.png"></p><p>Azure Migrate 観点では、移行が完了しており、かつ対象の Recovery Services コンテナーが現在その他のレプリケーション等で使用されていない場合、対象の Recovery Services コンテナーの削除を行っても <strong>移行元VM ・移行先 Azure VM・ネットワークには影響いたしません。</strong><br>対象の Recovery Services コンテナーが使用されているかどうかの確認 (現在バックアップもしくはレプリケーションが行われているかどうかの確認) は、お客様にてご確認の上、削除の判断をお願いいたします。</p><p>本記事の内容は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;みなさんこんにちは、Azure Migrate サポートです。&lt;br&gt;今回は Azure Migrate 機能を使って Azure へとマシンを移行後、不要となった Recovery Services コンテナーや、関連する </summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure Migrate" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-Migrate/"/>
    
  </entry>
  
  <entry>
    <title>MARS エージェントの再インストール手順</title>
    <link href="https://jpabrs-scem.github.io/blog/MARSBackup/How_to_re-install/"/>
    <id>https://jpabrs-scem.github.io/blog/MARSBackup/How_to_re-install/</id>
    <published>2025-01-10T03:00:00.000Z</published>
    <updated>2026-01-29T02:14:33.227Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは、Azure Backup サポートです。<br>今回は MARS エージェントの再インストール手順をお伝えさせていただきます。</p><p>なお、なんらかの不具合が発生している場合の MARS エージェントの再インストールは <strong>上書きインストールではなく、必ず 一度アンインストールした上</strong>で実施いただくようお願いいたします。<br>例えば、ネットワーク構成などを変えていないのに、MARS コンソールが立ち上がらなくなった (正常に動作しなくなった) 場合やバックアップ が失敗するようになった等の場合は再インストールが有効な対処策であることが多くございます。</p><p>特に証明書関連のエラーの場合再インストールの前後で証明書に変化があったかご確認いただけますと幸いです。<br>その際は下記記事を参考にして作業前後で証明書をご確認ください。</p><ul><li>4.4 各種証明書の確認証跡 - 4. MARS Backup エージェントを利用したバックアップ の障害調査に必要なログ<br><a href="https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigating/#4-4">https://jpabrs-scem.github.io/blog/AzureBackupGeneral/RequestForInvestigating/#4-4</a></li></ul><div class="alert is-warning"><p class="alert-title">警告</p><p>MARS エージェントの再インストール後も以前のスケジュール バックアップ設定や復元ポイントを利用可能ですが、その際には以前 MARS エージェントのサーバー登録時に利用したパスフレーズが必要となりますので、再インストール時は <strong>パスフレーズがお手元にあることを確認の上</strong>、作業を実行してください。</p></div><hr><p><a href="#1">1. MARS エージェントのアンインストール</a><br><a href="#2">2. MARS エージェントの(再)インストール</a><br><a href="#3">3. サーバーの登録</a><br><a href="#4">4. 関連公開情報</a></p><hr><h2 id="1-MARS-エージェントのアンインストール"><a href="#1-MARS-エージェントのアンインストール" class="headerlink" title=" 1.MARS エージェントのアンインストール"></a><a id="1"></a> 1.MARS エージェントのアンインストール</h2><h3 id="1-1-MARS-バックアップ対象のマシンにログインします"><a href="#1-1-MARS-バックアップ対象のマシンにログインします" class="headerlink" title=" 1-1. MARS バックアップ対象のマシンにログインします"></a><a id="1-1"></a> 1-1. MARS バックアップ対象のマシンにログインします</h3><p>下記のフォルダーをコピーして任意の別の場所に退避しておきます。<br>正常に再インストールが完了した際にはこの退避したフォルダは不要です。</p><blockquote><p>（対象パス）C:\Program Files<br>（コピーする対象のフォルダー）Microsoft Azure Recovery Services Agent</p></blockquote><h3 id="1-2-windows-ボタン-r-を押し、”appwiz-cpl”-と入力し、「OK」＞「プログラムのアンインストールまたは変更」画面を開きます"><a href="#1-2-windows-ボタン-r-を押し、”appwiz-cpl”-と入力し、「OK」＞「プログラムのアンインストールまたは変更」画面を開きます" class="headerlink" title=" 1-2. windows ボタン + r を押し、”appwiz.cpl” と入力し、「OK」＞「プログラムのアンインストールまたは変更」画面を開きます"></a><a id="1-2"></a> 1-2. windows ボタン + r を押し、”appwiz.cpl” と入力し、「OK」＞「プログラムのアンインストールまたは変更」画面を開きます</h3><p><img src="/blog/MARSBackup/How_to_re-install/How_to_re-install_01.png"></p><h3 id="1-3-「Microsoft-Azure-Recovery-Services-Agent」を右クリックし、「アンインストールと変更」をクリックします"><a href="#1-3-「Microsoft-Azure-Recovery-Services-Agent」を右クリックし、「アンインストールと変更」をクリックします" class="headerlink" title=" 1-3.「Microsoft Azure Recovery Services Agent」を右クリックし、「アンインストールと変更」をクリックします"></a><a id="1-3"></a> 1-3.「Microsoft Azure Recovery Services Agent」を右クリックし、「アンインストールと変更」をクリックします</h3><p><img src="/blog/MARSBackup/How_to_re-install/How_to_re-install_02.png"></p><h3 id="1-4-MARS-アプリケーション-のアンインストール-ウィザードが開くため、「アンインストール」をクリックします"><a href="#1-4-MARS-アプリケーション-のアンインストール-ウィザードが開くため、「アンインストール」をクリックします" class="headerlink" title=" 1-4. MARS アプリケーション のアンインストール ウィザードが開くため、「アンインストール」をクリックします"></a><a id="1-4"></a> 1-4. MARS アプリケーション のアンインストール ウィザードが開くため、「アンインストール」をクリックします</h3><p><img src="/blog/MARSBackup/How_to_re-install/How_to_re-install_03.png"></p><h3 id="1-5-アンインストールされたことを確認してください"><a href="#1-5-アンインストールされたことを確認してください" class="headerlink" title=" 1-5. アンインストールされたことを確認してください"></a><a id="1-5"></a> 1-5. アンインストールされたことを確認してください</h3><p><img src="/blog/MARSBackup/How_to_re-install/How_to_re-install_04.png"></p><p>ご調整がつくようであれば、このタイミングで一度 OS 再起動をすることお勧めします。</p><h2 id="2-MARS-エージェントの-再-インストール"><a href="#2-MARS-エージェントの-再-インストール" class="headerlink" title=" 2. MARS エージェントの(再)インストール"></a><a id="2"></a> 2. MARS エージェントの(再)インストール</h2><h3 id="2-1-Azure-Portal-gt-該当のRecovery-Services-コンテナー-gt-設定-–-バックアップ-より以下を選択し、”インフラストラクチャの準備”-をクリックしてください"><a href="#2-1-Azure-Portal-gt-該当のRecovery-Services-コンテナー-gt-設定-–-バックアップ-より以下を選択し、”インフラストラクチャの準備”-をクリックしてください" class="headerlink" title=" 2-1. Azure Portal &gt; 該当のRecovery Services コンテナー &gt; 設定 – バックアップ より以下を選択し、”インフラストラクチャの準備” をクリックしてください"></a><a id="2-1"></a> 2-1. Azure Portal &gt; 該当のRecovery Services コンテナー &gt; 設定 – バックアップ より以下を選択し、”インフラストラクチャの準備” をクリックしてください</h3><blockquote><p>ワークロードはどこで実行されていますか？：オンプレミス<br>何をバックアップしますか？：ファイルとフォルダー</p></blockquote><p><img src="/blog/MARSBackup/How_to_re-install/How_to_re-install_05.png"></p><h3 id="2-2-“Windows-Server-または-Windows-クライアント用エージェントのダウンロード”-をクリックしてください"><a href="#2-2-“Windows-Server-または-Windows-クライアント用エージェントのダウンロード”-をクリックしてください" class="headerlink" title=" 2-2. “Windows Server または Windows クライアント用エージェントのダウンロード” をクリックしてください"></a><a id="2-2"></a> 2-2. “Windows Server または Windows クライアント用エージェントのダウンロード” をクリックしてください</h3><p>*最新版のMARS エージェントインストーラーがダウンロードされます。<br><img src="/blog/MARSBackup/How_to_re-install/How_to_re-install_06.png"></p><h3 id="2-3-ダウンロードしたインストーラーを該当のサーバーにて実行してください"><a href="#2-3-ダウンロードしたインストーラーを該当のサーバーにて実行してください" class="headerlink" title=" 2-3. ダウンロードしたインストーラーを該当のサーバーにて実行してください"></a><a id="2-3"></a> 2-3. ダウンロードしたインストーラーを該当のサーバーにて実行してください</h3><p><img src="/blog/MARSBackup/How_to_re-install/How_to_re-install_07.png"></p><h3 id="2-4-セットアップ-ウィザードが開きますので、ウィザードの案内に従い、MARS-エージェントをインストールしてください"><a href="#2-4-セットアップ-ウィザードが開きますので、ウィザードの案内に従い、MARS-エージェントをインストールしてください" class="headerlink" title=" 2-4. セットアップ ウィザードが開きますので、ウィザードの案内に従い、MARS エージェントをインストールしてください"></a><a id="2-4"></a> 2-4. セットアップ ウィザードが開きますので、ウィザードの案内に従い、MARS エージェントをインストールしてください</h3><p><img src="/blog/MARSBackup/How_to_re-install/How_to_re-install_08.png"></p><h3 id="2-5-インストール完了後、”登録処理を続行”-をクリックしてください"><a href="#2-5-インストール完了後、”登録処理を続行”-をクリックしてください" class="headerlink" title=" 2-5. インストール完了後、”登録処理を続行” をクリックしてください"></a><a id="2-5"></a> 2-5. インストール完了後、”登録処理を続行” をクリックしてください</h3><p><img src="/blog/MARSBackup/How_to_re-install/How_to_re-install_09.png"></p><h3 id="2-6-サーバーの登録ウィザードが開きますので、次の手順に進んでください"><a href="#2-6-サーバーの登録ウィザードが開きますので、次の手順に進んでください" class="headerlink" title=" 2-6. サーバーの登録ウィザードが開きますので、次の手順に進んでください"></a><a id="2-6"></a> 2-6. サーバーの登録ウィザードが開きますので、次の手順に進んでください</h3><p><img src="/blog/MARSBackup/How_to_re-install/How_to_re-install_10.png"></p><h2 id="3-サーバーの登録"><a href="#3-サーバーの登録" class="headerlink" title=" 3. サーバーの登録"></a><a id="3"></a> 3. サーバーの登録</h2><h3 id="3-1-手順-2-2-の画面にて-”最新のRecovery-Services-Agent-を既にダウンロードしたか、使用している”-にチェックし、ダウンロードをクリックしてください"><a href="#3-1-手順-2-2-の画面にて-”最新のRecovery-Services-Agent-を既にダウンロードしたか、使用している”-にチェックし、ダウンロードをクリックしてください" class="headerlink" title=" 3-1. 手順 2-2 の画面にて ”最新のRecovery Services Agent を既にダウンロードしたか、使用している” にチェックし、ダウンロードをクリックしてください"></a><a id="3-1"></a> 3-1. 手順 2-2 の画面にて ”最新のRecovery Services Agent を既にダウンロードしたか、使用している” にチェックし、ダウンロードをクリックしてください</h3><p>*Recovery Services コンテナーの資格情報がダウンロードされます。</p><p><img src="/blog/MARSBackup/How_to_re-install/How_to_re-install_11.png"></p><h3 id="3-2-ダウンロードした資格情報を該当のサーバーに配置してください"><a href="#3-2-ダウンロードした資格情報を該当のサーバーに配置してください" class="headerlink" title="3-2. ダウンロードした資格情報を該当のサーバーに配置してください"></a><a id="3-2"></a>3-2. ダウンロードした資格情報を該当のサーバーに配置してください</h3><p><img src="/blog/MARSBackup/How_to_re-install/How_to_re-install_12.png"></p><h3 id="3-3-手順2-6の画面にて手順3-2でダウンロードした資格情報を選択し、”次へ”-をクリックしてください"><a href="#3-3-手順2-6の画面にて手順3-2でダウンロードした資格情報を選択し、”次へ”-をクリックしてください" class="headerlink" title="3-3. 手順2-6の画面にて手順3-2でダウンロードした資格情報を選択し、”次へ” をクリックしてください"></a><a id="3-3"></a>3-3. 手順2-6の画面にて手順3-2でダウンロードした資格情報を選択し、”次へ” をクリックしてください</h3><p><img src="/blog/MARSBackup/How_to_re-install/How_to_re-install_13.png"></p><h3 id="3-4-以前登録したパスフレーズを入力し、パスフレーズを保存する任意の場所を選択して、”登録”-をクリックして登録を完了してください"><a href="#3-4-以前登録したパスフレーズを入力し、パスフレーズを保存する任意の場所を選択して、”登録”-をクリックして登録を完了してください" class="headerlink" title="3-4. 以前登録したパスフレーズを入力し、パスフレーズを保存する任意の場所を選択して、”登録” をクリックして登録を完了してください"></a><a id="3-4"></a>3-4. 以前登録したパスフレーズを入力し、パスフレーズを保存する任意の場所を選択して、”登録” をクリックして登録を完了してください</h3><p><img src="/blog/MARSBackup/How_to_re-install/How_to_re-install_14.png"></p><h2 id="4-関連公開情報"><a href="#4-関連公開情報" class="headerlink" title="4. 関連公開情報"></a><a id="4"></a>4. 関連公開情報</h2><ul><li><p>MARS エージェントのダウンロード<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/install-mars-agent#download-the-mars-agent">https://learn.microsoft.com/ja-jp/azure/backup/install-mars-agent#download-the-mars-agent</a></p></li><li><p>サーバーにインストールされている MARS エージェントの更新<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/upgrade-mars-agent#update-the-mars-agent-installation-on-the-server">https://learn.microsoft.com/ja-jp/azure/backup/upgrade-mars-agent#update-the-mars-agent-installation-on-the-server</a></p></li><li><p>パスフレーズを忘れた場合、復旧できますか?<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-file-folder-backup-faq#---------------------">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-file-folder-backup-faq#---------------------</a></p></li></ul><p>本記事の内容は以上となります。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは、Azure Backup サポートです。&lt;br&gt;今回は MARS エージェントの再インストール手順をお伝えさせていただきます。&lt;/p&gt;
&lt;p&gt;なお、なんらかの不具合が発生している場合の MARS エージェントの</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="MARS Backup" scheme="https://jpabrs-scem.github.io/blog/tags/MARS-Backup/"/>
    
  </entry>
  
  <entry>
    <title>Azure VM Backupにおける整合性について</title>
    <link href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/"/>
    <id>https://jpabrs-scem.github.io/blog/AzureVMBackup/Consistencies/</id>
    <published>2025-01-10T03:00:00.000Z</published>
    <updated>2026-01-29T02:14:33.171Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>皆様こんにちは。Azure Backup サポートです。<br>今回は Azure VM Backup における整合性に関して具体例も踏まえつつご説明させていただきます。</p><p>まず、Azure VM Backup における整合性は下記の３種類ございます。<br>・アプリケーション整合性 (Application-consistent)<br><img src="/blog/AzureVMBackup/Consistencies/Consistencies_01.png" alt="2022-02-11_00h49_03"></p><p>・ファイルシステム整合性 (File-system consistent)<br><img src="/blog/AzureVMBackup/Consistencies/Consistencies_02.png" alt="2022-02-11_00h49_22"></p><p>・クラッシュ整合性 (Crash-consistent)<br><img src="/blog/AzureVMBackup/Consistencies/Consistencies_03.png" alt="2022-02-11_00h49_36"></p><p>なお、公開情報は下記にございますのでまず一度ご一読ください。<br>その前提で説明させていただきます。</p><ul><li>(参考) Azure VM バックアップの概要 スナップショットの整合性<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#snapshot-consistency">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#snapshot-consistency</a></li></ul><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><hr><p><a href="#1">1. アプリケーション整合性</a><br><a href="#1-1">  1.1 VSS 観点での調査について</a><br><a href="#1-2">  1.2  SQL Server のインストールされた Windows OS のバックアップについて</a><br><a href="#1-2-1">   1.2.1  ご参考ページ</a><br><a href="#1-3">  1.3  Oracle DB for Windows VM の Azure VM Backup について</a><br><a href="#1-4">  1.4  事前事後スクリプトについて</a><br><a href="#2">2. ファイルシステム整合性</a><br><a href="#3">3. クラッシュ整合性</a></p><hr><h2 id="1-アプリケーション整合性"><a href="#1-アプリケーション整合性" class="headerlink" title="1. アプリケーション整合性"></a>1. アプリケーション整合性<a id="1"></a></h2><p>こちら Azure VM Backup における最も上位の整合性でございます。<br>Windows OS や事前事後スクリプトを設定した Linux OS でオンライン バックアップを取得した場合にアプリケーション整合性となります。<br>なお、Windows OS の場合は VSS (ボリューム シャドウ コピー サービス) との連携によりアプリケーション整合性を取得するのみであり、Linux OS のような事前事後スクリプトの準備はございません。また Windows / Linux いずれも OS の起動を保証します。</p><p>Azure Portal 上の表示では、Windows OS の場合は VSS (VSS ライター) が正常に稼働すればアプリケーション整合性となり、Linux VM の場合は事前事後スクリプトが正常に完了すればアプリケーション整合性となります。<br>つまり、VSS に対応していないアプリケーションをご利用の場合は該当アプリケーションに対する整合性はございませんが、Azure Portal (Azure Backup) では VSS ライターが提供されていない対象のアプリケーションを検知することが出来ないため Azure Portal 上の表示はアプリケーション整合性となります。</p><p>また、<strong>ご利用のアプリケーション整合性が VSS に対応しているかは各アプリケーションの提供元ベンダーまでお問い合わせいただきますようお願いします。</strong></p><ul><li>(参考) VSS のしくみ<br><a href="https://learn.microsoft.com/ja-jp/windows-server/storage/file-server/volume-shadow-copy-service#how-volume-shadow-copy-service-work">https://learn.microsoft.com/ja-jp/windows-server/storage/file-server/volume-shadow-copy-service#how-volume-shadow-copy-service-work</a><blockquote><p>Microsoft 以外の VSS ライターは、バックアップ中にデータの一貫性を保証する必要がある Windows 用の多くのアプリケーションに含まれています。</p></blockquote></li></ul><h3 id="1-1-VSS-観点での調査について"><a href="#1-1-VSS-観点での調査について" class="headerlink" title="1.1 VSS 観点での調査について"></a>1.1 VSS 観点での調査について<a id="1-1"></a></h3><p>まず、Azure Backup チームでは VSS 関連の障害調査に関しては VSS および 特定の VSS ライターに不調があるというところまでが調査可能です。<br>なぜ “VSS および 特定の VSS ライターに不調が起きたのか” に関する根本原因についてはお客様の契約次第ではオンプレミス チームでの有償対応が必要となることがございます。<br>また、お客様のご契約が Azure 製品のサポート契約のみの場合オンプレミス範囲のサポート契約がないため、詳細な調査を行えないことがございます。<br>また切り分けの結果、他社製品のアプリケーションの VSS ライターの不具合であった場合には弊社ではサポート出来かねますので、ご利用のアプリケーション提供ベンダーまでお問い合わせお願いします。</p><p>つぎに、それぞれについて下記の通りお伝えさせていただきます。</p><h4 id="・VSS-の不調-bad-state-によりAzure-VM-Backupが失敗する"><a href="#・VSS-の不調-bad-state-によりAzure-VM-Backupが失敗する" class="headerlink" title="・VSS の不調 (bad state)によりAzure VM Backupが失敗する"></a>・VSS の不調 (bad state)によりAzure VM Backupが失敗する</h4><p>こちら根本原因の特定には VSS 観点での調査が必要となります。<br> Azure Backup チームでは 根本原因の特定については可能な範囲での調査をさせていただきます。</p><p>ご参考にまでに、下記のようなエラーが出ることがございます。</p><blockquote><p>Error Code ：ExtensionFailedVssServiceInBadState<br>Error Message ：Snapshot operation failed due to VSS (Volume Shadow Copy) service in bad state</p></blockquote><blockquote><p>Error Code ：ExtensionFailedVssWriterInBadState<br>Error Message ：Snapshot operation failed due to VSS Writers in bad state.</p></blockquote><p>事象の改善方法としては下記 URL 記載の <strong>VSS の再起動、および VM の再起動を行うことで改善することがほとんどでございます。</strong></p><ul><li>(参考) Azure 仮想マシンでのバックアップ エラーのトラブルシューティング - ExtensionFailedVssServiceInBadState - VSS (ボリューム シャドウ コピー) サービスが正しくない状態にあるため、スナップショット操作に失敗しました<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#extensionfailedvssserviceinbadstate---snapshot-operation-failed-due-to-vss-volume-shadow-copy-service-in-bad-state">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#extensionfailedvssserviceinbadstate---snapshot-operation-failed-due-to-vss-volume-shadow-copy-service-in-bad-state</a></li></ul><p> VSS 観点で、なぜ VSS が bad state になったか、に関する根本原因の調査のためには下記 URL 先のログの採取をお願いします。<br> <strong>可能な限り “[A]”が望ましいですが、”[B]” の方法で採取いただいても、ある程度は調査が可能な場合がございます。</strong></p><ul><li>(参考) VSS エラーが発生している事象の調査<br><a href="https://jpwinsup.github.io/mslog/storage/vss/vss-error/">https://jpwinsup.github.io/mslog/storage/vss/vss-error/</a></li></ul><h4 id="・VSS-ライターのエラーにより警告付き完了となる-アプリケーション整合性ではなくファイルシステム整合性となって復旧ポイントが取得されている"><a href="#・VSS-ライターのエラーにより警告付き完了となる-アプリケーション整合性ではなくファイルシステム整合性となって復旧ポイントが取得されている" class="headerlink" title="・VSS ライターのエラーにより警告付き完了となる / アプリケーション整合性ではなくファイルシステム整合性となって復旧ポイントが取得されている"></a>・VSS ライターのエラーにより警告付き完了となる / アプリケーション整合性ではなくファイルシステム整合性となって復旧ポイントが取得されている</h4><p>こちら根本原因の特定には VSS および VSS ライター観点での調査が必要となります。<br>Azure Backup チームでは どうして VSS ライター が失敗したのか、に関する根本原因の特定については可能な範囲での調査をさせていただきます。<br>一次調査の結果、VSS ライターのエラーを出しているアプリケーションが 弊社 SQL Server 等弊社製品の場合は担当チーム (SQL Server 等) で対応が可能でございますが、お客様の契約次第では有償対応が必要となることがございます。<br>　一方、VSS ライターのエラーを出しているアプリケーションが他社製品の場合、ご利用のアプリケーション提供ベンダーまでお問い合わせいただくようお願い申し上げます。</p><p>改善策としては、下記の URL をご参考にして<strong>VSS の再起動、および VM の再起動の対応いただければと存じます。</strong></p><ul><li>(参考) Azure 仮想マシンでのバックアップ エラーのトラブルシューティング - ExtensionFailedVssWriterInBadState - VSS ライターが正しくない状態にあるため、スナップショット操作に失敗しました<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#extensionfailedvsswriterinbadstate---snapshot-operation-failed-because-vss-writers-were-in-a-bad-state">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#extensionfailedvsswriterinbadstate---snapshot-operation-failed-because-vss-writers-were-in-a-bad-state</a></li></ul><h3 id="1-2-SQL-Server-のインストールされた-Windows-OS-のバックアップについて"><a href="#1-2-SQL-Server-のインストールされた-Windows-OS-のバックアップについて" class="headerlink" title="1.2  SQL Server のインストールされた Windows OS のバックアップについて"></a>1.2  SQL Server のインストールされた Windows OS のバックアップについて<a id="1-2"></a></h3><p>こちらよくいただくお問い合わせとして次の通りお伝えします。</p><blockquote><p>・SQL Server のインストールされた Windows OS をAzure VM Backup でバックアップすることは可能か、また何か考慮点があるか？<br>*ここで SQL Server とは Microsoft SQL Server を指します。</p></blockquote><p><strong>こちら結論から申し上げますと、可能です。</strong><br>Microsoft SQL Server では SQL ライターがございますので、SQL データベースの整合性を保った VM 全体のバックアップを取得することが可能です。</p><p>考慮点としましては下記 URL をご覧ください。</p><ul><li><p>(参考) Azure VM バックアップの概要 - スナップショットの作成<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#snapshot-creation">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-introduction#snapshot-creation</a></p><blockquote><p>既定の Azure Backup では、VSS の完全バックアップが作成されます (アプリケーション レベルで整合性のあるバックアップを取得するため、バックアップ時に、SQL Server などのアプリケーションのログは切り捨てられます)。 Azure VM バックアップで SQL Server データベースを使用している場合は、(ログを保持するために) VSS コピー バックアップを作成するように設定を変更できます。</p></blockquote></li><li><p>(参考) Azure 仮想マシンでのバックアップ エラーのトラブルシューティング - VM スナップショットに関する問題のトラブルシューティング<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#troubleshoot-vm-snapshot-issues">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-vms-troubleshoot#troubleshoot-vm-snapshot-issues</a></p><blockquote><p>既定では、VM バックアップによって Windows VM 上に VSS フル バックアップが作成されます。 SQL Server を実行していて SQL Server のバックアップを構成されている VM では、スナップショットの遅延が発生する可能性があります。 スナップショットの遅延が原因でバックアップが失敗する場合は、次のレジストリ キーを設定します。[HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\BCDRAGENT]<br>“USEVSSCOPYBACKUP”=”TRUE”</p></blockquote></li></ul><p>上記レジストリ設定にあたって OS 再起動は必要ございません。</p><h4 id="1-2-1-上記に関するご参考ページ"><a href="#1-2-1-上記に関するご参考ページ" class="headerlink" title="1.2.1 上記に関するご参考ページ "></a>1.2.1 上記に関するご参考ページ <a id="1-2-1"></a></h4><ul><li>コピーのみのバックアップ - SQL Server<br><a href="https://learn.microsoft.com/ja-jp/sql/relational-databases/backup-restore/copy-only-backups-sql-server?view=sql-server-ver16">https://learn.microsoft.com/ja-jp/sql/relational-databases/backup-restore/copy-only-backups-sql-server?view=sql-server-ver16</a><blockquote><p>コピーのみのバックアップとは、定期的に実行される一連の SQL Server バックアップとは別の SQL Server バックアップです。 通常、バックアップを行うとデータベースが変更され、その後のバックアップの復元方法に影響します。 ただし、データベース全体のバックアップや復元の手順に影響を与えない特殊な目的で、バックアップを行うと役に立つ場合があります。 このため、コピーのみのバックアップが導入されました。</p></blockquote></li></ul><h3 id="1-3-Oracle-DB-for-Windows-VM-の-Azure-VM-Backup-について"><a href="#1-3-Oracle-DB-for-Windows-VM-の-Azure-VM-Backup-について" class="headerlink" title="1.3  Oracle DB for Windows VM の Azure VM Backup について"></a>1.3  Oracle DB for Windows VM の Azure VM Backup について<a id="1-3"></a></h3><p>よくお問い合わせをいただく例としましては Oracle DB が搭載された Windows OS に関してお問い合わせをいただくことがございます。<br>弊社では Windows OS 向けの Oracle DB すべてが VSS に対応しているかわかりかねますが、少なくとも実績はございます。<br>ご利用の Oracle DB が VSS に対応しているかが不明な場合は別途 Oracle 社にお問い合わせいただければと存じます。</p><p>*下記情報は弊社外のサイトでございますが、ご参考になれば幸いです。弊社情報ではございませんのでその点ご留意ください。</p><ul><li>Oracleがインストールされているシステムで Exit Code -311が発生する<br><a href="https://actiphyhelp.zendesk.com/hc/ja/articles/13451077456153-Oracle%E3%81%8C%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%A7-Exit-Code-311%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B">https://actiphyhelp.zendesk.com/hc/ja/articles/13451077456153-Oracle%E3%81%8C%E3%82%A4%E3%83%B3%E3%82%B9%E3%83%88%E3%83%BC%E3%83%AB%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0%E3%81%A7-Exit-Code-311%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B</a></li><li>(Oracle社) VSSを使用したデータベースのバックアップおよびリカバリの目的<br>※Oracle DB すべてが VSS に対応しているかはわかりかねます<br><a href="https://docs.oracle.com/cd/F19136_01/ntqrf/purpose-of-database-backup-and-recovery-with-vss.html#GUID-6A44D80C-0427-4DB8-AD3C-BD5426AECC2B">https://docs.oracle.com/cd/F19136_01/ntqrf/purpose-of-database-backup-and-recovery-with-vss.html#GUID-6A44D80C-0427-4DB8-AD3C-BD5426AECC2B</a></li></ul><h3 id="1-4-事前事後スクリプトについて"><a href="#1-4-事前事後スクリプトについて" class="headerlink" title="1.4 事前事後スクリプトについて"></a>1.4 事前事後スクリプトについて<a id="1-4"></a></h3><p>Linux VM 事前事後スクリプトに関しましては、お客様自身で対象のアプリケーション (DBなど) の I/O を停止 / 再開する処理を記載いただく必要がございます。<br>そのため、対象のアプリケーションに対してそのようなコマンド制御ができない場合は、残念ながら事前事後スクリプトを用いることはできません。そのようなコマンド制御が可能かはアプリケーション提供ベンダーまでお問い合わせをいただきますようお願いします。</p><ul><li>(参考) Azure Backup を使用した Azure Linux VM のアプリケーション整合性バックアップ<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-linux-app-consistent">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-linux-app-consistent</a></li><li>(参考) データベース整合性スナップショットのための拡張事前/事後スクリプト<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-linux-database-consistent-enhanced-pre-post">https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-linux-database-consistent-enhanced-pre-post</a></li><li>(参考) GitHub 上のサンプル事前事後スクリプト (Oracle や MySQLがございます。)<br><a href="https://github.com/Azure/azure-linux-extensions/tree/master/VMBackup/main/workloadPatch/DefaultScripts">https://github.com/Azure/azure-linux-extensions/tree/master/VMBackup/main/workloadPatch/DefaultScripts</a></li></ul><h2 id="2-ファイルシステム整合性"><a href="#2-ファイルシステム整合性" class="headerlink" title="2.ファイルシステム整合性"></a>2.ファイルシステム整合性<a id="2"></a></h2><p>Windows OS のオンライン バックアップを取得した際に一部の VSS ライターが失敗した場合や Linux OS でオンライン バックアップを取得した場合 (または 事前事後スクリプトが失敗した場合) にファイルシステム整合性となります。<br>こちらは OS の起動を保証した整合性ですが、アプリケーション レベルでの整合性は担保されておりません。</p><h2 id="3-クラッシュ整合性"><a href="#3-クラッシュ整合性" class="headerlink" title="3.クラッシュ整合性"></a>3.クラッシュ整合性<a id="3"></a></h2><p>スナップショット作成実行時のディスクのデータのみを保存します。<br>アプリケーション整合性やファイルシステム整合性とは異なり、OS 内部とは連携せずスナップショットを取得します。<br>そのため、オフライン状態の VM をバックアップした際にはクラッシュ整合性となります。<br>OS の起動を保証しない整合性ではございますが、<strong>正常に電源が落とされた状態の VM であればメモリ上の情報や I/O の発生はなく、ディスクにしか情報はないため整合性の懸念は全くございません。</strong></p><ul><li>参考ブログ Azure VM Backup では オフライン バックアップができるのか<br><a href="https://jpabrs-scem.github.io/blog/AzureVMBackup/Azure_VM_Offline_backup/">https://jpabrs-scem.github.io/blog/AzureVMBackup/Azure_VM_Offline_backup/</a></li></ul><p>一方、Azure Disk Backup やマネージド ディスクのスナップショットなどは、起動中の VM にアタッチされているディスクのスナップショットを取得することが可能ですが、この際のオンライン状態でのスナップショットの整合性は Azure VM Backupとは異なり、クラッシュ整合性となります。<br>整合性は劣るものの、後述の通り DB のない VM であればクラッシュ整合性でも基本的には問題ございません。</p><ul><li>(参考) Azure ディスク バックアップの概要<br><a href="https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-overview">https://learn.microsoft.com/ja-jp/azure/backup/disk-backup-overview</a> </li><li>(参考) 仮想ハード ディスクのスナップショットを作成する<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/snapshot-copy-managed-disk?tabs=portal">https://learn.microsoft.com/ja-jp/azure/virtual-machines/snapshot-copy-managed-disk?tabs=portal</a></li></ul><p>クラッシュ整合性に関しましては次の公開情報にございますようなイメージをしていただけるとわかりやすいかと存じます。<br> (Azure Site Recovery のドキュメントではございますが、考え方は同じです。)</p><ul><li>(参考) Azure Site Recovery に関する一般的な質問 - クラッシュ整合性復旧ポイントとは何ですか?<br><a href="https://learn.microsoft.com/ja-jp/azure/site-recovery/site-recovery-faq#---------------------">https://learn.microsoft.com/ja-jp/azure/site-recovery/site-recovery-faq#---------------------</a><blockquote><p>クラッシュ整合性復旧ポイントには、スナップショットの作成中にサーバーから電源コードが引き抜かれたときのディスク上のデータが含まれます。 クラッシュ整合性復旧ポイントには、スナップショットの作成時にメモリに入っていたものは一切含まれません。<br>現在、ほとんどのアプリケーションは、クラッシュ整合性のスナップショットから十分に復旧できます。 データベースのないオペレーティング システムや、ファイル サーバー、DHCP サーバー、プリント サーバーなどのアプリケーションの場合は、クラッシュ整合性復旧ポイントで十分です。</p></blockquote></li></ul><p>本記事の説明は以上です。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;
&lt;p&gt;皆様こんにちは。Azure Backup サポートです。&lt;br&gt;今回は Azure VM Backup における整合性に関して具体例も踏まえつつご説明させていただきます。&lt;/p&gt;
&lt;p&gt;まず、Azure VM Backup に</summary>
      
    
    
    
    
    <category term="how to" scheme="https://jpabrs-scem.github.io/blog/tags/how-to/"/>
    
    <category term="Azure VM Backup" scheme="https://jpabrs-scem.github.io/blog/tags/Azure-VM-Backup/"/>
    
  </entry>
  
</feed>
