---
title: Azure VM Backup における CRR (クロスリージョン リストア) について
date: 2023-12-29 12:00:00
tags:
  - Azure VM Backup
  - how to
disableDisclaimer: false
---

<!-- more -->
こんにちは、Azure Backup サポートです。
今回は、Azure Backup での リージョンをまたがる復元（ = Cross-Region Restore / CRR）にて頻繁にいただくお問い合わせに関して、下記ご案内いたします。


## 目次
-----------------------------------------------------------
[1. CRR 機能を有効した場合の、冗長性オプションは「GRS」になるのか、「RA-GRS」になるのか？](#1)
[1-1. Azure Portal での CRR 有効時の確認方法](#1-1)
[1-2. GRS と RA-GRS(CRR有効化) の違い](#1-2)
[1-3. セカンダリ リージョンへのリストア手順](#1-3)
[2. セカンダリ リージョンへ復元ポイントがレプリケートされるまでに、最大何時間かかるのか？](#2)
[3. セカンダリ リージョンへ復元ポイントがいつレプリケート完了したか、Azure ポータル画面上でどのように確認すればよいのか？](#3)
[3-1. 補足：バックアップ ジョブについて](#3-1)
[4. 災害復旧後のレプリケーションについて](#4)
-----------------------------------------------------------

## <a id="1"></a> 1. CRR 機能を有効した場合の、冗長性オプションは「GRS」になるのか、「RA-GRS」になるのか？

結論から申し上げますと、RA-GRS となります。
![CRR_01](https://user-images.githubusercontent.com/71251920/153718070-4b865afe-f876-47e2-afd0-2484e7889235.gif)

・Azure Backup 用語集 - Azure Backup | Microsoft Docs
https://docs.microsoft.com/ja-jp/azure/backup/azure-backup-glossary#grs

 


### <a id="1-1"></a> 1-1. Azure Portal での CRR 有効時の確認方法
ご参考までに、CRR 機能を有効にした場合の Azure ポータル画面上の見え方を説明いたします。 
Recovery Services コンテナー「RSV-JPE-GRS-CRR」は「ストレージ レプリケーションの種類：geo 冗長」かつ「リージョンをまたがる復元：有効にする」となっております。
これによって CRR 機能が有効 (=RA-GRS) となります。

![CRR_02](https://user-images.githubusercontent.com/71251920/153718069-e91606c7-4001-40d7-8ec1-4596719263c5.gif)

CRR 機能が有効になっている場合、「バックアップ アイテム」画面上では「プライマリ リージョン」のほかに「セカンダリ リージョン」も選択できるよう、活性化されます。
![CRR_03](https://github.com/jpabrs-scem/blog/assets/141192952/8181f3a0-5004-4a26-bf96-45434e9ab5e4)
![CRR_04](https://github.com/jpabrs-scem/blog/assets/141192952/1af2d796-f098-465e-9ab0-1f0362056c06)

 一方でRecovery Services コンテナー上で「リージョンをまたがる復元：無効にする」を選択されている場合は、下図のように「プライマリ リージョン」がデフォルトで選択されており、かつ非活性表示となっているため「セカンダリ リージョン」への切り替えが不可能となっております。
 ![CRR_05](https://github.com/jpabrs-scem/blog/assets/141192952/a716e9db-a396-4ec8-9d22-60cf8afab3eb)

>[!WARNING]
> CRR 機能が有効にされてから上記「セカンダリ リージョン」の項目が活性化されるまで**最大で 48 時間**かかりますのでご注意ください。
> ---
> ・ Recovery Services コンテナーを作成して構成する - Azure Backup | Microsoft Learn  : リージョンをまたがる復元の設定
> 　 https://learn.microsoft.com/ja-jp/azure/backup/backup-create-recovery-services-vault#set-cross-region-restore



 ### <a id="1-2"></a> 1-2. GRS と RA-GRS (CRR有効化時) の違い
 Recovery Services コンテナーの冗長性が GRS であっても、RA-GRS (CRR有効化時) であってもセカンダリ リージョンにバックアップデータはレプリケーションされ保持されます。
 違いは**任意のタイミングでセカンダリ リージョンへ復元できるか**どうかです。

・geo 冗長ストレージ (GRS) コンテナーで、リージョンをまたがる復元 (CRR) 機能が有効になっている場合とそうでない場合では、どのような違いがありますか。
　https://learn.microsoft.com/ja-jp/azure/backup/backup-azure-backup-faq#geo----------grs-----------------------crr----------------------------------------
　"CRR 機能が有効になっていない GRS コンテナーの場合、<span style="color: red">Azure によってプライマリ リージョンでの障害が宣言されるまで、セカンダリ リージョンのデータにはアクセスできません。</span> このような場合、セカンダリ リージョンから復元が行われます。 
　　CRR が有効になっている場合、プライマリ リージョンが稼働している場合でも、セカンダリ リージョンでの復元をトリガーできます。"

またコストは RA-GRS (CRR有効化) にすることでストレージ単価が高くなりますのでその点ご留意ください。詳細に関しては下記をご覧ください。
・Azure Backup の価格 - バックアップ ストレージ の項目をご覧ください。
https://azure.microsoft.com/ja-jp/pricing/details/backup/

  ### <a id="1-3"></a> 1-3. セカンダリ リージョンへのリストア手順
下記公開情報をご覧ください。
・セカンダリ リージョンに復元する - Azure portal で Azure VM データを復元する方法
https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region


## <a id="2"></a> 2. セカンダリ リージョンへ復元ポイントがレプリケートされるまでに、最大何時間かかるのか？
セカンダリ リージョンへのデータのレプリケーションは、プライマリリージョンへのバックアップジョブが完了 (最大24時間) してから 12 時間以内にレプリケーションが完了するように動作します。
そのため、プライマリリージョンのバックアップジョブ完了とセカンダリ リージョンへのレプリケーションにはラグが生じます。

・Azure portal を使用して VM を復元する - Azure Backup | Microsoft Docs
https://docs.microsoft.com/ja-jp/azure/backup/backup-azure-arm-restore-vms#restore-in-secondary-region
> 現在、セカンダリ リージョンの RPO は "36 時間" です。 これは、プライマリ リージョンの RPO が "24 時間" であり、プライマリからセカンダリ リージョンへのバックアップ データのレプリケーションに最大 "12 時間" かかることがあるためです。

## <a id="3"></a> 3. セカンダリ リージョンへ復元ポイントがいつレプリケート完了したか、Azure ポータル画面上でどのように確認すればよいのか？
Recovery Services コンテナー ＞ バックアップ アイテム ＞ セカンダリ リージョン ＞ Azure Virtual Machine ＞ 対象の仮想マシンを選択し、「復元ポイント」欄に、対象の復元ポイントが表示されていれば、セカンダリ リージョンへのレプリケートは完了していると判断できます。

作業例）プライマリ リージョンに配置されている仮想マシン「SAPHANA03」を「今すぐバックアップ」を実施し、取得された復元ポイントがセカンダリ リージョンに複製されているかを確認する
![CRR_08](https://user-images.githubusercontent.com/71251920/153718060-4b01fca7-5815-4b8a-b2e8-3eb2f32ffa17.png)


下図画面の黄色罫線部分が、「今すぐバックアップ」にてトリガーし、バックアップが完了したバックアップ ジョブです。
***2021/12/9 17:50 に「今すぐバックアップ」のバックアップ ジョブがトリガーされ、18:21 ごろにバックアップが完了しております。***
![CRR_09](https://github.com/jpabrs-scem/blog/assets/141192952/088ad480-35c7-4706-bd1a-9891d27ddf6c)

バックアップ アイテム ＞ プライマリ リージョン ＞ Azure Virtual Machine 画面上の「最新の復元ポイント」に表示されている時刻は、バックアップが実行開始された時刻となります。
![CRR_10](https://user-images.githubusercontent.com/71251920/153718057-67e701d6-4f7b-44e7-bbfc-add77d52be00.jpg)

「プライマリ リージョン」側のバックアップ項目画面では、「復元ポイント」欄に、取得済の復元ポイントが表示されています。
![CRR_11](https://github.com/jpabrs-scem/blog/assets/141192952/5010fbae-bf29-4b86-a52c-c5f0b1a34e7d)

一方で、バックアップ アイテム ＞ セカンダリ リージョン ＞ Azure Virtual Machine ＞ 対象の仮想マシンをクリックします。
バックアップ項目画面では、***「復元ポイント」欄に、12/09 18:32 時点では、12/09 にプライマリ リージョン側にて取得済の復元ポイントはまだ表示されておらず、セカンダリ リージョン側に復元ポイントが複製されていないことが分かります。***
（2021/12/09 24時ごろも確認しましたが、復元ポイントは表示されておりませんでした）
![CRR_12](https://github.com/jpabrs-scem/blog/assets/141192952/a65099c1-2452-4090-b88a-d6b49161cece)


同じく、「セカンダリ リージョンへの復元」をクリックし、「復元ポイントの選択」欄を表示しても、***12/09 17:50 に開始・取得済の復元ポイントは表示されていないことが確認できます。***
![CRR_13](https://user-images.githubusercontent.com/71251920/153718054-b2f2fa69-cee7-4fb6-9997-46186c01f2b2.png)

2021/12/09 17:50 Auzre VM Backup 開始後、 ***12 時間以上経過した 2021/12/10 8:09 時点では、「復元ポイントの選択」欄にて、セカンダリ リージョンのデータとして 17:50 のバックアップ開始分が表示されていることが確認できました。***

![CRR_14](https://user-images.githubusercontent.com/71251920/153718052-24c17913-41e2-4936-bb36-39735f087e94.png)

### <a id="3-1"></a> 補足：セカンダリ リージョンのジョブについて
Recovery Services コンテナー ＞ バックアップ ジョブ ＞「セカンダリ リージョンのジョブを表示する」をクリックすると、セカンダリ リージョンのリストア ジョブを確認可能です。
しかし、プライマリ リージョンに配置されている仮想マシンのバックアップ ジョブは、 セカンダリ リージョンのバックアップ ジョブ上には表示されません。
![CRR_15](https://github.com/jpabrs-scem/blog/assets/141192952/3d017558-fd4b-49e8-92c2-c43b2967a3a5)

![CRR_16](https://github.com/jpabrs-scem/blog/assets/141192952/215c24ca-e692-4898-a41f-c713f0567b8a)
 
## <a id="4"></a> 災害復旧後のレプリケーションに関するFAQ
>Q. プライマリリージョンが復旧したあとに プライマリリージョンに VM を復旧できるか
>>A. こちらは可能ですが、Azure VM Backup の機能で実現するにはクロスリージョン リストアを実施いただく必要がございます。
具体的には一度セカンダリリージョンに VM をリストア いただき、復元した VM をセカンダリリージョンの Recovery Services コンテナーで保護しプライマリリージョンにクロスリージョン リストアを行う必要がございます。
これはセカンダリリージョンにあるバックアップデータからはセカンダリリージョンにしか、プライマリリージョンにあるバックアップデータからはプライマリリージョンにしかリストアができないためです。
Azure VM Backup の クロスリージョン リストア以外の方法ではセカンダリリージョンに VM をリストアした後に Azure Site Recovery などを用いた方法が考えられます。
・Azure VM を別の Azure リージョンに移動する
https://docs.microsoft.com/ja-jp/azure/site-recovery/azure-to-azure-move-overview

>Q. バックアップデータのレプリケーションは再開されるか
>>A. プライマリリージョンからセカンダリリージョンへのバックアップデータレプリケーションは災害復旧次第再開されます。
一方プライマリリージョンのデータが失われていたとしてもセカンダリリージョンからプライマリリージョンへのバックアップデータのレプリケーションは行われません。



CRR に関する説明は以上となります。
